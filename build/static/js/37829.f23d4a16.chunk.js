"use strict";(self.webpackChunkreact_training=self.webpackChunkreact_training||[]).push([[37829,18277,41863],{2622:function(e,t,n){n.d(t,{Z:function(){return o}});var i=n(15671),r=n(43144),a=n(39052),s=n(56885),o=function(e,t){function n(e){(0,i.Z)(this,n),this._observable=new s.s,this._set=new Set(e)}return(0,r.Z)(n,[{key:"size",get:function(){return(0,a.it)(this._observable),this._set.size}},{key:"add",value:function(e){var t=this._set.size;return this._set.add(e),this._set.size!==t&&this._observable.notify(),this}},{key:"clear",value:function(){this._set.size>0&&(this._set.clear(),this._observable.notify())}},{key:"delete",value:function(e){var t=this._set.delete(e);return t&&this._observable.notify(),t}},{key:"entries",value:function(){return(0,a.it)(this._observable),this._set.entries()}},{key:"forEach",value:function(e,t){var n=this;(0,a.it)(this._observable),this._set.forEach((function(i,r){return e.call(t,i,r,n)}),t)}},{key:"has",value:function(e){return(0,a.it)(this._observable),this._set.has(e)}},{key:"keys",value:function(){return(0,a.it)(this._observable),this._set.keys()}},{key:"values",value:function(){return(0,a.it)(this._observable),this._set.values()}},{key:e,value:function(){return(0,a.it)(this._observable),this._set[Symbol.iterator]()}},{key:t,get:function(){return this._set[Symbol.toStringTag]}}]),n}(Symbol.iterator,Symbol.toStringTag)},51066:function(e,t,n){n.d(t,{s:function(){return o}});var i=n(16889),r=n(12400),a=n(96334),s=n(22186);function o(e,t,n,i){if(null==t||null==i)return!1;var r=(0,a.Bg)(t,i,d);if(r.projector===a.iq)return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],!0;if(null==r.projector)return!1;var o=r.source,c=r.dest;if(c.spatialReferenceId===a.Ej.WEB_MERCATOR){var h=a.rf[o.spatialReferenceId][a.Ej.WGS84];return null!=h&&(h(e,0,u,0),(0,a.uT)(u,0,n,0),n[3]=l(u[1],e[2],e[3],s.sv.radius),!0)}if(o.spatialReferenceId!==a.Ej.WGS84&&o.spatialReferenceId!==a.Ej.CGCS2000||c.spatialReferenceId!==a.Ej.PLATE_CARREE){var v,f;r.projector(e,0,n,0);var _=null!==(v=o.metersPerUnit)&&void 0!==v?v:1,g=null!==(f=c.metersPerUnit)&&void 0!==f?f:1;n[3]=e[3]*_/g}else{var p=a.rf[o.spatialReferenceId][a.Ej.SPHERICAL_ECEF],m=a.rf[a.Ej.SPHERICAL_ECEF][a.Ej.PLATE_CARREE],y=e[3];null!=p&&null!=m&&(y=l(e[1],e[2],e[3],s.sv.radius)),r.projector(e,0,n,0),n[3]=y}return!0}function l(e,t,n,i){var r=i+t;if(r<i/2||n>r)return Number.MAX_VALUE;var a=Math.abs(c*e)+Math.asin(n/r);return a>=Math.PI/2?Number.MAX_VALUE:n/Math.cos(a)}var u=(0,r.Ue)(),d=(0,a.sw)(),c=(0,i.Vl)(1)},50631:function(e,t,n){n.d(t,{Z:function(){return Gt}});var i=n(74165),r=n(15861),a=n(37762),s=n(29439),o=n(15671),l=n(43144),u=n(60136),d=n(29388),c=n(27366),h=n(7138),v=n(93169),f=n(32718),_=n(27546),g=n(67426),p=n(66978),m=n(94172),y=n(49861),b=(n(84936),n(69912)),x=n(77258),C=n(65156),k=n(41388),N=n(50951),w=n(10064),I=n(92026),S=n(18759),R=n(71907),M=n(29303),D=n(21389),P=n(32035),F=n(12400),O=n(51066),L=n(69048),A=n(23470),E=n(51995),Z=n(5640),T=n(57661),V=n(99048),j=n(68401),U=n(32251),G=n(45856);function B(e){return q.apply(this,arguments)}function q(){return q=(0,r.Z)((0,i.Z)().mark((function e(t){var n,r,a,s,o,l;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],r=[],null!=t){e.next=3;break}return e.abrupt("return",{material:{alphaMode:"opaque",alphaCutoff:.1,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:n,textureData:r});case 3:return a=Q(t),"auto"===t.alphaMode&&console.warn('alphaMode "auto" not supported by I3S PBRMaterial - defaulting to "blend".'),s=(0,G.Ih)({normalTexture:t.normalTexture,emissiveTexture:a?t.emissiveTexture:null,emissiveFactor:a?E.Z.toUnitRGB(t.emissiveColor):null,occlusionTexture:a?t.occlusionTexture:null,metallicRoughnessTexture:a?t.metallicRoughnessTexture:null,metallicFactor:a?t.metallic:null,roughnessFactor:a?t.roughness:null}),o=s?G.yI[0]:a?t.metallic:0,l=s?G.yI[1]:a?t.roughness:0,e.t0="auto"===t.alphaMode?"blend":t.alphaMode,e.t1=t.alphaCutoff,e.t2=t.doubleSided,e.t3=t.doubleSided?j.Vr.None:j.Vr.Back,e.next=12,H(t.normalTexture,n,r,V.v.Normal);case 12:if(e.t4=e.sent,!a){e.next=19;break}return e.next=16,H(t.emissiveTexture,n,r,V.v.Emissive);case 16:e.t5=e.sent,e.next=20;break;case 19:e.t5=-1;case 20:if(e.t6=e.t5,!a){e.next=27;break}return e.next=24,H(t.occlusionTexture,n,r,V.v.Occlusion);case 24:e.t7=e.sent,e.next=28;break;case 27:e.t7=-1;case 28:return e.t8=e.t7,e.t9=a&&null!=t.emissiveColor?E.Z.toUnitRGB(t.emissiveColor):[0,0,0],e.t10=null!=t.color?E.Z.toUnitRGBA(t.color):[1,1,1,1],e.next=33,H(t.colorTexture,n,r,V.v.Color);case 33:if(e.t11=e.sent,!a){e.next=40;break}return e.next=37,H(t.metallicRoughnessTexture,n,r,V.v.MetallicRoughness);case 37:e.t12=e.sent,e.next=41;break;case 40:e.t12=-1;case 41:return e.t13=e.t12,e.t14=o,e.t15=l,e.t16={baseColorFactor:e.t10,baseColorTextureId:e.t11,metallicRoughnessTextureId:e.t13,metallicFactor:e.t14,roughnessFactor:e.t15},e.t17=!0,e.t18=s,e.t19={alphaMode:e.t0,alphaCutoff:e.t1,doubleSided:e.t2,cullFace:e.t3,normalTextureId:e.t4,emissiveTextureId:e.t6,occlusionTextureId:e.t8,emissiveFactor:e.t9,metallicRoughness:e.t16,wrapTextures:e.t17,hasParametersFromSource:e.t18},e.t20=n,e.t21=r,e.abrupt("return",{material:e.t19,requiredTextures:e.t20,textureData:e.t21});case 51:case"end":return e.stop()}}),e)}))),q.apply(this,arguments)}function H(e,t,n,i){return z.apply(this,arguments)}function z(){return z=(0,r.Z)((0,i.Z)().mark((function e(t,n,r,a){var s,o,l,u,d,c,h;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=2;break}return e.abrupt("return",-1);case 2:if(s=r.length,o=t.data,l=t.url,null==o){e.next=15;break}if(!(o instanceof HTMLImageElement||o instanceof HTMLCanvasElement)){e.next=7;break}return u=(0,U.n9)(o),e.abrupt("return",(r.push({id:s,usage:a,data:u,encoding:V.j.PNG,downsampled:!1}),n.push({id:s,usage:a,encodings:[{name:void 0,encoding:V.j.PNG}]}),s));case 7:if(!(o instanceof HTMLVideoElement)){e.next=9;break}return e.abrupt("return",-1);case 9:if(!(o instanceof ImageData)){e.next=11;break}throw new w.Z("ImageData textures not supported yet for client side I3S nodes");case 11:if(!(o instanceof T.NM)){e.next=13;break}throw new w.Z("EncodedMeshTexture textures not supported yet for client side I3S nodes");case 13:e.next=23;break;case 15:if(null==l){e.next=23;break}return(d=new Image).src=l,e.next=20,(0,Z.fY)(d,d.src,!1,void 0);case 20:return c=e.sent,h=(0,U.n9)(c),e.abrupt("return",(r.push({id:s,usage:a,data:h,encoding:V.j.PNG,downsampled:!1}),n.push({id:s,usage:a,encodings:[{name:void 0,encoding:V.j.PNG}]}),s));case 23:return e.abrupt("return",-1);case 24:case"end":return e.stop()}}),e)}))),z.apply(this,arguments)}function Q(e){return e.hasOwnProperty("metallicRoughnessTexture")}var J=function(){function e(t,n,i,r){(0,o.Z)(this,e),this._uid=t,this._worker=r,this._id2Meta=new Map,this._oid2Meta=new Map,this._indexSR=n.indexSR,this._vertexSR=n.vertexSR,this._renderSR=n.renderSR,this._localMode=n.localMode,this._memCache=i.newCache("sl-client-mesh-data-".concat(this._uid))}return(0,l.Z)(e,[{key:"uid",get:function(){return this._uid}},{key:"worker",get:function(){return this._worker}},{key:"indexSR",get:function(){return this._indexSR}},{key:"renderSR",get:function(){return this._renderSR}},{key:"createMeshNodeInfo",value:function(e,t){var n="mesh".concat(t),i=e.extent,r=i.spatialReference,a=this._indexSR,s=function(e,t){var n=e.spatialReference,i=[1,-1],r=[.5*e.width,.5*e.height,e.hasZ?.5*(e.zmax-e.zmin):0],a=n.isGeographic?n.metersPerUnit:1,s=e.center,o=0;if(e.hasZ)for(var l=0;l<2;++l)for(var u=0;u<2;++u)for(var d=0;d<2;++d){var c=(s.x+i[l]*r[0]-t.x)*a,h=(s.y+i[u]*r[1]-t.y)*a,v=s.z+i[d]*r[2]-t.z;o=Math.max(c*c+h*h+v*v,o)}else for(var f=0;f<2;++f)for(var _=0;_<2;++_){var g=(s.x+i[f]*r[0]-t.x)*a,p=(s.y+i[_]*r[1]-t.y)*a;o=Math.max(g*g+p*p,o)}return(0,A.k)([t.x,t.y,t.z],Math.sqrt(o))}(i,e.origin);return(0,O.s)(s,r,s,a),{type:"mesh",id:n,version:te(e),oid:t,mbs:s,componentNodeIds:[],unloadedMesh:e,nodeIndex:null,loadMeshPromise:null}}},{key:"addMeshNode",value:function(e,t){if(null!=this.getMeshNodeIndex(t.oid))throw new w.Z("I3SClientNodeLoader: client side mesh for feature oid=".concat(t.oid," already exists"));t.nodeIndex=e,this._id2Meta.set(t.id,t),this._oid2Meta.set(t.oid,t)}},{key:"getMeshNodeIndex",value:function(e){var t=this._oid2Meta.get(e);return null==t||"mesh"!==t.type?null:t.nodeIndex}},{key:"getMeshNodeInfo",value:function(e){var t,n=this._oid2Meta.values(),i=(0,a.Z)(n);try{for(i.s();!(t=i.n()).done;){var r=t.value;if("mesh"===r.type&&r.id===e)return r}}catch(s){i.e(s)}finally{i.f()}return null}},{key:"removeNode",value:function(e){var t=this._id2Meta.get(e);null!=t&&(this._id2Meta.delete(e),"mesh"===t.type&&this._oid2Meta.delete(t.oid))}},{key:"loadNodeJSON",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(n=this._id2Meta.get(t))){e.next=3;break}throw new w.Z("I3SClientNodeLoader::loadNodeJSON unable to find node ".concat(t));case 3:e.t0=n.type,e.next="mesh"===e.t0?6:"mesh-component"===e.t0?7:8;break;case 6:return e.abrupt("return",this._loadMeshNodeJSON(n));case 7:return e.abrupt("return",W(n));case 8:throw new w.Z("I3SClientNodeLoader::loadNodeJSON unable to handle node ".concat(t));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_loadMeshNodeJSON",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t){var n,r,a,s,o,l,u;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.id,e.next=3,this._getMeshData(t);case 3:if(null!=(r=e.sent.loadedMesh).components&&0!==r.components.length){e.next=6;break}return e.abrupt("return",{id:n,version:null,mbs:t.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null});case 6:for(a=[],s=r.components,o=0;o<s.length;++o)l="".concat(n,"-component").concat(o),u={type:"mesh-component",id:l,mbs:t.mbs,componentIndex:o,meshNodeInfo:t,textureData:new Map},this._id2Meta.set(u.id,u),t.componentNodeIds.push(l),a.push({id:u.id,href:null,mbs:u.mbs,obb:null});return e.abrupt("return",{id:n,version:null,mbs:t.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:a});case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateNodeIndex",value:function(e,t,n){var i=this._id2Meta.get(e);i&&"mesh"===i.type&&(i.nodeIndex=n)}},{key:"loadNodeData",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n){var r,s,o,l,u,d,c,h,v,f,_,g,m,y,b,x,C,k,N,S,R,M,D,P,F,O,L,A,E;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(s=this._id2Meta.get(t))&&"mesh-component"===s.type){e.next=3;break}throw new w.Z("Failed to load client node data for node ".concat(t," (unexpected node info)"));case 3:return o=s.meshNodeInfo,e.next=6,this._getMeshData(o);case 6:if(l=e.sent,u=l.loadedMesh,d=o.oid,null!=u.components){e.next=11;break}throw new w.Z("Failed to load client node data for node ".concat(t," (unexpected null reference)"));case 11:return c=u.components[s.componentIndex],e.next=14,B(c.material);case 14:if(h=e.sent,v=h.material,f=h.requiredTextures,null!=(_=h.textureData)){g=(0,a.Z)(_);try{for(g.s();!(m=g.n()).done;)null!=(y=m.value)&&s.textureData.set(y.id,y)}catch(i){g.e(i)}finally{g.f()}}return b={params:{material:v},type:"ArrayBufferView"},x=u.vertexSpace,C=u.origin,k=u.transform,N=[C.x,C.y,null!==(r=C.z)&&void 0!==r?r:0],l.projectionPromise||((0,I.O3)(this._worker,"SceneLayerWorker is needed to project mesh"),l.projectionPromise=this._worker.project({positions:u.vertexAttributes.position,localMatrix:null===k||void 0===k?void 0:k.localMatrix,vertexSpace:x.toJSON(),origin:N,inSpatialReference:u.spatialReference.toJSON(),outSpatialReference:this._vertexSR.toJSON(),localMode:this._localMode},n)),e.next=23,l.projectionPromise;case 23:return S=e.sent,R=S.projected,M=S.original,D=S.projectedOrigin,u.vertexAttributes.position=M,e.next=30,K(c,l,this._worker,n);case 30:return P=e.sent,F=P.transformed,O=P.original,u.vertexAttributes.normal=O,(0,p.k_)(n),L=$(R,c.faces,F,u.vertexAttributes.uv,u.vertexAttributes.color,d),A=L.geometryBuffer,E=L.geometryDescriptor,e.abrupt("return",{geometryData:{featureDataPosition:D,featureIds:[],geometries:[b]},attributeDataInfo:{attributeData:{},loadedAttributes:[]},geometryBuffer:A,geometryDescriptor:E,requiredTextures:f,textureData:_,normalReferenceFrame:this._vertexSR.isGeographic?"east-north-up":"vertex-reference-frame"});case 36:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"loadAttributes",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n,r){var s,o,l,u,d;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=t.numFeatures,o={},l=(0,a.Z)(n);try{for(l.s();!(u=l.n()).done;)d=u.value.field.name,o[d]=new Array(s)}catch(i){l.e(i)}finally{l.f()}return e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,i){return e.apply(this,arguments)}}()},{key:"loadTextures",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n,r){var s,o,l,u,d,c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.id,null!=(o=this._id2Meta.get(s))&&"mesh-component"===o.type){e.next=3;break}throw new Error("Failed to load textures for node ".concat(t.id," (unexpected node info)"));case 3:l=[],u=(0,a.Z)(n);try{for(u.s();!(d=u.n()).done;)c=d.value,l.push(o.textureData.get(c.id)||null)}catch(i){u.e(i)}finally{u.f()}return e.abrupt("return",l);case 7:case"end":return e.stop()}}),e,this)})));return function(t,n,i){return e.apply(this,arguments)}}()},{key:"_getMeshData",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t){var n,a,s,o=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.version,null!=(a=this._memCache.get(n))){e.next=6;break}if(null==t.loadMeshPromise){e.next=4;break}return e.abrupt("return",t.loadMeshPromise);case 4:return s=function(){var e=(0,r.Z)((0,i.Z)().mark((function e(r,a){var s,l,u;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.unloadedMesh.clone(),e.prev=1,e.next=4,s.load();case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(1),a(e.t0);case 9:l=s.memoryUsage,u={loadedMesh:s,projectionPromise:null,normalsTransformPromise:null,usedMemoryInBytes:l},o._memCache.put(n,u,l,S.M4),t.loadMeshPromise=null,r(u);case 11:case"end":return e.stop()}}),e,null,[[1,6]])})));return function(t,n){return e.apply(this,arguments)}}(),e.abrupt("return",(t.loadMeshPromise=new Promise((function(e,t){return s(e,t)})),t.loadMeshPromise));case 6:return e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();function W(e){return X.apply(this,arguments)}function X(){return(X=(0,r.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{id:t.id,version:t.meshNodeInfo.version,mbs:t.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null,isEmpty:!1});case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function K(e,t,n,i){return Y.apply(this,arguments)}function Y(){return Y=(0,r.Z)((0,i.Z)().mark((function e(t,n,r,a){var s,o,l,u,d;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=n.loadedMesh,o=s.transform,l=s.vertexAttributes,null!=(u="source"===t.shading?l.normal:null)&&null!=o&&(0!==o.rotationAngle||!(0,P.e)(o.scale,F.hq))){e.next=3;break}return e.abrupt("return",{transformed:u,original:l.normal});case 3:return n.normalsTransformPromise||((0,I.O3)(r,"SceneLayerWorker is needed to transform mesh normals"),d=(0,D.Ue)(),(0,M.XL)(d,o.localMatrix),n.normalsTransformPromise=r.transformNormals({normalMatrix:d,normals:u},a)),e.abrupt("return",n.normalsTransformPromise);case 5:case"end":return e.stop()}}),e)}))),Y.apply(this,arguments)}function $(e,t,n,i,r,a){var s,o,l,u=t.length/3,d=3*u,c=0,h=!1,v=0,f=!1,_=0,g=!1,p=0;c+=ne,s=c+=ne,c+=3*d*ie,null!=n&&(h=!0,v=c,c+=3*d*ie),null!=i&&(f=!0,_=c,c+=2*d*ie),null!=r&&(g=!0,p=c,c+=4*d*re),o=c,l=c+=1*ae,c+=2*ne;var m=new ArrayBuffer(c),y=new Uint8Array(m);ee(y,0,d),ee(y,ne,1);for(var b=new Float32Array(m,s),x=null!=n?new Float32Array(m,v):null,C=null!=i?new Float32Array(m,_):null,k=null!=r?new Uint8Array(m,p):null,N=0;N<u;++N)for(var w=3*N,I=0;I<3;++I){var S=t[w+I],R=3*S,M=9*N+3*I;if(b[M]=e[R],b[M+1]=e[R+1],b[M+2]=e[R+2],null!=x&&(x[M]=n[R],x[M+1]=n[R+1],x[M+2]=n[R+2]),null!=C){var D=2*S,P=6*N+2*I;C[P]=i[D],C[P+1]=i[D+1]}if(null!=k){var F=4*S,O=12*N+4*I;k[O]=r[F],k[O+1]=r[F+1],k[O+2]=r[F+2],k[O+3]=r[F+3]}}return ee(y,o,a),ee(y,o+ne,a/Math.pow(2,32)),ee(y,l,0),ee(y,l+ne,u-1),{geometryBuffer:m,geometryDescriptor:{isDraco:!1,isLegacy:!0,color:g,normal:h,uv0:f,uvRegion:!1,featureIndex:!0}}}function ee(e,t,n){e[t]=255&n,e[t+1]=255&n>>8,e[t+2]=255&n>>16,e[t+3]=255&n>>24}function te(e){var t,n,i,r=null===(t=e.metadata.displaySource)||void 0===t?void 0:t.source;if(null==r||!Array.isArray(r)||!r.length||r[0]instanceof File)return(0,R.DO)();var s,o=r,l="",u=(0,a.Z)(o);try{for(u.s();!(s=u.n()).done;){l+=s.value.makeHash()}}catch(d){u.e(d)}finally{u.f()}return l+JSON.stringify(null!==(n=null===(i=e.transform)||void 0===i?void 0:i.toJSON())&&void 0!==n?n:"")+((0,L.zZ)(e.vertexSpace)?JSON.stringify(e.vertexSpace.origin):"")+JSON.stringify(e.spatialReference)}var ne=4,ie=4,re=1,ae=8,se=n(63780),oe=n(42537),le=n(93463),ue=function(e){(0,u.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.call(this)).referenceCount=0,e.callbacks=new Array,e.runIndex=0,e}return(0,l.Z)(n,[{key:"running",get:function(){return this.callbacks.some((function(e){return e.running}))}},{key:"runTask",value:function(e){this._sort();for(var t=this.callbacks,n={numIndexLoading:0,numNodesLoading:0},i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].runTask(e,n),this.runIndex=i}},{key:"_sort",value:function(){for(var e=this.callbacks,t=e.length,n=this.runIndex;n>0;n--){for(var i=e[n-1],r=n;r<e.length&&i.priority<=e[r].priority&&(r!==t||i.priority<e[r].priority);)e[r-1]=e[r],r++;e[r-1]=i,t=r-1}this.runIndex=0}},{key:"add",value:function(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e),this.notifyChange("running")}},{key:"remove",value:function(e){(0,se.e$)(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}}]),n}(h.default);(0,c._)([(0,y.Cb)({readOnly:!0})],ue.prototype,"running",null),ue=(0,c._)([(0,b.j)("esri.views.3d.layers.i3s.I3SFrameTask")],ue);var de=(0,l.Z)((function e(t,n){(0,o.Z)(this,e),this.task=t,this.handle=n})),ce=new Map;function he(e,t){var n=ce.get(e);if(null==n){var i=new ue,r=e.registerTask(le.T8.I3S_CONTROLLER,i);n=new de(i,r),ce.set(e,n)}return n.task.add(t),(0,oe.kB)((function(){null!=n&&(n.task.remove(t),n.task.callbacks.length>0||(ce.delete(e),n.handle.remove(),n.task.destroy()),n=null)}))}var ve=n(28554),fe=n(95964),_e=n(44011),ge=(0,l.Z)((function e(t,n,i,r,a,s,l,u){(0,o.Z)(this,e),this.id=t,this.mbs=n,this.obb=i,this.version=r,this.resources=a,this.children=s,this.lodSelection=l,this.numFeatures=u})),pe=n(2985),me=n(89414),ye=function(){function e(t,n,i,r,a){(0,o.Z)(this,e),this.childOffset=t,this.childCount=n,this.visibilityCache=i,this.ref=r,this.node=a,this.useAsHole=0,this.filterImpact=fe.U_.NotChecked,this.traversalState=null,this.parent=-1}return(0,l.Z)(e,[{key:"invalidateBounds",value:function(){var e,t;null!==(e=this.node)&&void 0!==e&&e.invalidateServiceBVsInRenderSR(),null===(t=this.ref)||void 0===t||t.invalidateServiceBVsInRenderSR()}}]),e}(),be=(0,l.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Array,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Array;(0,o.Z)(this,e),this.nodes=t,this.children=n,this.lastTraversed=0,this.numNodesWithLoadedChildren=0})),xe=function(){function e(t,n,i,r,a,s,l,u,d,c,h,v,f,g,p,m){var y,b;(0,o.Z)(this,e),this.viewingMode=t,this._layer=n,this._streamDataController=r,this._clientNodeLoader=a,this._viewportQueries=s,this._logger=l,this.holeFilling=u,this._isLoaded=d,this._isReloading=c,this._isSelected=h,this._enable=v,this._needsUpdate=f,this._canRequest=g,this._computeVisibilityObb=p,this._computeNodeFiltering=m,this._dirty=!0,this._nodePages=new Map,this._clientNodePage=null,this._pageSize=0,this._rootIndex=0,this._lodMetric=fe.w5.None,this._lodConversion=function(e){return e},this._isEditable=!1,this._urlPrefix="",this._loadingNodes=new Set,this._loadingPages=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._version=we(0),this._visibilityCacheVersion=we(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missingPagesAndNodes=new _.Z({deallocator:null}),this._prefetchNodes=new _.Z({deallocator:null}),this._updates=new ke(this._missingPagesAndNodes),this._imModificationUncategorized=new _.Z({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=new Array,this._newPages=new Array,this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._frameNumber=0,this._traverseDescendantsQueue=[0],this._traverseDescendantsNestingLevel=0,this._isEditable=(0,ve.yA)()&&null!=(null===(y=n.associatedLayer)||void 0===y?void 0:y.infoFor3D),null!==(b=n.serviceUpdateTimeStamp)&&void 0!==b&&b.lastUpdate&&(this._lastUpdate="".concat(n.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(i)}return(0,l.Z)(e,[{key:"_useNodePages",get:function(){return this._pageSize>0}},{key:"_init",value:function(e){if("page"===e.type){var t=e.rootPage;switch(this._urlPrefix=e.urlPrefix,this._pageSize=e.pageSize,e.lodMetric){case"maxScreenThreshold":this._lodMetric=fe.w5.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=fe.w5.MaxScreenThreshold,this._lodConversion=Le}if(this._isEditable){this._rootIndex=-1;var n=De(e.rootIndex,e.pageSize),i=t.nodes[n],r={nodes:[{index:this._rootIndex,children:[e.rootIndex],mesh:void 0,obb:i.obb,lodThreshold:i.lodThreshold}]};this._addPage(Me(this._rootIndex,this._pageSize),r),this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=e.rootIndex;this._addPage(Me(e.rootIndex,this._pageSize),t),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix;var a=new be;if(this._nodePages.set(0,a),this._isEditable){this._clientNodePage=new be;var s={id:"-1",version:null,mbs:e.rootNode.mbs,obb:e.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:e.rootNode.mbs,obb:e.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new fe.$i(s.id,null),-1);var o=this._validateNode(s.id,s);o&&this._addNode(o,this._rootIndex)}else this._rootIndex=this._makeRefNode(new fe.$i(e.rootNode.id,null),-1);var l=this._validateNode(e.rootNode.id,e.rootNode);l&&this._addNode(l,0)}}},{key:"addClientNodeToIndex",value:function(e,t){var n=new fe.$i(e,t),i=this._makeClientRefNode(n,-1);return this._linkChildToParentNode(-1,i),this.requestUpdate(),i}},{key:"removeClientNodeFromIndex",value:function(e,t,n){this._destroyClientRefNode(e,t,n),this.requestUpdate()}},{key:"_loadPage",value:function(e){var t=this;this._loadingPages.add(e);var n=this._urlPrefix+e;this._streamDataController.request(n,"json").then((function(n){t._pageQueue.push({pageIndex:e,page:n})})).catch((function(n){t._loadingPages.delete(e),(0,p.D_)(n)||(t._failedPages.add(e),t._logger.error("#loadPage()",t._layer,"Error when loading page ".concat(e),n))}))}},{key:"_addQueuedPages",value:function(e){for(;this._pageQueue.length>0&&!e.done;){var t=this._pageQueue.shift(),n=t.pageIndex,i=t.page;this._addPage(n,i),this._loadingPages.delete(n),e.madeProgress(),this.needNodeElevationRange&&this._newPages.push(n)}this._updateParentsAndLevel()}},{key:"_invalidateElevationRangeForNewPages",value:function(e){var t=this;if(this.needNodeElevationRange)for(;this._newPages.length>0&&!e.done;){var n=this._nodePages.get(this._newPages.shift());null===n||void 0===n||n.nodes.forEach((function(e){for(var n=e.parent;null!=n&&n!==t._rootIndex;){var i=t.getNode(n);i&&!Number.isNaN(null===i||void 0===i?void 0:i.elevationRangeMin)&&(i.invalidateElevationRange(),t.invalidateBoundingVolumeCache(n)),n=t.getParentIndex(n)}}))}}},{key:"_addPage",value:function(e,t){var n=this,i=[],r=[],a=t.nodes.map((function(t,a){var s,o,l,u=i.length,d=t.children?t.children.length:0;r.push(n._rootIndex);for(var c=0;c<d;c++)i.push(t.children[c]);var h="".concat(t.index),v=me.Oo.fromJSON(t.obb),f=(0,A.k)(v.center,v.radius),_=null===(s=t.mesh)||void 0===s?void 0:s.attribute,g=null===(o=t.mesh)||void 0===o?void 0:o.geometry,p=null===(l=t.mesh)||void 0===l?void 0:l.material,m={hasSharedResource:!1,isEmpty:null==g,attributes:null!=(null===_||void 0===_?void 0:_.resource)?"".concat(_.resource):void 0,geometry:null!=(null===g||void 0===g?void 0:g.resource)?"".concat(g.resource):void 0,texture:null!=(null===p||void 0===p?void 0:p.resource)?"".concat(p.resource):void 0,geometryDefinition:g?g.definition:-1,materialDefinition:p?p.definition:-1},y=new fe.NB(h,Pe(a,e,n._pageSize),f,d,0,m,n._lastUpdate,n._lodMetric,n._lodConversion(t.lodThreshold),g?g.featureCount:null);return y.serviceObbInIndexSR=v,y.visibilityObbInRenderSR=n._computeVisibilityObb(y),y.vertexCount=g?g.vertexCount:0,new ye(u,d,Ne(n._visibilityCacheVersion),null,y)})),s=new be(a,i);-1===e?this._clientNodePage=s:this._nodePages.set(e,s)}},{key:"_updateParentsAndLevel",value:function(){var e=this,t=new Array,n=function(n,i,r){var a=e._getPage(n);if(null!=a){var s=De(n,e._pageSize),o=a.nodes[s];o.parent=null!=i?i:-1;var l=o.node;null!=l&&(l.level=r,t.push(n))}};for(n(this._rootIndex,null,0);t.length;){var i=t.pop(),r=this.getNode(i);if(null!=r)for(var a=0;a<r.childCount;a++)n(this.getChildIndex(r.index,a),i,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}},{key:"_getPage",value:function(e){var t=Me(e,this._pageSize);return this._getPageFromPageIndex(t)}},{key:"_getPageFromPageIndex",value:function(e){return e<0?this._clientNodePage:this._nodePages.get(e)}},{key:"_getNodeInternal",value:function(e){var t=this._getPage(e);return null==t?null:(t.lastTraversed=this._frameNumber,t.nodes[De(e,this._pageSize)])}},{key:"_addNode",value:function(e,t){e.children&&this.populateChildren(t,e.children);var n=this.getParent(t),i=null!=n?n.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?i+1:i);var r=function(e){if(e)for(var t=0;t<e.length;t++){var n,i=(0,a.Z)(Fe);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r[0]===e[t].metricType)return{lodMetric:r[1],maxError:e[t].maxError}}}catch(s){i.e(s)}finally{i.f()}}return{lodMetric:fe.w5.None,maxError:0}}(e.lodSelection),s=r.lodMetric,o=r.maxError,l=this._getNodeInternal(t),u=new fe.NB(e.id,t,e.mbs,l.childCount,i,e.resources,e.version,s,o,e.numFeatures);l.node=u,e.obb&&(u.serviceObbInIndexSR=me.Oo.fromJSON(e.obb)),u.visibilityObbInRenderSR=this._computeVisibilityObb(u);var d=l.ref;return null!=d&&(null==d.serviceMbsInIndexSR&&(d.serviceMbsInIndexSR=e.mbs),u.shareServiceBVsInRenderSRWith(d),d.visibilityObbInRenderSR=u.visibilityObbInRenderSR),u}},{key:"_makeRefNode",value:function(e,t){var n=this._nodePages.get(0);if(t<-1)return this._makeClientRefNode(e,t);if(null==n)return-1;var i=n.nodes.length,r=new ye(0,0,Ne(this._visibilityCacheVersion),e,null);return n.nodes.push(r),r.parent=t,e.invalidateServiceBVsInRenderSR(),i}},{key:"_makeClientRefNode",value:function(e,t){var n=this._clientNodePage;if(null==n)return-1;if(t>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");var i=-(n.nodes.length+1),r=new ye(0,0,Ne(this._visibilityCacheVersion),e,null);return n.nodes.push(r),r.parent=t,e.invalidateServiceBVsInRenderSR(),i}},{key:"_linkChildToParentNode",value:function(e,t){var n=this._clientNodePage;if(!(null==n||e>=0)){var i=De(e,this._pageSize),r=De(t,this._pageSize),s=n.nodes[i],o=s.childOffset;n.children.splice(s.childOffset+s.childCount,0,t);s.childCount+=1,null!=s.node&&(s.node.childCount+=1);var l,u=(0,a.Z)(n.nodes);try{for(u.s();!(l=u.n()).done;){var d=l.value;d.childOffset>o&&(d.childOffset+=1)}}catch(c){u.e(c)}finally{u.f()}n.nodes[r].parent=e,this._updateParentBoundingInformation(e)}}},{key:"_destroyClientRefNode",value:function(e,t,n){var i=this,r=this._clientNodePage;if(null!=r){var a=this.getParentIndex(e);if(null!=a){var s=new Set,o=new Map;!function e(n){var a,o,l,u=De(n,i._pageSize),d=r.nodes[u];if(d.childCount>0)for(var c=d.childOffset;c<d.childOffset+d.childCount;++c)e(r.children[c]);var h=null!==(a=null===(o=d.node)||void 0===o?void 0:o.id)&&void 0!==a?a:null===(l=d.ref)||void 0===l?void 0:l.id;if(null==h)throw new Error("Node has no id");t(h,n),s.add(d)}(e);for(var l=r.nodes,u=r.children,d=r.nodes.map((function(){return-1})),c=[],h=[],v=0;v<l.length;++v){var f=l[v];if(!s.has(f)){var _=c.length,g=Pe(v,-1,this._pageSize),p=Pe(_,-1,this._pageSize);if(f.node&&(f.node.index=p),d[v]=p,c.push(f),g!==p){var m,y,b,x=null!==(m=null===(y=f.node)||void 0===y?void 0:y.id)&&void 0!==m?m:null===(b=f.ref)||void 0===b?void 0:b.id;if(null==x)throw new Error("Node has no id");n(x,g,p),o.set(g,p)}}}for(var C=0;C<c.length;++C){for(var k=Pe(C,-1,this._pageSize),N=c[C],w=h.length,I=N.childOffset;I<N.childOffset+N.childCount;++I){var S=u[I];if(S>=0)h.push(S);else{var R=De(S,this._pageSize),M=l[R];if(s.has(M))continue;var D=d[R];h.push(D),M.parent=k}}N.childOffset=w,N.childCount=h.length-w,N.node&&(N.node.childCount=N.childCount)}r.nodes=c,r.children=h,this._updateParentBoundingInformation(d[De(a,this._pageSize)])}}}},{key:"_updateParentBoundingInformation",value:function(e){var t=e;do{var n,i=null,r=this._clientNodeLoader.indexSR,a=this._clientNodeLoader.renderSR,s=this._getNodeInternal(t);if(null==s)return;for(var o=0;o<s.childCount;o++){var l=this.getChildIndex(t,o),u=this._getNodeInternal(l),d=null!=u?u.ref||u.node:null;if(null!=d&&d.serviceMbsInIndexSR[3]>0)if(null==i)i=(0,A.a)(d.serviceMbsInIndexSR,Ae);else{var c=Ee,h=Ze,v=Te;(0,O.s)(d.serviceMbsInIndexSR,r,c,a),(0,O.s)(i,r,h,a),(0,A.u)(c,h,v),(0,O.s)(v,a,i,r)}}var f=s.ref||s.node;null!=f&&(null!=i?(null!==(n=f.serviceMbsInIndexSR)&&void 0!==n||(f.serviceMbsInIndexSR=(0,A.c)()),(0,A.a)(i,f.serviceMbsInIndexSR)):(0,_e.WD)(f.serviceMbsInIndexSR),f.invalidateServiceBVsInRenderSR(),f.geometryObbInRenderSR=null),this.invalidateNodeVisibilityCacheInternal(s),t=this.getParentIndex(t)}while(null!=t)}},{key:"populateChildren",value:function(e,t){var n=this._getNodeInternal(e),i=this._getPage(e);n.childOffset=i.children.length,n.childCount=t.length;for(var r=0;r<t.length;r++){var a=this._makeRefNode(t[r],e);i.children.push(a)}}},{key:"getNode",value:function(e){var t=this._getNodeInternal(e);return null!=t?t.node:null}},{key:"getIndexById",value:function(e){var t;return this._forAllNodes((function(n,i){(null!=n.node&&n.node.id===e||null!=n.ref&&n.ref.id===e)&&(t=i)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var n=this._getPage(e);if(null==n)return-1;var i=n.nodes[De(e,this._pageSize)];return n.children[i.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this._getPage(e);return null!=t&&e!==this._rootIndex?t.nodes[De(e,this._pageSize)].parent:null}},{key:"getParent",value:function(e){var t=this.getParentIndex(e);return null!=t?this.getNode(t):null}},{key:"isLeaf",value:function(e){var t=this._getNodeInternal(e);return null!=t&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this._rootIndex)}},{key:"isEditable",get:function(){return this._isEditable}},{key:"removeAllGeometryObbs",value:function(){this._forAllNodes((function(e){null!=e.node&&(e.node.geometryObbInRenderSR=null)}))}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=we(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this._getNodeInternal(e);null!=t&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=Ne(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this._getNodeInternal(e);null!=t&&(null!==t&&void 0!==t&&t.invalidateBounds(),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"updateElevationChanged",value:function(e){var t=this._getNodeInternal(e);if(null!=t)if(this.needNodeElevationRange){var n=null!=t.node?t.node:t.ref;null!=n&&n.invalidateElevationRange()}else this.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){var t=this._getNodeInternal(e),n=null===t||void 0===t?void 0:t.node;n&&(n.geometryObbInRenderSR=null,n.invalidateServiceBVsInRenderSR())}},{key:"invalidateVisibilityObbs",value:function(){var e=this;null!=this.rootNode&&this.traverse(this.rootNode,(function(t){return t.visibilityObbInRenderSR=e._computeVisibilityObb(t),t.geometryObbInRenderSR=null,!0}))}},{key:"_isElevationRangeUpToDate",value:function(e){var t;if(!this.needNodeElevationRange)return!0;var n=null!==(t=null===e||void 0===e?void 0:e.node)&&void 0!==t?t:null===e||void 0===e?void 0:e.ref;return!n||n.elevationRangeValid}},{key:"updateElevationRange",value:function(e){this._updateElevationRangeInternal(e,null)}},{key:"_updateElevationRangeInternal",value:function(e,t){var n,i,r,a=this._getNodeInternal(e);if(!a)return!1;var s=null!==(n=null===a||void 0===a?void 0:a.node)&&void 0!==n?n:null===a||void 0===a?void 0:a.ref;if(!s)return!1;if(s.elevationRangeValid)return null!==t&&void 0!==t&&t.expandElevationRange(s),!0;for(var o=new pe.r,l=!1,u=0;u<a.childCount;u++){var d=this.getChildIndex(e,u),c=this._updateElevationRangeInternal(d,o);l=l||!c}if(0===a.childCount||l){var h,v=!(null!==(h=a.node)&&void 0!==h&&h.resources.isEmpty);this._viewportQueries.expandElevationRange(s,v,o)}var f=s.elevationRangeMin,_=s.elevationRangeMax;return f===o.elevationRangeMin&&_===o.elevationRangeMax?(null!==t&&void 0!==t&&t.expandElevationRange(s),!0):(null!==(i=a.node)&&void 0!==i&&i.setElevationRange(o),null!==(r=a.ref)&&void 0!==r&&r.setElevationRange(o),this.invalidateBoundingVolumeCache(e),null!==t&&void 0!==t&&t.expandElevationRange(s),!0)}},{key:"isNodeVisible",value:function(e){var t=this._getNodeInternal(e);if(null==t)return!0;var n=t.ref;if(null!=n&&!n.serviceMbsInIndexSR)return!0;if(this._isElevationRangeUpToDate(t)&&Se(t.visibilityCache,this._visibilityCacheVersion))return Re(t.visibilityCache);var i=t.node,r=this._viewportQueries;if(i){var a=r.ensureElevationAgnosticBoundingVolume(i),s=r.isElevationAgnosticBoundingVolumeVisible(a),o=s;if(this.needNodeElevationRange&&s){var l=r.getNodeObbInRenderSRIndependentOfElevationOffset(i);null!=l&&(o=r.isObbVisibleIndependentOfElevation(a,l))}if(!o)return t.visibilityCache=Ie(!1,this._visibilityCacheVersion),!1}if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=i||null!=n)&&t.filterImpact===fe.U_.NotChecked){var u=null!=i?i.serviceMbsInIndexSR:null!=n?n.serviceMbsInIndexSR:null;t.filterImpact=null!=u?this._computeNodeFiltering(u):fe.U_.Unmodified}var d=null!=i&&t.filterImpact===fe.U_.Culled,c=!(null!=i&&i.imModificationImpact===fe.O4.Culled)&&!d;if(c){var h=!i||n&&!i.visibilityObbInRenderSR?null!==n&&void 0!==n?n:null:i;null!=h&&(this.needNodeElevationRange&&this.updateElevationRange(e),c=r.isNodeVisible(h))}return t.visibilityCache=Ie(c,this._visibilityCacheVersion),c}},{key:"isGeometryVisible",value:function(e){var t;if(!this.isNodeVisible(e))return!1;var n=this._getNodeInternal(e);return!!(null==(null===n||void 0===n||null===(t=n.node)||void 0===t?void 0:t.geometryObbInRenderSR)||this.layerHasModifications&&n.node.imModificationImpact===fe.O4.NotChecked)||this._viewportQueries.isGeometryVisible(n.node)}},{key:"_traverseCoverage",value:function(e,t,n,i,r){var a=this._getPage(e);if(null!=a&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,l=t.childOffset;l<s;++l){var u=a.children[l],d=this._getNodeInternal(u);null!=(null===d||void 0===d?void 0:d.node)&&this.isGeometryVisible(u)&&o.push(d)}i/=o.length;for(var c=0,h=o;c<h.length;c++){var v=h[c],f=v.node.index;this._isLoaded(f)||this._isReloading(f)?(r.delta=Math.max(r.delta,n),r.coverage+=i):this._traverseCoverage(f,v,n+1,i,r)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this._getNodeInternal(e);if(null==t)return!1;if("always"===this.holeFilling)return!0;if(Se(t.useAsHole,this._version))return Re(t.useAsHole);var n={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,n);var i=n.delta*n.coverage<=.5;return t.useAsHole=Ie(i,this._version),i}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=we(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this._forAllNodes((function(e){var n=e.node;null!=n&&(n.imModificationImpact=fe.O4.NotChecked,n.visibilityObbInRenderSR=t._computeVisibilityObb(n),n.hasModifications&&t.invalidateGeometryVisibility(n.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this._forAllNodes((function(e){if(null!=e){e.filterImpact=fe.U_.NotChecked;var n=e.node;null!=n&&t.invalidateNodeVisibilityCache(n.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,n){var i=this;if(this._dirty){this._pageQueue.length>0&&this._addQueuedPages(t),this._invalidateElevationRangeForNewPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missingPagesAndNodes.clear(),this._prefetchNodes.clear(),this._updates.reset(e),Ce.clear();var r=!0,a=new Oe,s=new Oe,o=this._imModificationUncategorized;o.clear();var l=new Set,u=0;this.traverseVisible((function(l,d,c){var h=Me(l,i._pageSize);if(null==d){var v=i._entryPriority(l);return v===1/0&&(v=i._entryPriority(c)),Ce.set(h,Math.max(v,Ce.get(h)||0)),i._loadingPages.has(h)||i._failedPages.has(h)||(i._missingPagesAndNodes.push(h),++u),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,v))}var f=d.node;if(i._updateNodeFeatureEstimate(f,s),null==f){var _=i._entryPriority(l);return i._loadingNodes.has(l)||i._failedNodes.has(l)||(i._missingPagesAndNodes.push(l),Ce.set(l,_)),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,_))}var g=i._getPage(l);if(0===i._missingPagesAndNodes.length&&!i._useNodePages)for(var p=0;p<d.childCount;p++){var m=g.children[d.childOffset+p],y=i._getNodeInternal(m);null==y||y.node||i._loadingNodes.has(m)||i._failedNodes.has(m)||(Ce.set(m,i._entryPriority(m)),i._prefetchNodes.push(m))}if(f.failed||f.resources.isEmpty)r&&d.childCount>0&&i._isSelected(f)&&(r=!1);else if(i._isLoaded(l)){if(a.known+=f.memory,++a.knownNodes,i._isSelected(f)?d.childCount>0&&(r=!1):(a.unremoved+=f.memory,r=!1),i._needsUpdate(f)){var b=i._entryPriority(l);Ce.set(l,b),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,b),i._updates.update.push(l)}}else if(f.memory&&(a.known+=f.memory,++a.knownNodes),i._isSelected(f)){if(d.childCount>0&&(r=!1),f.memory?(a.missing+=f.memory,a.known+=f.memory,++a.knownNodes):++a.missingNodes,e.includes(f.index))return i._maxProcessingPrio=Math.max(i._maxProcessingPrio,i._entryPriority(l)),void(i._updates.cancel=i._updates.cancel.filter((function(e){return e!==f.index})));if(t.done||!i._enable(f)){var x=i._entryPriority(l);Ce.set(l,x),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,x),i._updates.add.push(l),i.layerHasModifications&&n&&null!=f&&f.imModificationImpact===fe.O4.NotChecked&&o.push(l)}else t.madeProgress()}else i._isReloading(l)&&i._updates.remove.push(l)}),l),this._frameNumber++,this._missingPagesAndNodes.sort((function(e,t){return e-t})),this._missingPagesAndNodes.filterInPlace((function(e,t){return t<1||i._missingPagesAndNodes.data[t-1]!==e})),this._missingPagesAndNodes.sort((function(e,t){return Ce.get(e)-Ce.get(t)})),this._missingPagesAndNodes.length>0&&(this._maxUnloadedPrio=Ce.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear()),this._removeUnusedNodePages(l,u);var d=this._updates.add;d.length>0&&this.layerHasModifications&&(o.length>0&&null!==n&&void 0!==n&&n(o),d.filterInPlace((function(e){var t=i._getNodeInternal(e),n=null==(null===t||void 0===t?void 0:t.node)||t.node.imModificationImpact!==fe.O4.Culled;return n||i.invalidateNodeVisibilityCache(e),n}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=r,this._updates.add.filterInPlace((function(e){return Ce.get(e)>=i._maxUnloadedPrio})).sort((function(e,t){return Ce.get(e)-Ce.get(t)})),this._updates.update.sort((function(e,t){return Ce.get(e)-Ce.get(t)})),this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length,this._dirty=this._indexMissing>0,Ce.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var n=this._viewportQueries.updateScreenSpaceErrorBias(t),i=t,r=t,a=n,s=10;s--;){var o=new Oe;if(this._updateFeatureEstimate(i,o),this._computeFeatureEstimate(o)<=e){if(i>=t||o.missingNodes>0||0===s)break;a=i,i=.5*(i+r)}else r=i,i=.5*(i+a)}return this._version=we(this._version),this._viewportQueries.updateScreenSpaceErrorBias(n),Math.min(t,i)}},{key:"_removeUnusedNodePages",value:function(e,t){var n=this;if(this._useNodePages){var i=e.size,r=this._nodePages,o=r.size+this._loadingPages.size+t;if(o>Ve&&o>i){var l,u=new Array,d=(0,a.Z)(r);try{for(d.s();!(l=d.n()).done;){var c=(0,s.Z)(l.value,2),h=c[0],v=c[1];0!==v.numNodesWithLoadedChildren||e.has(h)||u.push([v.lastTraversed,h])}}catch(f){d.e(f)}finally{d.f()}u.sort((function(e,t){return e[0]-t[0]})).some((function(e){var t=e[1];return n._deleteNodePage(t),r.size<=Ve}))}}}},{key:"_updateFeatureEstimate",value:function(e,t){var n=this;this._version=we(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,i){return n._updateNodeFeatureEstimate(null!=i?i.node:void 0,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){null==e||e.failed||null==e.numFeatures||this._isSelected(e)&&(null!=e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes)}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missingPagesAndNodes)}},{key:"prefetch",value:function(){return this._prefetchNodes.sort((function(e,t){return Ce.get(e)-Ce.get(t)})),this._load(this._prefetchNodes)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();){var t=e.pop();this._useNodePages&&t>=0?this._loadPage(t):this._loadNode(t)}return!0}},{key:"isLoading",get:function(){return this._indexMissing>0}},{key:"isPrefetching",get:function(){return this._prefetchNodes.length>0}},{key:"indexLoading",get:function(){return this._loadingPages.size+this._loadingNodes.size}},{key:"indexMissing",get:function(){return this._indexMissing}},{key:"unloadedMemoryEstimate",get:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"maxPriority",get:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"nodeTraversalState",value:function(e){if(null==e)return null;var t=e.index,n=this._getNodeInternal(t);if(!n)return null;var i=null===n||void 0===n?void 0:n.traversalState;if(i&&Se(i.version,this._version))return i;var r=this._viewportQueries.getLodLevel(e),a=this._viewportQueries.hasLOD(e),s=!0;if(a){var o=this.getParentIndex(t);if(null!=o){var l=this._getNodeInternal(o),u=null===l||void 0===l?void 0:l.traversalState;s=!!u&&r>u.lodLevel}else s=r>0}else s=0===e.childCount;return i?(i.lodLevel=r,i.isChosen=s,i.version=Ie(!0,this._version),i):(i=new fe.oQ(a,s,r,Ie(!0,this._version)),n.traversalState=i,i)}},{key:"_loadNode",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t){var n,r,a,s,o,l,u,d=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._loadingNodes.add(t),null!=(n=this._getNodeInternal(t).ref)){e.next=4;break}return e.abrupt("return",void this._failedNodes.add(t));case 4:if(r=n.id,a=this._urlPrefix+r,s=function(){d._loadingNodes.delete(t),0===d._missingPagesAndNodes.length&&0===d._loadingNodes.size&&d.requestUpdate()},o=null,e.prev=6,!(t>=0)){e.next=13;break}return e.next=10,this._streamDataController.request(a,"json");case 10:e.t0=e.sent,e.next=16;break;case 13:return e.next=15,this._clientNodeLoader.loadNodeJSON(r);case 15:e.t0=e.sent;case 16:o=e.t0,e.next=22;break;case 19:return e.prev=19,e.t1=e.catch(6),e.abrupt("return",(s(),void((0,p.D_)(e.t1)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+a),this._failedNodes.add(t)))));case 22:if(s(),null!=(l=this._validateNode(r,o))){e.next=26;break}return e.abrupt("return");case 26:l.obb&&this.invalidateNodeVisibilityCache(t),u=this._addNode(l,t),this.nodeTraversalState(u);case 29:case"end":return e.stop()}}),e,this,[[6,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_validateNode",value:function(e,t){var n,i,r=this;if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._layer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._layer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,'Invalid shared resource href on node "'.concat(e,'"'));var a=t.geometryData;null==a||Array.isArray(a)&&0===a.length||Array.isArray(a)&&1===a.length&&"./geometries/0"===a[0].href||this._logger.warn("#validateNode()",this._layer,'Invalid geometry data on node "'.concat(e,'"'));var s=t.attributeData,o=this._layer.attributeStorageInfo;null==s||Array.isArray(s)&&!s.some((function(e,t){var n,i;return e.href!=="./attributes/".concat(null!==(n=null===o||void 0===o||null===(i=o[t])||void 0===i?void 0:i.key)&&void 0!==n?n:"f_".concat(t),"/0")}))||this._logger.warn("#validateNode()",this._layer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var l=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:void 0,u=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,d=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var n=function(t){return r._logger.error("#validateNode()",r._layer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)n("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return n("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return n("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&r._logger.error("#validateNode()",r._layer,'Invalid node href on node "'.concat(e,'"'));var i=new fe.$i("".concat(t.id),t.mbs);return i.serviceObbInIndexSR=!r.ignoreServiceObb&&t.hasOwnProperty("obb")&&t.obb?me.Oo.fromJSON(t.obb):null,i.visibilityObbInRenderSR=r._computeVisibilityObb(i),i})).filter((function(e){return null!=e})):null,c=null!==(n=null===(i=t.featureData)||void 0===i?void 0:i.length)&&void 0!==n&&n,h=!0===t.isEmpty;return new ge(e,t.mbs,l,"string"==typeof t.version?t.version:null,{isEmpty:!c&&h,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},d,Array.isArray(t.lodSelection)?t.lodSelection:null,u)}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((function(e){null!=e.node&&(e.node.failed=!1)}))}},{key:"_entryPriority",value:function(e){var t=this._getNodeInternal(e),n=this.getParentIndex(e);if(null==t||null==n&&null==t.node)return null==n?1/0:this._entryPriority(n);var i=0;if(t.node&&null!=n){var r=this._getNodeInternal(n).traversalState;null!=r&&(i=r.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;null!=s;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=null!=t.ref?this._viewportQueries.distToPOI(t.ref):null!=t.node?this._viewportQueries.distToPOI(t.node):0;return-o-i*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e,t){var n=this._getNodeInternal(this._rootIndex);null!=n?this._traverseVisible(this._rootIndex,null,n,e,t):e(this._rootIndex,null,null)}},{key:"_traverseVisible",value:function(e,t,n,i,r){var a=Me(e,this._pageSize);if(r&&r.add(a),n.node&&0===n.childCount)this.isGeometryVisible(e)&&i(e,n,t);else if(this.isNodeVisible(e)&&(i(e,n,t),null!=n.node)){var s=this.nodeTraversalState(n.node);if(null===s||void 0===s||!s.nodeHasLOD||s.lodLevel!==this._maxLodLevel)for(var o=this._getPageFromPageIndex(a),l=0;l<n.childCount;l++){var u=o.children[n.childOffset+l],d=this._getNodeInternal(u);if(d)this._traverseVisible(u,e,d,i,r);else{if(r){var c=Me(u,this._pageSize);r.add(c)}i(u,null,e)}}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseDescendants(e,t)}},{key:"traverseDescendants",value:function(e,t){++this._traverseDescendantsNestingLevel;var n=e.index,i=this._pageSize,r=Me(n,i),a=this._getPageFromPageIndex(r);if(null!=a){var s=this._frameNumber,o=this._nodePages;a.lastTraversed=s;var l=De(n,i),u=a.nodes[l];if(0!==u.childCount){var d=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0],c=0,h=[],v=u.childOffset,f=u.childCount,_=a.children;d.length=Math.pow(2,Math.ceil(Math.log2(c+f)));for(var g=v;g<v+f;++g){var p=_[g];p>=0?(d[c]=p,++c):h.push(p)}if(h.length>0){var m=this._clientNodePage;if(m)for(var y=m.children,b=0;b<h.length;){var x=h[b];++b;var C=-x-1,k=m.nodes[C],N=k.node;if(N&&t(N)){var w=k.childCount;if(0!==w)for(var I=k.childOffset,S=I+w,R=I;R<S;++R)h.push(y[R])}}}if(c>0){var M=0;if(i>0)for(var D=r*i,P=a,F=P.nodes;M<c;){var O=d[M],L=void 0;if(++M,D<=O&&O<D+i)L=P;else{var A=O/i|0,E=o.get(A);if(void 0===E)continue;(L=E).lastTraversed=s,F=(P=L).nodes,D=i*A}var Z=F[O-D],T=Z.node;if(null!=T&&!1!==t(T)){var V=Z.childCount;if(0!==V){var j=c+V;for(d.length<j&&(d.length=Math.pow(2,Math.ceil(Math.log2(c+V))));d.length<c+V;)d.length+=d.length;for(var U=L.children,G=Z.childOffset,B=G+V,q=G;q<B;++q)d[c]=U[q],++c}}}else{var H=o.get(0);if(H)for(;M<c;){var z=d[M];++M;var Q=H.nodes[z],J=Q.node;if(J&&t(J)){var W=Q.childCount;if(0!==W){d.length=Math.max(d.length,Math.pow(2,Math.ceil(Math.log2(c+W))));for(var X=H.children,K=Q.childOffset,Y=K+W,$=K;$<Y;++$)d[c]=X[$],++c}}}}}--this._traverseDescendantsNestingLevel}}}},{key:"updateChildrenLoaded",value:function(e,t){for(var n=this.getNode(e);null!=n;){var i=n.childrenLoaded,r=i+t;n.childrenLoaded=r;var a=0===i?1:0===r?-1:0,s=n.index;0!==a&&(this._getPage(s).numNodesWithLoadedChildren+=a),n=this.getParent(s)}}},{key:"checkChildrenLoadedInvariant",value:function(){var e=this;if(null==this.rootNode)return!0;var t=[];return function n(i){var r=e._isLoaded(i.index)||e._isReloading(i.index)?1:0;return e.traverseDescendants(i,(function(e){return r+=n(e),!1})),i.childrenLoaded!==r&&t.push(i.index),r}(this.rootNode),t.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+t.join(",")),t.length>0}},{key:"updateElevationInfo",value:function(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"relative-to-scene"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}},{key:"invalidateAllElevationRanges",value:function(){this._forAllNodes((function(e){var t,n;null!==e&&void 0!==e&&e.invalidateBounds(),null!==(t=e.node)&&void 0!==t&&t.invalidateElevationRange(),null===(n=e.ref)||void 0===n||n.invalidateElevationRange()}))}},{key:"_forAllNodes",value:function(e){if(null!=this._clientNodePage)for(var t=this._clientNodePage,n=0;n<t.nodes.length;n++)e(t.nodes[n],-(n+1));var i,r=(0,a.Z)(this._nodePages);try{for(r.s();!(i=r.n()).done;)for(var o=(0,s.Z)(i.value,2),l=o[0],u=o[1],d=l*this._pageSize,c=0;c<u.nodes.length;c++)e(u.nodes[c],d+c)}catch(h){r.e(h)}finally{r.f()}}},{key:"clearCaches",value:function(){var e=this;if(this._useNodePages){var t=this._nodePages,n=new Set;this.traverseVisible((function(t){return n.add(Me(t,e._pageSize))}));var i,r=(0,a.Z)(t);try{for(r.s();!(i=r.n()).done;){var o=(0,s.Z)(i.value,2),l=o[0],u=o[1];if(0!==u.numNodesWithLoadedChildren||n.has(l)){var d,c=(0,a.Z)(u.nodes);try{for(c.s();!(d=c.n()).done;){d.value.traversalState=null}}catch(h){c.e(h)}finally{c.f()}}else this._deleteNodePage(l)}}catch(h){r.e(h)}finally{r.f()}}}},{key:"_deleteNodePage",value:function(e){this._nodePages.delete(e)}},{key:"test",get:function(){}}]),e}(),Ce=new Map,ke=function(){function e(t){(0,o.Z)(this,e),this.missing=t,this.update=new _.Z({deallocator:null}),this.add=new _.Z({deallocator:null}),this.remove=new _.Z({deallocator:null}),this.cancel=[]}return(0,l.Z)(e,[{key:"reset",value:function(e){this.add.clear(),this.update.clear(),this.cancel=e}}]),e}();function Ne(e){return(0,_e.HV)(e,-2)}function we(e){return(0,_e.HV)(e,2)}function Ie(e,t){return t+(e?1:0)}function Se(e,t){return(-2&e)===t}function Re(e){return!(1&~e)}function Me(e,t){return e<0?-1:t>0?e/t|0:0}function De(e,t){return e<0?-e-1:0===t?e:e%t}function Pe(e,t,n){return-1===t?-(e+1):0===n?e:t*n+e}var Fe=[["maxScreenThreshold",fe.w5.MaxScreenThreshold],["screenSpaceRelative",fe.w5.ScreenSpaceRelative],["removedFeatureDiameter",fe.w5.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",fe.w5.DistanceRangeFromDefaultCamera]];var Oe=(0,l.Z)((function e(){(0,o.Z)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}));function Le(e){return Math.sqrt(e*(4/Math.PI))}var Ae=(0,A.c)(),Ee=(0,A.c)(),Ze=(0,A.c)(),Te=(0,A.c)(),Ve=(0,v.Z)("esri-mobile")?100:300,je=n(21765),Ue=function(){function e(t){(0,o.Z)(this,e),this._layerView=t,this._lodGlobalDirty=!1}return(0,l.Z)(e,[{key:"startNodeLoading",value:function(e,t,n){this._maxLodLevel=n.maxLodLevel,this._index=t,this._removeNodes=e}},{key:"shouldLoadNode",value:function(e){if(null==e)return!1;var t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this._layerView.view.resourceController.memoryController.usedMemory,n=Math.max(0,Math.floor(10*(t-1)));Ge.clear(),this._lodGlobalHandling(this._index.rootNode,n,!1,!!this._layerView.nodeCrossfadingEnabled);var i=Ge.length;this._removeNodes(Ge,e);var r=Ge.length<i;return 0!==Ge.length&&(this._lodGlobalDirty=!0),Ge.clear(),r}},{key:"_lodGlobalHandling",value:function(e,t,n,i){if(null==e)return!1;var r=e.index,a=this._index,s=this._layerView,o=a.nodeTraversalState(e),l=this._isChosenMaxLOD(o),u=e.resources.isEmpty;if(l&&u)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;var d=s.isNodeLoaded(r);if(i&&d&&l){var c=!n&&this.hasNoVisibleChildren(e);s.fadeNode(r,je.B.FadeIn,!c)}var h=d&&(!s.isNodeFullyFadedIn||s.isNodeFullyFadedIn(r));if(d&&(s.updateNodeState(r,l?fe.FE.Leaf:fe.FE.Hole),l))return h&&this._removeChildrenRecursive(e),h;var v=e.childCount>0,f=v;if(v)for(var _=0;_<e.childCount;_++){var g=a.getChildIndex(r,_),p=a.getNode(g);null!=p?!a.isGeometryVisible(g)||this._lodGlobalHandling(p,t,n||h,i)||(f=!1):a.isNodeVisible(g)&&(f=!1)}var m=d&&!l&&(f||Ge.length<t);m&&Ge.push(r),!i||m||!d||n||f||s.fadeNode(r,je.B.FadeIn,!1);var y=e.resources.isEmpty;return f||h&&!m||y}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseDescendants(e,(function(e){return(t._layerView.isNodeLoaded(e.index)||t._layerView.isNodeReloading(e.index))&&Ge.push(e.index),e.childrenLoaded>0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,n=!0;return this._index.traverseDescendants(e,(function(e){return!(!n||!t._index.isNodeVisible(e.index))&&(t._layerView.isNodeLoaded(e.index)?(n=!1,!1):e.childrenLoaded>0)})),n}},{key:"_childrenRequireLoading",value:function(e){var t=this,n=!1,i=!0;return this._index.traverseDescendants(e,(function(e){if(!i||!t._index.isNodeVisible(e.index))return!1;var r=t._index.nodeTraversalState(e);return t._isChosenMaxLOD(r)&&t._index.isGeometryVisible(e.index)&&(n=!0),t._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0})),i&&n}},{key:"_isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),Ge=new _.Z({deallocator:null}),Be=n(14921),qe=n(84652),He=n(35995),ze=n(28278),Qe=n(4046),Je=function(){function e(t,n,i,r,a,s){if((0,o.Z)(this,e),this._streamDataController=n,this._logger=i,this._defaultGeometrySchema=r,this._requiredAttributes=a,this._options=s,this._logLayer=t,this._layerUrl=t.parsedUrl.path,this._geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var l=t.textureSetDefinitions;this._materialAndTextures=t.materialDefinitions.map((function(e){return(0,Qe.R0)(l,e,"integrated-mesh"===t.type)}))}}return(0,l.Z)(e,[{key:"_load",value:function(e,t,n){return this._streamDataController.request(e,t,n)}},{key:"_loadAttribute",value:function(e,t,n){var i="".concat(this._layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this._load(i,"binary",n).then((function(e){return(0,ze.qM)(t,e)}))}},{key:"loadAttributes",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n,r){var a,s,o,l,u,d,c,h=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.allSettled(n.map((function(e){return h._loadAttribute(t,e.attributeStorageInfo,r)})));case 2:for(a=e.sent,s={},o=0;o<n.length;++o)l=a[o],u=n[o],"fulfilled"===l.status?(d=l.value,s[u.name]=d):(c=l.reason,(0,p.r9)(c),this._logger.error("#loadAttributes",this._logLayer,"Failed to load attributeData for '".concat(u.name,"' on node '").concat(t.id,"'"),c));return e.abrupt("return",s);case 6:case"end":return e.stop()}}),e,this)})));return function(t,n,i){return e.apply(this,arguments)}}()},{key:"loadNodeData",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n){var r,a,s,o,l,u,d,c,h,v,f,_,g,p,m,y,b,x,C,k,N,w,I,S;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=null!=this._requiredAttributes&&t.resources.attributes?(0,Be.q6)(this.loadAttributes(t,this._requiredAttributes,n)):null,s=Ye(this._geometryDefinitions,t),o=s.bufferDefinition,l=s.bufferIndex,u=!!t.resources.geometry,d=u?(0,Be.q6)(this._loadGeometry(t.resources.geometry,l,n)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this._loadShared(t,n);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(c=e.t0,h=t.resources.materialDefinition,v=this._materialAndTextures&&null!=h&&h>=0?this._materialAndTextures[h]:null!=c?(0,Qe.Pg)(c):null,f=null===v||void 0===v?void 0:v.material,_=null!==(r=null===v||void 0===v?void 0:v.textures)&&void 0!==r?r:[],g="".concat(t.id),!(p=!u&&this._options.loadFeatureData)){e.next=26;break}return e.next=23,this._loadFeatureData(g,n);case 23:e.t1=e.sent,e.next=27;break;case 26:e.t1=null;case 27:if(m=e.t1,y=p?We(m):{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:f}}],featureDataPosition:[0,0,0]},b=null==y?Xe(m):null,x=_.length>0?(0,Be.q6)(this.loadTextures(t,_,n)):null,C=null,k=null,!d){e.next=40;break}return e.t2=Be.w6,e.next=36,d;case 36:e.t3=e.sent,C=(0,e.t2)(e.t3),N=Ke(this._defaultGeometrySchema,c),k=(0,ze.Es)(o,N);case 40:if(!x){e.next=48;break}return e.t5=Be.w6,e.next=44,x;case 44:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=49;break;case 48:e.t4=null;case 49:if(w=e.t4,!a){e.next=58;break}return e.t8=Be.w6,e.next=54,a;case 54:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=59;break;case 58:e.t7={};case 59:if(I=e.t7,S=I?{attributeData:I,loadedAttributes:this._requiredAttributes}:null,null==y){e.next=63;break}return e.abrupt("return",{geometryData:y,attributeDataInfo:S,geometryBuffer:C,geometryDescriptor:k,requiredTextures:_,textureData:w});case 63:if(null==b){e.next=65;break}return e.abrupt("return",{pointData:b,attributeDataInfo:S,geometryBuffer:C,geometryDescriptor:k,requiredTextures:_,textureData:w});case 65:throw new Error;case 66:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadShared",value:function(){var t=(0,r.Z)((0,i.Z)().mark((function t(n,r){var a,s;return(0,i.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=n.resources.geometry){t.next=2;break}return t.abrupt("return",{});case 2:return a="".concat(this._layerUrl,"/nodes/").concat(n.resources.geometry,"/shared"),t.next=5,this._load(a,"json",r);case 5:return s=t.sent,t.abrupt("return",(e._fixTextureEncodings(s),e._addAbsoluteHrefTexture(s,a),s));case 7:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"_loadTexture",value:function(e,t,n,i,r,a){var s=!1;return r===V.j.DDS_S3TC||r===V.j.KTX2||r===V.j.Basis?this._load(e,"binary",a).then((function(e){return{id:t,usage:n,data:e,encoding:r,downsampled:s}})):this._load(e,"image",a).then((function(e){var a=e;if(i&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),l=Math.ceil(e.height/2),u=document.createElement("canvas");u.width=o,u.height=l,u.getContext("2d").drawImage(e,0,0,o,l),a=u,s=!0}return{id:t,usage:n,data:a,encoding:r,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,n){var i=this,r=!!this._options.uncompressedTextureDownsamplingEnabled,a=this._options.textureUsageMask;return Promise.all(t.map((function(t){if(!(t.usage&a))return null;var s=(0,Qe.nn)(t.encodings,i._options.textureEncodings);if(null==s)return i._logger.error("#loadTextures",i._logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,l="".concat(i._layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return i._loadTexture(l,t.id,t.usage,r,s.encoding,n)})))}},{key:"_loadFeatureData",value:function(e,t){var n="".concat(this._layerUrl,"/nodes/").concat(e,"/features/0");return this._load(n,"json",t)}},{key:"_loadGeometry",value:function(e,t,n){var i="".concat(this._layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this._load(i,"binary",n)}}],[{key:"_addAbsoluteHrefTexture",value:function(e,t){var n=e.textureDefinitions;if(null!=n)for(var i=0,r=Object.keys(n);i<r.length;i++){var s,o=r[i],l=(0,a.Z)(n[o].images);try{for(l.s();!(s=l.n()).done;){var u=s.value;Array.isArray(u.href)?u.hrefConcat=u.href.map((function(e){return(0,He.hF)(e,t)})):u.hrefConcat=(0,He.hF)(u.href,t)}}catch(d){l.e(d)}finally{l.f()}}}},{key:"_fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var n in t){var i=t[n];if(Array.isArray(i.encoding))for(var r=0;r<i.encoding.length;r++){var a=i.encoding[r];"data:"===a.substring(0,5)&&(i.encoding[r]=a.substring(5))}else{var s=i.encoding;"data:"===s.substring(0,5)&&(i.encoding=s.substring(5))}}}}]),e}();function We(e){if(!e)return null;var t,n=(0,a.Z)(e.featureData);try{for(n.s();!(t=n.n()).done;){var i=t.value,r=i.geometries;if(null!=r){var s,o=(0,a.Z)(r);try{for(o.s();!(s=o.n()).done;){var l=s.value;return{featureIds:[i.id],featureDataPosition:i.position,geometries:[l]}}}catch(u){o.e(u)}finally{o.f()}}}}catch(u){n.e(u)}finally{n.f()}return null}function Xe(e){if(!e)return null;var t,n=new Array,i=(0,a.Z)(e.featureData);try{for(i.s();!(t=i.n()).done;){var r=t.value;null!=r.position&&n.push({featureIds:[r.id],featureDataPosition:r.position,geometries:[]})}}catch(s){i.e(s)}finally{i.f()}return n}function Ke(e,t){if(!e||null===t||void 0===t||!t.materialDefinitions)return e;var n=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[n].params.vertexRegions&&e.vertexAttributes.region&&delete(e=(0,qe.d9)(e)).vertexAttributes.region,e}function Ye(e,t){var n={bufferDefinition:null,bufferIndex:0},i=t.resources.geometryDefinition;if(null==e||null==i||i<0)return n;var r=i>=0?e[i].geometryBuffers:null;if(null==r)return n;for(var a=0;a<r.length;a++){var s=r[a];if(null==s.compressedAttributes)n.bufferIndex=a,n.bufferDefinition=r[a];else if("draco"===s.compressedAttributes.encoding&&!(0,v.Z)("disable-feature:i3s-draco"))return n.bufferIndex=a,n.bufferDefinition=s,n}return n}var $e=n(1413),et=function(){function e(t,n,i){(0,o.Z)(this,e),this._requester=t,this._customParameters=n,this._apiKey=i,this._activeRequests=new Set}return(0,l.Z)(e,[{key:"busy",get:function(){return this._requester.busy}},{key:"request",value:function(e,t,n){var i=this,r=new AbortController,a=(0,p.$F)(n,(function(){return r.abort()})),s={signal:r.signal,query:(0,$e.Z)((0,$e.Z)({},this._customParameters),{},{token:this._apiKey})},o=this._requester.request(e,t,s),l={response:o,abortController:r,abortHandle:a};return this._activeRequests.add(l),(0,p.Bx)(o,(function(){var e;l.abortController=null,null!==(e=l.abortHandle)&&void 0!==e&&e.remove(),l.abortHandle=null,i._activeRequests.delete(l)})),o}},{key:"cancelAll",value:function(){this._activeRequests.forEach((function(e){var t,n;null!==(t=e.abortController)&&void 0!==t&&t.abort(),e.abortController=null,null===(n=e.abortHandle)||void 0===n||n.remove()})),this._activeRequests.clear()}}]),e}(),tt=n(19093),nt=n(86361),it=n(83448),rt=n(29691),at=n(96334),st=n(95773),ot=n(55652),lt=n(92975),ut=n(55946),dt=n(69691),ct=n(78935),ht=n(8821),vt=1e5,ft=function(){function e(t,n,i,r,a,s,l,u){var d=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{};(0,o.Z)(this,e),this._indexSR=t,this._renderCoordsHelper=n,this._clippingArea=a,this._elevationProvider=s,this._viewingMode=l,this._options=d,this._frustum=(0,st.Ue)(),this._frustumMbs=(0,nt.Ue)(),this._useFrustumCulling=!1,this._poi=(0,F.Ue)(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=new me.Oo,this._tmp1=(0,F.Ue)(),this._tmp2=(0,F.Ue)(),this._tmp3=(0,F.Ue)(),this._tmp0=(0,F.Ue)(),this._screenspaceErrorBias=d.screenspaceErrorBias||1,this._progressiveLoadFactor=d.progressiveLoadFactor||1,this.updateCamera(i,r);var c=this._renderCoordsHelper.spatialReference;this._renderSR=c,this._renderSRSphericalPCPF=(0,rt.rS)(c),this._isGlobalMode=c===this._renderSRSphericalPCPF,this.updateElevationInfo(u),this._tmpPoint=(0,ut.T)(0,0,0,t),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(c.isWebMercator||(0,lt.QM)(c)),this._indexSREllipsoidRadius=(0,it.Iu)(this._indexSR).radius,this._indexSRSphericalPCPF=(0,rt.rS)(t),this._projectorIndexSRToIndexSRSphericalPCPF=(0,at.R8)(this._indexSR,this._indexSRSphericalPCPF)}return(0,l.Z)(e,[{key:"_frustumMbsCenter",get:function(){return this._frustumMbs}},{key:"_frustumMbsRadius",get:function(){return this._frustumMbs[3]}},{key:"_frustumPlanes",get:function(){return this._frustum}},{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=ct.o.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext((0,ht.bw)((0,ht.WI)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){if(this._useFrustumCulling=t,t){(0,st.q_)(e.viewMatrix,e.projectionMatrix,this._frustum,gt);var n=e.eye,i=_t;(0,P.n)(i,e.viewForward);var r=pt;(0,P.z)(r,gt[4],n);var a=.5*(0,P.m)(r,r)/(0,P.m)(i,r),s=this._frustumMbs;(0,P.r)(s,n,i,a);var o=1+a;s[3]=o}this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}},{key:"updateClippingArea",value:function(e){this._clippingArea=e}},{key:"expandElevationRange",value:function(e,t,n){var i,r;if(null!=this._elevationContext){var a=e.serviceMbsInIndexSR;if(a){var s="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds){var o=this._elevationProvider.getSphereElevationBounds(a,this._indexSR,s);o&&n.expandElevationRange(o)}else{var l=a[0],u=a[1],d=a[2],c=this._elevationProvider.getElevation(l,u,d,this._indexSR,s);c&&n.expandElevationRangeValues(c,c);var h=t?null:null===(i=(r=this._elevationProvider).getRootElevationBounds)||void 0===i?void 0:i.call(r);h&&n.expandElevationRange(h)}}}}},{key:"getServiceMbsInRenderSR",value:function(e){var t=e.serviceMbsInRenderSR;if((0,_e.c$)(t))return t;e.serviceMbsInIndexSR&&(0,tt.c)(t,e.serviceMbsInIndexSR);var n=e.elevationRangeMin;if(this._elevationContext&&Number.isFinite(n)){var i=0,r=0,a=e.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":case"relative-to-scene":i=this._elevationContext.geometryZWithOffset(t[2],this._renderCoordsHelper)+n-t[2],r=a-n;break;case"on-the-ground":i=n-t[2],r=a-n}t[2]+=i+.5*r,t[3]+=.5*r}else this._elevationContext&&t[3]<vt&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=(0,dt.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return(0,O.s)(t,this._indexSR,t,this._renderSR),t}},{key:"getAndUpdateVisibilityObbInRenderSR",value:function(e){var t=e.visibilityObbInRenderSR;if(t)return t;var n=.01*this._indexSREllipsoidRadius,i=e.serviceMbsInIndexSR,r=e.serviceObbInIndexSR;if(null==r||!i||!r.isValid||this._isECEFOBBInLocalMode&&(r.halfSizeX>n||r.halfSizeY>n||r.halfSizeZ>n))return null;var a=e.serviceObbInRenderSR;if(null==a)a=new me.Oo,e.serviceObbInRenderSR=a;else if(a.isValid)return a;var s=i[3],o=0,l=0,u=r.centerZ,d=this._renderCoordsHelper,c=this._elevationContext;if(c&&e.elevationRangeValid){var h=e.elevationRangeMin,v=e.elevationRangeMax;switch(c.mode){case"relative-to-ground":case"relative-to-scene":o=c.geometryZWithOffset(u,d)+h-u,l=v-h;break;case"on-the-ground":o=h-u,l=v-h}}else if(c&&s<vt){var f=this._tmpPoint;f.x=r.centerX,f.y=r.centerY,f.z=u,o=(0,dt.w7)(f,this._elevationProvider,c,d)-u}var _=l>0,g=_?this._tmpObb:a;return r.transform(g,this._indexSR,this._renderSR,o,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),_&&(0,me.gI)(g,0,l,this._viewingMode,a),a}},{key:"getNodeObbInRenderSRIndependentOfElevationOffset",value:function(e){var t,n,i=null!==(t=null!==(n=e.visibilityObbInRenderSR)&&void 0!==n?n:e.serviceObbInRenderSR)&&void 0!==t?t:null;if(null!==i&&void 0!==i&&i.isValid)return i;var r=e.serviceObbInIndexSR;return r?(r.transform(Ct,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),Ct):null}},{key:"ensureElevationAgnosticBoundingVolume",value:function(e){return-1===e.elevationAgnosticBoundingVolume[3]&&e.level>0&&(this._viewingMode===N.JY.Global?this._updateElevationAgnosticBoundingVolumeGlobal(e):this._updateElevationAgnosticBoundingVolumeLocal(e)),e.elevationAgnosticBoundingVolume}},{key:"_updateElevationAgnosticBoundingVolumeGlobal",value:function(e){var t,n=this.getNodeObbInRenderSRIndependentOfElevationOffset(e),i=e.elevationAgnosticBoundingVolume,r=-1;if(n){var s=kt;n.getCenter(s),(0,P.n)(s,s),t=s,n.getCorners(Nt);var o,l=(0,a.Z)(Nt);try{for(l.s();!(o=l.n()).done;){var u=o.value;(0,P.n)(u,u);var d=(0,P.m)(u,s);if(d<=0)return void(i[3]=-1);var c=Math.sqrt(1-d*d);r=Math.max(r,c)}}catch(g){l.e(g)}finally{l.f()}}else{var h=e.serviceMbsInRenderSR;if(!(0,_e.c$)(h))return void(i[3]=-1);var v=(0,P.c)(kt,(0,A.g)(h)),f=h[3],_=(0,P.H)(v);if(_<f)return void(i[3]=-1);r=f/_,(0,P.n)(v,v),t=v}(0,tt.h)(i,t);i[3]=r+.001}},{key:"_updateElevationAgnosticBoundingVolumeLocal",value:function(e){var t=e.elevationAgnosticBoundingVolume,n=this.getNodeObbInRenderSRIndependentOfElevationOffset(e);if(n){var i=n.getCenter(kt);i[2]=0,(0,tt.h)(t,i);var r=0,s=wt;n.getCorners(Nt);var o,l=(0,a.Z)(Nt);try{for(l.s();!(o=l.n()).done;){var u=o.value;u[2]=0;var d=(0,P.w)(s,u);r=Math.max(r,d)}}catch(v){l.e(v)}finally{l.f()}t[3]=Math.sqrt(r)}else{var c=e.serviceMbsInRenderSR;if((0,_e.c$)(c)){var h=(0,P.c)(kt,(0,A.g)(c));h[2]=0,(0,tt.h)(t,h),t[3]=c[3]}}}},{key:"isNodeVisible",value:function(e){var t=this.getServiceMbsInRenderSR(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;var n=this.getAndUpdateVisibilityObbInRenderSR(e);return n?n.doesIntersectFrustumConservativeApproximation(this._frustum):(0,st.hr)(this._frustum,(0,A.w)(t))}},{key:"isElevationAgnosticBoundingVolumeVisible",value:function(e){return!this._useFrustumCulling||-1===e[3]||(this._viewingMode===N.JY.Global?this._isConeVisibleInFrustum(e):this._isCylinderVisibleInFrustum(e))}},{key:"_isConeVisibleInFrustum",value:function(e){if(!this._isConeVisibleInFrustumMbs(e))return!1;var t=e[3];if(-1===t||t>.9)return!0;var n=this._frustumPlanes,i=this._frustumMbsCenter,r=e,s=(0,P.m)(r,i),o=this._frustumMbsRadius,l=s-o,u=s+o;if(l<=0)return!0;var d,c=(0,P.j)(yt,r,l),h=(0,P.j)(bt,r,u),v=t/Math.sqrt(1-t*t),f=(0,a.Z)(n);try{for(f.s();!(d=f.n()).done;){var _=d.value,g=(0,ot.st)(_),p=(0,P.n)(xt,g),m=(0,P.m)(p,r);if(!(Math.abs(1-m)<.01)){var y=It;(0,P.j)(y,r,m),(0,P.z)(y,y,p),(0,P.n)(y,y);var b=St;if((0,P.r)(b,c,y,l*v),!((0,ot.jH)(_,b)<=0)&&((0,P.r)(b,h,y,u*v),!((0,ot.jH)(_,b)<=0)))return!1}}}catch(x){f.e(x)}finally{f.f()}return!0}},{key:"_isConeVisibleInFrustumMbs",value:function(e){var t=e[3];if(t>.9)return!0;var n=this._frustumMbsRadius,i=this._frustumMbsCenter,r=(0,P.H)(i);if(r<=n)return!0;var a=e,s=(0,P.m)(a,i),o=(0,P.j)(mt,a,s);if((0,P.F)(o,i)<n)return!0;var l=s/r;if(s<=0)return-l<n;var u=Math.sqrt(1-l*l);if(u<t)return!0;var d=n/r;return u*Math.sqrt(1-d*d)-d*l<t}},{key:"isObbVisibleIndependentOfElevation",value:function(e,t){if(!this._useFrustumCulling)return!0;if(-1===e[3])return!0;var n=this._frustumMbsRadius,i=this._frustumMbsCenter,r=this._frustumPlanes,s=Nt;if(t.getCorners(s),this._viewingMode===N.JY.Global){var o=e,l=(0,P.m)(o,i),u=l-n,d=l+n;if(u<=0)return!0;var c,h=(0,a.Z)(r);try{for(h.s();!(c=h.n()).done;){var v,f=c.value,_=!0,g=(0,a.Z)(s);try{for(g.s();!(v=g.n()).done;){var p=v.value,m=(0,P.m)(p,o),y=Rt;if((0,P.j)(y,p,u/m),(0,ot.jH)(f,y)<=0){_=!1;break}var b=Rt;if((0,P.j)(b,p,d/m),(0,ot.jH)(f,b)<=0){_=!1;break}}}catch(T){g.e(T)}finally{g.f()}if(_)return!1}}catch(T){h.e(T)}finally{h.f()}}else{var x,C=i[2]-n,k=i[2]+n,w=(0,a.Z)(r);try{for(w.s();!(x=w.n()).done;){var I,S=x.value,R=!0,M=(0,ot.st)(S),D=M[0],F=M[1],O=M[2],L=S[3],A=(0,a.Z)(s);try{for(A.s();!(I=A.n()).done;){var E=I.value,Z=D*E[0]+F*E[1]+L;if(Z+O*C<=0||Z+O*k<=0){R=!1;break}}}catch(T){A.e(T)}finally{A.f()}if(R)return!1}}catch(T){w.e(T)}finally{w.f()}}return!0}},{key:"_isCylinderVisibleInFrustum",value:function(e){var t=this._frustumMbsCenter,n=this._frustumMbsRadius,i=(0,P.c)(mt,t);i[2]=0;var r=e[3];return(0,P.F)(i,e)<=r+n}},{key:"isGeometryVisible",value:function(e){var t;if(!this._useFrustumCulling)return!0;var n=e.geometryObbInRenderSR;return null!==(t=null===n||void 0===n?void 0:n.doesIntersectFrustumConservativeApproximation(this._frustum))&&void 0!==t?t:this.isNodeVisible(e)}},{key:"_isMBSinClippingArea",value:function(e){return null==this._clippingArea||(0,_e.cr)(this._clippingArea,e)!==_e.pD.OUTSIDE}},{key:"_screenSpaceDiameterMbs",value:function(e,t){var n=this.getServiceMbsInRenderSR(e),i=Math.sqrt((0,P.a)((0,A.g)(n),this._camPos)),r=i-n[3];return this._updateMinMaxDistance(i),r<0?.5*Number.MAX_VALUE:t/r*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getServiceMbsInRenderSR(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getServiceMbsInRenderSR(e),n=(0,P.p)((0,A.g)(t),this._camPos);return this._updateMinMaxDistance(n),n}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getServiceMbsInRenderSR(e),n=t[3],i=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,P.l)((0,A.g)(t))+n)/(0,P.p)((0,A.g)(t),this._camPos);return Math.min(1,i)}},{key:"hasLOD",value:function(e){return e.lodMetric!==fe.w5.None}},{key:"_getDistanceGlobeMode",value:function(e,t){var n=(0,P.l)((0,A.g)(t)),i=(0,P.l)(e)-n;(0,P.j)(this._tmp0,e,(0,P.m)(e,(0,A.g)(t))/(0,P.q)(e));var r=(0,P.a)((0,A.g)(t),this._tmp0),a=t[3];if(r<=a*a)return Math.abs(i);var s=(0,P.j)(this._tmp0,(0,A.g)(t),1/n),o=n,l=a*a/2/o,u=(0,P.j)(this._tmp1,s,o-l),d=e,c=(0,P.f)(this._tmp2,d,u),h=(0,P.f)(this._tmp2,c,(0,P.j)(this._tmp3,s,(0,P.m)(s,c))),v=(0,P.g)(this._tmp2,u,(0,P.j)(this._tmp2,h,a/(0,P.l)(h))),f=(0,P.p)(d,v);if(i>=2e5){var _=(0,P.f)(this._tmp1,d,v),g=(0,P.m)(_,s)/(0,P.l)(_);g<.08&&(g=1e-4),f/=g}return f}},{key:"_getDistance",value:function(e,t){return this._isGlobalMode?this._getDistanceGlobeMode(e,t):function(e,t){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],a=n*n+i*i,s=t[3];if(a<=s*s)return Math.abs(r);var o=Math.sqrt(a)-s;return Math.sqrt(r*r+o*o)}(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(e.lodMetric===fe.w5.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){var t=this._progressiveLoadFactor*this._screenspaceErrorBias,n=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,n)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case fe.w5.ScreenSpaceRelative:var n=this.getServiceMbsInRenderSR(e),i=this._getDistance(this._camPos,n),r=2*i/this._screenSizeFactor,a=i+n[3];return this._updateMinMaxDistance(a),e.maxError*t<=r;case fe.w5.MaxScreenThreshold:var s=this._screenSpaceDiameterMbs(e,e.serviceMbsInIndexSR[3]*t);return this._options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case fe.w5.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case fe.w5.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getServiceMbsInRenderSR(e);return(0,P.p)((0,A.g)(t),this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return(0,P.p)(this._camPos,this._poi)}}]),e}();var _t=(0,F.Ue)(),gt=(0,st.Hf)(),pt=(0,F.Ue)(),mt=(0,F.Ue)(),yt=(0,F.Ue)(),bt=(0,F.Ue)(),xt=(0,F.Ue)(),Ct=new me.Oo,kt=(0,F.Ue)(),Nt=[(0,F.Ue)(),(0,F.Ue)(),(0,F.Ue)(),(0,F.Ue)(),(0,F.Ue)(),(0,F.Ue)(),(0,F.Ue)(),(0,F.Ue)()],wt=(0,F.Ue)(),It=(0,F.Ue)(),St=(0,F.Ue)(),Rt=(0,F.Ue)(),Mt=n(65206),Dt=n(45888),Pt=n(31195),Ft=1e-4,Ot=function(e){(0,u.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).screenSizeFactor=0,i.featureTarget=5e4,i.fixedFeatureTarget=!1,i.updating=!0,i.updatingProgress=1,i.leavesReached=!1,i.worker=null,i._featureLOD=1,i._stableFeatureLOD=!1,i._isIdle=!1,i._cameraDirty=!0,i._invisibleDirty=!1,i._idleStateCallbacks=null,i._newLoadingNodes=new _.Z({deallocator:null}),i._modificationsNodeFilteringArray=new _.Z,i._downloadingCount=0,i._loadingNodes=new Map,i._updatingNodes=new Map,i._progressMaxNumNodes=1,i._requiredAttributes=new Array,i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableIDBCache=!1,i._disableMemCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._idleQueue=new k.b,i._elevationUpdateNodes=new _.Z({deallocator:null}),i._errorCount=0,i}return(0,l.Z)(n,[{key:"isMeshPyramid",get:function(){var e;return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===(null===(e=this.layer.store)||void 0===e?void 0:e.lodType)}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"useMaximumNumberOfFeatures",get:function(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(Dt.Bh.I3S_INDEX);return new et(e,this.layer.customParameters,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(Dt.Bh.I3S_DATA);return new et(e,this.layer.customParameters,this.layer.apiKey)}},{key:"crsVertex",get:function(){return(0,_e.T2)(this.layer)}},{key:"crsIndex",get:function(){return(0,_e.tp)(this.layer)}},{key:"layer",get:function(){return this.layerView.i3slayer}},{key:"running",get:function(){return this.updating}},{key:"rootNodeVisible",get:function(){if(this._index){var e=this._index.rootNode;if(e)return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"requiredAttributes",get:function(){return this._requiredAttributes}},{key:"initialize",value:function(){var e=this,t=this.layerView,n=this.layer;this._disableMemCache=!t.loadCachedGPUData||!t.addCachedGPUData,this._lodHandling=new Ue(t),this._defaultGeometrySchema=n.store.defaultGeometrySchema,this.disableIDBCache=(0,v.Z)("disable-feature:idb-cache"),"fields"in n&&(this._fields=n.fields,this._attributeStorageInfo=n.attributeStorageInfo),this.addResolvingPromise(Promise.all([n.indexInfo,n.when(),t.when()]).then((function(i){var r=(0,s.Z)(i,1)[0];if(!e.destroyed&&t&&!t.destroyed&&r){var o=t.view,l=t.clientGeometry,u=o.resourceController;if(e._setClippingArea(o.clippingArea),e.addHandles([(0,m.watch)((function(){var e,t;return null===o||void 0===o||null===(e=o.pointsOfInterest)||void 0===e||null===(t=e.focus)||void 0===t?void 0:t.renderLocation}),(function(t){return e._pointOfInterestChanged(t)}),m.initial),(0,m.watch)((function(){return o.quality}),(function(){return e._setCameraDirty()}),m.sync),(0,m.watch)((function(){return t.contentVisible}),(function(t){var n=t?function(){return e._updateIdleState(!0)}:function(){return e._updateViewData()},i=t?function(){return e._updateIdleState(!1)}:function(){};t&&null!=e._index&&e._index.invalidateAllElevationRanges(),e._idleStateCallbacks?(t||e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=n,e._idleStateCallbacks.idleEnd=i):e._idleStateCallbacks=u.scheduler.registerIdleStateCallbacks(n,i)}),m.initial),he(t.view.resourceController.scheduler,e),(0,m.watch)((function(){return t.uncompressedTextureDownsamplingEnabled}),(function(){return e.restartNodeLoading()})),(0,m.watch)((function(){return[e.featureTarget,e.fixedFeatureTarget]}),(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),(0,m.watch)((function(){var e;return null===(e=o.state)||void 0===e?void 0:e.contentCamera}),(function(){return e._setCameraDirty()})),(0,m.watch)((function(){return n.elevationInfo}),(function(t){return e._elevationInfoChanged(t)})),(0,m.watch)((function(){return t.lodFactor}),(function(){return e._setCameraDirty()})),(0,m.watch)((function(){return t.availableFields}),(function(){return e._requiredFieldsChange()})),(0,m.watch)((function(){return t.holeFilling}),(function(t){return null!=e._index&&(e._index.holeFilling=t)}))]),e._viewportQueries=new ft(e.crsIndex,o.renderCoordsHelper,o.state.contentCamera,!o.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,e.isMeshPyramid?o.basemapTerrain:o.elevationProvider,(0,N.wg)(o.viewingMode),e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e._lod,angleDependentLoD:e._lod<.5}),e._clientNodeLoader=new J(e.layer.uid,{indexSR:e.crsIndex,vertexSR:e.crsVertex,renderSR:o.renderCoordsHelper.spatialReference,localMode:"local"===o.viewingMode},o.resourceController.memoryController,e.worker),e._index=new xe((0,N.wg)(o.viewingMode),n,r,e.indexStreamController,e._clientNodeLoader,e._viewportQueries,f.Z.getLogger(e),t.holeFilling,(function(e){return t.isNodeLoaded(e)}),(function(e){return t.isNodeReloading(e)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,fe.FE.Leaf)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(e){var n,i;return null!==(n=null===(i=t.computeVisibilityObb)||void 0===i?void 0:i.call(t,e))&&void 0!==n?n:null}),null!==t&&void 0!==t&&t.computeNodeFiltering?function(e){return t.computeNodeFiltering(e)}:void 0),e._index.updateElevationInfo(e.layer.elevationInfo,e.isMeshPyramid||e.isGraphics3D),e._index.imModificationsChanged(!!t.hasModifications),e._index.layerFilterChanged(!!t.hasGeometryFilter),null!=l){var d,c=(0,a.Z)(l);try{for(c.s();!(d=c.n()).done;){var h=d.value;e._addMesh(h.mesh,h.oid)}}catch(v){c.e(v)}finally{c.f()}e.addHandles(l.on("change",(function(t){var n,i=(0,a.Z)(t.removed);try{for(i.s();!(n=i.n()).done;){var r=n.value;e._removeMesh(r.oid)}}catch(v){i.e(v)}finally{i.f()}var s,o=(0,a.Z)(t.added);try{for(o.s();!(s=o.n()).done;){var l=s.value;e._addMesh(l.mesh,l.oid)}}catch(v){o.e(v)}finally{o.f()}})))}e._startNodeLoading()}})))}},{key:"updateNodeModificationStatus",value:function(e){var t=this,n=this._index,i=this.layerView;null!=n&&(null===i||void 0===i?void 0:i.updateNodeModificationStatus)&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var i=n.getNode(e);null!=i&&t._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._nodeLoader=null,At.prune(),null!=Lt&&(Lt.hide(),Lt=null)}},{key:"viewportQueries",get:function(){return this._viewportQueries}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,n=this.layer.objectIdField;return this.layerView.availableFields.map((function(n){var i=Zt(e,n),r=Zt(t,n);return i>=0&&r>=0?{index:i,name:t[r].name,field:t[r],attributeStorageInfo:e[i]}:null})).filter((function(e){return null!=e&&e.name!==n}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Et(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=(0,C.Ue)();(0,Mt.G)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(e),null!=this._index&&(this._index.progressiveLoadPenalty=jt.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"_addMesh",value:function(e,t){if(null!=this._index){var n=this._clientNodeLoader.createMeshNodeInfo(e,t),i=this._index.addClientNodeToIndex(n.id,n.mbs);this._clientNodeLoader.addMeshNode(i,n),this._evaluateUpdating(),this.notifyChange("rootNodeVisible")}}},{key:"_removeMesh",value:function(e){var t=this,n=this._clientNodeLoader.getMeshNodeIndex(e);if(null!=n){if(null==this._index)throw new Error("delayed removal of client side i3s node geometry not supported yet.");this._index.removeClientNodeFromIndex(n,(function(e,n){var i,r,a,s;t.layerView.removeNode(n),t._clientNodeLoader.removeNode(e),t.layerView.deleteCachedNodeData&&null!=e&&t.layerView.deleteCachedNodeData(e),null===(i=(r=t.layerView).deleteCachedGPUData)||void 0===i||i.call(r,null===(a=(s=t.layerView).loadCachedGPUData)||void 0===a?void 0:a.call(s,n))}),(function(e,n,i){t._clientNodeLoader.updateNodeIndex(e,n,i),t.layerView.updateNodeIndex&&t.layerView.updateNodeIndex(n,i)})),this.notifyChange("rootNodeVisible")}}},{key:"updateElevationChanged",value:function(e,t){var n=this._index;if(null==(null===n||void 0===n?void 0:n.rootNode)||null==t)return null;this.crsIndex.equals(t)||((0,x.d)(e,t,Ut,this.crsIndex),e=Ut);var i=this._elevationUpdateNodes;return i.clear(),(0,_e.tS)(e,n.rootNode,n,(function(e){return i.push(e.index)})),i.length&&(i.forAll((function(e){return n.updateElevationChanged(e)})),this._setCameraDirty()),i}},{key:"removeAllGeometryObbs",value:function(){null!=this._index&&this._index.removeAllGeometryObbs()}},{key:"getRenderMbs",value:function(e){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(e):null}},{key:"_elevationInfoChanged",value:function(e){null!=this._index&&(this._index.updateElevationInfo(e,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"_isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"unloadedMemoryEstimate",get:function(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}},{key:"_loadNodeData",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.index<0?this._clientNodeLoader.loadNodeData(t.id,n):this._nodeLoader.loadNodeData(t,n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadAttributes",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(t.index<0?this._clientNodeLoader:this._nodeLoader).loadAttributes(t,n,r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n,i){return e.apply(this,arguments)}}()},{key:"indexDepth",get:function(){return null!=this._index?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData?this._disableMemCache=e:this._disableMemCache=!0}},{key:"runTask",value:function(e,t){return this.layerView.contentVisible?this.layerView.visible&&null!=this._index?(this._processWithErrorLogging(e,t),this._index.maxPriority):-1/0:(this._updateViewData(),this._evaluateUpdating(),-1/0)}},{key:"_processWithErrorLogging",value:function(e,t){try{this._process(e,t)}catch(n){this._errorCount<50?f.Z.getLogger(this).error("Error during processing: ".concat(n," at ").concat(n.stack)):50===this._errorCount&&f.Z.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var n=this;this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(e.enabled=!1),e.run((function(){return n._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return n._processCache(e)})),this._isIntegratedMesh&&(e.enabled=!0),e.run((function(){return n._processNodes(e,t)})),this._idleQueue.runTask(e),e.run((function(){return n._prefetchIndex()})),t.numIndexLoading+=this._index.indexLoading,t.numNodesLoading+=this._downloadingCount,e.run((function(){return n._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating())}},{key:"_processIndex",value:function(e){var t=this;if(null==this._index)return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var n=this._index.featureEstimate.leavesReached;this._index.isLoading||n===this._get("leavesReached")||this._set("leavesReached",n)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!(null==this._index||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.useMaximumNumberOfFeatures&&null!=this._index&&null!=this._viewportQueries){var e=!this._index.isLoading,t=this.featureTarget*this._baseLOD,n=this._index.featureEstimate;if(n.estimate=n.estimate||t/2,this._index.indexMissing>500){if(this._featureLOD<=Ft)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&n.estimate<t){if(n.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/n.estimate,1.001));this._featureLOD*=i;var r=this._lod,a=this._index.checkFeatureTarget(t,r);a!==r&&(this._featureLOD=a/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(n.estimate>1.2*t||e&&n.estimate>t))return;if(this._featureLOD<=Ft)return;this._featureLOD/=1+.25*(n.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Ft,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if(null==t)return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var n=this._newLoadingNodes.pop(),i=t.getParent(n);null!=i&&!this.layerView.isNodeLoaded(i.index);i=t.getParent(i.index))if(this._enableFromGPUCache(i,fe.FE.Hole)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if(null==this._index)return!1;var n=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.remove.length>0&&!e.done;)this.layerView.removeNode(i.remove.pop()),e.madeProgress();for(;i.update.length>0&&!e.done;){var r=this._index.getNode(i.update.pop());null!=r&&(this._updateLoadedNode(r),e.madeProgress())}for(;i.add.length>0&&!e.done&&n>0;){--n;var a=this._index.getNode(i.add.back());if(null==a||a.cacheState!==fe.Hw.Cached&&!this._hasNodeLoadToken(t))break;i.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Dt.NT&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView){if(this.layerView.contentVisible){var n=(null!=this._index?this._index.indexMissing:0)+3*(null!=this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(n>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===n&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(n,this._progressMaxNumNodes),t=1-n/this._progressMaxNumNodes}else t=(e=this._cameraDirty)?0:1;this.updating=e,this.updatingProgress=t}}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&null!=this._index&&null!=this._viewportQueries){var e=this.layerView.view,t=e.state,n=t.contentCamera,i=t.fixedContentCamera;this.screenSizeFactor=1/(n.perScreenPixelRatio/2),this._viewportQueries.updateCamera(n,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=jt.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.quality<1?1:this.layerView.progressiveLoadFactor}},{key:"_lod",get:function(){return this._featureLOD*this._baseLOD}},{key:"_baseLOD",get:function(){var e=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*this.layerView.view.quality}},{key:"_lodDropFactor",get:function(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-Pt.d)/(.5-Pt.d)}},{key:"isGeometryVisible",value:function(e){var t;return!(null===(t=this._index)||void 0===t||!t.isGeometryVisible(e.index))}},{key:"updateVisibility",value:function(e){var t;null===(t=this._index)||void 0===t||t.invalidateNodeVisibilityCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){var t;null===(t=this._index)||void 0===t||t.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){var e;null===(e=this._index)||void 0===e||e.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){var e;null!==(e=this._index)&&void 0!==e&&e.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&!(null==this._index||!this._index.isGeometryVisible(e.index))}},{key:"_shouldDropNode",value:function(e){if(null==this._viewportQueries)return!1;var t=this._lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!this._updatesDisabled&&null!=t&&null!=this._viewportQueries){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var n={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new Je(this.layer,this.dataStreamController,f.Z.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,n),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t,n){return e._removeNodes(t,n,Tt.fadeout)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,n=this._index;if(null==n||null==this._viewportQueries)return!1;At.clear(),this.layerView.getLoadedNodeIndices(At);var i=0===this._viewportQueries.maxDistance,r=i?function(){return!1}:function(e){return t._shouldDropNode(e)};return At.filterInPlace((function(e){var t=n.getNode(e);return null==t||!n.isGeometryVisible(e)||r(t)})),At.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(At,e,Tt.pop),!(i&&this._lodDropFactor<1)&&(0===At.length||(At.clear(),!1))}},{key:"markNodeToRemove",value:function(e){At.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(At,le.G5,Tt.pop)}},{key:"_removeNodes",value:function(e,t,n){if(0!==e.length&&!t.done)for(null!=this._index&&this._index.requestUpdate();e.length>0&&!t.done;){var i=e.pop(),r=this._index;n===Tt.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=r&&r.isGeometryVisible(i)?this.layerView.fadeNode(i,je.B.FadeOut,!0):this.layerView.removeNode(i),t.madeProgress()}}},{key:"_needsUpdate",value:function(e){if(e.resources.isEmpty||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t){var n,r,a,s=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=new AbortController,this._updatingNodes.set(t.index,n),this._evaluateUpdating(),e.prev=2,r=Et(this.layerView.getLoadedAttributes(t.index),this._requiredAttributes),a=null,!r){e.next=9;break}e.t0=this.layerView.getAttributeData(t.index),e.next=12;break;case 9:return e.next=11,this._loadAttributes(t,this._requiredAttributes,n.signal);case 11:e.t0=e.sent;case 12:return a=e.t0,e.next=15,this.schedule((function(){return s.layerView.updateAttributes(t.index,{loadedAttributes:s._requiredAttributes,attributeData:a},n.signal)}),n.signal);case 15:e.next=21;break;case 17:if(e.prev=17,e.t1=e.catch(2),(0,p.D_)(e.t1)){e.next=21;break}return e.abrupt("return",this.layerView.updateAttributes(t.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},n.signal));case 21:this._updatingNodes.delete(t.index),this._evaluateUpdating();case 22:case"end":return e.stop()}}),e,this,[[2,17]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))f.Z.getLogger(this).error("already loading node "+e.index);else{var n=new AbortController;this._loadingNodes.set(e.index,n),this._evaluateUpdating(),this._loadAndAddNode(e,n.signal).then((function(i){i&&null!=t._index&&t._loadingNodes.get(e.index)===n&&(t._loadingNodes.delete(e.index),t._index.requestUpdate())})).catch((function(e){if(!(0,p.D_)(e))throw e})).finally((function(){t._loadingNodes.get(e.index)===n&&t._loadingNodes.delete(e.index),t._evaluateUpdating()}))}}},{key:"_loadAndAddNode",value:function(e,t){return e.cacheState===fe.Hw.Uncached?this._loadUncached(e,t).then((function(){return!1})):this._loadCached(e,t).then((function(t){return!t&&(e.cacheState=fe.Hw.Uncached,!0)})).catch((function(t){return!(0,p.D_)(t)&&(e.cacheState=fe.Hw.Uncached,!0)}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||null==this._index)return!1;if(t===fe.FE.Hole&&!this._index.useNodeAsHole(e.index))return!0;var n=this._loadCachedGPUData(e);return!!n&&(this.layerView.addCachedGPUData(e,n,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e.index);return null!=(null===t||void 0===t?void 0:t.attributeInfo)&&Et(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){null!=this._index&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateLoadStatus",value:function(e,t){var n=this._index;null!=n&&n.updateChildrenLoaded(e,t?1:-1)}},{key:"_loadCached",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n){var r,a,s,o,l,u,d,c=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._enableFromGPUCache(t,fe.FE.Leaf)){e.next=2;break}return e.abrupt("return",!0);case 2:if(r=this.layerView,!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData){e.next=5;break}return e.abrupt("return",!1);case 5:return a=function(e,n){return c._nodeLoader.loadTextures(t,e,n)},s=function(e,n){return c._clientNodeLoader.loadTextures(t,e,n)},o=t.index>=0?a:s,e.next=10,this.schedule((function(){return r.loadCachedNodeData(t,n,o)}),n);case 10:if(null!=(l=e.sent)){e.next=13;break}return e.abrupt("return",!1);case 13:return u=this._requiredAttributes,e.next=16,this.reschedule((function(){return c._loadAttributes(t,u,n)}),n);case 16:return d=e.sent,e.next=19,this.reschedule((function(){return r.addCachedNodeData(t,l,{loadedAttributes:u,attributeData:d},n)}),n);case 19:return this._nodeAdded(),e.abrupt("return",!0);case 21:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadUncached",value:function(e,t){var n=this;return this._downloadingCount++,this._loadNodeData(e,t).catch((function(e){throw n._downloadingCount--,e})).then((function(i){return n._downloadingCount--,n.schedule((function(){return n.layerView.addNode(e,i,t)}),t)})).then((function(){n._nodeAdded(),e.cacheState=fe.Hw.Cached})).catch((function(t){if(!(0,p.D_)(t))throw f.Z.getLogger(n).error("#loadNodeData()",n.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,null!=n._index&&n._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&null!=this._index&&this._index.resetFailedNodes())}},{key:"test",get:function(){}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),null!=this._index&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;null!=t&&t.layerFilterChanged(e),this._setCameraDirty()}}]),n}((0,g.v)(h.default));(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"isMeshPyramid",null),(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"isGraphics3D",null),(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"useMaximumNumberOfFeatures",null),(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"indexStreamController",null),(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"dataStreamController",null),(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"crsVertex",null),(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"crsIndex",null),(0,c._)([(0,y.Cb)()],Ot.prototype,"screenSizeFactor",void 0),(0,c._)([(0,y.Cb)()],Ot.prototype,"featureTarget",void 0),(0,c._)([(0,y.Cb)()],Ot.prototype,"fixedFeatureTarget",void 0),(0,c._)([(0,y.Cb)()],Ot.prototype,"layerView",void 0),(0,c._)([(0,y.Cb)()],Ot.prototype,"layer",null),(0,c._)([(0,y.Cb)()],Ot.prototype,"updating",void 0),(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"running",null),(0,c._)([(0,y.Cb)()],Ot.prototype,"updatingProgress",void 0),(0,c._)([(0,y.Cb)({readOnly:!0})],Ot.prototype,"leavesReached",void 0),(0,c._)([(0,y.Cb)({constructOnly:!0})],Ot.prototype,"worker",void 0),(0,c._)([(0,y.Cb)({readOnly:!0,dependsOn:[]})],Ot.prototype,"rootNodeVisible",null),Ot=(0,c._)([(0,b.j)("esri.layers.graphics.controllers.I3SOnDemandController")],Ot);var Lt,At=new _.Z({deallocator:null});function Et(e,t){return null!=e&&e.length===t.length&&e.every((function(e){return Zt(t,e.name)>=0}))}function Zt(e,t){for(var n=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===n)return i;return-1}var Tt,Vt,jt={factorIM:.2,factor3dObject:.05,distancePenalty:10},Ut=(0,C.Ue)();(Vt=Tt||(Tt={}))[Vt.pop=0]="pop",Vt[Vt.fadeout=1]="fadeout";var Gt=Ot},18277:function(e,t,n){n.d(t,{$6:function(){return p},$z:function(){return s},F7:function(){return a},Ow:function(){return u},S0:function(){return l},d1:function(){return d},dm:function(){return c},ir:function(){return o}});var i=n(93433),r=[["binary","application/octet-stream","bin",""]];function a(e,t){var n;return null!=v(t.name,null!==(n=null===e||void 0===e?void 0:e.supportedFormats)&&void 0!==n?n:[])}function s(e,t){var n;if(!e)return!1;var i=c(t,null!==(n=e.supportedFormats)&&void 0!==n?n:[]);return null!=i&&e.editFormats.includes(i)}function o(e){var t;return h(null!==(t=null===e||void 0===e?void 0:e.supportedFormats)&&void 0!==t?t:[]).flatMap(g).map((function(e){return".".concat(e)}))}function l(e,t){return f(function(e,t){var n=e.toLowerCase();return h(t).find((function(e){return _(e)===n}))}(e,t))}function u(e,t){return f(v(e,t))}function d(e,t){return _(function(e,t){return h(t).find((function(t){return f(t)===e}))}(e,t))}function c(e,t){var n;return null!==(n=u(e.name,t))&&void 0!==n?n:l(e.type,t)}function h(e){return[].concat(r,(0,i.Z)(e))}function v(e,t){var n=e.toLowerCase();return h(t).find((function(e){return g(e).some((function(e){return n.endsWith(e)}))}))}function f(e){return null===e||void 0===e?void 0:e[0]}function _(e){return null===e||void 0===e?void 0:e[1].toLowerCase()}function g(e){var t;return null!==(t=null===e||void 0===e?void 0:e[2].split(",").map((function(e){return e.toLowerCase()})))&&void 0!==t?t:[]}function p(e){var t;return null===(t=e.tables)||void 0===t?void 0:t.find((function(e){return"assetMaps"===e.role}))}},75367:function(e,t,n){n.r(t),n.d(t,{assetMapFromAssetMapsJSON:function(){return y},extractMesh:function(){return m},meshFeatureSetFromJSON:function(){return p}});var i,r,a=n(37762),s=n(52639),o=n(32718),l=n(77427),u=n(53866),d=n(63899),c=n(848),h=n(78952),v=n(76046),f=n(17493),_=n(18277),g=n(49818);function p(e,t,n){var i,r=n.features;n.features=[],delete n.geometryType;var o=g.Z.fromJSON(n);if(o.geometryType="mesh",!n.assetMaps)return o;var l,u,d=y(t,n.assetMaps),c=null!==(i=e.sourceSpatialReference)&&void 0!==i?i:h.Z.WGS84,v=n.globalIdFieldName,f=e.outFields,_=null!=f&&f.length>0?(l=f.includes("*")?null:new Set(f),function(e){var t=e.attributes;if(!t)return{};if(!l)return t;for(var n in t)l.has(n)||delete t[n];return t}):function(){return{}},p=(0,a.Z)(r);try{for(p.s();!(u=p.n()).done;){var b=u.value,x=m(b,v,c,t,d);o.features.push(new s.Z({geometry:x,attributes:_(b)}))}}catch(C){p.e(C)}finally{p.f()}return o}function m(e,t,n,r,s){var o=e.attributes[t],l=s.get(o);if(null==l||!e.geometry)return null;var h=function(e,t,n){var i=e.attributes,r=n.transformFieldRoles,a=i[r.originX],s=i[r.originY],o=i[r.originZ];return new c.Z({x:a,y:s,z:o,spatialReference:t})}(e,n,r),_=u.Z.fromJSON(e.geometry);_.spatialReference=n;var g=function(e,t){var n=t.transformFieldRoles;return new v.Z({translation:[e[n.translationX],-e[n.translationZ],e[n.translationY]],rotationAxis:[e[n.rotationX],-e[n.rotationZ],e[n.rotationY]],rotationAngle:e[n.rotationDeg],scale:[e[n.scaleX],e[n.scaleZ],e[n.scaleY]]})}(e.attributes,r),p=n.isGeographic?"local":"georeferenced",m=function(e){for(var t=Array.from(e.files.values()),n=new Array,r=0,s=t;r<s.length;r++){var o=s[r];if(o.status!==i.COMPLETED)return null;var l,u=new Array,d=(0,a.Z)(o.parts);try{for(d.s();!(l=d.n()).done;){var c=l.value;if(!c)return null;u.push(new f.LL(c.url,c.hash))}}catch(h){d.e(h)}finally{d.f()}n.push(new f.CP(o.name,o.mimeType,u))}return n}(l);return m?d.Z.createWithExternalSource(h,m,{extent:_,transform:g,vertexSpace:p}):d.Z.createIncomplete(h,{extent:_,transform:g,vertexSpace:p})}function y(e,t){var n,i=new Map,r=(0,a.Z)(t);try{var s=function(){var t=n.value,r=t.parentGlobalId;if(null==r)return"continue";var a=t.assetName,s=t.assetType,u=t.assetHash,d=t.assetURL,c=t.conversionStatus,h=t.seqNo,v=(0,_.d1)(s,e.supportedFormats);if(!v)return o.Z.getLogger("esri.rest.support.meshFeatureSet").error("mesh-feature-set:unknown-format","Service returned an asset of type ".concat(s,", but it does not list it as a supported type")),"continue";var f=(0,l.s1)(i,r,(function(){return{files:new Map}}));(0,l.s1)(f.files,a,(function(){return{name:a,type:s,mimeType:v,status:b(c),parts:[]}})).parts[h]={hash:u,url:d}};for(r.s();!(n=r.n()).done;)s()}catch(u){r.e(u)}finally{r.f()}return i}function b(e){switch(e){case"COMPLETED":case"SUBMITTED":return i.COMPLETED;case"INPROGRESS":return i.PENDING;default:return i.FAILED}}(r=i||(i={}))[r.FAILED=0]="FAILED",r[r.PENDING=1]="PENDING",r[r.COMPLETED=2]="COMPLETED"},41863:function(e,t,n){n.r(t),n.d(t,{default:function(){return m}});var i=n(74165),r=n(15861),a=n(15671),s=n(43144),o=n(60136),l=n(29388),u=n(27366),d=n(10064),c=n(94172),h=n(49861),v=(n(93169),n(32718),n(84936),n(69912)),f=n(79803),_=n(37933),g=n(28554),p=function(e){(0,o.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).type="feature-3d",e.direct3DObjectFeatureLayerDisplayEnabled=(0,g.Vi)(),e}return(0,s.Z)(n,[{key:"initialize",value:function(){var e,t=this,n=this.layer,a=this.view;null!==(e=(0,_.S1)(n))&&void 0!==e&&e.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new d.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:n}))),null!=n.infoFor3D&&(this.direct3DObjectFeatureLayerDisplayEnabled?this.addResolvingPromise((0,r.Z)((0,i.Z)().mark((function e(){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.whenOnce)((function(){return t.graphicsPipeline}));case 2:n=e.sent,t.destroyed||n.destroyed||(n.suspendResumeExtentMode="computed");case 4:case"end":return e.stop()}}),e)})))()):this.addResolvingPromise(Promise.reject(new d.Z("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ".concat(n.geometryType))))),"mesh"!==n.geometryType||(0,f.canProjectWithoutEngine)(n.spatialReference,a.spatialReference)||this.addResolvingPromise(Promise.reject(new d.Z("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}},{key:"featureSpatialReference",get:function(){var e,t;return null===(e=this.view.featureTiles)||void 0===e||null===(t=e.tilingScheme)||void 0===t?void 0:t.spatialReference}}]),n}(n(48750).Z);(0,u._)([(0,h.Cb)({constructOnly:!0})],p.prototype,"direct3DObjectFeatureLayerDisplayEnabled",void 0),(0,u._)([(0,h.Cb)()],p.prototype,"layer",void 0);var m=p=(0,u._)([(0,v.j)("esri.views.3d.layers.FeatureLayerView3D")],p)},4046:function(e,t,n){n.d(t,{K0:function(){return w},Pg:function(){return y},R0:function(){return _},RE:function(){return N},cU:function(){return x},dY:function(){return b},nn:function(){return I}});var i,r=n(4942),a=n(93169),s=n(16889),o=n(99048),l=n(89261),u=n(26461),d=n(86097),c=n(68401),h=n(1487),v=n(45856),f=n(8548);function _(e,t,n){var i,r,s=new Map,l=function(e,t){if(null==e)return-1;var n=s.get(e.id);if(n)return n.usage|=t,n.id;var i=s.size;return s.set(e.id,{id:i,usage:t}),i},u=t.pbrMetallicRoughness,d=null===u||void 0===u?void 0:u.baseColorFactor,h=t.emissiveFactor,f=(0,a.Z)("disable-feature:diffuse-rendering-i3s")||n?(0,v.Ix)({normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,emissiveFactor:t.emissiveFactor,occlusionTexture:t.occlusionTexture,metallicRoughnessTexture:null===u||void 0===u?void 0:u.metallicRoughnessTexture,metallicFactor:null===u||void 0===u?void 0:u.metallicFactor,roughnessFactor:null===u||void 0===u?void 0:u.roughnessFactor}):(0,v.Ih)({normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,emissiveFactor:t.emissiveFactor,occlusionTexture:t.occlusionTexture,metallicRoughnessTexture:null===u||void 0===u?void 0:u.metallicRoughnessTexture,metallicFactor:null===u||void 0===u?void 0:u.metallicFactor,roughnessFactor:null===u||void 0===u?void 0:u.roughnessFactor}),_=f?v.yI[0]:null!==(i=null===u||void 0===u?void 0:u.metallicFactor)&&void 0!==i?i:v.ml[0],m=f?v.yI[1]:null!==(r=null===u||void 0===u?void 0:u.roughnessFactor)&&void 0!==r?r:v.ml[1],y="mask"===t.alphaMode?o.v.Color|o.v.AlphaMask:o.v.Color,b={baseColorFactor:d?[d[0],d[1],d[2],d[3]]:[1,1,1,1],baseColorTextureId:l(null===u||void 0===u?void 0:u.baseColorTexture,y),metallicRoughnessTextureId:l(null===u||void 0===u?void 0:u.metallicRoughnessTexture,o.v.MetallicRoughness),metallicFactor:_,roughnessFactor:m},x={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?c.Vr.None:"back"===t.cullFace?c.Vr.Back:"front"===t.cullFace?c.Vr.Front:c.Vr.None,normalTextureId:l(t.normalTexture,o.v.Normal),emissiveTextureId:l(t.emissiveTexture,o.v.Emissive),occlusionTextureId:l(t.occlusionTexture,o.v.Occlusion),emissiveFactor:h?[h[0],h[1],h[2]]:[0,0,0],metallicRoughness:b,wrapTextures:!1,hasParametersFromSource:f},C=[];return s.forEach((function(t,n){var i=t.usage,r=null!=e&&e[n]&&e[n].formats,a=r?g(r.map((function(e){var t=e.name,n=e.format;return{name:t,encoding:p[n]}}))):[];C.push({id:n,usage:i,encodings:a})})),{material:x,textures:C}}function g(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var p={ktx2:o.j.KTX2,basis:o.j.Basis,dds:o.j.DDS_S3TC,png:o.j.PNG,jpg:o.j.JPG,"ktx-etc2":o.j.KTX_ETC2},m=(i={},(0,r.Z)(i,c.Ti.KTX2_ENCODING,o.j.Basis),(0,r.Z)(i,c.Ti.BASIS_ENCODING,o.j.Basis),(0,r.Z)(i,c.Ti.DDS_ENCODING,o.j.DDS_S3TC),(0,r.Z)(i,"image/png",o.j.PNG),(0,r.Z)(i,"image/jpg",o.j.JPG),(0,r.Z)(i,"image/jpeg",o.j.JPG),(0,r.Z)(i,"image/ktx",o.j.KTX_ETC2),i);function y(e){var t,n,i=null!==e&&void 0!==e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,r=null!==e&&void 0!==e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,a=i?null===(t=e.materialDefinitions)||void 0===t?void 0:t[i]:null,l=r?null===(n=e.textureDefinitions)||void 0===n?void 0:n[r]:null,u=b();if(null!=a){var d=a.params;d.diffuse&&(u.metallicRoughness.baseColorFactor=[d.diffuse[0],d.diffuse[1],d.diffuse[2],1]),null!=d.doubleSided&&(u.doubleSided=d.doubleSided,u.cullFace=d.doubleSided?c.Vr.None:c.Vr.Back),"none"!==d.cullFace&&"front"!==d.cullFace&&"back"!==d.cullFace||(u.cullFace="none"===d.cullFace?c.Vr.None:"back"===d.cullFace?c.Vr.Back:c.Vr.Front),d.transparency&&(u.metallicRoughness.baseColorFactor[3]=(0,s.uZ)(1-d.transparency,0,1)),(d.useVertexColorAlpha||u.metallicRoughness.baseColorFactor[3]<1)&&(u.alphaMode="blend")}var h=[];if(null!=l){!l.wrap||"repeat"!==l.wrap[0]&&"repeat"!==l.wrap[1]||(u.wrapTextures=!0);var v=o.v.Color;"rgba"===l.channels&&(u.alphaMode="blend",v|=o.v.AlphaMask);var f=l.images.length-1,_=l.images[f],p=function(e){return null===e||void 0===e?void 0:e.split("/").pop()},y=Array.isArray(l.encoding)?g(l.encoding.map((function(e,t){return{name:p(_.href[t]),encoding:m[e]||0}}))):[{name:p(_.href),encoding:m[l.encoding]||0}];h.push({id:0,usage:v,encodings:y}),u.metallicRoughness.baseColorTextureId=0}return{material:u,textures:h}}var b=function(){return{alphaMode:"opaque",alphaCutoff:u.F,doubleSided:!0,cullFace:c.Vr.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function x(e,t,n,i){if(null==(null===e||void 0===e?void 0:e.data))return null;var r=e.data,a=i.renderingContext.parameters.maxMaxAnisotropy,s=a>1,l=n||!t.wrapTextures?C:k,u=function(e){switch(e){case o.j.KTX2:return c.Ti.KTX2_ENCODING;case o.j.Basis:return c.Ti.BASIS_ENCODING;case o.j.DDS_S3TC:return c.Ti.DDS_ENCODING;case o.j.PNG:return"image/png";case o.j.JPG:return"image/jpeg";case o.j.KTX_ETC2:return"image/ktx";default:return""}}(e.encoding),d=e.usage&o.v.Color?"opaque"===t.alphaMode?3:4:3;return new h.x(r,{mipmap:s,maxAnisotropy:a,encoding:u,wrap:l,components:d,noUnpackFlip:!0})}var C={s:f.e8.CLAMP_TO_EDGE,t:f.e8.CLAMP_TO_EDGE},k={s:f.e8.REPEAT,t:f.e8.REPEAT};function N(e,t,n,i,r,a){var h=a.rendererTextureUsage,f=function(e){return function(e,t,n){if(null==e||n===o.v.None)return null;for(var i=0;i<e.length;i++){var r=e[i];if(null!=r&&r.usage&n){var a=t[i];return null!=a?a.id:null}}return null}(i,n,e&h)},_=t.metallicRoughness.baseColorFactor,g=(0,s.uZ)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[_[0],_[1],_[2],g],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=a.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?v.yI[2]:v.ml[2]],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=a.isIntegratedMesh,e.textureAlphaCutoff="mask"===t.alphaMode?t.alphaCutoff:u.F,e.alphaDiscardMode="opaque"===t.alphaMode?c.JJ.Opaque:"mask"===t.alphaMode?c.JJ.Mask:c.JJ.MaskBlend;var p=[],m=f(o.v.Color|o.v.AlphaMask);null!=m&&(e.baseColorTexture=new l.T(r,m),p.push(e.baseColorTexture.loadPromise));var y=f(o.v.MetallicRoughness);null!=y&&(e.metallicRoughnessTexture=new l.T(r,y),p.push(e.metallicRoughnessTexture.loadPromise));var b=f(o.v.Emissive);null!=b&&(e.emissionTexture=new l.T(r,b),p.push(e.emissionTexture.loadPromise));var x=f(o.v.Occlusion);null!=x&&(e.occlusionTexture=new l.T(r,x),p.push(e.occlusionTexture.loadPromise));var C=f(o.v.Normal);return null!=C&&(e.normalTexture=new l.T(r,C),p.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=a.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=(0,d.j)(a.viewSpatialReference),Promise.all(p)}function w(e){var t=!!e.compressedTextureS3TC,n=!!e.compressedTextureETC,i=(0,a.Z)("disable-feature:i3s-basis")?0:o.j.Basis|o.j.KTX2,r=o.j.JPG|o.j.PNG,s=i|o.j.DDS_S3TC;return r|(t?s:0)|(n?i:0)}function I(e,t){if(null!=t)return e.find((function(e){return!!(e.encoding&t)}))}},95964:function(e,t,n){n.d(t,{$i:function(){return m},FE:function(){return o},Hw:function(){return a},NB:function(){return y},O4:function(){return r},U_:function(){return i},oQ:function(){return b},w5:function(){return s}});var i,r,a,s,o,l,u=n(88301),d=n(61120),c=n(15671),h=n(43144),v=n(60136),f=n(29388),_=n(86361),g=n(23470),p=n(44011),m=function(e){(0,v.Z)(n,e);var t=(0,f.Z)(n);function n(e,i){var r;return(0,c.Z)(this,n),(r=t.call(this,NaN,NaN)).id=e,r.serviceMbsInIndexSR=i,r.serviceMbsInRenderSR=(0,g.f)(0,0,0,-1),r}return(0,h.Z)(n,[{key:"invalidateServiceBVsInRenderSR",value:function(){var e;(0,p.WD)(this.serviceMbsInRenderSR),null===(e=this.serviceObbInRenderSR)||void 0===e||e.invalidate()}},{key:"shareServiceBVsInRenderSRWith",value:function(e){this.serviceObbInRenderSR=e.serviceObbInRenderSR,this.serviceMbsInRenderSR=e.serviceMbsInRenderSR}}]),n}(n(2985).r);(l=i||(i={}))[l.Unmodified=0]="Unmodified",l[l.Culled=1]="Culled",l[l.NotChecked=2]="NotChecked",function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(r||(r={}));var y=function(e){(0,v.Z)(n,e);var t=(0,f.Z)(n);function n(e,i,s,o,l,u,d,h,v,f){var g;return(0,c.Z)(this,n),(g=t.call(this,e,s)).index=i,g.childCount=o,g.level=l,g.resources=u,g.version=d,g.lodMetric=h,g.maxError=v,g.numFeatures=f,g.failed=!1,g.cacheState=a.Unknown,g.vertexCount=0,g.memory=0,g.childrenLoaded=0,g.hasModifications=!1,g.imModificationImpact=r.NotChecked,g.elevationAgnosticBoundingVolume=(0,_.al)(0,0,0,-1),g}return(0,h.Z)(n,[{key:"invalidateServiceBVsInRenderSR",value:function(){(0,u.Z)((0,d.Z)(n.prototype),"invalidateServiceBVsInRenderSR",this).call(this),this.elevationAgnosticBoundingVolume[3]=-1}}]),n}(m);!function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"}(a||(a={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(s||(s={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(o||(o={}));var b=(0,h.Z)((function e(t,n,i,r){(0,c.Z)(this,e),this.nodeHasLOD=t,this.isChosen=n,this.lodLevel=i,this.version=r}))},75162:function(e,t,n){n.d(t,{v:function(){return L}});var i=n(74165),r=n(37762),a=n(15861),s=n(93433),o=n(15671),l=n(43144),u=n(60136),d=n(29388),c=n(27366),h=n(76200),v=n(7138),f=n(63780),_=n(14921),g=n(59896),p=n(80987),m=n(42537),y=(n(93169),n(32718)),b=n(92026),x=n(66978),C=n(2622),k=n(94172),N=n(49861),w=n(69912),I=n(92975),S=n(6291),R=n(12322),M=n(75367),D=n(28554),P=n(5640),F=n(50951),O=n(41863),L=function(e){(0,u.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._warnMaximumChangedObjectsExceeded=!1,i._maximumNumberOfEditOVerrides=V,i._original3DOFLDefinitionExpression=null,i._interactiveEditingSessions=new p.Z,i.geometryOverrides=new p.Z,i._clientGeometryCache=new Map,i._associatedLayerView=null,i._attributeChangedObjectIds=new C.Z,i._geometryChangedObjectIds=new C.Z,i._pendingFetchChangedObjectIds=null,i._pendingFetchAbortController=new AbortController,i._featureIdLocks=new Map,i}return(0,l.Z)(n,[{key:"initialize",value:function(){var e,t=this;this._memCache=this.memoryController.newCache("i3s-attribute-overrides-".concat(this.layer.uid)),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(null===(e=this._pendingFetchAbortController)||void 0===e?void 0:e.signal),this._pendingFetchChangedObjectIds.finally((function(){t._pendingFetchAbortController=null,t._pendingFetchChangedObjectIds=null})),this.is3DOFL&&null!=this._associatedLayer&&((0,D.Vi)()?this._associatedLayer.load().then((function(e){t.destroyed||(t._original3DOFLDefinitionExpression=e.definitionExpression,t.addHandles((0,k.watch)((function(){return t._definitionExpression}),(function(t){return e.definitionExpression=t}),k.initial)),t._associatedLayerView=new O.default({layer:t._associatedLayer,view:t.view}))})):(0,D.yA)())}},{key:"destroy",value:function(){this.is3DOFL&&null!=this._associatedLayer&&((0,D.Vi)()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=this._original3DOFLDefinitionExpression):(0,D.yA)()),this._set("layer",null),this._memCache=(0,b.SC)(this._memCache),this._pendingFetchAbortController=(0,b.IM)(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null,this._featureIdLocks.clear()}},{key:"is3DOFL",get:function(){var e;return(0,D.Rx)()&&null!=(null===(e=this._associatedLayer)||void 0===e?void 0:e.infoFor3D)}},{key:"sortedGeometryChangedObjectIds",get:function(){return this.is3DOFL?(0,s.Z)(this._geometryChangedObjectIds).sort((function(e,t){return e-t})):[]}},{key:"_associatedLayer",get:function(){return null==this.layer?null:this.layer.associatedLayer}},{key:"hasGeometryChanges",get:function(){return this._geometryChangedObjectIds.size>0}},{key:"_definitionExpression",get:function(){var e=this.sortedGeometryChangedObjectIds;return 0===e.length?"1 = 0":"OBJECTID IN (".concat(e.join(","),")")}},{key:"updating",get:function(){return!!this.is3DOFL&&(!!this._pendingFetchChangedObjectIds||!!(0,D.Vi)()&&(!(null!=this._associatedLayerView)||null!=this._associatedLayerView&&this._associatedLayerView.updating))}},{key:"isEmpty",get:function(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}},{key:"featureHasGeometryChanges",value:function(e){return this._geometryChangedObjectIds.has(e)}},{key:"featureHasAttributeChanges",value:function(e){return this._attributeChangedObjectIds.has(e)}},{key:"createInteractiveEditSession",value:function(e){this._attributeChangedObjectIds.add(e);var t=this._interactiveEditingSessions,n=new Z(e,(function(){t.remove(n)}));return t.unshift(n),n}},{key:"applyAttributeOverrides",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t,n,a){var s,o,l,u,d,c,h,v,f,_,g,p,m,y,b,C,k=arguments;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=k.length>3&&void 0!==k[3]?k[3]:[],e.t0=this._pendingFetchChangedObjectIds,!e.t0){e.next=5;break}return e.next=5,(0,x.Hl)(this._pendingFetchChangedObjectIds,a);case 5:if(null!=n){e.next=7;break}return e.abrupt("return");case 7:if(o=n.attributeData,null!=(l=n.loadedAttributes)&&null!=o&&0!==this._attributeChangedObjectIds.size){e.next=10;break}return e.abrupt("return");case 10:u=new Set,d=(0,r.Z)(l);try{for(d.s();!(c=d.n()).done;)h=c.value,u.add(h.index)}catch(i){d.e(i)}finally{d.f()}v=(0,r.Z)(s);try{for(v.s();!(f=v.n()).done;)_=f.value,u.has(_.index)||(l.push(_),o[_.name]=new Array(t.length))}catch(i){v.e(i)}finally{v.f()}return e.next=17,this._lockFeatureIds(t);case 17:if(g=e.sent,e.prev=18,p={attributeData:o,loadedAttributes:l},m=this._getOverridesFromCache(t,p,this._attributeChangedObjectIds),y=m.objectIds,b=m.fieldNames,0!==y.length&&0!==b.length){e.next=22;break}return e.abrupt("return");case 22:return e.next=24,this._queryAttributeOverridesFromAssociatedLayer(y,b,a);case 24:if(null!=(C=e.sent)){e.next=27;break}return e.abrupt("return");case 27:this._processOverridesFromAssociatedLayer(t,C,b,p);case 28:return e.prev=28,g.remove(),e.finish(28);case 31:case"end":return e.stop()}}),e,this,[[18,,28,31]])})));return function(t,n,i){return e.apply(this,arguments)}}()},{key:"updateGeometry",value:function(e,t){this._geometryChangedObjectIds.add(e);var n=this._clientGeometryCache.get(e);if(null!=n&&(this.geometryOverrides.remove(n),this._clientGeometryCache.delete(e)),null!=t){var i={oid:e,mesh:t};this.geometryOverrides.add(i),this._clientGeometryCache.set(e,i)}}},{key:"updateAttributeValue",value:function(e,t,n){this._attributeChangedObjectIds.add(e),this._cacheAttributeValue(e,t,n)}},{key:"featureAdded",value:function(e){this.is3DOFL&&(0,D.yA)()&&this._geometryChangedObjectIds.add(e),this._attributeChangedObjectIds.add(e)}},{key:"_cacheAttributeValue",value:function(e,t,n){this._memCache.put(this._getAttributeCacheKey(e,t),n,this._memCacheAttributeValueSize(n))}},{key:"_getOverridesFromCache",value:function(e,t,n){var i,a=t.loadedAttributes,s=t.attributeData,o=new Set,l=new Array,u=(0,r.Z)(a);try{for(u.s();!(i=u.n()).done;){var d=i.value;l[d.index]=s[d.name]}}catch(m){u.e(m)}finally{u.f()}for(var c=new Set,h=0;h<e.length;h++){var v=e[h];if(n.has(v)){var f,_=(0,r.Z)(a);try{for(_.s();!(f=_.n()).done;){var g=f.value,p=this._attributeFromCache(v,g.index);void 0===p?(o.add(v),c.add(g.name)):l[g.index][h]=p}}catch(m){_.e(m)}finally{_.f()}}}return{objectIds:Array.from(o),fieldNames:Array.from(c)}}},{key:"_attributeFromCache",value:function(e,t){var n=this._fromInteractiveEditingSession(e,t);if(void 0!==n)return n;var i=this._getAttributeCacheKey(e,t);return this._memCache.get(i)}},{key:"_fromInteractiveEditingSession",value:function(e,t){if(null!=this._interactiveEditingSessions){var n,i=(0,r.Z)(this._interactiveEditingSessions);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(a.objectId===e){var s=a.getAttribute(t);if(void 0!==s)return s}}}catch(o){i.e(o)}finally{i.f()}}}},{key:"_getAttributeCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"_queryAttributeOverridesFromAssociatedLayer",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t,n,a){var o,l,u,d,c,h,v,f,_,g,p,m;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return",null);case 2:if(this._logWarningIfMaximumObjectsExceeded(),null!=(o=this.layer.associatedLayer)){e.next=6;break}return e.abrupt("return",null);case 6:return l=o.createQuery(),u=o.objectIdField,d=[u].concat((0,s.Z)(n)),l.where="1=1",l.returnGeometry=!1,l.outFields=d,l.cacheHint=!0,e.next=10,this._executeBatchQuery(o,t,l,a);case 10:c=e.sent,h=[],v=(0,r.Z)(c);try{for(v.s();!(f=v.n()).done;)if((_=f.value).ok){g=(0,r.Z)(_.value.features);try{for(g.s();!(p=g.n()).done;)m=p.value,h.push(m)}catch(i){g.e(i)}finally{g.f()}}}catch(i){v.e(i)}finally{v.f()}return e.abrupt("return",h);case 15:case"end":return e.stop()}}),e,this)})));return function(t,n,i){return e.apply(this,arguments)}}()},{key:"_queryGeometryOverridesFromAssociatedLayer",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t,n){var a,o,l,u,d,c,h,v,f,_,g,p,m,b,x,C,k,N,w,S,R,P,O,L,E,Z,T;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&this.is3DOFL&&(0,D.yA)()){e.next=2;break}return e.abrupt("return",null);case 2:if(a=this.layer.associatedLayer,o=a.infoFor3D,l=a.spatialReference,u=this.view,d=u.state.viewingMode,c=u.spatialReference,h=d===F.JY.Global,v=l.isGeographic,!h||v){e.next=5;break}return e.abrupt("return",(y.Z.getLogger(this).warn("unsupported-pcs-edits-in-global-view",this.layer.title,j(l,c,this.view.viewingMode,A.Mode)),null));case 5:if(h||!v){e.next=7;break}return e.abrupt("return",(y.Z.getLogger(this).warn("unsupported-gcs-edits-in-local-view",this.layer.title,j(l,c,this.view.viewingMode,A.Mode)),null));case 7:if((0,I.fS)(l,c)||h&&c.isWebMercator&&l.isWGS84){e.next=9;break}return e.abrupt("return",(y.Z.getLogger(this).warn("unsupported-mismatched-spatial-reference-edits",this.layer.title,j(l,c,this.view.viewingMode,A.SpatialReference)),null));case 9:return this._logWarningIfMaximumObjectsExceeded(),f=a.objectIdField,_=a.globalIdField,g=[f].concat((0,s.Z)(null!=_?[_]:[])),(p=a.createQuery()).where="1=1",p.returnGeometry=!0,p.outFields=g,p.cacheHint=!0,p.returnZ=a.hasZ,p.returnM=a.hasM,e.next=14,this._executeBatchQuery(a,t,p,n);case 14:m=e.sent,b=[],x=(0,r.Z)(m),e.prev=17,x.s();case 19:if((C=x.n()).done){e.next=31;break}if((k=C.value).ok){e.next=23;break}return e.abrupt("continue",29);case 23:if(N=k.value,w=N.assetMaps,S=N.features,R=N.globalIdFieldName,null!=w){e.next=26;break}return e.abrupt("continue",29);case 26:P=(0,M.assetMapFromAssetMapsJSON)(o,w),O=(0,r.Z)(S);try{for(O.s();!(L=O.n()).done;)E=L.value,Z=(0,M.extractMesh)(E,R,l,o,P),T=E,null!=Z?(T.geometry=Z,b.push(T)):T.geometry=null}catch(i){O.e(i)}finally{O.f()}case 29:e.next=19;break;case 31:e.next=36;break;case 33:e.prev=33,e.t0=e.catch(17),x.e(e.t0);case 36:return e.prev=36,x.f(),e.finish(36);case 39:return e.abrupt("return",b);case 40:case"end":return e.stop()}}),e,this,[[17,33,36,39]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_logWarningIfMaximumObjectsExceeded",value:function(){if(this._warnMaximumChangedObjectsExceeded){this._warnMaximumChangedObjectsExceeded=!1;var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat((0,S.uf)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;e+=null!==t&&void 0!==t&&t.loaded?" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):" (".concat(this.layer.parsedUrl.path,")"),y.Z.getLogger(this).warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}}},{key:"_executeBatchQuery",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t,n,r,a){var o,l;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}return e.abrupt("return",[]);case 2:return o=(0,R.qo)(t),n=(0,s.Z)(n).sort((function(e,t){return e-t})),l=(0,f.vr)(n,o).map((function(e){var n=r.clone();return n.objectIds=e,(0,_.mt)((0,R.UK)(t,n,{signal:a}))})),e.abrupt("return",Promise.all(l));case 6:case"end":return e.stop()}}),e)})));return function(t,n,i,r){return e.apply(this,arguments)}}()},{key:"_processOverridesFromAssociatedLayer",value:function(e,t,n,i){var a=i.loadedAttributes,s=i.attributeData,o=this._associatedLayer;if(null!=o){var l,u=o.objectIdField,d=n.map((function(t){return t in s||(s[t]=new Array(e.length)),s[t]})),c=new Map(a.map((function(e){return[e.name,e.index]}))),h=n.map((function(e){return c.get(e)})),v=new Map(Array.from(e,(function(e,t){return[e,t]}))),f=(0,r.Z)(t);try{for(f.s();!(l=f.n()).done;)for(var _=l.value,g=_.attributes[u],p=0;p<n.length;p++){var m=h[p],y=v.get(g),b=_.attributes[n[p]];d[p][y]=b,this._cacheAttributeValue(g,m,b)}}catch(x){f.e(x)}finally{f.f()}}}},{key:"_memCacheAttributeValueSize",value:function(e){return"string"==typeof e?(0,g.hH)(e):(0,g.G3)()}},{key:"_fetchChangedObjectIds",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t){var n,a,o,l,u,d,c,v,f,g,p,m,b,x,C,k,N,w,I,S,R,M,F,O,L,A,E,Z,V,j,U,G,B,q,H;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=this.layer,e.next=3,u.load({signal:t});case 3:if(this._geometryChangedObjectIds.clear(),this._attributeChangedObjectIds.clear(),null!=(d=u.associatedLayer)&&null!==(n=d.capabilities)&&void 0!==n&&null!==(a=n.operations)&&void 0!==a&&a.supportsChangeTracking){e.next=8;break}return e.abrupt("return");case 8:if(null!=(c=this._getFetchChangedObjectIdsServerGen())){e.next=11;break}return e.abrupt("return");case 11:return v=d.layerId,f=this.is3DOFL,g={f:"json",returnIdsOnly:!0,layers:"[".concat(v,"]"),returnUpdates:!0,returnDeletes:f,returnInserts:f,layerServerGens:JSON.stringify([{id:v,serverGen:c}])},f&&(p=d.infoFor3D,g.fieldsToCompare=JSON.stringify({fields:[].concat((0,s.Z)(Object.values(p.transformFieldRoles)),[p.sourceHashField])})),e.next=15,(0,_.q6)((0,h.Z)("".concat(d.url,"/extractChanges"),{method:"post",query:g,timeout:T,signal:t}));case 15:if(!(m=e.sent).ok&&(0,P.q4)(m.error)&&(b=this.layer.title,y.Z.getLogger(this).warn("extractChanges:timeout",b,"".concat(b," could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service."))),!m.ok||1!==(null===(o=m.value.data)||void 0===o||null===(l=o.edits)||void 0===l?void 0:l.length)){e.next=29;break}for(N=m.value.data.edits[0],w=null===N||void 0===N?void 0:N.objectIds,I=null===N||void 0===N?void 0:N.fieldUpdates,S=null!==(x=null===w||void 0===w?void 0:w.adds)&&void 0!==x?x:[],R=null!==(C=null===w||void 0===w?void 0:w.updates)&&void 0!==C?C:[],M=null!==(k=null===w||void 0===w?void 0:w.deletes)&&void 0!==k?k:[],F=[].concat((0,s.Z)(S),(0,s.Z)(R),(0,s.Z)(M)),O=f?[].concat((0,s.Z)(S),(0,s.Z)(null!==I&&void 0!==I?I:R),(0,s.Z)(M)):[],(L=Math.min(this._maximumNumberOfEditOVerrides,F.length))<F.length&&(this._warnMaximumChangedObjectsExceeded=!0),A=F.sort((function(e,t){return e-t})),E=0;E<L;++E)Z=A[E],this._attributeChangedObjectIds.add(Z);V=(0,r.Z)(O);try{for(V.s();!(j=V.n()).done;)U=j.value,this._geometryChangedObjectIds.add(U)}catch(i){V.e(i)}finally{V.f()}if(!(this.is3DOFL&&(0,D.yA)()&&this._geometryChangedObjectIds.size>0)){e.next=29;break}return e.next=27,this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),t);case 27:if(null!=(G=e.sent)){B=(0,r.Z)(G);try{for(B.s();!(q=B.n()).done;)null!=(H=q.value).geometry&&this.updateGeometry(H.attributes[d.objectIdField],H.geometry)}catch(i){B.e(i)}finally{B.f()}}case 29:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getFetchChangedObjectIdsServerGen",value:function(){var e,t,n=this.layer;if(null!=(null===(e=n.serviceUpdateTimeStamp)||void 0===e?void 0:e.lastUpdate))return n.serviceUpdateTimeStamp.lastUpdate;var i=n.associatedLayer;return null!=(null===i||void 0===i||null===(t=i.serverGens)||void 0===t?void 0:t.minServerGen)?i.serverGens.minServerGen:null}},{key:"_lockFeatureIds",value:function(){var e=(0,a.Z)((0,i.Z)().mark((function e(t){var n,a,s,o,l,u,d,c,h,v,f,_;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=this._featureIdLocks,a=!0;case 2:if(!a){e.next=14;break}s=new Array,o=(0,r.Z)(t);try{for(o.s();!(l=o.n()).done;)u=l.value,(d=n.get(u))&&s.push(d)}catch(i){o.e(i)}finally{o.f()}if(0!==s.length){e.next=10;break}a=!1,e.next=12;break;case 10:return e.next=12,Promise.all(s);case 12:e.next=2;break;case 14:c=(0,x.hh)(),h=c.promise,v=(0,r.Z)(t);try{for(v.s();!(f=v.n()).done;)_=f.value,n.set(_,h)}catch(i){v.e(i)}finally{v.f()}return e.abrupt("return",(0,m.kB)((function(){var e,a=(0,r.Z)(t);try{for(a.s();!(e=a.n()).done;){var s=e.value;n.delete(s)}}catch(i){a.e(i)}finally{a.f()}c.resolve()})));case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"test",get:function(){}}]),n}(v.default);(0,c._)([(0,N.Cb)({constructOnly:!0})],L.prototype,"view",void 0),(0,c._)([(0,N.Cb)({constructOnly:!0})],L.prototype,"layer",void 0),(0,c._)([(0,N.Cb)({readOnly:!0})],L.prototype,"is3DOFL",null),(0,c._)([(0,N.Cb)()],L.prototype,"_interactiveEditingSessions",void 0),(0,c._)([(0,N.Cb)({readOnly:!0})],L.prototype,"sortedGeometryChangedObjectIds",null),(0,c._)([(0,N.Cb)({readOnly:!0})],L.prototype,"geometryOverrides",void 0),(0,c._)([(0,N.Cb)()],L.prototype,"_clientGeometryCache",void 0),(0,c._)([(0,N.Cb)()],L.prototype,"_associatedLayer",null),(0,c._)([(0,N.Cb)()],L.prototype,"_associatedLayerView",void 0),(0,c._)([(0,N.Cb)({constructOnly:!0})],L.prototype,"memoryController",void 0),(0,c._)([(0,N.Cb)()],L.prototype,"_attributeChangedObjectIds",void 0),(0,c._)([(0,N.Cb)()],L.prototype,"_geometryChangedObjectIds",void 0),(0,c._)([(0,N.Cb)()],L.prototype,"hasGeometryChanges",null),(0,c._)([(0,N.Cb)()],L.prototype,"_pendingFetchChangedObjectIds",void 0),(0,c._)([(0,N.Cb)()],L.prototype,"_pendingFetchAbortController",void 0),(0,c._)([(0,N.Cb)()],L.prototype,"_definitionExpression",null),(0,c._)([(0,N.Cb)()],L.prototype,"updating",null),(0,c._)([(0,N.Cb)()],L.prototype,"isEmpty",null),L=(0,c._)([(0,w.j)("esri.views.3d.layers.i3s.I3SOverrides")],L);var A,E,Z=function(){function e(t,n){(0,o.Z)(this,e),this.objectId=t,this._remove=n,this._updates=new Map,this._isActive=!0}return(0,l.Z)(e,[{key:"getAttribute",value:function(e){return this._updates.get(e)}},{key:"setAttribute",value:function(e,t){this.isActive&&this._updates.set(e,t)}},{key:"remove",value:function(){this.isActive&&(this._isActive=!1,this._remove())}},{key:"isActive",get:function(){return this._isActive}}]),e}(),T=1e4,V=5e4;function j(e,t,n,i){return"Displaying the edits of a SceneLayer with a".concat(i===A.Mode?e.isGeographic?" geographic ":" projected ":" ","spatial reference (wkid:").concat(e.wkid,") in ").concat(n," viewing mode").concat(i===A.SpatialReference?" with spatial reference (wkid:".concat(t.wkid,") "):" ","is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ").concat(i===A.Mode?"viewing mode":"view spatial reference"," to display edits.")}(E=A||(A={}))[E.Mode=0]="Mode",E[E.SpatialReference=1]="SpatialReference"},99048:function(e,t,n){var i,r;n.d(t,{j:function(){return i},v:function(){return r}}),function(e){e[e.KTX2=1]="KTX2",e[e.Basis=2]="Basis",e[e.DDS_S3TC=4]="DDS_S3TC",e[e.PNG=8]="PNG",e[e.JPG=16]="JPG",e[e.KTX_ETC2=32]="KTX_ETC2"}(i||(i={})),function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.MetallicRoughness=2]="MetallicRoughness",e[e.Normal=4]="Normal",e[e.Occlusion=8]="Occlusion",e[e.Emissive=16]="Emissive",e[e.AlphaMask=32]="AlphaMask",e[e.ColorTextures=19]="ColorTextures",e[e.GeometryTextures=36]="GeometryTextures",e[e.GeometryTexturesPBR=44]="GeometryTexturesPBR",e[e.AllTextures=37]="AllTextures",e[e.AllTexturesPBR=63]="AllTexturesPBR"}(r||(r={}))},21765:function(e,t,n){var i;n.d(t,{B:function(){return i}}),function(e){e[e.FadeIn=0]="FadeIn",e[e.FadeOut=1]="FadeOut"}(i||(i={}))},89261:function(e,t,n){n.d(t,{T:function(){return o}});var i=n(15671),r=n(43144),a=n(92026),s=n(66978),o=function(){function e(t,n){var r=this;(0,i.Z)(this,e),this._textures=t,this.loadPromise=null,this._disposed=!1;var o=this._textures.acquire(n);(0,s.y8)(o)?(o.then((function(e){r._disposed?(0,a.RY)(e):r._textureRef=e})),this.loadPromise=o):this._textureRef=o}return(0,r.Z)(e,[{key:"dispose",value:function(){this._textureRef=(0,a.RY)(this._textureRef),this._disposed=!0}},{key:"glTexture",get:function(){return null!=this._textureRef?this._textureRef.glTexture:null}}]),e}()}}]);
//# sourceMappingURL=37829.f23d4a16.chunk.js.map