"use strict";(self.webpackChunkreact_training=self.webpackChunkreact_training||[]).push([[7199],{7199:function(e,t,r){r.r(t),r.d(t,{default:function(){return z}});var i,a,n,s,l,o,u=r(1413),c=r(37762),d=r(15671),_=r(43144),h=r(60136),v=r(29388),f=r(27366),m=r(52639),y=r(76200),g=r(93169),x=r(32718),p=r(66978),b=r(94172),w=r(86710),T=r(49861),k=(r(84936),r(69912)),S=r(32035),R=r(12400),L=r(85305),V=r(95773);!function(e){e[e.Binary=0]="Binary",e[e.JSON=1]="JSON"}(i||(i={})),function(e){e[e.TreeIndex=0]="TreeIndex",e[e.TreeStats=1]="TreeStats",e[e.TreeData=2]="TreeData",e[e.BrickBundles=3]="BrickBundles",e[e.Section=4]="Section",e[e.VariableStats=5]="VariableStats"}(a||(a={})),function(e){e[e.None=1]="None",e[e.Front=2]="Front",e[e.Back=3]="Back"}(n||(n={})),function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(s||(s={})),function(e){e[e.None=0]="None",e[e.StaticSections=1]="StaticSections",e[e.Slices=2]="Slices",e[e.DynamicSections=4]="DynamicSections",e[e.GhostShell=8]="GhostShell",e[e.Isosurface=16]="Isosurface",e[e.Quality=32]="Quality",e[e.SunLocation=64]="SunLocation",e[e.StaticSectionSelection=128]="StaticSectionSelection",e[e.ExaggerationAndOffset=256]="ExaggerationAndOffset",e[e.CurrentTime=512]="CurrentTime",e[e.CurrentVariable=1024]="CurrentVariable",e[e.DeleteIsosurface=2048]="DeleteIsosurface",e[e.ContainerVisibility=4096]="ContainerVisibility",e[e.RenderMode=8192]="RenderMode",e[e.Optimization=16384]="Optimization",e[e.VariableStyles=32768]="VariableStyles",e[e.VolumeStyles=65536]="VolumeStyles",e[e.AnalysisSlice=131072]="AnalysisSlice"}(l||(l={})),function(e){e[e.Isosurfaces=0]="Isosurfaces",e[e.DynamicSections=1]="DynamicSections",e[e.StaticSections=2]="StaticSections"}(o||(o={}));var C=r(65905);function E(e){return(0,C.V)("esri/libs/vxl/".concat(e))}var F,I=r(50951),P=r(85312),U=r(38161),B=r(91643),A=r(70374),M=r(88153),W=r(54463),N=r(2263),q=r(93822),O=r(8548);!function(e){e[e.Lifetime=1]="Lifetime",e[e.RequestResponse=2]="RequestResponse",e[e.Rendering=3]="Rendering",e[e.Error=4]="Error"}(F||(F={}));var D=function(e){(0,h.Z)(i,e);var t=(0,v.Z)(i);function i(e){var r;return(0,d.Z)(this,i),(r=t.call(this,e))._halfIntTexturesAvailable=!1,r._textureFloatLinearAvailable=!1,r._havePreparedWithAllLayers=!1,r._renderPluginContext=null,r._vxlPromise=null,r._vxl=null,r._pluginIsActive=!1,r._moreToLoad=!1,r._viewportWidth=-1,r._viewportHeight=-1,r._newLayers=[],r._layers=new Map,r._rctx=null,r._renderTargetToRestore=null,r._lastFrameWasStationary=!1,r._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],r._wasmMemBlocks=new Map,r._dbgFlags=new Set,r._captureFrustum=!1,r._frustum=null,r._frustumRenderableId=-1,r._renderCoordsHelper=null,r.produces=new Map([[q.r.VOXEL,function(){return!!r._vxl&&"local"===r.view.viewingMode}]]),r.type=W.q7.VOXEL,r.slicePlaneEnabled=!0,r.isGround=!1,r.layerUid=[],r}return(0,_.Z)(i,[{key:"_dbg",value:function(e,t){this._dbgFlags.has(e)&&(e===F.Error?x.Z.getLogger(this).error(t):x.Z.getLogger(this).warn(t))}},{key:"_removeRenderPlugin",value:function(){this._pluginIsActive&&this.view._stage&&(this._dbg(F.Lifetime,"--removeRenderPlugin--"),this.view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}},{key:"initialize",value:function(){var e=this;this._dbg(F.Lifetime,"--initialize--");var t,r=(0,c.Z)(this._wasmMemBlockSizes);try{for(r.s();!(t=r.n()).done;){var i=t.value;this._wasmMemBlocks.set(i,0)}}catch(a){r.e(a)}finally{r.f()}this.addHandles([(0,b.watch)((function(){return e.view.ready}),(function(t){t&&"local"===e.view.viewingMode?(e._dbg(F.Lifetime,"view ready status changed to ready on a local view, calling addRenderPlugin"),e.view._stage.addRenderPlugin(e),e._pluginIsActive=!0):(e._dbg(F.Lifetime,"view ready status changed, not ready or not a local view!"),e._removeRenderPlugin())}),b.initial),(0,b.watch)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.qualityProfile}),(function(t){e._dbg(F.Rendering,"qualityProfile changed to "+t),e._vxl&&e._vxl.set_quality(e._toWasmQuality(t))}),b.initial),(0,b.watch)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.timeExtent}),(function(){if(e._vxl){var t,r=e._getTimeArgs(null===(t=e.view)||void 0===t?void 0:t.timeExtent);e._dbg(F.Rendering,"sceneView timeExtent changed to useTime="+r.hasTime+" st="+r.startTime+" et="+r.endTime),e._vxl.set_scene_time_extent(r.startTime,r.endTime,r.hasTime),e._renderPluginContext.requestRender()}}),b.initial),(0,b.watch)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.stationary}),(function(t){e._vxl&&t&&!e._lastFrameWasStationary&&e._renderPluginContext.requestRender()}))])}},{key:"initializeRenderContext",value:function(e){this._dbg(F.Lifetime,"--initializeRenderContext--");var t=e.renderContext.rctx;this._renderPluginContext=e,this._rctx=e.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this._textureFloatLinearAvailable=this._rctx.capabilities.textureFloatLinear,this._initializeWasm(t.gl)}},{key:"uninitializeRenderContext",value:function(){this._renderPluginContext=null,this._rctx=null,this._dbg(F.Lifetime,"--uninitializeRenderContext--")}},{key:"_restoreFramebuffer",value:function(){if(this._renderTargetToRestore){var e=this._renderTargetToRestore.fbo;if(this._rctx){this._rctx.bindFramebuffer(e,!0);var t=this._renderTargetToRestore.viewport;this._rctx.setViewport(t.x,t.y,t.width,t.height)}else this._dbg(F.Error,"no context in restoreFramebuffer!")}}},{key:"_bindPreviousDepthToSlot",value:function(e,t){var r=!!this._rctx,i=!!this._renderTargetToRestore;if(!r||!i)return 0;var a=this._renderTargetToRestore.fbo.depthStencilTexture;return a?(0===t?this._rctx.bindTexture(null,e,!0):this._rctx.bindTexture(a,e,!0),1):(this._dbg(F.Error,"no depth/stencil texture exists!"),0)}},{key:"_modifyResourceCount",value:function(e,t,r){if(this._rctx){var i=e;1===r?this._rctx.instanceCounter.increment(i,t):this._rctx.instanceCounter.decrement(i,t)}else this._dbg(F.Error,"modifyAllocation callback has no rendering context!")}},{key:"_setBlendState",value:function(e,t,r,i){this._rctx?(this._rctx.setBlendingEnabled(1===e),this._rctx.setBlendFunction(t,r),this._rctx.setBlendEquation(i)):this._dbg(F.Error,"setBlendState callback has no rendering context!")}},{key:"_setFrontFace",value:function(e){this._rctx?this._rctx.setFrontFace(e):this._dbg(F.Error,"setFrontFace callback has no rendering context!")}},{key:"_setDepthStencilStateFunction",value:function(e,t,r){this._rctx?(this._rctx.setDepthFunction(r),this._rctx.setDepthTestEnabled(1===e),this._rctx.setDepthWriteEnabled(1===t),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(O.wb.ALWAYS,0,255),this._rctx.setStencilOpSeparate(O.LR.FRONT,O.xS.KEEP,O.xS.INCR,O.xS.KEEP),this._rctx.setStencilOpSeparate(O.LR.BACK,O.xS.KEEP,O.xS.DECR,O.xS.KEEP)):this._dbg(F.Error,"setDepthStencilStateFunction callback has no rendering context!")}},{key:"_setRasterizerState",value:function(e){if(this._rctx)switch(e){case n.None:this._rctx.setFaceCullingEnabled(!1);break;case n.Back:this._rctx.setCullFace(O.LR.BACK),this._rctx.setFaceCullingEnabled(!0);break;case n.Front:this._rctx.setCullFace(O.LR.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(F.Error,"setRasterizerState callback has no rendering context!")}},{key:"_setViewport",value:function(e,t,r,i){this._rctx?this._rctx.setViewport(e,t,r,i):this._dbg(F.Error,"setViewport callback has no rendering context!")}},{key:"_updateMemoryUsage",value:function(){var e=this;this._layers.forEach((function(t,r){if(t.needMemoryUsageUpdate){var i=e._vxl.estimate_memory_usage(r);i>=0&&(t.needMemoryUsageUpdate=!1,t.layerView.setUsedMemory(i))}}))}},{key:"_syncRequestsResponses",value:function(){var e=this;this._layers.forEach((function(t,r){var i=[];t.responses.forEach((function(n,s){i.push(s),e._dbg(F.RequestResponse,"responding for requestID:"+s+" size:"+n.size),e._vxl.respond(r,s,n),n.requestType!==a.TreeIndex&&n.requestType!==a.Section||(t.needMemoryUsageUpdate=!0)}));for(var n=t.responses,s=0,l=i;s<l.length;s++){var o=l[s];n.delete(o)}var c=e._vxl.get_new_requests(r),d=t.abortController.signal,_=function(r){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();var i=c[r],a={responseType:"array-buffer",signal:d,query:(0,u.Z)((0,u.Z)({},t.layerView.layer.customParameters),{},{token:t.layerView.layer.apiKey})};e._dbg(F.RequestResponse,"making requestID:"+r+" url:"+i.url),(0,y.Z)(i.url,a).then((function(a){t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),e._dbg(F.RequestResponse,"have response for requestID:"+r);var s=0;if(a.data.byteLength>0){s=e._vxl._malloc(a.data.byteLength);for(var l=new Uint8Array(e._vxl.HEAPU8.buffer,s,a.data.byteLength),o=new Uint8Array(a.data),u=0;u<a.data.byteLength;++u)l[u]=o[u]}n.set(+r,{responseType:i.responseType,ptr:s,size:a.data.byteLength,success:!0,requestType:i.requestType})})).catch((function(a){t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),(0,p.D_)(a)||(e._dbg(F.Error,"requestID:".concat(r," failed, error=").concat(a.toString())),n.set(+r,{responseType:i.responseType,ptr:0,size:0,success:!1,requestType:i.requestType}))}))};for(var h in c)_(h)}))}},{key:"updateWasmCamera",value:function(e){this._vxl.set_projection_matrix.apply(this._vxl,e.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,e.viewMatrix),this._vxl.set_near_far(e.near,e.far)}},{key:"isUpdating",value:function(e){if(!this._vxl&&this._vxlPromise)return!0;var t=this._layers.get(e);return!!t&&t.outstandingRequestCount>0}},{key:"getLayerTimes",value:function(e){var t=this,r=[];return this._layers.forEach((function(i,a){if(i.layerView.wasmLayerId===e.wasmLayerId)for(var n=t._vxl.get_layer_epoch_times(a,e.layer.currentVariableId),s=0;s<n.length;++s)r.push(n[s])})),r}},{key:"getCurrentLayerTimeIndex",value:function(e){var t=this,r=0;return this._layers.forEach((function(i,a){i.layerView.wasmLayerId===e.wasmLayerId&&(r=t._vxl.get_layer_current_time_id(a))})),r}},{key:"setEnabled",value:function(e,t){var r=this;this._layers.forEach((function(i,a){i.layerView.wasmLayerId===e.wasmLayerId&&(r._vxl.set_enabled(a,t),i.needMemoryUsageUpdate=!0,r._renderPluginContext.requestRender())}))}},{key:"setIsInScaleRange",value:function(e,t){var r=this._layers.get(e.wasmLayerId);r&&t!==r.isInScaleRange&&(r.isInScaleRange=t,this._vxl.set_is_in_scale_range(e.wasmLayerId,t),r.needMemoryUsageUpdate=!t,this._renderPluginContext.requestRender())}},{key:"setStaticSections",value:function(e,t){var r={mask:l.StaticSections,staticSections:t};return this._doMaskedUIUpdate(e,r,!0)}},{key:"setCurrentVariable",value:function(e,t){var r={mask:l.CurrentVariable,currentVariable:t};return this._doMaskedUIUpdate(e,r,!0)}},{key:"setRenderMode",value:function(e,t){var r={mask:l.RenderMode,renderMode:t};return this._doMaskedUIUpdate(e,r,!0)}},{key:"setVerticalExaggerationAndOffset",value:function(e,t,r,i){var a={mask:l.ExaggerationAndOffset,volStyleDesc:{volumeId:t,verticalExaggeration:r,verticalOffset:i}};return this._doMaskedUIUpdate(e,a,!0)}},{key:"setVariableStyles",value:function(e,t){var r={mask:l.VariableStyles,variableStyles:t};return this._doMaskedUIUpdate(e,r,!0)}},{key:"setVolumeStyles",value:function(e,t){var r={mask:l.VolumeStyles,volumeStyles:t};return this._doMaskedUIUpdate(e,r,!0)}},{key:"setEnableDynamicSections",value:function(e,t){var r={mask:l.ContainerVisibility,containerIsVisible:t,container:o.DynamicSections};return this._doMaskedUIUpdate(e,r,!0)}},{key:"setEnableIsosurfaces",value:function(e,t){var r={mask:l.ContainerVisibility,containerIsVisible:t,container:o.Isosurfaces};return this._doMaskedUIUpdate(e,r,!0)}},{key:"setEnableSections",value:function(e,t){var r={mask:l.ContainerVisibility,containerIsVisible:t,container:o.StaticSections};return this._doMaskedUIUpdate(e,r,!0)}},{key:"setAnalysisSlice",value:function(e,t,r,i){var a={mask:l.AnalysisSlice,analysisSlice:{point:r,normal:i,enabled:t}};return this._doMaskedUIUpdate(e,a,!0)}},{key:"updateLayerTimeProperties",value:function(e){if(this._vxl){var t=this._layers.get(e.wasmLayerId);if(t){var r=t.layerView.layer,i=0;r.timeOffset&&(i=(0,w.rJ)(r.timeOffset.value,r.timeOffset.unit,"seconds"));var a=this._getTimeArgs(r.timeExtent);this._vxl.set_layer_time_properties(e.wasmLayerId,a.startTime,a.endTime,a.hasTime,r.useViewTime,i),this._renderPluginContext.requestRender()}}}},{key:"_doMaskedUIUpdate",value:function(e,t,r){var i=this;if(!this._vxl)return!1;var a=!1;return this._layers.forEach((function(r,n){if(r.layerView.wasmLayerId===e.wasmLayerId){var s={str:JSON.stringify(t),byteCount:0,ptr:0,isReusable:!1};i._allocateBlock(s)&&(a=1===i._vxl.handle_masked_ui_update(n,s.ptr,s.byteCount),s.isReusable||i._vxl._free(s.ptr))}})),a&&r&&this._renderPluginContext.requestRender(),a}},{key:"_addTriangleToWasmBuffer",value:function(e,t,r,i,a){return e[3*t]=r[0],e[3*t+1]=r[1],e[3*t+2]=r[2],e[3*(t+=1)]=i[0],e[3*t+1]=i[1],e[3*t+2]=i[2],e[3*(t+=1)]=a[0],e[3*t+1]=a[1],e[3*t+2]=a[2],t+1}},{key:"_addNormalToWasmBuffer",value:function(e,t,r){return e[3*t]=r[0],e[3*t+1]=r[1],e[3*t+2]=r[2],t+1}},{key:"_doCaptureFrustum",value:function(){if(this._vxl){var e=36,t=this._vxl._malloc(108*Float32Array.BYTES_PER_ELEMENT),r=new Float32Array(this._vxl.HEAPF32.buffer,t,108),i=this._vxl._malloc(36*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(this._vxl.HEAPF32.buffer,i,e),n=this._frustum.points[V.NQ.NEAR_BOTTOM_LEFT],s=this._frustum.points[V.NQ.NEAR_BOTTOM_RIGHT],l=this._frustum.points[V.NQ.NEAR_TOP_RIGHT],o=this._frustum.points[V.NQ.NEAR_TOP_LEFT],u=this._frustum.points[V.NQ.FAR_BOTTOM_LEFT],c=this._frustum.points[V.NQ.FAR_BOTTOM_RIGHT],d=this._frustum.points[V.NQ.FAR_TOP_RIGHT],_=this._frustum.points[V.NQ.FAR_TOP_LEFT],h=0,v=0,f=this._frustum.planes[V.Nu.NEAR];h=this._addTriangleToWasmBuffer(r,h,l,s,n),v=this._addNormalToWasmBuffer(a,v,f),h=this._addTriangleToWasmBuffer(r,h,n,o,l),v=this._addNormalToWasmBuffer(a,v,f);var m=this._frustum.planes[V.Nu.FAR];h=this._addTriangleToWasmBuffer(r,h,u,c,d),v=this._addNormalToWasmBuffer(a,v,m),h=this._addTriangleToWasmBuffer(r,h,d,_,u),v=this._addNormalToWasmBuffer(a,v,m);var y=this._frustum.planes[V.Nu.TOP];h=this._addTriangleToWasmBuffer(r,h,d,l,o),v=this._addNormalToWasmBuffer(a,v,y),h=this._addTriangleToWasmBuffer(r,h,o,_,d),v=this._addNormalToWasmBuffer(a,v,y);var g=this._frustum.planes[V.Nu.BOTTOM];h=this._addTriangleToWasmBuffer(r,h,n,s,c),v=this._addNormalToWasmBuffer(a,v,g),h=this._addTriangleToWasmBuffer(r,h,c,u,n),v=this._addNormalToWasmBuffer(a,v,g);var x=this._frustum.planes[V.Nu.LEFT];h=this._addTriangleToWasmBuffer(r,h,o,n,u),v=this._addNormalToWasmBuffer(a,v,x),h=this._addTriangleToWasmBuffer(r,h,u,_,o),v=this._addNormalToWasmBuffer(a,v,x);var p=this._frustum.planes[V.Nu.RIGHT];h=this._addTriangleToWasmBuffer(r,h,l,d,c),v=this._addNormalToWasmBuffer(a,v,p),h=this._addTriangleToWasmBuffer(r,h,c,s,l),v=this._addNormalToWasmBuffer(a,v,p),-1!==this._frustumRenderableId&&this._vxl.remove_generic_mesh(this._frustumRenderableId),this._frustumRenderableId=this._vxl.add_generic_mesh(t,108,i,e,255,0,0,64),this._vxl._free(t),this._vxl._free(i),this._captureFrustum=!1,this._renderPluginContext.requestRender()}}},{key:"captureFrustum",value:function(){null===this._renderCoordsHelper&&(this._renderCoordsHelper=B.Z.create(I.JY.Local,(0,L.E2)(!1,this.view.spatialReference))),null===this._frustum&&(this._frustum=new U.i(this._renderCoordsHelper)),this._captureFrustum=!0,null!==this._renderPluginContext&&this._renderPluginContext.requestRender()}},{key:"toggleFullVolumeExtentDraw",value:function(e){var t=this;this._vxl&&this._layers.forEach((function(r,i){r.layerView.wasmLayerId===e.wasmLayerId&&(t._vxl.toggle_full_volume_extent_draw(i),t._renderPluginContext.requestRender())}))}},{key:"addVoxelLayer",value:function(e){if(!this._vxl){var t={layerView:e,resolveCallback:null,rejectCallback:null},r=new Promise((function(e,r){t.resolveCallback=e,t.rejectCallback=r}));return this._newLayers.push(t),r}var i=this._addVoxelLayer(e);return i<0?Promise.reject(-1):Promise.resolve(i)}},{key:"removeVoxelLayer",value:function(e){var t=this;if(!this._vxl){var r=this._newLayers.findIndex((function(t){return e.uid===t.layerView.uid}));r>=0&&(this._newLayers[r].resolveCallback(-1),this._newLayers.splice(r,1));var i=this._newLayers.length;return 0===i&&(this._dbg(F.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i}var a=-1;this._layers.forEach((function(r,i){if(r.layerView.wasmLayerId===e.wasmLayerId){a=i,r.abortController.abort(),t._vxl.remove_layer(a);var n=t.layerUid.indexOf(e.layer.uid);-1!==n&&t.layerUid.splice(n,1)}})),a>=0&&this._layers.delete(a);var n=this._layers.size;return 0===n&&(this._dbg(F.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),n}},{key:"_getBlockSize",value:function(e){var t,r=(0,c.Z)(this._wasmMemBlockSizes);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(e<i)return i}}catch(a){r.e(a)}finally{r.f()}return-1}},{key:"_allocateBlock",value:function(e){e.byteCount=this._vxl.lengthBytesUTF8(e.str)+1;var t=this._getBlockSize(e.byteCount);return t<0?(e.isReusable=!1,e.ptr=this._vxl._malloc(e.byteCount)):(e.isReusable=!0,e.ptr=this._wasmMemBlocks.get(t),0===e.ptr&&(e.ptr=this._vxl._malloc(t),this._wasmMemBlocks.set(t,e.ptr))),0!==e.ptr&&(this._vxl.stringToUTF8(e.str,e.ptr,e.byteCount),!0)}},{key:"_getTimeArgs",value:function(e){var t=-Number.MAX_VALUE,r=Number.MAX_VALUE,i=!1;return null!=e&&(e.isAllTime?i=!0:(null!=e.start&&(i=!0,t=e.start.getTime()/1e3),null!=e.end&&(i=!0,r=e.end.getTime()/1e3))),{startTime:t,endTime:r,hasTime:i}}},{key:"_addVoxelLayer",value:function(e){var t,r=e.layer,i=r.getConfiguration();if(i.length<1)return-1;var a={str:i,byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(a))return-1;var n=this._getTimeArgs(r.timeExtent),s=this.view.spatialReference.isWGS84&&r.spatialReference.isWGS84?111319.49079327357:1,l=0;if(r.timeOffset&&(l=(0,w.rJ)(r.timeOffset.value,r.timeOffset.unit,"seconds")),t=this._vxl.add_layer(r.serviceRoot,a.ptr,a.byteCount,s,s,n.startTime,n.endTime,n.hasTime,r.useViewTime,l,this._toWasmQuality(this.view.qualityProfile)),a.isReusable||this._vxl._free(a.ptr),t>=0){var o;(null===(o=r.test)||void 0===o?void 0:o.constantUpscaling)&&(this._setUpscalingLimits(0,.25,.25),this._setUpscalingLimits(1,.5,.5),this._setUpscalingLimits(2,.75,.75));var u=new AbortController;if(this._layers.set(t,{layerView:e,responses:new Map,outstandingRequestCount:0,abortController:u,needMemoryUsageUpdate:!1,isInScaleRange:!0}),this.layerUid.push(e.layer.uid),!this._halfIntTexturesAvailable||(0,g.Z)("mac")){var d,_=[],h="",v=(0,c.Z)(e.layer.variables);try{for(v.s();!(d=v.n()).done;){var f=d.value;"Int16"!==f.renderingFormat.type&&"UInt16"!==f.renderingFormat.type||(_.push(f.name),f.id===e.layer.currentVariableId&&(h=f.name))}}catch(k){v.e(k)}finally{v.f()}""!==h&&x.Z.getLogger(this).error("#addVoxelLayer_error()",e.layer,"The voxel layer '".concat(e.layer.title,"' cannot render the current variable '").concat(h,"' in this browser")),_.length>0&&x.Z.getLogger(this).warn("#addVoxelLayer_warning()",e.layer,"The voxel layer '".concat(e.layer.title,"' cannot render the variables '").concat(_.toString(),"' in this browser"))}if(!this._textureFloatLinearAvailable){var m,y=[],p="",b=(0,c.Z)(e.layer.variables);try{for(b.s();!(m=b.n()).done;){var T=m.value;"Float32"===T.renderingFormat.type&&(y.push(T.name),T.id===e.layer.currentVariableId&&(p=T.name))}}catch(k){b.e(k)}finally{b.f()}""!==p&&x.Z.getLogger(this).error("#addVoxelLayer_error()",e.layer,"The voxel layer '".concat(e.layer.title,"' cannot render the current variable '").concat(p,"' in this browser")),y.length>0&&x.Z.getLogger(this).warn("#addVoxelLayer_warning()",e.layer,"The voxel layer '".concat(e.layer.title,"' cannot render the variables '").concat(y.toString(),"' in this browser"))}return(0,g.Z)("esri-mobile")&&x.Z.getLogger(this).warnOnce("Mobile support differs across devices. Voxel layer might not display as expected."),t}return-1}},{key:"prepareRender",value:function(e){if(this._vxl){var t=e.bindParameters.camera.viewForward,r=e.bindParameters.camera.eye;this._vxl.update_camera_pos_and_direction(r[0],r[1],r[2],t[0],t[1],t[2]);var i=this._vxl.cull();this._dbg(F.RequestResponse,"missingResourceCount="+i),this._moreToLoad=i>0,this._havePreparedWithAllLayers=0===this._newLayers.length,this._updateMemoryUsage()}}},{key:"renderNode",value:function(e){if(this._vxl){var t,r=(0,c.Z)(this._newLayers);try{for(r.s();!(t=r.n()).done;){var i=t.value,a=this._addVoxelLayer(i.layerView);-1===a?i.rejectCallback(-1):i.resolveCallback(a)}}catch(s){r.e(s)}finally{r.f()}if(this._newLayers=[],0!==this._layers.size){this._lastFrameWasStationary=this.view.stationary,this._syncRequestsResponses(),this._beforeDraw(),this._vxl.begin_color_frame(!this.view._stage.renderer.isFeatureEnabled(N.Y.HighResolutionVoxel),e.bindParameters.lighting.mainLight.direction[0],e.bindParameters.lighting.mainLight.direction[1],e.bindParameters.lighting.mainLight.direction[2]);var n=this._renderTargetToRestore.viewport;n.width===this._viewportWidth&&n.height===this._viewportHeight||(this._viewportWidth=n.width,this._viewportHeight=n.height,this._vxl.set_viewport(n.width,n.height),this._layers.forEach((function(e){e.needMemoryUsageUpdate=!0}))),0===n.x&&0===n.y||this._dbg(F.Error,"Unsupported viewport parameters detected!"),this.updateWasmCamera(e.bindParameters.camera),this._captureFrustum&&(this._frustum.update(e.bindParameters.camera),this._doCaptureFrustum()),this._vxl.draw(),this._afterDraw(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender()}else this._dbg(F.Error,"No voxel layers but RenderPlugin instance is being asked to render!")}}},{key:"destroy",value:function(){var e=this;this._dbg(F.Lifetime,"--destroy--"),this._removeRenderPlugin(),this._vxl&&(this._layers.forEach((function(e){e.abortController.abort()})),this._wasmMemBlocks.forEach((function(t){0!==t&&e._vxl._free(t)})),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}},{key:"_initializeWasm",value:function(e){var t=this;return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=function(e){return new Promise((function(t){return r.e(4808).then(r.bind(r,4808)).then((function(e){return e.v})).then((function(r){var i=(0,r.default)({locateFile:E,preinitializedWebGLContext:e,onRuntimeInitialized:function(){return t(i)}})}))})).catch((function(e){throw e}))}(e).then((function(e){var r;if(t._vxl=e,t._vxlPromise=null,t._newLayers.length<=0)return t._dbg(F.Lifetime," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void t.destroy();var i=t._getTimeArgs(null===(r=t.view)||void 0===r?void 0:r.timeExtent),a=t._vxl.addFunction(t._restoreFramebuffer.bind(t),"v"),n=t._vxl.addFunction(t._setBlendState.bind(t),"viiii"),s=t._vxl.addFunction(t._setFrontFace.bind(t),"vi"),l=t._vxl.addFunction(t._setRasterizerState.bind(t),"vi"),o=t._vxl.addFunction(t._setDepthStencilStateFunction.bind(t),"viii"),u=t._vxl.addFunction(t._setViewport.bind(t),"viiii"),c=t._vxl.addFunction(t._bindPreviousDepthToSlot.bind(t),"iii"),d=t._vxl.addFunction(t._modifyResourceCount.bind(t),"viii"),_=t._halfIntTexturesAvailable&&!(0,g.Z)("mac"),h=t._textureFloatLinearAvailable;t._vxl.initialize_voxel_wasm(a,n,s,l,o,u,c,d,i.startTime,i.endTime,i.hasTime,_,h),t._renderPluginContext&&t._renderPluginContext.requestRender()})).catch((function(){var e,r=(0,c.Z)(t._newLayers);try{for(r.s();!(e=r.n()).done;){e.value.rejectCallback(-2)}}catch(i){r.e(i)}finally{r.f()}t._dbg(F.Error," WASM failed to download, removing RenderPlugin and destroying"),t.destroy()}))),this._vxlPromise)}},{key:"pickDepth",value:function(e,t,r){if(!this._vxl||!this._rctx||0===this._layers.size)return null;var i=r.viewport[3]-t;if(e<0||e>r.viewport[2]||t<0||t>r.viewport[3])return this._dbg(F.Error,"[js] pickDepth: outOfRange, screenXY=[".concat(e.toFixed(0),", ").concat(i.toFixed(0),"]]")),null;this._beforeDraw();var a=r.viewForward,n=r.eye;this._vxl.update_camera_pos_and_direction(n[0],n[1],n[2],a[0],a[1],a[2]),this.updateWasmCamera(r),this._vxl.begin_frame();var s=this._vxl.pick_depth(e,i);return this._afterDraw(),s.success?s.distanceToCamera:null}},{key:"pickObject",value:function(e,t,r,i){if(!this._vxl||!this._rctx||0===this._layers.size)return null;var a=Math.round(e),n=Math.round(t);if(a<0||a>r.viewport[2]||n<0||n>r.viewport[3])return this._dbg(F.Error,"[js] pickObject: outOfRange, screenXY=[".concat(a,", ").concat(n,"], vp=[").concat(r.viewport.toString(),"]")),null;this._beforeDraw();var s=r.viewForward,l=r.eye;this._vxl.update_camera_pos_and_direction(l[0],l[1],l[2],s[0],s[1],s[2]),this.updateWasmCamera(r),this._vxl.begin_frame();var o=null;if(0===i.length)o=this._vxl.pick_object(a,n,0,0);else{var u={str:JSON.stringify({layerIds:i}),byteCount:0,ptr:0,isReusable:!1};this._allocateBlock(u)&&(o=this._vxl.pick_object(a,n,u.ptr,u.byteCount),u.isReusable||this._vxl._free(u.ptr))}return this._afterDraw(),o}},{key:"_beforeDraw",value:function(){this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._rctx.setPolygonOffsetFillEnabled(!1),this._rctx.setScissorTestEnabled(!1),this._rctx.setColorMask(!0,!0,!0,!0)}},{key:"_afterDraw",value:function(){this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate()}},{key:"intersect",value:function(e,t,r,i,a){var n=this;if(this._vxl&&this._rctx&&0!==this._layers.size&&e.options.selectionMode&&!e.options.isFiltered){if(null==a||a[0]<0||a[0]>e.camera.viewport[2]||a[1]<0||a[1]>e.camera.viewport[3])return this._dbg(F.Error,"[js] VoxelWasmPerScene.intersect: outOfRange, screenXY=[".concat(a[0].toFixed(0),", ").concat(a[1].toFixed(0),"]")),null;var s=[];this._layers.forEach((function(t){e.options.filteredLayerUids.includes(t.layerView.layer.uid)&&s.push(t.layerView.wasmLayerId)}));var l=this.pickObject(a[0],a[1],e.camera,s);if(null!=l&&-1!==l.layerId){var o=this._layers.get(l.layerId);if(o){var u=o.layerView.layer.uid,c=l.distanceToCamera/(0,S.p)(r,i),d=(0,R.Ue)();d[0]=l.worldX,d[1]=l.worldY,d[2]=l.worldZ;var _={};if(null!=l.continuousValue&&null!=l.continuousValueUnits?_["Voxel.ServiceValue"]="".concat(l.continuousValue.toLocaleString()," ").concat(l.continuousValueUnits):null!=l.uniqueValueLabel&&null!=l.uniqueValue?_["Voxel.ServiceValue"]="".concat(l.uniqueValueLabel," (").concat(l.uniqueValue,")"):null!=l.uniqueValue&&(_["Voxel.ServiceValue"]="".concat(l.uniqueValue)),_["Voxel.ServiceVariableLabel"]=l.variableLabel,_["Voxel.Position"]=l.voxelSpacePosition,null!=l.epochTime&&null!=l.nativeTime&&null!=l.nativeTimeUnits){var h=new Date(l.epochTime);_["Voxel.ServiceLocalTime"]=h.toString(),_["Voxel.ServiceNativeTime"]="".concat(l.nativeTime.toLocaleString()," ").concat(l.nativeTimeUnits)}null!=l.depth&&null!=l.depthUnits&&(_["Voxel.ServiceDepth"]="".concat(l.depth.toLocaleString()," ").concat(l.depthUnits));var v=l.faceNormal;_["Voxel.WorldPosition"]="[".concat(d[0],", ").concat(d[1],", ").concat(d[2],"]");var f=function(e){var t=new P.DI(d,u,(function(){return n._createVoxelGraphic(o.layerView.layer,_)}));e.set(n.type,t,c,v)},m=e.results,y=e.options.store===W.eC.ALL;if((null==m.min.dist||c<m.min.dist)&&f(m.min),(null==m.max.dist||c>m.max.dist)&&f(m.max),y){var g=(0,M.LP)(e.ray);f(g),e.results.all.push(g)}}}}}},{key:"_createVoxelGraphic",value:function(e,t){return new m.Z({layer:e,sourceLayer:e,attributes:t})}},{key:"_toWasmQuality",value:function(e){switch(e){case"low":return 0;case"medium":return 1;case"high":return 2}}},{key:"_setUpscalingLimits",value:function(e,t,r){this._vxl&&this._vxl.set_upscaling_limits(e,t,r)}}]),i}(A.tY);(0,f._)([(0,T.Cb)({constructOnly:!0})],D.prototype,"view",void 0);var z=D=(0,f._)([(0,k.j)("esri.layers.VoxelWasmPerSceneView")],D)}}]);
//# sourceMappingURL=7199.ea9e5f93.chunk.js.map