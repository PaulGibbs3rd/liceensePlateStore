"use strict";(self.webpackChunkreact_training=self.webpackChunkreact_training||[]).push([[23842],{23842:function(e,t,r){r.r(t),r.d(t,{default:function(){return Te}});var n=r(93433),i=r(1413),a=r(74165),s=r(15861),o=r(15671),l=r(43144),u=r(97326),c=r(88301),f=r(61120),h=r(60136),p=r(29388),d=r(27366),m=r(44055),v=r(11582),y=r(10064),x=r(32718),g=r(97642),b=r(66978),k=r(94172),w=r(49861),Z=r(25243),I=(r(84936),r(93169),r(27135)),_=r(69912),R=r(30651),S=r(11936),T=r(6693),C=r(46671),M=r(29439),F=(r(59486),r(45918)),O=r(76200),P=r(44927),D=r(38511),B=r(92975),N=r(25899),J=r(70361),A=r(86591),E=r(22678),z=r(41625),L=r(79586),H=r(22824),W=r(80885),q=r(59226),G=r(68860),j=r(53866),U=r(99278);function V(e,t){if(e.spatialReference.equals(t))return e;var r=(0,G.c9)(e.spatialReference),n=(0,G.c9)(t);if(r===n)return e;var i=r/n;return{x:e.x*i,y:e.y*i}}function Y(e,t,r){return X.apply(this,arguments)}function X(){return X=(0,s.Z)((0,a.Z)().mark((function e(t,i,s){var o,l,u,c,f,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("extent"!==s.type){e.next=2;break}return e.abrupt("return",K(t,i,s));case 2:return o=t.width,l=t.height,u=new Uint8Array(o*l),e.next=7,Promise.all([r.e(99058),r.e(2170)]).then(r.bind(r,2170));case 7:return c=e.sent,f=c.contains,h=c.intersects,e.abrupt("return",h(i,s)?"polyline"===s.type?$(t,i,s):f(s,i)?t:Q(t,i,s):new U.Z({pixelType:t.pixelType,width:o,height:l,mask:u,maskIsAlpha:!1,pixels:(0,n.Z)(t.pixels)}));case 11:case"end":return e.stop()}}),e)}))),X.apply(this,arguments)}function Q(e,t,r){if(!e)return e;var i,a=e.width,s=e.height,o=t.width/a,l=t.height/s,u=t.xmin,c=t.ymax;if("extent"===r.type){var f=(r.xmin-u)/o,h=(r.xmax-u)/o,p=(c-r.ymax)/l,d=(c-r.ymin)/l;i=[[[f,p],[f,d],[h,d],[h,p],[f,p]]]}else i=r.rings.map((function(e){return e.map((function(e){var t=(0,M.Z)(e,2),r=t[0],n=t[1];return[(r-u)/o,(c-n)/l]}))}));var m=document.createElement("canvas");m.width=a,m.height=s;var v=m.getContext("2d");v.fillStyle="#f00",v.beginPath(),i.forEach((function(e){v.moveTo(e[0][0],e[0][1]);for(var t=0;t<e.length;t++)v.lineTo(e[t][0],e[t][1]);v.closePath()})),v.fill();for(var y=v.getImageData(0,0,a,s).data,x=e.mask,g=a*s,b=new Uint8Array(g),k=0;k<g;k++)x&&!x[k]||(b[k]=y[4*k+3]>127?255:0);return new U.Z({pixelType:e.pixelType,width:a,height:s,mask:b,maskIsAlpha:!1,pixels:(0,n.Z)(e.pixels)})}function K(e,t,r){var i=e.width,a=e.height,s=new Uint8Array(i*a),o=t.width/i,l=t.height/a;if(r.width/o<.5||r.height/l<.5)return new U.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)});var u=t.xmin,c=t.xmax,f=t.ymin,h=t.ymax,p=r.xmin,d=r.xmax,m=r.ymin,v=r.ymax,y=Math.max(u,p),x=Math.min(c,d),g=Math.max(f,m),b=Math.min(h,v),k=.5*o,w=.5*l;if(x-y<k||b-g<w||x<u+k||y>c-k||g>h-w||b<f+w)return new U.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)});var Z=Math.max(0,(y-u)/o),I=Math.min(i,Math.max(0,(x-u)/o)),_=Math.max(0,(h-b)/l),R=Math.min(a,Math.max(0,(h-g)/l)),S=Math.round(Z),T=Math.round(I)-1,C=Math.round(_),M=Math.round(R)-1;if(S===T&&Z%1>.5&&I%1<.5||C===M&&_%1>.5&&R%1<.5)return new U.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)});if(0===S&&0===C&&T===i&&M===a)return e;for(var F=e.mask,O=C;O<=M;O++)for(var P=S;P<=T;P++){var D=O*i+P;s[D]=F?F[D]:255}return new U.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)})}function $(e,t,r){for(var i=e.width,a=e.height,s=new Uint8Array(i*a),o=t.width/i,l=t.height/a,u=t.xmin,c=t.ymax,f=r.paths,h=e.mask,p=0;p<f.length;p++)for(var d=f[p],m=0;m<d.length-1;m++){var v=(0,M.Z)(d[m],2),y=v[0],x=v[1],g=(0,M.Z)(d[m+1],2),b=g[0],k=g[1],w=Math.floor((c-x)/l),Z=Math.floor((c-k)/l);if(Z<w){var I=w;w=Z,Z=I}w=Math.max(0,w),Z=Math.min(a-1,Z);for(var _=(b-y)/(k-x),R=w;R<=Z;R++){var S=R===w?Math.max(x,k):(a+1-R)*l,T=R===Z?Math.min(x,k):S-l,C=k===x?Math.floor((y-u)/o):Math.floor((_*(S-x)+y-u)/o),F=k===x?Math.floor((b-u)/o):Math.floor((_*(T-x)+y-u)/o);if(F<C){var O=C;C=F,F=O}var P=R*i;C=Math.max(0,C),F=Math.min(i-1,F);for(var D=P+C;D<=P+F;D++)s[D]=h?h[D]:255}}return new U.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)})}function ee(e,t,r){var n,i,a,s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=e.spatialReference,l=V(r,o),u=l.x,c=l.y,f="extent"===t.type?t:t.extent,h=f.xmin,p=f.xmax,d=f.ymax,m=f.ymin,v=e.extent,y=v.xmin,x=v.ymax;return s?(h=y+(h>y?u*Math.round((h-y)/u):0),d=x-(d<x?c*Math.round((x-d)/c):0),p=y+(p>y?u*Math.round((p-y)/u):0),m=x-(m<x?c*Math.round((x-m)/c):0),n=new j.Z({xmin:h,ymax:d,xmax:p,ymin:m,spatialReference:o}),i=Math.round(n.width/u),a=Math.round(n.height/c)):(i=Math.floor((p-h)/u+.8),a=Math.floor((d-m)/c+.8),p=(h=y+(h>y?u*Math.floor((h-y)/u+.1):0))+i*u,m=(d=x-(d<x?c*Math.floor((x-d)/c+.1):0))-a*c,n=new j.Z({xmin:h,ymax:d,xmax:p,ymin:m,spatialReference:o})),{extent:n,width:i,height:a}}var te=r(17314),re=r(80394),ne=r(49818),ie=function(e){(0,h.Z)(n,e);var t=(0,p.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).datasetFormat="Function",e.tileType="Raster",e.rasterFunction=null,e._clippingGeometry=new Map,e}return(0,l.Z)(n,[{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h,p,d,m,v,x=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return l=this.rasterFunction,null!==(r=this.primaryRasters)&&void 0!==r&&null!==(n=r.rasters)&&void 0!==n&&n.length?l.sourceRasters=this.primaryRasters.rasters:(this.primaryRasters=l.getPrimaryRasters(),this.rasterJobHandler&&(null===(i=this.primaryRasters.rasters)||void 0===i||i.forEach((function(e){return e.rasterJobHandler=x.rasterJobHandler})))),u=this.primaryRasters,c=u.rasters,f=u.rasterIds,h=c.map((function(e){return e.rasterInfo?void 0:e.open(t)})),e.next=7,Promise.all(h);case 7:if(p=c.map((function(e){return e.rasterInfo})),d=l.bind({rasterInfos:p,rasterIds:f}),l.rawSourceRasterInfos=p,d.success&&0!==p.length){e.next=10;break}throw new y.Z("raster-function:open","cannot bind the function: ".concat(null!==(s=d.error)&&void 0!==s?s:""));case 10:return"Table"===(null===(m="Table"===l.functionName?l:null===(o=l.functionArguments)||void 0===o?void 0:o.raster)||void 0===m?void 0:m.functionName)&&(l.rasterInfo.attributeTable=ne.Z.fromJSON(m.functionArguments.attributeTableAsRecordSet)),e.next=14,this.syncJobHandler();case 14:return v=p[0],this.hasUniqueSourceStorageInfo=1===p.length||p.slice(1).every((function(e){return se(e,v)})),this.set("sourceJSON",c[0].sourceJSON),this.set("rasterInfo",l.rasterInfo),e.next=20,this._updateClipGeometry();case 20:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"syncJobHandler",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null===(t=this.rasterJobHandler)||void 0===t?void 0:t.updateRasterFunction(this.rasterFunction));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k,w,Z,I,_,R,S=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=S.length>3&&void 0!==S[3]?S[3]:{},c=this.primaryRasters,f=c.rasters,h=c.rasterIds,p=!1,d=u.interpolation,m=null===(s=this.rasterFunction.flatWebGLFunctionChain)||void 0===s?void 0:s.hasFocalFunction,!u.requestRawData&&m&&(p=1===f.length&&!u.skipRasterFunction,u=(0,i.Z)((0,i.Z)({},u),{},{interpolation:"bilinear",requestRawData:p})),v=f.map((function(e){return e.fetchPixels(t,r,n,u)})),e.next=8,Promise.all(v);case 8:if(y=e.sent,x=y.map((function(e){return e.pixelBlock})),g=p||u.requestRawData?y.map((function(e){return e.srcTilePixelSize})):null,!u.skipRasterFunction&&!x.every((function(e){return null==e}))){e.next=13;break}return e.abrupt("return",y[0]);case 13:if(b=null!==(o=null===(l=y.find((function(e){return null!=e.pixelBlock})))||void 0===l?void 0:l.extent)&&void 0!==o?o:t,!this.rasterJobHandler){e.next=20;break}return e.next=17,this.rasterJobHandler.process({extent:b,primaryPixelBlocks:x,primaryPixelSizes:g,primaryRasterIds:h});case 17:e.t0=e.sent,e.next=21;break;case 20:e.t0=this.rasterFunction.process({extent:b,primaryPixelBlocks:x,primaryPixelSizes:g,primaryRasterIds:h});case 21:if(k=e.t0,w=y[0].transformGrid,p&&null!=k&&null!=w){e.next=31;break}if(Z=u.noClip?null:this.getClippingGeometry(b.spatialReference),e.t1=u.noClip||u.requestRawData||null==k||!Z,e.t1){e.next=30;break}return e.next=29,Y(k,b,Z);case 29:k=e.sent;case 30:return e.abrupt("return",(0,i.Z)((0,i.Z)({},y[0]),{},{pixelBlock:k}));case 31:if(I={rows:w.spacing[0],cols:w.spacing[1]},!this.rasterJobHandler){e.next=38;break}return e.next=35,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[k],srcMosaicSize:{width:k.width,height:k.height},destDimension:{width:r,height:n},coefs:w.coefficients,sampleSpacing:I,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:d,alignmentInfo:void 0,blockWidths:null},u);case 35:_=e.sent.pixelBlock,e.next=39;break;case 38:_=(0,te.Uk)(k,{width:r,height:n},w.coefficients,I,d);case 39:if(R=u.noClip?null:this.getClippingGeometry(t.spatialReference),e.t2=u.noClip||u.requestRawData||null==_||null==R,e.t2){e.next=45;break}return e.next=44,Y(_,t,R);case 44:_=e.sent;case 45:return e.abrupt("return",{extent:t,srcExtent:y[0].srcExtent,pixelBlock:_});case 46:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getClippingGeometry",value:function(e){var t=this._clippingGeometry.get("0");if(!e||!t)return t;var r=function(e){var t,r;return String(null!==(t=null!==(r=e.wkid)&&void 0!==r?r:e.wkt)&&void 0!==t?t:e.wkt2)}(e),n=this._clippingGeometry.get(r);return null!=n||(n=e.equals(t.spatialReference)?t:(0,re.Wt)(t,e),this._clippingGeometry.set(r,n)),n}},{key:"_updateClipGeometry",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t,n,i,s,o,l,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.rasterFunction.getClippingGeometries()[0],!(n=null===t||void 0===t?void 0:t.clippingGeometry)||"inside"!==t.clippingType){e.next=11;break}return i=this.rasterInfo.extent,e.next=6,Promise.all([r.e(99058),r.e(2170)]).then(r.bind(r,2170));case 6:s=e.sent,o=s.difference,l=s.densify,u=l(W.Z.fromExtent(i),2*(i.width+i.height)/40),u=(0,re.Wt)(u,n.spatialReference),n=o(u,n);case 11:this._clippingGeometry.clear(),n&&this._clippingGeometry.set("0",n);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),n}(q.Z);(0,d._)([(0,w.Cb)({type:String,json:{write:!0}})],ie.prototype,"datasetFormat",void 0),(0,d._)([(0,w.Cb)()],ie.prototype,"tileType",void 0),(0,d._)([(0,w.Cb)()],ie.prototype,"rasterFunction",void 0),(0,d._)([(0,w.Cb)()],ie.prototype,"primaryRasters",void 0);var ae=ie=(0,d._)([(0,_.j)("esri.layers.support.rasterDatasets.FunctionRaster")],ie);function se(e,t){var r=e.storageInfo,n=e.pixelSize,i=e.spatialReference,a=e.extent,s=t.storageInfo,o=t.pixelSize,l=t.spatialReference,u=t.extent;return n.x===o.x&&n.y===o.y&&i.equals(l)&&a.equals(u)&&r.blockHeight===s.blockHeight&&r.blockWidth===s.blockWidth&&r.maximumPyramidLevel===s.maximumPyramidLevel}var oe=r(21969),le=r(43346),ue=r(21449),ce=r(64145),fe=r(73425),he=r(43238),pe=r(50254),de=r(55185),me=r(78952),ve=r(848),ye=r(6061),xe=r(29598),ge=r(71684),be=r(56811),ke=r(99063),we=r(83040),Ze=r(60117),Ie=r(70047),_e=r(81085),Re=r(84933),Se=function(e){(0,h.Z)(d,e);var t=(0,p.Z)(d);function d(){var e;(0,o.Z)(this,d);for(var n=arguments.length,i=new Array(n),l=0;l<n;l++)i[l]=arguments[l];return(e=t.call.apply(t,[this].concat(i)))._primaryRasters=[],e.bandIds=null,e.interpolation=null,e.legendEnabled=!0,e.isReference=null,e.listMode="show",e.sourceJSON=null,e.version=null,e.type="imagery-tile",e.operationalLayerType="ArcGISTiledImageServiceLayer",e.popupEnabled=!0,e.popupTemplate=null,e.fields=null,e.source=void 0,e._debouncedSaveOperations=(0,b.Ds)(function(){var t=(0,s.Z)((0,a.Z)().mark((function t(n,i,s){var o,l,c;return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.e(63275).then(r.bind(r,63275));case 2:o=t.sent,l=o.save,c=o.saveAs,t.t0=n,t.next=t.t0===Re.x.SAVE?8:t.t0===Re.x.SAVE_AS?9:10;break;case 8:return t.abrupt("return",l((0,u.Z)(e),i));case 9:return t.abrupt("return",c((0,u.Z)(e),s,i));case 10:case"end":return t.stop()}}),t)})));return function(e,r,n){return t.apply(this,arguments)}}()),e}return(0,l.Z)(d,[{key:"normalizeCtorArgs",value:function(e,t){return"string"==typeof e?(0,i.Z)({url:e},t):e}},{key:"load",value:function(e){var t=this,r=null!=e?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(b.r9).then((function(){return t._openRaster(r)}))),Promise.resolve(this)}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"rasterFields",get:function(){var e,t,r=[new we.Z({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"}),new we.Z({name:"Raster.ServicePixelValue.Raw",alias:"Raw Pixel Value",domain:null,editable:!1,length:50,type:"string"})],i=null!==(e=null===(t=this.raster)||void 0===t?void 0:t.rasterInfo)&&void 0!==e?e:this.serviceRasterInfo,a=null===i||void 0===i?void 0:i.attributeTable,s=null!=a?a.fields:null;if(s){var o=s.filter((function(e){return"oid"!==e.type&&"value"!==e.name.toLowerCase()})).map((function(e){var t=e.clone();return t.name="Raster."+e.name,t}));r.push.apply(r,(0,n.Z)(o))}var l=null===i||void 0===i?void 0:i.dataType,u=null===i||void 0===i?void 0:i.multidimensionalInfo;if(("vector-magdir"===l||"vector-uv"===l)&&null!=u){var c,f=null===(c=u.variables[0].unit)||void 0===c?void 0:c.trim(),h="Magnitude"+(f?" (".concat(f,")"):"");r.push(new we.Z({name:"Raster.Magnitude",alias:h,domain:null,editable:!1,type:"double"})),r.push(new we.Z({name:"Raster.Direction",alias:"Direction (\xb0)",domain:null,editable:!1,type:"double"}))}return r}},{key:"createPopupTemplate",value:function(e){var t=this.rasterFields,r=new Set(t.map((function(e){return e.name})).filter((function(e){return"raster.servicepixelvalue.raw"!==e.toLowerCase()})));return(0,_e.eZ)({fields:t,title:this.title},(0,i.Z)((0,i.Z)({},e),{},{visibleFieldNames:r}))}},{key:"generateRasterInfo",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,i,s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,Z.TJ)(z.Z,t),e.next=3,this.load();case 3:if(t&&"none"!==(null===(n=t.functionName)||void 0===n?void 0:n.toLowerCase())){e.next=5;break}return e.abrupt("return",this.serviceRasterInfo);case 5:return e.prev=5,e.next=8,this._openFunctionRaster(t,r);case 8:return i=e.sent,s=i.rasterInfo,e.abrupt("return",s);case 13:if(e.prev=13,e.t0=e.catch(5),!(e.t0 instanceof y.Z)){e.next=17;break}throw e.t0;case 17:throw new y.Z("imagery-tile-layer","the given raster function is not supported");case 18:case"end":return e.stop()}}),e,this,[[5,13]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"save",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._debouncedSaveOperations(Re.x.SAVE,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"saveAs",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._debouncedSaveOperations(Re.x.SAVE_AS,r,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"write",value:function(e,t){var r,n=null!==(r=this._primaryRasters[0])&&void 0!==r?r:this.raster;if(this.loaded?"RasterTileServer"===n.datasetFormat&&("Raster"===n.tileType||"Map"===n.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return(0,c.Z)((0,f.Z)(d.prototype),"write",this).call(this,e,t);if(null!==t&&void 0!==t&&t.messages){var i="".concat(t.origin,"/").concat(t.layerContainerType||"operational-layers");t.messages.push(new y.Z("layer:unsupported","Layers (".concat(this.title,", ").concat(this.id,") of type '").concat(this.declaredClass,"' are not supported in the context of '").concat(i,"'"),{layer:this}))}return null}},{key:"_openRaster",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,s,o,l,u,c,f=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=!1,!this.raster){e.next=7;break}return e.next=4,this._openFromRaster(this.raster,t);case 4:n="Function"===this.raster.datasetFormat,e.next=22;break;case 7:if(s=this.url,o=this.rasterFunction,l=this.source,s||l){e.next=10;break}throw new y.Z("imagery-tile-layer:open","missing url or source parameter");case 10:if(!l){e.next=15;break}return e.next=13,this._openFromSource(l,t);case 13:e.next=22;break;case 15:if(!o){e.next=20;break}return e.next=18,this._openFromUrlWithRasterFunction(s,o,t);case 18:e.next=22;break;case 20:return e.next=22,this._openFromUrl(s,t);case 22:if(u=this.raster.rasterInfo){e.next=25;break}throw new y.Z("imagery-tile-layer:load","cannot load resources on "+this.url);case 25:this._set("serviceRasterInfo",n?u:this._primaryRasters[0].rasterInfo),this._set("spatialReference",u.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON?(c="Map"===this.raster.tileType&&null!=this.sourceJSON.minLOD&&null!=this.sourceJSON.maxLOD?this.sourceJSON:(0,i.Z)((0,i.Z)({},this.sourceJSON),{},{minScale:0,maxScale:0}),this.read(c,{origin:"service"})):this.read({tileInfo:null===(r=this.serviceRasterInfo)||void 0===r?void 0:r.storageInfo.tileInfo.toJSON()},{origin:"service"}),this.title||(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles((0,k.watch)((function(){return f.customParameters}),(function(e){f.raster&&(f.raster.ioConfig.customFetchParameters=e)})));case 27:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_openFromRaster",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.rasterInfo,e.t0){e.next=4;break}return e.next=4,t.open({signal:r});case 4:this._primaryRasters="Function"===t.datasetFormat?t.primaryRasters.rasters:[t],this.url||(this.url=this._primaryRasters[0].url);case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_openFromUrlWithRasterFunction",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var s,o,l,u=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=[t],r&&(0,le.G8)(r.toJSON(),s),e.next=4,Promise.all(s.map((function(e){return Ie.Z.open({url:e,sourceJSON:u.sourceJSON,ioConfig:(0,i.Z)((0,i.Z)({sampling:"closest"},u.ioConfig),{},{customFetchParameters:u.customParameters}),signal:n})})));case 4:if(o=e.sent,l=o.findIndex((function(e){return null==e})),!(l>-1)){e.next=8;break}throw new y.Z("imagery-tile-layer:open","cannot open raster: ".concat(s[l]));case 8:return e.abrupt("return",(this._primaryRasters=o,this._initializeWithFunctionRaster(r)));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_openFromUrl",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ie.Z.open({url:t,sourceJSON:this.sourceJSON,ioConfig:(0,i.Z)((0,i.Z)({sampling:"closest"},this.ioConfig),{},{customFetchParameters:this.customParameters}),signal:r});case 2:if(null!=(n=e.sent)){e.next=5;break}throw new y.Z("imagery-tile-layer:open","cannot open raster: ".concat(t));case 5:this._primaryRasters=[n],this.raster=n;case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_openFromSource",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,o,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s="the tiled imagery data source is not supported",o="coverage"===(null===(n=t.type)||void 0===n?void 0:n.toLowerCase())?"CovJSON":t.extent&&t.pixelBlock?"MEMORY":null){e.next=3;break}throw new y.Z("imagery-tile-layer:open",s);case 3:return"MEMORY"===o&&(t={extent:t.extent,pixelBlocks:[t.pixelBlock]}),e.next=6,Ie.Z.open({url:"",source:t,datasetFormat:o,ioConfig:(0,i.Z)((0,i.Z)({sampling:"closest"},this.ioConfig),{},{customFetchParameters:this.customParameters}),signal:r});case 6:if(null!=(l=e.sent)){e.next=9;break}throw new y.Z("imagery-tile-layer:open",s);case 9:if(this._primaryRasters=[l],!this.rasterFunction){e.next=15;break}return e.next=13,this._initializeWithFunctionRaster(this.rasterFunction);case 13:e.next=16;break;case 15:this.raster=l;case 16:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_openFunctionRaster",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,i,s,o,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s={raster:this._primaryRasters[0]},this._primaryRasters.length>1&&this._primaryRasters.forEach((function(e){return s[e.url]=e})),o=(0,le.Ue)(null!==(n=null===(i=t.functionDefinition)||void 0===i?void 0:i.toJSON())&&void 0!==n?n:t.toJSON(),s),l=new ae({rasterFunction:o}),e.next=5,l.open(r);case 5:return e.abrupt("return",l);case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_initializeWithFunctionRaster",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._openFunctionRaster(t,r);case 3:this.raster=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),e.t0 instanceof y.Z&&x.Z.getLogger(this).error("imagery-tile-layer:open",e.t0.message),x.Z.getLogger(this).warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),this._set("rasterFunction",null),this.raster=this._primaryRasters[0];case 9:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t,r){return e.apply(this,arguments)}}()}]),d}((0,T.h7)((0,be.M)((0,ye.q)((0,xe.I)((0,C.N)(function(e){var t=function(e){(0,h.Z)(n,e);var t=(0,p.Z)(n);function n(){var e,r,i;(0,o.Z)(this,n);for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];return(i=t.call.apply(t,[this].concat(s)))._isConstructedFromFunctionRaster=!1,i._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},i.bandIds=null,i.copyright=null,i.interpolation="nearest",i.multidimensionalSubset=null,i.raster=null,i.serviceRasterInfo=null,i.sourceJSON=null,i.spatialReference=null,i.symbolizer=null,i._isConstructedFromFunctionRaster="Function"===(null===(e=s[0])||void 0===e||null===(r=e.raster)||void 0===r?void 0:r.datasetFormat),i}return(0,l.Z)(n,[{key:"fullExtent",get:function(){var e;return null===(e=this.serviceRasterInfo)||void 0===e?void 0:e.extent}},{key:"multidimensionalDefinition",set:function(e){this._set("multidimensionalDefinition",e),this.updateRenderer()}},{key:"rasterFunction",set:function(e){var t,r;"none"===(null===(t=e)||void 0===t||null===(r=t.functionName)||void 0===r?void 0:r.toLowerCase())&&(e=void 0),this._set("rasterFunction",e),this.updateRasterFunction()}},{key:"rasterInfo",get:function(){return(0,P.Mr)(x.Z.getLogger(this),"rasterInfo",{replacement:"serviceRasterInfo",version:"4.29",warnOnce:!0}),this._get("serviceRasterInfo")}},{key:"url",set:function(e){this._set("url",(0,N.Nm)(e,x.Z.getLogger(this)))}},{key:"renderer",set:function(e){null==e&&null==this.rasterFunction?this._configDefaultRenderer("override"):(this._set("renderer",e),this.updateRenderer())}},{key:"readRenderer",value:function(e,t,r){var n,i,a=null===t||void 0===t||null===(n=t.layerDefinition)||void 0===n||null===(i=n.drawingInfo)||void 0===i?void 0:i.renderer;return(0,F.ij)(a,r)||void 0}},{key:"convertVectorFieldData",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,i,s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.serviceRasterInfo,null!=t&&n){e.next=3;break}return e.abrupt("return",null);case 3:return i=this._rasterJobHandler.instance,s=n.dataType,e.abrupt("return",i?i.convertVectorFieldData({pixelBlock:t,dataType:s},r):(0,ce.KC)(t,s));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"computeStatisticsHistograms",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,o,l,u,c,f,h,p,d,m,v,x;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.load(r);case 2:if(t=(0,Z.TJ)(pe.Z,t).clone(),null!=(s=this.serviceRasterInfo)){e.next=6;break}throw new y.Z("imagery-tile-mixin:compute-statistics-histograms","serviceRasterInfo must be specified");case 6:if(null!=(o=t.geometry)){e.next=9;break}throw new y.Z("imagery-tile-mixin:compute-statistics-histograms","geometry must be specified");case 9:if(l=o,u=s.spatialReference,e.t0=o.spatialReference.equals(u),e.t0){e.next=16;break}return e.next=15,(0,re.zD)();case 15:l="extent"===o.type?(0,re.tB)(o,u):(0,re.Wt)(o,u);case 16:return c=null!==(n=t.pixelSize)&&void 0!==n?n:new ve.Z({x:s.pixelSize.x,y:s.pixelSize.y,spatialReference:u}),f=ee(s,l,c),h=f.extent,p=f.width,d=f.height,e.next=23,this.fetchPixels(h,p,d,(0,i.Z)((0,i.Z)({},r),{},{interpolation:"nearest"}));case 23:if(null!=(m=e.sent).pixelBlock){e.next=26;break}throw new y.Z("imagery-tile-mixin:compute-statistics-histograms","failed to fetch pixels");case 26:return e.next=28,Y(m.pixelBlock,h,l);case 28:return v=e.sent,x=this._rasterJobHandler.instance,e.abrupt("return",x?x.computeStatisticsHistograms({pixelBlock:v},r):(0,ue.js)(v));case 31:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"createFlowMesh",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._rasterJobHandler.instance,e.abrupt("return",n?n.createFlowMesh(t,r):(0,de.GE)(t.meshType,t.simulationSettings,t.flowData,null!=r.signal?r.signal:(new AbortController).signal));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"normalizeRasterFetchOptions",value:function(e){var t,r,n=(null!==(t=this.serviceRasterInfo)&&void 0!==t?t:{}).multidimensionalInfo;if(null==n)return e;var a=e.multidimensionalDefinition||this.multidimensionalDefinition;(null===(r=a)||void 0===r?void 0:r.length)||(a=(0,oe.Tj)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset}));var s=e.timeExtent||this.timeExtent;if(null!=a&&null!=s&&(null!=s.start||null!=s.end)){var o,l;a=a.map((function(e){return e.clone()}));var u=null===(o=n.variables.find((function(e){return e.name===a[0].variableName})))||void 0===o||null===(l=o.dimensions)||void 0===l?void 0:l.find((function(e){return"StdTime"===e.name})),c=a.find((function(e){return"StdTime"===e.dimensionName}));if(!u||!c)return(0,i.Z)((0,i.Z)({},e),{},{multidimensionalDefinition:null});var f=s.start,h=s.end,p=null==f?null:f.getTime(),d=null==h?null:h.getTime(),m=null!==p&&void 0!==p?p:d,v=null!==d&&void 0!==d?d:p;if(null!=u.values){var y=u.values.filter((function(e){if(Array.isArray(e)){if(m===v)return e[0]<=m&&e[1]>=m;var t=e[0]<=m&&e[1]>m||e[0]<v&&e[1]>=v,r=e[0]>=m&&e[1]<=v||e[0]<m&&e[1]>v;return t||r}return m===v?e===m:e>=m&&e<=v}));if(y.length){var x=y.sort((function(e,t){var r=Array.isArray(e)?e[0]:e,n=Array.isArray(e)?e[1]:e,i=Array.isArray(t)?t[0]:t,a=Array.isArray(t)?t[1]:t;return m===v?r-i:Math.abs(n-v)-Math.abs(a-v)}))[0];c.values=[x]}else a=null}else if(u.hasRegularIntervals&&u.extent){var g=(0,M.Z)(u.extent,2),b=g[0],k=g[1];m>k||v<b?a=null:c.values=m===v?[m]:[Math.max(b,m),Math.min(k,v)]}}return null!=a&&(0,oe.nb)(a,this.multidimensionalSubset)?(0,i.Z)((0,i.Z)({},e),{},{multidimensionalDefinition:null}):(0,i.Z)((0,i.Z)({},e),{},{multidimensionalDefinition:a})}},{key:"updateRasterFunction",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t,r,n,i,s,o,l,u,c,f,h,p,d,m,v;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.loaded&&"imagery-tile"===this.type&&(this.rasterFunction||this._cachedRasterFunctionJson)&&JSON.stringify(this.rasterFunction)!==JSON.stringify(this._cachedRasterFunctionJson)){e.next=2;break}return e.abrupt("return");case 2:if(!this._isConstructedFromFunctionRaster||"Function"!==this.raster.datasetFormat){e.next=5;break}return r=this.raster.rasterFunction.toJSON(),e.abrupt("return",(!this.rasterFunction&&r&&this._set("rasterFunction",z.Z.fromJSON(r)),void(this._cachedRasterFunctionJson=null===(t=this.rasterFunction)||void 0===t?void 0:t.toJSON())));case 5:if(i=this.raster,s=!1,"Function"===i.datasetFormat?(n=i.primaryRasters.rasters,i=n[0],s=!0):n=[i],!(o=this.rasterFunction)){e.next=19;break}return f={raster:i},n.length>1&&n.forEach((function(e){return f[e.url]=e})),h=(0,le.Ue)(null!==(l=null===(u=o.functionDefinition)||void 0===u?void 0:u.toJSON())&&void 0!==l?l:o.toJSON(),f),(p=new ae({rasterFunction:h})).rasterJobHandler=this._rasterJobHandler.instance,e.next=15,p.open();case 15:this._cachedRasterFunctionJson=null===(c=this.rasterFunction)||void 0===c?void 0:c.toJSON(),this.raster=p,e.next=23;break;case 19:return this.raster=i,this._cachedRasterFunctionJson=null,e.next=23,i.when();case 23:if(this._cachedRendererJson=null,s||o){e.next=25;break}return e.abrupt("return");case 25:d=this.bandIds,m=this.raster.rasterInfo.bandCount,v=null!==d&&void 0!==d&&d.length?d.some((function(e){return e>=m})):m>=3,d&&(v||this.renderer&&"raster-stretch"!==this.renderer.type)&&this._set("bandIds",null),this._configDefaultRenderer("auto");case 27:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateRenderer",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t,r,n,s,o,l,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.loaded,r=this.symbolizer,t&&r&&this.renderer){e.next=3;break}return e.abrupt("return");case 3:if(n=this.raster.rasterInfo,s=(0,oe.N3)(n,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),o=null===s||void 0===s?void 0:s.name,l=(0,fe.ol)((0,i.Z)((0,i.Z)({},this.renderer.toJSON()),{},{variableName:o})),JSON.stringify(this._cachedRendererJson)!==JSON.stringify(l)){e.next=6;break}return e.abrupt("return");case 6:if(u=this._rasterJobHandler.instance,e.t0=u,!e.t0){e.next=15;break}return r.rasterInfo=(0,fe.FI)(n,o),r.rendererJSON=l,r.bind(),e.next=14,u.updateSymbolizer(r);case 14:this._cachedRendererJson=l;case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"applyRenderer",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,o,l,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(s=null===t||void 0===t?void 0:t.pixelBlock)&&s.pixels&&s.pixels.length>0){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this.updateRenderer();case 5:if(l=this._rasterJobHandler.instance,u=null!==(n=this.bandIds)&&void 0!==n?n:[],!l){e.next=12;break}return e.next=9,l.symbolize((0,i.Z)((0,i.Z)({},t),{},{simpleStretchParams:r,bandIds:u}));case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=this.symbolizer.symbolize((0,i.Z)((0,i.Z)({},t),{},{simpleStretchParams:r,bandIds:u}));case 13:return o=e.t0,e.abrupt("return",o);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getTileUrl",value:function(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?"".concat(this.url,"/tile/").concat(e,"/").concat(t,"/").concat(r):""}},{key:"getCompatibleTileInfo",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.loaded||null==t)return null;if(r&&e.equals(this.spatialReference))return this.tileInfo;var n=(0,B.C5)(e);return H.Z.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}},{key:"getCompatibleFullExtent",value:function(e){var t;return this.loaded?(null!==(t=this._compatibleFullExtent)&&void 0!==t&&t.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}},{key:"fetchTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,n,s){var o,l,u,c,f,h=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(l=h.length>3&&void 0!==h[3]?h[3]:{},r(this),!l.requestAsImageElement){e.next=4;break}return u=this.getTileUrl(t,n,s),e.abrupt("return",(0,O.Z)(u,{responseType:"image",query:(0,i.Z)((0,i.Z)({},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:l.signal}).then((function(e){return e.data})));case 4:if(null==(c=this.serviceRasterInfo).multidimensionalInfo||null!=(l=this.normalizeRasterFetchOptions(l)).multidimensionalDefinition){e.next=8;break}return f=l.tileInfo||c.storageInfo.tileInfo,e.abrupt("return",{extent:this.raster.getTileExtentFromTileInfo(t,n,s,f),pixelBlock:null});case 8:return e.next=10,this._initJobHandler();case 10:return e.next=12,this.updateRasterFunction();case 12:return"raster-shaded-relief"===(null===(o=this.renderer)||void 0===o?void 0:o.type)&&(l=(0,i.Z)((0,i.Z)({},l),{},{buffer:{cols:1,rows:1}})),e.abrupt("return",this.raster.fetchTile(t,n,s,l));case 14:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=s.length>3&&void 0!==s[3]?s[3]:{},null==this.serviceRasterInfo.multidimensionalInfo||null!=(i=this.normalizeRasterFetchOptions(i)).multidimensionalDefinition){e.next=5;break}e.t0={extent:t,pixelBlock:null},e.next=12;break;case 5:return e.next=7,this._initJobHandler();case 7:return e.next=9,this.updateRasterFunction();case 9:r=Math.round(r),n=Math.round(n),e.t0=this.raster.fetchPixels(t,r,n,i);case 12:return e.abrupt("return",e.t0);case 13:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=l.length>1&&void 0!==l[1]?l[1]:{},e.next=3,this.load();case 3:if(i=this.raster,null==(null===(s=this.serviceRasterInfo)||void 0===s?void 0:s.multidimensionalInfo)){e.next=7;break}if(s.hasMultidimensionalTranspose&&((0,oe.WU)(n.multidimensionalDefinition)||n.transposedVariableName||n.timeExtent)||null!=(n=this.normalizeRasterFetchOptions(n)).multidimensionalDefinition){e.next=7;break}return e.abrupt("return",{location:t,value:null});case 7:if(!(o=null===(r=this.multidimensionalSubset)||void 0===r?void 0:r.areaOfInterest)||o.contains(t)){e.next=10;break}throw new y.Z("imagery-tile-mixin:identify","the request cannot be fulfilled when falling outside of the multidimensional subset");case 10:return e.abrupt("return",i.identify(t,n));case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"increaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount++}},{key:"decreaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}},{key:"hasStandardTime",value:function(){var e,t,r,n=null===(e=this.serviceRasterInfo)||void 0===e?void 0:e.multidimensionalInfo;if(null==n||"standard-time"!==(null===(t=this.serviceRasterInfo)||void 0===t?void 0:t.dataType))return!1;var i=this.multidimensionalDefinition,a=null===i||void 0===i||null===(r=i[0])||void 0===r?void 0:r.variableName;return n.variables.some((function(e){return e.name===a&&(!(null!==i&&void 0!==i&&i[0].dimensionName)||e.dimensions.some((function(e){return"StdTime"===e.name})))}))}},{key:"getStandardTimeValue",value:function(e){return new Date(24*(e-25569)*3600*1e3).toString()}},{key:"getMultidimensionalSubsetVariables",value:function(e){var t,r=null!==e&&void 0!==e?e:null===(t=this.serviceRasterInfo)||void 0===t?void 0:t.multidimensionalInfo;return(0,oe.jj)(this.multidimensionalSubset,r)}},{key:"_configDefaultSettings",value:function(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=(0,oe.Tj)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this.rasterFunction&&"Function"===this.raster.datasetFormat&&(this._cachedRasterFunctionJson=this.rasterFunction.toJSON()),this._configDefaultRenderer()}},{key:"_initJobHandler",value:function(){var e=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var t=new L.Z;return this._rasterJobHandler.connectionPromise=t.initialize().then((0,s.Z)((0,a.Z)().mark((function n(){return(0,a.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r(e),e._rasterJobHandler.instance=t,e.raster.rasterJobHandler=t,"Function"===e.raster.datasetFormat&&e.raster.syncJobHandler(),n.t0=e.rasterFunction,!n.t0){n.next=8;break}return n.next=8,e.updateRasterFunction().catch((function(){}));case 8:e.renderer&&e.updateRenderer();case 9:case"end":return n.stop()}}),n)})))).catch((function(){})),this._rasterJobHandler.connectionPromise}},{key:"_shutdownJobHandler",value:function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this._cachedRendererJson=null,this.raster&&(this.raster.rasterJobHandler=null)}},{key:"_configDefaultInterpolation",value:function(){if(null==this.interpolation){var e;r(this);var t=this.raster,n=(0,fe.In)(t.rasterInfo,t.tileType,null===(e=this.sourceJSON)||void 0===e?void 0:e.defaultResamplingMethod);this._set("interpolation",n)}}},{key:"_configDefaultRenderer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"no";r(this);var t=this.raster.rasterInfo;!this.bandIds&&t.bandCount>1&&(this.bandIds=(0,fe.YD)(t));var n=(0,oe.N3)(t,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),a=null===n||void 0===n?void 0:n.name,s=(0,fe.Ko)(this.raster);if(!this.renderer||"override"===e){var o,l,u=(0,fe.Ob)(t,{bandIds:this.bandIds,variableName:a,rasterFunctionColorRamp:s}),c=t.statistics,f=c&&c.length>0?c[0]:null,h=null!==(o=null===f||void 0===f?void 0:f.max)&&void 0!==o?o:0,p=null!==(l=null===f||void 0===f?void 0:f.min)&&void 0!==l?l:0;"WCSServer"===this.raster.datasetFormat&&"raster-stretch"===u.type&&(h>1e24||p<-1e24)&&(u.dynamicRangeAdjustment=!0,u.statistics=null,"none"===u.stretchType&&(u.stretchType="min-max")),this.renderer=u}var d=(0,fe.ol)((0,i.Z)((0,i.Z)({},this.renderer.toJSON()),{},{variableName:a})),m=(0,fe.FI)(t,a);this.symbolizer?(this.symbolizer.rendererJSON=d,this.symbolizer.rasterInfo=m):this.symbolizer=new he.Z({rendererJSON:d,rasterInfo:m});var v=this.symbolizer.bind();if(v.success){if("auto"===e){var y=this.raster.rasterInfo.colormap,g=this.renderer;if(null!=y&&"raster-colormap"===g.type){var b=(0,fe.Ob)(this.raster.rasterInfo);JSON.stringify(b)!==JSON.stringify(g)&&this._configDefaultRenderer("override")}else if("raster-stretch"===g.type){var k,w,Z=null===(k=this.bandIds)||void 0===k?void 0:k.length,I=null===(w=g.statistics)||void 0===w?void 0:w.length;!g.dynamicRangeAdjustment&&I&&Z&&I!==Z&&this._configDefaultRenderer("override")}}}else x.Z.getLogger(this).warn("imagery-tile-mixin",v.error||"The given renderer is not supported by the layer."),"auto"===e&&this._configDefaultRenderer("override")}}]),n}(e);function r(e){if(!e.raster||!e.serviceRasterInfo)throw new y.Z("imagery-tile","no raster")}return(0,d._)([(0,w.Cb)({clonable:!1})],t.prototype,"_cachedRendererJson",void 0),(0,d._)([(0,w.Cb)({clonable:!1})],t.prototype,"_cachedRasterFunctionJson",void 0),(0,d._)([(0,w.Cb)({clonable:!1})],t.prototype,"_compatibleFullExtent",void 0),(0,d._)([(0,w.Cb)({clonable:!1})],t.prototype,"_isConstructedFromFunctionRaster",void 0),(0,d._)([(0,w.Cb)({clonable:!1})],t.prototype,"_rasterJobHandler",void 0),(0,d._)([(0,w.Cb)()],t.prototype,"bandIds",void 0),(0,d._)([(0,w.Cb)({json:{origins:{service:{read:{source:"copyrightText"}}}}})],t.prototype,"copyright",void 0),(0,d._)([(0,w.Cb)({json:{read:!1}})],t.prototype,"fullExtent",null),(0,d._)([(0,w.Cb)()],t.prototype,"interpolation",void 0),(0,d._)([(0,w.Cb)()],t.prototype,"ioConfig",void 0),(0,d._)([(0,w.Cb)({type:[A.Z],json:{write:!0}})],t.prototype,"multidimensionalDefinition",null),(0,d._)([(0,w.Cb)({type:E.Z,json:{write:!0}})],t.prototype,"multidimensionalSubset",void 0),(0,d._)([(0,w.Cb)()],t.prototype,"raster",void 0),(0,d._)([(0,w.Cb)({type:z.Z,json:{name:"renderingRule",write:!0}})],t.prototype,"rasterFunction",null),(0,d._)([(0,w.Cb)({readOnly:!0})],t.prototype,"rasterInfo",null),(0,d._)([(0,w.Cb)()],t.prototype,"serviceRasterInfo",void 0),(0,d._)([(0,w.Cb)()],t.prototype,"sourceJSON",void 0),(0,d._)([(0,w.Cb)({readOnly:!0,type:me.Z,json:{read:!1}})],t.prototype,"spatialReference",void 0),(0,d._)([(0,w.Cb)({type:H.Z})],t.prototype,"tileInfo",void 0),(0,d._)([(0,w.Cb)(J.HQ)],t.prototype,"url",null),(0,d._)([(0,w.Cb)({types:F.dr,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(){var e,t="raster-stretch"===(null===(e=this.renderer)||void 0===e?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:F.FK,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(e){return{enabled:e&&"vector-field"!==e.type&&"flow"!==e.type}}}}}}})],t.prototype,"renderer",null),(0,d._)([(0,D.r)("renderer")],t.prototype,"readRenderer",null),(0,d._)([(0,w.Cb)({clonable:!1})],t.prototype,"symbolizer",void 0),t=(0,d._)([(0,_.j)("esri.layers.mixins.ImageryTileMixin")],t)}((0,ke.n)((0,S.Y)((0,ge.Q)((0,g.R)((0,v.J)(R.Z))))))))))));(0,d._)([(0,w.Cb)({clonable:!1})],Se.prototype,"_primaryRasters",void 0),(0,d._)([(0,w.Cb)({type:[Z.z8],json:{write:{overridePolicy:function(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null===(e=this.bandIds)||void 0===e?void 0:e.join(","))}}}}})],Se.prototype,"bandIds",void 0),(0,d._)([(0,w.Cb)({json:{write:{overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),(0,I.J)(Ze.cl)],Se.prototype,"interpolation",void 0),(0,d._)([(0,w.Cb)(J.rn)],Se.prototype,"legendEnabled",void 0),(0,d._)([(0,w.Cb)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],Se.prototype,"isReference",void 0),(0,d._)([(0,w.Cb)({type:["show","hide"]})],Se.prototype,"listMode",void 0),(0,d._)([(0,w.Cb)({json:{read:!0,write:!0}})],Se.prototype,"blendMode",void 0),(0,d._)([(0,w.Cb)()],Se.prototype,"sourceJSON",void 0),(0,d._)([(0,w.Cb)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],Se.prototype,"version",void 0),(0,d._)([(0,w.Cb)({readOnly:!0,json:{read:!1}})],Se.prototype,"type",void 0),(0,d._)([(0,w.Cb)({type:["ArcGISTiledImageServiceLayer"]})],Se.prototype,"operationalLayerType",void 0),(0,d._)([(0,w.Cb)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:function(e,t){return!t.disablePopup}},write:{target:"disablePopup",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer:function(e,t,r){t[r]=!e}}}})],Se.prototype,"popupEnabled",void 0),(0,d._)([(0,w.Cb)({type:m.Z,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],Se.prototype,"popupTemplate",void 0),(0,d._)([(0,w.Cb)({readOnly:!0})],Se.prototype,"defaultPopupTemplate",null),(0,d._)([(0,w.Cb)({readOnly:!0,type:[we.Z]})],Se.prototype,"fields",void 0),(0,d._)([(0,w.Cb)({readOnly:!0,type:[we.Z]})],Se.prototype,"rasterFields",null),(0,d._)([(0,w.Cb)({constructOnly:!0})],Se.prototype,"source",void 0);var Te=Se=(0,d._)([(0,_.j)("esri.layers.ImageryTileLayer")],Se)},34810:function(e,t,r){r.d(t,{y:function(){return M}});var n=r(74165),i=r(1413),a=r(15861),s=r(15671),o=r(43144),l=r(60136),u=r(29388),c=r(27366),f=r(76200),h=r(7138),p=r(70116),d=r(10064),m=r(42537),v=(r(93169),r(16054)),y=r(27546),x=r(66978),g=r(94172),b=r(99346),k=r(35995),w=r(49861),Z=(r(32718),r(84936),r(69912)),I=r(87960),_=r(84652),R=r(18722);var S,T=function(){function e(t){(0,s.Z)(this,e),function(e){if(null===e||void 0===e||!e.location)throw new d.Z("tilemap:missing-location","Location missing from tilemap response");if(!1===e.valid)throw new d.Z("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new d.Z("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new d.Z("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new d.Z("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}(t);var r=t.location,n=t.data;this.location=Object.freeze((0,_.d9)(r));for(var i=this.location.width,a=this.location.height,o=!0,l=!0,u=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e<=R.c8?t?new Array(e).fill(0):new Array(e):new Uint32Array(e)}(Math.ceil(i*a/32)),c=0,f=0;f<n.length;f++){var h=f%32;n[f]?(l=!1,u[c]|=1<<h):o=!1,31===h&&++c}l?(this._availability="unavailable",this.byteSize=40):o?(this._availability="available",this.byteSize=40):(this._availability=u,this.byteSize=40+(0,R.Xw)(u))}return(0,o.Z)(e,[{key:"getAvailability",value:function(e,t){if("unavailable"===this._availability||"available"===this._availability)return this._availability;var r=(e-this.location.top)*this.location.width+(t-this.location.left),n=r%32,i=r>>5,a=this._availability;return i<0||i>a.length?"unknown":a[i]&1<<n?"available":"unavailable"}}],[{key:"fromDefinition",value:function(t,r){var n=t.service.request||f.Z,a=t.row,s=t.col,o=t.width,l=t.height,u={query:{f:"json"}};return r=r?(0,i.Z)((0,i.Z)({},u),r):u,n(function(e){var t,r;if(null!==(t=e.service.tileServers)&&void 0!==t&&t.length){var n=e.service.tileServers;r="".concat(n&&n.length?n[e.row%n.length]:e.service.url,"/tilemap/").concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height)}else r="".concat(e.service.url,"/tilemap/").concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height);var i=e.service.query;return i&&(r="".concat(r,"?").concat(i)),r}(t),r).then((function(e){return e.data})).catch((function(e){var t;if(422===(null===e||void 0===e||null===(t=e.details)||void 0===t?void 0:t.httpStatus))return{location:{top:a,left:s,width:o,height:l},valid:!0,data:new Array(o*l).fill(0)};throw e})).then((function(t){if(t.location&&(t.location.top!==a||t.location.left!==s||t.location.width!==o||t.location.height!==l))throw new d.Z("tilemap:location-mismatch","Tilemap response for different location than requested",{response:t,definition:{top:a,left:s,width:o,height:l}});return e.fromJSON(t)}))}},{key:"fromJSON",value:function(t){return Object.freeze(new e(t))}}]),e}();function C(e){return"".concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height)}var M=S=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(e){var n;return(0,s.Z)(this,r),(n=t.call(this,e))._pendingTilemapRequests={},n.request=f.Z,n.size=32,n._prefetchingEnabled=!0,n}return(0,o.Z)(r,[{key:"initialize",value:function(){var e=this;this._tilemapCache=new v.z(2*p.Y.MEGABYTES),this.addHandles((0,g.watch)((function(){var t=e.layer;return[null===t||void 0===t?void 0:t.parsedUrl,null===t||void 0===t?void 0:t.tileServers,null===t||void 0===t?void 0:t.apiKey,null===t||void 0===t?void 0:t.customParameters]}),(function(){return e._initializeTilemapDefinition()}),g.initial))}},{key:"effectiveMinLOD",get:function(){var e;return null!==(e=this.minLOD)&&void 0!==e?e:this.layer.tileInfo.lods[0].level}},{key:"effectiveMaxLOD",get:function(){var e;return null!==(e=this.maxLOD)&&void 0!==e?e:this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}},{key:"getAvailability",value:function(e,t,r){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return"unavailable";var n=this._tilemapFromCache(e,t,r,this._tmpTilemapDefinition);return n?n.getAvailability(t,r):"unknown"}},{key:"fetchAvailability",value:function(e,t,r,n){return!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(new d.Z("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:r})):this._fetchTilemap(e,t,r,n).catch((function(e){return e})).then((function(n){if(n instanceof T){var i=n.getAvailability(t,r);if("unavailable"===i)throw new d.Z("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:r});return i}if((0,x.D_)(n))throw n;return"unknown"}))}},{key:"fetchAvailabilityUpsample",value:function(e,t,r,n,i){var a=this;n.level=e,n.row=t,n.col=r;var s=this.layer.tileInfo;s.updateTileInfo(n);var o=this.fetchAvailability(e,t,r,i).catch((function(e){if((0,x.D_)(e))throw e;if(s.upsampleTile(n))return a.fetchAvailabilityUpsample(n.level,n.row,n.col,n,i);throw e}));return this._fetchAvailabilityUpsamplePrefetch(n.id,e,t,r,i,o),o}},{key:"_fetchAvailabilityUpsamplePrefetch",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r,a,s,o,l){var u,c,f,h,p,d,v,y,g,k=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._prefetchingEnabled&&null!=t){e.next=2;break}return e.abrupt("return");case 2:if(u="prefetch-".concat(t),!this.hasHandles(u)){e.next=5;break}return e.abrupt("return");case 5:return c=new AbortController,l.then((function(){return c.abort()}),(function(){return c.abort()})),f=!1,h=(0,m.kB)((function(){f||(f=!0,c.abort())})),this.addHandles(h,u),e.next=12,(0,b.MU)(10,c.signal).catch((function(){}));case 12:if(f||(f=!0,this.removeHandles(u)),!(0,x.Hc)(c)){e.next=15;break}return e.abrupt("return");case 15:for(p=new I.f(t,r,a,s),d=(0,i.Z)((0,i.Z)({},o),{},{signal:c.signal}),v=this.layer.tileInfo,y=function(e){var t=k.fetchAvailability(p.level,p.row,p.col,d);S._prefetches.push(t);var r=function(){S._prefetches.removeUnordered(t)};t.then(r,r)},g=0;S._prefetches.length<S._maxPrefetch&&v.upsampleTile(p);++g)y();case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a,s){return e.apply(this,arguments)}}()},{key:"_fetchTilemap",value:function(e,t,r,n){var a,s=this;if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return Promise.reject(new d.Z("tilemap-cache:level-unavailable","Level ".concat(e," is unavailable in the service")));var o=this._tmpTilemapDefinition,l=this._tilemapFromCache(e,t,r,o);if(l)return Promise.resolve(l);var u=null===(a=n)||void 0===a?void 0:a.signal;return n=(0,i.Z)((0,i.Z)({},n),{},{signal:null}),new Promise((function(e,t){(0,x.fu)(u,(function(){return t((0,x.zE)())}));var r=C(o),i=s._pendingTilemapRequests[r];if(!i){i=T.fromDefinition(o,n).then((function(e){return s._tilemapCache.put(r,e,e.byteSize),e}));var a=function(){delete s._pendingTilemapRequests[r]};s._pendingTilemapRequests[r]=i,i.then(a,a)}i.then(e,t)}))}},{key:"_initializeTilemapDefinition",value:function(){var e;if(this.layer.parsedUrl){var t=this.layer,r=t.parsedUrl,n=t.apiKey,a=t.customParameters;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:r.path,query:(0,k.B7)((0,i.Z)((0,i.Z)((0,i.Z)({},r.query),a),{},{token:null!==n&&void 0!==n?n:null===(e=r.query)||void 0===e?void 0:e.token})),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}}},{key:"_tilemapFromCache",value:function(e,t,r,n){n.level=e,n.row=t-t%this.size,n.col=r-r%this.size;var i=C(n);return this._tilemapCache.get(i)}},{key:"test",get:function(){}}]),r}(h.default);M._maxPrefetch=4,M._prefetches=new y.Z({initialSize:S._maxPrefetch}),(0,c._)([(0,w.Cb)({constructOnly:!0})],M.prototype,"layer",void 0),(0,c._)([(0,w.Cb)({constructOnly:!0})],M.prototype,"minLOD",void 0),(0,c._)([(0,w.Cb)({constructOnly:!0})],M.prototype,"maxLOD",void 0),(0,c._)([(0,w.Cb)({constructOnly:!0})],M.prototype,"request",void 0),(0,c._)([(0,w.Cb)({constructOnly:!0})],M.prototype,"size",void 0),M=S=(0,c._)([(0,Z.j)("esri.layers.support.TilemapCache")],M)},59226:function(e,t,r){r.d(t,{Z:function(){return H}});var n=r(29439),i=r(93433),a=r(74165),s=r(15861),o=r(1413),l=r(15671),u=r(43144),c=r(60136),f=r(29388),h=r(27366),p=(r(59486),r(76200)),d=r(10064),m=r(46784),v=r(32718),y=r(67426),x=r(66978),g=r(49861),b=r(25243),k=(r(84936),r(93169),r(69912)),w=r(25899),Z=r(70361),I=r(86591),_=r(59068),R=r(32014),S=r(22824),T=r(21969),C=r(55635),M=r(92089),F=r(45502),O=r(17314),P=r(80394),D=r(64145),B=r(38164),N=r(53866),J=r(848),A=r(78952),E=0,z=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,l.Z)(this,r),(e=t.apply(this,arguments))._tileFetchQueue=new B.e({concurrency:32,process:function(t,r){return e._fetchRawTile(t.pyramidLevel,t.row,t.col,(0,o.Z)((0,o.Z)({},t.options),{},{signal:r}))}}),e.datasetName=null,e.datasetFormat=null,e.hasUniqueSourceStorageInfo=!0,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}return(0,u.Z)(r,[{key:"init",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,P.zD)(),this.addResolvingPromise(t),e.next=4,this.when();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"normalizeCtorArgs",value:function(e){var t;return null!==(t=e)&&void 0!==t&&t.ioConfig&&(e=(0,o.Z)((0,o.Z)({},e),{},{ioConfig:(0,o.Z)({resolution:null,bandIds:null,sampling:"closest",tileInfo:S.Z.create()},e.ioConfig)})),e}},{key:"_isGlobalWrappableSource",get:function(){var e=this.rasterInfo,t=(0,P.ut)(e.spatialReference);return null!=t&&e.extent.width>=t/2}},{key:"_hasNoneOrGCSShiftTransform",get:function(){var e=this.rasterInfo.transform;return null==e||"gcs-shift"===e.type}},{key:"rasterJobHandler",set:function(e){var t,r;this._set("rasterJobHandler",e),"Function"===this.datasetFormat&&(null===(t=this.primaryRasters)||void 0===t||null===(r=t.rasters)||void 0===r||r.forEach((function(t){return t.rasterJobHandler=e})))}},{key:"rasterId",get:function(){return this.url||"rasterId-"+E++}},{key:"url",set:function(e){this._set("url",(0,w.Nm)(e,v.Z.getLogger(this)))}},{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new d.Z("BaseRaster:open-not-implemented","open() is not implemented");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,l,u=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=u.length>3&&void 0!==u[3]?u[3]:{},s=i.tileInfo||this.rasterInfo.storageInfo.tileInfo,l=this.getTileExtentFromTileInfo(t,r,n,s),e.abrupt("return",(i=(0,o.Z)({noClip:!0},i),this.fetchPixels(l,s.size[0],s.size[1],i)));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,l,u,c,f,h,p,d,m,v,y,x,g,k,w,Z,I,_,R,S,M,F,O,D,B,A,E,z,L,H,W,q,G,j,U,V,Y,X,Q,K,$,ee,te=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=te.length>1&&void 0!==te[1]?te[1]:{},t=(0,b.TJ)(J.Z,t).clone().normalize(),l=(s=i).multidimensionalDefinition,u=s.timeExtent,c=this.rasterInfo,f=c.hasMultidimensionalTranspose,h=c.multidimensionalInfo,p=i.transposedVariableName,(d=null!=h&&f&&(null!=u||(0,T.WU)(l)))&&!p&&(p=null!=l&&l.length>0?null!==(m=l[0].variableName)&&void 0!==m?m:void 0:h.variables[0].name,i=(0,o.Z)((0,o.Z)({},i),{},{transposedVariableName:p})),i=this._getRequestOptionsWithSliceId(i),v=c.spatialReference,y=c.extent,x=i.datumTransformation,g=(0,P.nF)(t,v,x),y.intersects(g)){e.next=11;break}return e.abrupt("return",{location:g,value:null});case 11:if(null==c.transform){e.next=16;break}if(k=c.transform.inverseTransform(g),c.nativeExtent.intersects(k)){e.next=15;break}return e.abrupt("return",{location:k,value:null});case 15:g=k;case 16:if(w=0,Z=null!=p&&null!=h&&c.hasMultidimensionalTranspose,"Function"!==this.datasetFormat){e.next=40;break}if(I=this.primaryRasters.rasters[0],!Z){e.next=22;break}return e.abrupt("return",I.identify(g,i));case 22:return _=c.pixelSize,R=3,S=_.x*R/2,M=_.y*R/2,F=new N.Z({xmin:g.x-S,xmax:g.x+S,ymin:g.y-M,ymax:g.y+M,spatialReference:v}),O={interpolation:"nearest",multidimensionalDefinition:l,sliceId:i.sliceId},e.next=30,I.fetchPixels(F,R,R,O);case 30:return D=e.sent,B=D.pixelBlock,e.next=34,this.fetchPixels(F,R,R,O);case 34:if(A=e.sent,E=A.pixelBlock,null!=B){e.next=38;break}return e.abrupt("return",{location:g,value:null});case 38:return z=Math.floor(R*R*.5),L=!B.mask||B.mask[z]?B.pixels.map((function(e){return e[z]})):null,e.abrupt("return",(null!=E&&(H=!E.mask||E.mask[z]?E.pixels.map((function(e){return e[z]})):void 0),{location:g,value:L,processedValue:H,pyramidLevel:0}));case 40:if(Z){e.next=50;break}if(!i.srcResolution){e.next=45;break}w=(0,P.kr)(i.srcResolution,c,this.ioConfig.sampling).pyramidLevel,e.next=50;break;case 45:return e.next=47,this.computeBestPyramidLevelForLocation(t,i);case 47:if(null!=(w=e.sent)){e.next=50;break}return e.abrupt("return",{location:g,value:null});case 50:if(null!==(W=this.identifyPixelLocation(g,w,null,Z))){e.next=53;break}return e.abrupt("return",{location:g,value:null});case 53:return q=W.row,G=W.col,j=W.rowOffset,U=W.colOffset,V=W.blockWidth,Y=null!==(r=p)&&void 0!==r?r:i.sliceId,X=(0,C.Rq)(this.rasterId,Y),Q="".concat(w,"/").concat(q,"/").concat(G),null==(K=(0,C.Qg)(X,null,Q))&&(K=this.fetchRawTile(w,q,G,i),(0,C.gX)(X,null,Q,K)),e.next=58,K;case 58:if(null!==($=e.sent)&&void 0!==$&&null!==(n=$.pixels)&&void 0!==n&&n.length){e.next=61;break}return e.abrupt("return",{location:g,value:null});case 61:return ee=j*V+U,e.abrupt("return",this._processIdentifyResult($,{srcLocation:g,position:ee,pyramidLevel:w,useTransposedTile:!!Z,requestSomeSlices:d,identifyOptions:i}));case 63:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k,w,Z,I=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=I.length>3&&void 0!==I[3]?I[3]:{},t=(0,P.Fi)(t),i=this._getRequestOptionsWithSliceId(i),s=this._hasNoneOrGCSShiftTransform,!i.requestRawData||!s){e.next=5;break}return e.abrupt("return",this._fetchPixels(t,r,n,i));case 5:if(o=(0,P.ut)(t.spatialReference),l=(0,P.Hq)(t),!(null==o||0===l||1===l&&this._isGlobalWrappableSource&&s)){e.next=8;break}return e.abrupt("return",this._fetchPixels(t,r,n,i));case 8:if(!(l>=3)){e.next=10;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 10:for(u=[],f=(c=t).xmin,h=c.xmax,p=Math.round(o/(h-f)*r),d=p-Math.round((o/2-f)/(h-f)*r),m=0,v=[],y=0;y<=l;y++)x=new N.Z({xmin:0===y?f:-o/2,xmax:y===l?h-o*y:o/2,ymin:t.ymin,ymax:t.ymax,spatialReference:t.spatialReference}),m+=g=0===y?p-d:y===l?r-m:p,v.push(g),b=i.disableWrapAround&&y>0?null:this._fetchPixels(x,g,n,i),u.push(b);return e.next=16,Promise.all(u);case 16:if(k=e.sent.map((function(e){return null===e||void 0===e?void 0:e.pixelBlock})),w=null,Z={width:r,height:n},!this.rasterJobHandler){e.next=25;break}return e.next=22,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:k,srcMosaicSize:Z,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:v},i);case 22:w=e.sent.pixelBlock,e.next=26;break;case 25:w=(0,O.us)(k,Z,{blockWidths:v});case 26:return e.abrupt("return",{extent:t,srcExtent:(0,P.tB)(t,this.rasterInfo.spatialReference,i.datumTransformation),pixelBlock:w});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=k.length>3&&void 0!==k[3]?k[3]:{},r={x:Math.floor(r.x),y:Math.floor(r.y)},e.next=4,this._fetchRawTiles(t,r,n,i);case 4:if(s=e.sent,o=this.rasterInfo,l=o.nativeExtent,u=o.nativePixelSize,c=o.storageInfo,f=Math.pow(2,t),h=u.x*f,p=u.y*f,d=new N.Z({xmin:l.xmin+h*r.x,xmax:l.xmin+h*(r.x+n.width-1),ymin:l.ymax-p*(r.y+n.height-1),ymax:l.ymax-p*r.y,spatialReference:l.spatialReference}),s){e.next=15;break}return e.abrupt("return",{extent:d,srcExtent:d,pixelBlock:null});case 15:if(m=s.pixelBlocks,v=s.mosaicSize,1!==m.length||null==m[0]||m[0].width!==n.width||m[0].height!==n.height){e.next=18;break}return e.abrupt("return",{extent:d,srcExtent:d,pixelBlock:s.pixelBlocks[0]});case 18:if(y=t>0?c.pyramidBlockWidth:c.blockWidth,x=t>0?c.pyramidBlockHeight:c.blockHeight,g={x:r.x%y,y:r.y%x},!this.rasterJobHandler){e.next=25;break}return e.next=22,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:m,srcMosaicSize:v,destDimension:n,clipOffset:g,clipSize:n,coefs:null,sampleSpacing:null,interpolation:i.interpolation,alignmentInfo:null,blockWidths:null},i);case 22:b=e.sent.pixelBlock,e.next=26;break;case 25:b=(0,O.us)(m,v,{clipOffset:g,clipSize:n});case 26:return e.abrupt("return",{extent:d,srcExtent:d,pixelBlock:b});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r,n){throw new d.Z("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}},{key:"computeExtent",value:function(e){return(0,P.tB)(this.rasterInfo.extent,e)}},{key:"decodePixelBlock",value:function(e,t){return!this.rasterJobHandler||t.useCanvas?(0,F.J)(e,t):this.rasterJobHandler.decode({data:e,options:t})}},{key:"request",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,i,s,l,u,c,f,h,d=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=d.length>2&&void 0!==d[2]?d[2]:0,l=this.ioConfig.customFetchParameters,u=r.range,c=r.query,f=r.headers,s=null!==(n=null!==(i=s)&&void 0!==i?i:r.retryCount)&&void 0!==n?n:this.ioConfig.retryCount,h=u?{Range:"bytes=".concat(u.from,"-").concat(u.to)}:null,e.prev=4,e.next=7,(0,p.Z)(t,(0,o.Z)((0,o.Z)({},r),{},{query:(0,o.Z)((0,o.Z)({},c),l),headers:(0,o.Z)((0,o.Z)({},f),h)}));case 7:return e.abrupt("return",e.sent);case 10:if(e.prev=10,e.t0=e.catch(4),!(s>0)){e.next=14;break}return e.abrupt("return",(s--,this.request(t,r,s)));case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){var t=this.rasterInfo.multidimensionalInfo;return null==t||null==e||0===e.length?null:(0,T.gk)(e,t)}},{key:"getTileExtentFromTileInfo",value:function(e,t,r,n){var i=n.lodAt(e);return this.getTileExtent({x:i.resolution,y:i.resolution},t,r,n.origin,n.spatialReference,n.size)}},{key:"updateTileInfo",value:function(){var e=this.rasterInfo,t=e.storageInfo,r=e.spatialReference,n=e.extent,i=e.pixelSize,a=t.pyramidResolutions;if(!t.tileInfo){for(var s=[],o=t.maximumPyramidLevel||0,l=(i.x+i.y)/2,u=1/.0254*96*l,c=0;c<=o&&(s.unshift(new _.Z({level:o-c,resolution:l,scale:u})),c!==o);c++)if(a){var f=(a[c].x+a[c].y)/2;u*=f/l,l=f}else l*=2,u*=2;var h=new J.Z({x:n.xmin,y:n.ymax,spatialReference:r});t.tileInfo=new S.Z({origin:h,size:[t.blockWidth,t.blockHeight],spatialReference:r,lods:s}),t.isVirtualTileInfo=!0}}},{key:"createRemoteDatasetStorageInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=arguments.length>3?arguments[3]:void 0,i=e.width,a=e.height,s=e.nativeExtent,o=e.pixelSize,l=e.spatialReference,u=new J.Z({x:s.xmin,y:s.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(i,a))/Math.LN2-8)));var c=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[o],n);e.storageInfo=new R.Z({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:u,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:c})}},{key:"computeBestPyramidLevelForLocation",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",0);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"computeBlockBoundary",value:function(e,t,r,n,a){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:2;if(1===a.length&&s>0)for(var l=(a=(0,i.Z)(a))[0],u=l.x,c=l.y,f=0;f<s;f++)u*=o,c*=o,a.push({x:u,y:c});for(var h=[],p=n.x,d=n.y,m=0;m<a.length;m++){var v=a[m],y=v.x,x=v.y;h.push({minCol:Math.floor((e.xmin-p+.1*y)/t/y),maxCol:Math.floor((e.xmax-p-.1*y)/t/y),minRow:Math.floor((d-e.ymax+.1*x)/r/x),maxRow:Math.floor((d-e.ymin-.1*x)/r/x)})}return h}},{key:"getPyramidPixelSize",value:function(e){var t=this.rasterInfo.nativePixelSize,r=this.rasterInfo.storageInfo,n=r.pyramidResolutions,i=r.pyramidScalingFactor;if(0===e)return t;if(null!=n&&n.length)return n[e-1];var a=Math.pow(i,e);return{x:t.x*a,y:t.y*a}}},{key:"identifyPixelLocation",value:function(e,t,r,n){var i=this.rasterInfo,a=i.spatialReference,s=i.nativeExtent,o=i.storageInfo,l=o.maximumPyramidLevel,u=o.origin,c=o.transposeInfo,f=n&&null!=c?c.tileSize[0]:o.blockWidth,h=n&&null!=c?c.tileSize[1]:o.blockHeight,p=(0,P.nF)(e,a,r);if(!s.intersects(p))return null;if(t<0||t>l)return null;var d=this.getPyramidPixelSize(t),m=d.x,v=d.y,y=(u.y-p.y)/v/h,x=(p.x-u.x)/m/f,g=Math.min(h-1,Math.floor((y-Math.floor(y))*h)),b=Math.min(f-1,Math.floor((x-Math.floor(x))*f));return{pyramidLevel:t,row:Math.floor(y),col:Math.floor(x),rowOffset:g,colOffset:b,blockWidth:f,srcLocation:p}}},{key:"getTileExtent",value:function(e,t,r,i,a,s){var o=(0,n.Z)(s,2),l=o[0],u=o[1],c=i.x+r*l*e.x,f=c+l*e.x,h=i.y-t*u*e.y,p=h-u*e.y;return new N.Z({xmin:c,xmax:f,ymin:p,ymax:h,spatialReference:a})}},{key:"getBlockWidthHeight",value:function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}},{key:"isBlockOutside",value:function(e,t,r){var n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}},{key:"updateImageSpaceRasterInfo",value:function(e){var t=e.extent,r=e.pixelSize;if(-.5!==t.xmin||.5!==t.ymax||1!==r.x||1!==r.y||null!=e.transform){var n=e.width,i=e.height,a=A.Z.WebMercator;e.spatialReference=a,e.extent=e.nativeExtent=new N.Z({xmin:-.5,ymax:.5,xmax:n-.5,ymin:.5-i,spatialReference:a}),e.isPseudoSpatialReference=!0,e.transform=null,e.pixelSize=new J.Z({x:1,y:1,spatialReference:a});var s=e.extent,o=e.storageInfo;if(o){o.origin=new J.Z({x:s.xmin,y:s.ymax,spatialReference:a});var l=o.pyramidResolutions,u=o.tileInfo;if(l&&l.forEach((function(e){e.x/=r.x,e.y/=r.y})),u){u.origin=o.origin;var c=(e.nativePixelSize.x+e.nativePixelSize.y)/2;u.lods.forEach((function(e,t){e.resolution=c*Math.pow(2,t),e.scale=96*e.resolution/.0254}))}}}}},{key:"_fetchPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k,w,Z,I,_,R,S,T,C,M,F,B,N,A,E,z,H,W,q,G,j,U,V,Y,X,Q,K,$,ee=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=ee.length>3&&void 0!==ee[3]?ee[3]:{},!((s=(0,P.Hq)(t))>=2)){e.next=4;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 4:if(o=this._getSourceDataInfo(t,r,n,i),l=o.pyramidLevel,u=o.srcResolution,c=o.srcExtent,f=o.srcWidth,h=o.srcHeight,p=o.ul,0!==f&&0!==h){e.next=7;break}return e.abrupt("return",{extent:t,srcExtent:c,pixelBlock:null});case 7:return d=this.rasterInfo,m=d.transform,v="gcs-shift"===(null===m||void 0===m?void 0:m.type),y=null!=(0,P.ut)(t.spatialReference),!v&&y||(s=(0,P.Hq)(o.srcExtent,v)),e.next=11,this._fetchRawTiles(l,p,{width:f,height:h,wrapCount:s},i);case 11:if(x=e.sent){e.next=14;break}return e.abrupt("return",{extent:t,srcExtent:c,pixelBlock:null});case 14:if(g=d.storageInfo,b=l>0?g.pyramidBlockWidth:g.blockWidth,k=l>0?g.pyramidBlockHeight:g.blockHeight,w=d.pixelSize,Z=w.x,I=w.y,l>0&&(_=g.pyramidResolutions,R=g.pyramidScalingFactor,null!=_&&_[l-1]?(S=_[l-1],Z=S.x,I=S.y):(T=Math.pow(R,l),Z*=T,I*=T)),C=d.spatialReference,M=new J.Z({x:Z,y:I,spatialReference:C}),F=b===f&&k===h&&p.x%b==0&&p.y%k==0,B=new J.Z({x:(t.xmax-t.xmin)/r,y:(t.ymax-t.ymin)/n,spatialReference:t.spatialReference}),N=!t.spatialReference.equals(C),A=C.isGeographic?1e-9:1e-4,E=i.datumTransformation,N||!F||1!==x.pixelBlocks.length||b!==r||k!==n||!L(u,B,A)){e.next=20;break}return e.abrupt("return",{extent:t,srcExtent:c,srcTilePixelSize:M,pixelBlock:x.pixelBlocks[0]});case 20:if(z=y&&null!=(0,P.ut)(c.spatialReference)&&this._hasNoneOrGCSShiftTransform,H=i.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector"),e.t0=H&&!this.rasterJobHandler,!e.t0){e.next=25;break}return e.next=25,(0,P.zD)();case 25:if(!this.rasterJobHandler){e.next=31;break}return e.next=28,this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:t,srcBufferExtent:x.extent,pixelSize:B.toJSON(),datumTransformation:E,rasterTransform:m,hasWrapAround:s>0||z,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:H},i);case 28:e.t1=e.sent,e.next=32;break;case 31:e.t1=(0,P.Qp)({projectedExtent:t,srcBufferExtent:x.extent,pixelSize:B,datumTransformation:E,rasterTransform:m,hasWrapAround:s>0||z,isAdaptive:!1,includeGCSGrid:H});case 32:if(W=e.t1,G=!i.requestRawData,j={rows:W.spacing[0],cols:W.spacing[1]},U=this._hasNoneOrGCSShiftTransform?this._getRasterTileAlignmentInfo(l,x.extent.xmin):void 0,V=x.pixelBlocks,Y=x.mosaicSize,X=x.isPartiallyFilled,Q=null,!this.rasterJobHandler){e.next=43;break}return e.next=38,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:V,srcMosaicSize:Y,destDimension:G?{width:r,height:n}:null,coefs:G?W.coefficients:null,sampleSpacing:G?j:null,projectDirections:H,gcsGrid:H?W.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:i.interpolation,alignmentInfo:U,blockWidths:null},i);case 38:K=e.sent,q=K.pixelBlock,Q=K.localNorthDirections,e.next=45;break;case 43:$=(0,O.us)(V,Y,{alignmentInfo:U}),q=G?(0,O.Uk)($,{width:r,height:n},W.coefficients,j,i.interpolation):$,H&&W.gcsGrid&&(Q=(0,O.Qh)({width:r,height:n},W.gcsGrid),q=(0,D.xQ)(q,this.rasterInfo.dataType,Q));case 45:return e.abrupt("return",i.requestRawData||H?{extent:t,srcExtent:c,srcTilePixelSize:M,pixelBlock:q,transformGrid:W,localNorthDirections:Q,isPartiallyFilled:X}:{extent:t,srcExtent:c,srcTilePixelSize:M,pixelBlock:q});case 46:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_fetchRawTiles",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n,i){var s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k,w,Z,I,_,R,S,T,C,M,F,O,P,D,B,J,A,E,z,L,H,W=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this.rasterInfo.storageInfo,o=s.origin,l=s.blockBoundary,u=this.getBlockWidthHeight(t),c=u.blockWidth,f=u.blockHeight,h=r.x,p=r.y,d=n.width,m=n.height,v=n.wrapCount,y=this._getRasterTileAlignmentInfo(t,0),i.buffer&&(h-=i.buffer.cols,p-=i.buffer.rows,d+=2*i.buffer.cols,m+=2*i.buffer.rows),x=0,g=0,b=0,v&&null!=y&&(g=y.worldColumnCountFromOrigin,b=y.originColumnOffset,x=y.rightPadding,g*y.blockWidth-x>=h+d&&(x=0)),k=Math.floor(h/c),w=Math.floor(p/f),Z=Math.floor((h+d+x-1)/c),I=Math.floor((p+m+x-1)/f),_=l[t]){e.next=9;break}return e.abrupt("return",null);case 9:if(R=_.minRow,S=_.minCol,T=_.maxCol,C=_.maxRow,0!==v||!(I<R||Z<S||w>C||k>T)){e.next=12;break}return e.abrupt("return",null);case 12:for(M=new Array,F=!1,O=null==this.ioConfig.allowPartialFill?i.allowPartialFill:this.ioConfig.allowPartialFill,P=w;P<=I;P++)for(D=k;D<=Z;D++)B=D,!i.disableWrapAround&&v&&null!=y&&g<=D&&(B=D-g-b),P>=R&&B>=S&&C>=P&&T>=B?function(){var e=W._tileFetchQueue.push({pyramidLevel:t,row:P,col:B,options:i},{signal:i.signal});O?M.push(new Promise((function(t){e.then((function(e){return t(e)})).catch((function(){F=!0,t(null)}))}))):M.push(e)}():M.push(Promise.resolve(null));if(0!==M.length){e.next=18;break}return e.abrupt("return",null);case 18:return e.next=20,Promise.all(M);case 20:return J=e.sent,A={height:(I-w+1)*f,width:(Z-k+1)*c},E=this.rasterInfo.spatialReference,z=this.getPyramidPixelSize(t),L=z.x,H=z.y,e.abrupt("return",{extent:new N.Z({xmin:o.x+k*c*L,xmax:o.x+(Z+1)*c*L,ymin:o.y-(I+1)*f*H,ymax:o.y-w*f*H,spatialReference:E}),pixelBlocks:J,mosaicSize:A,isPartiallyFilled:F});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_fetchRawTile",value:function(e,t,r,n){var i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return Promise.resolve(null);var a=i.minRow,s=i.minCol,l=i.maxCol,u=i.maxRow;if(t<a||r<s||t>u||r>l)return Promise.resolve(null);var c=(0,C.Rq)(this.rasterId,n.sliceId),f="".concat(e,"/").concat(t,"/").concat(r),h=(0,C.Qg)(c,n.registryId,f);if(null==h){var p=new AbortController;h=this.fetchRawTile(e,t,r,(0,o.Z)((0,o.Z)({},n),{},{signal:p.signal})),(0,C.gX)(c,n.registryId,f,h,p),h.catch((function(){return(0,C.Gc)(c,n.registryId,f)}))}return n.signal&&(0,x.fu)(n,(function(){(0,C.OE)(c,n.registryId,f)})),h}},{key:"_computeMagDirValues",value:function(e){var t,r=this.rasterInfo,i=r.bandCount,a=r.dataType;if((2!==i||"vector-magdir"!==a)&&"vector-uv"!==a||2!==(null===e||void 0===e?void 0:e.length)||null===(t=e[0])||void 0===t||!t.length)return null;var s=e[0].length;if("vector-magdir"===a){var o=e[1].map((function(e){return(e+360)%360}));return[e[0],o]}for(var l=(0,n.Z)(e,2),u=l[0],c=l[1],f=[],h=[],p=0;p<s;p++){var d=(0,D.Tg)([u[p],c[p]]),m=(0,n.Z)(d,2),v=m[0],y=m[1];f.push(v),h.push(y)}return[f,h]}},{key:"_getRasterTileAlignmentInfo",value:function(e,t){return null==this._rasterTileAlignmentInfo&&(this._rasterTileAlignmentInfo=(0,P.P_)(this.rasterInfo)),null==this._rasterTileAlignmentInfo.pyramidsInfo?null:(0,o.Z)({startX:t,halfWorldWidth:this._rasterTileAlignmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlignmentInfo.hasGCSSShiftTransform},this._rasterTileAlignmentInfo.pyramidsInfo[e])}},{key:"_getSourceDataInfo",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i={datumTransformation:n.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0,ul:{x:0,y:0}};n.srcResolution&&(i.srcResolution=n.srcResolution,this._updateSourceDataInfo(e,i));var a=this.rasterInfo.storageInfo.maximumPyramidLevel||0,s=i.srcWidth,o=i.srcHeight,l=i.pyramidLevel,u=s/t,c=o/r,f=l<a&&u*c>=16,h=l===a&&this._requireTooManySrcTiles(s,o,t,r);if(f||h||0===s||0===o){var p=new J.Z({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),d=(0,P.VO)(p,this.rasterInfo.spatialReference,e,i.datumTransformation),m=!d||n.srcResolution&&d.x+d.y<n.srcResolution.x+n.srcResolution.y;if(f&&n.srcResolution&&m){var v=Math.round(Math.log(Math.max(u,c))/Math.LN2)-1;if(a-l+3>=v){var y=Math.pow(2,v);d={x:n.srcResolution.x*y,y:n.srcResolution.y*y}}}d&&(i.srcResolution=d,this._updateSourceDataInfo(e,i))}return this._requireTooManySrcTiles(i.srcWidth,i.srcHeight,t,r)&&(i.srcWidth=0,i.srcHeight=0),i}},{key:"_requireTooManySrcTiles",value:function(e,t,r,n){var i=this.rasterInfo.storageInfo.tileInfo,a=e/r,s=t/n;return Math.ceil(e/i.size[0])*Math.ceil(t/i.size[1])>=256*Math.max(1,(r+n)/1024)||a>8||s>8}},{key:"_updateSourceDataInfo",value:function(e,t){t.srcWidth=0,t.srcHeight=0;var r=this.rasterInfo,n=r.spatialReference,i=t.srcResolution,a=t.datumTransformation,s=(0,P.kr)(i,r,this.ioConfig.sampling),o=s.pyramidLevel,l=s.pyramidResolution;if(!s.excessiveReading){var u=t.srcExtent||(0,P.tB)(e,n,a);if(null!=u){var c=r.transform;c&&(u=c.inverseTransform(u)),t.srcExtent=u;var f=r.storageInfo.origin,h=f.x,p=f.y,d=Math.floor((u.xmin-h)/l.x+.1),m=Math.floor((p-u.ymax)/l.y+.1),v=Math.floor((u.xmax-h)/l.x-.1),y=Math.floor((p-u.ymin)/l.y-.1),x=u.width<.1*l.x?0:v-d+1,g=u.height<.1*l.y?0:y-m+1;t.pyramidLevel=o,t.pyramidResolution=l,t.srcWidth=x,t.srcHeight=g,t.ul={x:d,y:m}}}}},{key:"_getRequestOptionsWithSliceId",value:function(e){return null!=this.rasterInfo.multidimensionalInfo&&null==e.sliceId&&(e=(0,o.Z)((0,o.Z)({},e),{},{sliceId:this.getSliceIndex(e.multidimensionalDefinition)})),e}},{key:"_processIdentifyResult",value:function(e,t){var r=t.srcLocation,n=t.position,i=t.pyramidLevel,a=t.useTransposedTile,s=e.pixels[0].length/e.width/e.height;if(e.mask&&!e.mask[n])return{location:r,value:null};var l=this.rasterInfo.multidimensionalInfo;if(null==l||!a){var u=e.pixels.map((function(e){return e[n]})),c={location:r,value:u,pyramidLevel:i},f=this._computeMagDirValues(u.map((function(e){return[e]})));return null!==f&&void 0!==f&&f.length&&(c.magdirValue=f.map((function(e){return e[0]}))),c}var h=e.pixels.map((function(e){return e.slice(n*s,n*s+s)})),p=this._computeMagDirValues(h),d=t.requestSomeSlices,m=t.identifyOptions,v=(0,T.MO)(l,m.transposedVariableName);if(d){var y,x=(0,T.Ur)(v,m.multidimensionalDefinition,m.timeExtent);h=h.map((function(e){return x.map((function(t){return e[t]}))})),p=null===(y=p)||void 0===y?void 0:y.map((function(e){return x.map((function(t){return e[t]}))})),v=x.map((function(e){return v[e]}))}var g,b=e.noDataValues||this.rasterInfo.noDataValue,k={pixels:h,pixelType:e.pixelType};return null!=b&&((0,M.Ao)(k,b),g=k.mask),{location:r,value:null,dataSeries:v.map((function(e,t){var r,n,i={value:0===(null===(r=g)||void 0===r?void 0:r[t])?null:h.map((function(e){return e[t]})),multidimensionalDefinition:e.multidimensionalDefinition.map((function(e){return new I.Z((0,o.Z)((0,o.Z)({},e),{},{isSlice:!0}))}))};return null!==(n=p)&&void 0!==n&&n.length&&(i.magdirValue=[p[0][t],p[1][t]]),i})),pyramidLevel:i}}}]),r}((0,y.v)(m.wq));function L(e,t,r){return Math.abs(e.x-t.x)<r&&Math.abs(e.y-t.y)<r}(0,h._)([(0,g.Cb)()],z.prototype,"_rasterTileAlignmentInfo",void 0),(0,h._)([(0,g.Cb)()],z.prototype,"_tileFetchQueue",void 0),(0,h._)([(0,g.Cb)({readOnly:!0})],z.prototype,"_isGlobalWrappableSource",null),(0,h._)([(0,g.Cb)({readOnly:!0})],z.prototype,"_hasNoneOrGCSShiftTransform",null),(0,h._)([(0,g.Cb)()],z.prototype,"rasterJobHandler",null),(0,h._)([(0,g.Cb)({readOnly:!0})],z.prototype,"rasterId",null),(0,h._)([(0,g.Cb)(Z.HQ)],z.prototype,"url",null),(0,h._)([(0,g.Cb)({type:String,json:{write:!0}})],z.prototype,"datasetName",void 0),(0,h._)([(0,g.Cb)({type:String,json:{write:!0}})],z.prototype,"datasetFormat",void 0),(0,h._)([(0,g.Cb)()],z.prototype,"hasUniqueSourceStorageInfo",void 0),(0,h._)([(0,g.Cb)()],z.prototype,"rasterInfo",void 0),(0,h._)([(0,g.Cb)()],z.prototype,"ioConfig",void 0),(0,h._)([(0,g.Cb)()],z.prototype,"sourceJSON",void 0);var H=z=(0,h._)([(0,k.j)("esri.layers.support.rasterDatasets.BaseRaster")],z)},70047:function(e,t,r){r.d(t,{Z:function(){return Je}});var n=r(74165),i=r(15861),a=r(15671),s=r(43144),o=r(10064),l=r(60136),u=r(29388),c=r(27366),f=r(49861),h=r(93169),p=r(32718),d=(r(84936),r(69912)),m=r(59226),v=r(93433),y=r(29439),x=r(51995),g=(r(59486),r(53866)),b=r(36257),k=r(99278),w=r(92089),Z=r(78952);function I(e){return["x","e","east","long","longitude"].includes(e.toLowerCase())}function _(e){return["y","n","west","lat","latitude"].includes(e.toLowerCase())}function R(e){for(var t=e.domain.axes,r=Object.keys(t),n=[],i=[],a=-1,s=-1,o=[],l=function(e){var l=r[e];I(l)?a=e:_(l)&&(s=e);var u=t[l],c=[];if("values"in u){u.values.forEach((function(e){return c.push("string"==typeof e?new Date(e).getTime():e)}));var f=c[1]-c[0];n.push([c[0]-.5*f,c[c.length-1]+.5*f]),i.push(f)}else{var h=u.start,p=u.stop,d=u.num,m=(p-h)/(d-1);n.push([h-.5*m,p+.5*m]),i.push(m);for(var v=0;v<d;v++)c.push(h+m*v)}o.push({name:l,values:c,extent:[c[0],c[c.length-1]]})},u=0;u<r.length;u++)l(u);a>-1&&-1===s?s=0===a?1:0:s>-1&&-1===a?a=0===s?1:0:-1===s&&-1===a&&(a=0,s=1),o=o.filter((function(e,t){return!(t===a||t===s)}));var c=e.domain.referencing.find((function(e){return e.coordinates.includes(r[a])})).system.id,f=null===c||void 0===c?void 0:c.slice(c.lastIndexOf("/")+1),h=null==f||"CRS84"===f?4326:Number(f),p=new Z.Z({wkid:h}),d=(0,y.Z)(n[a],2),m=d[0],v=d[1],x=(0,y.Z)(n[s],2),b=x[0],k=x[1],w=new g.Z({xmin:m,xmax:v,ymin:b,ymax:k,spatialReference:p});return{width:Math.round(w.width/i[a]),height:Math.round(w.height/i[s]),extent:w,dimensions:o}}function S(e){var t,r=(0,b.G3)();return r&&null!==(t=e[r])&&void 0!==t?t:Object.values(e)[0]}function T(){return Math.round(255*Math.random())}function C(e){var t={},r=e.parameters;if(!r)return t;for(var n=0,i=Object.entries(r);n<i.length;n++){var a,s=(0,y.Z)(i[n],2),o=s[0],l=s[1],u=l.type,c=l.description,f=l.unit,h=l.categoryEncoding,p=l.observedProperty;"Parameter"===u&&(t[o]={},c&&(t[o].description=S(c)),f&&(t[o].unit=f.label?S(f.label):null,t[o].symbol=null===(a=f.symbol)||void 0===a?void 0:a.value),h)&&function(e){var r=Object.entries(h).map((function(e,t){return{OID:t,Value:Number(e[1]),ClassName:e[0].slice(e[0].lastIndexOf("/")+1),Count:1}})),n=!1;(null===p||void 0===p||null===(e=p.categories)||void 0===e?void 0:e.length)&&(p.categories.forEach((function(e){if(e.id){var t=e.id.slice(e.id.lastIndexOf("/")+1),i=r.find((function(e){return e.ClassName===t}));if(i){var a=e.label?S(e.label):null;if(i.Label=a,e.preferredColor){var s=x.Z.fromHex(e.preferredColor);s&&(n=!0,i.Red=s.r,i.Green=s.g,i.Blue=s.b)}}}})),n&&r.forEach((function(e){null==e.Red&&(e.Red=T(),e.Green=T(),e.Blue=T())})));var i={objectIdFieldName:"",fields:[{name:"OID",type:"esriFieldTypeOID",alias:"OID",domain:null},{name:"Value",type:"esriFieldTypeInteger",alias:"Value",domain:null},{name:"Count",type:"esriFieldTypeDouble",alias:"Count",domain:null},{name:"ClassName",type:"esriFieldTypeString",alias:"ClassName",domain:null,length:50},{name:"Label",type:"esriFieldTypeString",alias:"Label",domain:null,length:50}],features:r.map((function(e){return{attributes:e}}))};n&&i.fields.push({name:"Red",type:"esriFieldTypeInteger",alias:"Red",domain:null},{name:"Green",type:"esriFieldTypeInteger",alias:"Green",domain:null},{name:"Blue",type:"esriFieldTypeInteger",alias:"Blue",domain:null}),t[o].attributeTable=i}()}return t}function M(e){for(var t=Number.MAX_VALUE,r=-Number.MAX_VALUE,n=0;n<e.length;n++){var i=e[n];null!=i&&(i<t&&(t=i),i>r&&(r=i))}return(0,w.JQ)(t,r)}function F(e,t,r){for(var n,i=e.map((function(e,r){return{name:e,count:t[r]}})).sort((function(e,t){return e.name>t.name?-1:1})),a=(n=1,function(e){return n*=e.count}),s=[].concat((0,v.Z)(i.slice(1)),[{name:"",count:1}]).reverse().map(a).reverse(),o=0,l=function(n){o+=s[i.findIndex((function(t){return t.name===e[n]}))]*(r%t[n]),r=Math.floor(r/t[n])},u=e.length-1;u>=0;u--)l(u);return o}function O(e){for(var t,r=R(e),n=r.width,i=r.height,a=r.extent,s=r.dimensions,o=e.ranges,l=Object.keys(o).sort((function(e,t){return e<t?-1:1})),u=[],c=0;c<l.length;c++){var f=l[c];(null===s||void 0===s?void 0:s.length)&&u.push({name:f,dimensions:s})}var h=C(e);u.forEach((function(e){return h[e.name]&&Object.assign(e,h[e.name])}));for(var p=u.length?{variables:u}:void 0,d=[],m=0;m<l.length;m++)for(var v=o[l[m]],y=v.values,x=v.dataType,g=v.axisNames,b=v.shape,w=b.length>2?m*b.slice(0,-2).reduce((function(e,t){return e*t})):0,Z=g.slice(0,-2),I=b.slice(0,-2),_="float"===x?"f32":M(y),S=n*i,T=y.length/S,O=0;O<T;O++){for(var P=k.Z.createEmptyBand(_,S),D=new Uint8Array(S).fill(255),B=!1,N=O*S,J=0;J<S;J++){var A=y[N+J];null==A?(D[J]=0,B=!0):P[J]=A}if(0===m||null!==s&&void 0!==s&&s.length){var E=new k.Z({width:n,height:i,mask:B?D:null,pixels:[P],pixelType:_});E.updateStatistics(),null!==s&&void 0!==s&&s.length?d[F(Z,I,O)+w]=E:d.push(E)}else{var z=d[O];z.pixels.push(P),B?z.mask&&(z.mask=k.Z.combineBandMasks([z.mask,D])):z.mask=B?D:null}}var L=null===(t=Object.values(h).find((function(e){return e.attributeTable})))||void 0===t?void 0:t.attributeTable;return{extent:a,pixelBlocks:d,multidimensionalInfo:p,attributeTable:L,bandNames:p?void 0:l}}var P=r(1413),D=r(66978),B=r(86591),N=r(53737),J=r(21969),A=r(17314),E=r(21449),z=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(){var e;return(0,a.Z)(this,r),(e=t.apply(this,arguments)).datasetFormat="MEMORY",e.source=null,e}return(0,s.Z)(r,[{key:"url",get:function(){return""}},{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,h,p,d,m,v,y,x,b,k,w;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:if(a=this.source,s=a.pixelBlocks,o=a.attributeTable,l=a.statistics,u=a.histograms,c=a.name,f=a.nativeExtent,h=a.transform,p=s[0],d=p.width,m=p.height,v=p.pixelType,y=null!==(r=a.extent)&&void 0!==r?r:new g.Z({xmin:-.5,ymin:.5,xmax:d-.5,ymax:m-.5,spatialReference:new Z.Z({wkid:3857})}),x=null!==(i=a.isPseudoSpatialReference)&&void 0!==i?i:!a.extent,b={x:y.width/d,y:y.height/m},k=(0,P.Z)({},a.keyProperties),o&&(k.DataType="Thematic"),w=new N.Z({width:d,height:m,pixelType:v,extent:y,nativeExtent:f,attributeTable:o,transform:h,pixelSize:b,spatialReference:y.spatialReference,bandCount:p.pixels.length,keyProperties:k,multidimensionalInfo:a.multidimensionalInfo,statistics:l,isPseudoSpatialReference:x,histograms:u}),this.ioConfig.skipMapInfo&&this.updateImageSpaceRasterInfo(w),this.createRemoteDatasetStorageInfo(w,512,512),this._set("rasterInfo",w),this.updateTileInfo(),!w.multidimensionalInfo){e.next=14;break}return e.next=12,this._buildMDimStats(a.pixelBlocks,w.multidimensionalInfo);case 12:e.next=16;break;case 14:return e.next=16,this._buildInMemoryRaster(p,{width:512,height:512},t);case 16:w.multidimensionalInfo||(this.source=null),this.datasetName=c;case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!this._pixelBlockTiles){var i=this.rasterInfo,a=(0,y.Z)(i.storageInfo.tileInfo.size,2),s=a[0],o=a[1],l=n.sliceId,u=this.source.pixelBlocks,c={pixelBlock:null==l?u[0]:u[l],useBilinear:"thematic"!==i.dataType,tileSize:{width:s,height:o},level:e,row:t,col:r},f=this.rasterJobHandler?this.rasterJobHandler.clipTile(c,n):(0,A.Uu)(c);return Promise.resolve(f)}var h=this._pixelBlockTiles.get("".concat(e,"/").concat(t,"/").concat(r));return Promise.resolve(h)}},{key:"_buildInMemoryRaster",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,l,u,c,f,h,p,d,m,v;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=this.rasterInfo,c=null!==(a=u.storageInfo.maximumPyramidLevel)&&void 0!==a?a:0,f="thematic"!==u.dataType,h=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:t,tileSize:r,maximumPyramidLevel:c,useBilinear:f},i):Promise.resolve((0,A.Vl)(t,r,c,f)),p=null!=u.statistics,d=null!=u.histograms,m=this.ioConfig.skipStatistics||p?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:t},i):Promise.resolve((0,E.Hv)(t)),e.next=9,(0,D.as)([h,m]);case 9:if((v=e.sent)[0].value||!v[1].value){e.next=12;break}throw new o.Z("inmemory-raster:open","failed to build in memory raster");case 12:this._pixelBlockTiles=v[0].value,p||(u.statistics=null===(s=v[1].value)||void 0===s?void 0:s.statistics),d||(u.histograms=null===(l=v[1].value)||void 0===l?void 0:l.histograms);case 13:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_buildMDimStats",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=(0,n.Z)().mark((function e(a){var s,l,u,c,f;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(s=r.variables[a]).statistics){e.next=3;break}return e.abrupt("return","continue");case 3:if(l=s.dimensions.map((function(e){var t,r,n;return new B.Z({variableName:s.name,dimensionName:e.name,values:[null!==(t=null===(r=e.values)||void 0===r?void 0:r[0])&&void 0!==t?t:null===(n=e.extent)||void 0===n?void 0:n[0]],isSlice:!0})})),u=(0,J.gk)(l,r),null!=(c=null==u?null:t[u])){e.next=6;break}return e.abrupt("return","continue");case 6:if(!o.rasterJobHandler){e.next=12;break}return e.next=9,o.rasterJobHandler.computeStatisticsHistograms({pixelBlock:c},i);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=(0,E.js)(c);case 13:f=e.t0,s.statistics=f.statistics,s.histograms||(s.histograms=f.histograms);case 15:case"end":return e.stop()}}),e)})),s=0;case 2:if(!(s<r.variables.length)){e.next=10;break}return e.delegateYield(a(s),"t0",4);case 4:if("continue"!==e.t0){e.next=7;break}return e.abrupt("continue",7);case 7:s++,e.next=2;break;case 10:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(m.Z);(0,c._)([(0,f.Cb)({type:String,json:{write:!0}})],z.prototype,"datasetFormat",void 0),(0,c._)([(0,f.Cb)()],z.prototype,"source",void 0),(0,c._)([(0,f.Cb)()],z.prototype,"url",null);var L=z=(0,c._)([(0,d.j)("esri.layers.support.rasterDatasets.InMemoryRaster")],z),H=r(49818),W=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(){var e;return(0,a.Z)(this,r),(e=t.apply(this,arguments)).datasetFormat="CovJSON",e}return(0,s.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,h,p,d,m;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._fetchData(t);case 4:return r=e.sent,i=r.extent,a=r.pixelBlocks,s=r.multidimensionalInfo,o=r.attributeTable,l=r.bandNames,u=(0,E.js)(a[0]),c=u.statistics,f=u.histograms,h=null===l||void 0===l?void 0:l.map((function(e){return{BandName:e}})),p={DataType:o?"Thematic":s?"Scientific":"Generic",BandProperties:h},d=new L({source:{extent:i,pixelBlocks:a,attributeTable:o?H.Z.fromJSON(o):null,multidimensionalInfo:s,statistics:c,histograms:f,keyProperties:p,isPseudoSpatialReference:!1}}),e.next=18,d.open();case 18:this._inMemoryRaster=d,m=this.source?"":this.url.slice(this.url.lastIndexOf("/")+1),this._set("datasetName",m.slice(0,m.indexOf("."))),this._set("rasterInfo",d.rasterInfo);case 21:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this._inMemoryRaster.fetchRawTile(e,t,r,n)}},{key:"_fetchData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,l,u,c,f,h,p,d,m,v,y;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(r=this.source)||void 0===r){e.next=4;break}e.t0=r,e.next=7;break;case 4:return e.next=6,this.request(this.url,{signal:null===t||void 0===t?void 0:t.signal});case 6:e.t0=e.sent.data;case 7:if(u=e.t0,c="imagery-tile-layer:open-coverage-json","coverage"===(null===(i=u.type)||void 0===i?void 0:i.toLowerCase())&&"grid"===(null===(a=u.domain)||void 0===a||null===(s=a.domainType)||void 0===s?void 0:s.toLowerCase())){e.next=11;break}throw new o.Z(c,"Only coverage with Grid domain type is supported");case 11:if(u.ranges){e.next=13;break}throw new o.Z(c,"Missing ranges in the grid coverage data");case 13:if(null!==(l=u.domain.referencing)&&void 0!==l&&l.length){e.next=15;break}throw new o.Z(c,"Missing domain referencing in the grid coverage data");case 15:f=Object.values(u.ranges),h=0;case 17:if(!(h<f.length)){e.next=26;break}if(p=f[h],d=p.axisNames,m=p.shape,v=p.type,y=p.values,"ndarray"===v.toLowerCase()&&null!==y&&void 0!==y&&y.length&&null!==d&&void 0!==d&&d.length&&null!==m&&void 0!==m&&m.length){e.next=21;break}throw new o.Z(c,"Only ranges with valid NdArray, axisNames, shape, and inline values are supported");case 21:if(I(d[d.length-1])&&_(d[d.length-2])){e.next=23;break}throw new o.Z(c,"Only row-major ordered pixel values are supported. X axis must be the last axis.");case 23:h++,e.next=17;break;case 26:return e.abrupt("return",O(u));case 27:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(m.Z);(0,c._)([(0,f.Cb)({type:String,json:{write:!0}})],W.prototype,"datasetFormat",void 0),(0,c._)([(0,f.Cb)({constructOnly:!0})],W.prototype,"source",void 0);var q=W=(0,c._)([(0,d.j)("esri.layers.support.rasterDatasets.CovJSONRaster")],W),G=r(63780),j=r(92975);function U(e,t){if(!e||!t)return[];var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=[];if(t){for(var i=U(e,r),a=0;a<i.length;a++)U(i[a],t).forEach((function(e){return n.push(e)}));return n}var s=e.getElementsByTagNameNS("*",r);if(!s||0===s.length)return[];for(var o=0;o<s.length;o++)n.push(s[o]||s.item(o));return n}function V(e,t){if(!e||!t)return null;var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=U(e,r);return n.length>0?t?V(n[0],t):n[0]:null}function Y(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=r?V(e,r):e;return n?(t=n.textContent||n.nodeValue)?t.trim():null:null}function X(e,t){return function(e,t){for(var r,n=U(e,t),i=[],a=0;a<n.length;a++)(r=n[a].textContent||n[a].nodeValue)&&""!==(r=r.trim())&&i.push(r);return i}(e,t).map((function(e){return Number(e)}))}function Q(e,t){var r=Y(e,t);return Number(r)}function K(e,t){var r,n=null===e||void 0===e||null===(r=e.nodeName)||void 0===r?void 0:r.toLowerCase(),i=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===i}var $=r(69405);function ee(e,t){if(!e||!t)return null;for(var r=[],n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function te(e){if(!e)return null;var t=Number(e);if(!isNaN(t)&&0!==t)return new Z.Z({wkid:t});if(e=String(e).trim(),(0,j.xl)(e))return new Z.Z({wkt2:e});var r=e.toUpperCase();if(r.startsWith("COMPD_CS")){if(!r.includes("VERTCS")||!r.includes("GEOGCS")&&!r.startsWith("PROJCS"))return null;var n=r.indexOf("VERTCS"),i=r.indexOf("PROJCS"),a=i>-1?i:r.indexOf("GEOGCS");if(-1===a)return null;var s=e.slice(a,e.lastIndexOf("]",n)+1).trim(),o=e.slice(n,e.lastIndexOf("]")).trim();t=re(s);var l=new Z.Z(t?{wkid:t}:{wkt:s}),u=re(o);return u&&(l.vcsWkid=u),l}return r.startsWith("GEOGCS")||r.startsWith("PROJCS")?(t=re(e),new Z.Z(0!==t?{wkid:t}:{wkt:e})):null}function re(e){var t,r=e.replaceAll("]","[").replaceAll('"',"").split("[").map((function(e){return e.trim()})).filter((function(e){return""!==e})),n=r[r.length-1].split(","),i=null===(t=n[0])||void 0===t?void 0:t.toLowerCase();if(("epsg"===i||"esri"===i)&&e.endsWith('"]]')){var a=Number(n[1]);if(!isNaN(a)&&0!==a)return a}return 0}function ne(e){var t;if("pamdataset"!==(null===e||void 0===e||null===(t=e.documentElement.tagName)||void 0===t?void 0:t.toLowerCase()))return{};var r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((function(e){if(1===e.nodeType)if(K(e,"SRS")){if(!r.spatialReference){var t=Y(e);r.spatialReference=te(t)}}else if(K(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){var n=function(e){var t,r=V(e,"GeodataXform"),n=te(Q(r,"SpatialReference/WKID")||Y(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};var i=null!==(t=Q(r,"PolynomialOrder"))&&void 0!==t?t:1,a=X(r,"CoeffX/Double"),s=X(r,"CoeffY/Double"),o=X(r,"InverseCoeffX/Double"),l=X(r,"InverseCoeffY/Double"),u=ee(a,s),c=ee(o,l);return{spatialReference:n,transform:u&&c&&u.length&&c.length?new $.Z({spatialReference:n,polynomialOrder:i,forwardCoefficients:u,inverseCoefficients:c}):null}}(e),i=n.spatialReference,a=n.transform;r.transform=a,r.spatialReference||(r.spatialReference=i)}else U(e,"MDI").forEach((function(e){return r.metadata[e.getAttribute("key")]=Y(e)}));else if(K(e,"PAMRasterBand")){var s=function(e){var t,r,n,i,a,s=Q(e,"NoDataValue"),o=V(e,"Histograms/HistItem"),l=Q(o,"HistMin"),u=Q(o,"HistMax"),c=Q(o,"BucketCount"),f=null===(t=Y(o,"HistCounts"))||void 0===t?void 0:t.split("|").map((function(e){return Number(e)}));U(e,"Metadata/MDI").forEach((function(e){var t,s=Number(null!==(t=e.textContent)&&void 0!==t?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":r=s;break;case"STATISTICS_MAXIMUM":n=s;break;case"STATISTICS_MEAN":i=s;break;case"STATISTICS_STDDEV":a=s}}));var h=Q(e,"Metadata/SourceBandIndex");return{noDataValue:s,histogram:null!==f&&void 0!==f&&f.length&&null!=l&&null!=u?{min:l,max:u,size:c||f.length,counts:f}:null,sourceBandIndex:h,statistics:null!=r&&null!=n?{min:r,max:n,avg:i,stddev:a}:null}}(e);null!=s.sourceBandIndex&&null==r.rasterBands[s.sourceBandIndex]?r.rasterBands[s.sourceBandIndex]=s:r.rasterBands.push(s)}}));var n=r.rasterBands;if(n.length){var i=!!n[0].statistics;r.statistics=i?n.map((function(e){return e.statistics})).filter(G.pC):null;var a=!!n[0].histogram;r.histograms=a?n.map((function(e){return e.histogram})).filter(G.pC):null}return r}var ie=r(45502),ae=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(){return(0,a.Z)(this,r),t.apply(this,arguments)}return(0,s.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,h,p,d,m;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._fetchData(t);case 4:return r=e.sent,e.next=7,this._fetchAuxiliaryData(t);case 7:return i=e.sent,a=i.spatialReference,s=i.statistics,o=i.histograms,l=i.transform,(u=!a)&&(a=new Z.Z({wkid:3857})),(null===o||void 0===o?void 0:o.length)&&null==s&&(s=(0,E.Oh)(o)),c=r.width,f=r.height,h=new g.Z({xmin:-.5,ymin:.5-f,xmax:c-.5,ymax:.5,spatialReference:a}),p=l?l.forwardTransform(h):h,!0,l&&(d=l.forwardCoefficients,d&&0===d[1]&&0===d[2]&&(l=null,h=p)),m=new L({source:{extent:p,nativeExtent:h,transform:l,pixelBlocks:[r],statistics:s,histograms:o,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:u},ioConfig:{sampling:"closest",skipStatistics:!0}}),this.ioConfig.skipMapInfo&&(m.ioConfig.skipMapInfo=!0),e.next=23,m.open();case 23:m.source=null,this._set("rasterInfo",m.rasterInfo),this._inMemoryRaster=m;case 26:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this._inMemoryRaster.fetchRawTile(e,t,r,n)}},{key:"_fetchData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,l,u;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url,{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 2:if(r=e.sent,i=r.data,"JPG"===(a=(0,ie.y)(i).toUpperCase())||"PNG"===a||"GIF"===a||"BMP"===a){e.next=7;break}throw new o.Z("image-aux-raster:open","the data is not a supported format");case 7:return this._set("datasetFormat",a),s=a.toLowerCase(),l="gif"===s||"bmp"===s||!(0,h.Z)("ios"),e.next=12,this.decodePixelBlock(i,{format:s,useCanvas:l,hasNoZlibMask:!0});case 12:if(null!=(u=e.sent)){e.next=15;break}throw new o.Z("image-aux-raster:open","the data cannot be decoded");case 15:return e.abrupt("return",u);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,h,p,d,m;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=null===t||void 0===t?void 0:t.signal,a=this.ioConfig,s=a.skipExtensions,o=void 0===s?[]:s,l=a.skipMapInfo,u=l||o.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:i}),c=this.datasetFormat,h=(f="JPG"===c?"jgw":"PNG"===c?"pgw":"BMP"===c?"bpw":null)&&o.includes(f)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+f,{responseType:"text",signal:i}),e.next=11,(0,D.as)([u,h]);case 11:if(p=e.sent,null===i||void 0===i||!i.aborted){e.next=14;break}throw(0,D.zE)();case 14:return(d=ne(null===(r=p[0].value)||void 0===r?void 0:r.data)).transform||(m=p[1].value?p[1].value.data.split("\n").slice(0,6).map((function(e){return Number(e)})):null,d.transform=6===(null===m||void 0===m?void 0:m.length)?new $.Z({forwardCoefficients:[m[4],m[5],m[0],-m[1],m[2],-m[3]]}):null),e.abrupt("return",d);case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(m.Z);(0,c._)([(0,f.Cb)({type:String,json:{write:!0}})],ae.prototype,"datasetFormat",void 0);var se=ae=(0,c._)([(0,d.j)("esri.layers.support.rasterDatasets.ImageAuxRaster")],ae),oe=r(92026),le=r(35995),ue=r(32014),ce=r(22824),fe=r(34810),he=r(3089),pe=r(38045),de=r(848),me=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(){var e;return(0,a.Z)(this,r),(e=t.apply(this,arguments))._levelOffset=0,e._tilemapCache=null,e._slices=null,e.datasetFormat="RasterTileServer",e.tileType=null,e}return(0,s.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,l,u,c,f,h,p,d,m,v,x,g,b,k,w,Z,I,_,R,S,T,C,M,F,O,P,D,B;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:if(u=null===t||void 0===t?void 0:t.signal,!this.sourceJSON){e.next=7;break}e.t0={data:this.sourceJSON},e.next=10;break;case 7:return e.next=9,this.request(this.url,{query:{f:"json"},signal:u});case 9:e.t0=e.sent;case 10:if((c=e.t0).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),f=c.data,this.sourceJSON=f,f){e.next=15;break}throw new o.Z("imageserverraster:open","cannot initialize tiled image service, missing service info");case 15:if(f.tileInfo){e.next=17;break}throw new o.Z("imageserverraster:open","use ImageryLayer to open non-tiled image services");case 17:return this._fixScaleInServiceInfo(),h=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=f.cacheType,null==this.tileType&&(h.includes(f.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===f.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=null!==(r=null===(i=f.name)||void 0===i?void 0:i.slice(f.name.indexOf("/")+1))&&void 0!==r?r:"",e.next=22,this._fetchRasterInfo({signal:u});case 22:if(null!=(p=e.sent)){e.next=25;break}throw new o.Z("image-server-raster:open","cannot initialize image service");case 25:(0,pe.n$)(p,f),d="Map"===this.tileType?ve(f.tileInfo,f):ce.Z.fromJSON(f.tileInfo),(0,oe.O3)(d),m=this._computeMinMaxLOD(p,d),v=(0,y.Z)(m,2),x=v[0],g=v[1],b=p.extent,k=p.pixelSize,w=.5/p.width*k.x,Z=Math.max(k.x,k.y),I=d.lods,("Map"!==this.tileType&&0!==f.maxScale||Math.abs(k.x-k.y)>w||!I.some((function(e){return Math.abs(e.resolution-Z)<w})))&&(k.x=k.y=x.resolution,p.width=Math.ceil((b.xmax-b.xmin)/k.x-.1),p.height=Math.ceil((b.ymax-b.ymin)/k.y-.1)),_=x.level-g.level,R=(0,y.Z)(d.size,2),S=R[0],T=R[1],C=[],M=[],I.forEach((function(e,t){e.level>=g.level&&e.level<=x.level&&C.push({x:e.resolution,y:e.resolution}),t<I.length-1&&M.push(Math.round(10*e.resolution/I[t+1].resolution)/10)})),C.sort((function(e,t){return e.x-t.x})),F=this.computeBlockBoundary(b,S,T,d.origin,C,_),O=C.length>1?C.slice(1):null,f.transposeInfo&&(P={tileSize:[f.transposeInfo.rows,f.transposeInfo.cols],packetSize:null!==(a=null===(s=p.keyProperties)||void 0===s?void 0:s._yxs.PacketSize)&&void 0!==a?a:0}),D=M.length<=1||M.length>=3&&M.slice(0,-1).every((function(e){return e===M[0]}))?null!==(l=M[0])&&void 0!==l?l:2:Math.round(10/Math.pow(g.resolution/x.resolution,-1/_))/10,p.storageInfo=new ue.Z({blockWidth:d.size[0],blockHeight:d.size[1],pyramidBlockWidth:d.size[0],pyramidBlockHeight:d.size[1],pyramidResolutions:O,pyramidScalingFactor:D,compression:d.format,origin:d.origin,firstPyramidLevel:1,maximumPyramidLevel:_,tileInfo:d,transposeInfo:P,blockBoundary:F}),ye(p),this._set("rasterInfo",p),f.capabilities.toLowerCase().includes("tilemap")&&(B={tileInfo:p.storageInfo.tileInfo,parsedUrl:(0,le.mN)(this.url),url:this.url,tileServers:[]},this._tilemapCache=new fe.y({layer:B}));case 36:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k,w,Z,I,_,R,S,T,C,M,F,O,P=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=P.length>3&&void 0!==P[3]?P[3]:{},s=this.rasterInfo,o=s.storageInfo,l=s.extent,u=o.transposeInfo,c=null!=u&&!!a.transposedVariableName,!this._slices||c||null!=a.sliceId){e.next=4;break}return e.abrupt("return",null);case 4:return f=c?0:o.maximumPyramidLevel-t+this._levelOffset,h="".concat(this.url,"/tile/").concat(f,"/").concat(r,"/").concat(i),p=this._slices?c?{variable:a.transposedVariableName}:{sliceId:a.sliceId||0}:null,e.next=9,this.request(h,{query:p,responseType:"array-buffer",signal:a.signal});case 9:if(d=e.sent,m=d.data){e.next=13;break}return e.abrupt("return",null);case 13:return v=c?u.tileSize:o.tileInfo.size,e.next=16,this.decodePixelBlock(m,{width:v[0],height:v[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType,returnInterleaved:c,noDataValue:this.rasterInfo.noDataValue});case 16:if(null!=(y=e.sent)){e.next=19;break}return e.abrupt("return",null);case 19:if(x=o.blockBoundary[t],!("jpg"!==o.compression||i>x.minCol&&i<x.maxCol&&r>x.minRow&&r<x.maxRow)){e.next=22;break}return e.abrupt("return",y);case 22:return g=o.origin,b=o.blockWidth,k=o.blockHeight,w=this.getPyramidPixelSize(t),Z=w.x,I=w.y,_=Math.round((l.xmin-g.x)/Z)%b,R=Math.round((l.xmax-g.x)/Z)%b||b,S=Math.round((g.y-l.ymax)/I)%k,T=Math.round((g.y-l.ymin)/I)%k||k,C=i===x.minCol?_:0,M=r===x.minRow?S:0,F=i===x.maxCol?R:b,O=r===x.maxRow?T:k,e.abrupt("return",((0,A.pW)(y,{x:C,y:M},{width:F-C,height:O-M}),y));case 24:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){if(!this._slices||null==e||0===e.length)return null;for(var t=e,r=0;r<this._slices.length;r++){var n=this._slices[r].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var r=t.find((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}));return!r||(Array.isArray(e.values[0])?"".concat(e.values[0][0],"-").concat(e.values[0][1]):e.values[0])!==(Array.isArray(r.values[0])?"".concat(r.values[0][0],"-").concat(r.values[0][1]):r.values[0])})))return r}return null}},{key:"fetchVariableStatisticsHistograms",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,a,s,o,l,u;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.request(this.url+"/statistics",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.statistics})),l=this.request(this.url+"/histograms",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.histograms})),e.next=4,Promise.all([o,l]);case 4:return u=e.sent,e.abrupt("return",(u[0]&&u[0].forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation})),null!==(i=u[1])&&void 0!==i&&null!==(a=i[0])&&void 0!==a&&null!==(s=a.counts)&&void 0!==s&&s.length||(u[1]=null),{statistics:u[0]||null,histograms:u[1]||null}));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"computeBestPyramidLevelForLocation",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:{},this._tilemapCache){e.next=3;break}return e.abrupt("return",0);case 3:if(null!==(i=this.identifyPixelLocation(t,0,r.datumTransformation))){e.next=6;break}return e.abrupt("return",null);case 6:a=0,s=this.rasterInfo.storageInfo.maximumPyramidLevel,o=s-a+this._levelOffset,l=i.srcLocation;case 10:if(!(o>=0)){e.next=25;break}return e.prev=11,e.next=14,this._tilemapCache.fetchAvailability(o,i.row,i.col,r);case 14:if(e.t0=e.sent,"available"!==e.t0){e.next=17;break}return e.abrupt("break",25);case 17:e.next=21;break;case 19:e.prev=19,e.t1=e.catch(11);case 21:if(o--,a++,null!==(i=this.identifyPixelLocation(l,a,r.datumTransformation))){e.next=23;break}return e.abrupt("return",null);case 23:e.next=10;break;case 25:return e.abrupt("return",-1===o||null==i?null:a);case 26:case"end":return e.stop()}}),e,this,[[11,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchRasterInfo",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,h;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.sourceJSON,"Map"!==this.tileType){e.next=4;break}return i=r.fullExtent||r.extent,a=Math.ceil((i.xmax-i.xmin)/r.pixelSizeX-.1),s=Math.ceil((i.ymax-i.ymin)/r.pixelSizeY-.1),o=Z.Z.fromJSON(r.spatialReference||i.spatialReference),l=new de.Z({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:o}),e.abrupt("return",new N.Z({width:a,height:s,bandCount:3,extent:g.Z.fromJSON(i),spatialReference:o,pixelSize:l,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}}));case 4:return u=t.signal,c=(0,pe.gh)(this.url,this.sourceJSON,{signal:u,query:this.ioConfig.customFetchParameters}),f=r.hasMultidimensions?this.request("".concat(this.url,"/slices"),{query:{f:"json"},signal:u}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.slices})).catch((function(){return null})):null,e.next=9,Promise.all([c,f]);case 9:return h=e.sent,e.abrupt("return",(this._slices=h[1],h[0]));case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fixScaleInServiceInfo",value:function(){var e=this.sourceJSON;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}},{key:"_computeMinMaxLOD",value:function(e,t){var r,n,i,a=e.pixelSize,s=.5/e.width*a.x,o=t.lods,l=t.lodAt(Math.max.apply(null,o.map((function(e){return e.level})))),u=t.lodAt(Math.min.apply(null,o.map((function(e){return e.level})))),c=this.tileType;if("Map"===c)return this._levelOffset=o[0].level,[l,u];if("Raster"===c)return[null!==(i=o.find((function(e){return e.resolution===a.x})))&&void 0!==i?i:l,u];var f=this.sourceJSON,h=f.minScale,p=f.maxScale,d=l;p>0&&(d=o.find((function(e){return Math.abs(e.scale-p)<s})),d||(d=null!==(r=o.filter((function(e){return e.scale>p})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0])&&void 0!==r?r:l));var m=u;return h>0&&(m=null!==(n=o.find((function(e){return Math.abs(e.scale-h)<s})))&&void 0!==n?n:u,this._levelOffset=m.level-u.level),[d,m]}}]),r}(m.Z);function ve(e,t){if(!e)return null;var r=t.minScale,n=t.maxScale,i=t.minLOD,a=t.maxLOD;if(null!=i&&null!=a)return ce.Z.fromJSON((0,P.Z)((0,P.Z)({},e),{},{lods:e.lods.filter((function(e){var t=e.level;return null!=t&&t>=i&&t<=a}))}));if(0!==r&&0!==n){var s=function(e){return Math.round(1e4*e)/1e4},o=r?s(r):1/0,l=n?s(n):-1/0;return ce.Z.fromJSON((0,P.Z)((0,P.Z)({},e),{},{lods:e.lods.filter((function(e){var t=s(e.scale);return t<=o&&t>=l}))}))}return ce.Z.fromJSON(e)}function ye(e){var t=e.extent,r=e.spatialReference;t.xmin>-1&&t.xmax>181&&(null===r||void 0===r?void 0:r.wkid)&&r.isGeographic&&(e.nativeExtent=e.extent,e.transform=new he.Z,e.extent=e.transform.forwardTransform(t))}(0,c._)([(0,f.Cb)({type:String,json:{write:!0}})],me.prototype,"datasetFormat",void 0),(0,c._)([(0,f.Cb)()],me.prototype,"tileType",void 0);var xe=me=(0,c._)([(0,d.j)("esri.layers.support.rasterDatasets.ImageServerRaster")],me),ge=r(60263),be=new Map;be.set("Int8","s8"),be.set("UInt8","u8"),be.set("Int16","s16"),be.set("UInt16","u16"),be.set("Int32","s32"),be.set("UInt32","u32"),be.set("Float32","f32"),be.set("Float64","f32"),be.set("Double64","f32");var ke=new Map;ke.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),ke.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),ke.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),ke.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});var we=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(){var e;return(0,a.Z)(this,r),(e=t.apply(this,arguments))._files=null,e._storageIndex=null,e.datasetFormat="MRF",e}return(0,s.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k,w,Z,I,_,R;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),r=t?t.signal:null,e.next=6,this.request(this.url,{responseType:"xml",signal:r});case 6:if(i=e.sent,a=this._parseHeader(i.data),s=a.rasterInfo,o=a.files,l=this.ioConfig,u=l.skipMapInfo,c=l.skipExtensions,(void 0===c?[]:c).includes("aux.xml")||u){e.next=19;break}return e.next=17,this._fetchAuxiliaryData(t);case 17:null!=(h=e.sent)&&(s.statistics=null!==(f=h.statistics)&&void 0!==f?f:s.statistics,s.histograms=h.histograms,h.histograms&&null==s.statistics&&(s.statistics=(0,E.Oh)(h.histograms)));case 19:return u&&this.updateImageSpaceRasterInfo(s),this._set("rasterInfo",s),this._files=o,e.next=22,this.request(o.index,{responseType:"array-buffer",signal:r});case 22:for(p=e.sent,this._storageIndex=Ze(p.data),d=this.rasterInfo.storageInfo,m=d.blockWidth,v=d.blockHeight,y=this.rasterInfo.storageInfo.pyramidScalingFactor,x=this.rasterInfo,g=x.width,b=x.height,k=[],w=this._getBandSegmentCount(),Z=0,I=-1;Z<this._storageIndex.length;)I++,_=Math.ceil(g/m/Math.pow(y,I))-1,R=Math.ceil(b/v/Math.pow(y,I))-1,Z+=(_+1)*(R+1)*w*4,k.push({maxRow:R,maxCol:_,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=k,I>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=I),this.updateTileInfo();case 28:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,w,Z,I,_,R,S,T,C,M,F,O,P,D,B,N,J=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=J.length>3&&void 0!==J[3]?J[3]:{},s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.blockBoundary,!(!(c=u[t])||c.maxRow<r||c.maxCol<i||c.minRow>r||c.minCol>i)){e.next=4;break}return e.abrupt("return",null);case 4:if(f=this.rasterInfo,h=f.bandCount,p=f.pixelType,d=this._getTileLocation(t,r,i),m=d.ranges,v=d.actualTileWidth,y=d.actualTileHeight,m&&0!==m.length){e.next=7;break}return e.abrupt("return",null);case 7:if(0!==m[0].from||0!==m[0].to){e.next=10;break}return x=new Uint8Array(o*l),e.abrupt("return",new k.Z({width:o,height:l,pixels:void 0,mask:x,validPixelCount:0}));case 10:for(g=this.ioConfig.bandIds,b=this._getBandSegmentCount(),w=[],Z=0,Z=0;Z<b;Z++)g&&!g.includes(Z)||w.push(this.request(this._files.data,{range:{from:m[Z].from,to:m[Z].to},responseType:"array-buffer",signal:a.signal}));return e.next=15,Promise.all(w);case 15:for(I=e.sent,_=I.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),R=new Uint8Array(_),S=[],T=0,Z=0;Z<b;Z++)S.push(T),R.set(new Uint8Array(I[Z].data),T),T+=I[Z].data.byteLength;return C=ke.get(this.rasterInfo.storageInfo.compression).decoderFormat,e.next=24,this.decodePixelBlock(R.buffer,{width:o,height:l,format:C,planes:(null===g||void 0===g?void 0:g.length)||h,offsets:S,pixelType:p});case 24:if(null!=(M=e.sent)){e.next=27;break}return e.abrupt("return",null);case 27:if(null!=(F=this.rasterInfo.noDataValue)&&"lerc"!==C&&!M.mask&&null!=(F=F[0])){if(O=M.width*M.height,P=new Uint8Array(O),Math.abs(F)>1e24)for(Z=0;Z<O;Z++)Math.abs((M.pixels[0][Z]-F)/F)>1e-6&&(P[Z]=1);else for(Z=0;Z<O;Z++)M.pixels[0][Z]!==F&&(P[Z]=1);M.mask=P}if(D=0,B=0,v!==o||y!==l)if(N=M.mask)for(Z=0;Z<l;Z++)if(B=Z*o,Z<y)for(D=v;D<o;D++)N[B+D]=0;else for(D=0;D<o;D++)N[B+D]=0;else for(N=new Uint8Array(o*l),M.mask=N,Z=0;Z<y;Z++)for(B=Z*o,D=0;D<v;D++)N[B+D]=1;return e.abrupt("return",M);case 32:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_getBandSegmentCount",value:function(){return ke.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}},{key:"_getTileLocation",value:function(e,t,r){var n,i,a,s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.pyramidScalingFactor,c=this.rasterInfo,f=c.width,h=c.height,p=this._getBandSegmentCount(),d=0,m=0;for(a=0;a<e;a++)m=Math.pow(u,a),d+=(n=Math.ceil(f/o/m))*(i=Math.ceil(h/l/m));m=Math.pow(u,e),n=Math.ceil(f/o/m),i=Math.ceil(h/l/m),d+=t*n+r,d*=4*p;for(var v=this._storageIndex.subarray(d,d+4*p),y=0,x=0,g=[],b=0;b<p;b++)x=(y=v[4*b]*Math.pow(2,32)+v[4*b+1])+v[4*b+2]*Math.pow(2,32)+v[4*b+3],g.push({from:y,to:x});return{ranges:g,actualTileWidth:r<n-1?o:Math.ceil(f/m)-o*(n-1),actualTileHeight:t<i-1?l:Math.ceil(h/m)-l*(i-1)}}},{key:"_parseHeader",value:function(e){var t=V(e,"MRF_META/Raster");if(!t)throw new o.Z("mrf:open","not a valid MRF format");var r=V(t,"Size"),n=parseInt(r.getAttribute("x"),10),i=parseInt(r.getAttribute("y"),10),a=parseInt(r.getAttribute("c"),10),s=(Y(t,"Compression")||"none").toLowerCase();if(!ke.has(s))throw new o.Z("mrf:open","currently does not support compression "+s);var l=Y(t,"DataType")||"UInt8",u=be.get(l);if(null==u)throw new o.Z("mrf:open","currently does not support pixel type "+l);var c,f,h=V(t,"PageSize"),p=parseInt(h.getAttribute("x"),10),d=parseInt(h.getAttribute("y"),10),m=V(t,"DataValues");if(m&&(null!=(f=m.getAttribute("NoData"))&&(c=f.trim().split(" ").map((function(e){return parseFloat(e)})))),V(e,"MRF_META/CachedSource"))throw new o.Z("mrf:open","currently does not support MRF referencing other data files");var v,y=V(e,"MRF_META/GeoTags"),x=V(y,"BoundingBox"),b=!1;if(null!=x){var k,w=parseFloat(x.getAttribute("minx")),I=parseFloat(x.getAttribute("miny")),_=parseFloat(x.getAttribute("maxx")),R=parseFloat(x.getAttribute("maxy")),S=Y(y,"Projection")||"",T=Z.Z.WGS84;if("LOCAL_CS[]"!==S)if(S.toLowerCase().startsWith("epsg:")){var C=Number(S.slice(5));isNaN(C)||0===C||(T=new Z.Z({wkid:C}))}else T=null!==(k=te(S))&&void 0!==k?k:Z.Z.WGS84;else b=!0,T=new Z.Z({wkid:3857});(v=new g.Z(w,I,_,R)).spatialReference=T}else b=!0,v=new g.Z({xmin:-.5,ymin:.5-i,xmax:n-.5,ymax:.5,spatialReference:new Z.Z({wkid:3857})});var M=V(e,"MRF_META/Rsets"),F=parseInt((null===M||void 0===M?void 0:M.getAttribute("scale"))||"2",10),O=v.spatialReference,P=new ue.Z({origin:new de.Z({x:v.xmin,y:v.ymax,spatialReference:O}),blockWidth:p,blockHeight:d,pyramidBlockWidth:p,pyramidBlockHeight:d,compression:s,pyramidScalingFactor:F}),D=new de.Z({x:v.width/n,y:v.height/i,spatialReference:O}),B=new N.Z({width:n,height:i,extent:v,isPseudoSpatialReference:b,spatialReference:O,bandCount:a,pixelType:u,pixelSize:D,noDataValue:c,storageInfo:P}),J=Y(e,"datafile"),A=Y(e,"IndexFile");return{rasterInfo:B,files:{mrf:this.url,index:A||this.url.replace(".mrf",".idx"),data:J||this.url.replace(".mrf",ke.get(s).blobExtension)}}}},{key:"_fetchAuxiliaryData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,i=r.data,e.abrupt("return",ne(i));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(m.Z);function Ze(e){if(e.byteLength%16>0)throw new Error("invalid array buffer must be multiples of 16");var t,r,n,i,a,s;if(ge.f){for(r=new Uint8Array(e),i=new ArrayBuffer(e.byteLength),n=new Uint8Array(i),a=0;a<e.byteLength/4;a++)for(s=0;s<4;s++)n[4*a+s]=r[4*a+3-s];t=new Uint32Array(i)}else t=new Uint32Array(e);return t}(0,c._)([(0,f.Cb)()],we.prototype,"_files",void 0),(0,c._)([(0,f.Cb)()],we.prototype,"_storageIndex",void 0),(0,c._)([(0,f.Cb)({type:String,json:{write:!0}})],we.prototype,"datasetFormat",void 0);var Ie=we=(0,c._)([(0,d.j)("esri.layers.support.rasterDatasets.MRFRaster")],we),_e=r(17061);function Re(e){var t=e.fields,r=e.records,n=t.some((function(e){return"oid"===e.name.toLowerCase()}))?"OBJECTID":"OID",i=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((function(e){return{name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}}))),a=i.map((function(e){return e.name})),s=[],o=0,l=0;return r.forEach((function(e){var t={};for(t[n]=o++,l=1;l<a.length;l++)t[a[l]]=e[l-1];s.push({attributes:t})})),{displayFieldName:"",fields:i,features:s}}var Se=function(){function e(){(0,a.Z)(this,e)}return(0,s.Z)(e,null,[{key:"supportedVersions",get:function(){return[5]}},{key:"parse",value:function(e){var t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};var n,i=t.getUint32(4,!0),a=t.getUint16(8,!0),s=t.getUint16(10,!0),o={version:r,recordCount:i,headerByteCount:a,recordByteCount:s},l=32,u=[],c=[];if(3===r){for(;13!==t.getUint8(l);)n=String.fromCharCode(t.getUint8(l+11)).trim(),u.push({name:(0,_e.f)(new Uint8Array(e,l,11)),type:n,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(n)],length:t.getUint8(l+16)}),l+=32;if(l+=1,u.length>0)for(var f=function(){var r=[];32===t.getUint8(l)?(l+=1,u.forEach((function(t){if("C"===t.type)r.push((0,_e.f)(new Uint8Array(e,l,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim()));else if("D"===t.type){var n=String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}l+=t.length})),c.push(r)):l+=s};c.length<i&&e.byteLength-l>s;)f()}return{header:o,fields:u,records:c,recordSet:Re({fields:u,records:c})}}}]),e}(),Te=r(58424),Ce=r(92217),Me=function(e,t){var r;return null===(r=e.get(t))||void 0===r?void 0:r.values},Fe=function(e,t){var r,n;return null===(r=e.get(t))||void 0===r||null===(n=r.values)||void 0===n?void 0:n[0]},Oe=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(){var e;return(0,a.Z)(this,r),(e=t.apply(this,arguments))._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}return(0,s.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,l,u,c,f,h,d,m,v,y,x,g,b,k,w,Z,I,_,R,S;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return l=t?t.signal:null,e.next=5,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:l});case 5:if(u=e.sent,c=u.data){e.next=9;break}throw new o.Z("tiffraster:open","failed to open url "+this.url);case 9:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf(".")),f=(0,Te.cK)(c),h=f.littleEndian,d=f.firstIFDPos,m=f.isBigTiff,v=[],e.next=13,this._readIFDs(v,c,h,d,0,m?8:4,l);case 13:if(y=Pe(v),x=y.imageInfo,g=y.rasterInfo,b=(0,Te.ee)(v),k=(0,Te.I7)(v),this._headerInfo=(0,P.Z)({littleEndian:h,isBigTiff:m,ifds:v,pyramidIFDs:b,maskIFDs:k},x),this._set("rasterInfo",g),x.isSupported){e.next=16;break}throw new o.Z("tiffraster:open","this tiff is not supported: "+x.message);case 16:if(x.tileWidth){e.next=18;break}throw new o.Z("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");case 18:if(g.isPseudoSpatialReference&&p.Z.getLogger(this).warn("The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported."),w=null===(r=v[0].get("PREDICTOR"))||void 0===r||null===(i=r.values)||void 0===i?void 0:i[0],3!==(null===(a=v[0].get("SAMPLEFORMAT"))||void 0===a||null===(s=a.values)||void 0===s?void 0:s[0])||2!==w){e.next=22;break}throw new o.Z("tiffraster:open","unsupported horizontal difference encoding. Predictor=3 is supported for floating point data");case 22:if(Z=this.ioConfig,I=Z.skipMapInfo,_=Z.skipExtensions,(R=void 0===_?[]:_).includes("aux.xml")||I){e.next=28;break}return e.next=26,this._fetchAuxiliaryMetaData(t);case 26:null!=(S=e.sent)&&De(S,g);case 28:if(e.t0=R.includes("vat.dbf")||1!==g.bandCount||"u8"!==g.pixelType||I,e.t0){e.next=34;break}return e.next=32,this._fetchAuxiliaryTable(t);case 32:g.attributeTable=e.sent,null!=g.attributeTable&&(g.keyProperties.DataType="thematic");case 34:I&&this.updateImageSpaceRasterInfo(g),this.updateTileInfo();case 36:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=u.length>3&&void 0!==u[3]?u[3]:{},null!==(a=this._headerInfo)&&void 0!==a&&a.isSupported&&!this.isBlockOutside(t,r,i)){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this._fetchRawTiffTile(t,r,i,!1,s);case 5:if(null==(o=e.sent)||!this._headerInfo.hasMaskBand){e.next=11;break}return e.next=9,this._fetchRawTiffTile(t,r,i,!0,s);case 9:null!=(l=e.sent)&&l.pixels[0]instanceof Uint8Array&&(o.mask=l.pixels[0]);case 11:return e.abrupt("return",o);case 12:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_readIFDs",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i,a,s){var o,l,u,c=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=c.length>5&&void 0!==c[5]?c[5]:4,l=c.length>6?c[6]:void 0,a){e.next=4;break}return e.abrupt("return",null);case 4:if(!(a>=r.byteLength||a<0)){e.next=10;break}return e.next=7,this.request(this.url,{range:{from:a+s,to:a+s+this._bufferSize},responseType:"array-buffer",signal:l});case 7:r=e.sent.data,s=a+s,a=0;case 10:return e.next=12,this._readIFD(r,i,a,s,Ce.Z.tiffTags,o,l);case 12:if(u=e.sent,t.push(u.ifd),u.nextIFD){e.next=15;break}return e.abrupt("return",null);case 15:return e.next=17,this._readIFDs(t,r,i,u.nextIFD-s,s,o,l);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"_readIFD",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i,a){var s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k,w=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=w.length>4&&void 0!==w[4]?w[4]:Ce.Z.tiffTags,o=w.length>5&&void 0!==w[5]?w[5]:4,l=w.length>6?w[6]:void 0,t){e.next=5;break}return e.abrupt("return",null);case 5:if(!(u=(0,Te.vr)(t,r,i,a,s,o)).success){e.next=25;break}if(h=[],null!==(c=u.ifd)&&void 0!==c&&c.forEach((function(e){e.values||h.push(e)})),!(h.length>0)){e.next=16;break}if(p=h.map((function(e){return e.offlineOffsetSize})).filter(G.pC),d=Math.min.apply(null,p.map((function(e){return e[0]}))),!(Math.min.apply(null,p.map((function(e){return e[0]+e[1]})))-d<=this._bufferSize)){e.next=16;break}return e.next=13,this.request(this.url,{range:{from:d,to:d+this._bufferSize},responseType:"array-buffer",signal:l});case 13:m=e.sent,v=m.data,t=v,a=d,h.forEach((function(e){return(0,Te.Dq)(t,r,e,a)}));case 16:if(null===(f=u.ifd)||void 0===f||!f.has("GEOKEYDIRECTORY")){e.next=24;break}if(y=u.ifd.get("GEOKEYDIRECTORY"),!((x=null===y||void 0===y?void 0:y.values)&&x.length>4)){e.next=24;break}return g=x[0]+"."+x[1]+"."+x[2],e.next=22,this._readIFD(t,r,y.valueOffset+6-a,a,Ce.Z.geoKeys,2,l);case 22:b=e.sent,y.data=b.ifd,y.data&&y.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[g]});case 24:return e.abrupt("return",u);case 25:if(!u.requiredBufferSize||u.requiredBufferSize===t.byteLength){e.next=30;break}return e.next=28,this.request(this.url,{range:{from:a,to:a+u.requiredBufferSize+4},responseType:"array-buffer",signal:l});case 28:return k=e.sent,e.abrupt("return",(t=k.data).byteLength<u.requiredBufferSize?null:this._readIFD(t,r,0,a,Ce.Z.tiffTags,4,l));case 30:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_fetchRawTiffTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i,a){var s,o,l,u,c,f,h,p,d,m,v,y,x,g,b,k,w,Z,I,_,R,S,T,C,M=this,F=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=F.length>4&&void 0!==F[4]?F[4]:{},o=this._getTileLocation(t,r,i,a)){e.next=4;break}return e.abrupt("return",null);case 4:return l=o.ranges,u=o.actualTileWidth,c=o.actualTileHeight,f=o.ifd,h=l.map((function(e){return M.request(M.url,{range:e,responseType:"array-buffer",signal:s.signal})})),e.next=11,Promise.all(h);case 11:if(p=e.sent,d=p.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),m=1===p.length?p[0].data:new ArrayBuffer(d),v=[0],y=[0],p.length>1)for(x=new Uint8Array(m),g=0,b=0;g<p.length;g++)k=p[g].data,x.set(new Uint8Array(k),b),v[g]=b,b+=k.byteLength,y[g]=k.byteLength;return w=this.getBlockWidthHeight(t),Z=w.blockWidth,I=w.blockHeight,e.next=22,this.decodePixelBlock(m,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:f,offsets:v,sizes:y},width:Z,height:I,planes:null,pixelType:null});case 22:if(null!=(_=e.sent)){e.next=25;break}return e.abrupt("return",null);case 25:if(u!==Z||c!==I)if(C=_.mask)for(R=0;R<I;R++)if(T=R*Z,R<c)for(S=u;S<Z;S++)C[T+S]=0;else for(S=0;S<Z;S++)C[T+S]=0;else for(C=new Uint8Array(Z*I),_.mask=C,R=0;R<c;R++)for(T=R*Z,S=0;S<u;S++)C[T+S]=1;return e.abrupt("return",_);case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_getTileLocation",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=this.rasterInfo.storageInfo,a=i.firstPyramidLevel,s=i.blockBoundary,o=0===e?0:e-(a-1),l=this._headerInfo;if(!l)return null;var u=n?l.maskIFDs[o]:0===o?null===l||void 0===l?void 0:l.ifds[0]:null===l||void 0===l?void 0:l.pyramidIFDs[o-1];if(!u)return null;var c=(0,Te.If)(u,l),f=Me(u,"TILEOFFSETS");if(void 0===f)return null;var h=Me(u,"TILEBYTECOUNTS"),p=s[o],d=p.minRow,m=p.minCol,v=p.maxRow,y=p.maxCol;if(t>v||r>y||t<d||r<m)return null;var x=Fe(u,"IMAGEWIDTH"),g=Fe(u,"IMAGELENGTH"),b=Fe(u,"TILEWIDTH"),k=Fe(u,"TILELENGTH"),w=[];if(c)for(var Z=this.rasterInfo.bandCount,I=0;I<Z;I++){var _=I*(v+1)*(y+1)+t*(y+1)+r;w[I]={from:f[_],to:f[_]+h[_]-1}}else{var R=t*(y+1)+r;w.push({from:f[R],to:f[R]+h[R]-1})}for(var S=0;S<w.length;S++)if(null==w[S].from||!w[S].to||w[S].to<0)return null;return{ranges:w,ifd:u,actualTileWidth:r===y&&x%b||b,actualTileHeight:t===v&&g%k||k}}},{key:"_fetchAuxiliaryMetaData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,i=r.data,e.abrupt("return",ne(i));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryTable",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,i=r.data,a=Se.parse(i),e.abrupt("return",null!==a&&void 0!==a&&a.recordSet?H.Z.fromJSON(a.recordSet):null);case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",null);case 12:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(m.Z);function Pe(e){var t,r,n=(0,Te.FI)(e),i=n.width,a=n.height,s=n.tileWidth,o=n.tileHeight,l=n.planes,u=n.pixelType,c=n.compression,f=n.firstPyramidLevel,h=n.maximumPyramidLevel,p=n.pyramidBlockWidth,d=n.pyramidBlockHeight,m=n.pyramidResolutions,v=n.tileBoundary,y=n.affine,x=n.metadata,b=te((null===(t=n.extent.spatialReference)||void 0===t?void 0:t.wkt)||(null===(r=n.extent.spatialReference)||void 0===r?void 0:r.wkid)),k=!!n.isPseudoGeographic;null==b&&(k=!0,b=new Z.Z({wkid:3857}));var w=new g.Z((0,P.Z)((0,P.Z)({},n.extent),{},{spatialReference:b})),I=new de.Z(w?{x:w.xmin,y:w.ymax,spatialReference:b}:{x:0,y:0}),_=new ue.Z({blockWidth:s,blockHeight:o,pyramidBlockWidth:p,pyramidBlockHeight:d,compression:c,origin:I,firstPyramidLevel:f,maximumPyramidLevel:h,pyramidResolutions:m,blockBoundary:v}),R=new de.Z({x:(w.xmax-w.xmin)/i,y:(w.ymax-w.ymin)/a,spatialReference:b}),S=x?{BandProperties:x.bandProperties,DataType:x.dataType}:{},T=null,C=Fe(e[0],"PHOTOMETRICINTERPRETATION"),M=Me(e[0],"COLORMAP");if(C<=3&&(null===M||void 0===M?void 0:M.length)>3&&M.length%3==0){T=[];for(var F=M.length/3,O=0;O<F;O++)T.push([O,M[O]>>>8,M[O+F]>>>8,M[O+2*F]>>>8])}var D=new N.Z({width:i,height:a,bandCount:l,pixelType:u,pixelSize:R,storageInfo:_,spatialReference:b,isPseudoSpatialReference:k,keyProperties:S,extent:w,colormap:T,statistics:x?x.statistics:null});if(null!==y&&void 0!==y&&y.length&&(D.nativeExtent=new g.Z({xmin:-.5,ymin:.5-a,xmax:i-.5,ymax:.5,spatialReference:b}),D.transform=new $.Z({polynomialOrder:1,forwardCoefficients:[y[2]+y[0]/2,y[5]-y[3]/2,y[0],y[3],-y[1],-y[4]]}),D.extent=D.transform.forwardTransform(D.nativeExtent),D.pixelSize=new de.Z({x:(w.xmax-w.xmin)/i,y:(w.ymax-w.ymin)/a,spatialReference:b}),_.origin.x=-.5,_.origin.y=.5),m){var B=D.pixelSize,J=B.x,A=B.y;m.forEach((function(e){e.x*=J,e.y*=A}))}return{imageInfo:n,rasterInfo:D}}function De(e,t){var r;if(t.statistics=null!==(r=e.statistics)&&void 0!==r?r:t.statistics,t.histograms=e.histograms,e.histograms&&null==t.statistics&&(t.statistics=(0,E.Oh)(e.histograms)),e.transform&&null==t.transform){t.transform=e.transform,t.nativeExtent=t.extent;var n=t.transform.forwardTransform(t.nativeExtent);t.pixelSize=new de.Z({x:(n.xmax-n.xmin)/t.width,y:(n.ymax-n.ymin)/t.height,spatialReference:t.spatialReference}),t.extent=n}t.isPseudoSpatialReference&&e.spatialReference&&(t.spatialReference=e.spatialReference,t.extent.spatialReference=t.nativeExtent.spatialReference=t.storageInfo.origin.spatialReference=t.spatialReference)}(0,c._)([(0,f.Cb)()],Oe.prototype,"_files",void 0),(0,c._)([(0,f.Cb)()],Oe.prototype,"_headerInfo",void 0),(0,c._)([(0,f.Cb)()],Oe.prototype,"_bufferSize",void 0),(0,c._)([(0,f.Cb)({type:String,json:{write:!0}})],Oe.prototype,"datasetFormat",void 0);var Be=Oe=(0,c._)([(0,d.j)("esri.layers.support.rasterDatasets.TIFFRaster")],Oe),Ne=new Map;Ne.set("MRF",{desc:"Meta Raster Format",constructor:Ie}),Ne.set("TIFF",{desc:"GeoTIFF",constructor:Be}),Ne.set("RasterTileServer",{desc:"Raster Tile Server",constructor:xe}),Ne.set("JPG",{desc:"JPG Raster Format",constructor:se}),Ne.set("PNG",{desc:"PNG Raster Format",constructor:se}),Ne.set("GIF",{desc:"GIF Raster Format",constructor:se}),Ne.set("BMP",{desc:"BMP Raster Format",constructor:se}),Ne.set("CovJSON",{desc:"COVJSON Raster Format",constructor:q}),Ne.set("MEMORY",{desc:"In Memory Raster Format",constructor:L});var Je=function(){function e(){(0,a.Z)(this,e)}return(0,s.Z)(e,null,[{key:"supportedFormats",get:function(){var e=new Set;return Ne.forEach((function(t,r){return e.add(r)})),e}},{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,l,u,c,f,h,p,d,m;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.url,s=t.ioConfig,l=t.source,u=t.sourceJSON,null==(c=null!==(r=t.datasetFormat)&&void 0!==r?r:null===s||void 0===s?void 0:s.datasetFormat)&&(a.includes(".")?c=a.slice(a.lastIndexOf(".")+1).toUpperCase():"coverage"===(null===l||void 0===l||null===(i=l.type)||void 0===i?void 0:i.toLowerCase())?c="CovJSON":(null===l||void 0===l?void 0:l.extent)&&l.pixelblocks&&(c="MEMORY")),"OVR"===c||"TIF"===c?c="TIFF":"JPG"===c||"JPEG"===c||"JFIF"===c?c="JPG":"COVJSON"===c&&(c="CovJSON"),a.toLowerCase().includes("/imageserver")&&!a.toLowerCase().includes("/wcsserver")&&(c="RasterTileServer"),f={url:a,source:l,sourceJSON:u,datasetFormat:c,ioConfig:null!==s&&void 0!==s?s:{bandIds:null,sampling:null}},Object.keys(f).forEach((function(e){null==f[e]&&delete f[e]})),!c){e.next=13;break}if(this.supportedFormats.has(c)){e.next=7;break}throw new o.Z("rasterfactory:open","not a supported format "+c);case 7:if("CRF"!==c){e.next=9;break}throw new o.Z("rasterfactory:open","cannot open raster: ".concat(a));case 9:return h=new(0,Ne.get(c).constructor)(f),e.next=12,h.open({signal:t.signal});case 12:return e.abrupt("return",h);case 13:return p=Array.from(Ne.keys()).filter((function(e){return"CovJSON"!==e&&"Memory"!==e})),d=0,m=function e(){if(!(c=p[d++]))return null;if("CRF"===c)return null;var r=new(0,Ne.get(c).constructor)(f);return r.open({signal:t.signal}).then((function(){return r})).catch((function(){return e()}))},e.abrupt("return",m());case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(e,t,r){Ne.has(e.toUpperCase())||Ne.set(e.toUpperCase(),{desc:t,constructor:r})}}]),e}()},55635:function(e,t,r){r.d(t,{OE:function(){return p},Gc:function(){return v},Qg:function(){return d},Rq:function(){return c},gX:function(){return m},z2:function(){return f},ET:function(){return h},Vx:function(){return x}});r(59486);var n=r(15671),i=r(43144),a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;(0,n.Z)(this,e),this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,r)}return(0,i.Z)(e,[{key:"decreaseRefCount",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var i=n.get(r);return i.refCount--,i.refCount<=0&&(n.delete(r),i.controller&&i.controller.abort()),i.refCount}return 0}},{key:"getBlock",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var i=n.get(r);return i.ts=Date.now(),i.refCount++,n.delete(r),n.set(r,i),i.block}return null}},{key:"putBlock",value:function(e,t,r,n){var i=this._cachedBlocks,a=e+"/"+t;if(i.has(a)){var s=i.get(a);s.ts=Date.now(),s.refCount++}else i.set(a,{block:r,ts:Date.now(),refCount:1,controller:n});this._trim(),this._updateTimer()}},{key:"deleteBlock",value:function(e,t){var r=this._cachedBlocks,n=e+"/"+t;r.has(n)&&r.delete(n)}},{key:"updateMaxSize",value:function(e){this._size=e,this._trim()}},{key:"empty",value:function(){this._cachedBlocks.clear(),this._clearTimer()}},{key:"getCurrentSize",value:function(){return this._cachedBlocks.size}},{key:"_updateTimer",value:function(){var e=this;if(null==this._timer){var t=this._cachedBlocks;this._timer=setInterval((function(){for(var r=Array.from(t),n=Date.now(),i=0;i<r.length&&r[i][1].ts<=n-e._duration;i++)t.delete(r[i][0]);0===t.size&&e._clearTimer()}),this._interval)}}},{key:"_trim",value:function(){var e=this._cachedBlocks;if(!(-1===this._size||this._size>=e.size))for(var t=Array.from(e),r=0;r<t.length-this._size;r++)e.delete(t[r][0])}},{key:"_clearTimer",value:function(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}]),e}(),s=r(80394),o=r(848),l=new Map,u=new a;function c(e,t){return null==t?e:"".concat(e,"?sliceId=").concat(t)}function f(e,t){var r={extent:null,rasterInfo:t,cache:new Map},n=l.get(e);return n?(n.push(r),n.length-1):(l.set(e,[r]),0)}function h(e,t){var r=l.get(e);r&&(r[t]=null,r.some((function(e){return null!=e}))||l.delete(e))}function p(e,t,r){var n,i=l.get(e);if(!i)return null==t?u.decreaseRefCount(e,r):0;if(null==t||null==i[t])return u.decreaseRefCount(e,r);var a=null===(n=i[t])||void 0===n?void 0:n.cache,s=null===a||void 0===a?void 0:a.get(r);if(a&&s){if(s.refCount--,0===s.refCount){a.delete(r);for(var o=0;o<i.length;o++){var c;null===(c=i[o])||void 0===c||c.cache.delete(r)}s.controller&&s.controller.abort()}return s.refCount}return 0}function d(e,t,r){var n,i=l.get(e);if(!i)return null==t?u.getBlock(e,r):null;if(null==t||null==i[t]){for(var a=0;a<i.length;a++){var s,o=null===(s=i[a])||void 0===s?void 0:s.cache.get(r);if(o)return o.refCount++,o.block}return u.getBlock(e,r)}var c=null===(n=i[t])||void 0===n?void 0:n.cache.get(r);if(c)return c.refCount++,c.block;for(var f=0;f<i.length;f++){var h;if(f!==t&&i[f]){var p=null===(h=i[f])||void 0===h?void 0:h.cache,d=null===p||void 0===p?void 0:p.get(r);if(p&&d)return d.refCount++,p.set(r,d),d.block}}return null}function m(e,t,r,n){var i,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=l.get(e);if(s)if(null!=t&&null!=s[t]){var o={refCount:1,block:n,isResolved:!1,isRejected:!1,controller:a};n.then((function(){return o.isResolved=!0})).catch((function(){return o.isRejected=!0})),null===(i=s[t])||void 0===i||i.cache.set(r,o)}else u.putBlock(e,r,n,a);else null==t&&u.putBlock(e,r,n,a)}function v(e,t,r){var n,i=l.get(e);i?null!=t&&null!=i[t]?null===(n=i[t])||void 0===n||n.cache.delete(r):u.deleteBlock(e,r):null==t&&u.deleteBlock(e,r)}function y(e,t){var r,n=l.get(e);return n&&null!==(r=n[t])&&void 0!==r?r:null}function x(e,t,r,n,i,a){var l,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=y(e,t);if(c){var f=c.extent,h=c.cache,p=c.rasterInfo;if(!f||f.xmin!==r.xmin||f.xmax!==r.xmax||f.ymin!==r.ymin||f.ymax!==r.ymax){n=null!==(l=n)&&void 0!==l?l:0;for(var d=r.clone().normalize(),m=p.spatialReference,v=p.transform,x=new Set,g=0;g<d.length;g++){var b=d[g];if(!(b.xmax-b.xmin<=n||b.ymax-b.ymin<=n)){var k=(0,s.tB)(b,m,u);null!=v&&(k=v.inverseTransform(k));var w=new o.Z({x:n,y:n,spatialReference:b.spatialReference});if(null==i&&!(i=(0,s.VO)(w,m,b,u)))return;var Z=(0,s.kr)(i,p,a||"closest"),I=Z.pyramidLevel,_=Z.pyramidResolution,R=Z.excessiveReading;if(R)return;for(var S=p.storageInfo,T=S,C=T.origin,M={x:Math.max(0,Math.floor((k.xmin-C.x)/_.x)),y:Math.max(0,Math.floor((C.y-k.ymax)/_.y))},F=Math.ceil((k.xmax-k.xmin)/_.x-.1),O=Math.ceil((k.ymax-k.ymin)/_.y-.1),P=I>0?S.pyramidBlockWidth:S.blockWidth,D=I>0?S.pyramidBlockHeight:S.blockHeight,B=1,N=Math.max(0,Math.floor(M.x/P)-B),J=Math.max(0,Math.floor(M.y/D)-B),A=Math.floor((M.x+F-1)/P)+B,E=Math.floor((M.y+O-1)/D)+B,z=J;z<=E;z++)for(var L=N;L<=A;L++)x.add("".concat(I,"/").concat(z,"/").concat(L))}}h.forEach((function(e,t){if(!x.has(t)){var r=h.get(t);(null==r||r.isResolved||r.isRejected)&&h.delete(t)}})),c.extent={xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax}}}}}}]);
//# sourceMappingURL=23842.17b10af0.chunk.js.map