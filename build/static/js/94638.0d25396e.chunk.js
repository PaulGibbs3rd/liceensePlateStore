"use strict";(self.webpackChunkreact_training=self.webpackChunkreact_training||[]).push([[94638],{50690:function(e,t,n){n.d(t,{A:function(){return p},a:function(){return m},b:function(){return _}});var i,r,a,o=n(30168),s=n(43144),l=n(15671),u=n(60136),c=n(29388),h=n(24967),d=n(98634),f=n(64201),v=n(19253),p=function(e){(0,u.Z)(n,e);var t=(0,c.Z)(n);function n(){return(0,l.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n)}(d.K);function _(e){var t=new f.kG;t.include(h.k),t.fragment.uniforms.add(new v.A("colorTexture",(function(e){return e.color})),new v.A("depthTexture",(function(e){return e.depth})));var n=e.haze;return t.fragment.code.add((0,d.H)(i||(i=(0,o.Z)(["\n    void main() {\n      float depthSample = texture(depthTexture, uv).r;\n      if (depthSample "," ) {\n          fragColor = vec4(0);\n          return;\n      }\n      fragColor = texture(colorTexture, uv);\n    }\n    "])),n?(0,d.H)(r||(r=(0,o.Z)(["== 1.0"]))):(0,d.H)(a||(a=(0,o.Z)(["!= 1.0"]))))),t}var m=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:p,build:_},Symbol.toStringTag,{value:"Module"}))},86868:function(e,t,n){n.d(t,{B:function(){return y},a:function(){return s},b:function(){return g}});var i,r,a,o,s,l=n(30168),u=n(91835),c=n(8966),h=n(63434),d=n(32426),f=n(49450),v=n(58406),p=n(98634),_=n(64201),m=n(19253);function g(e){var t=new _.kG,n=t.fragment;if(t.include(d.T),e.background===s.Only){var g=e.output===c.l.ColorComposite;return g?n.uniforms.add(new f.J("backgroundColor",(function(e){return e.backgroundColor}))):n.include(u.H),n.code.add((0,p.H)(i||(i=(0,l.Z)(["\n      void main() {\n        fragColor = vec4(",", 1.0);\n      }\n    "])),g?(0,p.H)(r||(r=(0,l.Z)(["backgroundColor"]))):(0,p.H)(a||(a=(0,l.Z)(["gridColor(uv)"]))))),t}return t.include(h.J,e),n.uniforms.add(new m.A("tex",(function(e){return e.texture})),new v.p("opacity",(function(e){return e.opacity}))).code.add((0,p.H)(o||(o=(0,l.Z)(["void main() {\nfragColor = blendLayers(uv, texture(tex, uv), opacity);\n}"])))),t}!function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(s||(s={}));var y=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return s},build:g},Symbol.toStringTag,{value:"Module"}))},98757:function(e,t,n){n.d(t,{B:function(){return d},b:function(){return h}});var i,r=n(30168),a=n(24967),o=n(98634),s=n(64201),l=n(19253),u=8,c=16;function h(){var e=new s.kG;return e.include(a.k),e.fragment.uniforms.add(new l.A("edgesTexture",(function(e){return e.inputTexture})),new l.A("areaTexture",(function(e){return e.areaTexture})),new l.A("searchTexture",(function(e){return e.searchTexture}))),e.fragment.code.add((0,o.H)(i||(i=(0,r.Z)(["\n    #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )\n    #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )\n\n    vec4 sampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset, vec2 resolution) {\n      return texture(tex, coord + offset.x * resolution, 0.0);\n    }\n\n    float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {\n      e.r = bias + e.r * scale;\n      return 255.0 * texture( searchTex, e, 0.0 ).r;\n    }\n\n    float searchLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 0.0, 1.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord -= vec2( 2.0, 0.0 ) * resolution;\n        if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n      }\n      texcoord.x += 0.25 * resolution.x;\n      texcoord.x += resolution.x;\n      texcoord.x += 2.0 * resolution.x;\n      texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);\n      return texcoord.x;\n    }\n\n    float searchRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 0.0, 1.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord += vec2( 2.0, 0.0 ) * resolution;\n        if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n      }\n      texcoord.x -= 0.25 * resolution.x;\n      texcoord.x -= resolution.x;\n      texcoord.x -= 2.0 * resolution.x;\n      texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );\n      return texcoord.x;\n    }\n\n    float searchUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 1.0, 0.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord += vec2( 0.0, 2.0 ) * resolution;\n        if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n      }\n      texcoord.y -= 0.25 * resolution.y;\n      texcoord.y -= resolution.y;\n      texcoord.y -= 2.0 * resolution.y;\n      texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );\n      return texcoord.y;\n    }\n\n    float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 1.0, 0.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * resolution;\n        if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n      }\n      texcoord.y += 0.25 * resolution.y;\n      texcoord.y += resolution.y;\n      texcoord.y += 2.0 * resolution.y;\n      texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );\n      return texcoord.y;\n    }\n\n    vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {\n      vec2 texcoord = float( "," ) * round( 4.0 * vec2( e1, e2 ) ) + dist;\n      texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );\n      texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;\n      return texture( areaTex, texcoord, 0.0 ).rg;\n    }\n\n    void main() {\n      vec2 size = vec2(textureSize(edgesTexture, 0));\n      vec2 resolution = 1.0 / size;\n      vec2 pixelCoord = uv * size;\n      vec4 offsets[2];\n      offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );\n      offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );\n      vec4 maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( "," );\n\n      ivec4 subsampleIndices = ivec4(0.0);\n      vec4 weights = vec4(0.0);\n      vec2 e = texture( edgesTexture, uv ).rg;\n      if ( e.g > 0.0 ) {\n        vec2 d;\n        vec2 coords;\n        coords.x = searchLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x, resolution );\n        coords.y = offsets[1].y;\n        d.x = coords.x;\n        float e1 = texture( edgesTexture, coords, 0.0 ).r;\n        coords.x = searchRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y, resolution );\n        d.y = coords.x;\n        d = d * size.x - pixelCoord.x;\n        vec2 sqrt_d = sqrt( abs(d) );\n        coords.y -= 1.0 * resolution.y;\n        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ), resolution).r;\n        weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );\n      }\n\n      if ( e.r > 0.0 ) {\n        vec2 d;\n        vec2 coords;\n        coords.y = searchUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z, resolution );\n        coords.x = offsets[0].x;\n        d.x = coords.y;\n        float e1 = texture( edgesTexture, coords, 0.0 ).g;\n        coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w, resolution );\n        d.y = coords.y;\n        d = d * size.y - pixelCoord.y;\n        vec2 sqrt_d = sqrt(abs(d));\n        coords.y -= 1.0 * resolution.y;\n        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0), resolution).g;\n        weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );\n\n        // for some reason the following lines are necessary to prevent\n        // texture lookup precision issues on some Intel integrated graphics chips\n        vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);\n        weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);\n      }\n      fragColor = weights;\n    }"])),o.H.int(u),o.H.int(u),o.H.int(u),o.H.int(u),o.H.int(c),o.H.int(u))),e}var d=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},40051:function(e,t,n){n.d(t,{B:function(){return c},b:function(){return u}});var i,r=n(30168),a=n(24967),o=n(98634),s=n(64201),l=n(19253);function u(){var e=new s.kG;return e.include(a.k),e.fragment.uniforms.add(new l.A("blendWeightsTexture",(function(e){return e.inputTexture})),new l.A("colorTexture",(function(e){return e.color}))),e.fragment.code.add((0,o.H)(i||(i=(0,r.Z)(["void main() {\nvec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));\nvec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);\nvec4 a;\na.rb = texture(blendWeightsTexture, uv).rb;\na.g = texture(blendWeightsTexture, offsets.zw).g;\na.a = texture(blendWeightsTexture, offsets.xy).a;\nif ( dot(a, vec4(1.0)) < 1e-5 ) {\nfragColor = texture( colorTexture, uv, 0.0 );\n} else {\nvec2 offset;\noffset.x = a.a > a.b ? a.a : -a.b;\noffset.y = a.g > a.r ? -a.g : a.r;\nif ( abs( offset.x ) > abs( offset.y )) {\noffset.y = 0.0;\n} else {\noffset.x = 0.0;\n}\nvec4 C = texture( colorTexture, uv, 0.0 );\nvec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );\nfloat s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );\nfragColor = mix(C, Cop, s);\n}\n}"])))),e}var c=Object.freeze(Object.defineProperty({__proto__:null,build:u},Symbol.toStringTag,{value:"Module"}))},39073:function(e,t,n){n.d(t,{C:function(){return j},a:function(){return B},b:function(){return V}});var i,r,a,o,s,l,u,c,h,d,f,v,p,_,m,g,y,b,w,C,x=n(30168),T=n(29134),S=n(7025),k=n(12400),M=n(5461),P=n(60113),R=n(54943),E=n(29202),O=n(92395),A=n(82999),D=n(49450),Z=n(95276),I=n(58406),L=n(98634),N=n(8654),U=n(64201),H=n(19253),F=n(4760),V=(0,k.al)(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),z=(0,k.al)(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),q=(0,k.al)(parseFloat(Number(V[0]+z[0]).toFixed(6)),parseFloat(Number(V[1]+z[1]).toFixed(6)),parseFloat(Number(V[2]+z[2]).toFixed(6)));function B(e){var t=new U.kG;t.attributes.add(F.T.POSITION,"vec2"),t.include(P.D,{textureCoordinateType:P.N.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");var n=t.vertex,S=t.fragment;return n.uniforms.add(new N.g("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new N.g("inverseViewMatrix",(function(e,t){return(0,T.iS)(G,t.camera.viewMatrix)}))),n.code.add((0,L.H)(i||(i=(0,x.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),S.uniforms.add(new D.J("backgroundColor",(function(e){return e.backgroundColor})),new A.A("radii",(function(e){return e.radii})),new D.J("cameraPosition",(function(e,t){return t.camera.eye})),new Z.N("heightParameters",(function(e){return e.heightParameters})),new I.p("innerFadeDistance",(function(e){return e.innerFadeDistance})),new I.p("altitudeFade",(function(e){return e.altitudeFade})),new H.A("depthTexture",(function(e){return e.depthTexture})),new I.p("hazeStrength",(function(e){return e.hazeStrength}))),S.constants.add("betaRayleigh","vec3",V),S.constants.add("betaCombined","vec3",q),S.constants.add("betaMie","float",3996e-9),S.constants.add("scaleHeight","float",M.TR*M.k8),(0,O.Pe)(S),t.include(E.D),e.haze&&S.include(R.K),S.code.add((0,L.H)(r||(r=(0,x.Z)(["vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = planet ? heightParameters[1] - radius * radius : heightParameters[2];\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),S.code.add((0,L.H)(a||(a=(0,x.Z)(["float chapmanApproximation(float X, float h, float cosZenith) {\nfloat c = sqrt(X + h);\nfloat cExpH = c * exp(-h);\nif (cosZenith >= 0.0) {\nreturn cExpH / (c * cosZenith + 1.0);\n} else {\nfloat x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);\nfloat c0 = sqrt(x0);\nreturn 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);\n}\n}"])))),S.code.add((0,L.H)(o||(o=(0,x.Z)(["float getOpticalDepth(vec3 position, vec3 dir, float h) {\nreturn scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));\n}"])))),S.code.add((0,L.H)(s||(s=(0,x.Z)(["\n    const int STEPS = 6;\n\n    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {\n      float reducedPlanetRadius = radii[0] - 20000.0;\n      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);\n      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);\n      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;\n      bool insideAtmosphere = heightParameters[0] < radii[1];\n\n      if (!(hitsAtmosphere || insideAtmosphere)) {\n        return vec3(0);\n      }\n\n      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;\n\n      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;\n\n      if (heightParameters[0] < reducedPlanetRadius) {\n        // Long light rays from the night side of the planet lead to numerical instability\n        // Do not render the atmosphere in such cases\n        if (dot(rayDir, normalize(cameraPos)) < -0.025) {\n          return vec3(0);\n        }\n        start = rayPlanetIntersect.y;\n      }\n\n      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;\n      float maxEnd = end;\n\n      ","\n\n      vec3 samplePoint = cameraPos + rayDir * end;\n      float multiplier = hitsPlanet ? -1.0 : 1.0;\n\n      vec3 scattering = vec3(0);\n      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);\n      float stepSize = (end - start) / float(STEPS);\n      for (int i = 0; i < STEPS; i++) {\n        samplePoint -= stepSize * rayDir;\n        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);\n\n        if (i > 0) {\n          scattering *= "," exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));\n        }\n\n        if (dot(normalize(samplePoint), lightDir) > -0.3) {\n\n          float scale = exp(-scaleFract);\n          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);\n\n          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);\n          ","\n        }\n\n        lastOpticalDepth = opticalDepth;\n\n      }\n\n      float mu = dot(rayDir, lightDir);\n      float mumu = 1.0 + mu * mu;\n\n      float phaseRayleigh = 0.0596831 * mumu;\n\n      ","\n    }\n\n    ","\n\n    ","\n\n    vec3 tonemapACES(vec3 x) {\n      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n    }\n\n    void main() {\n      vec3 rayDir = normalize(worldRay);\n      float terrainDepth = -1.0;\n      ","\n\n      ","\n\n      col = tonemapACES(col);\n      fragColor = delinearizeGamma(vec4(col, alpha));\n      ","\n    }\n  "])),e.haze?(0,L.H)(l||(l=(0,x.Z)(["if (terrainDepth != -1.0) { end = terrainDepth; }"]))):"",e.haze?"":(0,L.H)(u||(u=(0,x.Z)(["mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "]))),e.haze?"":(0,L.H)(c||(c=(0,x.Z)(["scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);"]))),e.haze?(0,L.H)(h||(h=(0,x.Z)(["return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;"]))):(0,L.H)(d||(d=(0,x.Z)(["\n            const float g = 0.8;\n            const float gg = g * g;\n            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;\n            phaseMie = clamp(phaseMie, 0.0, 128.0);\n            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);"]))),e.haze?"":(0,L.H)(f||(f=(0,x.Z)(["\n            vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {\n              vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);\n              if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {\n                return fragColor;\n              }\n\n              float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));\n              vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);\n              float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;\n              if (relDist > 1.0) {\n                return surfaceColor;\n              }\n\n              return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));\n            }\n\n            float getGlow(float dist, float radius, float intensity) {\n              return pow(radius / max(dist, 1e-6), intensity);\n            }\n\n            vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){\n\n              // Get the amount of atmosphere between camera and the Sun along the view ray\n              float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;\n              float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));\n\n              // Find the amount of light that remains after travelling through the atmosphere from the Sun along the view ray\n              // This will make the colour of the Sun reddish on the horizon and white from space\n              vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));\n\n              // Alignment of light direction and view ray\n              float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);\n              // Draw the Sun as a bright disc\n              float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));\n\n              return normalize(sunTransmittance) * sunDisc;\n            }"]))),e.haze&&e.reduced?(0,L.H)(v||(v=(0,x.Z)(["\n        float getDepth(vec2 uv){\n          return linearDepthFromTexture(depthTexture, uv);\n        }\n\n        float textureBilinear(vec2 uv) {\n          // Information about the high-resolution depth texture\n          vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));\n          vec2 texelSize = 1.0 / depthTextureSize;\n\n          // The uv inside the upper right pixel - of the tile of 4 pixels -\n          // that the atmosphere uv maps to in the depth texture\n          vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);\n\n          // Relative distance of the uv coordinates inside the depth texture pixel\n          vec2 f = fract(depthUV);\n\n          // Snap to the centre of the depth texture pixel\n          vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;\n\n          // Read the depth texture pixel and its three neighbours\n          float d0 = getDepth(snapUV);\n          float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));\n          float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));\n          float d3 = getDepth(snapUV + texelSize);\n\n          // Return the bilinearly interpolated value of the neighbouring pixels based\n          // on the sample position in the depth texture pixel\n          return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);\n        }\n        "]))):"",e.haze?(0,L.H)(p||(p=(0,x.Z)(["\n          float depthSample = texture(depthTexture, vuv0).r;\n          if (depthSample != 1.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n\n              ","\n\n            terrainDepth = max(0.0, length(cameraSpaceRay));\n          }else{\n            discard;\n          }\n          "])),e.reduced?(0,L.H)(_||(_=(0,x.Z)(["cameraSpaceRay *= -textureBilinear(vuv0);"]))):(0,L.H)(m||(m=(0,x.Z)(["cameraSpaceRay *= -linearDepthFromTexture(depthTexture, vuv0);"])))):(0,L.H)(g||(g=(0,x.Z)(["",""])),e.reduced?"":(0,L.H)(y||(y=(0,x.Z)(["\n                float depthSample = texture(depthTexture, vuv0).r;\n                if (depthSample != 1.0) {\n                  fragColor = vec4(0);\n                  return;\n                }"])))),e.haze?(0,L.H)(b||(b=(0,x.Z)(["\n            vec3 col = vec3(0);\n            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);\n            if(depthSample != 1.0){\n              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);\n            }\n            // Alpha is ignored for haze blending\n            float alpha = 1.0;\n            "]))):(0,L.H)(w||(w=(0,x.Z)(["\n            vec3 col = linearizeGamma(backgroundColor);\n            col += getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);\n            col += getSun(cameraPosition, rayDir, mainLightDirection);\n            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));"]))),e.haze?"":(0,L.H)(C||(C=(0,x.Z)(["fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);"]))))),t}var G=(0,S.Ue)(),j=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:V,build:B},Symbol.toStringTag,{value:"Module"}))},50703:function(e,t,n){n.d(t,{C:function(){return A},a:function(){return I},b:function(){return D}});var i,r,a,o,s,l,u,c,h,d,f=n(30168),v=n(43144),p=n(15671),_=n(60136),m=n(29388),g=n(16889),y=n(21389),b=n(13611),w=n(6644),C=n(12658),x=n(20460),T=n(68820),S=n(24967),k=n(82999),M=n(58406),P=n(98634),R=n(35522),E=n(64201),O=n(19253),A=function(e){(0,_.Z)(n,e);var t=(0,m.Z)(n);function n(){var e;return(0,p.Z)(this,n),(e=t.apply(this,arguments)).cloudRadius=0,e.cloudSize=0,e.detailSize=0,e.absorption=0,e.density=0,e.smoothness=0,e.cloudHeight=0,e.coverage=0,e.raymarchingSteps=C.L.default.raymarchingSteps,e.weatherTile=(0,w.Ue)(),e.viewMatrix=(0,y.Ue)(),e}return(0,v.Z)(n)}(P.K);function D(e){var t=new E.kG;t.include(S.k,!1);var n=t.fragment;return n.uniforms.add(new M.p("cloudRadius",(function(e){return e.cloudRadius})),new M.p("power",(function(e){return(0,g.t7)(35,120,e.absorption)})),new M.p("sigmaE",(function(e){return 1+e.absorption})),new M.p("density",(function(e){return(0,g.t7)(0,.3,e.density)})),new M.p("cloudSize",(function(e){return(0,g.t7)(0,.02,Math.max(.01,1-e.cloudSize))})),new M.p("detailSize",(function(e){return(0,g.t7)(0,.2,Math.max(.01,1-e.detailSize))})),new M.p("smoothness",(function(e){return(0,g.t7)(0,.5,1-e.smoothness)})),new M.p("cloudHeight",(function(e){return(0,g.t7)(0,1500,e.cloudHeight)})),new M.p("coverage",(function(e){return e.coverage})),new R.c("view",(function(e){return e.viewMatrix})),new O.A("cloudShapeTexture",(function(e){return null!=e.noiseTexture?e.noiseTexture.textureAtlas:null})),new k.A("cloudVariables",(function(e){return(0,b.t8)(Z,e.coverage,e.absorption)}))),n.constants.add("halfCubeMapSize","float",.5*e.cubeMapSize),n.code.add((0,P.H)(i||(i=(0,f.Z)(["\n    const int STEPS = ",";\n    const int STEPS_LIGHT = 6;\n    const float stepL = 300.0 / float(STEPS_LIGHT);\n    const float cloudStart = 1500.0;\n\n    vec3 rayDirection(vec2 fragCoord) {\n      vec2 xy = fragCoord - halfCubeMapSize;\n      return normalize(vec3(-xy, -halfCubeMapSize));\n    }\n\n    float remap(float x, float low1, float high1, float low2, float high2) {\n      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n    }\n\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }"])),e.steps===x.p.SIXTEEN?(0,P.H)(r||(r=(0,f.Z)(["16"]))):e.steps===x.p.HUNDRED?(0,P.H)(a||(a=(0,f.Z)(["100"]))):(0,P.H)(o||(o=(0,f.Z)(["200"]))))),n.code.add((0,P.H)(s||(s=(0,f.Z)(["\n    float getCloudShape(vec3 pos, float pOffset) {\n      const float textureWidth = ",";\n      const float dataWidth = ",";\n      const float tileRows = ",";\n      const vec3 atlasDimensions = vec3(",", ",", tileRows * tileRows);\n\n      //Change from Y being height to Z being height\n      vec3 p = float(",") * pos.xzy;\n\n      //Pixel coordinates of point in the 3D data\n      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));\n      float f = fract(coord.z);\n      float level = floor(coord.z);\n      float tileY = floor(level / tileRows);\n      float tileX = level - tileY * tileRows;\n\n      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column\n      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;\n      vec2 pixel = coord.xy + offset;\n      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;\n\n      return 1.0 - mix(data.x, data.y, f);\n    }\n\n    float getCloudMap(vec2 p){\n      // Shift the texture center to origin to avoid seam artifacts\n      vec2 uv = ("," * p) / "," + 0.5;\n\n      return texture(cloudShapeTexture, uv).a;\n    }\n    "])),P.H.float(T.a5),P.H.float(T.a5),P.H.float(T.CB),P.H.float(T.i9),P.H.float(T.i9),P.H.float(T.Mw),P.H.float(T.H6),P.H.float(T.a5))),n.code.add((0,P.H)(l||(l=(0,f.Z)(["float clouds(vec3 p) {\nfloat cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat cloudMap = getCloudMap(cloudSize * p.xy);\ncloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat shape = getCloudShape(8.0 * cloudSize * p, 0.0);\ncloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);\ncloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nreturn density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));\n}"])))),n.code.add((0,P.H)(u||(u=(0,f.Z)(["vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = dot(start, start) - (radius * radius);\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}\nfloat HenyeyGreenstein(float g, float costh) {\nreturn (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));\n}"])))),n.code.add("\n    float multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      float luminance = 0.0;\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),n.code.add((0,P.H)(c||(c=(0,f.Z)(["float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {\nfloat lightRayDensity = clouds(p);\nlightRayDensity += clouds(p + sunDirection * 1.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 2.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 3.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 4.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 5.0 * stepL);\nfloat beersLaw = multipleOctaves(lightRayDensity, mu, stepL);\nreturn mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);\n}"])))),n.code.add((0,P.H)(h||(h=(0,f.Z)(["float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {\nif (dir.z < 0.0) {\nreturn 0.0;\n}\ntotalTransmittance = 1.0;\nfloat stepS = totalDistance / float(STEPS);\nfloat cameraHeight = length(org);\nfloat mu = 0.5 + 0.5 * dot(sunDirection, dir);\nfloat phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);\nvec3 p = org + distToStart  * dir;\nfloat dist = distToStart;\nfloat shading = 0.0;\nfor (int i = 0; i < STEPS; i++) {\nfloat sampleDensity = clouds(p);\nfloat sampleSigmaE = sampleDensity * sigmaE;\nif (sampleDensity > 0.0 ) {\nfloat ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));\nfloat luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));\nfloat transmittance = exp(-sampleSigmaE * stepS);\nshading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;\ntotalTransmittance *= transmittance;\nif (totalTransmittance <= 0.001) {\ntotalTransmittance = 0.0;\nbreak;\n}\n}\ndist += stepS;\np = org + dir * dist;\n}\nreturn shading;\n}"])))),n.code.add((0,P.H)(d||(d=(0,f.Z)(["void main() {\nif (coverage ==  0.0) {\nfragColor = vec4(0.0, 1.0, 0.0, 1.0);\nreturn;\n}\nvec3 rayDir = rayDirection(gl_FragCoord.xy);\nrayDir = normalize(view * rayDir);\nvec3 viewPos = vec3(0, 0, cloudRadius + 1.0);\nbool hitsPlanet = rayDir.z < 0.0;\nfloat hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));\nfloat totalTransmittance = 1.0;\nfloat shading = 0.0;\nif (hitsPlanet) {\nshading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);\ntotalTransmittance = hazeFactor;\nfragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\nreturn;\n}\nvec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);\nvec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);\nfloat distToStart = rayStartIntersect.y;\nfloat totalDistance = rayEndIntersect.y - distToStart;\nvec3 sunDirection = normalize(vec3(0, 0, 1));\nshading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);\nshading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);\ntotalTransmittance = mix(0.0, totalTransmittance, hazeFactor);\nfragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\n}"])))),t}var Z=(0,w.Ue)(),I=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:A,build:D},Symbol.toStringTag,{value:"Module"}))},4685:function(e,t,n){n.d(t,{C:function(){return x},b:function(){return w}});var i,r,a=n(30168),o=n(29134),s=n(7025),l=n(60750),u=n(29202),c=n(92395),h=n(41481),d=n(85586),f=n(73619),v=n(116),p=n(78980),_=n(49450),m=n(98634),g=n(8654),y=n(64201),b=n(4760);function w(){var e=new y.kG,t=e.attributes,n=e.varyings,s=e.vertex,w=e.fragment;return t.add(b.T.POSITION,"vec2"),n.add("worldRay","vec3"),s.uniforms.add(new g.g("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new g.g("inverseViewMatrix",(function(e,t){return(0,o.iS)(C,t.camera.viewMatrix)}))),s.code.add((0,m.H)(i||(i=(0,a.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;\ngl_Position = vec4(position, 1.0, 1.0);\n}"])))),w.include(v.Y),w.include(p.n),e.include(l._,{pbrMode:h.f7.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(d.e),e.include(u.D),e.include(c.kR),e.include(f.j),w.uniforms.add(new _.J("cameraPosition",(function(e,t){return t.camera.eye}))),w.code.add((0,m.H)(r||(r=(0,a.Z)(["void main() {\nvec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);\nfragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);\n}"])))),e}var C=(0,s.Ue)(),x=Object.freeze(Object.defineProperty({__proto__:null,build:w},Symbol.toStringTag,{value:"Module"}))},34659:function(e,t,n){n.d(t,{C:function(){return Se},b:function(){return Te}});var i,r,a,o,s,l,u,c,h,d,f,v,p,_,m,g,y,b,w,C,x,T,S,k,M,P,R,E,O,A,D,Z,I,L,N,U,H,F,V,z,q,B=n(30168),G=n(22186),j=n(92015),W=n(7564),X=n(37107),Q=n(91871),Y=n(22357),J=n(37081),K=n(33280),$=n(16010),ee=n(60113),te=n(48655),ne=n(85380),ie=n(74058),re=n(16574),ae=n(137),oe=n(54943),se=n(98864),le=n(38171),ue=n(48051),ce=n(34975),he=n(92395),de=n(15226),fe=n(41481),ve=n(51612),pe=n(93511),_e=n(22702),me=n(26461),ge=n(10763),ye=n(86097),be=n(98634),we=n(64201),Ce=n(19253),xe=n(25920);function Te(e){var t=new we.kG;t.include(ie.up,e),t.include(ne.Bb,e),t.include(te.c,e),t.include(ee.D,e),t.include(Y.qj,e),t.include(X.AD,e),t.include(ge.o,e),t.include(K.P_,e),t.include(ve.s,e),t.include(Q.z,e);var n=t.vertex,Te=t.fragment;e.pbrMode!==fe.f7.Normal&&e.pbrMode!==fe.f7.Schematic||(t.include(fe.jV,e),e.hasNormalTexture&&t.include(le.Q,e));var Se=e.output===J.H_.Shadow||e.output===J.H_.ShadowHighlight||e.output===J.H_.ShadowExcludeHighlight;Se&&e.componentData===X._N.Varying?n.code.add((0,be.H)(i||(i=(0,B.Z)(["#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"])))):n.code.add((0,be.H)(r||(r=(0,B.Z)(["#define discardShadows(castShadows) {}"]))));var ke=e.integratedMeshMode===W.O.ColorOverlay||e.integratedMeshMode===W.O.ColorOverlayWithWater,Me=ke&&e.output===J.H_.Color&&e.pbrMode===fe.f7.WaterOnIntegratedMesh;ke&&(t.include(ce.XP,e),t.include(_e.WB,e),e.spherical?n.code.add((0,be.H)(a||(a=(0,B.Z)(["\n      const float invEllipsoidRadius = ",";\n      vec2 projectOverlay(vec3 pos) {\n        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);\n      }\n      "])),be.H.float(1/(e.ellipsoidMode===ye.U.Earth?G.sv.radius:e.ellipsoidMode===ye.U.Mars?G.yr.radius:G.Z1.radius)))):n.code.add((0,be.H)(o||(o=(0,B.Z)(["vec2 projectOverlay(vec3 pos) { return pos.xy; }"]))))),Me&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),n.code.add((0,be.H)(s||(s=(0,B.Z)(["\n    void main() {\n      bool castShadows;\n      vec4 externalColor = forwardExternalColor(castShadows);\n      discardShadows(castShadows);\n\n      vertexDiscardByOpacity(externalColor.a);\n\n      ","\n\n      if (externalColor.a < ",") {\n        // Discard this vertex\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n\n      forwardPosition(readElevationOffset());\n      forwardNormal();\n      forwardTextureCoordinates();\n      forwardVertexColor();\n      forwardLinearDepth();\n      ","\n      ","\n      ","\n    }\n  "])),e.output===J.H_.ObjectAndLayerIdColor?(0,be.H)(l||(l=(0,B.Z)(["externalColor.a = 1.0;"]))):"",be.H.float(me.b),e.output===J.H_.ObjectAndLayerIdColor?(0,be.H)(u||(u=(0,B.Z)(["forwardObjectAndLayerIdColor();"]))):"",Me?e.spherical?(0,be.H)(c||(c=(0,B.Z)(["\n                groundNormal = normalize(positionWorld());\n                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));\n                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));"]))):(0,be.H)(h||(h=(0,B.Z)(["\n                groundNormal = vec3(0.0, 0.0, 1.0);\n                tbnTangent = vec3(1.0, 0.0, 0.0);\n                tbnBiTangent = vec3(0.0, 1.0, 0.0);"]))):"",ke?(0,be.H)(d||(d=(0,B.Z)(["setOverlayVTC(projectOverlay(position));"]))):"")),e.output===J.H_.Color&&(Te.include(oe.S),t.include(de.l,e),t.include(se.P,e),t.include(ue.B,e),t.include(ce.XP,e),e.transparencyPassType===xe.A.ColorAlpha&&(t.outputs.add("fragColor","vec4",0),t.outputs.add("fragAlpha","float",1)),e.receiveShadows?(t.include(pe.hb,e),Te.code.add((0,be.H)(f||(f=(0,B.Z)(["float evaluateShadow() {\nreturn readShadowMap(vPositionWorldCameraRelative, linearDepth);\n}"]))))):Te.code.add((0,be.H)(v||(v=(0,B.Z)(["float evaluateShadow() { return 0.0; }"])))),ke&&Te.uniforms.add(new Ce.A("ovColorTex",(function(e,t){return(0,_e.WE)(e,t)}))),Te.code.add((0,be.H)(p||(p=(0,B.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n        ","\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        vec4 externalColor;\n        int externalColorMixMode;\n        readExternalColor(externalColor, externalColorMixMode);\n\n        vec4 materialColor = computeMaterialColor(\n          textureColor,\n          externalColor,\n          externalColorMixMode\n        );\n        ","\n    "])),e.multipassEnabled?(0,be.H)(_||(_=(0,B.Z)(["terrainDepthTest(vPosition_view.z);"]))):"",ke?(0,be.H)(m||(m=(0,B.Z)(["vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);"]))):"")),e.pbrMode===fe.f7.Normal||e.pbrMode===fe.f7.Schematic?((0,he.F1)(Te),Te.code.add((0,be.H)(g||(g=(0,B.Z)(["\n        ","\n        vec3 normalVertex = shadingNormalWorld();\n        float additionalIrradiance = 0.02 * mainLightIntensity[2];\n      "])),e.pbrMode===fe.f7.Normal?(0,be.H)(y||(y=(0,B.Z)(["\n                applyPBRFactors();\n                if (int(externalColorMixMode) == 3) {\n                  mrr = vec3(0.0, 0.6, 0.2);\n                }"]))):"")),e.hasNormalTexture?Te.code.add((0,be.H)(b||(b=(0,B.Z)(["mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);\nvec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);"])))):Te.code.add((0,be.H)(w||(w=(0,B.Z)(["vec3 shadingNormal = normalVertex;"])))),Te.code.add((0,be.H)(C||(C=(0,B.Z)(["","\n      "])),e.spherical?(0,be.H)(x||(x=(0,B.Z)(["vec3 normalGround = normalize(positionWorld());"]))):(0,be.H)(T||(T=(0,B.Z)(["vec3 normalGround = vec3(0.0, 0.0, 1.0);"]))))),Te.code.add((0,be.H)(S||(S=(0,B.Z)(["\n        vec3 viewDir = normalize(vPositionWorldCameraRelative);\n        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();\n        ","\n\n        ","\n\n        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());\n        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);\n        "])),e.snowCover?(0,be.H)(k||(k=(0,B.Z)(["\n                vec3 surfaceNormal = normalize(shadingNormalWorld());\n                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\n                materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);\n                ssao = mix(ssao, 0.5 * ssao, snow);\n                shadingNormal = mix(shadingNormal, surfaceNormal, snow);"]))):"",ke?(0,be.H)(M||(M=(0,B.Z)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):""))):(e.receiveShadows?Te.code.add((0,be.H)(P||(P=(0,B.Z)(["float shadow = evaluateShadow();"])))):e.spherical?((0,ce.sC)(Te),Te.code.add((0,be.H)(R||(R=(0,B.Z)(["float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());\nfloat shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);"]))))):Te.code.add((0,be.H)(E||(E=(0,B.Z)(["float shadow = 0.0;"])))),Me&&Te.uniforms.add(new Ce.A("ovNormalTex",(function(e,t){var n;return null===(n=t.overlay)||void 0===n?void 0:n.getTexture(j.D.WaterNormal)}))),e.snowCover&&Te.code.add((0,be.H)(O||(O=(0,B.Z)(["vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));\nfloat snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\nmaterialColor.rgb = mix(materialColor.rgb, vec3(1), snow);"])))),Te.code.add((0,be.H)(A||(A=(0,B.Z)(["\n        float ambientOcclusion = evaluateAmbientOcclusion();\n        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());\n\n        ","\n\n        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);\n      ","\n      "])),ke?(0,be.H)(D||(D=(0,B.Z)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):"",Me?(0,be.H)(Z||(Z=(0,B.Z)(["\n              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                // un-gamma the ground color to mix in linear space\n                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);\n              }"]))):""))),Te.code.add((0,be.H)(I||(I=(0,B.Z)(["\n        fragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);\n        ","\n      }\n    "])),e.transparencyPassType===xe.A.ColorAlpha?(0,be.H)(L||(L=(0,B.Z)(["\n                fragColor = premultiplyAlpha(fragColor);\n                fragAlpha = fragColor.a;"]))):"")));var Pe=e.output===J.H_.Depth;return(Pe||Se||e.output===J.H_.ViewshedShadow)&&(Pe||t.include(re.F,e),Te.code.add((0,be.H)(N||(N=(0,B.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n      }\n    "])),Pe?"":(0,be.H)(U||(U=(0,B.Z)(["outputDepth(linearDepth);"])))))),e.output===J.H_.Normal&&(t.include(ue.B,e),Te.code.add((0,be.H)(H||(H=(0,B.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        // note: the alpha component needs to be 1.0 in order for this material to influence ambient occlusion,\n        // see the ssao fragment shader\n        float alpha = ",";\n        fragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);\n      }\n    "])),e.normalType===$.r.Ground?"0.0":"1.0"))),e.output===J.H_.ObjectAndLayerIdColor&&t.fragment.code.add((0,be.H)(F||(F=(0,B.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n      }\n    "])),ke?(0,be.H)(V||(V=(0,B.Z)(["fragColor = getOverlayColorTexel(vtcOverlay);"]))):"outputObjectAndLayerIdColor();")),e.output===J.H_.Highlight&&(t.include(ae.bA),Te.code.add((0,be.H)(z||(z=(0,B.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n\n        outputHighlight();\n      }\n    "])),ke?(0,be.H)(q||(q=(0,B.Z)(["\n                vec4 overlayColor = getCombinedOverlayColor();\n                if (overlayColor.a == 0.0) {\n                  fragColor = vec4(0.0);\n                  return;\n                }"]))):""))),t}var Se=Object.freeze(Object.defineProperty({__proto__:null,build:Te},Symbol.toStringTag,{value:"Module"}))},4170:function(e,t,n){n.d(t,{C:function(){return y},a:function(){return w},b:function(){return b}});var i,r,a,o=n(30168),s=n(43144),l=n(15671),u=n(60136),c=n(29388),h=n(24967),d=n(54943),f=n(78980),v=n(82999),p=n(58406),_=n(98634),m=n(64201),g=n(19253),y=function(e){(0,u.Z)(n,e);var t=(0,c.Z)(n);function n(){var e;return(0,l.Z)(this,n),(e=t.apply(this,arguments)).opacity=1,e}return(0,s.Z)(n)}(_.K);function b(e){var t=new m.kG;return t.include(h.k),t.fragment.uniforms.add(new g.A("tex",(function(e){return e.texture}))),e.hasOpacityFactor&&t.fragment.uniforms.add(new p.p("opacity",(function(e){return e.opacity}))),e.isDepthBlit&&(t.fragment.uniforms.add(new v.A("nearFar",(function(e,t){return t.camera.nearFar}))),t.fragment.include(d.K),t.fragment.include(f.n)),t.fragment.code.add((0,_.H)(i||(i=(0,o.Z)(["\n    void main() {\n      ","\n    }"])),e.isDepthBlit?(0,_.H)(r||(r=(0,o.Z)(["\n              float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);\n              fragColor = float2rgba(normalizedLinearDepth);"]))):(0,_.H)(a||(a=(0,o.Z)(["\n              fragColor = texture(tex, uv) ",";"])),e.hasOpacityFactor?"* opacity":""))),t}var w=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:y,build:b},Symbol.toStringTag,{value:"Module"}))},82396:function(e,t,n){n.d(t,{E:function(){return d},b:function(){return h}});var i,r=n(30168),a=n(24967),o=n(98634),s=n(64201),l=n(19253),u=.05,c=2;function h(){var e=new s.kG;return e.include(a.k),e.fragment.uniforms.add(new l.A("colorTexture",(function(e){return e.color}))),e.outputs.add("fragEdges","vec2"),e.fragment.code.add((0,o.H)(i||(i=(0,r.Z)(["\n    float absMax3(vec3 v) {\n      vec3 t = abs(v);\n      return max(max(t.r, t.g), t.b);\n    }\n\n    void main() {\n      vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));\n      vec4 offsets[3];\n      offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);\n      offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);\n      offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);\n\n      // Calculate color deltas:\n      vec4 delta;\n      vec3 C = texture(colorTexture, uv).rgb;\n\n      vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;\n      delta.x = absMax3(C - Cleft);\n\n      vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;\n      delta.y = absMax3(C - Ctop);\n\n      vec2 edges = step(vec2(","), delta.xy);\n\n      // discard if there is no edge:\n      if (dot(edges, vec2(1.0)) == 0.0) {\n        discard;\n      }\n\n      // Calculate right and bottom deltas:\n      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;\n      delta.z = absMax3(C - Cright);\n\n      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;\n      delta.w = absMax3(C - Cbottom);\n\n      // Calculate the maximum delta in the direct neighborhood:\n      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n\n      // Calculate left-left and top-top deltas:\n      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;\n      delta.z = absMax3(C - Cleftleft);\n\n      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;\n      delta.w = absMax3(C - Ctoptop);\n\n      // Calculate the final maximum delta:\n      maxDelta = max(max(maxDelta, delta.z), delta.w);\n\n      // Local contrast adaptation in action:\n      edges *= step(maxDelta, float(",") * delta.xy);\n\n      fragEdges = edges;\n    }\n  "])),o.H.float(u),o.H.float(c))),e}var d=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},43223:function(e,t,n){n.d(t,{F:function(){return k},a:function(){return R},b:function(){return M}});var i,r,a,o,s=n(30168),l=n(43144),u=n(15671),c=n(60136),h=n(29388),d=n(29134),f=n(7025),v=n(12400),p=n(60113),_=n(54943),m=n(29202),g=n(82999),y=n(49450),b=n(58406),w=n(98634),C=n(8654),x=n(64201),T=n(19253),S=n(4760),k=function(e){(0,c.Z)(n,e);var t=(0,h.Z)(n);function n(){var e;return(0,u.Z)(this,n),(e=t.apply(this,arguments)).fogColor=(0,v.Ue)(),e.fogStrength=4e-6,e.atmosphereC=1,e.fogAmount=0,e}return(0,l.Z)(n)}(w.K);function M(){var e=new x.kG;e.attributes.add(S.T.POSITION,"vec2"),e.include(p.D,{textureCoordinateType:p.N.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");var t=e.vertex,n=e.fragment;return t.uniforms.add(new C.g("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new C.g("inverseViewMatrix",(function(e,t){return(0,d.iS)(P,t.camera.viewMatrix)}))),t.code.add((0,w.H)(i||(i=(0,s.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),n.uniforms.add(new b.p("atmosphereC",(function(e){return e.atmosphereC})),new y.J("cameraPosition",(function(e,t){return t.camera.eye})),new g.A("nearFar",(function(e,t){return t.camera.nearFar})),new T.A("depthTexture",(function(e){return e.depthTexture})),new b.p("fogStrength",(function(e){return e.fogStrength})),new b.p("fogAmount",(function(e){return e.fogAmount})),new y.J("fogColor",(function(e){return e.fogColor}))),e.include(m.D),n.include(_.S),n.code.add((0,w.H)(r||(r=(0,s.Z)(["vec2 sphereIntersect(vec3 start, vec3 dir) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat d = (b * b) - 4.0 * a * atmosphereC;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),n.code.add((0,w.H)(a||(a=(0,s.Z)(["vec4 applyFog(float dist, vec3 rayDir){\nif(dist == -1.0){\nvec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);\ndist = 0.055 * rayAtmosphereIntersect.y;\n}\nfloat fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));\nreturn vec4(fogAmount * fogColor, fogAmount);\n}"])))),n.code.add((0,w.H)(o||(o=(0,s.Z)(["vec3 tonemapACES(vec3 x) {\nreturn clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n}\nvoid main() {\nvec3 rayDir = normalize(worldRay);\nfloat terrainDepth = -1.0;\nfloat depthSample = texture(depthTexture, vuv0).r;\nfloat zNorm = 2.0 * depthSample - 1.0;\nfloat linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));\nif(depthSample < 1.0 && depthSample > 0.0){\nvec3 cameraSpaceRay = normalize(eyeDir);\ncameraSpaceRay /= cameraSpaceRay.z;\ncameraSpaceRay *= linDepth;\nterrainDepth = max(0.0, length(cameraSpaceRay));\n}\nvec4 fog = applyFog(terrainDepth, rayDir);\nfragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));\n}"])))),e}var P=(0,f.Ue)(),R=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:k,build:M},Symbol.toStringTag,{value:"Module"}))},67273:function(e,t,n){n.d(t,{H:function(){return f},a:function(){return p},b:function(){return v}});var i,r=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(29388),u=n(24967),c=n(98634),h=n(64201),d=n(19253),f=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n)}(c.K);function v(){var e=new h.kG;return e.include(u.k),e.fragment.uniforms.add(new d.A("tex",(function(e){return e.texture}))),e.fragment.code.add((0,c.H)(i||(i=(0,r.Z)(["void main() {\nfragColor = vec4(1.0 - texture(tex, uv).a);\n}"])))),e}var p=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:f,build:v},Symbol.toStringTag,{value:"Module"}))},90765:function(e,t,n){n.d(t,{H:function(){return m},b:function(){return p}});var i,r,a=n(30168),o=n(19093),s=n(86361),l=n(82999),u=n(95276),c=n(98634),h=n(64201),d=n(19253),f=n(4760),v=n(69012);function p(){var e=new h.kG,t=e.vertex,n=e.fragment,s=t.code,p=n.code;return e.attributes.add(f.T.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(f.T.UV0,"vec2"),t.uniforms.add(new d.A("coverageTex",(function(e){return e.coverageTexture})),new l.A("coverageRounding",(function(e){return e.coverageRounding}))),s.add((0,c.H)(i||(i=(0,a.Z)(["void main() {\nvec4 cov = texture(coverageTex, uv0 * coverageRounding);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\nreturn;\n}\ngl_Position = vec4(position, 0.0, 1.0);\nuv = position.xy * 0.5 + vec2(0.5);\n}"])))),n.uniforms.add(new d.A("tex",(function(e){return e.blurTexture})),new d.A("highlightTexture",(function(e){return e.highlightTexture})),new u.N("uColor",(function(e){return e.color})),new u.N("haloColor",(function(e){return e.haloColor})),new u.N("opacities",(function(e){return(0,o.s)(_,e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)}))),n.constants.add("inner","float",1-(v.o-v.b)/v.o),p.add((0,c.H)(r||(r=(0,a.Z)(["void main() {\nvec4 blurredHighlightValue = texture(tex, uv);\nfloat highlightIntensity = blurredHighlightValue.a;\nif (highlightIntensity == 0.0) {\ndiscard;\n}\nvec4 origin_color = texture(highlightTexture, uv);\nfloat outlineIntensity;\nfloat fillIntensity;\nif (blurredHighlightValue.g > blurredHighlightValue.b) {\noutlineIntensity = haloColor.w * opacities[1];\nfillIntensity = uColor.w * opacities[3];\n}\nelse {\noutlineIntensity = haloColor.w * opacities[0];\nfillIntensity = uColor.w * opacities[2];\n}\nfloat outlineFactor = smoothstep(0.0, inner, highlightIntensity);\nfloat fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;\nfloat intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;\nfragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);\n}"])))),e}var _=(0,s.Ue)(),m=Object.freeze(Object.defineProperty({__proto__:null,build:p},Symbol.toStringTag,{value:"Module"}))},56384:function(e,t,n){n.d(t,{H:function(){return g},a:function(){return b},b:function(){return y}});var i,r,a=n(30168),o=n(43144),s=n(15671),l=n(60136),u=n(29388),c=n(6644),h=n(22527),d=n(82999),f=n(98634),v=n(64201),p=n(78050),_=n(19253),m=n(4760),g=function(e){(0,l.Z)(n,e);var t=(0,u.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).blurSize=(0,c.Ue)(),e}return(0,o.Z)(n)}(f.K);function y(){var e=new v.kG,t=e.attributes,n=e.varyings,o=e.vertex,s=e.fragment;return t.add(m.T.POSITION,"vec2"),t.add(m.T.UV0,"vec2"),n.add("blurCoordinate","vec3"),o.uniforms.add(new _.A("coverageTex",(function(e){return e.coverageTexture})),new d.A("coverageRounding",(function(e){return e.coverageRounding}))),o.code.add((0,f.H)(i||(i=(0,a.Z)(["void main() {\ngl_Position = vec4(position, 0.0, 1.0);\nvec4 cov = texture(coverageTex, uv0 * coverageRounding);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\n}\nblurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), cov.g);\n}"])))),s.uniforms.add(new h.q("blurSize",(function(e){return e.blurSize})),new p.R("tex",(function(e){return e.blurInputTexture}))),s.code.add((0,f.H)(r||(r=(0,a.Z)(["void main() {\nvec2 uv = blurCoordinate.xy;\nvec4 center = texture(tex, uv);\nif (blurCoordinate.z == 1.0) {\nfragColor = center;\n} else {\nvec4 sum = center * 0.204164;\nsum += texture(tex, uv + blurSize * 1.407333) * 0.304005;\nsum += texture(tex, uv - blurSize * 1.407333) * 0.304005;\nsum += texture(tex, uv + blurSize * 3.294215) * 0.093913;\nsum += texture(tex, uv - blurSize * 3.294215) * 0.093913;\nfragColor = sum;\n}\n}"])))),e}var b=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:g,build:y},Symbol.toStringTag,{value:"Module"}))},69012:function(e,t,n){n.d(t,{H:function(){return f},a:function(){return g},b:function(){return m},c:function(){return v},g:function(){return p},o:function(){return _}});var i,r=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(29388),u=n(24967),c=n(98634),h=n(64201),d=n(78050),f=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n)}(c.K);function v(){var e=new h.kG,t=e.outputs,n=e.fragment;return e.include(u.k),n.uniforms.add(new d.R("textureInput",(function(e){return e.input}))),n.constants.add("sampleArea","int",Math.ceil(_/2)),t.add("fragGrid","vec2"),n.code.add((0,c.H)(i||(i=(0,r.Z)(["\n    void main() {\n      float red = 0.0;\n      float green = 1.0;\n      int cellSize = ",";\n      vec2 texelSize = 1.0 / vec2(textureSize(textureInput, 0));\n      vec2 offset = floor(gl_FragCoord.xy) * vec2(float(cellSize));\n\n      for(int x = -sampleArea; x < cellSize + sampleArea; x += 2) {\n        for(int y = -sampleArea; y < cellSize + sampleArea; y += 2) {\n          vec2 coord = (offset + vec2(float(x), float(y))) * texelSize;\n          vec4 value = texture(textureInput, coord);\n          float mx = floor(max(value.g, value.b));\n\n          red = max(red, ceil(value.r));\n          green = min(green, mx);\n          if(red == 1.0 && green == 0.0) {\n            fragGrid = vec2(red, green);\n            return;\n          }\n        }\n      }\n      fragGrid = vec2(red, green);\n    }"])),c.H.int(p))),e}var p=32,_=9,m=.4,g=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:f,blurSize:m,build:v,gridCellPixelSize:p,outlineSize:_},Symbol.toStringTag,{value:"Module"}))},19388:function(e,t,n){n.d(t,{M:function(){return y},a:function(){return T},b:function(){return b}});var i,r,a=n(30168),o=n(43144),s=n(15671),l=n(60136),u=n(29388),c=n(17842),h=n(19093),d=n(86361),f=n(13773),v=n(95276),p=n(98634),_=n(64201),m=n(19253),g=n(4760),y=function(e){(0,l.Z)(n,e);var t=(0,u.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).mask=null,e.overlay=null,e.input=null,e.size=0,e}return(0,o.Z)(n)}(p.K);function b(){var e=new _.kG;return e.attributes.add(g.T.POSITION,"vec2"),e.vertex.uniforms.add(new v.N("drawPosition",(function(e,t){return function(e,t){var n=t.camera.pixelRatio,i=e.magnifier.offset.x*n,r=e.magnifier.offset.y*n;(0,c.md)(e.magnifier.position,w);var a=t.camera.screenToRender(w,C),o=Math.ceil(n*e.magnifier.size),s=t.camera.fullWidth,l=t.camera.fullHeight;return(0,h.s)(x,(a[0]+i)/s*2-1,(a[1]-r)/l*2-1,o/s*2,o/l*2)}(e,t)}))),e.varyings.add("vUV","vec2"),e.vertex.code.add((0,p.H)(i||(i=(0,a.Z)(["void main(void) {\nvUV = position;\ngl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);\n}"])))),e.fragment.uniforms.add(new m.A("textureInput",(function(e){return e.input}))),e.fragment.uniforms.add(new m.A("textureMask",(function(e){return e.mask}))),e.fragment.uniforms.add(new m.A("textureOverlay",(function(e){return e.overlay}))),e.fragment.uniforms.add(new f.U("maskEnabled",(function(e){return e.magnifier.maskEnabled}))),e.fragment.uniforms.add(new f.U("overlayEnabled",(function(e){return e.magnifier.overlayEnabled}))),e.fragment.code.add((0,p.H)(r||(r=(0,a.Z)(["const float barrelFactor = 1.1;\nvec2 barrel(vec2 uv) {\nvec2 uvn = uv * 2.0 - 1.0;\nif (uvn.x == 0.0 && uvn.y == 0.0) {\nreturn vec2(0.5, 0.5);\n}\nfloat theta = atan(uvn.y, uvn.x);\nfloat r = pow(length(uvn), barrelFactor);\nreturn r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;\n}\nvoid main() {\nfloat mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;\nvec4 inputColor = texture(textureInput, barrel(vUV)) * mask;\nvec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);\nfragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;\n}"])))),e}var w=(0,c.s1)(),C=(0,c.gX)(),x=(0,d.Ue)(),T=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:y,build:b},Symbol.toStringTag,{value:"Module"}))},50214:function(e,t,n){n.d(t,{N:function(){return x},a:function(){return S},b:function(){return T}});var i,r,a,o,s,l,u,c,h=n(30168),d=n(43144),f=n(15671),v=n(60136),p=n(29388),_=n(6644),m=n(84819),g=n(68820),y=n(24967),b=n(82999),w=n(98634),C=n(64201),x=function(e){(0,v.Z)(n,e);var t=(0,p.Z)(n);function n(){var e;return(0,f.Z)(this,n),(e=t.apply(this,arguments)).weatherTile=(0,_.al)(0,0),e}return(0,d.Z)(n)}(w.K);function T(e){var t=new C.kG;if(t.include(y.k,!1),t.fragment.code.add((0,w.H)(i||(i=(0,h.Z)(["float remap(float x, float low1, float high1, float low2, float high2) {\nreturn low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n}"])))),e.mode===m.u.Full){t.fragment.code.add((0,w.H)(r||(r=(0,h.Z)(["\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }\n\n    // Safer modulo for positive and negative values\n    vec3 modulo(vec3 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec3 hash(vec3 p3, float frequency){\n      p3 = modulo(p3, frequency);\n      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yxz + 33.33);\n      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);\n    }\n\n    // 5th order polynomial interpolation\n    vec3 fade(vec3 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec3 p, float frequency){\n      // Cell point is in\n      vec3 i = floor(p);\n\n      // Position in the cell in [0, 1]\n      vec3 f = fract(p);\n\n      // Interpolation value for gradient mixing\n      vec3 u = fade(f);\n\n      // Trilinear interpolation of gradients at cube vertices around point\n      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),\n                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),\n                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),\n                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),\n                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),\n                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );\n    }\n\n    float getPerlinNoise(vec3 pos, float frequency) {\n      float octaveFrequencyFactor = 2.0;\n      float sum = 0.0;\n      float weightSum = 0.0;\n      float weight = 1.0;\n\n      for (int oct = 0; oct < 3; oct++) {\n        vec3 p = pos * frequency;\n        float val = 0.5 + 0.5 * gradientNoise(p, frequency);\n        sum += val * weight;\n        weightSum += weight;\n        weight *= 0.5;\n        frequency *= octaveFrequencyFactor;\n      }\n\n      float noise = (sum / weightSum);\n      noise = saturate(noise);\n      return noise;\n    }\n\n    float worley(vec3 pos, float numCells) {\n      vec3 p = pos * numCells;\n      float d = 1.0e10;\n\n      for (int x = -1; x <= 1; x++) {\n        for (int y = -1; y <= 1; y++) {\n          for (int z = -1; z <= 1; z++) {\n            vec3 tp = floor(p) + vec3(x, y, z);\n            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);\n            d = min(d, dot(tp, tp));\n          }\n        }\n      }\n\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n\n    vec3 get3Dfrom2D(vec2 uv) {\n      vec2 tile = floor(uv);\n      float z = floor("," * tile.y + tile.x);\n      return vec3(fract(uv), z);\n    }\n\n    float getTextureForPointPerlinWorley(vec3 p) {\n      float perlinNoise = getPerlinNoise(p, ",");\n\n      float worley0 = worley(p, "," * 2.0);\n      float worley1 = worley(p, "," * 8.0);\n      float worley2 = worley(p, "," * 14.0);\n\n      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);\n    }\n\n    float getTextureForPointWorley(vec3 p) {\n      float worley0 = worley(p, ",");\n      float worley1 = worley(p, "," * 2.0);\n      float worley2 = worley(p, "," * 4.0);\n      float worley3 = worley(p, "," * 8.0);\n\n      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;\n      float FBM2 = worley2 * 0.75 + worley3 * 0.25;\n\n      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;\n    }\n  "])),w.H.float(g.CB),w.H.float(8),w.H.float(2),w.H.float(2),w.H.float(2),w.H.float(2),w.H.float(2),w.H.float(2),w.H.float(2)))}return t.fragment.uniforms.add(new b.A("weatherTile",(function(e){return e.weatherTile}))),t.fragment.code.add((0,w.H)(a||(a=(0,h.Z)(["\n    vec2 modulo(vec2 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec2 hash(vec2 p){\n      // Get position of p in weather tile\n      p = modulo(p, ",");\n\n      // Get global coordinates of p\n      p += weatherTile * ",";\n\n      // Limit position to avoid numerical instability\n      p = modulo(p, ",");\n\n      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;\n    }\n\n    vec2 fade(vec2 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec2 p){\n      vec2 i = floor( p );\n      vec2 f = fract( p );\n\n      vec2 u = fade(f);\n\n      // Bilinear interpolation of gradients at cell vertices around point\n      return  mix(\n                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),\n                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),\n                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),\n                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),\n                u.y);\n    }\n\n    float worley(vec2 p){\n      float d = 1.0e10;\n      for (int x = -1; x <= 1; x++){\n        for (int y = -1; y <= 1; y++){\n                vec2 tp = floor(p) + vec2(x, y);\n                tp = p - tp - (0.5 + 0.5 * hash(tp));\n                d = min(d, dot(tp, tp));\n            }\n        }\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n  "])),w.H.float(g.JK),w.H.float(g.JK),w.H.float(g.r7))),t.fragment.code.add((0,w.H)(o||(o=(0,h.Z)(["void main() {"])))),e.mode===m.u.Full&&t.fragment.code.add((0,w.H)(s||(s=(0,h.Z)(["\n        float padWidth = 1.0;\n        float paddedSize = "," + 2.0 * padWidth;\n        float tileCount = "," * ",";\n        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);\n\n        bool padCell = false;\n        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        bool startPadX = false;\n        bool startPadY = false;\n        bool endPadX = false;\n        bool endPadY = false;\n\n        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {\n          startPadX = true;\n        }\n\n        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {\n          startPadY = true;\n        }\n\n        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {\n          endPadX = true;\n        }\n\n        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {\n          endPadY = true;\n        }\n\n        vec2 padding = vec2(2.0 * padWidth) * tile;\n        vec2 uv;\n\n        if (padCell) {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n\n          if (startPadX) {\n            pixel.x += ",";\n          }\n\n          if (startPadY) {\n            pixel.y += ",";\n          }\n\n          if (endPadX) {\n            pixel.x -= ",";\n          }\n\n          if (endPadY) {\n            pixel.y -= ",";\n          }\n\n          uv = vec2(pixel.xy / ",");\n        } else {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n          uv = vec2(pixel.xy / ",");\n        }\n\n        vec3 p_ = get3Dfrom2D(uv);\n        vec3 p = p_;\n        p.z /= ("," * ",");\n\n        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        float worleyNoise = getTextureForPointWorley(p);\n\n        fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n        p_ = mod(p_ + 1.0, "," * ",");\n        p = p_;\n        p.z /= ("," * ",");\n\n        worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        worleyNoise = getTextureForPointWorley(p);\n\n        fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n      "])),w.H.float(g.i9),w.H.float(g.CB),w.H.float(g.CB),w.H.float(g.i9),w.H.float(g.i9),w.H.float(g.i9),w.H.float(g.i9),w.H.float(g.i9),w.H.float(g.i9),w.H.float(g.CB),w.H.float(g.CB),w.H.float(g.CB),w.H.float(g.CB),w.H.float(g.CB),w.H.float(g.CB))),t.fragment.code.add((0,w.H)(l||(l=(0,h.Z)(["\n      vec2 mapUV = "," * (gl_FragCoord.xy / ",");\n      float map = abs(gradientNoise(mapUV));\n      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);\n\n      ",";\n    }\n  "])),w.H.float(g.JK),w.H.float(g.a5),e.mode===m.u.Full?(0,w.H)(u||(u=(0,h.Z)(["fragColor.ba = vec2(0.0, map);"]))):(0,w.H)(c||(c=(0,h.Z)(["fragColor = vec4(map);"]))))),t}var S=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:x,build:T},Symbol.toStringTag,{value:"Module"}))},90829:function(e,t,n){n.d(t,{O:function(){return f},a:function(){return p},b:function(){return v}});var i,r=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(29388),u=n(24967),c=n(98634),h=n(64201),d=n(19253),f=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n)}(c.K);function v(){var e=new h.kG;return e.include(u.k),e.fragment.uniforms.add(new d.A("colorTexture",(function(e){return e.colorTexture})),new d.A("alphaTexture",(function(e){return e.alphaTexture})),new d.A("frontFaceTexture",(function(e){return e.frontFaceTexture}))),e.fragment.code.add((0,c.H)(i||(i=(0,r.Z)(["void main() {\nfloat srcAlpha = texture(alphaTexture, uv).r;\nif(srcAlpha <= 1e-5){\ndiscard;\n}\nvec4 srcColor = texture(colorTexture, uv);\nvec4 frontFace = texture(frontFaceTexture, uv);\nfragColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);\n}"])))),e}var p=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:f,build:v},Symbol.toStringTag,{value:"Module"}))},19159:function(e,t,n){n.d(t,{P:function(){return S},b:function(){return y}});var i,r,a,o,s,l,u=n(30168),c=n(32035),h=n(12400),d=n(96916),f=n(49450),v=n(58406),p=n(98634),_=n(8654),m=n(64201),g=n(4760);function y(e){var t=new m.kG;return t.attributes.add(g.T.POSITION,"vec3"),t.attributes.add(g.T.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new f.J("cameraPosition",(function(e,t){return t.camera.eye}))),t.vertex.uniforms.add(new f.J("offset",(function(e,t){return function(e,t){var n=t.camera.eye,i=.5*e.width,r=1/e.width,a=(0,c.J)(b,(0,c.s)(b,(n[0]+i)*r,(n[1]+i)*r,(n[2]+i)*r));return(0,c.z)(a,n,(0,c.j)(a,a,e.width))}(e,t)}))),t.vertex.uniforms.add(new v.p("width",(function(e){return e.width}))),t.vertex.uniforms.add(new _.g("proj",(function(e,t){return t.camera.projectionMatrix}))),t.vertex.uniforms.add(new _.g("view",(function(e,t){return t.camera.viewMatrix}))),t.vertex.uniforms.add(new v.p("time",(function(e){return e.time}))),t.varyings.add("vUv","vec2"),t.vertex.code.add((0,p.H)(i||(i=(0,u.Z)(["\n    vec3 hash31(float p){\n      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return fract((p3.xxy + p3.yzz) * p3.zyx);\n    }\n\n    float hash11(float p){\n      p = fract(p * 0.1031);\n      p *= p + 33.33;\n      p *= p + p;\n      return fract(p);\n    }\n\n    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/\n    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){\n      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;\n    }\n\n    void main(void) {\n\n      vUv = position.xz;\n\n      vec3 rand = hash31(instanceFeatureAttribute);\n\n      // Set random position for all particles\n      // The hash function space is not high resolution so offset particles by an additional random value\n      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width\n      // overlaying multiple identical but offset grids\n      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;\n\n      // Random orientation of rain drops\n      float angle = 3.1415 * hash11(instanceFeatureAttribute);\n\n      vec3 up = vec3(0, 0, 1);\n\n      // Gravity and wind direction\n      vec3 direction = normalize(cameraPosition);\n\n      vec3 tangent = normalize(cross(direction, up));\n\n      // Gravity\n      vec3 animatedPos = randomPosition + direction * -time;\n\n      // Rain particles fall straight down and are randomly oriented\n      // Snow particles have random sinusoid trajectories and are rotated to face the camera\n      ","\n    }\n  "])),e.type===d.H.Rain?(0,p.H)(r||(r=(0,u.Z)(["\n            // Random rotation for particle\n            vec3 rotationAxis = up;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);\n\n            // Rotate particle to planetary position\n            rotationAxis = tangent;\n            angle = 0.5 * -acos(dot(direction, up));\n            quat = vec4(rotationAxis * sin(angle), cos(angle));\n            transformedPos = rotateVectorByQuaternion(transformedPos, quat);\n\n            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * pos;\n      "]))):(0,p.H)(a||(a=(0,u.Z)(["\n            vec3 rotationAxis = direction;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n\n            tangent = rotateVectorByQuaternion(tangent, quat);\n            // Random sinusoid from friction\n            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));\n            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);\n      "]))))),t.fragment.uniforms.add(new v.p("opacity",(function(e){return e.opacity})),new f.J("particleColor",(function(t,n){return function(e,t){var n=t.type===d.H.Rain?x:C,i=(0,c.j)(b,n,T),r=e.camera.eye;(0,c.n)(w,r);var a=Math.max(0,(0,c.m)(w,e.lighting.mainLight.direction));return(0,c.o)(i,i,n,a)}(n,e)}))),t.fragment.code.add((0,p.H)(o||(o=(0,u.Z)(["\n    void main() {\n\n      // Cut off corners of the triangle\n      if(vUv.x < 0.0 || vUv.y < 0.0){\n        discard;\n      }\n\n      float d = length(vUv - vec2(0.5));\n\n      ","\n      fragColor = opacity * vec4(particleColor * d, d);\n    }\n  "])),e.type===d.H.Rain?(0,p.H)(s||(s=(0,u.Z)(["d = 0.35 * smoothstep(0.5, 0.0, d);"]))):(0,p.H)(l||(l=(0,u.Z)(["d = smoothstep(0.5, 0.1, d);"]))))),t}var b=(0,h.Ue)(),w=(0,h.Ue)(),C=(0,h.al)(1,1,1),x=(0,h.al)(.85,.85,.85),T=.7,S=Object.freeze(Object.defineProperty({__proto__:null,build:y},Symbol.toStringTag,{value:"Module"}))},87016:function(e,t,n){n.d(t,{C:function(){return L},R:function(){return F},a:function(){return N},b:function(){return U},c:function(){return H}});var i,r,a,o,s,l,u,c,h,d,f,v,p,_=n(30168),m=n(43144),g=n(15671),y=n(60136),b=n(29388),w=n(12400),C=n(39395),x=n(54786),T=n(9386),S=n(63434),k=n(32426),M=n(116),P=n(13773),R=n(82999),E=n(58406),O=n(699),A=n(99339),D=n(98634),Z=n(64201),I=n(19253),L=function(e){(0,y.Z)(n,e);var t=(0,b.Z)(n);function n(e,i,r,a,o,s){var l;return(0,g.Z)(this,n),(l=t.call(this,e,a,o)).colormap=i,l.symbolizer=r,l.u_colormap=s,l.backgroundColor=w.AG,l.fboTexture=null,l.baseOpacity=1,l}return(0,m.Z)(n)}(T.J),N=function(e){(0,y.Z)(n,e);var t=(0,b.Z)(n);function n(){return(0,g.Z)(this,n),t.apply(this,arguments)}return(0,m.Z)(n)}(L),U=function(e){(0,y.Z)(n,e);var t=(0,b.Z)(n);function n(){return(0,g.Z)(this,n),t.apply(this,arguments)}return(0,m.Z)(n)}(L);function H(e){var t=new Z.kG;return t.include(k.T),t.include(T.G,e),t.include(x.i,e),t.include(S.J,e),t.fragment.code.add((0,D.H)(i||(i=(0,_.Z)(["vec4 applyBackgroundBlend(vec4 layerColor) {\nreturn blendLayers(vuv, layerColor, u_opacity);\n}"])))),e.colorizerType===C.U.Stretch?function(e,t){e.fragment.uniforms.add(new A._("u_bandCount",(function(e){return e.symbolizer.u_bandCount})),new O.O("u_minCutOff",(function(e){return e.symbolizer.u_minCutOff}),3),new O.O("u_maxCutOff",(function(e){return e.symbolizer.u_maxCutOff}),3),new O.O("u_factor",(function(e){return e.symbolizer.u_factor}),3),new E.p("u_minOutput",(function(e){return e.symbolizer.u_minOutput})),new E.p("u_maxOutput",(function(e){return e.symbolizer.u_maxOutput})),new P.U("u_useGamma",(function(e){return e.symbolizer.u_useGamma})),new O.O("u_gamma",(function(e){return e.symbolizer.u_gamma}),3),new O.O("u_gammaCorrection",(function(e){return e.symbolizer.u_gammaCorrection}),3),new E.p("u_opacity",(function(e){return e.common.u_opacity}))),e.fragment.code.add((0,D.H)(a||(a=(0,_.Z)(["float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {\nif (val >= maxCutOff) {\nreturn maxOutput;\n} else if (val <= minCutOff) {\nreturn minOutput;\n}\nfloat stretchedVal;\nif (useGamma) {\nfloat tempf = 1.0;\nfloat outRange = maxOutput - minOutput;\nfloat relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);\nif (gamma > 1.0) {\ntempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);\n}\nstretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;\n} else {\nstretchedVal = minOutput + (val - minCutOff) * factor;\n}\nreturn stretchedVal;\n}"]))));var n=t.applyColormap?(0,D.H)(o||(o=(0,_.Z)(["fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));"]))):(0,D.H)(s||(s=(0,_.Z)(["fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));"])));e.fragment.code.add((0,D.H)(l||(l=(0,_.Z)(["\n      void main() {\n        vec2 pixelLocation = getPixelLocation(uv);\n        if (isOutside(pixelLocation)) {\n          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n\n        vec4 currentPixel = getPixel(pixelLocation);\n        ","\n      }"])),t.stretchType===C.H.Noop?(0,D.H)(u||(u=(0,_.Z)(["\n        fragColor = applyBackgroundBlend(currentPixel);"]))):(0,D.H)(c||(c=(0,_.Z)(["\n        if (currentPixel.a == 0.0) {\n          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n        if (u_bandCount == 1) {\n          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          ","\n        } else {\n          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);\n          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);\n          fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));\n        }"])),n)))}(t,e):e.colorizerType===C.U.Lut?function(e){e.fragment.code.add((0,D.H)(r||(r=(0,_.Z)(["void main() {\nvec2 pixelLocation = getPixelLocation(uv);\nif (isOutside(pixelLocation)) {\nfragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\nreturn;\n}\nvec4 currentPixel = getPixel(pixelLocation);\nfragColor = applyBackgroundBlend(colormap(currentPixel, true));\n}"]))))}(t):e.colorizerType===C.U.Hillshade&&function(e,t){var n=e.fragment;n.uniforms.add(new I.A("u_image",(function(e){return e.u_image})),new A._("u_hillshadeType",(function(e){return e.symbolizer.u_hillshadeType})),new O.O("u_sinZcosAs",(function(e){return e.symbolizer.u_sinZcosAs}),6),new O.O("u_sinZsinAs",(function(e){return e.symbolizer.u_sinZsinAs}),6),new O.O("u_cosZs",(function(e){return e.symbolizer.u_cosZs}),6),new O.O("u_weights",(function(e){return e.symbolizer.u_weights}),6),new R.A("u_factor",(function(e){return e.symbolizer.u_factor})),new E.p("u_minValue",(function(e){return e.symbolizer.u_minValue})),new E.p("u_maxValue",(function(e){return e.symbolizer.u_maxValue})),new R.A("u_srcImageSize",(function(e){return e.common.u_srcImageSize}))),n.include(M.Y),n.code.add((0,D.H)(h||(h=(0,_.Z)(["vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {\nval = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);\nvec4 color = colormap(vec4(val, val, val, 1.0), false);\nvec3 hsv = rgb2hsv(color.rgb);\nhsv.z = hillshade;\nreturn vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;\n}"])))),n.code.add((0,D.H)(d||(d=(0,_.Z)(["float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){\nif (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {\nreturn 0.0;\n}  else {\nreturn e;\n}\n}"]))));var i=t.applyColormap?(0,D.H)(f||(f=(0,_.Z)(["fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));"]))):(0,D.H)(v||(v=(0,_.Z)(["hillshade *= alpha;\nfragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));"])));n.code.add((0,D.H)(p||(p=(0,_.Z)(["\n    void main() {\n      vec2 pixelLocation = getPixelLocation(uv);\n      if (isOutside(pixelLocation)) {\n        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      vec4 currentPixel = getPixel(pixelLocation);\n      if (currentPixel.a == 0.0) {\n        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      //mirror edge pixels\n      vec2 axy = vec2(-1.0, -1.0);\n      vec2 bxy = vec2(0.0, -1.0);\n      vec2 cxy = vec2(1.0, -1.0);\n      vec2 dxy = vec2(-1.0, 0.0);\n      vec2 fxy = vec2(1.0, 0.0);\n      vec2 gxy = vec2(-1.0, 1.0);\n      vec2 hxy = vec2(0.0, 1.0);\n      vec2 ixy = vec2(1.0, 1.0);\n      vec2 onePixel = 1.0 / u_srcImageSize;\n      if (pixelLocation.s < onePixel.s) {\n        axy[0] = 1.0;\n        dxy[0] = 1.0;\n        gxy[0] = 1.0;\n      }\n      if (pixelLocation.t < onePixel.t) {\n        axy[1] = 1.0;\n        bxy[1] = 1.0;\n        cxy[1] = 1.0;\n      }\n      if (pixelLocation.s > 1.0 - onePixel.s) {\n        cxy[0] = -1.0;\n        fxy[0] = -1.0;\n        ixy[0] = -1.0;\n      }\n      if (pixelLocation.t > 1.0 - onePixel.t) {\n        gxy[1] = -1.0;\n        hxy[1] = -1.0;\n        ixy[1] = -1.0;\n      }\n\n      // calculate hillshade\n      vec4 va = texture(u_image, pixelLocation + onePixel * axy);\n      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);\n      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);\n      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);\n      vec4 ve = texture(u_image, pixelLocation);\n      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);\n      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);\n      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);\n      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);\n\n      // calculate the rate of z change along the x, y, and diagonal direction\n      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;\n      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;\n      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);\n      float hillshade = 0.0;\n\n      // traditional single light source\n      if (u_hillshadeType == 0){\n        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;\n        float z = (u_cosZs[0] + cosDelta) / dzd;\n        if (z < 0.0)  z = 0.0;\n        hillshade = z;\n      } else {\n        // multi-directional with 6 light sources\n        for (int k = 0; k < 6; k++) {\n        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;\n        float z = (u_cosZs[k] + cosDelta) / dzd;\n        if (z < 0.0) z = 0.0;\n        hillshade = hillshade + z * u_weights[k];\n        if (k == 5) break;\n        }\n      }\n\n      // set color\n      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);\n      alpha *= u_opacity;\n      ","\n    }\n  "])),i))}(t,e),t}var F=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:U,ColorizerStretchUniforms:N,ColorizerUniforms:L,build:H},Symbol.toStringTag,{value:"Module"}))},13378:function(e,t,n){n.d(t,{S:function(){return _},a:function(){return b},b:function(){return g}});var i,r=n(30168),a=n(29134),o=n(7025),s=n(24967),l=n(54943),u=n(93511),c=n(96415),h=n(78980),d=n(98634),f=n(8654),v=n(64201),p=n(19253),_=255,m=1/_;function g(e){var t=new v.kG,n=t.fragment;return n.include(h.n),n.include(l.K),t.include(c.GZ),t.include(s.k),t.include(u.hb,e),n.uniforms.add(new p.A("shadowMap",(function(e,t){return t.shadowMap.depthTexture})),new p.A("depthMap",(function(e,t){var n;return null===(n=t.depth)||void 0===n?void 0:n.attachment})),new f.g("inverseViewMatrix",(function(e,t){return(0,a.U_)(y,(0,a.Iu)(y,t.camera.viewMatrix,t.camera.center))}))),n.constants.add("sampleValue","float",m),t.outputs.add("sampleCount","float"),n.code.add((0,d.H)(i||(i=(0,r.Z)(["void main(void) {\nfloat depth = depthFromTexture(depthMap, uv);\nif (depth >= 1.0 || depth <= 0.0) {\ndiscard;\n}\nfloat currentPixelDepth = linearizeDepth(depth);\nvec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\nvec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\nmat4 shadowMatrix;\nfloat linearDepth = -currentPixelDepth;\nint i = chooseCascade(linearDepth, shadowMatrix);\nif (i >= numCascades) {\ndiscard;\n}\nvec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\nif (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\ndiscard;\n}\nivec2 texSize = textureSize(shadowMap, 0);\nivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));\nfloat depthShadow = readShadowMapDepth(uvShadow, shadowMap);\nbool shadow = depthShadow < lvpos.z;\nif (!shadow) {\ndiscard;\n}\nsampleCount = sampleValue;\n}"])))),t}var y=(0,o.Ue)(),b=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:_,build:g},Symbol.toStringTag,{value:"Module"}))},89822:function(e,t,n){n.d(t,{S:function(){return T},a:function(){return M},b:function(){return k}});var i,r,a,o,s=n(30168),l=n(15671),u=n(43144),c=n(60136),h=n(29388),d=n(86361),f=n(24967),v=n(54943),p=n(96415),_=n(78980),m=n(95276),g=n(58406),y=n(98634),b=n(64201),w=n(19253),C=n(13378),x=n(79485),T=function(e){(0,c.Z)(n,e);var t=(0,h.Z)(n);function n(e){var i;return(0,l.Z)(this,n),(i=t.call(this))._data=e,i.sampleScale=0,i.opacityFromElevation=1,i.color=(0,d.d9)(S),i.bandSize=.1,i.threshold=.5,i}return(0,u.Z)(n,[{key:"shadowCastMap",get:function(){return this._data.shadowCastTexture}}]),n}(y.K),S=(0,d.al)(.01,0,.25,1);function k(e){var t=new b.kG,n=t.fragment;n.include(_.n),n.include(v.S),t.include(p.GZ),t.include(f.k);var l=e.visualization,u=e.bandsEnabled;n.constants.add("inverseSampleValue","float",C.S),n.uniforms.add(new w.A("shadowCastMap",(function(e){return e.shadowCastMap})),new g.p("sampleScale",(function(e){return e.sampleScale})),new g.p("opacityFromElevation",(function(e){return e.opacityFromElevation})),new m.N("uColor",(function(e){return e.color})));var c=l===x.w.Gradient,h=l===x.w.Threshold;return c&&u?n.uniforms.add(new g.p("bandSize",(function(e){return e.bandSize}))):h&&n.uniforms.add(new g.p("threshold",(function(e){return e.threshold}))),n.code.add((0,y.H)(i||(i=(0,s.Z)(["\n    void main(void) {\n      float record = texture(shadowCastMap, uv).r;\n      float pixelSamples = record * inverseSampleValue;\n      if (pixelSamples < 1.0) {\n        discard;\n      }\n\n      float strength = pixelSamples * sampleScale;\n\n      ","\n\n      ","\n\n      fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ",");\n    }\n  "])),h?(0,y.H)(r||(r=(0,s.Z)(["\n          if (strength <= threshold) {\n            discard;\n          }"]))):"",c&&u?(0,y.H)(a||(a=(0,s.Z)(["strength = ceil(strength / bandSize) * bandSize;"]))):"",c?(0,y.H)(o||(o=(0,s.Z)(["* strength"]))):"")),t}var M=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:T,build:k},Symbol.toStringTag,{value:"Module"}))},38727:function(e,t,n){n.d(t,{S:function(){return S},b:function(){return C}});var i,r=n(30168),a=n(29134),o=n(7025),s=n(32035),l=n(12400),u=n(75831),c=n(24967),h=n(137),d=n(93511),f=n(78980),v=n(49450),p=n(95276),_=n(58406),m=n(98634),g=n(8654),y=n(64201),b=n(19253),w=n(471);function C(e){var t=new y.kG;t.include(d.hb,e),t.include(c.k),t.include(u.R);var n=t.fragment;return n.include(f.n),n.uniforms.add(new b.A("defaultDepthTex",(function(e,t){return t.shadowMap.getSnapshot(w.i.ExcludeHighlight)})),new b.A("highlightDepthTex",(function(e,t){return t.shadowMap.getSnapshot(w.i.Highlight)})),new b.A("depthMap",(function(e,t){var n;return null===(n=t.depth)||void 0===n?void 0:n.attachment})),new b.A("highlightTexture",(function(e){return e.highlight})),new p.N("uColor",(function(e){return e.shadowColor})),new _.p("opacity",(function(e){return e.shadowOpacity})),new _.p("occludedOpacity",(function(e){return e.occludedShadowOpacity})),new _.p("terminationFactor",(function(e){return e.opacityElevation*e.dayNightTerminator})),new v.J("lightingMainDirectionView",(function(e,t){return(0,s.n)(T,(0,s.h)(T,t.lighting.mainLight.direction,t.camera.viewInverseTransposeMatrix))})),new g.g("inverseViewMatrix",(function(e,t){return(0,a.U_)(x,(0,a.Iu)(x,t.camera.viewMatrix,t.camera.center))}))),n.constants.add("unoccludedHighlightFlag","vec4",h.ck),n.code.add((0,m.H)(i||(i=(0,r.Z)(["\n    void main(void) {\n      vec4 highlightInfo = texture(highlightTexture, uv);\n      float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;\n      if (visiblyHighlighted > ",") {\n        discard;\n      }\n\n      float depth = depthFromTexture(depthMap, uv);\n\n      // 1.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard\n      if (depth >= 1.0 || depth <= 0.0) {\n        discard;\n      }\n\n      float currentPixelDepth = linearizeDepth(depth);\n      vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\n      vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\n\n      mat4 shadowMatrix;\n      float linearDepth = -currentPixelDepth;\n      int i = chooseCascade(linearDepth, shadowMatrix);\n      if (i >= numCascades) {\n        discard;\n      }\n\n      vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\n\n      // vertex completely outside? -> no shadow\n      if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\n        discard;\n      }\n\n      ivec2 texSize = textureSize(highlightDepthTex, 0);\n      ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));\n\n      float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);\n      bool shadowHighlight = depthHighlight < lvpos.z;\n      if (!shadowHighlight) {\n        discard;\n      }\n\n      float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);\n      bool shadowDefault = depthDefault < lvpos.z;\n\n      vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);\n      bool shaded = dot(normal, lightingMainDirectionView) < ",";\n\n      float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;\n      fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);\n    }\n  "])),m.H.float(.99999),m.H.float(.025))),t}var x=(0,o.Ue)(),T=(0,l.Ue)(),S=Object.freeze(Object.defineProperty({__proto__:null,build:C},Symbol.toStringTag,{value:"Module"}))},92014:function(e,t,n){n.d(t,{S:function(){return R},a:function(){return A},b:function(){return E},c:function(){return O}});var i,r,a,o,s,l,u,c,h=n(30168),d=n(43144),f=n(15671),v=n(60136),p=n(29388),_=n(6644),m=n(12400),g=n(69362),y=n(94951),b=n(92395),w=n(82999),C=n(49450),x=n(58406),T=n(98634),S=n(8654),k=n(64201),M=n(19253),P=n(4760),R=function(e){(0,v.Z)(n,e);var t=(0,p.Z)(n);function n(){var e;return(0,f.Z)(this,n),(e=t.apply(this,arguments)).texV=(0,_.Ue)(),e.altitudeFade=0,e.innerScale=0,e.undergroundFadeAlpha=0,e.silhouette=new E,e}return(0,d.Z)(n)}(T.K),E=(0,d.Z)((function e(){(0,f.Z)(this,e),this.center=(0,m.Ue)(),this.v1=(0,m.Ue)(),this.v2=(0,m.Ue)()}));function O(e){var t=new k.kG,n=t.vertex,d=t.fragment;if((0,b.Pe)(n),e.geometry===g.n.Underground)t.attributes.add(P.T.POSITION,"vec2"),t.varyings.add("color","vec4"),n.uniforms.add(new C.J("cameraPosition",(function(e,t){return t.camera.eye})),new x.p("undergroundFadeAlpha",(function(e){return e.undergroundFadeAlpha}))),n.code.add((0,T.H)(i||(i=(0,h.Z)(["void main(void) {\nfloat ndotl = dot(normalize(cameraPosition), mainLightDirection);\nfloat lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\ncolor = vec4(vec3(lighting), undergroundFadeAlpha);\ngl_Position = vec4(position.xy, 1.0, 1.0);\n}"])))),d.code.add((0,T.H)(r||(r=(0,h.Z)(["void main() {\nfragColor = color;\n}"]))));else{t.include(y.w,e),t.attributes.add(P.T.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");var f=e.geometry===g.n.Cylinder;n.uniforms.add(new S.g("proj",(function(e,t){return t.camera.projectionMatrix})),new S.g("view",(function(e,t){return t.camera.viewMatrix}))),f||(t.varyings.add("innerFactor","float"),n.uniforms.add(new C.J("silCircleCenter",(function(e){return e.silhouette.center}))),n.uniforms.add(new C.J("silCircleV1",(function(e){return e.silhouette.v1}))),n.uniforms.add(new C.J("silCircleV2",(function(e){return e.silhouette.v2}))),n.uniforms.add(new w.A("texV",(function(e){return e.texV}))),n.uniforms.add(new x.p("innerScale",(function(e){return e.innerScale}))));var v=1/128;n.code.add((0,T.H)(a||(a=(0,h.Z)(["\n\t\tvoid main(void) {\n      ","\n      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\n\n\t\t  gl_Position = transformPosition(proj, view, pos);\n\t\t  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane\n    }\n\t  "])),f?(0,T.H)(o||(o=(0,h.Z)(["\n      vec3 pos = position;\n      float ndotl = mainLightDirection.z;\n      vtc = vec2(0.0, position.z + 0.05);"]))):(0,T.H)(s||(s=(0,h.Z)(["\n      innerFactor = clamp(-position.z, 0.0, 1.0);\n      float scale = position.y * (1.0 + innerFactor * innerScale);\n      float phi = position.x * "," + 1.0;\n      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;\n      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);\n      vtc.x = position.x  * ",";\n      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;\n      "])),T.H.float(6.2831853*v),T.H.float(v)))),d.uniforms.add(new M.A("tex",(function(e){return e.texture}))),f||d.uniforms.add(new x.p("altitudeFade",(function(e){return e.altitudeFade}))),d.code.add((0,T.H)(l||(l=(0,h.Z)(["\n\t\tvoid main() {\n\t\t\tvec4 atmosphereColor = texture(tex, vtc) * falloff;\n      ","\n    }"])),f?(0,T.H)(u||(u=(0,h.Z)(["fragColor = atmosphereColor;"]))):(0,T.H)(c||(c=(0,h.Z)(["\n\t\t\tvec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);\n\t\t\tfragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));\n      "])))))}return t}var A=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:E,SimpleAtmospherePassParameters:R,build:O},Symbol.toStringTag,{value:"Module"}))},96894:function(e,t,n){n.d(t,{S:function(){return _},b:function(){return v}});var i,r,a=n(30168),o=n(29134),s=n(7025),l=n(95276),u=n(58406),c=n(98634),h=n(8654),d=n(64201),f=n(4760);function v(){var e=new d.kG;return e.attributes.add(f.T.POSITION,"vec3"),e.attributes.add(f.T.COLOR,"vec4"),e.attributes.add(f.T.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new h.g("transform",(function(e,t){return function(e,t){var n=24e-8;return(0,o.JG)(p,t.camera.projectionMatrix),p[10]=n-1,p[11]=-1,p[14]=(n-2)*t.camera.near,(0,o.Jp)(p,p,t.camera.viewMatrix),(0,o.Jp)(p,p,e.modelMatrix)}(e,t)})),new l.N("viewport",(function(e,t){return t.camera.fullViewport})),new u.p("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),e.vertex.code.add((0,c.H)(i||(i=(0,a.Z)(["void main(void) {\ngl_Position = transform * vec4(position, 0);\nvcolor = color / 1.2;\nvsize = size * 5.0 * pixelRatio;\ngl_PointSize = vsize;\n}"])))),e.fragment.code.add((0,c.H)(r||(r=(0,a.Z)(["void main() {\nfloat cap = 0.7;\nfloat scale = 1.0 / cap;\nfloat helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);\nfloat alpha = clamp((cap - helper) * scale, 0.0, 1.0);\nfloat intensity = alpha * alpha * alpha;\nif (vsize < 3.0) {\nintensity *= 0.5;\n}\nfragColor = vec4(vcolor.xyz, intensity);\n}"])))),e}var p=(0,s.Ue)(),_=Object.freeze(Object.defineProperty({__proto__:null,build:v},Symbol.toStringTag,{value:"Module"}))},73401:function(e,t,n){n.d(t,{S:function(){return l}});var i,r,a,o=n(84397),s={exports:{}};i=s,r=function(){var e=Math.PI,t=Math.sin,n=Math.cos,i=Math.tan,r=Math.asin,a=Math.atan2,o=Math.acos,s=e/180,l=864e5,u=2440588,c=2451545,h={dec:0,ra:0};function d(e){return new Date((e+.5-u)*l)}function f(e){return function(e){return e.valueOf()/l-.5+u}(e)-c}var v=23.4397*s;function p(e,r){return a(t(e)*n(v)-i(r)*t(v),n(e))}function _(e,i){return r(t(i)*n(v)+n(i)*t(v)*t(e))}function m(e,r,o){return a(t(e),n(e)*t(r)-i(o)*n(r))}function g(e,i,a){return r(t(i)*t(a)+n(i)*n(a)*n(e))}function y(e,t){return s*(280.16+360.9856235*e)-t}function b(e){return s*(357.5291+.98560028*e)}function w(e){return s*(1.9148*t(e)+.02*t(2*e)+3e-4*t(3*e))}function C(t,n){return t+n+102.9372*s+e}function x(e,t){var n=b(e),i=C(n,w(n));return t||(t={dec:0,ra:0}),t.dec=_(i,0),t.ra=p(i,0),t}var T={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,n,i){var r=s*-n,a=s*t,o=f(e),l=x(o,h),u=y(o,r)-l.ra;return i||(i={azimuth:0,altitude:0}),i.azimuth=m(u,a,l.dec),i.altitude=g(u,a,l.dec),i}},S=[[-.83,"sunrise","sunset"]];T.addTime=function(e,t,n){S.push([e,t,n])};var k=9e-4;function M(t,n){return Math.round(t-k-n/(2*e))}function P(t,n,i){return k+(t+n)/(2*e)+i}function R(e,n,i){return c+e+.0053*t(n)-.0069*t(2*i)}function E(e,i,r){return o((t(e)-t(i)*t(r))/(n(i)*n(r)))}function O(e){var i=s*(134.963+13.064993*e),r=s*(93.272+13.22935*e),a=s*(218.316+13.176396*e)+6.289*s*t(i),o=5.128*s*t(r),l=385001-20905*n(i);return{ra:p(a,o),dec:_(a,o),dist:l}}return T.getTimes=function(e,i,r){var a=s*-r,o=s*i,l=M(f(e),a),u=P(0,a,l),c=b(u),h=w(c),v=C(c,h),p=_(v,0),m=R(u,c,v);function g(e){return R(P(E(e,o,p),a,l),c,v)}var y,x,k,O,A,D={solarNoon:d(m),nadir:d(m-.5),polarException:T.PolarException.NORMAL};for(y=0,x=S.length;y<x;y+=1)A=m-((O=g((k=S[y])[0]*s))-m),D[k[1]]=d(A),D[k[2]]=d(O);return D.polarException=function(e){var i=(t(e)-t(o)*t(p))/(n(o)*n(p));return i<-1?T.PolarException.MIDNIGHT_SUN:i>1?T.PolarException.POLAR_NIGHT:T.PolarException.NORMAL}(S[0][0]*s),D},T.getMoonPosition=function(e,t,n){var r=s*-n,a=s*t,o=f(e),l=O(o),u=y(o,r)-l.ra,c=g(u,a,l.dec);return c+=.017*s/i(c+10.26*s/(c+5.1*s)),{azimuth:m(u,a,l.dec),altitude:c,distance:l.dist}},T.getMoonFraction=function(e){var i=f(e),r=x(i),s=O(i),l=149598e3,u=o(t(r.dec)*t(s.dec)+n(r.dec)*n(s.dec)*n(r.ra-s.ra)),c=a(l*t(u),s.dist-l*n(u));return(1+n(c))/2},T},void 0!==(a=r())&&(i.exports=a);var l=(0,o.g)(s.exports)},89438:function(e,t,n){n.d(t,{T:function(){return Ce},a:function(){return ke},b:function(){return xe}});var i,r,a,o,s,l,u,c,h,d,f,v,p,_,m,g,y,b,w,C,x,T,S,k,M,P,R,E,O,A,D,Z,I,L,N,U,H,F,V=n(1413),z=n(30168),q=n(43144),B=n(15671),G=n(60136),j=n(29388),W=n(29134),X=n(7025),Q=n(32035),Y=n(12400),J=n(92015),K=n(22357),$=n(37081),ee=n(33280),te=n(94951),ne=n(16010),ie=n(52276),re=n(60113),ae=n(97397),oe=n(16574),se=n(137),le=n(30694),ue=n(34975),ce=n(92395),he=n(8555),de=n(41481),fe=n(93511),ve=n(22702),pe=n(28288),_e=n(41012),me=n(49450),ge=n(98634),ye=n(76028),be=n(64201),we=n(19253),Ce=function(e){(0,G.Z)(n,e);var t=(0,j.Z)(n);function n(){return(0,B.Z)(this,n),t.apply(this,arguments)}return(0,q.Z)(n)}(pe.uS);function xe(e){var t=new be.kG,n=t.vertex,q=t.fragment,B=t.varyings;t.include(ie.f),t.include(ne.O,e),t.include(re.D,e);var G=function(){t.include(he.n,e),n.code.add((0,ge.H)(i||(i=(0,z.Z)(["vec3 getNormal() {\nfloat z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);\nvec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,\nnormalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);\nreturn normalize(n);\n}"]))))};(0,_e.Sv)(n,e),t.include(te.w,e);var j=e.overlayMode!==ve.gT.Disabled,X=j&&e.invisible;switch(e.output){case $.H_.Color:t.include(pe.EK,e),t.include(ue.XP,e),j&&t.include(ve.yl,(0,V.Z)((0,V.Z)({},e),{},{pbrMode:e.pbrMode===de.f7.Simplified?de.f7.TerrainWithWater:de.f7.Water}));var Y=e.overlayMode===ve.gT.EnabledWithWater;Y&&t.include(ae.M,e),B.add("vnormal","vec3"),B.add("vpos","vec3"),B.add("vup","vec3"),G(),e.screenSizePerspective&&(0,_e._8)(n);var Ce=e.receiveShadows&&!e.renderOccluded;Ce&&t.include(K.qj,e),e.screenSizePerspective&&(B.add("screenSizeDistanceToCamera","float"),B.add("screenSizeCosAngle","float")),n.code.add((0,ge.H)(r||(r=(0,z.Z)(["\n        void main(void) {\n          //Position\n          vpos = position;\n          vec3 positionWorld = position + localOrigin;\n          gl_Position = transformPosition(proj, view, vpos);\n\n          //Normal\n          vnormal = getNormal();\n\n          //Up\n          vup = getLocalUp(position, localOrigin);\n\n          ","\n\n          //Texture UV\n          vec2 uv = getUV0();\n          forwardTextureCoordinatesWithTransform(uv);\n          ","\n          ","\n\n          ","\n\n          ","\n\n        }\n      "])),Y?(0,ge.H)(a||(a=(0,z.Z)(["forwardVertexTangent(vnormal);"]))):(0,ge.H)(o||(o=(0,z.Z)([""]))),j?(0,ge.H)(s||(s=(0,z.Z)(["setOverlayVTC(uv);"]))):"",e.tileBorders?(0,ge.H)(l||(l=(0,z.Z)(["forwardTextureCoordinates();"]))):"",e.screenSizePerspective?(0,ge.H)(u||(u=(0,z.Z)(["\n          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;\n          screenSizeDistanceToCamera = length(viewPos);\n          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;\n          screenSizeCosAngle = abs(viewSpaceNormal.z);"]))):"",Ce?(0,ge.H)(c||(c=(0,z.Z)(["forwardLinearDepth();"]))):"")),t.include(ee.f5,e),t.include(ue.XP,e),t.include(le.K,e),t.include(fe.XE,e),(0,_e.hY)(q,e),(0,ue.PN)(q),(0,ue.sC)(q),q.uniforms.add(n.uniforms.get("localOrigin"),new me.J("viewDirection",(function(e,t){return(0,Q.n)(Se,(0,Q.s)(Se,t.camera.viewMatrix[12],t.camera.viewMatrix[13],t.camera.viewMatrix[14]))}))),Y&&q.uniforms.add(new we.A("ovWaterTex",(function(e,t){var n;return null===(n=t.overlay)||void 0===n?void 0:n.getTexture(J.D.WaterNormal)})),new ye.K("view",(function(e,t){return(0,W.Iu)(Te,t.camera.viewMatrix,e.origin)}))),q.code.add((0,ge.H)(h||(h=(0,z.Z)(["const float sliceOpacity = 0.2;\nfloat lum(vec3 c) {\nreturn (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;\n}"])))),(0,ce.Pe)(q),(0,ce.F1)(q),q.code.add((0,ge.H)(d||(d=(0,z.Z)(["\n        void main() {\n          vec3 normal = normalize(vnormal);\n          float vndl = dot(normal, mainLightDirection);\n\n          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));\n          float shadow = ",";\n\n          float ssao = evaluateAmbientOcclusionInverse();\n          vec4 tileColor = getTileColor();\n\n          ","\n\n          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here\n          // is neglectable because terrain typically renders first into the framebuffer.\n          if(tileColor.a <= 0.0) {\n            discard;\n          }\n\n          bool sliced = rejectBySlice(vpos);\n          if (sliced) {\n            tileColor *= sliceOpacity;\n          }\n\n          vec3 albedo = tileColor.rgb;\n\n          // heuristic shading function used in the old terrain, now used to add ambient lighting\n\n          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n\n          ","\n          ","\n          ","\n          ","\n          ","\n          fragColor = highlightSlice(fragColor, vpos);\n        }\n      "])),e.receiveShadows&&!e.renderOccluded?"readShadowMap(vpos, linearDepth)":e.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0",j?(0,ge.H)(f||(f=(0,z.Z)(["\n              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);\n              vec4 overlayColor = overlayOpacity * overlayColorOpaque;\n              ","\n              vec4 groundColor = tileColor;\n              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;"])),e.invisible?(0,ge.H)(v||(v=(0,z.Z)(["if (overlayColor.a == 0.0) { discard; }"]))):""):"",e.pbrMode===de.f7.Simplified||e.pbrMode===de.f7.TerrainWithWater?(0,ge.H)(p||(p=(0,z.Z)(["fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);"]))):(0,ge.H)(_||(_=(0,z.Z)(["fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);"]))),Y?(0,ge.H)(m||(m=(0,z.Z)(["\n              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);\n                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);\n                vec4 viewPosition = view*vec4(vpos, 1.0);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                float opacity = sliced ? sliceOpacity : 1.0;\n                // un-gamma the ground color to mix in linear space\n                fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;\n              }"]))):"",e.screenSizePerspective?(0,ge.H)(g||(g=(0,z.Z)(["\n            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));\n            if (perspectiveScale <= 0.25) {\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);\n            }\n            else if (perspectiveScale <= 0.5) {\n              fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);\n            }\n            else if (perspectiveScale >= 0.99) {\n              fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);\n            }\n            else {\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);\n            }"]))):"",e.visualizeNormals?e.spherical?(0,ge.H)(y||(y=(0,z.Z)(["\n                  vec3 localUp = normalize(vpos + localOrigin);\n                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));\n                  vec3 forward = normalize(cross(localUp, right));\n                  mat3 tbn = mat3(right, forward, localUp);\n                  vec3 tNormal = normalize(normal * tbn);\n                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n              "]))):(0,ge.H)(b||(b=(0,z.Z)(["\n                  vec3 tNormal = normalize(normal);\n                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n              "]))):"",e.tileBorders?(0,ge.H)(w||(w=(0,z.Z)(["\n              vec2 dVuv = fwidth(vuv0);\n              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));\n              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);"]))):""));break;case $.H_.Depth:X&&t.include(ve.yl,e),n.code.add((0,ge.H)(C||(C=(0,z.Z)(["\n              void main(void) {\n                ","\n                gl_Position = transformPosition(proj, view, position);\n              }\n          "])),X?(0,ge.H)(x||(x=(0,z.Z)(["setOverlayVTC(getUV0());"]))):"")),q.code.add((0,ge.H)(T||(T=(0,z.Z)(["\n              void main() {\n                ","\n              }\n          "])),X?(0,ge.H)(S||(S=(0,z.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""));break;case $.H_.Shadow:case $.H_.ShadowHighlight:case $.H_.ShadowExcludeHighlight:case $.H_.ViewshedShadow:t.include(oe.F,e),(0,K.Lm)(t),(0,K.Zu)(t),n.code.add((0,ge.H)(k||(k=(0,z.Z)(["void main(void) {\ngl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);\n}"])))),q.code.add((0,ge.H)(M||(M=(0,z.Z)(["void main() {\noutputDepth(linearDepth);\n}"]))));break;case $.H_.Normal:X&&t.include(ve.yl,e),B.add("vnormal","vec3"),(0,_e._8)(n),G(),n.code.add((0,ge.H)(P||(P=(0,z.Z)(["\n        void main(void) {\n          ","\n          gl_Position = transformPosition(proj, view, position);\n          vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);\n        }\n      "])),X?(0,ge.H)(R||(R=(0,z.Z)(["setOverlayVTC(getUV0());"]))):"")),q.code.add((0,ge.H)(E||(E=(0,z.Z)(["\n        void main() {\n          ","\n          vec3 normal = normalize(vnormal);\n          if (gl_FrontFacing == false) {\n            normal = -normal;\n          }\n          fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);\n        }\n      "])),X?(0,ge.H)(O||(O=(0,z.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""));break;case $.H_.Highlight:j&&t.include(ve.yl,e),n.code.add((0,ge.H)(A||(A=(0,z.Z)(["\n          void main() {\n            ","\n            gl_Position = transformPosition(proj, view, position);\n          }\n        "])),j?(0,ge.H)(D||(D=(0,z.Z)(["setOverlayVTC(getUV0());"]))):"")),t.include(se.bA,e),q.code.add((0,ge.H)(Z||(Z=(0,z.Z)(["\n          void main() {\n            ","\n            outputHighlight();\n          }\n        "])),j?(0,ge.H)(I||(I=(0,z.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""))}return e.output===$.H_.ObjectAndLayerIdColor&&(j?(t.include(ve.yl,(0,V.Z)((0,V.Z)({},e),{},{pbrMode:de.f7.Disabled})),n.code.add((0,ge.H)(L||(L=(0,z.Z)(["void main(void) {\ngl_Position = transformPosition(proj, view, position);\nsetOverlayVTC(getUV0());\n}"])))),q.code.add((0,ge.H)(N||(N=(0,z.Z)(["void main() {\nfragColor = getOverlayColorTexel(vtcOverlay);\n}"]))))):(n.code.add((0,ge.H)(U||(U=(0,z.Z)(["void main(void) {\n        ","\n      }"])),e.opaque?(0,ge.H)(H||(H=(0,z.Z)([" gl_Position = transformPosition(proj, view, position);"]))):"")),q.code.add((0,ge.H)(F||(F=(0,z.Z)(["void main() {\nfragColor = vec4(0.0);\n}"])))))),t}var Te=(0,X.Ue)(),Se=(0,Y.Ue)(),ke=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:Ce,build:xe},Symbol.toStringTag,{value:"Module"}))},95720:function(e,t,n){n.d(t,{V:function(){return R},a:function(){return A},b:function(){return E}});var i,r,a,o,s=n(30168),l=n(43144),u=n(15671),c=n(60136),h=n(29388),d=n(29134),f=n(7025),v=n(75831),p=n(24967),_=n(54943),m=n(76284),g=n(24842),y=n(27193),b=n(82999),w=n(49450),C=n(699),x=n(99339),T=n(98634),S=n(8654),k=n(78928),M=n(64201),P=n(19253),R=function(e){(0,c.Z)(n,e);var t=(0,h.Z)(n);function n(){var e;return(0,u.Z)(this,n),(e=t.apply(this,arguments)).targetVector=[1,0,0],e.upVector=[0,0,1],e.fovs=[45,45],e.headingAndTilt=[0,0],e.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},e.projectionMatrices=f.Wd.flat(),e.viewMatrices=f.Wd.flat(),e}return(0,l.Z)(n)}(m.c);function E(e){var t=new M.kG,n=t.fragment;t.include(p.k),t.include(m.C),t.include(y.r),n.include(_.K),n.include(g.f),n.uniforms.add(new P.A("depthTexture",(function(e,t){var n;return null===(n=t.depth)||void 0===n?void 0:n.attachment}))),n.uniforms.add(new S.g("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new S.g("inverseViewNormalMatrix",(function(e,t){return(0,d.iS)(O,t.camera.viewInverseTransposeMatrix)}))),n.uniforms.add(new w.J("viewshedTargetVector",(function(e,t){return e.targetVector})),new w.J("viewshedUpVector",(function(e,t){return e.upVector})),new b.A("viewshedFOVs",(function(e,t){return e.fovs})),new b.A("viewshedHeadingAndTilt",(function(e,t){return e.headingAndTilt})),new b.A("viewshedNearFar",(function(e,t){var n;return null!==(n=e.shadowMap.nearFar)&&void 0!==n?n:[1,100]}))),n.uniforms.add(new P.A("viewshedShadowMap",(function(e){return e.shadowMap.depthTexture})),new k.G("viewshedProjectionMatrices",(function(e,t){return e.projectionMatrices}),6),new k.G("viewshedViewMatrices",(function(e,t){return e.viewMatrices}),6),new x._("viewshedNumFaces",(function(e,t){return e.shadowMap.numActiveFaces})),new C.O("viewshedAtlasRegions",(function(e,t){return e.shadowMap.atlasRegions.flat()}),24)),n.constants.add("visibleColor","vec4",[0,1,0,.5]),n.constants.add("occludedColor","vec4",[1,0,0,.5]);var l=e.useNormalMap;return l?(n.uniforms.add(new P.A("normalMap",(function(e,t){return e.normalTexture}))),n.code.add((0,T.H)(i||(i=(0,s.Z)(["vec3 normalFromTexture() {\nvec4 norm4 = texture(normalMap, uv);\nvec3 nNormal = vec3(-1.0) + 2.0 * norm4.xyz;\nreturn normalize((inverseViewNormalMatrix * vec4(nNormal, 1.0)).xyz);\n}"]))))):t.include(v.R),n.code.add((0,T.H)(r||(r=(0,s.Z)(["\n    // UV coordinates of point projected onto viewshed shadow map\n    vec2 getViewshedUv(vec4 worldPosition, int face) {\n      mat4 viewshedMatrix = viewshedProjectionMatrices[face];\n      vec4 viewshedUv4 = viewshedMatrix * worldPosition;\n      vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;\n      return viewshedUv.xy;\n    }\n\n    float viewshedDepthToFloat(float depth) {\n      return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);\n    }\n\n    // Orthographic depth to viewshed of given point and given cube map face in range [0, 1].\n    float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {\n      mat4 viewshedViewMatrix = viewshedViewMatrices[face];\n      vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;\n      vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;\n      float depth = -viewshedUv.z;\n      return viewshedDepthToFloat(depth);\n    }\n\n    // Read depth from shadow map given uv and cube map face\n    float getDepthFromShadowMap(vec2 uv, int face) {\n      int index = 4 * face;\n\n      float umin = viewshedAtlasRegions[index];\n      float umax = viewshedAtlasRegions[index + 1];\n      float vmin = viewshedAtlasRegions[index + 2];\n      float vmax = viewshedAtlasRegions[index + 3];\n\n      vec4 atlasRegion = vec4(umin, vmin, umax, vmax);\n      return rgba4ToFloat(textureAtlasLookup(viewshedShadowMap, uv, atlasRegion));\n    }\n\n    struct ViewshedPoint {\n      int face;\n      vec2 uv;\n      bool isWithin;\n      float orthographicDepth;\n    };\n\n    // Find cube map face the given position lies in and return relevant information about it\n    bool getViewshedPoint(vec4 worldPosition, out ViewshedPoint point) {\n      vec3 nUp = normalize(viewshedUpVector);\n\n      // Try with all active cube map faces\n      for(int i=0; i < viewshedNumFaces; i++) {\n\n        // Check if when projected, point lies within shadow map texture\n        vec2 viewshedUv = getViewshedUv(worldPosition, i);\n        if (viewshedUv.x > 0.0 && viewshedUv.x < 1.0 && viewshedUv.y > 0.0 && viewshedUv.y < 1.0) {\n          float orthoDepth = getOrthographicDepthToViewshed(worldPosition, i);\n          if (orthoDepth >= 0.0) { // found a cube map face\n\n            // Check whether point is really inside viewshed geometry, not just within the camera frustum\n\n            // outside farDistance\n            vec3 position = worldPosition.xyz;\n            bool isWithin = length(position) <= viewshedNearFar[1];\n\n            // horizontally outside fov\n            float t = dot(nUp, position);\n            bool isBottomHalf = t > 0.0;\n            vec3 nProjVector = normalize(position - t * nUp);\n            if (isWithin) {\n              float angle = acos(dot(normalize(viewshedTargetVector), nProjVector));\n              if (angle > viewshedFOVs[0] / 2.0) {\n                isWithin = false;\n              }\n            }\n\n            // vertically outside fov\n            if (isWithin) {\n              float angle = acos(dot(nProjVector, normalize(position)));\n              if (!isBottomHalf) {\n                angle = -angle;\n              }\n              float tilt = viewshedHeadingAndTilt[1];\n              float limit = viewshedFOVs[1] / 2.0;\n              if (angle > limit || angle < -limit) {\n                isWithin = false;\n              }\n            }\n\n            point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);\n            return true;\n          }\n        }\n      }\n\n      // no cube face matches\n      return false;\n    }\n\n    float normalCosAngle(float linearDepth, vec3 localPosition) {\n      ",";\n\n      vec3 viewingDir = normalize(localPosition);\n      return dot(normal, viewingDir);\n    }\n\n    void main() {\n      float depth = depthFromTexture(depthTexture, uv);\n\n      // Outside camera planes\n      if (depth >= 1.0 || depth <= 0.0) {\n        return;\n      }\n\n      float linearDepth = linearizeDepth(depth);\n\n      // Relative to viewshed position\n      vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);\n\n      ViewshedPoint point;\n      bool foundFace = getViewshedPoint(localPosition, point);\n\n      // Outside every viewshed\n      if (!foundFace || !point.isWithin) {\n        return;\n      }\n\n      float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);\n      float distance = point.orthographicDepth;\n\n      bool visible = distance < viewshedDepth;\n      fragColor = visible ? visibleColor : occludedColor;\n\n      float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);\n\n      // Everything facing away, and close to parallel is considered occluded.\n      // Theshold corresponds to around 0.6 degrees, tuned empirically.\n      if (cosAngle > -0.01) {\n        fragColor = occludedColor;\n      }\n    }"])),l?(0,T.H)(a||(a=(0,s.Z)(["vec3 normal = normalFromTexture();"]))):(0,T.H)(o||(o=(0,s.Z)(["\n        vec3 cameraSpacePosition = reconstructPosition(gl_FragCoord.xy, linearDepth);\n        vec3 normal = normalFromDepth(depthTexture, cameraSpacePosition, gl_FragCoord.xy, uv);\n        normal = (inverseViewNormalMatrix * vec4(normal, 1.0)).xyz;\n        "]))))),t}var O=(0,f.Ue)(),A=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:R,build:E},Symbol.toStringTag,{value:"Module"}))},70116:function(e,t,n){var i;n.d(t,{Y:function(){return i}}),function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"}(i||(i={}))},47898:function(e,t,n){n.d(t,{Fp:function(){return h},GJ:function(){return l},M1:function(){return a},MQ:function(){return p},Ww:function(){return _},bA:function(){return d},hw:function(){return f},mE:function(){return c},ne:function(){return s},nn:function(){return u},qF:function(){return m},yG:function(){return o},yP:function(){return v}});var i=n(1413),r=n(68860);function a(e){return{value:e}}function o(e,t){return{type:(0,r.UF)(t),value:e,unit:t}}function s(e,t){return{type:(0,r.UF)(t),value:e,unit:t}}function l(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"arithmetic";return{type:(0,r.UF)(t),value:e,unit:t,rotationType:n}}function u(e,t){var n=c(e,t);return"angle"===e.type?l(n,t,e.rotationType):function(e,t){return{type:(0,r.UF)(t),value:e,unit:t}}(n,t)}function c(e,t){return(0,r.En)(e.value,e.unit,t)}function h(e,t){return null==e?t:null==t||e.value>(0,r.En)(t.value,t.unit,e.unit)?e:t}function d(e,t){return null==e?null:(0,i.Z)((0,i.Z)({},e),{},{value:e.value*t})}function f(e,t,n){if(t===n)return e;switch(n){case"arithmetic":case"geographic":return 90-e}}var v=o(0,"meters"),p=s(0,"square-meters"),_=(l(0,"radians"),l(0,"degrees")),m=l(0,"degrees","geographic")},85305:function(e,t,n){n.d(t,{BR:function(){return w},E2:function(){return E},Is:function(){return T},Kf:function(){return b},NE:function(){return k},P0:function(){return y},Tz:function(){return R},Ue:function(){return d},ej:function(){return C},id:function(){return x},pb:function(){return g},pt:function(){return _},qf:function(){return f},rF:function(){return S},yS:function(){return P}});var i=n(29134),r=n(32035),a=n(12400),o=n(83448),s=n(78952),l=n(29691),u=n(14320),c=n(82218),h=n(23470);function d(e){var t=e.value,n=e.operations;return{operations:n,value:n.create(t)}}function f(e,t,n){return e.operations.setExtent(e.value,t,n.value),n}function v(e){return{operations:e,value:e.create()}}function p(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:v(e);return n.operations=e,e.copy(t,n.value),n}function _(e){return p(h.s,(0,h.f)(0,0,0,(0,o.Iu)(e).radius))}var m=Math.pow(2,50);function g(){return p(c.b,(0,c.f)([0,0,0],[m,0,0],[0,m,0]))}function y(e,t,n){return e.operations.axisAt(e.value,t,u.R.Z,n)}function b(e,t,n,i){return e.operations.axisAt(e.value,t,n,i)}function w(e,t,n){return e.operations.intersectRay(e.value,t,n)}function C(e,t,n){return e.operations.intersectRayClosestSilhouette(e.value,t,n)}function x(e,t){return e.operations.altitudeAt(e.value,t)}function T(e,t,n,i){return e.operations.setAltitudeAt(e.value,t,n,i)}function S(e,t,n,a){return t!==a&&(0,i.JG)(a,t),(0,r.s)(M,a[12],a[13],a[14]),T(e,M,n,M),a[12]=M[0],a[13]=M[1],a[14]=M[2],a}function k(e,t,n){return e.operations.elevate(e.value,t,n.value)}var M=(0,a.Ue)();function P(e,t,n,i,a){return a[0]=(0,r.m)(e,t),a[1]=(0,r.m)(e,n),a[2]=(0,r.m)(e,i),a}function R(e,t,n,i,a){(0,r.c)(n,e),(0,r.c)(O,t),(0,r.n)(O,O),(0,r.b)(i,O,n),(0,r.b)(a,i,n)}function E(e,t){return e?(0,l.rS)(t):t.isGeographic?s.Z.PlateCarree:t}var O=(0,a.Ue)()},28970:function(e,t,n){n.d(t,{d:function(){return i}});var i="OBJECTID"},22689:function(e,t,n){n.d(t,{b:function(){return a}});var i=n(15671),r=n(43144),a=function(){function e(t){(0,i.Z)(this,e),this._store=t}return(0,r.Z)(e,[{key:"destroy",value:function(){this._store.destroy()}},{key:"get",value:function(e){return this._store.get(e)}},{key:"put",value:function(e,t){this._store.put(e,t,t.values.byteLength+256)}}]),e}()},8904:function(e,t,n){n.d(t,{G$:function(){return g},OB:function(){return _},Tl:function(){return m}});var i=n(37762),r=n(60136),a=n(29388),o=n(15671),s=n(43144),l=(n(59486),n(93169),n(42537)),u=n(32718),c=n(68860),h=n(65156),d=n(81753),f=n(848),v=function(){return u.Z.getLogger("esri.layers.support.ElevationSampler")},p=function(){function e(){(0,o.Z)(this,e)}return(0,s.Z)(e,[{key:"queryElevation",value:function(e){return g(e.clone(),this)}},{key:"on",value:function(){return(0,l.kB)()}},{key:"projectIfRequired",value:function(e,t){return y(e,t)}}]),e}(),_=function(e){(0,r.Z)(n,e);var t=(0,a.Z)(n);function n(e,i,r){var a;(0,o.Z)(this,n),(a=t.call(this)).tile=e,a.noDataValue=r;var s=e.tile.extent;a.extent=(0,h.HH)(s,i.spatialReference),a.extent.zmin=e.zmin,a.extent.zmax=e.zmax,a._aaExtent=s;var l=(0,c.c9)(i.spatialReference),u=i.lodAt(e.tile.level).resolution*l;return a.demResolution={min:u,max:u},a}return(0,s.Z)(n,[{key:"spatialReference",get:function(){return this.extent.spatialReference}},{key:"contains",value:function(e){var t=this.projectIfRequired(e,this.spatialReference);return null!=t&&this.containsAt(t.x,t.y)}},{key:"containsAt",value:function(e,t){return(0,h.jE)(this._aaExtent,e,t)}},{key:"elevationAt",value:function(e,t){var n;if(!this.containsAt(e,t)){var i=this.extent,r="".concat(i.xmin,", ").concat(i.ymin,", ").concat(i.xmax,", ").concat(i.ymax);return v().warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(r,")")),this.noDataValue}return null!==(n=this.tile.sample(e,t))&&void 0!==n?n:this.noDataValue}}]),n}(p),m=function(e){(0,r.Z)(n,e);var t=(0,a.Z)(n);function n(e,i,r){var a,s;(0,o.Z)(this,n),a=t.call(this),"number"==typeof i?(a.noDataValue=i,s=null):(s=i,a.noDataValue=r),a.samplers=s?e.map((function(e){return new _(e,s,a.noDataValue)})):e;var l=a.samplers[0];if(l){a.extent=l.extent.clone();var u=l.demResolution,c=u.min,d=u.max;a.demResolution={min:c,max:d};for(var f=1;f<a.samplers.length;f++){var v=a.samplers[f];a.extent.union(v.extent),a.demResolution.min=Math.min(a.demResolution.min,v.demResolution.min),a.demResolution.max=Math.max(a.demResolution.max,v.demResolution.max)}}else a.extent=(0,h.HH)((0,h.Ue)(),s.spatialReference),a.demResolution={min:0,max:0};return a}return(0,s.Z)(n,[{key:"spatialReference",get:function(){return this.extent.spatialReference}},{key:"elevationAt",value:function(e,t){var n,r,a=!1,o=(0,i.Z)(this.samplers);try{for(o.s();!(r=o.n()).done;){var s=r.value;if(s.containsAt(e,t)&&(a=!0,(n=s.elevationAt(e,t))!==s.noDataValue))return n}}catch(l){o.e(l)}finally{o.f()}return null!=n?n:(a||v().warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler")),this.noDataValue)}}]),n}(p);function g(e,t){var n=y(e,t.spatialReference);if(!n)return null;switch(e.type){case"point":!function(e,t,n){e.z=n.elevationAt(t.x,t.y)}(e,n,t);break;case"polyline":!function(e,t,n){b.spatialReference=t.spatialReference;for(var i=e.hasM&&!e.hasZ,r=0;r<e.paths.length;r++)for(var a=e.paths[r],o=t.paths[r],s=0;s<a.length;s++){var l=a[s],u=o[s];b.x=u[0],b.y=u[1],i&&(l[3]=l[2]),l[2]=n.elevationAt(b.x,b.y)}e.hasZ=!0}(e,n,t);break;case"multipoint":!function(e,t,n){b.spatialReference=t.spatialReference;for(var i=e.hasM&&!e.hasZ,r=0;r<e.points.length;r++){var a=e.points[r],o=t.points[r];b.x=o[0],b.y=o[1],i&&(a[3]=a[2]),a[2]=n.elevationAt(b.x,b.y)}e.hasZ=!0}(e,n,t)}return e}function y(e,t){if(null==e)return null;var n=e.spatialReference;if(n.equals(t))return e;var i=(0,d.iV)(e,t);return i||v().error("Cannot project geometry spatial reference (wkid:".concat(n.wkid,") to elevation sampler spatial reference (wkid:").concat(t.wkid,")")),i}var b=new f.Z},11939:function(e,t,n){n.d(t,{K:function(){return a}});var i=n(43144),r=n(15671),a=(0,i.Z)((function e(t,n){(0,r.Z)(this,e),this.data=t,this.safeWidth=.99999999*(t.width-1),this.dx=(t.width-1)/(n[2]-n[0]),this.dy=(t.width-1)/(n[3]-n[1]),this.x0=n[0],this.y1=n[3]}))},16553:function(e,t,n){n.d(t,{B:function(){return b},J:function(){return g}});var i=n(74165),r=n(37762),a=n(15861),o=n(10064),s=n(32718),l=n(76672),u=n(76969),c=n(6291),h=n(39638),d=n(37270),f=n(93253),v=n(819),p=function(){return s.Z.getLogger("esri.layers.support.labelFormatUtils")},_={type:"simple",evaluate:function(){return null}},m={getAttribute:function(e,t){return e.field(t)}};function g(e,t,n){return y.apply(this,arguments)}function y(){return(y=(0,a.Z)((0,i.Z)().mark((function e(t,n,r){var a,s,u,c,h,d;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.symbol&&n){e.next=2;break}return e.abrupt("return",_);case 2:if(a=t.where,"arcade"!==(s=(0,f.hV)(t)).type){e.next=12;break}return e.next=6,(0,v.WW)(s.expression,r,n);case 6:if(null!=(c=e.sent)){e.next=9;break}return e.abrupt("return",_);case 9:u={type:"arcade",evaluate:function(e,t){try{var n="attributes"in e?c.repurposeFeature(e):e;n.contextTimeZone=null!==t&&void 0!==t?t:null;var i=c.evaluate({$view:{timeZone:t},$feature:n},c.services);if(null!=i)return i.toString()}catch(r){p().error(new o.Z("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:r,feature:e,expression:s}))}return null},needsHydrationToEvaluate:function(){return null==(0,f.el)(s.expression)}},e.next=13;break;case 12:u={type:"simple",evaluate:function(e){return s.expression.replaceAll(/{[^}]*}/g,(function(t){var i=t.slice(1,-1),r=n.get(i);if(!r)return t;var a=null;return"attributes"in e?e&&e.attributes&&(a=e.attributes[r.name]):a=e.field(r.name),null==a?"":b(a,r)}))}};case 13:if(!a){e.next=25;break}return e.prev=14,e.next=17,(0,l.E)(a,n);case 17:h=e.sent,e.next=23;break;case 20:return e.prev=20,e.t0=e.catch(14),e.abrupt("return",(p().error(new o.Z("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:a,error:e.t0})),_));case 23:d=u.evaluate,u.evaluate=function(e,t){var n="attributes"in e?void 0:m;try{if(h.testFeature(e,n))return d(e,t)}catch(i){p().error(new o.Z("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:a,feature:e,error:i}))}return null};case 25:return e.abrupt("return",u);case 26:case"end":return e.stop()}}),e,null,[[14,20]])})))).apply(this,arguments)}function b(e,t){if(null==e)return"";var n=t.domain;if(n)if("codedValue"===n.type||"coded-value"===n.type){var i,a=e,o=(0,r.Z)(n.codedValues);try{for(o.s();!(i=o.n()).done;){var s=i.value;if(s.code===a)return s.name}}catch(m){o.e(m)}finally{o.f()}}else if("range"===n.type){var l=(0,h.D3)(t),f=l.max,v=l.min,p=+e;if(null!=v&&null!=f&&v<=p&&p<=f)return n.name}var _=e;return(0,d.y2)(t)?_=(0,u.p6)(_,(0,u.Ze)("short-date")):(0,d.H7)(t)&&(_=(0,c.uf)(+_)),_||""}},74509:function(e,t,n){n.d(t,{AA:function(){return v},Jn:function(){return u},LR:function(){return P},Lt:function(){return d},O3:function(){return w},Ou:function(){return g},RL:function(){return h},Uy:function(){return S},VW:function(){return l},W_:function(){return T},Wb:function(){return k},XH:function(){return p},Zz:function(){return o},ap:function(){return m},fl:function(){return f},fm:function(){return R},jG:function(){return E},kf:function(){return M},mF:function(){return s},tR:function(){return O},tq:function(){return C},vQ:function(){return y},vu:function(){return c},zx:function(){return b}});var i=n(68860),r=n(88152);function a(e){return e?E:O}function o(e,t){return null!==t&&void 0!==t&&t.mode?t.mode:a(e).mode}function s(e,t){return null!=t?t:a(e)}function l(e,t){return o(null!=e&&e.hasZ,t)}function u(e,t){return s(null!=e&&!!e.hasZ,t)}function c(e){var t=_(e);return l(e.geometry,t)}function h(e){var t=_(e),n=l(e.geometry,t);return{mode:n,offset:null!=t&&"on-the-ground"!==n?R(t):0,featureExpressionInfo:null===t||void 0===t?void 0:t.featureExpressionInfo}}function d(e){return p(h(e))}function f(e){return p(e)||v(e)}function v(e){var t;return"0"===(null===e||void 0===e||null===(t=e.featureExpressionInfo)||void 0===t?void 0:t.expression)}function p(e){if(!e)return!1;if("on-the-ground"===e.mode)return!1;var t=null!==e&&void 0!==e&&e.featureExpressionInfo?e.featureExpressionInfo.expression:null;return!(!t||"0"===t)}function _(e){return e.layer&&"elevationInfo"in e.layer?e.layer.elevationInfo:null}function m(e,t){if(null===e||void 0===e||!e.offset)return 0;var n=e.offset,r=e.unit;if("decimal-degrees"===r)return 0;var a="unknown"!==r&&r?r:"meters",o=(0,i.y)(t);return o?(0,i.En)(n,a,o):0}function g(e,t,n){var i,r;if(null!==n&&void 0!==n&&n.mode){var a=e.hasZ?e.z:0,o=m(n,e.spatialReference);switch(n.mode){case"absolute-height":return a-o;case"on-the-ground":return 0;case"relative-to-ground":return a-((null!==(i=t.elevationProvider.getElevation(e.x,e.y,a,e.spatialReference,"ground"))&&void 0!==i?i:0)+o);case"relative-to-scene":return a-((null!==(r=t.elevationProvider.getElevation(e.x,e.y,a,e.spatialReference,"scene"))&&void 0!==r?r:0)+o)}}}function y(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return w(e,t.x,t.y,t.hasZ?t.z:0,t.spatialReference,n,i)}function b(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return w(e,t[0],t[1],t.length>2?t[2]:0,n,i,r)}function w(e,t,n,i,r,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(null!=a){var s=null!=o?o.mode:"absolute-height";if("on-the-ground"===s)return 0;var l=C(t,n,i,r,e,a),u=l.absoluteZ;return x(u,t,n,i,r,e,o,s)}}function C(e,t,n,i,r,a){var o=m(a,i);switch(a.mode){case"absolute-height":return{absoluteZ:n+o,elevation:0};case"on-the-ground":var s,l=null!==(s=r.elevationProvider.getElevation(e,t,0,i,"ground"))&&void 0!==s?s:0;return{absoluteZ:l,elevation:l};case"relative-to-ground":var u,c=null!==(u=r.elevationProvider.getElevation(e,t,n,i,"ground"))&&void 0!==u?u:0;return{absoluteZ:n+c+o,elevation:c};case"relative-to-scene":var h,d=null!==(h=r.elevationProvider.getElevation(e,t,n,i,"scene"))&&void 0!==h?h:0;return{absoluteZ:n+d+o,elevation:d}}}function x(e,t,n,i,r,a,o,s){var l,u,c=m(o,r);switch(s){case"absolute-height":return e-c;case"relative-to-ground":return e-((null!==(l=a.elevationProvider.getElevation(t,n,i,r,"ground"))&&void 0!==l?l:0)+c);case"relative-to-scene":return e-((null!==(u=a.elevationProvider.getElevation(t,n,i,r,"scene"))&&void 0!==u?u:0)+c)}}function T(e,t){if(null==t)return!1;var n=t.mode;return null!=n&&("scene"===e&&"relative-to-scene"===n||"ground"===e&&"absolute-height"!==n)}function S(e,t,n){return n&&n.mode!==t?"".concat(e," only support ").concat(t," elevation mode"):null}function k(e,t,n){return(null===n||void 0===n?void 0:n.mode)===t?"".concat(e," do not support ").concat(t," elevation mode"):null}function M(e,t){return null!=(null===t||void 0===t?void 0:t.featureExpressionInfo)&&"0"!==t.featureExpressionInfo.expression?"".concat(e," do not support featureExpressionInfo"):null}function P(e,t){t&&e.warn(".elevationInfo=",t)}function R(e){var t;return(null!==(t=null===e||void 0===e?void 0:e.offset)&&void 0!==t?t:0)*(0,r.Z7)(null===e||void 0===e?void 0:e.unit)}var E={mode:"absolute-height",offset:0},O={mode:"on-the-ground",offset:null}},87422:function(e,t,n){n.d(t,{s:function(){return c}});var i=n(15671),r=n(43144),a=n(60136),o=n(29388),s=n(91505),l=n(93169),u=n(66978),c=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments))._fadeOutResolver=null,e._fadeInResolver=null,e._clips=null,e.computedVisible=!0,e.computedOpacity=1,e.fadeTransitionEnabled=!1,e.inFadeTransition=!1,e._isReady=!1,e._opacity=1,e.parent=null,e._stage=null,e._visible=!0,e}return(0,r.Z)(n,[{key:"clips",get:function(){return this._clips},set:function(e){this._clips=e,this.requestRender()}},{key:"isReady",get:function(){return this._isReady}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}},{key:"stage",get:function(){return this._stage},set:function(e){var t;if(this._stage!==e){var n=this._stage;this._stage=e,e?(null===(t=this._stage)||void 0===t?void 0:t.untrashDisplayObject(this))||(this.onAttach(),this.emit("attach")):null===n||void 0===n||n.trashDisplayObject(this)}}},{key:"transforms",get:function(){return this._getTransforms()}},{key:"_getTransforms",value:function(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible!==e&&(this._visible=e,this.requestRender())}},{key:"hasLabels",get:function(){return!1}},{key:"hasHighlight",get:function(){return!1}},{key:"hasBlending",get:function(){return!1}},{key:"fadeIn",value:function(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=(0,u.hh)(),this.requestRender()),this._fadeInResolver.promise}},{key:"fadeOut",value:function(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=(0,u.hh)(),this.requestRender()),this._fadeOutResolver.promise}},{key:"endTransitions",value:function(){var e,t;null!==(e=this._fadeInResolver)&&void 0!==e&&e.call(this),this._fadeInResolver=null,null!==(t=this._fadeOutResolver)&&void 0!==t&&t.call(this),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}},{key:"beforeRender",value:function(e){this.updateTransitionProperties(e.deltaTime,e.state.scale),this.setTransform(e.state)}},{key:"afterRender",value:function(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&0===this.computedOpacity&&(this._fadeOutResolver(),this._fadeOutResolver=null)}},{key:"remove",value:function(){var e;null===(e=this.parent)||void 0===e||e.removeChild(this)}},{key:"setTransform",value:function(e){}},{key:"processRender",value:function(e){this.stage&&this.computedVisible&&this.doRender(e)}},{key:"requestRender",value:function(){this.stage&&this.stage.requestRender()}},{key:"processDetach",value:function(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}},{key:"updateTransitionProperties",value:function(e,t){var n=0===(0,l.Z)("mapview-transitions-duration")?0:1/(0,l.Z)("mapview-transitions-duration");if(this.fadeTransitionEnabled&&0!==n){var i=this._fadeOutResolver||!this.visible?0:this.opacity,r=this.computedOpacity;if(r===i)this.computedVisible=this.visible;else{var a=e*n;this.computedOpacity=r>i?Math.max(i,r-a):Math.min(i,r+a),this.computedVisible=this.computedOpacity>0;var o=i===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}},{key:"onAttach",value:function(){}},{key:"onDetach",value:function(){}},{key:"doRender",value:function(e){}},{key:"ready",value:function(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}]),n}(s.Z)},39395:function(e,t,n){var i,r;n.d(t,{H:function(){return r},U:function(){return i}}),function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(i||(i={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(r||(r={}))},47566:function(e,t,n){n.d(t,{y:function(){return o}});var i=n(37762),r=n(15671),a=n(43144),o=function(){function e(){(0,r.Z)(this,e),this._candidateTiles=[]}return(0,a.Z)(e,[{key:"schedule",value:function(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}},{key:"reshuffle",value:function(e){var t,n=[],r=(0,i.Z)(this._candidateTiles);try{for(r.s();!(t=r.n()).done;){var a=t.value;e>0?(a.reshuffle(),e--):n.push(a)}}catch(o){r.e(o)}finally{r.f()}this._candidateTiles=n}}]),e}()},12658:function(e,t,n){n.d(t,{L:function(){return l}});var i=n(43144),r=n(15671),a=n(20460),o=(0,i.Z)((function e(t,n,i,a,o,s,l,u){var c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:.5;(0,r.Z)(this,e),this.coverage=t,this.density=n,this.absorption=i,this.cloudSize=a,this.detailSize=o,this.smoothness=s,this.cloudHeight=l,this.raymarchingSteps=u,this.median=c})),s=new o([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],a.p.SIXTEEN),l={sunny:s,cloudy:new o([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],a.p.TWOHUNDRED,.6),rainy:new o([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],a.p.TWOHUNDRED,.4),snowy:new o([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],a.p.HUNDRED,.65),foggy:new o([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],a.p.SIXTEEN),default:s}},20460:function(e,t,n){n.d(t,{p:function(){return i},t:function(){return d}});var i,r=n(43144),a=n(15671),o=n(60136),s=n(29388),l=n(27366),u=n(93169),c=n(46208),h=n(33559);!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(i||(i={}));var d=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).steps=i.SIXTEEN,e.writeTextureChannels=c.uz.RG,e}return(0,r.Z)(n)}(h.m);(0,l._)([(0,h.o)({count:i.COUNT})],d.prototype,"steps",void 0),(0,l._)([(0,h.o)({constValue:(0,u.Z)("esri-mobile")?1024:2048})],d.prototype,"cubeMapSize",void 0),(0,l._)([(0,h.o)()],d.prototype,"writeTextureChannels",void 0)},84819:function(e,t,n){n.d(t,{i:function(){return c},u:function(){return i}});var i,r=n(43144),a=n(15671),o=n(60136),s=n(29388),l=n(27366),u=n(33559);!function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(i||(i={}));var c=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).mode=i.Full,e}return(0,r.Z)(n)}(u.m);(0,l._)([(0,u.o)({count:i.COUNT})],c.prototype,"mode",void 0)},68820:function(e,t,n){n.d(t,{CB:function(){return a},H6:function(){return u},JK:function(){return l},Mw:function(){return r},a5:function(){return o},i9:function(){return i},r7:function(){return s}});var i=(0,n(93169).Z)("esri-mobile")?64:128,r=i/128,a=Math.ceil(Math.sqrt(i)),o=(i+2)*a,s=1e5,l=128,u=o/1560},96916:function(e,t,n){n.d(t,{H:function(){return i},Y:function(){return c}});var i,r=n(43144),a=n(15671),o=n(60136),s=n(29388),l=n(27366),u=n(33559);!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(i||(i={}));var c=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).type=i.Rain,e}return(0,r.Z)(n)}(u.m);(0,l._)([(0,u.o)({count:i.COUNT})],c.prototype,"type",void 0)},69362:function(e,t,n){n.d(t,{f:function(){return h},n:function(){return i}});var i,r=n(43144),a=n(15671),o=n(60136),s=n(29388),l=n(27366),u=n(33559),c=n(8883);!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(i||(i={}));var h=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).geometry=i.Cone,e}return(0,r.Z)(n)}(c.W);(0,l._)([(0,u.o)({count:i.COUNT})],h.prototype,"geometry",void 0)},13086:function(e,t,n){n.d(t,{Z:function(){return _}});var i,r=n(1413),a=n(15671),o=n(43144),s=n(60136),l=n(29388),u=n(27366),c=n(91505),h=n(49861),d=(n(93169),n(32718),n(84936),n(69912)),f=n(18814),v=i=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e){var i;(0,a.Z)(this,n),(i=t.call(this,e)).cameraTrackingEnabled=!0,i.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};var r=(new Date).getFullYear(),o=new Date("March 15, "+r+" 12:00:00 UTC");return i._set("defaultDate",o),i._set("date",o),i}return(0,o.Z)(n,[{key:"defaultDate",get:function(){return new Date(this._get("defaultDate").getTime())},set:function(e){var t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}},{key:"date",set:function(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}},{key:"autoUpdate",value:function(e,t){var n=i.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;var r=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(r=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));var a=i.calculateTimezoneOffset(this.positionTimezoneInfo);if(n!==a&&(p.target=this,p.timezoneOffset=a,this.emit("timezone-will-change",p),p.target=null),null!=e)return isNaN(e.getTime())||r!==e.getTime()}},{key:"clone",value:function(){var e=this._get("date")===this._get("defaultDate"),t=new i((0,r.Z)((0,r.Z)({},this.cloneConstructProperties()),{},{defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled}));return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}},{key:"cloneWithWebsceneLighting",value:function(e){var t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}},{key:"cloneNonPersistentConstructProperties",value:function(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}}],[{key:"fromWebsceneLighting",value:function(e){return new i(e.cloneConstructProperties())}}]),n}(c.Z.EventedMixin(f.Z));(0,u._)([(0,h.Cb)({type:Boolean})],v.prototype,"cameraTrackingEnabled",void 0),(0,u._)([(0,h.Cb)({type:Date})],v.prototype,"defaultDate",null),(0,u._)([(0,h.Cb)({type:Date})],v.prototype,"date",null),function(e){e.calculateTimezoneOffset=function(e){var t=e.hours,n=e.minutes,i=e.seconds;return Math.round(t+n/60+i/3600)}}((v=i=(0,u._)([(0,d.j)("esri.views.3d.environment.SunLighting")],v))||(v={}));var p={target:null,timezoneOffset:0},_=v},12040:function(e,t,n){n.d(t,{Z:function(){return p}});var i,r=n(1413),a=n(15671),o=n(43144),s=n(60136),l=n(29388),u=n(27366),c=n(91505),h=n(49861),d=(n(93169),n(32718),n(84936),n(69912)),f=n(67808),v=i=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e){var i;return(0,a.Z)(this,n),(i=t.call(this,e)).cameraTrackingEnabled=!0,i}return(0,o.Z)(n,[{key:"clone",value:function(){return new i((0,r.Z)((0,r.Z)({},this.cloneConstructProperties()),{},{cameraTrackingEnabled:this.cameraTrackingEnabled}))}},{key:"cloneWithWebsceneLighting",value:function(e){var t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}},{key:"cloneNonPersistentConstructProperties",value:function(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}}],[{key:"fromWebsceneLighting",value:function(e){return new i(e.cloneConstructProperties())}}]),n}(c.Z.EventedMixin(f.Z));(0,u._)([(0,h.Cb)({type:Boolean})],v.prototype,"cameraTrackingEnabled",void 0);var p=v=i=(0,u._)([(0,d.j)("esri.views.3d.environment.VirtualLighting")],v)},5461:function(e,t,n){n.d(t,{TR:function(){return o},Tk:function(){return a},k8:function(){return s},yx:function(){return r}});var i=n(16889);function r(e){var t=1e5;return(0,i.uZ)((e-t)/9e5,0,1)}var a=1e4,o=.085,s=1e5},39261:function(e,t,n){n.d(t,{$L:function(){return c},JF:function(){return l},mq:function(){return h}});var i,r=n(74165),a=n(15861),o=null,s=new Map;function l(e){return u.apply(this,arguments)}function u(){return u=(0,a.Z)((0,r.Z)().mark((function e(t){var a,l;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=null==o,!e.t0){e.next=6;break}return null==i&&(i=n.e(7199).then(n.bind(n,7199))),e.next=5,i;case 5:o=e.sent;case 6:return a=t.view,l=s.get(a),e.abrupt("return",(l||(l=new o.default({view:a}),s.set(a,l)),l.addVoxelLayer(t)));case 9:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}function c(e){return s.get(e)}function h(e){var t=e.view,n=s.get(t);n&&n.removeVoxelLayer(e)<1&&(s.delete(t),0===s.size&&(i=null,o=null))}},31901:function(e,t,n){n.d(t,{S:function(){return oe},C:function(){return ue}});var i=n(74165),r=n(15861),a=n(37762),o=n(60136),s=n(29388),l=n(43144),u=n(15671),c=n(27366),h=n(7138),d=n(14921),f=(n(93169),n(32718)),v=n(77427),p=n(92026),_=n(66978),m=n(94172),g=n(49861),y=(n(84936),n(69912)),b=n(6644),w=n(37818),C=n(16553),x=n(29481),T=n(70446),S=n(67166),k=n(95437),M=n(24168),P=n(19477);function R(e){return e instanceof P.l?e.graphics3DSymbol:e instanceof M.q?e:null}var E=n(3250),O=n(32035),A=n(12400),D=n(41414),Z=n(61310),I=n(5008),L=n(21400),N=function(){return f.Z.getLogger("esri.views.3d.layers.graphics.labelPlacement")},U=(0,l.Z)((function e(t,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,u.Z)(this,e),this.graphics3DGraphic=t,this.labelSymbol=n,this.labelClass=i,this.disablePlacement=r}));function H(e){var t=function(e){var t=e.labelClass.labelPlacement,n=e.labelSymbol,i=e.graphics3DGraphic,r=R(i.graphics3DSymbol),a="point-3d"===(null===r||void 0===r?void 0:r.symbol.type)?r.symbol:null,o=B[t]||z(e);return null!=a&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:a.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!n||!n.hasVisibleVerticalOffset()||null!=a&&a.supportsCallout()&&a.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:o&&function(e){return"above-center"===e}(o.placement)?{placement:"above-center",verticalOffset:n.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(N().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}(e);if(null==t)return null;var n=function(e,t){if(t.anchor)return t;var n=e.labelClass.labelPlacement,i=B[n],r=i||z(e);return n&&!i&&N().warnOncePerTick("the requested label placement '".concat(n,"' is currently unsupported in SceneView.")),function(e,t){var n=t.graphics3DGraphic.graphic.geometry;if(null==n)return null;if(null!=t.disablePlacement)return t.labelClass.labelPlacement?(N().warnOncePerTick(V(null===e||void 0===e?void 0:e.placement,t.disablePlacement.logEntityDescription)),z(t)):e;var i=n.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return N().warnOncePerTick(V(null===e||void 0===e?void 0:e.placement,"'".concat(i,"' geometries"))),z(t);break;case"point":case"mesh":return e}return e}(r,e)}(e,t);if(null==n)return null;var i=n.anchor,r=!!t.hasLabelVerticalOffset,a=t.verticalOffset;return function(e,t,n){var i=n.graphics3DGraphic.graphic.geometry;if(null==i)return null;switch(i.type){case"point":case"mesh":!function(e,t,n){var i=F(n);if(null==i)return;var r=n.graphics3DGraphic.layers[0];switch(null!=r?r.getCenterObjectSpace(e.translation):(0,O.s)(e.translation,0,0,0),i.type){case"icon":case"text":!function(e,t,n,i){var r=n.graphics3DGraphic,a=null!=i?i.getScreenSize():null;if(r.isDraped||null==a)e.hasLabelVerticalOffset||"center"===e.anchor||(B[n.labelClass.labelPlacement]&&N().warnOncePerTick("the requested placement '".concat(t.placement,"' is currently unsupported for draped graphics")),e.anchor="center");else{var o=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:X,i=e.graphics3DGraphic.layers[0],r=null!==(t=null===i||void 0===i?void 0:i.stageObject.geometries[0].material)&&void 0!==t?t:null;if(r&&r instanceof L.A){var a=r.parameters.anchorPosition;n[0]=2*(a[0]-.5),n[1]=2*(a[1]-.5)}else n[0]=0,n[1]=0;return n}(n);e.screenOffset[0]=a[0]/2*(t.normalizedOffset[0]-o[0]);var s=a[1]/2*(t.normalizedOffset[1]-o[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=s,e.centerOffsetUnits="screen"):e.screenOffset[1]=s}}(e,t,n,r);break;case"object":case"fill":q(e,t,r)}}(e,t,n);break;case"polygon":!function(e,t,n){var i=F(n);if(null!=i&&"extrude"===i.type){var r=n.graphics3DGraphic.layers[0];null!=r?(r.getBoundingBoxObjectSpace(Q),(0,D.be)(Q,e.translation),e.translation[2]=(0,D.Cb)(Q)/2):(0,O.s)(e.translation,0,0,0),q(e,t,r)}}(e,t,n)}var r=Z.aT-I.Wg;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}(new E.a(a,i,r),n,e)}function F(e){var t=R(e.graphics3DGraphic.graphics3DSymbol);return null!=t?t.symbol.symbolLayers.at(0):null}function V(e,t){return"the requested label placement '".concat(e,"' is currently unsupported for ").concat(t," in SceneView.")}function z(e){var t=e.graphics3DGraphic.graphic.geometry;if(null==t)return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:A.AG,anchor:"center"};case"polygon":var n=F(e);return null!=n&&"extrude"===n.type?B["above-center"]:{placement:"center-center",normalizedOffset:A.AG,anchor:"center"};case"point":case"mesh":return B["above-center"];default:return}}function q(e,t,n){var i=null!=n?n.getBoundingBoxObjectSpace(Q):Q,r=(0,A.al)(i[3]-i[0],i[4]-i[1],i[5]-i[2]),a=Math.sqrt(r[0]*r[0]+r[1]*r[1]);e.centerOffset[0]=a/2*t.normalizedOffset[0];var o=e.translation[2],s=r[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+s;var l=(0,O.l)(r);e.centerOffset[2]=l/2*t.normalizedOffset[2]}var B={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},G={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]},j=function(e){var t=G[e],n=B[e];t.forEach((function(e){B[e]=n}))};for(var W in G)j(W);Object.freeze&&(Object.freeze(B),Object.keys(B).forEach((function(e){var t;Object.freeze(B[e]),Object.freeze(null===(t=B[e])||void 0===t?void 0:t.normalizedOffset)})));var X=[0,0],Q=(0,D.Ue)(),Y=n(31908),J=function(){function e(t){(0,u.Z)(this,e),this._stage=t,this._materials=new Map}return(0,l.Z)(e,[{key:"get",value:function(e){return this._materials.get(e)}},{key:"add",value:function(e,t){this._materials.set(e,t),this._stage.add(t)}},{key:"dispose",value:function(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}]),e}(),K=n(43164),$=n(29473),ee=n(97882),te=n(93463),ne=n(73553),ie=(0,l.Z)((function e(t,n){(0,u.Z)(this,e),this.labelingContext=t,this.graphics3DGraphic=n,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array})),re=(0,l.Z)((function e(t,n,i,r,a){(0,u.Z)(this,e),this.labelClass=t,this.graphics3DSymbol=n,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=a,this.calloutSymbolLayerIndex=0})),ae=function(){function e(t,n,i,r,a,o,s,l){(0,u.Z)(this,e),this.layer=n,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=a,this.elevationInfoOverride=o,this.disablePlacement=s,this.active=l,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new ee.F(t,{pickable:!0,disableOctree:!0},n.uid)}return(0,l.Z)(e,[{key:"destroy",value:function(){this.stageLayer.destroy()}}]),e}(),oe=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){var i;return(0,u.Z)(this,n),(i=t.call(this,e))._dirty=!1,i._labels=new Map,i._labelingContexts=new Array,i}return(0,l.Z)(n,[{key:"setup",value:function(){var e=this;this.dispose(),this.addHandles([(0,m.watch)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(){return e.setDirty()})),(0,m.watch)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.rasterPixelRatio}),(function(){return e._resetAllLabels()})),this.view.resourceController.scheduler.registerTask(te.T8.LABELER,this)]),this._textTextureAtlas=new $.U({view:this.view}),this._hudMaterialCollection=new J(this.view._stage),this._calloutMaterialCollection=new J(this.view._stage)}},{key:"dispose",value:function(){this.removeAllHandles(),this._textTextureAtlas=(0,p.M2)(this._textTextureAtlas),this._hudMaterialCollection=(0,p.M2)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,p.M2)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}},{key:"destroy",value:function(){this.dispose(),ce.graphic=null,ce.renderingInfo=null,ce.layer=null}},{key:"_activateLabelingContext",value:function(e){var t=this;e.graphics.forEach((function(n,i){var r=new ie(e,n);t._labels.set(i,r),e.labelsToInitialize.set(i,r),n.setVisibilityFlag(T.E.LABEL,T.P.USER,!0)})),e.active=!0}},{key:"_deactivateLabelingContext",value:function(e){var t=this;e.graphics.forEach((function(e,n){e.setVisibilityFlag(T.E.LABEL,T.P.USER,!1),t.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),t._labels.delete(n)})),e.active=!1}},{key:"_addLabelTextureToAtlas",value:function(e){var t,n=(0,a.Z)(e.graphics3DGraphic.labelLayers);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i._labelClass){var r=e.textRenderers[i._labelIndex];r&&(this._textTextureAtlas.addTextTexture(r,i.stageObject),e.addedToTextureAtlas=!0)}}}catch(o){n.e(o)}finally{n.f()}}},{key:"_removeLabelTextureFromAtlas",value:function(e){var t,n=(0,a.Z)(e.graphics3DGraphic.labelLayers);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i._labelClass){var r=e.textRenderers[i._labelIndex];null!=r&&(this._textTextureAtlas.removeTextTexture(r,i.stageObject),e.addedToTextureAtlas=!1)}}}catch(o){n.e(o)}finally{n.f()}}},{key:"running",get:function(){return this.view.ready&&(this._dirty||this.deconflictor.running)}},{key:"runTask",value:function(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),ne.J}},{key:"_updateLabels",value:function(e){var t=this;if(this._dirty){this._dirty=!1;var n,i=(0,a.Z)(this._labelingContexts);try{var r=function(){var i=n.value;if(i.active)if(se(i))t._dirty=!0;else if(le(i.labelClassContexts)){if(null===i.labelClassContexts)return t._deactivateLabelingContext(i),"continue";t._createLabelClassContext(i),t._dirty=!0}else(0,v.oE)(i.labelsToInitialize,(function(n,r){return t._ensureGraphics3DResources(n)&&(t._labels.set(r,n),t.deconflictor.setDirty(),e.madeProgress()),(n.visible&&n.textInitialized||!n.visible&&n.hasGraphics3DResources)&&(i.labelsToInitialize.delete(r),e.madeProgress()),e.done}))&&(t._dirty=!0)};for(i.s();!(n=i.n()).done;)r()}catch(o){i.e(o)}finally{i.f()}this._dirty||this.notifyChange("updating")}}},{key:"_createLabelClassContextAsync",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t){var n,a,o,s,l,u,c,h=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=null===(n=t.labelClassAbortController)||void 0===n?void 0:n.signal,e.t0=t.layer.when,!e.t0){e.next=5;break}return e.next=5,t.layer.when();case 5:if((0,_.k_)(s),null===(a=t.scaleVisibility)||void 0===a||a.updateScaleRangeActive(),l=t.graphics3DCore,u=l.layer,c=null===(o=u.labelingInfo)||void 0===o?void 0:o.filter((function(e){return!!e.symbol})),c&&0!==c.length){e.next=10;break}return e.abrupt("return");case 10:return!1,e.next=13,(0,d.Ed)(c,function(){var e=(0,r.Z)((0,i.Z)().mark((function e(n,r){var a,o,u,c,v;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.symbol,null!=(o=R(l.getOrCreateGraphics3DSymbol(a)))){e.next=3;break}return e.abrupt("return",void f.Z.getLogger(h).error("Failed to create Graphics3DSymbol for label"));case 3:return e.next=5,o.load();case 5:if((0,_.k_)(s),u=null,e.t0=(0,x.Pd)(a)&&a.hasVisibleCallout(),!e.t0){e.next=13;break}return u=(0,S.S)(a,l.symbolCreationContext),e.next=12,u.load();case 12:(0,_.k_)(s);case 13:return e.next=15,(0,d.q6)((0,C.J)(n,t.layer.fieldsIndex,h.view.spatialReference));case 15:if(c=e.sent,(0,_.k_)(s),!0!==c.ok){e.next=23;break}return e.next=19,h._createTextRenderParameters(o.symbol);case 19:v=e.sent,(0,_.k_)(s),t.labelClassContexts[r]=new re(n,o,u,v,c.value),e.next=24;break;case 23:f.Z.getLogger(h).error("Label expression failed to evaluate: ".concat(c.error)),!0;case 24:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}());case 13:(0,_.k_)(s);case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createLabelClassContext",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t){var n=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(null==t.labelClassPromise&&(t.labelClassPromise=this._createLabelClassContextAsync(t).catch((function(e){if((0,_.D_)(e))throw e;t.labelClassContexts.length=0})).then((function(){t.labelClassAbortController=null,n.notifyChange("updating")})).catch((function(){})),this.notifyChange("updating")),t.labelClassPromise));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createTextRenderParameters",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.symbolLayers.at(0),e.abrupt("return","text"!==(null===n||void 0===n?void 0:n.type)?null:K.V.fromSymbol(n,this.view.state.rasterPixelRatio));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_destroyLabelClassContext",value:function(e){var t,n=(0,a.Z)(e.labelClassContexts);try{for(n.s();!(t=n.n()).done;){--t.value.graphics3DSymbol.referenced}}catch(r){n.e(r)}finally{n.f()}var i=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,p.IM)(i),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}},{key:"_createTextSymbolGraphic",value:function(e,t,n,i,r,a){var o=new E.U(n,(0,Y.zi)(n.anchor),(0,Y.EP)(n.anchor),e.text,(0,b.al)(e.displayWidth,e.displayHeight));return ce.graphic=t,ce.renderingInfo=null,ce.layer=i,r.createLabel(ce,o,this._hudMaterialCollection,this._textTextureAtlas,(function(){var e=H(a);return e?e.elevationOffset:null}))}},{key:"_createLineCalloutGraphic",value:function(e,t,n,i,r){ce.graphic=e,ce.layer=r;var a=i.screenOffset[0];return ce.renderingInfo=new k.Ly(null,t,i.translation,i.centerOffset,a,i.centerOffsetUnits,i.elevationOffset,this._calloutMaterialCollection),n.createGraphics3DGraphic(ce)}},{key:"_ensureGraphics3DResources",value:function(e){var t;if(e.hasGraphics3DResources)return!1;var n=e.graphics3DGraphic;if(n.destroyed)return!1;this._ensureTextTextureResources(e);var i=e.labelingContext,r=i.labelClassContexts;if(le(r)||!i.emptySymbolLabelSupported&&0===n.layers.length)return!1;for(var a=!1,o=n.graphic,s=i.layer,l=ue(i.layer),u=0;u<r.length;u++){var c,h,d=e.textRenderers[u],f=e.textLabelPlacements[u];if(null!=d&&null!=f){var v=r[u],p=v.graphics3DSymbol,_=p.symbol&&"label-3d"===p.symbol.type?p.symbol:null,m=p.symbolLayers[0];if(m){m.setElevationInfoOverride(i.elevationInfoOverride);var g=new U(n,_,v.labelClass),y=this._createTextSymbolGraphic(d,o,f,s,m,g);if(null==y)return!1;y._labelClass=v.labelClass,y._labelIndex=u,n.addLabelGraphic(y,i.stageLayer),n.deconflictionPriority=null!==(c=null===(h=v.textRenderParameters)||void 0===h?void 0:h.definition.size)&&void 0!==c?c:0,n.setVisibilityFlag(T.E.LABEL,T.P.USER,l),n.setVisibilityFlag(T.E.LABEL,T.P.SCALE_RANGE,!0),n.setVisibilityFlag(T.E.LABEL,T.P.DECONFLICTION,!1),a=!0;var b=v.graphics3DCalloutSymbolLayer;if(b&&f.hasLabelVerticalOffset){b.setElevationInfoOverride(i.elevationInfoOverride);var w=this._createLineCalloutGraphic(o,_,b,f,s);null!=w&&(v.calloutSymbolLayerIndex=n.labelLayers.length,n.addLabelGraphic(w,i.stageLayer))}break}}}return a&&null!==(t=i.scaleVisibility)&&void 0!==t&&t.updateGraphicLabelScaleVisibility(n),e.hasGraphics3DResources=!0,!0}},{key:"_destroyGraphics3DResources",value:function(e){var t,n=e.labelingContext.labelClassContexts,i=(0,a.Z)(e.graphics3DGraphic.labelLayers);try{for(i.s();!(t=i.n()).done;){var r=t.value;if(null!=r._labelClass){var o=n[r._labelIndex].graphics3DSymbol.symbolLayers[0];null===o||void 0===o||o.onRemoveGraphic(r)}}}catch(s){i.e(s)}finally{i.f()}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}},{key:"_ensureTextTextureResources",value:function(e){if(!e.textInitialized){var t=e.labelingContext,n=t.labelClassContexts;if(!le(n)){for(var i=e.graphics3DGraphic.graphic,r=0;r<n.length;r++){var a,o=n[r];if(e.textRenderers[r]=null,e.textLabelPlacements[r]=null,null!=(null===o||void 0===o?void 0:o.textRenderParameters)){var s=o.labelFunction,l=void 0;if("arcade"===s.type)try{var u=s.needsHydrationToEvaluate()?(0,w.mW)(i,t.layer):i;l=s.evaluate(u)}catch(p){l=null}else l=s.evaluate(i);if(null!=l&&""!==l&&!/^\s+$/.test(l)){var c=o.graphics3DSymbol,h="label-3d"===(null===(a=c.symbol)||void 0===a?void 0:a.type)?c.symbol:null;if(c.symbolLayers[0]){var d=H({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:h,labelClass:o.labelClass,disablePlacement:t.disablePlacement});if(null!=d){var f=(0,Y.zi)(d.anchor),v=(0,Y.mq)(f);e.textRenderers[r]=new I.tV(l,v,o.textRenderParameters,$.U.maxSize),e.textLabelPlacements[r]=d}}}}}e.textInitialized=!0}}}},{key:"_destroyTextTextureResources",value:function(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}},{key:"_addGraphic",value:function(e,t){var n=t.graphic.uid;if(e.graphics.set(n,t),e.active){var i=new ie(e,t);this._labels.set(n,i),e.labelsToInitialize.set(n,i)}this.setDirty(),this.deconflictor.setDirty()}},{key:"_updateGraphicGeometry",value:function(e,t){var n=t.graphic.uid,i=this._labels.get(n);if(!i)return!0;var r,o=(0,a.Z)(i.graphics3DGraphic.labelLayers);try{for(o.s();!(r=o.n()).done;){var s=r.value;if(null!=s._labelClass&&!e.labelClassContexts[s._labelIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(s,t.graphic.geometry))return!1}}catch(l){o.e(l)}finally{o.f()}return this.setDirty(),this.deconflictor.setDirty(),!0}},{key:"_removeGraphic",value:function(e,t){var n=t.graphic.uid,i=this._labels.get(n);e.graphics.delete(n),i&&(this._destroyGraphic(i,n),e.labelsToInitialize.delete(n),this.setDirty(),this.deconflictor.setDirty())}},{key:"_destroyGraphic",value:function(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}},{key:"_labelingInfoChange",value:function(){var e=(0,r.Z)((0,i.Z)().mark((function e(t,n){var r,o,s,l;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}return e.abrupt("return",(this._visibilityInfoChange(t),this._resetLabels(t),this._createLabelClassContext(t)));case 2:r=(0,a.Z)(n);try{for(r.s();!(o=r.n()).done;)s=o.value,(l=t.graphics.get(s))&&(this._removeGraphic(t,l),this._addGraphic(t,l))}catch(i){r.e(i)}finally{r.f()}case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_globalPropertyChanged",value:function(e,t){var n,i=(0,a.Z)(t.labelClassContexts);try{var r=function(){var i=n.value,r=new Map;t.graphics.forEach((function(e){return r.set(e.graphic.uid,e)}));if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,(function(e){return e.labelLayers[0]})),i.graphics3DCalloutSymbolLayer){i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,(function(e){return e.labelLayers[i.calloutSymbolLayerIndex]}))}};for(i.s();!(n=i.n()).done;)r()}catch(o){i.e(o)}finally{i.f()}}},{key:"_visibilityInfoChange",value:function(e){var t=ue(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}},{key:"_resetAllLabels",value:function(){var e,t=(0,a.Z)(this._labelingContexts);try{for(t.s();!(e=t.n()).done;){var n=e.value;this._resetLabels(n)}}catch(i){t.e(i)}finally{t.f()}}},{key:"_resetLabels",value:function(e){var t=this;e.graphics.forEach((function(n,i){var r=t._labels.get(i);r&&(t._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}},{key:"_findLabelingContext",value:function(e){var t,n=(0,a.Z)(this._labelingContexts);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i.graphics3DCore===e)return i}}catch(r){n.e(r)}finally{n.f()}return null}},{key:"addGraphicsOwner",value:function(e,t,n){var i=this,r=(null===n||void 0===n?void 0:n.emptySymbolLabelSupported)||!1,a=(null===n||void 0===n?void 0:n.elevationInfoOverride)||null,o=(null===n||void 0===n?void 0:n.disablePlacement)||null;if(!this._findLabelingContext(e)){var s=e.layer,l=new ae(this.view._stage,s,e,t,r,a,o,ue(s));return this._labelingContexts.push(l),this.setDirty(),{addGraphic:function(e){return i._addGraphic(l,e)},removeGraphic:function(e){return i._removeGraphic(l,e)},updateGraphicGeometry:function(e){return i._updateGraphicGeometry(l,e)},layerLabelsEnabled:function(){return ue(l.layer)},labelingInfoChange:function(e){return i._labelingInfoChange(l,e)},elevationInfoChange:function(){return i._globalPropertyChanged("elevationInfo",l)},slicePlaneEnabledChange:function(){return i._globalPropertyChanged("slicePlaneEnabled",l)},visibilityInfoChange:function(){return i._visibilityInfoChange(l)},reset:function(){return i._resetLabels(l)},remove:function(){return i._removeGraphicsOwner(e)},setDirty:function(){return i.setDirty()}}}}},{key:"_removeGraphicsOwner",value:function(e){var t=this,n=this._findLabelingContext(e);if(n){var i=this._labelingContexts.indexOf(n);this._labelingContexts.splice(i,1),n.graphics.forEach((function(e){return t._removeGraphic(n,e)})),n.destroy(),this.setDirty()}}},{key:"setLabelGraphicVisibility",value:function(e,t){var n=e.graphic.uid,i=this._labels.get(n);i&&i.visible!==t&&(t&&!i.addedToTextureAtlas?(this._addLabelTextureToAtlas(i),i.textInitialized||i.labelingContext.labelsToInitialize.set(n,i)):!t&&i.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(i),i.visible=t,this.setDirty())}},{key:"setDirty",value:function(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}},{key:"updating",get:function(){var e;return this._dirty||(null===(e=this._textTextureAtlas)||void 0===e?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((function(e){return se(e)}))}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;var e=this._labelingContexts.length>0?this._labelingContexts.reduce((function(e,t){return e+(se(t)?0:1)}),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){}}]),n}(h.default);function se(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function le(e){return!e||0===e.length}function ue(e){var t;return!0===e.labelsVisible&&!(null===(t=e.labelingInfo)||void 0===t||!t.some((function(e){return!!e.symbol})))}(0,c._)([(0,g.Cb)({constructOnly:!0})],oe.prototype,"view",void 0),(0,c._)([(0,g.Cb)({constructOnly:!0})],oe.prototype,"deconflictor",void 0),(0,c._)([(0,g.Cb)()],oe.prototype,"_textTextureAtlas",void 0),(0,c._)([(0,g.Cb)({type:Boolean,readOnly:!0})],oe.prototype,"updating",null),oe=(0,c._)([(0,y.j)("esri.views.3d.layers.graphics.Labeler")],oe);var ce=new k._D(null,null,null)},85312:function(e,t,n){n.d(t,{A8:function(){return _},AK:function(){return c},BF:function(){return m},DI:function(){return f},GS:function(){return p},a8:function(){return h},f9:function(){return d},lt:function(){return v}});var i=n(43144),r=n(15671),a=n(60136),o=n(29388),s=n(54463),l=n(55848),u=n(22178),c=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,i,a,o){var s;return(0,r.Z)(this,n),(s=t.call(this,i,a)).point=e,s.createGraphic=o,s}return(0,i.Z)(n)}(l.Dx);function h(e){return(0,u.nn)(e)&&e.intersector===s.q7.PCL&&!!e.target}var d=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,i,a,o,s){var l;return(0,r.Z)(this,n),(l=t.call(this,e)).layerUid=e,l.sublayerUid=i,l.nodeIndex=a,l.componentIndex=o,l.triangleNr=s,l}return(0,i.Z)(n)}(l.Zh),f=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,i,a){var o;return(0,r.Z)(this,n),(o=t.call(this,i,null)).point=e,o.createVoxelGraphic=a,o}return(0,i.Z)(n)}(l.Dx),v=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,i){var a;return(0,r.Z)(this,n),(a=t.call(this,e,null)).createTiles3DGraphic=i,a}return(0,i.Z)(n)}(l.Dx);function p(e){return(0,u.nn)(e)&&e.intersector===s.q7.I3S&&!!e.target}function _(e){return(0,u.nn)(e)&&e.intersector===s.q7.VOXEL&&!!e.target}function m(e){return(0,u.nn)(e)&&e.intersector===s.q7.TILES3D&&!!e.target}},13470:function(e,t,n){n.d(t,{C:function(){return l},E:function(){return i}});var i,r,a=n(15671),o=n(43144),s=n(65156),l=function(){function e(t,n,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,a.Z)(this,e),this.lij=[0,0,0],this.extent=(0,s.Ue)(),this.resolution=0,this.loadPriority=0,this.measures={visibility:i.VISIBLE_ON_SURFACE,screenRect:(0,s.Ue)(),distance:0,shouldSplit:!1},this.used=!1,o&&this.acquire(t,n,r,o)}return(0,o.Z)(e,[{key:"acquire",value:function(t,n,i,r){this.tilingScheme=r,this.id=e.id(t,n,i),this.lij[0]=t,this.lij[1]=n,this.lij[2]=i,r.getExtent(t,n,i,this.extent),this.resolution=r.resolutionAtLevel(t)}},{key:"release",value:function(){this.tilingScheme=null}},{key:"getChildren",value:function(t){var n=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return t?(t[0].acquire(n,i,r,this.tilingScheme),t[1].acquire(n,i+1,r,this.tilingScheme),t[2].acquire(n,i,r+1,this.tilingScheme),t[3].acquire(n,i+1,r+1,this.tilingScheme),t):[new e(n,i,r,this.tilingScheme),new e(n,i+1,r,this.tilingScheme),new e(n,i,r+1,this.tilingScheme),new e(n,i+1,r+1,this.tilingScheme)]}},{key:"copyMeasurementsFrom",value:function(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,(0,s.JG)(e.measures.screenRect,this.measures.screenRect)}}],[{key:"id",value:function(e,t,n){return"".concat(e,"/").concat(t,"/").concat(n)}}]),e}();(r=i||(i={}))[r.INVISIBLE=0]="INVISIBLE",r[r.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",r[r.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"},38161:function(e,t,n){n.d(t,{i:function(){return l}});var i=n(15671),r=n(43144),a=n(32035),o=n(12400),s=n(95773),l=function(){function e(t){(0,i.Z)(this,e),this.renderCoordsHelper=t,this.frustum=(0,s.Ue)(),this._points=(0,s.Hf)(),this.lines=new Array(12),this._origin=(0,o.Ue)(),this._direction=(0,o.Ue)(),this._altitude=null;for(var n=0;n<12;n++)this.lines[n]={origin:null,direction:(0,o.Ue)(),endpoint:null}}return(0,r.Z)(e,[{key:"planes",get:function(){return this.frustum}},{key:"points",get:function(){return this._points}},{key:"mutablePoints",get:function(){return this._points}},{key:"direction",get:function(){return this._direction}},{key:"origin",get:function(){return this._origin}},{key:"update",value:function(e){(0,s.q_)(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),(0,a.c)(this._origin,e.eye),(0,a.c)(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}},{key:"updatePoints",value:function(e){for(var t=0;t<this._points.length;t++)(0,a.c)(this._points[t],e[t]);(0,s.Jp)(this.frustum,this._points),this._updateLines()}},{key:"altitude",get:function(){return this._altitude}},{key:"intersectsSphere",value:function(e){return(0,s.hr)(this.frustum,e)}},{key:"intersectsRay",value:function(e){return(0,s.Zr)(this.frustum,e)}},{key:"intersectsLineSegment",value:function(e,t){return(0,s.rN)(this.frustum,e,t)}},{key:"intersectsPoint",value:function(e){return(0,s.g8)(this.frustum,e)}},{key:"_updateLines",value:function(){for(var e=this._points,t=0;t<4;t++){var n=t+4;u(this.lines[t],e[t],e[n]),u(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),u(this.lines[t+8],e[n],3===t?e[4]:e[n+1])}}}]),e}();function u(e,t,n){e.origin=t,e.endpoint=n,(0,a.E)(e.direction,t,n)}l.planePointIndices=s.xu,l.nearFarLineIndices=[[s.NQ.NEAR_BOTTOM_LEFT,s.NQ.FAR_BOTTOM_LEFT],[s.NQ.NEAR_BOTTOM_RIGHT,s.NQ.FAR_BOTTOM_RIGHT],[s.NQ.NEAR_TOP_RIGHT,s.NQ.FAR_TOP_RIGHT],[s.NQ.NEAR_TOP_LEFT,s.NQ.FAR_TOP_LEFT]]},2985:function(e,t,n){n.d(t,{r:function(){return a}});var i=n(15671),r=n(43144),a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1/0;(0,i.Z)(this,e),this.elevationRangeMin=t,this.elevationRangeMax=n}return(0,r.Z)(e,[{key:"elevationRangeValid",get:function(){return!Number.isNaN(this.elevationRangeMin)}},{key:"invalidateElevationRange",value:function(){this.elevationRangeMin=NaN}},{key:"expandElevationRangeValues",value:function(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}},{key:"expandElevationRange",value:function(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}},{key:"setElevationRange",value:function(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}]),e}()},31195:function(e,t,n){n.d(t,{d:function(){return p},c:function(){return v}});var i=n(15671),r=n(43144),a=n(60136),o=n(29388),s=n(27366),l=n(7138),u=(n(93169),n(32718)),c=n(18759),h=n(99346),d=n(49861),f=(n(84936),n(69912));function v(e){return new _({view:e})}var p=.1,_=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e))._quality=1,r._usedMemory=0,r._updating=!1,r._stableQuality=0,r._downscaleMemoryUsed=0,r._canFastRecover=!1,r._memoryPredicted=0,r._cacheStorage=new c.WJ,r._warnMemoryUsage=null,r._numQualityChanges=0,r._maxMemory=750,r._additionalCacheMemory=0,r.addHandles((0,h.A)({prepare:function(){return r._updateMemory()}})),r}return(0,r.Z)(n,[{key:"destroy",value:function(){this._cacheStorage.destroy()}},{key:"maxMemory",get:function(){return this._maxMemory},set:function(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}},{key:"additionalCacheMemory",get:function(){return this._additionalCacheMemory},set:function(e){null!=e&&(this._additionalCacheMemory=e)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._usedMemory}},{key:"usedCacheMemory",get:function(){return this._cacheStorage.size}},{key:"newCache",value:function(e,t){return new c.Xq(e,this._cacheStorage,t)}},{key:"resetStableQuality",value:function(){this._stableQuality=0}},{key:"disableMemCache",value:function(){this.additionalCacheMemory=-4096}},{key:"update",value:function(){if(!(this._memoryPredicted<=0)||this._updating){var e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>p&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;e=this._updateQuality(this._quality+.05)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}}},{key:"_updateQuality",value:function(e){return(e=Math.min(Math.max(e,p),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}},{key:"_layersUpdating",value:function(){return this.view.allLayerViews.some((function(e){return!!e.updating}))}},{key:"_updateMemory",value:function(){var e,t,n,i,r,a,o=this;if(this.view){null===(e=this.view._stage)||void 0===e||null===(t=e.renderer)||void 0===t||t.tick();var s=null===(n=this.view._stage)||void 0===n||null===(i=n.renderer)||void 0===i?void 0:i.usedMemory,l=(null!==(r=null===(a=this.view.basemapTerrain)||void 0===a?void 0:a.usedMemory)&&void 0!==r?r:0)+(s?s.fbos+s.edges+s.plugins:0),c=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((function(e){if(function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}(e)){var t=e.ignoresMemoryFactor?o._quality:1;l+=e.usedMemory*t,c+=e.unloadedMemory*t}}));var h=null==this._warnMemoryUsage||Math.round(10*l)!==Math.round(10*this._warnMemoryUsage),d=1048576*this.maxMemory;if(l>d&&h){this._warnMemoryUsage=l;var f=function(e){return(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB"},v=Math.round(100*this._quality);u.Z.getLogger(this).warn("Memory Limit exceeded! Limit: ".concat(f(d)," Current: ").concat(f(l)," Projected: ").concat(f(l+c)," Quality: ").concat(v,"%"))}this._usedMemory=l/d,this._memoryPredicted=(l+c)/d;var p=d-l;this._cacheStorage.maxSize=Math.max(0,p+1048576*this.additionalCacheMemory)}}},{key:"test",get:function(){}}]),n}(l.default);(0,s._)([(0,d.Cb)({constructOnly:!0})],_.prototype,"view",void 0),(0,s._)([(0,d.Cb)()],_.prototype,"maxMemory",null),(0,s._)([(0,d.Cb)()],_.prototype,"additionalCacheMemory",null),(0,s._)([(0,d.Cb)({readOnly:!0})],_.prototype,"memoryFactor",null),(0,s._)([(0,d.Cb)({readOnly:!0})],_.prototype,"updating",null),(0,s._)([(0,d.Cb)({readOnly:!0})],_.prototype,"usedMemory",null),(0,s._)([(0,d.Cb)({readOnly:!0})],_.prototype,"usedCacheMemory",null),(0,s._)([(0,d.Cb)()],_.prototype,"_quality",void 0),(0,s._)([(0,d.Cb)()],_.prototype,"_usedMemory",void 0),(0,s._)([(0,d.Cb)()],_.prototype,"_updating",void 0),(0,s._)([(0,d.Cb)()],_.prototype,"_stableQuality",void 0),(0,s._)([(0,d.Cb)()],_.prototype,"_maxMemory",void 0),(0,s._)([(0,d.Cb)()],_.prototype,"_additionalCacheMemory",void 0),_=(0,s._)([(0,f.j)("esri.views.3d.support.MemoryController")],_)},91643:function(e,t,n){n.d(t,{Z:function(){return w}});var i=n(15671),r=n(43144),a=n(16889),o=n(68860),s=n(29134),l=n(32035),u=n(83448),c=n(29691),h=n(68859),d=n(5629),f=n(5986),v=n(14320),p=n(85305),_=n(55652),m=n(40927),g=n(51378),y=n(81020),b=n(50951),w=function(){function e(t,n,r,a){(0,i.Z)(this,e),this.viewingMode=t,this.spatialReference=n,this.unitInMeters=r,this._coordinateSystem=a,this._tmpCoordinateSystem=(0,p.Ue)(a),this.referenceEllipsoid=(0,u.Iu)(n),this.sphericalPCPF=(0,c.rS)(n)}return(0,r.Z)(e,[{key:"extent",set:function(e){e&&(0,p.qf)(this._coordinateSystem,e,this._coordinateSystem)}},{key:"getAltitude",value:function(e){return(0,p.id)(this._coordinateSystem,e)}},{key:"setAltitude",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return(0,p.Is)(this._coordinateSystem,n,t,e)}},{key:"setAltitudeOfTransformation",value:function(e,t){(0,p.rF)(this._coordinateSystem,t,e,t)}},{key:"worldUpAtPosition",value:function(e,t){return(0,p.P0)(this._coordinateSystem,e,t)}},{key:"worldBasisAtPosition",value:function(e,t,n){return(0,p.Kf)(this._coordinateSystem,e,t,n)}},{key:"basisMatrixAtPosition",value:function(e,t){var n=this.worldBasisAtPosition(e,v.R.X,g.WM.get()),i=this.worldBasisAtPosition(e,v.R.Y,g.WM.get()),r=this.worldBasisAtPosition(e,v.R.Z,g.WM.get());return(0,s.t8)(t,n[0],n[1],n[2],0,i[0],i[1],i[2],0,r[0],r[1],r[2],0,0,0,0,1),t}},{key:"headingAtPosition",value:function(e,t){var n=this.worldUpAtPosition(e,g.WM.get()),i=this.worldBasisAtPosition(e,v.R.Y,g.WM.get()),r=(0,m.cp)(t,i,n);return(0,a.BV)(r)}},{key:"intersectManifoldClosestSilhouette",value:function(e,t,n){return(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem),(0,p.ej)(this._tmpCoordinateSystem,e,n),n}},{key:"intersectManifold",value:function(e,t,n){(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);var i=g.WM.get();return(0,p.BR)(this._tmpCoordinateSystem,e,i)?(0,l.c)(n,i):null}},{key:"intersectInfiniteManifold",value:function(e,t,n){if(this.viewingMode===b.JY.Global)return this.intersectManifold(e,t,n);(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);var i=this._tmpCoordinateSystem.value,r=g.WM.get();return(0,_.BR)(i.plane,e,r)?(0,l.c)(n,r):null}},{key:"toRenderCoords",value:function(e,t,n){return(0,y.f)(e)?(0,h.K)(e,t,this.spatialReference):(0,f.S)(e,t,n,this.spatialReference)}},{key:"fromRenderCoords",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,y.f)(t)?(null!=n&&(t.spatialReference=n),(0,d.f)(e,this.spatialReference,t)?t:null):(0,f.S)(e,this.spatialReference,t,n)?t:null}}],[{key:"create",value:function(t,n){switch(t){case b.JY.Local:return new e(b.JY.Local,n,(0,o.c9)(n),(0,p.pb)());case b.JY.Global:return new e(b.JY.Global,n,1,(0,p.pt)(n))}}},{key:"renderUnitScaleFactor",value:function(e,t){return(0,o.r6)(e)/(0,o.r6)(t)}}]),e}()},81703:function(e,t,n){n.d(t,{Bh:function(){return c},eW:function(){return d},iE:function(){return h},j$:function(){return l},u4:function(){return u}});var i=n(17842),r=n(13611),a=n(32035),o=n(40885),s=n(51378);function l(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,o.Ue)();return u(e,(0,i.md)(t),n),(0,a.n)(n.direction,n.direction),n}function u(e,t,n){return c(e,e.screenToRender(t,(0,i.Wv)(s.WM.get())),n)}function c(e,t,n){var o=(0,i.Wv)((0,r.JG)(s.WM.get(),t));if(o[2]=0,!e.unprojectFromRenderScreen(o,n.origin))return null;var l=(0,i.Wv)((0,r.JG)(s.WM.get(),t));l[2]=1;var u=e.unprojectFromRenderScreen(l,s.WM.get());return null==u?null:((0,a.f)(n.direction,u,n.origin),n)}function h(e,t,n){return d(e,e.screenToRender(t,(0,i.Wv)(s.WM.get())),n)}function d(e,t,n){(0,a.c)(n.origin,e.eye);var i=(0,a.s)(s.WM.get(),t[0],t[1],1),r=e.unprojectFromRenderScreen(i,s.WM.get());return null==r?null:((0,a.f)(n.direction,r,n.origin),n)}},9985:function(e,t,n){n.d(t,{K0:function(){return O},qL:function(){return S},us:function(){return A},wX:function(){return x}});var i=n(74165),r=n(1413),a=n(37762),o=n(15861),s=(n(59486),n(52639)),l=n(83704),u=n(17842),c=n(12400),h=n(5986),d=n(28970),f=n(37933),v=n(94463),p=n(77648),_=n(88153),m=n(54463),g=n(22178),y=n(41781),b=n(76783),w=n(78952),C=n(848);function x(e,t,n,i){return T.apply(this,arguments)}function T(){return(T=(0,o.Z)((0,i.Z)().mark((function e(t,n,r,a){var o,s,l,c,h,d,p,b;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r?A(t,r):a,s=(0,u.s1)(n.x,n.y),o.requiresGroundFeedback=!0,o.enableDraped=!0,(l=(0,_.Z8)(t.state.viewingMode)).options.selectionMode=!0,l.options.store=m.eC.ALL,t.sceneIntersectionHelper.intersectIntersectorScreen(s,l,o),c=k(t,l.results.all,o.graphics),h=l.results.ground,d=(0,y.J4)(h,t),p=null!=d&&"type"in d&&(0,f.nx)(d.type)?d:null,b={screenPoint:n,results:c,ground:{mapPoint:M(t,h),distance:(0,g.nn)(h)?h.distanceInRenderSpace:0,layer:p}},e.abrupt("return",(v.h.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(b.intersector=l),b));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function S(e,t,n,i){var r,o,s,l,c,h=n?A(e,n):i,d=!((null===(r=h.graphics)||void 0===r||!r.include)&&(null===(o=h.graphics)||void 0===o||!o.exclude)),f=!((null===(s=h.mediaElements)||void 0===s||!s.include)&&(null===(l=h.mediaElements)||void 0===l||!l.exclude)),v=(0,u.md)(t);h.enableDraped=h.include&&!h.include.has(b.xX)||(null===(c=h.exclude)||void 0===c?void 0:c.has(b.xX));var p=e.sceneIntersectionHelper,g=(0,_.Z8)(e.state.viewingMode);if(g.options.selectionMode=!0,g.options.store=d||f?m.eC.ALL:m.eC.MIN,g.options.hud=!(null!==n&&void 0!==n&&n.excludeHud),p.intersectIntersectorScreen(v,g,h),d||f){var w,C=(0,a.Z)(g.results.all);try{for(C.s();!(w=C.n()).done;){var x=w.value,T=(0,y.bK)(x,e);if(null==T)return M(e,x);if(d&&("graphic"!==T.type||R(h.graphics,T.graphic)))return M(e,x);if(f&&("media"!==T.type||E(h.mediaElements,T.element)))return M(e,x)}}catch(S){C.e(S)}finally{C.f()}return null}return M(e,g.results.min)}function k(e,t,n){for(var i=new Array,a=null,o=0;o<t.length;o++){var s=t[o],l=(0,y.J4)(s,e);if(null!=l&&(l===e.map.ground||"type"in l&&(0,f.nx)(l.type)))break;var u=(0,y.bK)(s,e);if(null!=u){if("graphic"===u.type){if(null==a&&o!==t.length-1&&(a=new Set),null!=a){var c=P(u.graphic);if(a.has(c))continue;a.add(c)}if(!R(n,u.graphic))continue}var h=M(e,s),d=s.distanceInRenderSpace;if("media"===u.type){var v=u.element.toSource(h);i.push((0,r.Z)((0,r.Z)({},u),{},{mapPoint:h,distance:d,sourcePoint:v}))}else i.push((0,r.Z)((0,r.Z)({},u),{},{mapPoint:h,distance:d}))}}return i}function M(e,t,n){var i;return t.getIntersectionPoint(U)?(n=O(e,U,n),t.intersector===m.q7.TERRAIN&&e.basemapTerrain&&(n.z=null!==(i=(0,p.KO)(e.basemapTerrain,n))&&void 0!==i?i:0),n):null}function P(e){var t=e.sourceLayer,n=e.layer,i=t&&"objectIdField"in t?t:n&&"objectIdField"in n?n:t;if(i){var r,a,o=null!==(r=i.objectIdField)&&void 0!==r?r:d.d,s=null===(a=e.attributes)||void 0===a?void 0:a[o];if(s)return"o-".concat(i.id,"-").concat(s)}return"u-".concat(e.uid)}function R(e,t){return E(e,P(t))}function E(e,t){return null==e||(null==e.include||e.include.has(t))&&(null==e.exclude||!e.exclude.has(t))}function O(e,t,n){var i=e.spatialReference||w.Z.WGS84;return(0,h.S)(t,e.renderSpatialReference,U,i)?t=U:(i=w.Z.WGS84,(0,h.S)(t,e.renderSpatialReference,U,i)&&(t=U)),n?(n.x=t[0],n.y=t[1],n.z=t[2],n.spatialReference=i):n=new C.Z(t,i),n}function A(e,t){var n=D(e,t.include,N.INCLUDE),i=D(e,t.exclude,N.EXCLUDE);return{include:n.layerUids,exclude:i.layerUids,graphics:{include:n.graphicUids,exclude:i.graphicUids},mediaElements:{include:n.mediaElements,exclude:i.mediaElements}}}function D(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{layerUids:void 0,graphicUids:void 0,mediaElements:void 0};if(!t)return i;if(t instanceof s.Z)I(i,P(t)),n===N.INCLUDE&&(null!=e.graphicsView&&t.layer===e?Z(i,e.graphicsView.processor.layer.id):t.layer&&Z(i,t.layer.uid));else if("layer"in t&&"element"in t)L(i,t.element),n===N.INCLUDE&&Z(i,t.layer.uid);else if((0,l.TW)(t)){var r,o=(0,a.Z)(t);try{for(o.s();!(r=o.n()).done;){var u=r.value;u===e.graphics&&null!=e.graphicsView?Z(i,e.graphicsView.processor.layer.id):u===e.map.ground?Z(i,b.xX):D(e,u,n,i)}}catch(c){o.e(c)}finally{o.f()}}else"uid"in t&&Z(i,t.uid);return i}function Z(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function I(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function L(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)}var N,U=(0,c.Ue)();!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(N||(N={}))},45888:function(e,t,n){var i;n.d(t,{Bh:function(){return i},NT:function(){return a},Ty:function(){return r}}),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(i||(i={}));var r=function(){var e=new Array;return e[i.ELEVATION]=10,e[i.BASEMAP]=10,e[i.I3S_INDEX]=10,e[i.I3S_DATA]=10,e[i.SYMBOLOGY]=5,e}(),a=30},28961:function(e,t,n){n.d(t,{GD:function(){return x},H3:function(){return g},WA:function(){return m},XO:function(){return b},d5:function(){return w}});var i=n(43144),r=n(15671),a=n(16889),o=n(29134),s=n(7025),l=n(13611),u=n(6644),c=n(32035),h=n(12400),d=n(50951),f=n(73401),v=n(80064),p={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}},_=(0,i.Z)((function e(t,n){(0,r.Z)(this,e),this.direct=t,this.ambient=n}));function m(e,t,n,i,r,o){(0,c.s)(o.ambient.color,1,1,1),o.ambient.intensity=p.global.ambient,(0,c.s)(o.direct.color,1,1,1),o.direct.intensity=p.global.direct;var s,d=t[2],v=(0,a.uZ)((Math.abs(d)-p.local.altitude)/(p.global.altitude-p.local.altitude),0,1);if(o.globalFactor=v,null!=e&&(s=f.S.getTimes(e,t[1],t[0])),v<1){var _;if(null!=e)_=function(e,t,n){var i,r,a=e.valueOf();t.polarException===f.S.PolarException.MIDNIGHT_SUN?(i=a-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,r=i+432e6):t.polarException===f.S.PolarException.POLAR_NIGHT?(i=a-2,r=a-1):(i=t.sunrise.valueOf(),r=t.sunset.valueOf());var o=r-i,s=i+o/2,d=o/4,v=s-d,p=s+d,_=.06*o,m=i-_/2,g=i+_/2,y=r-_/2,b=r+_/2,w=(0,u.Ue)(),C=(0,h.Ue)(),x=(0,h.Ue)(),T="";if(a<m||a>b)(0,l.JG)(w,L),(0,c.c)(C,P),(0,c.c)(x,A),T="night";else if(a<g){var S=(a-m)/(g-m);(0,l.t7)(w,L,N,S),(0,c.o)(C,P,R,S),(0,c.o)(x,A,D,S),T="sun rising"}else if(a<v){var j=(a-g)/(v-g);(0,l.t7)(w,N,U,j),(0,c.o)(C,R,E,j),(0,c.o)(x,D,Z,j),T="early morning"}else if(a<s){var W=(a-v)/(s-v);(0,l.t7)(w,U,H,W),(0,c.o)(C,E,O,W),(0,c.o)(x,Z,I,W),T="late morning"}else if(a<p){var X=(a-s)/(p-s);(0,l.t7)(w,H,F,X),(0,c.o)(C,O,V,X),(0,c.o)(x,I,z,X),T="early afternoon"}else if(a<y){var Q=(a-p)/(y-p);(0,l.t7)(w,F,q,Q),(0,c.o)(C,V,B,Q),(0,c.o)(x,z,G,Q),T="late afternoon"}else if(a<b){var Y=(a-y)/(b-y);(0,l.t7)(w,q,L,Y),(0,c.o)(C,B,P,Y),(0,c.o)(x,G,A,Y),T="sun setting"}var J=0;switch(n){case"rainy":case"foggy":J=.8;break;case"snowy":J=.5}J>0&&(M(C,J),M(x,J));var K=k(n);return{direct:{intensity:w[0]*K.direct,color:C},ambient:{intensity:w[1]*K.ambient,color:x},timeOfDay:T}}(e,s,i);else{var m=k(i);_={direct:{intensity:p.local.directAtNoon*m.direct,color:(0,h.al)(1,1,1)},ambient:{intensity:p.local.ambientAtNoon*m.ambient,color:(0,h.al)(1,1,1)},timeOfDay:"early afternoon"}}(0,c.o)(o.ambient.color,_.ambient.color,o.ambient.color,v),o.ambient.intensity=(0,a.t7)(_.ambient.intensity,o.ambient.intensity,v),(0,c.o)(o.direct.color,_.direct.color,o.direct.color,v),o.direct.intensity=(0,a.t7)(_.direct.intensity,o.direct.intensity,v),o.specularStrength="rainy"===i||"snowy"===i||"foggy"===i?0:1,o.environmentStrength="rainy"===i?.7:"snowy"===i||"foggy"===i?.75:1}o.noonFactor=null!=e?function(e,t){var n,i,r=e.valueOf();t.polarException===f.S.PolarException.MIDNIGHT_SUN?(n=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,i=n+432e6):t.polarException===f.S.PolarException.POLAR_NIGHT?(n=r-2,i=r-1):(n=t.sunrise.valueOf(),i=t.sunset.valueOf());var o=n+(i-n)/2;return 1-(0,a.uZ)(Math.abs(r-o)/432e5,0,1)}(e,s):1,null!=e?y(e,t,n,o.direct.directionToLightSource):g(r,n,o.direct.directionToLightSource)}function g(e,t,n){t===d.JY.Global?(0,c.n)(X,e.eye):(0,c.s)(X,0,0,1),(0,c.j)(Q,e.viewForward,-1);var i=(0,v.EU)(Q,X),r=Math.max(i-2*J,0),a=.85*r/(r+1),s=Math.max(J,i-J-a);(0,o.Us)(W,-s,e.viewRight),(0,c.h)(n,Q,W),(0,c.g)(n,n,(0,c.j)(Y,e.viewRight,K)),(0,c.n)(n,n)}function y(e,t,n,i){var r=S,s=(0,o.yR)(T);if(n===d.JY.Global)f.S.getPosition(e,0,0,r),(0,c.s)(i,0,0,-1),(0,o.lM)(s,s,-r.azimuth),(0,o.uD)(s,s,-r.altitude),(0,c.h)(i,i,s);else{var l=p.planarDirection,u=l.globalAngles,h=t[2],v=(Math.abs(h)-l.localAltitude)/(l.globalAltitude-l.localAltitude);(v=(0,a.uZ)(v,0,1))<1?(f.S.getPosition(e,t[1],t[0],r),r.azimuth=(1-v)*r.azimuth+v*u.azimuth,r.altitude=(1-v)*r.altitude+v*u.altitude):(r.azimuth=u.azimuth,r.altitude=u.altitude),(0,c.s)(i,0,-1,0),(0,o.jI)(s,s,-r.azimuth),(0,o.lM)(s,s,-r.altitude),(0,c.h)(i,i,s)}}function b(e,t){if(t===d.JY.Global)return!0;var n=p.planarDirection;return Math.abs(e)<n.localAltitude}function w(e,t,n,i,r){for(var a=e.getTime(),o=t.getTime()-a,s=Math.floor(o/n)+1,l=new Array(s),u=0;u<s;++u)j.setTime(a+n*u),l[u]=(0,h.Ue)(),y(j,i,r,l[u]);return l}var C=(0,h.al)(.5773502691896258,-.5773502691896258,.5773502691896258),x=(0,i.Z)((function e(){(0,r.Z)(this,e),this.ambient={color:(0,h.al)(1,1,1),intensity:.55},this.direct={color:(0,h.al)(1,1,1),intensity:.55,directionToLightSource:(0,h.d9)(C)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1})),T=(0,s.Ue)(),S={azimuth:0,altitude:0};function k(e){switch(e){case"disabled":case"sunny":case"cloudy":return new _(1,1);case"rainy":return new _(.4,1.2);case"snowy":return new _(.5,1.3);case"foggy":return new _(.2,1.6)}}function M(e,t){var n=(e[0]+e[1]+e[2])/3;e[0]+=(n-e[0])*t,e[1]+=(n-e[1])*t,e[2]+=(n-e[2])*t}var P=(0,h.al)(.01,.01,.01),R=(0,h.al)(1,.6,.5),E=(0,h.al)(1,.98,.98),O=(0,h.al)(1,1,1),A=(0,h.al)(.8,.8,1),D=(0,h.al)(.8,.8,1),Z=(0,h.al)(.98,.98,1),I=(0,h.al)(1,1,1),L=(0,u.al)(.01,p.local.ambientAtNight),N=(0,u.al)(p.local.directAtTwilight,p.local.ambientAtTwilight),U=(0,u.al)(.9*p.local.directAtNoon,p.local.ambientAtNoon),H=(0,u.al)(p.local.directAtNoon,p.local.ambientAtNoon),F=U,V=E,z=Z,q=N,B=R,G=D;var j=new Date(0),W=(0,s.Ue)(),X=(0,h.Ue)(),Q=(0,h.Ue)(),Y=(0,h.Ue)(),J=.25,K=.2},82575:function(e,t,n){n.d(t,{M:function(){return r},O:function(){return a}});var i=n(92975);function r(e){return a(e)||(0,i.BZ)(e)||(0,i.V2)(e)}function a(e){return(0,i.oR)(e)||(0,i.yW)(e)}},58890:function(e,t,n){n.d(t,{V:function(){return i},q:function(){return r}});var i={value:.5,readOnly:!0},r={readOnly:!0,value:.5,get:function(){return this.updating?this.updatingProgressValue:1}}},35367:function(e,t,n){var i;n.d(t,{X:function(){return i}}),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(i||(i={}))},82394:function(e,t,n){var i;n.d(t,{z:function(){return i}}),function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(i||(i={}))},35535:function(e,t,n){n.d(t,{$X:function(){return o},C5:function(){return f},Cf:function(){return s},GZ:function(){return c},JR:function(){return d},if:function(){return l},p1:function(){return v},qC:function(){return p},uU:function(){return h},zl:function(){return u}});var i=n(16889),r=n(65156),a=n(62140),o=64,s=512,l=2.5,u=(0,i.oK)(i.F3/10),c=2,h=(0,r.Ue)();a.t.WebMercatorAuxiliarySphere.getExtent(0,0,0,h);var d=(0,r.Ue)([-180,-90,180,90]),f="Cannot extend surface to encompass all layers because it would result in too many root tiles.",v="Surface extent is too large for tile resolution at level 0.",p=4},55468:function(e,t,n){function i(e){return null!=e&&"type"in e&&"vector-tile"===e.type}function r(e){return null!=e&&"type"in e&&"raster-tile"===e.type}function a(e){return null!=e&&"type"in e&&"tile-texture"===e.type}function o(e){return null!=e&&"type"in e&&"image+type"===e.type}n.d(t,{AK:function(){return i},Cm:function(){return o},Q_:function(){return a},yd:function(){return r}})},62140:function(e,t,n){n.d(t,{_:function(){return m},t:function(){return _}});var i=n(15671),r=n(43144),a=(n(59486),n(10064)),o=(n(93169),n(16889)),s=n(68860),l=n(53866),u=n(78952),c=n(65156),h=n(92975),d=n(81753),f=n(59068),v=n(22824),p=n(848),_=function(){function e(t){(0,i.Z)(this,e);var n=e.checkUnsupported(t);if(null!=n)throw n;var r=t;this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,h.sT)(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;var a=r.lods.reduce((function(e,t){return t.level<e.minLod.level&&(e.minLod=t),e.max=Math.max(e.max,t.level),e}),{minLod:r.lods[0],max:-1/0}),o=a.minLod,s=Math.pow(2,o.level),l=o.resolution*s,u=o.scale*s;this.levels=new Array(a.max+1);for(var c=0;c<this.levels.length;c++)this.levels[c]={resolution:l,scale:u,tileSize:[l*r.size[0],l*r.size[1]]},l/=2,u/=2}return(0,r.Z)(e,[{key:"clone",value:function(){return new e(this.toTileInfo())}},{key:"toTileInfo",value:function(){return new v.Z({dpi:this.dpi,origin:new p.Z({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((function(e,t){return new f.Z({level:t,scale:e.scale,resolution:e.resolution})}))})}},{key:"getExtent",value:function(e,t,n,i){var r=this.levels[e],a=r.tileSize[0],o=r.tileSize[1];i[0]=this.origin[0]+n*a,i[2]=this.origin[0]+(n+1)*a,i[3]=this.origin[1]-t*o,i[1]=this.origin[1]-(t+1)*o}},{key:"convertExtentToRadians",value:function(e,t){this._isWebMercator?(t[0]=(0,d.tp)(e[0]),t[1]=(0,d.mZ)(e[1]),t[2]=(0,d.tp)(e[2]),t[3]=(0,d.mZ)(e[3])):this._isGCS&&(t[0]=(0,o.Vl)(e[0]),t[1]=(0,o.Vl)(e[1]),t[2]=(0,o.Vl)(e[2]),t[3]=(0,o.Vl)(e[3]))}},{key:"getExtentGeometry",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new l.Z;return this.getExtent(e,t,n,g),i.spatialReference=this.spatialReference,i.xmin=g[0],i.ymin=g[1],i.xmax=g[2],i.ymax=g[3],i.zmin=void 0,i.zmax=void 0,i}},{key:"ensureMaxLod",value:function(e){if(null==e)return!1;for(var t=!1;this.levels.length<=e;){var n=this.levels[this.levels.length-1],i=n.resolution,r=n.scale,a=i/2*this.pixelSize;this.levels.push({resolution:i/2,scale:r/2,tileSize:[a,a]}),t=!0}return t}},{key:"capMaxLod",value:function(e){this.levels.length>e+1&&(this.levels.length=e+1)}},{key:"getMaxLod",value:function(){return this.levels.length-1}},{key:"scaleAtLevel",value:function(e){return this.levels[0].scale/Math.pow(2,e)}},{key:"levelAtScale",value:function(e){var t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}},{key:"resolutionAtLevel",value:function(e){return this.levels[0].resolution/Math.pow(2,e)}},{key:"compatibleWith",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0;if(e.checkUnsupported(t))return!1;var i=new e(t);if(!i.spatialReference.equals(this.spatialReference))return!1;if(i.pixelSize!==this.pixelSize)return!1;var r=Math.min(this.levels.length-1,i.levels.length-1,n),a=this.levels[r].resolution,s=.5*a;return!(!(0,o.W8)(i.origin[0],this.origin[0],s)||!(0,o.W8)(i.origin[1],this.origin[1],s))&&(s=.5*a/Math.pow(2,r)/this.pixelSize*12,(0,o.W8)(a,i.levels[r].resolution,s))}},{key:"rootTilesInExtent",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,r=new Array,a=this.levels[0].tileSize;if(null==t||0===a[0]||0===a[1])return r;e.computeRowColExtent(t,a,this.origin,g);var o=g[1],s=g[3],l=g[0],u=g[2],c=u-l,h=s-o;if(c*h>i){var d=Math.floor(Math.sqrt(i));h>d&&(s=(o=o+Math.floor(.5*h)-Math.floor(.5*d))+d),c>d&&(u=(l=l+Math.floor(.5*c)-Math.floor(.5*d))+d)}for(var f=o;f<s;f++)for(var v=l;v<u;v++)r.push([0,f,v]);return null!=n&&(n[0]=this.origin[0]+l*a[0],n[1]=this.origin[1]-s*a[1],n[2]=this.origin[0]+u*a[0],n[3]=this.origin[1]-o*a[1]),r}},{key:"test",get:function(){}}],[{key:"computeRowColExtent",value:function(e,t,n,i){var r=.001*(e[2]-e[0]+(e[3]-e[1]));i[0]=Math.max(0,Math.floor((e[0]+r-n[0])/t[0])),i[2]=Math.max(0,Math.ceil((e[2]-r-n[0])/t[0])),i[1]=Math.max(0,Math.floor((n[1]-e[3]+r)/t[1])),i[3]=Math.max(0,Math.ceil((n[1]-e[1]-r)/t[1]))}},{key:"isPowerOfTwo",value:function(e){var t=e.lods,n=t[0].resolution*Math.pow(2,t[0].level);return!t.some((function(e){return!(0,o.Y8)(e.resolution,n/Math.pow(2,e.level))}))}},{key:"hasGapInLevels",value:function(e){var t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(var n=1;n<t.length;n++)if(t[n]!==t[0]+n)return!0;return!1}},{key:"tileSizeSupported",value:function(e){var t=e.size[1];return t===e.size[0]&&!(t&t-1)&&t>=128&&t<=512}},{key:"hasOriginPerLODs",value:function(e){var t=e.origin;return e.lods.some((function(e){return null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)}))}},{key:"getMissingTileInfoError",value:function(){return new a.Z("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}},{key:"checkUnsupported",value:function(t){return null==t?m():t.lods.length<1?new a.Z("tilingscheme:generic","Tiling scheme must have at least one level"):e.isPowerOfTwo(t)?e.hasGapInLevels(t)?new a.Z("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):e.tileSizeSupported(t)?e.hasOriginPerLODs(t)?new a.Z("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new a.Z("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new a.Z("tilingscheme:power-of-two","Tiling scheme must be power of two")}},{key:"fromExtent",value:function(t,n){var i=t[2]-t[0],r=t[3]-t[1],a=(0,s.c9)(n),o=1.2*Math.max(i,r),l=o/256,u=l*a*(96/.0254),c=new e(new v.Z({size:[256,256],origin:new p.Z({x:t[0]-.5*(o-i),y:t[3]+.5*(o-r)}),lods:[new f.Z({level:0,resolution:l,scale:u})],spatialReference:n}));return c.ensureMaxLod(20),c}},{key:"makeWebMercatorAuxiliarySphere",value:function(t){var n=new e(e.WebMercatorAuxiliarySphereTileInfo);return n.ensureMaxLod(t),n}},{key:"makeGCSWithTileSize",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,r=256/n,a=new e(new v.Z({size:[n,n],origin:new p.Z({x:-180,y:90,spatialReference:t}),spatialReference:t,lods:[new f.Z({level:0,resolution:.703125*r,scale:295497598.570834*r})]}));return a.ensureMaxLod(i),a}}]),e}();function m(){return new a.Z("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}_.WebMercatorAuxiliarySphereTileInfo=new v.Z({size:[256,256],origin:new p.Z({x:-20037508.342787,y:20037508.342787,spatialReference:u.Z.WebMercator}),spatialReference:u.Z.WebMercator,lods:[new f.Z({level:0,resolution:156543.03392800014,scale:591657527.591555})]}),_.WebMercatorAuxiliarySphere=_.makeWebMercatorAuxiliarySphere(19);var g=(0,c.Ue)()},53379:function(e,t,n){n.d(t,{Wq:function(){return ie},er:function(){return Y},qA:function(){return E},T9:function(){return M},HK:function(){return R},V0:function(){return P},RB:function(){return A},O1:function(){return K},E_:function(){return J},Fp:function(){return O},TK:function(){return F},Eu:function(){return ue},_1:function(){return U},a_:function(){return H},S3:function(){return j},Ay:function(){return q},GL:function(){return V},Mw:function(){return he},wt:function(){return se},x4:function(){return D},uv:function(){return ce},wP:function(){return z},z7:function(){return G},Q:function(){return L},B9:function(){return W},Ke:function(){return B},OD:function(){return le},_0:function(){return oe},sP:function(){return te},cA:function(){return fe},OC:function(){return de},$v:function(){return re},_F:function(){return ae},ep:function(){return X},Bu:function(){return ee},FZ:function(){return Q},zT:function(){return ne},jO:function(){return $},wu:function(){return k}});var i=n(4942),r=n(80987),a=n(92975),o=n(37933),s=n(50951),l=n(35367),u=n(55468),c=n(10064),h=n(32035),d=n(12400),f=n(65156),v=n(82575),p=n(35535),_=n(62140),m=(0,d.Ue)(),g=(0,d.Ue)(),y=(0,d.Ue)(),b=(0,d.Ue)();function w(e,t,n,i){(0,h.c)(m,n),m[i]=t[i];var r,a=(0,h.f)(m,m,t),o=(0,h.f)(g,e,t),s=(0,h.m)(o,a),l=(0,h.m)(a,a);r=s<=0?t:l<=s?n:(0,h.g)(m,t,(0,h.j)(a,a,s/l));var u=(0,h.f)(m,e,r);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}var C=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n,i){if(null==e)return(0,_._)();var r=e.spatialReference;if(r.isGeographic&&!(0,v.O)(r))return new c.Z("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");var a=_.t.checkUnsupported(e);if(null!=a)return a;if(null==n)return new c.Z("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");var o=function(e,t){var n=e.lods,i=n[0].resolution*Math.pow(2,n[0].level),r=[i*e.size[0],i*e.size[1]],a=[e.origin.x,e.origin.y],o=(0,f.oJ)(t),s=(0,f.Ue)();_.t.computeRowColExtent(o,r,a,s);var l=(s[2]-s[0])*(s[3]-s[1]);if(l>p.$X){var u=n[0].scale*Math.pow(2,n[0].level),h=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*u/i,d=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/Math.pow(10,d))*Math.pow(10,d),new c.Z("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(u).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:u,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:p.$X})}return null}(e,n);return o||(null==t||r.equals(t)||t.isWGS84&&r.isWebMercator?null:new c.Z("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))},isInsideExtent:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=e.extent;if(null==i)return!1;if(0===n)return(0,f.BD)(i,t);var r=Math.min(i[2]-i[0],i[3]-i[1]);return(0,f.Zm)(i,t,n*r)},tiltToExtentEdge:function(e,t,n){var i=e.extent;if(null==i)return 0;y[0]=i[0],y[1]=i[1],y[2]=n,b[0]=i[2],b[1]=i[3],b[2]=n;var r=1/0,a=1/0;return t[0]<y[0]?r=w(t,y,b,0):t[0]>b[0]&&(r=w(t,b,y,0)),t[1]<y[1]?a=w(t,y,b,1):t[1]>b[1]&&(a=w(t,b,y,1)),Math.min(r,a)}},Symbol.toStringTag,{value:"Module"}));var x,T=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n,i){if(null==e)return(0,_._)();var r=(null===e||void 0===e?void 0:e.lods.length)-1,a=e.spatialReference;if(a.isWebMercator){if(!_.t.makeWebMercatorAuxiliarySphere(r).compatibleWith(e,i))return new c.Z("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!(0,v.M)(a))return new c.Z("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!_.t.makeGCSWithTileSize(e.spatialReference,e.size[0],r).compatibleWith(e,i))return e.spatialReference.isWGS84?new c.Z("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new c.Z("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==t||e.spatialReference.equals(t)?null:new c.Z("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")},isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0}},Symbol.toStringTag,{value:"Module"})),S=(x={},(0,i.Z)(x,s.JY.Global,T),(0,i.Z)(x,s.JY.Local,C),x);function k(e,t){e||console.warn("Terrain: "+t)}var M=!1,P=!1;function R(e){P=e,M=M||e}function E(e){M=e}function O(e,t){if(M&&!e){var n,i=null===(n=(new Error).stack)||void 0===n?void 0:n.slice(5);throw console.warn("Terrain internal: "+(null!==t&&void 0!==t?t:"")+" at "+i),new Error("Assertion failed"+(t?": "+t:""))}}function A(e){return Z(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function D(e){return"imagery-tile"===(null===e||void 0===e?void 0:e.type)||"wcs"===(null===e||void 0===e?void 0:e.type)}function Z(e){return"imagery-tile-3d"===(null===e||void 0===e?void 0:e.type)}function I(e){return"tile-3d"===(null===e||void 0===e?void 0:e.type)}function L(e){return"vector-tile-3d"===(null===e||void 0===e?void 0:e.type)}function N(e){return"wmts-3d"===(null===e||void 0===e?void 0:e.type)}function U(e){return"elevation-3d"===(null===e||void 0===e?void 0:e.type)}function H(e){return"group"===(null===e||void 0===e?void 0:e.type)}function F(e){return e&&(I(e)||N(e)||Z(e)||L(e))}function V(e){return e&&(I(e)||Z(e)||L(e)||N(e))}function z(e){return V(e)||U(e)}function q(e){var t;return(0,u.yd)(null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data)}function B(e){return W(null===e||void 0===e?void 0:e.sourceLayerInfo)||!(null===e||void 0===e||!e.isVTLBackground)}function G(e){var t;return(0,u.Q_)(null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data)}function j(e){var t,n=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return(0,u.Cm)(n)||n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof ImageData}function W(e){return(0,u.AK)(null===e||void 0===e?void 0:e.data)}function X(e){return null!=e&&"release"in e&&e.release(),null}function Q(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function Y(e,t,n,i,r){return S[i].checkIfTileInfoSupportedForViewSR(e,n,t,r)}function J(e,t,n){var i,r=null,a=null;if("wmts"===(null===e||void 0===e?void 0:e.type)){var o=K(e,t,n);r=o.tileInfo,a=o.fullExtent}else{a=D(e)?e.getCompatibleFullExtent(t):e.fullExtent;var l=n===s.JY.Local;r=D(e)?e.getCompatibleTileInfo(t,a,l):"vector-tile"===(null===e||void 0===e?void 0:e.type)?l&&!$(t)||ee.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}var u="tilemapCache"in e?null===(i=e.tilemapCache)||void 0===i?void 0:i.effectiveMaxLOD:void 0;return null!=r&&null!=a&&null==Y(r,a,t,n,u)?{tileInfo:r,fullExtent:a}:null}function K(e,t,n){var i=(0,o.mt)(e);if(null!=i){if(!r.Z.isCollection(i))return{tileInfo:i.tileInfo,fullExtent:i.fullExtent};var a=i.find((function(e){return null==Y(e.tileInfo,e.fullExtent,t,n)}));if(a)return{tileInfo:a.tileInfo,fullExtent:a.fullExtent}}return{tileInfo:null,fullExtent:null}}function $(e){return e.isWGS84||e.isWebMercator||(0,a.yW)(e)||!(0,a.N$)(e)}var ee={force512VTL:!1};function te(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function ne(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function ie(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ve;return Math.abs(e-t)<n}function re(e){return e===l.X.NORTH_EAST?l.X.SOUTH_WEST:e===l.X.NORTH_WEST?l.X.SOUTH_EAST:e===l.X.SOUTH_WEST?l.X.NORTH_EAST:l.X.NORTH_WEST}function ae(e){return e===l.X.NORTH?l.X.SOUTH:e===l.X.EAST?l.X.WEST:e===l.X.SOUTH?l.X.NORTH:l.X.EAST}function oe(e){return e===l.X.NORTH_WEST||e===l.X.SOUTH_WEST}function se(e){return e===l.X.NORTH_WEST||e===l.X.NORTH_EAST}function le(e){return e===l.X.NORTH_WEST||e===l.X.WEST||e===l.X.SOUTH_WEST}function ue(e){return e===l.X.NORTH_EAST||e===l.X.EAST||e===l.X.SOUTH_EAST}function ce(e){return e===l.X.SOUTH_EAST||e===l.X.SOUTH||e===l.X.SOUTH_WEST}function he(e){return e===l.X.NORTH_EAST||e===l.X.NORTH||e===l.X.NORTH_WEST}var de=[l.X.NORTH,l.X.EAST,l.X.SOUTH,l.X.WEST],fe=[l.X.NORTH_EAST,l.X.SOUTH_EAST,l.X.SOUTH_WEST,l.X.NORTH_WEST],ve=1e-5},36734:function(e,t,n){n.d(t,{AA:function(){return l},E9:function(){return C},QT:function(){return b},b:function(){return y},dF:function(){return p},gl:function(){return h},rv:function(){return u},t8:function(){return w},yf:function(){return c},zW:function(){return d}});var i=n(37762),r=n(15671),a=n(43144),o=n(27546),s=n(82394),l=function(){function e(){(0,r.Z)(this,e),this._queue=new o.Z,this.remove=function(){}}return(0,a.Z)(e,[{key:"done",get:function(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}},{key:"resetOne",value:function(e){this._queue.clear(),this._queue.push(e),this._last=void 0}},{key:"reset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}},{key:"skipSubtree",value:function(){this._last=void 0}},{key:"next",value:function(){var e,t=null===(e=this._last)||void 0===e?void 0:e.children;return null!==t&&void 0!==t&&t[0]&&this._queue.pushArray(t),this._last=this._queue.pop(),this._last}}]),e}(),u=function(){function e(){(0,r.Z)(this,e),this._q=new o.Z}return(0,a.Z)(e,[{key:"done",get:function(){return 0===this._q.length}},{key:"reset",value:function(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(var t=0;t<this._q.length;++t){var n=this._q.data[t];n.isLeaf||this._q.pushArray(n.children)}}}},{key:"next",value:function(){return this._q.pop()}}]),e}();function c(e,t,n){if(null==(null===t||void 0===t?void 0:t.fullExtent))return!1;var i=t.fullExtent,r=e.extent;if(n){if(r[0]<i.xmin||r[1]<i.ymin||r[2]>i.xmax||r[3]>i.ymax)return!1}else if(i.xmin>r[2]||i.ymin>r[3]||i.xmax<r[0]||i.ymax<r[1])return!1;var a=e.surface.tilingScheme.levels[e.level].scale,o=t.minScale;if(o>0&&a>1.00000001*o)return!1;var s=t.maxScale;return!(s>0&&a<.99999999*s)}function h(e,t){var n=e.lij,i=t.lij;return n[0]-i[0]||n[1]-i[1]||n[2]-i[2]}function d(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==n||0===n.length?e===s.z.BACK_TO_FRONT?t.sort(f):t.sort(v):t.sort((function(t,i){return _(t,i,e,n)}))}function f(e,t){var n=t.screenDepth-e.screenDepth;if(0!==n)return n;var i=e.lij,r=t.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function v(e,t){var n=e.screenDepth-t.screenDepth;if(0!==n)return n;var i=e.lij,r=t.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function p(e,t,n){var i=e.screenDepth,r=t.screenDepth;return i<r?-n:i>r?n:h(e,t)}function _(e,t,n,i){return m(e,i)===m(t,i)?p(e,t,n):e?n:-n}function m(e,t){var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(e.intersectsExtent(a))return!0}}catch(o){r.e(o)}finally{r.f()}return!1}function g(e,t){var n=e.distanceToPOI-t.distanceToPOI;if(0!==n)return n;var i=e.lij,r=t.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function y(e,t){for(var n=e.length,i=0;i<n;++i)e.at(i).updateDistanceToPOI(t);e.sort(g)}function b(e,t,n){for(var i=1,r=0,a=0;e!==t;)if(i*=.5,r*=.5,a*=.5,1&e.lij[2]&&(r+=.5),1&e.lij[1]||(a+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");n.init(t,r,a,i)}function w(e){for(var t=0;t<e.length;t++){var n=e[t],i=n.parent;if(i)for(var r=0;r<4;r++){var a=i.children[r];if(a&&a!==n)return!0}}return!1}function C(e,t){if(!e||!t||e[0]===t[0])return!1;var n=e[0]<t[0],i=n?e:t,r=n?t:e,a=1<<r[0]-i[0];return Math.floor(r[1]/a)===i[1]&&Math.floor(r[2]/a)===i[2]}},46987:function(e,t,n){n.d(t,{Un:function(){return H},ws:function(){return M},zO:function(){return V},Qu:function(){return z}});var i=n(15671),r=n(43144),a=n(60136),o=n(29388),s=n(27366),l=n(92026),u=n(29303),c=n(21389),h=n(32035),d=n(12400),f=n(19093),v=n(86361),p=n(49420),_=n(92015),m=n(9028),g=n(7564),y=n(37107),b=n(91871),w=n(37762),C=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments))._dirty=!0,e}return(0,r.Z)(n,[{key:"_setDirty",value:function(){this._dirty=!0}},{key:"_setClean",value:function(){if(this._dirty=!1,null!=this._parameterBlocks){var e,t=(0,w.Z)(this._parameterBlocks);try{for(t.s();!(e=t.n()).done;){this[e.value]._setClean()}}catch(n){t.e(n)}finally{t.f()}}}},{key:"dirty",get:function(){return this._dirty||this._checkParameterBlocksDirty()}},{key:"_checkParameterBlocksDirty",value:function(){if(null==this._parameterBlocks)return!1;var e,t=(0,w.Z)(this._parameterBlocks);try{for(t.s();!(e=t.n()).done;){if(this[e.value].dirty)return!0}}catch(n){t.e(n)}finally{t.f()}return!1}}]),n}(n(98634).K),x=function(){function e(){(0,i.Z)(this,e),this._dirty=!0}return(0,r.Z)(e,[{key:"_setDirty",value:function(){this._dirty=!0}},{key:"_setClean",value:function(){this._dirty=!1}},{key:"dirty",get:function(){return this._dirty}}]),e}();function T(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,n){var i,r=null!==(i=t._parameterCount)&&void 0!==i?i:0;if(t._parameterCount=r+1,e.vectorOps){var a=e.vectorOps;Object.defineProperty(t,n,{get:function(){return this[r]},set:function(e){var t=this[r];if(null==t)this[r]=e;else{if(a.equals(t,e))return;a.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,n,{get:function(){return this[r]},set:function(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function S(){return function(e,t){var n,i=null!==(n=e._parameterCount)&&void 0!==n?n:0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get:function(){return this[i]},set:function(e){this[i]!==e&&(this[i]=e,this._setDirty())}})}}var k,M,P=n(74779),R=n(37081),E=n(16010),O=n(96658),A=n(41481),D=n(26461),Z=n(86097),I=n(75104),L=n(68401),N=n(25920),U=n(45856),H=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,r){var a;(0,i.Z)(this,n),(a=t.call(this)).toMapSpace=r,a.baseColor=(0,v.al)(1,1,1,1),a.usePBR=!1,a.hasParametersFromSource=!1,a.mrrFactors=(0,d.nI)(U.ml),a.emissiveFactor=(0,d.al)(0,0,0),a.baseColorTexture=null,a.metallicRoughnessTexture=null,a.emissionTexture=null,a.occlusionTexture=null,a.normalTexture=null,a.objectOpacity=1,a.commonMaterialParameters=new F,a.componentParameters=new V,a.textureAlphaCutoff=D.F,a.alphaDiscardMode=L.JJ.Opaque,a.isIntegratedMesh=!1,a.polygonOffsetEnabled=!1,a.ellipsoidMode=Z.U.Earth,a.hasOccludees=!1,a._techniqueConfiguration=new g._;var o=new I.I(e.position),s=(0,c.d9)(e.rotationScale);return(0,u.U_)(s,s),(0,u.p4)(s,s),a.transformNormalGlobalFromModel=s,a.transformWorldFromModelTL=o.low,a.transformWorldFromModelTH=o.high,a.transformWorldFromModelRS=e.rotationScale,a}return(0,r.Z)(n,[{key:"dispose",value:function(){this._technique=(0,l.RY)(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}},{key:"texture",get:function(){return null!=this.baseColorTexture?this.baseColorTexture.glTexture:null}},{key:"textureMetallicRoughness",get:function(){return null!=this.metallicRoughnessTexture?this.metallicRoughnessTexture.glTexture:null}},{key:"textureEmissive",get:function(){return null!=this.emissionTexture?this.emissionTexture.glTexture:null}},{key:"textureOcclusion",get:function(){return null!=this.occlusionTexture?this.occlusionTexture.glTexture:null}},{key:"textureNormal",get:function(){return null!=this.normalTexture?this.normalTexture.glTexture:null}},{key:"prepareTechnique",value:function(e,t,n,i){var r=this._techniqueConfiguration;r.hasVertexColors=i.colors,r.hasNormals=i.hasNormals,r.textureCoordinateType=i.textureCoordinates,r.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,r.hasEmissionTexture=null!=this.emissionTexture,r.hasOcclusionTexture=null!=this.occlusionTexture,r.hasNormalTexture=null!=this.normalTexture,r.transparencyPassType=t.identifier===P.o9.Material&&null!=n.transparencyPassType?n.transparencyPassType:N.A.NONE,r.multipassEnabled=t.identifier===P.o9.Material&&n.multipassEnabled,r.cullAboveGround=t.identifier===P.o9.Material&&n.multipassTerrain.cullAboveGround,r.ellipsoidMode=this.ellipsoidMode,r.componentData=this.componentParameters.type,r.cullFace=this.commonMaterialParameters.cullFace,r.doubleSidedMode=this.commonMaterialParameters.doubleSided?O.q.View:O.q.None,r.hasColorTexture=null!=this.baseColorTexture;var a=this._computeWhichMaterialPass();if(r.blendingEnabled=a===k.Transparent||a===k.OpaqueAndTransparent,r.alphaDiscardMode=this.alphaDiscardMode,r.integratedMeshMode=this.isIntegratedMesh?function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(_.D.ColorNoRasterImage))}(n)?function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(_.D.WaterNormal))}(n)?g.O.ColorOverlayWithWater:g.O.ColorOverlay:g.O.NoOverlay:g.O.None,r.hasPolygonOffset=this.polygonOffsetEnabled,r.pbrMode=r.integratedMeshMode===g.O.ColorOverlayWithWater?A.f7.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?i.needsNormals&&this.isIntegratedMesh?A.f7.Disabled:A.f7.Schematic:A.f7.Normal:A.f7.Disabled,r.normalType=i.needsNormals?r.hasNormals?E.r.Compressed:E.r.ScreenDerivative:E.r.Ground,r.hasSlicePlane=null!=n.slicePlane&&this.commonMaterialParameters.hasSlicePlane,t.identifier===P.o9.ShadowMap)r.output=R.H_.Shadow,r.vertexDiscardMode=b.a.None;else if(t.identifier===P.o9.ViewshedShadowMap)r.output=R.H_.ViewshedShadow,r.vertexDiscardMode=b.a.None;else if(t.identifier===P.o9.Highlight)r.output=R.H_.Highlight,r.vertexDiscardMode=b.a.None;else{switch(a===k.OpaqueAndTransparent?r.vertexDiscardMode=t.transparent?b.a.Opaque:b.a.Transparent:r.vertexDiscardMode=b.a.None,r.output=t.output,r.receiveAmbientOcclusion=!1,r.receiveShadows=!1,t.output){case R.H_.Color:r.receiveAmbientOcclusion=null!=n.ssao,r.hasOccludees=n.hasOccludees,r.receiveShadows=n.shadowMap.ready,r.hasScreenSpaceReflections=null!=n.ssr.lastFrameColor,r.hasCloudsReflections=null!=n.cloudsFade.data;break;case R.H_.ObjectAndLayerIdColor:r.objectAndLayerIdColor=!0}r.snowCover=this.hasSnowCover(n)}return this._technique=e.releaseAndAcquire(m.h,r,this._technique),this._setClean(),this._technique}},{key:"hasSnowCover",value:function(e){return null!=e.weather&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}},{key:"submit",value:function(e,t,n){if(0!==this.objectOpacity){var i=n.renderable.geometry,r=n.components,a=n.renderable.meta.cameraDepthSquared,o=r.geometryRanges,s=r.highlightRanges,l=r.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case k.Opaque:e.materialOpaque.submitDraw(this,i,o,a);break;case k.Transparent:e.materialTransparent.submitDraw(this,i,o,a);break;case k.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,i,o,a),e.materialTransparent.submitDraw(this,i,o,a);break;case k.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,i,o,a),function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(_.D.Highlight))}(t)&&e.highlightIntegratedMesh.submitDraw(this,i,o,a)}var u=this.componentParameters.castShadows!==M.None;u&&e.shadowMap.submitDraw(this,i,o,a),null!=s&&(e.highlight.submitDraw(this,i,s,a),u&&e.highlightShadowMap.submitDraw(this,i,s,a)),t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,i,o,a),u&&null!=l&&e.defaultShadowMap.submitDraw(this,i,l,a)}}},{key:"_computeWhichMaterialPass",value:function(){return this.isIntegratedMesh?k.IntegratedMesh:this.objectOpacity<1?k.Transparent:this.componentParameters.opaqueOverride===M.All?k.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===L.JJ.Blend||this.alphaDiscardMode===L.JJ.MaskBlend?k.Transparent:this.componentParameters.transparent===M.None?k.Opaque:this.componentParameters.transparent===M.All?k.Transparent:k.OpaqueAndTransparent}}]),n}(C);(0,s._)([T({vectorOps:f.v})],H.prototype,"baseColor",void 0),(0,s._)([T()],H.prototype,"usePBR",void 0),(0,s._)([T()],H.prototype,"hasParametersFromSource",void 0),(0,s._)([T({vectorOps:h.I})],H.prototype,"mrrFactors",void 0),(0,s._)([T({vectorOps:h.I})],H.prototype,"emissiveFactor",void 0),(0,s._)([T({dispose:!0})],H.prototype,"baseColorTexture",void 0),(0,s._)([T({dispose:!0})],H.prototype,"metallicRoughnessTexture",void 0),(0,s._)([T({dispose:!0})],H.prototype,"emissionTexture",void 0),(0,s._)([T({dispose:!0})],H.prototype,"occlusionTexture",void 0),(0,s._)([T({dispose:!0})],H.prototype,"normalTexture",void 0),(0,s._)([T()],H.prototype,"objectOpacity",void 0),(0,s._)([S()],H.prototype,"commonMaterialParameters",void 0),(0,s._)([S()],H.prototype,"componentParameters",void 0),(0,s._)([T()],H.prototype,"textureAlphaCutoff",void 0),(0,s._)([T()],H.prototype,"alphaDiscardMode",void 0),(0,s._)([T()],H.prototype,"isIntegratedMesh",void 0),(0,s._)([T()],H.prototype,"polygonOffsetEnabled",void 0),(0,s._)([T()],H.prototype,"ellipsoidMode",void 0),(0,s._)([T()],H.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(k||(k={}));var F=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).doubleSided=!1,e.cullFace=L.Vr.Back,e.hasSlicePlane=!0,e}return(0,r.Z)(n)}(x);(0,s._)([T()],F.prototype,"doubleSided",void 0),(0,s._)([T()],F.prototype,"cullFace",void 0),(0,s._)([T()],F.prototype,"hasSlicePlane",void 0);var V=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).externalColor=(0,v.al)(1,1,1,1),e.externalColorMixMode=p.a9.Multiply,e.castShadows=M.All,e}return(0,r.Z)(n,[{key:"transparent",get:function(){return this.externalColor[3]<1?M.All:M.None}},{key:"opaqueOverride",get:function(){return this.externalColorMixMode===p.a9.Replace&&1===this.externalColor[3]?M.All:M.None}},{key:"visible",get:function(){return this.externalColor[3]>0?M.All:M.None}},{key:"type",get:function(){return y._N.Uniform}}]),n}(x);(0,s._)([T({vectorOps:f.v})],V.prototype,"externalColor",void 0),(0,s._)([T()],V.prototype,"externalColorMixMode",void 0),(0,s._)([T()],V.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(M||(M={}));var z=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).texture=null,e.transparent=M.None,e.opaqueOverride=M.None,e.castShadows=M.None,e}return(0,r.Z)(n,[{key:"type",get:function(){return y._N.Varying}}]),n}(x);(0,s._)([T()],z.prototype,"texture",void 0),(0,s._)([T()],z.prototype,"transparent",void 0),(0,s._)([T()],z.prototype,"opaqueOverride",void 0),(0,s._)([T()],z.prototype,"castShadows",void 0)},9028:function(e,t,n){n.d(t,{V:function(){return C},h:function(){return w}});var i=n(15671),r=n(43144),a=n(60136),o=n(29388),s=n(50951),l=n(7564),u=n(34659),c=n(37081),h=n(82144),d=n(31132),f=n(68401),v=n(78041),p=n(27627),_=n(50411),m=n(25920),g=n(4760),y=n(8548),b=n(36207),w=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,r.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.spherical=e.viewingMode===s.JY.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}},{key:"initializeProgram",value:function(e){return new p.$(e.rctx,n.shader.get().build(this.configuration),C)}},{key:"_setPipelineState",value:function(e){var t=this.configuration,n=t.integratedMeshMode!==l.O.None,i=e===m.A.NONE,r=e===m.A.FrontFace;return(0,b.sm)({blending:t.output===c.H_.Color&&t.blendingEnabled?i?v.wu:(0,v.j7)(e):null,culling:(0,b.zp)(t.cullFace),depthTest:{func:(0,v.Bh)(e)},depthWrite:i||r?b.LZ:null,drawBuffers:t.output===c.H_.Depth?{buffers:[y.Xg.NONE]}:(0,v.V7)(e),colorWrite:b.BK,stencilWrite:n||t.hasOccludees?_.s3:null,stencilTest:n?(0,_.ec)(f.hU.IntegratedMeshMaskExcluded):t.hasOccludees?_.RY:null,polygonOffset:i||r?t.hasPolygonOffset?{factor:2,units:2}:null:v.E0})}},{key:"initializePipeline",value:function(){return this._setPipelineState(this.configuration.transparencyPassType)}}]),n}(d.A);w.shader=new h.J(u.C,(function(){return n.e(86940).then(n.bind(n,86940))}));var C=new Map([[g.T.POSITION,0],[g.T.NORMAL,1],[g.T.NORMALCOMPRESSED,1],[g.T.COLOR,2],[g.T.UV0,3],[g.T.UVREGION,4],[g.T.COMPONENTINDEX,5]])},7564:function(e,t,n){n.d(t,{O:function(){return i},_:function(){return w}});var i,r=n(43144),a=n(15671),o=n(60136),s=n(29388),l=n(27366),u=n(37107),c=n(91871),h=n(37081),d=n(16010),f=n(60113),v=n(96658),p=n(41481),_=n(86097),m=n(99340),g=n(33559),y=n(68401),b=n(25920);!function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(i||(i={}));var w=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).output=h.H_.Color,e.textureCoordinateType=f.N.None,e.componentData=u._N.Uniform,e.cullFace=y.Vr.Back,e.vertexDiscardMode=c.a.None,e.doubleSidedMode=v.q.WindingOrder,e.alphaDiscardMode=y.JJ.Opaque,e.integratedMeshMode=i.None,e.transparencyPassType=b.A.NONE,e.ellipsoidMode=_.U.Earth,e.pbrMode=p.f7.Disabled,e.normalType=d.r.Attribute,e.spherical=!1,e.doublePrecisionRequiresObfuscation=!1,e.hasVertexColors=!1,e.hasNormals=!1,e.hasSlicePlane=!1,e.hasColorTexture=!1,e.receiveAmbientOcclusion=!0,e.receiveShadows=!0,e.blendingEnabled=!0,e.hasScreenSpaceReflections=!1,e.hasPolygonOffset=!1,e.hasMetallicRoughnessTexture=!1,e.hasEmissionTexture=!1,e.hasOcclusionTexture=!1,e.hasNormalTexture=!1,e.hasOccludees=!1,e.multipassEnabled=!1,e.cullAboveGround=!1,e.hasNormalTextureTransform=!1,e.hasCloudsReflections=!0,e.snowCover=!1,e.objectAndLayerIdColor=!1,e}return(0,r.Z)(n)}(g.m);(0,l._)([(0,g.o)({count:h.H_.COUNT})],w.prototype,"output",void 0),(0,l._)([(0,g.o)({count:f.N.COUNT})],w.prototype,"textureCoordinateType",void 0),(0,l._)([(0,g.o)({count:u._N.COUNT})],w.prototype,"componentData",void 0),(0,l._)([(0,g.o)({count:y.Vr.COUNT})],w.prototype,"cullFace",void 0),(0,l._)([(0,g.o)({count:c.a.COUNT})],w.prototype,"vertexDiscardMode",void 0),(0,l._)([(0,g.o)({count:v.q.COUNT})],w.prototype,"doubleSidedMode",void 0),(0,l._)([(0,g.o)({count:y.JJ.COUNT})],w.prototype,"alphaDiscardMode",void 0),(0,l._)([(0,g.o)({count:i.COUNT})],w.prototype,"integratedMeshMode",void 0),(0,l._)([(0,g.o)({count:b.A.COUNT})],w.prototype,"transparencyPassType",void 0),(0,l._)([(0,g.o)({count:_.U.COUNT})],w.prototype,"ellipsoidMode",void 0),(0,l._)([(0,g.o)({count:p.f7.COUNT})],w.prototype,"pbrMode",void 0),(0,l._)([(0,g.o)({count:d.r.COUNT})],w.prototype,"normalType",void 0),(0,l._)([(0,g.o)()],w.prototype,"spherical",void 0),(0,l._)([(0,g.o)()],w.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasVertexColors",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasNormals",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasSlicePlane",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasColorTexture",void 0),(0,l._)([(0,g.o)()],w.prototype,"receiveAmbientOcclusion",void 0),(0,l._)([(0,g.o)()],w.prototype,"receiveShadows",void 0),(0,l._)([(0,g.o)()],w.prototype,"blendingEnabled",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasScreenSpaceReflections",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasPolygonOffset",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasMetallicRoughnessTexture",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasEmissionTexture",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasOcclusionTexture",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasNormalTexture",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasOccludees",void 0),(0,l._)([(0,g.o)()],w.prototype,"multipassEnabled",void 0),(0,l._)([(0,g.o)()],w.prototype,"cullAboveGround",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasNormalTextureTransform",void 0),(0,l._)([(0,g.o)()],w.prototype,"hasCloudsReflections",void 0),(0,l._)([(0,g.o)()],w.prototype,"snowCover",void 0),(0,l._)([(0,g.o)()],w.prototype,"objectAndLayerIdColor",void 0),(0,l._)([(0,g.o)({constValue:!1})],w.prototype,"occlusionPass",void 0),(0,l._)([(0,g.o)({constValue:m.P.Draw})],w.prototype,"pbrTextureBindType",void 0),(0,l._)([(0,g.o)({constValue:!0})],w.prototype,"hasSliceHighlight",void 0),(0,l._)([(0,g.o)({constValue:!1})],w.prototype,"hasSliceInVertexProgram",void 0),(0,l._)([(0,g.o)({constValue:!1})],w.prototype,"useCustomDTRExponentForWater",void 0),(0,l._)([(0,g.o)({constValue:!1})],w.prototype,"hasVertexTangents",void 0),(0,l._)([(0,g.o)({constValue:!0})],w.prototype,"supportsTextureAtlas",void 0),(0,l._)([(0,g.o)({constValue:!1})],w.prototype,"highStepCount",void 0),(0,l._)([(0,g.o)({constValue:!1})],w.prototype,"instancedDoublePrecision",void 0),(0,l._)([(0,g.o)({constValue:!1})],w.prototype,"hasModelTransformation",void 0),(0,l._)([(0,g.o)({constValue:!0})],w.prototype,"useFillLights",void 0),(0,l._)([(0,g.o)({constValue:!1})],w.prototype,"objectAndLayerIdColorInstanced",void 0)},91871:function(e,t,n){n.d(t,{a:function(){return s},z:function(){return h}});var i,r,a,o,s,l=n(30168),u=n(41644),c=n(98634);function h(e,t){var n=e.vertex;switch(n.code.add((0,c.H)(i||(i=(0,l.Z)(["#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)"])))),t.vertexDiscardMode){case s.None:n.code.add((0,c.H)(r||(r=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) {}"]))));break;case s.Opaque:n.code.add((0,c.H)(a||(a=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))));break;case s.Transparent:n.code.add((0,c.H)(o||(o=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))));break;case s.COUNT:break;default:(0,u.Bg)(t.vertexDiscardMode)}}!function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(s||(s={}))},92911:function(e,t,n){n.d(t,{N:function(){return o}});var i=n(55158),r=n(60113),a=n(4760);function o(e){var t=(0,i.U$)().vec3f(a.T.POSITION);return e.hasNormals&&t.vec2i16(a.T.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===r.N.Default?t.vec2f(a.T.UV0):e.textureCoordinates===r.N.Atlas&&(t.vec2f(a.T.UV0),t.vec4u16(a.T.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(a.T.COLOR,{glNormalized:!0}),t}},75831:function(e,t,n){n.d(t,{R:function(){return l}});var i,r=n(30168),a=n(54943),o=n(96415),s=n(98634);function l(e){var t=e.fragment;e.include(o.GZ),t.include(a.K),t.code.add((0,s.H)(i||(i=(0,r.Z)(["vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {\nivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));\nfloat leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);\nfloat rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);\nfloat bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);\nfloat topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);\nbool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);\nbool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);\nvec3 fragCoordHorizontal = pickLeft\n? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)\n: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);\nvec3 fragCoordVertical = pickBottom\n? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)\n: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);\nvec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);\nvec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);\nvec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));\nreturn pickLeft == pickBottom ? normal : -normal;\n}"]))))}},97397:function(e,t,n){n.d(t,{M:function(){return l}});var i,r,a,o=n(30168),s=n(98634);function l(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add((0,s.H)(i||(i=(0,o.Z)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))):e.vertex.code.add((0,s.H)(r||(r=(0,o.Z)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = vec3(1.0, 0.0, 0.0);\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))),e.fragment.code.add((0,s.H)(a||(a=(0,o.Z)(["mat3 getTBNMatrix(vec3 n) {\nreturn mat3(tbnTangent, tbnBiTangent, n);\n}"]))))}},35600:function(e,t,n){var i;n.d(t,{MV:function(){return a},iM:function(){return i},pU:function(){return r}}),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(i||(i={}));var r={normal:i.Normal,average:i.Average,lighten:i.Lighten,lighter:i.Lighter,screen:i.Screen,plus:i.Plus,"color-dodge":i.ColorDodge,darken:i.Darken,multiply:i.Multiply,"color-burn":i.ColorBurn,overlay:i.Overlay,"soft-light":i.SoftLight,"hard-light":i.HardLight,"vivid-light":i.VividLight,hue:i.Hue,saturation:i.Saturation,luminosity:i.Luminosity,color:i.Color,difference:i.Difference,exclusion:i.Exclusion,minus:i.Minus,invert:i.Invert,reflect:i.Reflect,"destination-over":i.DestinationOver,"destination-atop":i.DestinationAtop,"destination-in":i.DestinationIn,"destination-out":i.DestinationOut,"source-atop":i.SourceAtop,"source-in":i.SourceIn,"source-out":i.SourceOut,xor:i.Xor};function a(e){return e===i.DestinationOver||e===i.DestinationAtop||e===i.DestinationIn||e===i.DestinationOut||e===i.SourceAtop||e===i.SourceIn||e===i.SourceOut||e===i.Xor}},54786:function(e,t,n){n.d(t,{i:function(){return l}});var i,r=n(30168),a=n(58406),o=n(98634),s=n(19253);function l(e){e.fragment.uniforms.add(new s.A("u_colormap",(function(e){return e.u_colormap})),new a.p("u_colormapOffset",(function(e){return e.colormap.u_colormapOffset})),new a.p("u_colormapMaxIndex",(function(e){return e.colormap.u_colormapMaxIndex})),new a.p("u_opacity",(function(e){return e.common.u_opacity}))),e.fragment.code.add((0,o.H)(i||(i=(0,r.Z)(["vec4 colormap(vec4 currentPixel, bool isFloat) {\nfloat colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;\nvec4 result;\nif (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {\nresult = vec4(0.0, 0.0, 0.0, 0.0);\n} else {\nvec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);\nresult = texelFetch(u_colormap, ivec2(texelCoordinates), 0);\n}\nreturn result;\n}"]))))}},9386:function(e,t,n){n.d(t,{G:function(){return y},J:function(){return g}});var i,r=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(29388),u=n(82999),c=n(98634),h=n(19253);function d(e){e.fragment.uniforms.add(new h.A("u_transformGrid",(function(e){return e.u_transformGrid})),new u.A("u_transformSpacing",(function(e){return e.common.u_transformSpacing})),new u.A("u_targetImageSize",(function(e){return e.common.u_targetImageSize}))),e.fragment.code.add((0,c.H)(i||(i=(0,r.Z)(["vec2 projectPixelLocation(vec2 coords) {\nvec2 index_image = floor(coords * u_targetImageSize);\nvec2 oneTransformPixel = vec2(4.0, 1.0);\nvec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;\nvec2 pos = fract((index_image + 0.5) / u_transformSpacing);\nvec2 transform_location = index_transform + 0.5;\nvec2 srcLocation;\nif (pos.s <= pos.t) {\nvec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;\nvec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;\nsrcLocation.s = dot(ll_abc, vec3(pos, 1.0));\nsrcLocation.t = dot(ll_def, vec3(pos, 1.0));\n} else {\nvec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;\nvec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;\nsrcLocation.s = dot(ur_abc, vec3(pos, 1.0));\nsrcLocation.t = dot(ur_def, vec3(pos, 1.0));\n}\nreturn srcLocation;\n}"]))))}var f,v,p,_=n(32426),m=n(13773),g=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this)).common=e,a.u_image=i,a.u_transformGrid=r,a}return(0,a.Z)(n)}(_.R);function y(e,t){e.include(d),e.fragment.uniforms.add(new h.A("u_image",(function(e){return e.u_image})),new m.U("u_flipY",(function(e){return e.common.u_flipY})),new m.U("u_applyTransform",(function(e){return e.common.u_applyTransform})));var n=t.requireBilinearWithNN;n&&e.fragment.uniforms.add(new u.A("u_srcImageSize",(function(e){return e.common.u_srcImageSize}))),e.fragment.code.add((0,c.H)(f||(f=(0,r.Z)(["vec2 getPixelLocation(vec2 coords) {\nvec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;\nif (!u_applyTransform) {\nreturn targetLocation;\n}\nreturn projectPixelLocation(targetLocation);\n}\nbool isOutside(vec2 coords){\nif (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {\nreturn true;\n} else {\nreturn false;\n}\n}"])))),n?e.fragment.code.add((0,c.H)(v||(v=(0,r.Z)(["vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {\nvec2 texelStart = floor(coords * texSize);\nvec2 coord0 = texelStart / texSize;\nvec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;\nvec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;\nvec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;\nvec4 color0 = texture(sampler, coord0);\nvec4 color1 = texture(sampler, coord1);\nvec4 color2 = texture(sampler, coord2);\nvec4 color3 = texture(sampler, coord3);\nvec2 blend = fract(coords * texSize);\nvec4 color01 = mix(color0, color1, blend.x);\nvec4 color23 = mix(color2, color3, blend.x);\nvec4 color = mix(color01, color23, blend.y);\nfloat alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);\ncolor = color * alpha + (1.0 - alpha) * texture(sampler, coords);\nreturn color;\n}\nvec4 getPixel(vec2 pixelLocation) {\nreturn sampleBilinear(u_image, pixelLocation, u_srcImageSize);\n}"])))):e.fragment.code.add((0,c.H)(p||(p=(0,r.Z)(["vec4 getPixel(vec2 pixelLocation) {\nreturn texture(u_image, pixelLocation);\n}"]))))}},98864:function(e,t,n){n.d(t,{P:function(){return d}});var i,r,a,o=n(30168),s=n(48655),l=n(71033),u=n(20395),c=n(22035),h=n(98634);function d(e,t){e.include(s.c,t),e.fragment.include(l.y);var n=e.fragment;n.uniforms.add(new u.$("baseColor",(function(e){return e.baseColor}))),n.uniforms.add(new c.p("objectOpacity",(function(e){return e.objectOpacity}))),t.hasVertexColors?n.code.add((0,h.H)(i||(i=(0,o.Z)(["vec3 _baseColor() {\nreturn baseColor.rgb * vColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a * vColor.a;\n}"])))):n.code.add((0,h.H)(r||(r=(0,o.Z)(["vec3 _baseColor() {\nreturn baseColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a;\n}"])))),n.code.add((0,h.H)(a||(a=(0,o.Z)(["vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {\nvec3 baseColor = _baseColor();\nfloat baseOpacity = _baseOpacity();\nvec3 color = mixExternalColor(\nbaseColor,\ntextureColor.rgb,\nexternalColor.rgb,\nexternalColorMixMode\n);\nfloat opacity = objectOpacity * mixExternalOpacity(\nbaseOpacity,\ntextureColor.a,\nexternalColor.a,\nexternalColorMixMode\n);\nreturn vec4(color, opacity);\n}"]))))}},48051:function(e,t,n){n.d(t,{B:function(){return g}});var i,r,a,o,s,l,u,c,h=n(30168),d=n(41644),f=n(16010),v=n(85380),p=n(74058),_=n(96658),m=n(98634);function g(e,t){var n=e.fragment;switch(t.doubleSidedMode){case _.q.None:n.code.add((0,m.H)(i||(i=(0,h.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn normal;\n}"]))));break;case _.q.View:e.include(p.up,t),n.code.add((0,m.H)(r||(r=(0,h.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;\n}"]))));break;case _.q.WindingOrder:n.code.add((0,m.H)(a||(a=(0,h.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;default:(0,d.Bg)(t.doubleSidedMode);case _.q.COUNT:}switch(t.normalType){case f.r.Attribute:case f.r.Compressed:e.include(v.Bb,t),n.code.add((0,m.H)(o||(o=(0,h.Z)(["vec3 shadingNormalWorld() {\nreturn _adjustDoublesided(normalize(vNormalWorld));\n}\nvec3 shadingNormal_view() {\nvec3 normal = normalize(vNormalView);\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;case f.r.ScreenDerivative:e.include(p.up,t),n.code.add((0,m.H)(s||(s=(0,h.Z)(["vec3 shadingNormalWorld() {\nreturn normalize(cross(\ndFdx(vPositionWorldCameraRelative),\ndFdy(vPositionWorldCameraRelative)\n));\n}\nvec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));\n}"]))));break;case f.r.Ground:t.spherical?(e.include(p.up,t),n.code.add((0,m.H)(l||(l=(0,h.Z)(["vec3 shadingNormalWorld() {\nreturn normalize(positionWorld());\n}"]))))):n.code.add((0,m.H)(u||(u=(0,h.Z)(["vec3 shadingNormalWorld() {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),n.code.add((0,m.H)(c||(c=(0,h.Z)(["vec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;\n}"]))));break;default:(0,d.Bg)(t.normalType);case f.r.COUNT:}}},51612:function(e,t,n){n.d(t,{s:function(){return v}});var i,r,a,o=n(30168),s=n(37081),l=n(60113),u=n(51520),c=n(27193),h=n(98634),d=n(78050),f=n(68401);function v(e,t){var n=e.fragment;if(!t.hasColorTexture||t.output!==s.H_.Color&&t.alphaDiscardMode===f.JJ.Opaque)n.code.add((0,h.H)(a||(a=(0,o.Z)(["vec4 readBaseColorTexture() { return vec4(1.0); }"]))));else{e.include(u.i,t);var v=t.textureCoordinateType===l.N.Atlas;n.uniforms.add(new d.R("baseColorTexture",(function(e){return e.texture}))),v?(e.include(c.r),n.code.add((0,h.H)(i||(i=(0,o.Z)(["vec4 readBaseColorTexture() {\nreturn textureAtlasLookup(baseColorTexture, vuv0, vuvRegion);\n}"]))))):n.code.add((0,h.H)(r||(r=(0,o.Z)(["vec4 readBaseColorTexture() {\nreturn texture(baseColorTexture, vuv0);\n}"]))))}}},91835:function(e,t,n){n.d(t,{H:function(){return o}});var i,r=n(30168),a=n(98634);function o(e){e.code.add((0,a.H)(i||(i=(0,r.Z)(["\n    float lineFactorAtPosition(float value) {\n      float pos = value * ",";\n      if(pos < 0.5 || pos > ",") {\n        return 1.0;\n      }\n\n      pos = pos + 0.5;\n      float modulo = mod(pos, 16.0);\n      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;\n    }\n\n    float lineFactorAtUV(vec2 uv) {\n      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));\n    }\n\n    float lineFactor(vec2 uv) {\n      vec2 offset = fwidth(uv) * 0.25;\n      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;\n    }\n\n    vec3 gridColor(vec2 uv) {\n      float line = lineFactor(uv) * 0.1 + 0.9;\n      return vec3(1.0, 0.972, 0.918) * line;\n    }"])),a.H.float(257),a.H.float(256.5)))}},57017:function(e,t,n){var i;n.d(t,{I:function(){return i}}),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(i||(i={}))},8966:function(e,t,n){var i;n.d(t,{l:function(){return i}}),function(e){e[e.Composite=0]="Composite",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.GroupBackgroundComposite=3]="GroupBackgroundComposite",e[e.COUNT=4]="COUNT"}(i||(i={}))},25012:function(e,t,n){var i;n.d(t,{m:function(){return i}}),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(i||(i={}))},28288:function(e,t,n){n.d(t,{EK:function(){return T},uS:function(){return x}});var i,r,a,o,s,l,u,c,h,d,f=n(30168),v=n(43144),p=n(15671),_=n(60136),m=n(29388),g=n(93511),y=n(91835),b=n(55375),w=n(98634),C=n(61809),x=function(e){(0,_.Z)(n,e);var t=(0,m.Z)(n);function n(){var e;return(0,p.Z)(this,n),(e=t.apply(this,arguments)).overlayOpacity=1,e}return(0,v.Z)(n)}(g.nj);function T(e,t){var n=e.vertex,v=e.fragment,p=e.varyings;p.add("vtc","vec2"),n.uniforms.add(new M("texOffsetAndScale")),v.uniforms.add(new P("tex")),v.uniforms.add(new k("textureOpacities"));var _=t.textureFadingEnabled&&!t.renderOccluded;_&&(n.uniforms.add(new M("nextTexOffsetAndScale")),p.add("nvtc","vec2"),v.uniforms.add(new P("texNext")),v.uniforms.add(new k("nextTexOpacities")),v.uniforms.add(new S("fadeFactor")));var m=t.tileBlendInput===b.R.ColorComposite,g=t.tileBlendInput===b.R.GridComposite;g&&v.include(y.H),m&&v.uniforms.add(new k("backgroundColor")),n.code.add((0,w.H)(i||(i=(0,f.Z)(["\n  void forwardTextureCoordinatesWithTransform(in vec2 uv) {\n    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;\n    ","\n  }"])),_?(0,w.H)(r||(r=(0,f.Z)(["nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;"]))):(0,w.H)(a||(a=(0,f.Z)([""]))))),v.code.add((0,w.H)(o||(o=(0,f.Z)(["\n    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {\n      ","\n    }"])),g||m?(0,w.H)(s||(s=(0,f.Z)(["\n              if (opacities.y <= 0.0) {\n                return color * opacities.z * opacities.x;\n              }\n              vec4 bg = vec4("," * opacities.y, opacities.y);\n              vec4 layer = color * opacities.z;\n              return (bg * (1.0 - layer.a) + layer) * opacities.x;"])),m?(0,w.H)(l||(l=(0,f.Z)(["backgroundColor"]))):(0,w.H)(u||(u=(0,f.Z)(["gridColor(uv)"])))):(0,w.H)(c||(c=(0,f.Z)(["return color;"]))))),_?v.code.add((0,w.H)(h||(h=(0,f.Z)(["vec4 getTileColor() {\nvec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);\nif (fadeFactor >= 1.0) {\nreturn color;\n}\nvec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);\nreturn mix(nextColor, color, fadeFactor);\n}"])))):v.code.add((0,w.H)(d||(d=(0,f.Z)(["vec4 getTileColor() {\nreturn getColor(texture(tex, vtc), vtc, textureOpacities);\n}"]))))}var S=function(e){(0,_.Z)(n,e);var t=(0,m.Z)(n);function n(e){return(0,p.Z)(this,n),t.call(this,e,"float")}return(0,v.Z)(n)}(C.x),k=function(e){(0,_.Z)(n,e);var t=(0,m.Z)(n);function n(e){return(0,p.Z)(this,n),t.call(this,e,"vec3")}return(0,v.Z)(n)}(C.x),M=function(e){(0,_.Z)(n,e);var t=(0,m.Z)(n);function n(e){return(0,p.Z)(this,n),t.call(this,e,"vec4")}return(0,v.Z)(n)}(C.x),P=function(e){(0,_.Z)(n,e);var t=(0,m.Z)(n);function n(e){return(0,p.Z)(this,n),t.call(this,e,"sampler2D")}return(0,v.Z)(n)}(C.x)},63434:function(e,t,n){n.d(t,{J:function(){return _e}});var i,r,a,o,s,l,u,c,h,d,f,v,p,_,m,g,y,b,w,C,x,T,S,k,M,P,R,E,O,A,D,Z,I,L,N,U,H,F,V,z,q,B=n(30168),G=n(43144),j=n(15671),W=n(60136),X=n(29388),Q=n(12400),Y=n(35600),J=n(91835),K=n(57017),$=n(8966),ee=n(25012),te=n(98634);function ne(e,t){var n=t.blendMode;n!==Y.iM.Normal&&(n===Y.iM.Reflect&&e.code.add((0,te.H)(i||(i=(0,B.Z)(["float reflectBlend(in float cb, in float cl) {\nreturn (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);\n}"])))),n!==Y.iM.ColorDodge&&n!==Y.iM.VividLight||e.code.add((0,te.H)(r||(r=(0,B.Z)(["float colorDodge(in float cb, in float cl) {\nreturn (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));\n}"])))),n!==Y.iM.ColorBurn&&n!==Y.iM.VividLight||e.code.add((0,te.H)(a||(a=(0,B.Z)(["float colorBurn(in float cb, in float cl) {\nreturn (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);\n}"])))),n===Y.iM.Overlay&&e.code.add((0,te.H)(o||(o=(0,B.Z)(["float overlay(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);\n}"])))),n===Y.iM.HardLight&&e.code.add((0,te.H)(s||(s=(0,B.Z)(["float hardLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));\n}"])))),n===Y.iM.SoftLight&&e.code.add((0,te.H)(l||(l=(0,B.Z)(["float softLight(in float cb, in float cl) {\nif (cl <= 0.5) {\nreturn cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);\n}\nif (cb <= 0.25) {\nreturn cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);\n}\nreturn cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);\n}"])))),n===Y.iM.VividLight&&e.code.add((0,te.H)(u||(u=(0,B.Z)(["float vividLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));\n}"])))),n!==Y.iM.Hue&&n!==Y.iM.Saturation&&n!==Y.iM.Color&&n!==Y.iM.Luminosity||(e.code.add((0,te.H)(c||(c=(0,B.Z)(["float minv3(in vec3 c) {\nreturn min(min(c.r, c.g), c.b);\n}\nfloat maxv3(in vec3 c) {\nreturn max(max(c.r, c.g), c.b);\n}\nfloat lumv3(in vec3 c) {\nreturn dot(c, vec3(0.3, 0.59, 0.11));\n}\nvec3 clipColor(vec3 color) {\nfloat lum = lumv3(color);\nfloat mincol = minv3(color);\nfloat maxcol = maxv3(color);\nif (mincol < 0.0) {\ncolor = lum + ((color - lum) * lum) / (lum - mincol);\n}\nif (maxcol > 1.0) {\ncolor = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);\n}\nreturn color;\n}\nvec3 setLum(vec3 cbase, vec3 clum) {\nreturn clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));\n}"])))),n!==Y.iM.Hue&&n!==Y.iM.Saturation||e.code.add((0,te.H)(h||(h=(0,B.Z)(["float satv3(vec3 c) {\nreturn maxv3(c) - minv3(c);\n}\nvec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)\n{\nfloat minbase = minv3(cbase);\nfloat sbase = satv3(cbase);\nfloat ssat = satv3(csat);\nreturn setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);\n}"]))))),e.code.add((0,te.H)(d||(d=(0,B.Z)(["\n    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {\n      ","\n    }\n  "])),n===Y.iM.Multiply?(0,te.H)(f||(f=(0,B.Z)(["return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Average?(0,te.H)(v||(v=(0,B.Z)(["return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Lighten?(0,te.H)(p||(p=(0,B.Z)(["return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Darken?(0,te.H)(_||(_=(0,B.Z)(["return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Lighter?(0,te.H)(m||(m=(0,B.Z)(["return vec4(cl * ol + cb * ob, ol + ob);"]))):n===Y.iM.Plus?(0,te.H)(g||(g=(0,B.Z)(["return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);"]))):n===Y.iM.Minus?(0,te.H)(y||(y=(0,B.Z)(["return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);"]))):n===Y.iM.Screen?(0,te.H)(b||(b=(0,B.Z)(["return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Difference?(0,te.H)(w||(w=(0,B.Z)(["return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Invert?(0,te.H)(C||(C=(0,B.Z)(["return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);"]))):n===Y.iM.DestinationOver?(0,te.H)(x||(x=(0,B.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);"]))):n===Y.iM.DestinationAtop?(0,te.H)(T||(T=(0,B.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);"]))):n===Y.iM.DestinationOut?(0,te.H)(S||(S=(0,B.Z)(["return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));"]))):n===Y.iM.SourceAtop?(0,te.H)(k||(k=(0,B.Z)(["return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);"]))):n===Y.iM.SourceOut?(0,te.H)(M||(M=(0,B.Z)(["return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));"]))):n===Y.iM.Xor?(0,te.H)(P||(P=(0,B.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));"]))):n===Y.iM.DestinationIn?(0,te.H)(R||(R=(0,B.Z)(["return vec4(cb * ob * ol, ol * ob);"]))):n===Y.iM.SourceIn?(0,te.H)(E||(E=(0,B.Z)(["return vec4(cl * ol * ob, ol * ob);"]))):n===Y.iM.Hue?(0,te.H)(O||(O=(0,B.Z)(["\n          vec3 f = setLumSat(cl, cb, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Saturation?(0,te.H)(A||(A=(0,B.Z)(["\n          vec3 f = setLumSat(cb, cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Color?(0,te.H)(D||(D=(0,B.Z)(["\n          vec3 f = setLum(cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Luminosity?(0,te.H)(Z||(Z=(0,B.Z)(["\n          vec3 f = setLum(cb, cl);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Exclusion?(0,te.H)(I||(I=(0,B.Z)(["\n          vec3 f = cl + cb - 2.0 * cl * cb;\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Reflect?(0,te.H)(L||(L=(0,B.Z)(["\n          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.ColorDodge?(0,te.H)(N||(N=(0,B.Z)(["\n          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.ColorBurn?(0,te.H)(U||(U=(0,B.Z)(["\n          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.Overlay?(0,te.H)(H||(H=(0,B.Z)(["\n          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.SoftLight?(0,te.H)(F||(F=(0,B.Z)(["\n          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.HardLight?(0,te.H)(V||(V=(0,B.Z)(["\n          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Y.iM.VividLight?(0,te.H)(z||(z=(0,B.Z)(["\n          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):(0,te.H)(q||(q=(0,B.Z)([""]))))))}var ie,re,ae,oe,se,le,ue,ce,he,de,fe=n(49450),ve=n(58406),pe=n(19253);te.K;function _e(e,t){var n=t.output===$.l.GridComposite,i=t.output===$.l.ColorComposite,r=t.output===$.l.GroupBackgroundComposite,a=t.output===$.l.Composite,o=t.baseOpacityMode===K.I.Required,s=e.fragment;o&&s.uniforms.add(new ve.p("baseOpacity",(function(e){return e.baseOpacity}))),n?s.include(J.H):i?s.uniforms.add(new fe.J("backgroundColor",(function(e){return e.backgroundColor}))):a&&s.uniforms.add(new pe.A("fboColor",(function(e){return e.fboTexture})));var l=t.blendMode!==Y.iM.Normal,u=t.premultipliedSource===ee.m.On,c=!l&&!u&&(a&&!o||r);s.include(ne,t),s.code.add((0,te.H)(ie||(ie=(0,B.Z)(["\n    vec4 getBackground(vec2 uv) {\n      return "," ",";\n    }\n\n    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {\n      ","\n    }"])),o?(0,te.H)(re||(re=(0,B.Z)(["baseOpacity *"]))):"",r?(0,te.H)(ae||(ae=(0,B.Z)(["vec4(0.0, 0.0, 0.0, 0.0)"]))):i?(0,te.H)(oe||(oe=(0,B.Z)(["vec4(backgroundColor, 1.0)"]))):n?(0,te.H)(se||(se=(0,B.Z)(["vec4(gridColor(uv), 1.0)"]))):(0,te.H)(le||(le=(0,B.Z)(["texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)"]))),l?(0,te.H)(ue||(ue=(0,B.Z)(["\n          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;\n          vec4 bgColor = getBackground(bgUV);\n          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;\n          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);"]))):(0,te.H)(ce||(ce=(0,B.Z)(["\n          float composeAlpha = colorLayer.a * opacity;\n          ",""])),c?(0,te.H)(he||(he=(0,B.Z)(["return colorLayer * opacity;"]))):(0,te.H)(de||(de=(0,B.Z)(["\n            vec4 bgColor = getBackground(bgUV);\n            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;"]))))))}},55375:function(e,t,n){var i;n.d(t,{R:function(){return i}}),function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(i||(i={}))},32426:function(e,t,n){n.d(t,{R:function(){return v},T:function(){return p}});var i,r=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(29388),u=n(6644),c=n(82999),h=n(58406),d=n(98634),f=n(4760),v=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).scale=1,e.offset=u.AG,e}return(0,a.Z)(n)}(d.K);function p(e){e.attributes.add(f.T.POSITION,"vec2"),e.attributes.add(f.T.UV0,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new h.p("scale",(function(e){return e.scale})),new c.A("offset",(function(e){return e.offset}))).code.add((0,d.H)(i||(i=(0,r.Z)(["void main(void) {\ngl_Position = vec4(position, 0.0, 1.0);\nuv = uv0 * scale + offset;\nvuv = uv0;\n}"]))))}},86097:function(e,t,n){n.d(t,{U:function(){return i},j:function(){return a}});var i,r=n(92975);function a(e){return e&&(0,r.BZ)(e)?i.Mars:e&&(0,r.V2)(e)?i.Moon:i.Earth}!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(i||(i={}))},76284:function(e,t,n){n.d(t,{C:function(){return _},c:function(){return p}});var i,r=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(29388),u=n(29134),c=n(7025),h=n(12400),d=n(96415),f=n(98634),v=n(8654),p=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).localOrigin=(0,h.ll)(),e}return(0,a.Z)(n)}(f.K);function _(e){e.include(d.GZ),e.fragment.uniforms.add(new v.g("inverseViewMatrix",(function(e,t){var n=(0,c.Ue)();return(0,u.Iu)(n,t.camera.viewMatrix,e.localOrigin),(0,u.iS)(n,n)}))),e.fragment.code.add((0,f.H)(i||(i=(0,r.Z)(["vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {\nvec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);\nreturn inverseViewMatrix * cameraSpace;\n}"]))))}},75104:function(e,t,n){n.d(t,{I:function(){return l}});var i=n(15671),r=n(43144),a=n(32035),o=n(93311),s=n(12400),l=function(){function e(t){(0,i.Z)(this,e),this._low=(0,s.Ue)(),this._high=(0,s.Ue)(),t&&this.set(t)}return(0,r.Z)(e,[{key:"low",get:function(){return this._low}},{key:"high",get:function(){return this._high}},{key:"set",value:function(e){(0,a.c)(this._low,(0,a.c)(u,e));var t=(0,a.z)(u,e,this._low);(0,a.c)(this._high,t)}},{key:"get",value:function(e){return(0,a.g)(e,this._low,this._high)}},{key:"getLowScaled",value:function(e){return(0,a.j)(e,this._low,1)}}]),e}(),u=(0,o.Ue)()},53641:function(e,t,n){n.d(t,{Bn:function(){return s},QI:function(){return o}});var i=n(4760),r=n(8548),a=n(61109),o=(new a.G(i.T.POSITION,3,r.g.FLOAT,0,12),[new a.G(i.T.POSITION,2,r.g.FLOAT,0,8)]),s=[new a.G(i.T.POSITION,2,r.g.FLOAT,0,16),new a.G(i.T.UV0,2,r.g.FLOAT,8,16)]},2263:function(e,t,n){n.d(t,{Y:function(){return i},n:function(){return s}});var i,r=n(93169),a=n(59447),o=n(75248);function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!(0,r.Z)("disable-feature:high-quality-idle"),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=new a.r;return e?(n.set(o.n.IDLE,i.Antialiasing,"low"!==t),n.set(o.n.IDLE,i.HighResolutionAtmosphere,"low"!==t),n.set(o.n.IDLE,i.HighQualityTransparency,!0),n.set(o.n.IDLE,i.SSAO,!0),n.set(o.n.IDLE,i.WaterReflection,!0),n.set(o.n.IDLE,i.PhysicalPixelRendering,!0)):(n.set(o.n.ANIMATING,i.HighResolutionShadows,!0),n.set(o.n.ANIMATING,i.HighResolutionViewshed,!0),n.set(o.n.INTERACTING,i.HighResolutionShadows,!0),n.set(o.n.INTERACTING,i.HighResolutionViewshed,!0)),n.set(o.n.IDLE,i.HighResolutionShadows,!0),n.set(o.n.IDLE,i.HighResolutionViewshed,!0),n.set(o.n.IDLE,i.HighResolutionVoxel,!0),n}!function(e){e[e.Antialiasing=0]="Antialiasing",e[e.HighQualityTransparency=1]="HighQualityTransparency",e[e.HighResolutionVoxel=2]="HighResolutionVoxel",e[e.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",e[e.SSAO=4]="SSAO",e[e.WaterReflection=5]="WaterReflection",e[e.HighResolutionShadows=6]="HighResolutionShadows",e[e.HighResolutionViewshed=7]="HighResolutionViewshed",e[e.PhysicalPixelRendering=8]="PhysicalPixelRendering"}(i||(i={}))},99905:function(e,t,n){n.d(t,{g:function(){return v}});var i=n(37762),r=n(15671),a=n(43144),o=function(){function e(t){(0,r.Z)(this,e),this._maxCount=t,this._nextIndex=0,this._recycledIndices=[]}return(0,a.Z)(e,[{key:"activeCount",get:function(){return this._nextIndex-this._recycledIndices.length}},{key:"availableCount",get:function(){return this._recycledIndices.length+this._maxCount-this._nextIndex}},{key:"acquire",value:function(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}},{key:"release",value:function(e){this._recycledIndices.push(e)}}]),e}(),s=n(25158),l=n(8548),u=n(57808),c=n(52311),h=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,r.Z)(this,e),this._rctx=t,this._fieldCount=n,this.textureWidth=4096,this._dirty=!0;var i=new c.X(this.textureWidth,1);i.samplingMode=l.cw.NEAREST,i.wrapMode=l.e8.CLAMP_TO_EDGE,this._texture=new u.x(this._rctx,i),this._data=new s.mc(new ArrayBuffer(4*this.textureWidth))}return(0,a.Z)(e,[{key:"dispose",value:function(){this._texture.dispose(),this._texture=void 0,this._data=void 0}},{key:"setData",value:function(e,t,n,i,r,a){var o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,n),this._data.set(o,1,i),this._data.set(o,2,r),this._data.set(o,3,a)}},{key:"setDataElement",value:function(e,t,n,i){var r=e*this._fieldCount+t;this._dirty=!0,this._data.set(r,n,i)}},{key:"getDataElement",value:function(e,t,n){var i=e*this._fieldCount+t;return this._dirty=!0,this._data.get(i,n)}},{key:"resizeToFit",value:function(e){var t=(e+1)*this._fieldCount;if(t>this._data.count){var n=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new s.mc(new ArrayBuffer(4*n));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}},{key:"updateTexture",value:function(){if(this._dirty){var e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}}},{key:"texture",get:function(){return this._texture}}]),e}(),d=65536,f=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,r.Z)(this,e),this.textureBuffer=new h(t,n),this._indexManager=new o(d)}return(0,a.Z)(e,[{key:"dispose",value:function(){this.textureBuffer.dispose(),this.textureBuffer=void 0}},{key:"availableCount",get:function(){return this._indexManager.availableCount}},{key:"activeCount",get:function(){return this._indexManager.activeCount}},{key:"acquireIndex",value:function(){var e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}},{key:"releaseIndex",value:function(e){this._indexManager.release(e)}}]),e}(),v=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,r.Z)(this,e),this._rctx=t,this._fieldCount=n,this._buffers=[]}return(0,a.Z)(e,[{key:"garbageCollect",value:function(){this._buffers=this._buffers.filter((function(e){return 0!==e.activeCount||(e.dispose(),!1)}))}},{key:"destroy",value:function(){this._buffers.forEach((function(e){return e.dispose()})),this._buffers=[]}},{key:"getBuffer",value:function(e){var t,n=(0,i.Z)(this._buffers);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.availableCount>=e)return r}}catch(o){n.e(o)}finally{n.f()}if(e>d)return null;var a=new f(this._rctx,this._fieldCount);return this._buffers.push(a),a}},{key:"updateTextures",value:function(){var e,t=(0,i.Z)(this._buffers);try{for(t.s();!(e=t.n()).done;){e.value.textureBuffer.updateTexture()}}catch(n){t.e(n)}finally{t.f()}}}]),e}()},58206:function(e,t,n){n.d(t,{U:function(){return B}});var i=n(93433),r=n(37762),a=n(15671),o=n(43144),s=n(60136),l=n(29388),u=n(27366),c=n(80987),h=n(16889),d=n(92026),f=n(94172),v=n(49861),p=n(93169),_=(n(32718),n(84936),n(69912)),m=n(29134),g=n(7025),y=n(32035),b=n(12400),w=n(37081),C=n(70374),x=n(93822),T=n(18020),S=n(32251),k=n(86361),M=n(81296),P=n(97731),R=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).sectionAngles=(0,k.Ue)(),e}return(0,o.Z)(n,[{key:"sectionAnglesDeg",get:function(){return(0,k.nI)(this.sectionAngles.map((function(e){return(0,h.BV)(e)})))},set:function(e){this.sectionAngles=(0,k.nI)(e.map((function(e){return(0,h.Vl)(e)})))}},{key:"projectionMatrix",get:function(){var e=(0,g.Ue)();return(0,m.dC)(e,this.sectionMatrix,this._projectionMatrixInternal)}},{key:"sectionMatrix",get:function(){var e=this.sectionAngles[0],t=this.sectionAngles[1],n=this.sectionAngles[2],i=this.sectionAngles[3];(0,P.hu)(e<=t),(0,P.hu)(n<=i);var r=2*Math.tan(this.fovX/2),a=2*Math.tan(this.fovY/2),o=Math.tan(e),s=Math.tan(t),l=Math.tan(n),u=s-o,c=Math.tan(i)-l,h=r/u,d=a/c,f=-(o+u/2)/r*2,v=-(l+c/2)/a*2,p=(0,g.Ue)();(0,m.vc)(p,[f,v,0]);var _=(0,g.Ue)();(0,m.xJ)(_,[h,d,1]);var y=(0,g.Ue)();return(0,m.dC)(y,_,p)}},{key:"_sectionRatioX",get:function(){var e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),n=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/n)}},{key:"setViewport",value:function(e,t){var n=t*this._sectionRatioX;return this.viewport=[e[0],e[1],n,t],n}}]),n}(M.Z);(0,u._)([(0,v.Cb)()],R.prototype,"sectionAngles",void 0),(0,u._)([(0,v.Cb)()],R.prototype,"sectionAnglesDeg",null),(0,u._)([(0,v.Cb)()],R.prototype,"projectionMatrix",null),(0,u._)([(0,v.Cb)()],R.prototype,"sectionMatrix",null),(0,u._)([(0,v.Cb)()],R.prototype,"_sectionRatioX",null),R=(0,u._)([(0,_.j)("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],R);var E=n(8548),O=function(){function e(){(0,a.Z)(this,e),this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}return(0,o.Z)(e,[{key:"textureSizeModifier",value:function(e){return e?this.textureSizeModHighQuality:this.textureSizeModLowQuality}},{key:"textureResizeModulo",value:function(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}]),e}(),A=["front","left","right","back","top","bottom"];var D=function(){function e(t){(0,a.Z)(this,e),this._fbos=t,this._enabled=!1,this._faces={},this._textureWidth=0,this._textureHeight=0,this.settings=new O,this._maxTextureWidth=Math.min((0,p.Z)("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}return(0,o.Z)(e,[{key:"depthTexture",get:function(){var e;return null===(e=this._handle)||void 0===e?void 0:e.getTexture()}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e||this.disposeOffscreenBuffers()}},{key:"isTextureZero",get:function(){return 0===this._textureWidth||0===this._textureHeight}},{key:"nearFar",get:function(){var e=this.faces;return 0===e.length?null:e[0].nearFar}},{key:"numActiveFaces",get:function(){var e=this._faces,t=0;return Object.keys(e).forEach((function(n){e[n]&&(t+=1)})),t}},{key:"faces",get:function(){for(var e=this._faces,t=[],n=0,i=A;n<i.length;n++){var r=e[i[n]];r&&t.push(r)}return t}},{key:"atlasRegions",get:function(){var e=this;return this.faces.map((function(t){return[t.x/e._textureWidth,(t.x+t.width)/e._textureWidth,t.y/e._textureHeight,(t.y+t.height)/e._textureHeight]}))}},{key:"viewshedProjectionMatrices",get:function(){return this.faces.map((function(e){return e.projectionMatrix}))}},{key:"viewshedViewMatrices",get:function(){return this.faces.map((function(e){return e.viewMatrix}))}},{key:"_setupFaceCamera",value:function(e,t,n,i){var r=t.observerRenderSpace,a=t.tiltedUpVector,o=t.targetRenderSpace,s=t.farDistanceRenderSpace,l=t.horizontalFieldOfView,u=t.verticalFieldOfView,c=(0,b.Ue)();(0,y.z)(c,o,r);var d,f=(0,b.Ue)(),v=(0,b.Ue)(),p=function(e,t){var n=(0,b.Ue)(),i=(0,g.Ue)();return(0,m.Us)(i,e,t),(0,y.h)(n,c,i),(0,y.g)(n,r,n),n},_=a,w=Math.min(90,l),C=Math.min(90,Math.max(0,(l-90)/2)),x=-45,T=45,S=-45,k=45;if(function(e){return!["top","bottom"].includes(e)}(e)){var M=function(e){return(0,h.uZ)(e,-45,45)};S=M(-u/2)-this.settings.toleranceBottomTop,k=M(+u/2)+this.settings.toleranceBottomTop}switch(e){case"front":d=o,x=-w/2,T=w/2;break;case"left":d=p(Math.PI/2,a),x=45-C;break;case"right":d=p(-Math.PI/2,a),T=-45+C;break;case"top":d=(0,y.g)(f,r,a),_=(0,y.k)(v,c);break;case"bottom":d=(0,y.z)(f,r,a),_=c;break;case"back":d=p(Math.PI,a)}var P=new R({center:d,eye:r,up:_,far:s});P.sectionAnglesDeg=[x-this.settings.toleranceSides,T+this.settings.toleranceSides,S,k],P.fovY=Math.PI/2;var E=P.setViewport(n,i);return this._faces[e]=P,E}},{key:"_bindFBO",value:function(){var e,t=this._fbos.rctx;t.unbindTexture(this.depthTexture),t.bindFramebuffer(null===(e=this._handle)||void 0===e?void 0:e.fbo)}},{key:"_computeActiveFaces",value:function(e){var t=new Set,n=e.horizontalFieldOfView,i=e.verticalFieldOfView,r=-i/2,a=i/2;return 0===n||0===i||(r<=45&&a>=-45&&t.add("front"),n>90&&(t.add("left"),t.add("right")),n>270&&t.add("back"),a>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}},{key:"_computeBaseTextureSize",value:function(e,t,n,i){var r=Math.min(window.devicePixelRatio,t)/e.pixelRatio,a=this.settings.textureSizeModifier(n),o=(0,S.nq)(Math.floor(Math.max(e.fullWidth,e.fullHeight)*r*a)),s=Math.floor(this._maxTextureWidth/i),l=Math.min(s,o);return(0,S.pf)(l)}},{key:"_ensureFBO",value:function(){var e,t,n,i,r,a=this._textureWidth,o=this._textureHeight;(null===(e=this._handle)||void 0===e||null===(t=e.fbo)||void 0===t?void 0:t.width)===a&&(null===(n=this._handle)||void 0===n||null===(i=n.fbo)||void 0===i?void 0:i.height)===o||(null!==(r=this._handle)&&void 0!==r&&r.release(),this._handle=this._fbos.acquire(a,o,"viewshed shadow map",T.q.RGBA4)),this._handle.acquireDepth(T.m.DEPTH16_BUFFER)}},{key:"clearFBO",value:function(){var e=this._fbos.rctx;this._ensureFBO(),this._bindFBO(),e.setClearColor(1,1,1,1),e.clear(E.lk.COLOR_BUFFER_BIT|E.lk.DEPTH_BUFFER_BIT)}},{key:"dispose",value:function(){this.enabled=!1,this.disposeOffscreenBuffers()}},{key:"disposeOffscreenBuffers",value:function(){this._handle=(0,d.RY)(this._handle)}},{key:"start",value:function(e,t,n,i){var r=this;if(this._faces={},!this.enabled)return!1;var a=this._computeActiveFaces(t),o=a.size;if(0===o)return!1;var s=this._computeBaseTextureSize(e,i,n,o);if(0===s)return!1;var l=0,u=0,c=0;return A.filter((function(e){return a.has(e)})).forEach((function(e){var n=function(e,t){if(t<4)return 0;var n="front"===e||"left"===e;return 4===t?n?0:1:n||"right"===e?0:1}(e,o);n>u&&(c=Math.max(c,l),l=0),u=n;var i=n*s;l+=r._setupFaceCamera(e,t,[l,i],s)})),c=Math.max(c,l),this._textureWidth=this.settings.textureResizeModulo(c),this._textureHeight=function(e){return e<4?1:2}(o)*s,this.clearFBO(),!0}},{key:"finish",value:function(){var e;null===(e=this._handle)||void 0===e||e.detachDepth()}},{key:"test",get:function(){return{faces:this._faces,faceTypes:A}}}]),e}();var Z=n(95720),I=n(82144),L=n(31132),N=n(7566),U=n(78041),H=n(27627),F=n(36207),V=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){return(0,a.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"initializeProgram",value:function(e){return new H.$(e.rctx,n.shader.get().build(this.configuration),N.i)}},{key:"initializePipeline",value:function(){return(0,F.sm)({colorWrite:F.BK,blending:U.wu})}}]),n}(L.A);V.shader=new I.J(Z.a,(function(){return n.e(20191).then(n.bind(n,20191))}));var z=n(33559),q=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).useNormalMap=!0,e}return(0,o.Z)(n)}(z.m);(0,u._)([(0,z.o)()],q.prototype,"useNormalMap",void 0);var B=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,i){var r;return(0,a.Z)(this,n),(r=t.call(this,e))._pluginContext=null,r.renderHighQuality=!1,r._parameters=new Z.V,r._configuration=new q,r._viewsheds=new c.Z,r.produces=new Map([[x.r.VIEWSHED,function(){return!0}]]),r._renderShadowMap=i,r}return(0,o.Z)(n,[{key:"viewshedShadowMap",get:function(){return this._viewshedShadowMap}},{key:"enabled",get:function(){return this._viewsheds.length>0}},{key:"initialize",value:function(){var e=this;this.addHandles((0,f.watch)((function(){return e.view.qualitySettings.maximumPixelRatio}),(function(t){return e._maximumPixelRatio=t}),f.syncAndInitial))}},{key:"destroy",value:function(){this.uninitializeRenderContext()}},{key:"consumes",value:function(){return this.enabled?C.of:C.jt}},{key:"initializeRenderContext",value:function(e){this._pluginContext=e,this._viewshedShadowMap=new D(this.fboCache),this._viewshedShadowMap.enabled=!0}},{key:"renderNode",value:function(e,t,n){var i,a,o,s=e.bindParameters,l=e.rctx;if(this.enabled&&s.depth&&null!=n){var u=this._setupNormals(n);if(null!=this._technique&&this._configuration.useNormalMap===u||(this._configuration.useNormalMap=u,this._technique=null===(i=this._pluginContext)||void 0===i?void 0:i.techniques.acquire(V,this._configuration)),null!==(a=this._technique)&&void 0!==a&&a.compiled){var c,h=(0,r.Z)(this._viewsheds);try{for(h.s();!(c=h.n()).done;){var d=c.value,f=e.rctx.getBoundFramebufferObject(),v=this._renderViewshedShadowCubeMap(s,d),p=this._viewshedShadowMap;v&&null!=p.depthTexture&&!p.isTextureZero&&(this._setPassParameters(d),e.rctx.bindFramebuffer(f),l.bindTechnique(this._technique,s,this._parameters),l.screen.draw())}}catch(_){h.e(_)}finally{h.f()}}else null===(o=this._pluginContext)||void 0===o||o.requestRender()}}},{key:"uninitializeRenderContext",value:function(){this._pluginContext=null,this._viewshedShadowMap.dispose(),this._technique=(0,d.SC)(this._technique)}},{key:"updateViewsheds",value:function(e){var t=this,n=e.removes;null!=n&&(c.Z.isCollection(n)?this._viewsheds.removeMany(n):this._viewsheds.remove(n));var i=e.adds;if(null!=i)if(c.Z.isCollection(i)){var r=i.filter((function(e){return!t._viewsheds.includes(e)}));this._viewsheds.addMany(r)}else this._viewsheds.includes(i)||this._viewsheds.add(i)}},{key:"_renderViewshedShadowCubeMap",value:function(e,t){var n=this._viewshedShadowMap;if(!n.enabled)return!1;var i=n.start(e.camera,t,this.renderHighQuality,this._maximumPixelRatio);if(i){var a,o=(0,r.Z)(n.faces);try{for(o.s();!(a=o.n()).done;){var s=a.value;this._renderShadowMap(e,s,w.H_.ViewshedShadow)}}catch(l){o.e(l)}finally{o.f()}}return n.finish(),i}},{key:"_setPassParameters",value:function(e){var t=this._parameters,n=this._viewshedShadowMap,r=e.observerRenderSpace;t.localOrigin=r,t.fovs=[(0,h.Vl)(e.horizontalFieldOfView),(0,h.Vl)(e.verticalFieldOfView)],t.headingAndTilt=[(0,h.Vl)(e.heading),(0,h.Vl)(e.tiltParallelToSurface)],t.upVector=e.tiltedUpVector;var a=function(e,t){var n=(0,b.Ue)();return(0,y.z)(n,e,t)}(e.targetRenderSpace,r);t.targetVector=a,t.shadowMap=n;for(var o=[],s=[],l=0;l<n.numActiveFaces;l++)(0,m.Iu)(j,n.viewshedViewMatrices[l],r),o.push.apply(o,(0,i.Z)(j.flat())),G(n.viewshedProjectionMatrices[l],j,W),s.push.apply(s,(0,i.Z)(W.flat()));t.viewMatrices=o,t.projectionMatrices=s}},{key:"_setupNormals",value:function(e){var t=e.get("normals"),n=null===t||void 0===t?void 0:t.getTexture();return this._parameters.normalTexture=n,null!=n}},{key:"test",get:function(){return{viewsheds:this._viewsheds}}}]),n}(C.tY);function G(e,t,n){var i=(0,b.al)(.5,.5,.5);return(0,m.vc)(n,i),(0,m.bA)(n,n,i),(0,m.dC)(n,n,e),(0,m.dC)(n,n,t),n}(0,u._)([(0,v.Cb)()],B.prototype,"_pluginContext",void 0),(0,u._)([(0,v.Cb)()],B.prototype,"fboCache",void 0),(0,u._)([(0,v.Cb)()],B.prototype,"view",void 0),(0,u._)([(0,v.Cb)()],B.prototype,"viewshedShadowMap",null),B=(0,u._)([(0,_.j)("esri.views.3d.webgl-engine.lib.Viewshed")],B);var j=(0,g.Ue)(),W=(0,g.Ue)()},67009:function(e,t,n){n.d(t,{Hr:function(){return c},dG:function(){return u},dx:function(){return l},rD:function(){return s},so:function(){return h},tf:function(){return o}});var i=n(50256),r=n(55158),a=n(4760),o=(0,r.U$)().vec3f(a.T.POSITION).u16(a.T.COMPONENTINDEX).freeze(),s=(0,r.U$)().vec2u8(a.T.SIDENESS).freeze(),l=(0,i.K)(s),u=(0,r.U$)().vec3f(a.T.POSITION0).vec3f(a.T.POSITION1).vec2i16(a.T.NORMALCOMPRESSED).u16(a.T.COMPONENTINDEX).u8(a.T.VARIANTOFFSET,{glNormalized:!0}).u8(a.T.VARIANTSTROKE).u8(a.T.VARIANTEXTENSION,{glNormalized:!0}).freeze(),c=(0,r.U$)().vec3f(a.T.POSITION0).vec3f(a.T.POSITION1).vec2i16(a.T.NORMALCOMPRESSED).vec2i16(a.T.NORMAL2COMPRESSED).u16(a.T.COMPONENTINDEX).u8(a.T.VARIANTOFFSET,{glNormalized:!0}).u8(a.T.VARIANTSTROKE).u8(a.T.VARIANTEXTENSION,{glNormalized:!0}).freeze(),h=new Map([[a.T.POSITION0,0],[a.T.POSITION1,1],[a.T.COMPONENTINDEX,2],[a.T.VARIANTOFFSET,3],[a.T.VARIANTSTROKE,4],[a.T.VARIANTEXTENSION,5],[a.T.NORMALCOMPRESSED,6],[a.T.NORMAL2COMPRESSED,7],[a.T.SIDENESS,8]])},41371:function(e,t,n){n.d(t,{D:function(){return g},q:function(){return y}});var i=n(15671),r=n(43144),a=n(84936),o=n(32035),s=n(12400),l=n(50256),u=n(52920),c=n(67009),h=function(){function e(){(0,i.Z)(this,e)}return(0,r.Z)(e,[{key:"updateSettings",value:function(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?_:p}},{key:"write",value:function(e,t,n){w.seed=this._edgeHashFunction(n);var i=w.getIntRange(0,255),r=w.getIntRange(0,this.settings.variants-1),a=w.getFloat(),o=255*(.5*function(e,t){return Math.pow(Math.abs(e),t)*Math.sign(e)}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7),1.2)+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,i),e.variantStroke.set(t,r),e.variantExtension.set(t,o)}}]),e}(),d=new Float32Array(6),f=new Uint32Array(d.buffer),v=new Uint32Array(1);function p(e){return d[0]=e.position0[0],d[1]=e.position0[1],d[2]=e.position0[2],d[3]=e.position1[0],d[4]=e.position1[1],d[5]=e.position1[2],v[0]=31*(31*(31*(31*(31*(166811+f[0])+f[1])+f[2])+f[3])+f[4])+f[5],v[0]}function _(e){var t=d;t[0]=m(e.position0[0]),t[1]=m(e.position0[1]),t[2]=m(e.position0[2]),t[3]=m(e.position1[0]),t[4]=m(e.position1[1]),t[5]=m(e.position1[2]),v[0]=5381;for(var n=0;n<f.length;n++)v[0]=31*v[0]+f[n];return v[0]}function m(e){return Math.round(1e4*e)/1e4}var g=function(){function e(){(0,i.Z)(this,e),this._commonWriter=new h}return(0,r.Z)(e,[{key:"updateSettings",value:function(e){this._commonWriter.updateSettings(e)}},{key:"allocate",value:function(e){return c.dG.createBuffer(e)}},{key:"write",value:function(e,t,n){this._commonWriter.write(e,t,n),(0,o.g)(b,n.faceNormal0,n.faceNormal1),(0,o.n)(b,b);var i=e.normalCompressed,r=i.typedBuffer,a=i.typedBufferStride;(0,u.hd)(r,t,b[0],b[1],b[2],a)}}]),e}();g.Layout=c.dG,g.glLayout=(0,l.K)(c.dG,1);var y=function(){function e(){(0,i.Z)(this,e),this._commonWriter=new h}return(0,r.Z)(e,[{key:"updateSettings",value:function(e){this._commonWriter.updateSettings(e)}},{key:"allocate",value:function(e){return c.Hr.createBuffer(e)}},{key:"write",value:function(e,t,n){this._commonWriter.write(e,t,n);var i=e.normalCompressed,r=i.typedBuffer,a=i.typedBufferStride;(0,u.hd)(r,t,n.faceNormal0[0],n.faceNormal0[1],n.faceNormal0[2],a);var o=e.normal2Compressed,s=o.typedBuffer,l=o.typedBufferStride;(0,u.hd)(s,t,n.faceNormal1[0],n.faceNormal1[1],n.faceNormal1[2],l)}}]),e}();y.Layout=c.Hr,y.glLayout=(0,l.K)(c.Hr,1);var b=(0,s.Ue)(),w=new a.Z},32666:function(e,t,n){n.d(t,{n:function(){return c}});var i=n(43144),r=n(15671),a=n(16889),o=n(27546),s=n(32035),l=n(12400),u=(0,i.Z)((function e(){(0,r.Z)(this,e),this.position0=(0,l.Ue)(),this.position1=(0,l.Ue)(),this.faceNormal0=(0,l.Ue)(),this.faceNormal1=(0,l.Ue)(),this.componentIndex=0,this.cosAngle=0}));function c(e,t,n){var i=e.vertices.position,r=e.vertices.componentIndex,a=m.position0,o=m.position1,l=m.faceNormal0,u=m.faceNormal1,c=d(e),f=c.edges,p=c.normals,_=f.length/4,g=t.allocate(_),y=0,b=_,w=null===n||void 0===n?void 0:n.allocate(b),C=0,S=0,M=0;v.length=0;for(var P=0;P<_;++P){var R=4*P;i.getVec(f.data[R],a),i.getVec(f.data[R+1],o);var E=v.pushNew();E.index=4*P,E.length=(0,s.p)(a,o)}v.sort((function(e,t){return t.length-e.length}));var O=new Array,A=new Array;v.forAll((function(e){var c=e.length,d=e.index,v=f.data[d],_=f.data[d+1],b=f.data[d+2],P=f.data[d+3],R=-1===P;if(i.getVec(v,a),i.getVec(_,o),R){var E=3*b;(0,s.s)(l,p.data[E],p.data[E+1],p.data[E+2]),(0,s.c)(u,l),m.componentIndex=r.get(v),m.cosAngle=(0,s.m)(l,u)}else{var D=3*b;if((0,s.s)(l,p.data[D],p.data[D+1],p.data[D+2]),D=3*P,(0,s.s)(u,p.data[D],p.data[D+1],p.data[D+2]),m.componentIndex=r.get(v),m.cosAngle=(0,s.m)(l,u),function(e,t){return e.cosAngle>t}(m,T))return;m.cosAngle<-.9999&&(0,s.c)(u,l)}S+=c,M++,R||function(e,t){return e.cosAngle<t}(m,k)?(t.write(g,y++,m),O.push(c)):h(m,x)&&(w&&n&&n.write(w,C++,m),A.push(c))}));var D=new Float32Array(O.reverse()),Z=new Float32Array(A.reverse()),I=w&&n?{instancesData:w.slice(0,C),lodInfo:{lengths:Z}}:void 0;return{regular:{instancesData:g.slice(0,y),lodInfo:{lengths:D}},silhouette:I,averageEdgeLength:S/M}}function h(e,t){var n=(0,a.ZF)(e.cosAngle);return(0,s.E)(y,e.position1,e.position0),n*((0,s.m)((0,s.b)(g,e.faceNormal0,e.faceNormal1),y)>0?-1:1)>t}function d(e){var t=e.faces.length/3,n=e.faces,i=e.neighbors,r=e.vertices.position;p.length=_.length=0;for(var a=0;a<t;a++){var o=3*a,l=i[o],u=i[o+1],c=i[o+2],h=n[o],d=n[o+1],f=n[o+2];r.getVec(h,b),r.getVec(d,w),r.getVec(f,C),(0,s.f)(w,w,b),(0,s.f)(C,C,b),(0,s.b)(b,w,C),(0,s.n)(b,b),_.pushArray(b),(-1===l||h<d)&&(p.push(h),p.push(d),p.push(a),p.push(l)),(-1===u||d<f)&&(p.push(d),p.push(f),p.push(a),p.push(u)),(-1===c||f<h)&&(p.push(f),p.push(h),p.push(a),p.push(c))}return{edges:p,normals:_}}var f=(0,i.Z)((function e(){(0,r.Z)(this,e),this.index=0,this.length=0})),v=new o.Z({allocator:function(e){return e||new f},deallocator:null}),p=new o.Z({deallocator:null}),_=new o.Z({deallocator:null}),m=new u,g=(0,l.Ue)(),y=(0,l.Ue)(),b=(0,l.Ue)(),w=(0,l.Ue)(),C=(0,l.Ue)(),x=(0,a.Vl)(4),T=Math.cos(x),S=(0,a.Vl)(35),k=Math.cos(S)},79762:function(e,t,n){n.d(t,{Kl:function(){return d},n_:function(){return g},kY:function(){return f},Yr:function(){return m}});var i=n(43144),r=n(15671),a=n(35888);function o(e,t,n){for(var i=t/3,r=new Uint32Array(n+1),a=new Uint32Array(n+1),o=function(e,t){e<t?r[e+1]++:a[t+1]++},s=0;s<i;s++){var l=e[3*s],u=e[3*s+1],c=e[3*s+2];o(l,u),o(u,c),o(c,l)}for(var h=0,d=0,f=0;f<n;f++){var v=r[f+1],p=a[f+1];r[f+1]=h,a[f+1]=d,h+=v,d+=p}for(var _=new Uint32Array(6*i),m=r[n],g=function(e,t,n){if(e<t){var i=r[e+1]++;_[2*i]=t,_[2*i+1]=n}else{var o=a[t+1]++;_[2*m+2*o]=e,_[2*m+2*o+1]=n}},y=0;y<i;y++){var b=e[3*y],w=e[3*y+1],C=e[3*y+2];g(b,w,y),g(w,C,y),g(C,b,y)}for(var x=function(e,t){for(var n=2*e,i=t-e,r=1;r<i;r++){for(var a=_[n+2*r],o=_[n+2*r+1],s=r-1;s>=0&&_[n+2*s]>a;s--)_[n+2*s+2]=_[n+2*s],_[n+2*s+3]=_[n+2*s+1];_[n+2*s+2]=a,_[n+2*s+3]=o}},T=0;T<n;T++)x(r[T],r[T+1]),x(m+a[T],m+a[T+1]);for(var S=new Int32Array(3*i),k=function(t,n){return t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1},M=function(e,t){var n=k(e,t);S[3*t+n]=-1},P=function(e,t,n,i){var r=k(e,t);S[3*t+r]=i;var a=k(n,i);S[3*i+a]=t},R=0;R<n;R++){for(var E=r[R],O=r[R+1],A=a[R],D=a[R+1];E<O&&A<D;){var Z=_[2*E],I=_[2*m+2*A];Z===I?(P(R,_[2*E+1],I,_[2*m+2*A+1]),E++,A++):Z<I?(M(R,_[2*E+1]),E++):(M(I,_[2*m+2*A+1]),A++)}for(;E<O;)M(R,_[2*E+1]),E++;for(;A<D;)M(_[2*m+2*A],_[2*m+2*A+1]),A++}return S}var s=n(55158),l=n(4760),u=n(67009),c=n(41371),h=n(32666);function d(e){var t=f(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return p.updateSettings(e.writerSettings),_.updateSettings(e.writerSettings),(0,h.n)(t,p,_)}function f(e,t,n,i){if(t){var r=o(n,i,e.count);return new v(n,i,r,e)}var s=(0,a.d)(e.buffer,e.stride/4,{originalIndices:n,originalIndicesLength:i}),l=o(s.indices,i,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:l,vertices:u.tf.createView(s.buffer)}}var v=(0,i.Z)((function e(t,n,i,a){(0,r.Z)(this,e),this.faces=t,this.facesLength=n,this.neighbors=i,this.vertices=a})),p=new c.D,_=new c.q,m=(0,s.U$)().vec3f(l.T.POSITION0).vec3f(l.T.POSITION1),g=(0,s.U$)().vec3f(l.T.POSITION0).vec3f(l.T.POSITION1).u16(l.T.COMPONENTINDEX)},20684:function(e,t,n){n.d(t,{l:function(){return h},o:function(){return c}});var i=n(7566),r=n(53641),a=n(80658),o=n(44070),s=n(8548),l=n(57808),u=n(52311);function c(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.QI,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.i,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,c=null;return c=t===r.Bn?new Float32Array([l,l,0,0,u,l,1,0,l,u,0,1,u,u,1,1]):new Float32Array([l,l,u,l,l,u,u,u]),new a.U(e,n,{geometry:t},{geometry:o.f.createVertex(e,s.l1.STATIC_DRAW,c)})}function h(e){var t=new u.X(4);return t.samplingMode=s.cw.NEAREST,new l.x(e,t)}},41781:function(e,t,n){n.d(t,{J4:function(){return h},VB:function(){return _},_s:function(){return m},bK:function(){return f},tB:function(){return d}});var i=n(29134),r=n(12400),a=n(41414),o=n(23470),s=n(85312),l=n(43449),u=n(22178),c=n(22255);function h(e,t){var n,i;return(0,u.es)(e)||(0,u.G1)(e)?p(null===(n=e.target)||void 0===n?void 0:n.object,t):(0,l.TX)(e)?null===(i=t.map)||void 0===i?void 0:i.ground:(0,s.a8)(e)||(0,s.GS)(e)||(0,l.j9)(e)||(0,s.A8)(e)?p(e.target,t):null}function d(e,t){var n=f(e,t);return null!=n&&"graphic"===n.type?n.graphic:null}function f(e,t){var n;if(null==e)return null;if((0,u.es)(e)||(0,u.G1)(e))return v(null===(n=e.target)||void 0===n?void 0:n.object,t);if((0,s.a8)(e)){var i=e.target.createGraphic();return{type:"graphic",graphic:i,layer:i.layer}}if((0,s.A8)(e)){var r=e.target.createVoxelGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if((0,s.BF)(e)){var a=e.target.createTiles3DGraphic();return{type:"graphic",graphic:a,layer:a.layer}}return(0,l.j9)(e)||(0,c.w)(e)?v(e.target,t):(0,s.GS)(e)?function(e,t){var n=p(e,t);if(null==n)return null;var i=t.allLayerViews.find((function(e){return e.layer===n}));return i&&!i.suspended&&"getGraphicFromIntersectorTarget"in i?function(e){return null!=e?{type:"graphic",graphic:e,layer:e.layer}:null}(i.getGraphicFromIntersectorTarget(e)):null}(e.target,t):null}function v(e,t){if(null==(null===e||void 0===e?void 0:e.graphicUid))return null;var n=p(e,t);if(null==n)return null;if(n===t.graphics)return null==t.graphicsView||"number"!=typeof e.graphicUid?null:t.graphicsView.getHit(e.graphicUid);var i=t.allLayerViews.find((function(e){return e.layer===n}));return!i||i.suspended||null==e.graphicUid?null:"getHit"in i?i.getHit(e.graphicUid):null}function p(e,t){return null==(null===e||void 0===e?void 0:e.layerUid)?null:null!=t.graphicsView&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.allLayers.find((function(t){return t.uid===e.layerUid}))}function _(e,t){if((0,u.es)(e)||(0,u.G1)(e))return(0,o.b)(e.target.object.boundingVolumeWorldSpace.bounds);if((0,c.w)(e)){(0,i.Q$)(g,e.transformation);var n=Math.max(g[0],g[1],g[2]);return e.target.baseBoundingSphere.radius*n}if((0,s.GS)(e)){var r=function(e,t){var n=p(e,t);if(null==n)return null;var i=t.allLayerViews.find((function(e){return e.layer===n}));return i&&!i.suspended&&"getAABBFromIntersectorTarget"in i?i.getAABBFromIntersectorTarget(e):null}(e.target,t);return r?.5*(0,a.wz)(r):null}return null}function m(e){return!(0,u.es)(e)&&!(0,u.G1)(e)&&((0,c.w)(e)?e.target.numLodLevels>1:!!(0,s.GS)(e))}var g=(0,r.Ue)()},79485:function(e,t,n){n.d(t,{l:function(){return c},w:function(){return i}});var i,r=n(43144),a=n(15671),o=n(60136),s=n(29388),l=n(27366),u=n(33559);!function(e){e[e.Gradient=0]="Gradient",e[e.Threshold=1]="Threshold",e[e.COUNT=2]="COUNT"}(i||(i={}));var c=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).visualization=i.Gradient,e.bandsEnabled=!1,e}return(0,r.Z)(n)}(u.m);(0,l._)([(0,u.o)({count:i.COUNT})],c.prototype,"visualization",void 0),(0,l._)([(0,u.o)()],c.prototype,"bandsEnabled",void 0)},85276:function(e,t,n){n.r(t),n.d(t,{default:function(){return _x}});var i=n(37762),r=n(74165),a=n(15861),o=n(15671),s=n(43144),l=n(97326),u=n(88301),c=n(61120),h=n(60136),d=n(29388),f=n(27366),v=n(63665),p=(n(59486),n(36721)),_=n(80987),m=n(50093),g=n(10064),y=n(98928),b=n(42537),w=n(93169),C=n(32718),x=n(92026),T=n(62314),S=n(66978),k=n(94172),M=n(99346),P=n(17842),R=n(70431),E=n(49861),O=n(89125),A=(n(84936),n(69912)),D=n(25243),Z=n(7138),I=n(25265),L=n(23879);function N(e,t){var n=(0,L.vw)(e),i=(0,L.vw)(t),r=n.store,a=i.store,o=i.metadata;for(var s in o){var l=o[s],u=r.originOf(s),c=a.originOf(s);if(!l.readOnly&&c!==I.s3.DEFAULTS)if(u===I.s3.DEFAULTS)e.set(s,a.get(s));else{var h=r.get(s),d=a.get(s);h&&d&&d instanceof Z.default&&h instanceof Z.default&&h instanceof d.constructor&&N(h,d)}}}var U=n(12400),H=n(68748),F=n(90724),V=n(79803),z=n(77258),q=n(68859),B=n(65156),G=n(82218),j=n(85305),W=n(82582),X=n(37933),Q=n(37319),Y=n(6003),J=n(42047),K=n(60084),$=n(91505),ee=n(78952),te=n(34066),ne=n(8904),ie=n(35535),re=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).demResolution={min:-1,max:-1},i.noDataValue=ie.zl,i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.view.basemapTerrain.on("elevation-change",(function(){return e.emit("changed",{})}))}},{key:"extent",get:function(){var e=this.view.basemapTerrain;if(null==(null===e||void 0===e?void 0:e.extent)||null==e.spatialReference)return null;var t=(0,B.HH)(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}},{key:"spatialReference",get:function(){var e,t;return null!==(e=null===(t=this.view.basemapTerrain)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:ee.Z.WGS84}},{key:"elevationAt",value:function(e,t){var n,i;if(null==this.extent||!(0,te.Kv)(this.extent,e,t)){var r=null!=this.extent?"".concat(this.extent.xmin,", ").concat(this.extent.ymin,", ").concat(this.extent.xmax,", ").concat(this.extent.ymax):null;return C.Z.getLogger(this).warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(r,")")),this.noDataValue}return null!==(n=null===(i=this.view.elevationProvider)||void 0===i?void 0:i.getElevation(e,t,0,this.spatialReference,"ground"))&&void 0!==n?n:this.noDataValue}},{key:"queryElevation",value:function(e){return(0,ne.G$)(e.clone(),this)}}]),n}($.Z.EventedAccessor);(0,f._)([(0,E.Cb)({readOnly:!0})],re.prototype,"demResolution",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],re.prototype,"extent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],re.prototype,"noDataValue",void 0),(0,f._)([(0,E.Cb)()],re.prototype,"spatialReference",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],re.prototype,"view",void 0);var ae=re=(0,f._)([(0,A.j)("esri.views.support.GroundViewElevationSampler")],re),oe=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).view=null,i.layerViews=new _.Z,i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles((0,k.when)((function(){var t,n;return null===(t=e.view)||void 0===t||null===(n=t.map)||void 0===n?void 0:n.ground}),(function(e){return e.load()}))),this.addHandles(this.layerViews.on("after-changes",(function(){return e._layerViewsAfterChangesHandler()})))}},{key:"destroy",value:function(){this._set("view",null);var e,t=(0,i.Z)(this.layerViews);try{for(t.s();!(e=t.n()).done;){e.value.destroy()}}catch(n){t.e(n)}finally{t.f()}this.layerViews.length=0}},{key:"elevationSampler",get:function(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new ae({view:this.view}):null:null}},{key:"extent",get:function(){var e=this.view;return e&&"2d"!==e.type&&e.ready?(0,K.HH)(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}},{key:"updating",get:function(){return!this.suspended&&this.layerViews.some((function(e){return e.updating}))}},{key:"suspended",get:function(){return!this.view||this.view.suspended}},{key:"_layerViewsAfterChangesHandler",value:function(){var e=this;this.removeHandles("updating"),this.addHandles(this.layerViews.map((function(t){return(0,k.watch)((function(){return t.updating}),(function(){return e._updateUpdating()}),k.sync)})).toArray(),"updating"),this._updateUpdating()}},{key:"_updateUpdating",value:function(){this.notifyChange("updating")}}]),n}(Z.default);(0,f._)([(0,E.Cb)({readOnly:!0})],oe.prototype,"elevationSampler",null),(0,f._)([(0,E.Cb)({readOnly:!0})],oe.prototype,"extent",null),(0,f._)([(0,E.Cb)({type:Boolean,readOnly:!0})],oe.prototype,"updating",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],oe.prototype,"view",void 0),(0,f._)([(0,E.Cb)({type:_.Z,readOnly:!0})],oe.prototype,"layerViews",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],oe.prototype,"suspended",null);var se=oe=(0,f._)([(0,A.j)("esri.views.GroundView")],oe),le=n(28435),ue=n(91175),ce=n(9918),he=n(50951),de=function(){return Promise.all([n.e(45320),n.e(58985),n.e(4924)]).then(n.bind(n,31819))},fe=function(){return Promise.all([n.e(45320),n.e(73725)]).then(n.bind(n,73725))},ve={"base-dynamic":function(){return Promise.all([n.e(69229),n.e(11166)]).then(n.bind(n,27304))},"base-elevation":fe,"base-tile":de,"bing-maps":de,"building-scene":function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(44011),n.e(63899),n.e(37829),n.e(59147),n.e(43629),n.e(37791),n.e(48506)]).then(n.bind(n,7452))},catalog:function(){return n.e(57862).then(n.bind(n,57862))},"catalog-dynamic-group":function(){return n.e(10866).then(n.bind(n,10866))},"catalog-footprint":function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(46340)]).then(n.bind(n,46340))},csv:function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(4766)]).then(n.bind(n,4766))},dimension:function(){return n.e(46143).then(n.bind(n,46143))},elevation:fe,feature:function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(41863)]).then(n.bind(n,41863))},geojson:function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(74385)]).then(n.bind(n,74385))},graphics:function(){return Promise.all([n.e(50489),n.e(41170),n.e(80143),n.e(79240)]).then(n.bind(n,79240))},group:function(){return n.e(5407).then(n.bind(n,5407))},imagery:function(){return Promise.all([n.e(69229),n.e(9237)]).then(n.bind(n,11283))},"integrated-mesh":function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(44011),n.e(63899),n.e(37829),n.e(43629),n.e(10983)]).then(n.bind(n,10983))},"integrated-mesh-3dtiles":function(){return n.e(12996).then(n.bind(n,12996))},"line-of-sight":function(){return n.e(31484).then(n.bind(n,31484))},"map-image":function(){return Promise.all([n.e(58985),n.e(69229),n.e(21881),n.e(22175)]).then(n.bind(n,23344))},media:function(){return Promise.all([n.e(99058),n.e(121),n.e(38856),n.e(48521)]).then(n.bind(n,48521))},"ogc-feature":function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(1732)]).then(n.bind(n,1732))},"open-street-map":de,"oriented-imagery":function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(41863)]).then(n.bind(n,41863))},"point-cloud":function(){return Promise.all([n.e(44011),n.e(90172),n.e(51941)]).then(n.bind(n,51941))},voxel:function(){return n.e(9714).then(n.bind(n,9714))},route:function(){return Promise.all([n.e(50489),n.e(72305),n.e(80143),n.e(29417),n.e(62923)]).then(n.bind(n,62923))},scene:function(e){return null==e.profile||"mesh-pyramids"===e.profile?Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(44011),n.e(63899),n.e(37829),n.e(43629),n.e(13826),n.e(37791),n.e(47745)]).then(n.bind(n,47745)):Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(44011),n.e(63899),n.e(37829),n.e(13826),n.e(65225)]).then(n.bind(n,65225))},stream:function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(41170),n.e(39199),n.e(97463),n.e(80142)]).then(n.bind(n,21643))},tile:de,"imagery-tile":function(){return Promise.all([n.e(80394),n.e(45320),n.e(18354)]).then(n.bind(n,18354))},"vector-tile":function(){return Promise.all([n.e(9892),n.e(45320),n.e(30969),n.e(29955),n.e(56130),n.e(40292)]).then(n.bind(n,61368))},wcs:function(){return Promise.all([n.e(80394),n.e(45320),n.e(18354)]).then(n.bind(n,18354))},"web-tile":de,wfs:function(){return Promise.all([n.e(45026),n.e(59008),n.e(27607),n.e(54054),n.e(71486),n.e(14346),n.e(68928),n.e(50489),n.e(36690),n.e(41170),n.e(39199),n.e(48750),n.e(2662)]).then(n.bind(n,2662))},wms:function(){return Promise.all([n.e(69229),n.e(76888),n.e(30629)]).then(n.bind(n,69121))},wmts:function(){return Promise.all([n.e(45320),n.e(15421)]).then(n.bind(n,15421))},"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};var pe,_e,me=function(e){return null!=ve[e.type]},ge=function(e){var t=ve[e.type];if(null==t)throw function(e){var t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",n=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new g.Z("".concat(n,":view-not-supported"),"".concat(t," is not supported in 3D"))}(e);return t(e)},ye=n(14921),be="analyses-owner-handles";!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(pe||(pe={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(_e||(_e={}));var we=function(e){(0,h.Z)(l,e);var t=(0,d.Z)(l);function l(e){var n;return(0,o.Z)(this,l),(n=t.call(this,e))._allAnalysisViews=new _.Z,n._creatingViewCount=0,n._items=new Map,n._scheduledUpdateHandle=null,n._attachedToViewResolver=Ce(),n._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}},n}return(0,s.Z)(l,[{key:"destroy",value:function(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,S.zE)("AnalysisViewManager was destroyed"))}},{key:"attach",value:function(){this._connectOwners(),this._attachedToViewResolver.resolve()}},{key:"detach",value:function(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,S.zE)()),this._attachedToViewResolver=Ce()}},{key:"updating",get:function(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((function(e){return e.updating}))}},{key:"testInfo",get:function(){}},{key:"whenAnalysisView",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._attachedToViewResolver.promise;case 2:if(null!=(n=this._items.get(t))&&n.state.list!==_e.REMOVED){e.next=5;break}throw new g.Z("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});case 5:return e.abrupt("return",n.createAnalysisViewTask.promise);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_connectOwners",value:function(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),be)}},{key:"_disconnectOwners",value:function(){this.removeHandles(be),this._update(),this._creatingViewCount=0}},{key:"_connectAnalysesCollection",value:function(e){var t,n=this,r=(0,i.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;this._addAnalysis(a)}}catch(l){r.e(l)}finally{r.f()}var o=e.on("after-add",(function(e){return n._addAnalysis(e.item)})),s=e.on("after-remove",(function(e){return n._removeAnalysis(e.item)}));return(0,b.kB)((function(){o.remove(),s.remove();var t,r=(0,i.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;n._removeAnalysis(a)}}catch(l){r.e(l)}finally{r.f()}}))}},{key:"_addAnalysis",value:function(e){var t=this,n=this._items.get(e);if(null==n){var i={state:{view:pe.PENDING,list:_e.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=(0,ye.vr)((function(e){return t._createAnalysisViewPromise(i,e)}))}else n.state.list=_e.ADDED}},{key:"_removeAnalysis",value:function(e){var t=this._items.get(e);null!=t?(t.state.list=_e.REMOVED,this._scheduleUpdate()):C.Z.getLogger(this).error("Trying to remove analysis which was not added")}},{key:"_scheduleUpdate",value:function(){var e=this;null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=(0,M.Os)((function(){return e._update()})))}},{key:"_update",value:function(){var e=this;this._scheduledUpdateHandle=(0,x.hw)(this._scheduledUpdateHandle),this._items.forEach((function(t){if(t.state.list===_e.REMOVED)switch(e._items.delete(t.analysis),t.state.view){case pe.PENDING:t.createAnalysisViewTask=(0,x.IM)(t.createAnalysisViewTask);break;case pe.CREATED:null!=t.view&&(e._allAnalysisViews.remove(t.view),t.view=(0,x.SC)(t.view),t.createAnalysisViewTask=null)}}))}},{key:"_createAnalysisViewPromise",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n){var i,a,o,s;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.analysis,a=i.type,o=this._analysisModules[a],this._creatingViewCount+=1,null!=o.module){e.next=11;break}return e.prev=2,e.next=5,this._loadAnalysisModule(a);case 5:o.module=e.sent,e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(2),this._creatingViewCount-=1,e.t0;case 11:if(!(0,S.Hc)(n)){e.next=13;break}throw this._creatingViewCount-=1,(0,S.zE)("AnalysisView creation aborted");case 13:return s=new o.module.default({analysis:i,view:this.view}),e.prev=14,e.next=17,s.when();case 17:e.next=22;break;case 19:throw e.prev=19,e.t1=e.catch(14),this._creatingViewCount-=1,e.t1;case 22:if(!(0,S.Hc)(n)){e.next=24;break}throw this._creatingViewCount-=1,s.destroy(),(0,S.zE)("AnalysisView creation aborted");case 24:return e.abrupt("return",(t.view=s,t.state.view=pe.CREATED,this._allAnalysisViews.add(s),this._creatingViewCount-=1,s));case 25:case"end":return e.stop()}}),e,this,[[2,8],[14,19]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadAnalysisModule",value:function(e){switch(e){case"area-measurement":return Promise.all([n.e(99058),n.e(17877),n.e(121),n.e(95050),n.e(6230),n.e(77)]).then(n.bind(n,59214));case"dimension":return Promise.all([n.e(99058),n.e(17877),n.e(121),n.e(52162),n.e(38856),n.e(96026),n.e(10039),n.e(97411),n.e(29950),n.e(95050),n.e(6230),n.e(89290)]).then(n.bind(n,89290));case"direct-line-measurement":return Promise.all([n.e(99058),n.e(121),n.e(95050),n.e(6230),n.e(61491)]).then(n.bind(n,61491));case"line-of-sight":return Promise.all([n.e(17877),n.e(52162),n.e(96026),n.e(10039),n.e(28050)]).then(n.bind(n,77897));case"slice":return Promise.all([n.e(17877),n.e(52162),n.e(10039),n.e(44011),n.e(59147),n.e(98035),n.e(68796)]).then(n.bind(n,94018));case"viewshed":return Promise.all([n.e(99058),n.e(17877),n.e(52162),n.e(96026),n.e(10039),n.e(97411),n.e(6599),n.e(97433)]).then(n.bind(n,44549))}}}]),l}(Z.default);function Ce(){var e=(0,S.hh)();return e.promise.catch((function(){})),e}(0,f._)([(0,E.Cb)()],we.prototype,"updating",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],we.prototype,"view",void 0),(0,f._)([(0,E.Cb)()],we.prototype,"_allAnalysisViews",void 0),(0,f._)([(0,E.Cb)()],we.prototype,"_creatingViewCount",void 0);var xe=we=(0,f._)([(0,A.j)("esri.views.3d.analysis.AnalysisViewManager3D")],we),Te=n(11582),Se=n(16889),ke=n(22186),Me=n(80064),Pe=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).collision=new Ae,i.distance=1/0,i.minimumPoiDistance=4,i.tilt=null,i}return(0,s.Z)(n,[{key:"altitude",get:function(){return this.mode===he.JY.Local?null:this._get("altitude")||null},set:function(e){this.mode!==he.JY.Local?this._set("altitude",e):C.Z.getLogger(this).warn("Altitude constraint is ignored in local scenes")}},{key:"clampAltitude",value:function(e){return this.altitude?(0,Se.uZ)(e,this.altitude.min,this.altitude.max):e}},{key:"clampTilt",value:function(e,t){if(!this.tilt)return t;var n=this.tilt(e);return(0,Se.uZ)(t,n.min,n.max)}},{key:"clampDistance",value:function(e){return Math.min(e,this.distance)}},{key:"createDefaultTilt",value:function(){return this.mode===he.JY.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}},{key:"createConstantMaxTilt",value:function(e){return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oe;return n.min=Ee.min,n.max=e,n}}},{key:"_createDefaultTiltLocal",value:function(){var e=this.collision.enabled?(0,Me.uV)([[4e3,Ee.max],[1e4,(0,Se.Vl)(88)],[6e6,(0,Se.Vl)(88)]]):function(){return Ee.max};return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oe;return n.min=Ee.min,n.max=e(t),n}}},{key:"_createDefaultTiltGlobal",value:function(){var e=this.collision.enabled?(0,Me.uV)([[4e3,Ee.max],[5e4,(0,Se.Vl)(88)],[6e6,(0,Se.Vl)(88)],[2e7,Ee.min]]):(0,Me.uV)([[3e5,Ee.max],[3e6,(0,Se.Vl)(88)],[6e6,(0,Se.Vl)(88)],[2e7,Ee.min]]);return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oe;return n.min=Ee.min,n.max=e(t),n}}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],Pe.prototype,"altitude",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Pe.prototype,"collision",void 0),(0,f._)([(0,E.Cb)()],Pe.prototype,"distance",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Pe.prototype,"minimumPoiDistance",void 0),(0,f._)([(0,E.Cb)()],Pe.prototype,"tilt",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Pe.prototype,"mode",void 0),Pe=(0,f._)([(0,A.j)("esri.views.3d.state.Constraints")],Pe);var Re=function(e){return{min:-2e5,max:4*e.radius}}(ke.sv),Ee={min:(0,Se.Vl)(.5),max:(0,Se.Vl)(179.5)},Oe={min:0,max:0},Ae=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).enabled=!0,e.elevationMargin=5,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)({type:Boolean})],Ae.prototype,"enabled",void 0),(0,f._)([(0,E.Cb)({type:Number})],Ae.prototype,"elevationMargin",void 0),Ae=(0,f._)([(0,A.j)("esri.views.3d.state.Constraints.CollisionConstraint")],Ae);var De=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).min=Re.min,e.max=Re.max,e}return(0,s.Z)(n)}(Te.j);(0,f._)([(0,E.Cb)({type:Number})],De.prototype,"min",void 0),(0,f._)([(0,E.Cb)({type:Number})],De.prototype,"max",void 0),De=(0,f._)([(0,A.j)("esri.views.3d.constraints.AltitudeConstraint")],De);var Ze=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).mode="auto",e}return(0,s.Z)(n,[{key:"near",get:function(){return this._get("near")},set:function(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}},{key:"castNear",value:function(e){return Math.max(1e-8,e)}},{key:"far",get:function(){return this._get("far")},set:function(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}},{key:"castFar",value:function(e){return Math.max(1e-8,e)}},{key:"autoUpdate",value:function(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}}]),n}(Te.j);(0,f._)([(0,E.Cb)({type:Number,value:1e-8})],Ze.prototype,"near",null),(0,f._)([(0,O.p)("near")],Ze.prototype,"castNear",null),(0,f._)([(0,E.Cb)({type:Number,value:1e-8})],Ze.prototype,"far",null),(0,f._)([(0,O.p)("far")],Ze.prototype,"castFar",null),(0,f._)([(0,E.Cb)({type:["auto","manual"]})],Ze.prototype,"mode",void 0),Ze=(0,f._)([(0,A.j)("esri.views.3d.constraints.ClipDistanceConstraint")],Ze);var Ie={min:(0,Se.BV)(Ee.min),max:(0,Se.BV)(Ee.max)},Le=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).mode="auto",i}return(0,s.Z)(n,[{key:"max",get:function(){return this._get("max")},set:function(e){this._set("max",e),this.mode="manual"}},{key:"castMax",value:function(e){return(0,Se.uZ)(e,Ie.min,Ie.max)}},{key:"autoUpdate",value:function(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}}]),n}(Te.j);(0,f._)([(0,E.Cb)({type:["auto","manual"]})],Le.prototype,"mode",void 0),(0,f._)([(0,E.Cb)({type:Number,value:Ie.max})],Le.prototype,"max",null),(0,f._)([(0,O.p)("max")],Le.prototype,"castMax",null),Le=(0,f._)([(0,A.j)("esri.views.3d.constraints.TiltConstraint")],Le);var Ne=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).tilt=new Le,e.altitude=new De,e.clipDistance=new Ze,e}return(0,s.Z)(n)}(Te.j);(0,f._)([(0,E.Cb)({type:Le})],Ne.prototype,"tilt",void 0),(0,f._)([(0,E.Cb)({type:De})],Ne.prototype,"altitude",void 0),(0,f._)([(0,E.Cb)({type:Ze})],Ne.prototype,"clipDistance",void 0),Ne=(0,f._)([(0,A.j)("esri.views.3d.constraints.Constraints")],Ne);var Ue,He=n(1413),Fe=n(41644),Ve=n(84652),ze=n(13086),qe=n(12040),Be={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:ze.Z,virtual:qe.Z}},Ge=Ue=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"quality",set:function(e){["low","high"].includes(e)&&this._set("quality",e)}},{key:"clone",value:function(){return new Ue({quality:this.quality})}}]),n}(Z.default);(0,f._)([(0,E.Cb)({type:["low","high"],value:"low"})],Ge.prototype,"quality",null),Ge=Ue=(0,f._)([(0,A.j)("esri.views.3d.environment.SceneViewAtmosphere")],Ge);var je,We=n(21147),Xe=n(18814),Qe=n(67808),Ye=je=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).atmosphere=new Ge,i.lighting=i.castLighting(),i.cachedCameraTrackingEnabled=null,i}return(0,s.Z)(n,[{key:"destroy",value:function(){this.atmosphere.destroy()}},{key:"castLighting",value:function(e){return this._convertLightingWithDestroy(e)}},{key:"applyLighting",value:function(e){this.lighting=this._convertLightingWithDestroy(e)}},{key:"_convertLightingWithDestroy",value:function(e){var t=this._convertLighting(e);return t!==e&&this.addHandles((0,b.ed)(t)),t}},{key:"_convertLighting",value:function(e){var t,n;return e?e instanceof ze.Z||e instanceof qe.Z?e:e instanceof Xe.Z?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new ze.Z((0,He.Z)((0,He.Z)({},e.cloneConstructProperties()),null===(t=this.lighting)||void 0===t?void 0:t.cloneNonPersistentConstructProperties())):e instanceof Qe.Z?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new qe.Z((0,He.Z)((0,He.Z)({},e.cloneConstructProperties()),null===(n=this.lighting)||void 0===n?void 0:n.cloneNonPersistentConstructProperties())):(0,D.N7)(Be,e):new ze.Z}},{key:"clone",value:function(){return new je({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Ve.d9)(this.background)})}},{key:"cloneWithWebsceneEnvironment",value:function(e){return new je((0,He.Z)((0,He.Z)({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Ve.d9)(this.background)},e.cloneConstructProperties()),{},{lighting:this._getLighting(e)}))}},{key:"_getLighting",value:function(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):ze.Z.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):qe.Z.fromWebsceneLighting(e.lighting);default:return(0,Fe.Bg)(e.lighting),ze.Z.fromWebsceneLighting(e.lighting)}}}],[{key:"fromWebsceneEnvironment",value:function(e){var t=e.cloneConstructProperties();return new je((0,He.Z)((0,He.Z)({},t),{},{lighting:t.lighting?"virtual"===t.lighting.type?qe.Z.fromWebsceneLighting(t.lighting):ze.Z.fromWebsceneLighting(t.lighting):void 0}))}}]),n}(We.Z);(0,f._)([(0,E.Cb)({type:Ge,json:{read:!1},nonNullable:!0})],Ye.prototype,"atmosphere",void 0),(0,f._)([(0,E.Cb)({nonNullable:!0})],Ye.prototype,"lighting",void 0),(0,f._)([(0,O.p)("lighting")],Ye.prototype,"castLighting",null);var Je,Ke=Ye=je=(0,f._)([(0,A.j)("esri.views.3d.environment.SceneViewEnvironment")],Ye),$e=n(47898),et=n(32035),tt=n(92975),nt=n(83448);!function(e){e[e.Realistic=0]="Realistic",e[e.Local=1]="Local",e[e.Mars=2]="Mars",e[e.None=3]="None"}(Je||(Je={}));var it=n(86950),rt=n(100),at=n(13611),ot=n(19093),st=n(86361),lt=n(5461),ut=n(6644),ct=n(39073),ht=n(98634),dt=n(82144),ft=n(31132),vt=n(7566),pt=n(27627),_t=n(8548),mt=n(36207),gt=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).heightParameters=(0,st.Ue)(),e.radii=(0,ut.Ue)(),e.innerFadeDistance=0,e.altitudeFade=0,e.hazeStrength=1,e.renderScale=(0,ut.Ue)(),e.backgroundColor=(0,U.Ue)(),e}return(0,s.Z)(n)}(ht.K),yt=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return this.configuration.reduced?(0,mt.sm)({blending:(0,mt.if)(_t.zi.ONE,_t.zi.ZERO),depthTest:{func:_t.wb.ALWAYS},colorWrite:mt.BK}):this.configuration.haze?(0,mt.sm)({blending:(0,mt.wK)(_t.zi.ONE,_t.zi.ZERO,_t.zi.ONE_MINUS_SRC_COLOR,_t.zi.ONE),colorWrite:mt.BK}):(0,mt.sm)({blending:(0,mt.if)(_t.zi.SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:_t.wb.LEQUAL},colorWrite:mt.BK})}}]),n}(ft.A);yt.shader=new dt.J(ct.C,(function(){return n.e(40608).then(n.bind(n,40608))}));var bt=n(33559),wt=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).haze=!1,e}return(0,s.Z)(n)}(bt.m);(0,f._)([(0,bt.o)()],wt.prototype,"haze",void 0);var Ct=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).reduced=!1,e}return(0,s.Z)(n)}(wt);(0,f._)([(0,bt.o)()],Ct.prototype,"reduced",void 0);var xt=n(18020),Tt=n(53641),St=n(20684),kt=n(32251),Mt=n(50690),Pt=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return this.configuration.haze?(0,mt.sm)({blending:(0,mt.wK)(_t.zi.ONE,_t.zi.ZERO,_t.zi.ONE_MINUS_SRC_COLOR,_t.zi.ONE),depthTest:{func:_t.wb.ALWAYS},colorWrite:mt.BK}):(0,mt.sm)({blending:(0,mt.if)(_t.zi.SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:_t.wb.ALWAYS},colorWrite:mt.BK})}}]),n}(ft.A);Pt.shader=new dt.J(Mt.a,(function(){return n.e(93074).then(n.bind(n,93074))}));var Rt=n(13910),Et=function(){function e(t,n){var i=this;(0,o.Z)(this,e),this._view=t,this._context=n,this.type=Je.Realistic,this._handles=new rt.Z,this._compositingPassParameters=new Mt.A,this._passParameters=new gt,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=ke.sv.radius,this._fadeHaze=0,this._updateRadius(ke.sv.radius);var r=this._context.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([(0,k.watch)((function(){var e,t;return null===(e=i._view)||void 0===e||null===(t=e.basemapTerrain)||void 0===t?void 0:t.rootTileElevationBounds}),(function(){var e;return null!==(e=i._view)&&void 0!==e&&e.basemapTerrain?i._updateRootTileElevationBounds():null})),(0,k.watch)((function(){var e,t;return null===(e=i._view)||void 0===e||null===(t=e.basemapTerrain)||void 0===t?void 0:t.visibleElevationBounds}),(function(){var e;return null!==(e=i._view)&&void 0!==e&&e.basemapTerrain?i._updateVisibleElevationBounds():null})),(0,k.watch)((function(){var e;return null===(e=i._view)||void 0===e?void 0:e.environment.background}),(function(e){var t=e instanceof Rt.Z?(0,it.O)(e.color):st.AG;(0,et.s)(i._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])}),k.syncAndInitial)]);var a=new Ct;a.haze=!1,this._atmosphereTechnique=this._context.techniques.acquire(yt,a),this._compositingTechnique=this._context.techniques.acquire(Pt,a),a.haze=!0,this._atmosphereHazeTechnique=this._context.techniques.acquire(yt,a),this._compositingHazeTechnique=this._context.techniques.acquire(Pt,a),a.reduced=!0,a.haze=!1,this._atmosphereReducedTechnique=this._context.techniques.acquire(yt,a),a.haze=!0,this._atmosphereHazeReducedTechnique=this._context.techniques.acquire(yt,a),this._vao=(0,St.o)(r,Tt.Bn)}return(0,s.Z)(e,[{key:"destroy",value:function(){this._handles.destroy(),this._compositingTechnique.release(),this._compositingHazeTechnique.release(),this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._atmosphereReducedTechnique.release(),this._atmosphereHazeReducedTechnique.release(),this._vao.dispose()}},{key:"render",value:function(e,t){this._render(e,t?this._atmosphereTechnique:this._atmosphereReducedTechnique,t,!1)}},{key:"renderHaze",value:function(e,t,n){this._fadeHaze=t,this._render(e,n?this._atmosphereHazeTechnique:this._atmosphereHazeReducedTechnique,n,!0)}},{key:"_render",value:function(e,t,n,i){var r=this,a=e.bindParameters.mainDepth;if(a){this._update(e.bindParameters.camera),this._passParameters.depthTexture=a;var o=e.rctx.bindTechnique(t,e.bindParameters,this._passParameters),s=e.offscreenRenderingHelper;if(n)s.renderDepthDetached((function(){return r._renderCommon(o,e)}));else{var l,u=e.rctx.getViewport(),c=(0,et.l)(e.bindParameters.camera.eye)-ke.sv.radius;if(c<lt.k8){var h=Math.min(1,Math.max(0,c/lt.k8));l=i?(0,Se.t7)(.4,.5,h):(0,Se.t7)(.2,.3,h)}else{var d=Math.min(1,Math.max(0,(c-lt.k8)/(15*lt.k8)));l=i?(0,Se.t7)(.5,1,d):(0,Se.t7)(.3,.6,d)}var f=(0,kt.nq)(Math.round(l*e.bindParameters.camera.fullViewport[2])),v=(0,kt.nq)(Math.round(l*e.bindParameters.camera.fullViewport[3]));e.rctx.setViewport(0,0,f,v);var p=s.renderToCachedFBO(null,i?"chapman haze":"chapman",(function(){return r._renderCommon(o,e)}),[0,0,0,1],xt.q.RGBA,null,f,v);e.rctx.setViewport(u.x,u.y,u.width,u.height),this._compositingPassParameters.color=p.getTexture(),this._compositingPassParameters.depth=a;var _=i?this._compositingHazeTechnique:this._compositingTechnique;e.rctx.bindTechnique(_,e.bindParameters,this._compositingPassParameters),s.renderDepthDetached((function(){return e.rctx.screen.draw()})),p.release()}}}},{key:"_renderCommon",value:function(e,t){null!=this._vao&&(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(_t.MX.TRIANGLE_STRIP,0,4))}},{key:"_updateRootTileElevationBounds",value:function(){var e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=ke.sv.radius,this._updateVisibleElevationBounds())}},{key:"_updateVisibleElevationBounds",value:function(){var e=function(e){return e*Math.cos(Math.PI/16/16)}(ke.sv.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}},{key:"_updateRadius",value:function(e){this._lowerBoundEarthRadius=e,(0,at.t8)(this._passParameters.radii,e,e+lt.k8),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-lt.Tk)*lt.Tk)}},{key:"_update",value:function(e){if(e){var t=(0,et.q)(e.eye),n=Math.sqrt(t),i=t-this._passParameters.radii[1]*this._passParameters.radii[1],r=(0,Se.uZ)((n-this._passParameters.radii[0])/lt.k8,0,1);(0,ot.s)(this._passParameters.heightParameters,n,t,i,r),this._passParameters.altitudeFade=(0,lt.yx)(n-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=(0,Se.t7)((0,Se.t7)(.6,1,(0,Se.CW)(9500,10500,n-ke.sv.radius)),1,this._fadeHaze)}}}]),e}();var Ot=n(4685),At=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),i=t.call(this,e,new bt.m,(function(){return i.destroy()}))}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.ONE,_t.zi.ZERO,_t.zi.SRC_ALPHA,_t.zi.ONE),depthTest:{func:_t.wb.LEQUAL},colorWrite:mt.BK})}}]),n}(ft.A);At.shader=new dt.J(Ot.C,(function(){return n.e(43359).then(n.bind(n,43359))}));var Dt=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._technique=new At(e),i._vao=(0,St.o)(e.rctx),i}return(0,s.Z)(n,[{key:"destroy",value:function(){this._technique=(0,x.RY)(this._technique),this._vao=(0,x.M2)(this._vao)}},{key:"render",value:function(e){if(this._technique.compiled){var t=e.bindParameters.cloudsFade;if(null!=this._vao&&null!=t.data){var n=e.rctx.bindTechnique(this._technique,e.bindParameters,Zt);e.rctx.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(_t.MX.TRIANGLE_STRIP,0,4)}}else this.requestRender()}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],Dt.prototype,"rctx",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Dt.prototype,"viewingMode",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Dt.prototype,"planetRadius",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Dt.prototype,"requestRender",void 0),Dt=(0,f._)([(0,A.j)("esri.views.3d.environment.CloudsComposition")],Dt);var Zt=new ht.K,It=n(46208),Lt=n(29303),Nt=n(29134),Ut=n(7025),Ht=n(93311),Ft=n(50703),Vt=n(5573),zt=n(12658),qt=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i){var r;return(0,o.Z)(this,n),r=t.call(this,e,i,(function(){return r.destroy()}))}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.if)(_t.zi.CONSTANT_COLOR,_t.zi.ONE_MINUS_CONSTANT_COLOR,_t.db.ADD,this.configuration.writeTextureChannels===It.uz.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:_t.wb.LEQUAL},colorWrite:mt.BK})}}]),n}(ft.A);qt.shader=new dt.J(Ft.a,(function(){return n.e(78383).then(n.bind(n,78383))}));var Bt=n(20460),Gt=n(50214),jt=n(84819),Wt=n(68820),Xt=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:this.configuration.mode===jt.u.Full?(0,mt.if)(_t.zi.ONE,_t.zi.ZERO):(0,mt.wK)(_t.zi.ZERO,_t.zi.ONE,_t.zi.ONE,_t.zi.ZERO),depthTest:{func:_t.wb.ALWAYS},colorWrite:mt.BK})}}]),n}(ft.A);Xt.shader=new dt.J(Gt.a,(function(){return n.e(52659).then(n.bind(n,52659))}));var Qt=n(53634),Yt=n(52311),Jt=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._needsRender=!0,i._passParameters=new Gt.N,i._fbo=new Qt.X(e.context.renderContext.rctx,new Yt.X(Wt.a5)),i._vao=(0,St.o)(e.context.renderContext.rctx),i}return(0,s.Z)(n,[{key:"_techniques",get:function(){return this.context.techniques}},{key:"textureAtlas",get:function(){return null!=this._texture?null!=this._weatherMapTechnique&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(jt.u.WeatherMap)):null!=this._fullTechnique&&this._fullTechnique.compiled&&(this._texture=this._render(jt.u.Full)),this._texture}},{key:"_setDirty",value:function(){this._needsRender=!0}},{key:"updateWeatherMap",value:function(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||((0,at.JG)(this._passParameters.weatherTile,e),this._setDirty())}},{key:"destroy",value:function(){this._fullTechniqueCached=(0,x.RY)(this._fullTechniqueCached),this._weatherMapTechniqueCached=(0,x.RY)(this._weatherMapTechniqueCached),this._fbo=(0,x.M2)(this._fbo),this._vao=(0,x.M2)(this._vao)}},{key:"_fullTechnique",get:function(){if(null==this._fullTechniqueCached){var e=new jt.i;e.mode=jt.u.Full,this._fullTechniqueCached=this._techniques.acquire(Xt,e)}return this._fullTechniqueCached}},{key:"_weatherMapTechnique",get:function(){if(null==this._weatherMapTechniqueCached){var e=new jt.i;e.mode=jt.u.WeatherMap,this._weatherMapTechniqueCached=this._techniques.acquire(Xt,e)}return this._weatherMapTechniqueCached}},{key:"_render",value:function(e){if(null==this._vao||null==this._fbo)return null;var t=e===jt.u.Full?this._fullTechnique:this._weatherMapTechnique,n=this.context.renderContext.rctx,i=n.getViewport();n.setViewport(0,0,Wt.a5,Wt.a5),n.bindFramebuffer(this._fbo);var r=n.bindTechnique(t,null,this._passParameters);return n.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),n.gl.drawArrays(n.gl.TRIANGLE_STRIP,0,4),n.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],Jt.prototype,"context",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Jt.prototype,"_techniques",null),Jt=(0,f._)([(0,A.j)("esri.views.3d.environment.NoiseTextureAtlas")],Jt);var Kt=n(83377),$t=n(93463),en=n(73553),tn=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._techniques=new Array,i._techniqueConfiguration=new Bt.t,i._bindParameters=new Kt.p(null,null),i._passParameters=new Ft.C,i._weatherTile=(0,ut.Ue)(),i._weatherTileCount=128,i._faceIndex=0,i._tileIndex=0,i.coverage=(0,Se.t7)(zt.L.default.coverage[0],zt.L.default.coverage[1],.5),i.density=(0,Se.t7)(zt.L.default.density[0],zt.L.default.density[1],.5),i.absorption=(0,Se.t7)(zt.L.default.absorption[0],zt.L.default.absorption[1],.5),i.cloudSize=(0,Se.t7)(zt.L.default.cloudSize[0],zt.L.default.cloudSize[1],.5),i.detailSize=(0,Se.t7)(zt.L.default.detailSize[0],zt.L.default.detailSize[1],.5),i.smoothness=(0,Se.t7)(zt.L.default.smoothness[0],zt.L.default.smoothness[1],.5),i.cloudHeight=(0,Se.t7)(zt.L.default.cloudHeight[0],zt.L.default.cloudHeight[1],.5),i.raymarchingSteps=zt.L.default.raymarchingSteps,i._viewMatrix=(0,Ut.Ue)(),i._dirty=!1,i.running=!1,i._vao=(0,St.o)(e.context.renderContext.rctx),i}return(0,s.Z)(n,[{key:"_getTechnique",value:function(e){var t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,n=t===It.uz.RG?2*e:2*e+1;return this._techniques[n]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[n]=new qt({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[n])}},{key:"updateWeatherTile",value:function(){var e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(null!=e&&null!=t){(0,at.t8)(this._weatherTile,(e+90)/180,(t+180)/360);var n=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-n)*this._weatherTile[1]);var i=0,r=0;if(null!=this.view.environment&&"virtual"!==this.view.environment.lighting.type&&null!=this.view.environment.lighting.date){var a,o=new Date(this.view.environment.lighting.date);o.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(null!==(a=this.view.environment.lighting.displayUTCOffset)&&void 0!==a?a:0)),i=31*o.getUTCMonth()+o.getUTCDate(),r=o.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+i)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+r%100)%(4*this._weatherTileCount),(0,at.fS)(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}}},{key:"initialize",value:function(){var e=this,t=(0,nt.Iu)(this.view.spatialReference);this._passParameters.cloudRadius=.5*t.radius,this.setDirty(),this.updateWeatherTile(),this.addHandles([this.view.resourceController.scheduler.registerTask($t.T8.CLOUDS_GENERATOR,this),(0,k.watch)((function(){return[e.coverage,e.density,e.absorption,e.cloudSize,e.detailSize,e.smoothness,e.cloudHeight,e.raymarchingSteps]}),(function(){return e.setDirty()}),k.initial)])}},{key:"destroy",value:function(){this._techniques.forEach((function(e){return(0,x.RY)(e)})),this._frameBufferCube=(0,x.M2)(this._frameBufferCube),this._techniques.length=0,this._vao.dispose(),this._passParameters.noiseTexture=(0,x.SC)(this._passParameters.noiseTexture)}},{key:"_tilesPerFace",get:function(){switch(this._techniqueConfiguration.steps){case Bt.p.SIXTEEN:return 1;case Bt.p.HUNDRED:return 4;case Bt.p.COUNT:case Bt.p.TWOHUNDRED:return 8}}},{key:"usedMemory",get:function(){var e,t,n,i,r;return(null!==(e=null===(t=this._frameBufferCube)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0)+(null!==(n=null===(i=this._passParameters.noiseTexture)||void 0===i||null===(r=i.textureAtlas)||void 0===r?void 0:r.usedMemory)&&void 0!==n?n:0)}},{key:"_ensureNoiseTexture",value:function(){var e,t;return null!==(t=(e=this._passParameters).noiseTexture)&&void 0!==t||(e.noiseTexture=new Jt({context:this.context})),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile),null!=this._passParameters.noiseTexture.textureAtlas}},{key:"_ensureFrameBufferCube",value:function(e){if(null==this._frameBufferCube){var t=new Yt.X(e);t.target=_t.No.TEXTURE_CUBE_MAP,t.wrapMode=_t.e8.CLAMP_TO_EDGE,this._frameBufferCube=new Qt.X(this.context.renderContext.rctx,t)}return this._frameBufferCube}},{key:"cubeMap",get:function(){return this._frameBufferCube}},{key:"destroyFrameBufferCube",value:function(){this._frameBufferCube=(0,x.M2)(this._frameBufferCube)}},{key:"applyPreset",value:function(e,t){var n=e.median,i=function(e){var i=(0,Se.t7)(e[0],e[1],n);return t<.5?(0,Se.t7)(e[0],i,2*t):(0,Se.t7)(i,e[1],2*(t-.5))};this.coverage=i(e.coverage),this.density=i(e.density),this.absorption=i(e.absorption),this.cloudSize=i(e.cloudSize),this.detailSize=i(e.detailSize),this.smoothness=i(e.smoothness),this.cloudHeight=i(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}},{key:"setDirty",value:function(){this._dirty=this.running=!0}},{key:"runTask",value:function(e){0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),(0,at.JG)(this._passParameters.weatherTile,this._weatherTile));var t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return en.J;if(this.context.renderContext.bindParameters.cloudsFade.fadeMode===Vt.lL.CROSS_FADE||!this._ensureNoiseTexture())return en.J;0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=It.jL.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);var n=nn[this._faceIndex],i=rn[this._faceIndex];(0,Nt.ji)(this._viewMatrix,an,n,i),(0,Lt.xO)(this._passParameters.viewMatrix,this._viewMatrix);var r=this.context.renderContext.rctx,a=r.bindTechnique(t,this._bindParameters,this._passParameters);r.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao);var o=r.getViewport(),s=t.configuration.cubeMapSize,l=s/this._tilesPerFace,u=this._tileIndex*l;r.setViewport(0,u,s,l);var c=this._ensureFrameBufferCube(s);r.bindFramebuffer(c);var h=_t.No.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return c.setColorTextureTarget(h),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.gl.flush(),r.setViewport(o.x,o.y,o.width,o.height),this.requestRender(),++this._tileIndex,4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.running||(this.context.renderContext.bindParameters.cloudsFade.renderingStage=It.jL.FADING)):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),en.J}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],tn.prototype,"context",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],tn.prototype,"view",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],tn.prototype,"requestRender",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"coverage",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"density",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"absorption",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"cloudSize",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"detailSize",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"smoothness",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"cloudHeight",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"raymarchingSteps",void 0),(0,f._)([(0,E.Cb)()],tn.prototype,"running",void 0),tn=(0,f._)([(0,A.j)("esri.views.3d.environment.CloudsGenerator")],tn);var nn=[(0,Ht.al)(1,0,0),(0,Ht.al)(-1,0,0),(0,Ht.al)(0,1,0),(0,Ht.al)(0,-1,0),(0,Ht.al)(0,0,1)],rn=[(0,Ht.al)(0,1,0),(0,Ht.al)(0,1,0),(0,Ht.al)(0,0,-1),(0,Ht.al)(0,0,1),(0,Ht.al)(0,1,0)],an=(0,Ht.ll)(),on=n(43223),sn=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),i=t.call(this,e,new bt.m,(function(){return i.destroy()}))}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.SRC_ALPHA,_t.zi.ZERO,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE),colorWrite:mt.BK})}}]),n}(ft.A);sn.shader=new dt.J(on.a,(function(){return n.e(34991).then(n.bind(n,34991))}));var ln=n(50902),un=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;(0,o.Z)(this,n),(i=t.call(this,e))._passParameters=new on.F;var r=e.context.renderContext.rctx;i._vao=(0,St.o)(r,Tt.Bn),i._technique=new sn(e);var a=(0,nt.Iu)(e.view.spatialReference);return i._planetRadius=a.radius,i._atmosphereRadius=a.radius+lt.k8,i}return(0,s.Z)(n,[{key:"destroy",value:function(){this._technique.release(),this._vao.dispose()}},{key:"strength",get:function(){return this._passParameters.fogStrength},set:function(e){this._passParameters.fogStrength=e}},{key:"render",value:function(e,t){var n=this;if(this._update(e,t),!(this._passParameters.fogAmount<=0)){var i=this._technique;if(i.compiled){var r=e.offscreenRenderingHelper;r.renderDepthDetached((function(){n._passParameters.depthTexture=r.depthTexture;var t=e.rctx.bindTechnique(i,e.bindParameters,n._passParameters);n._renderFog(t,e)}))}else this.context.requestRender()}}},{key:"_renderFog",value:function(e,t){var n=t.rctx;n.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),n.drawArrays(_t.MX.TRIANGLE_STRIP,0,4)}},{key:"_update",value:function(e,t){var n=e.bindParameters.camera;(0,et.n)(hn,n.eye);var i=Math.max(0,(0,et.m)(hn,e.bindParameters.lighting.mainLight.direction)),r=t.color;(0,et.j)(dn,r,.1),(0,et.o)(this._passParameters.fogColor,dn,r,i);var a=(0,et.l)(n.eye),o=a*a;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-(0,Se.CW)(.95*ln.nq,1*ln.nq,Math.abs(a-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],un.prototype,"context",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],un.prototype,"view",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],un.prototype,"rctx",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],un.prototype,"viewingMode",void 0),un=(0,f._)([(0,A.j)("esri.views.3d.environment.Fog")],un);var cn=(0,s.Z)((function e(){(0,o.Z)(this,e),this.color=(0,U.Ue)(),this.strength=0,this.amount=0})),hn=(0,U.Ue)(),dn=(0,U.Ue)(),fn=n(92014),vn=n(69362),pn=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return this.configuration.geometry===vn.n.Cylinder?(0,mt.sm)({blending:(0,mt.wK)(_t.zi.SRC_ALPHA,_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),culling:mt.Rd,depthTest:{func:_t.wb.LEQUAL},colorWrite:mt.BK}):(0,mt.sm)({blending:(0,mt.wK)(_t.zi.SRC_ALPHA,_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:_t.wb.LEQUAL},colorWrite:mt.BK})}}]),n}(ft.A);pn.shader=new dt.J(fn.a,(function(){return n.e(35701).then(n.bind(n,35701))}));var _n=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]),mn=n(50256),gn=n(55158),yn=n(70619),bn=n(80658),wn=n(4760),Cn=n(44070),xn=n(57808),Tn=n(3384),Sn=function(){function e(t,n){(0,o.Z)(this,e),this.type=Je.Local,this._configuration=new vn.f,this._passParameters=new fn.S,this._configuration.geometry=vn.n.Cylinder,this._technique=n.techniques.acquire(pn,this._configuration);var i=n.renderContext.rctx;this._vao=function(e){for(var t=(0,yn.xu)(1,2,!1)[0][1],n=t.data,i=t.indices,r=Mn.createBuffer(i.length),a=r.position,o=0;o<i.length;++o){var s=3*i[o%3==0?o+2:o%3==2?o-2:o];a.set(o,0,n[s]),a.set(o,1,n[s+1]),a.set(o,2,n[s+2])}return new bn.U(e,vt.i,{geometry:(0,mn.K)(Mn)},{geometry:Cn.f.createVertex(e,_t.l1.STATIC_DRAW,r.buffer)})}(i),this._vaoCount=(0,Tn._V)(this._vao,"geometry");var r=new Yt.X;r.wrapMode=_t.e8.CLAMP_TO_EDGE,r.flipped=!0,r.width=1,r.height=512,this._passParameters.texture=new xn.x(i,r,_n)}return(0,s.Z)(e,[{key:"destroy",value:function(){this._passParameters.texture=(0,x.M2)(this._passParameters.texture),this._vao.dispose(),this._technique.release()}},{key:"render",value:function(e){var t=e.rctx,n=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);(function(e,t){(0,Nt.JG)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1})(kn,e.bindParameters.camera.viewMatrix),n.setUniformMatrix4fv("view",kn),t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(_t.MX.TRIANGLES,0,this._vaoCount)}},{key:"renderHaze",value:function(){return!1}}]),e}();var kn=(0,Ut.Ue)(),Mn=(0,gn.U$)().vec3f(wn.T.POSITION),Pn=n(38461),Rn=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),En=n(97731),On=128,An=-lt.Tk,Dn=(0,Me.uV)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]),Zn=function(){function e(t,n){var i=this;(0,o.Z)(this,e),this.view=t,this.type=Je.Mars,this._passParameters=new fn.S,this._vaoCount=0,this._texV1=1;var r=(0,nt.Iu)(t.spatialReference);this._planetRadius=r.radius,this._outerRimWidth=r.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+An)/this._planetRadius,this._middleRimFactor=(this._planetRadius+0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniques=n.techniques;var a=n.renderContext.rctx;this._cameraChangeHandle=(0,k.watch)((function(){var e;return null===(e=i.view.state)||void 0===e?void 0:e.camera}),(function(){return n.requestRender()}),k.syncAndInitial),this._vao=this._createRibbon(a),this._vaoCount=(0,Tn._V)(this._vao,"geometry"),this._fadeVao=(0,St.o)(a),this._fadeVaoCount=(0,Tn._V)(this._fadeVao,"geometry");var s=new Yt.X;s.wrapMode=_t.e8.CLAMP_TO_EDGE,s.flipped=!0,s.width=1,s.height=512,this._passParameters.texture=new xn.x(a,s,Rn);var l=new vn.f;l.geometry=vn.n.Cone,this._coneTechnique=this._techniques.acquire(pn,l),l.geometry=vn.n.Underground,this._undergroundTechnique=this._techniques.acquire(pn,l)}return(0,s.Z)(e,[{key:"destroy",value:function(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=(0,x.M2)(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}},{key:"render",value:function(e){var t=e.bindParameters.camera;this._update(t);var n=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(n.bindTechnique(this._coneTechnique,e.bindParameters,this._passParameters),n.bindVAO(this._vao),n.drawArrays(_t.MX.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(n.bindTechnique(this._undergroundTechnique,e.bindParameters,this._passParameters),n.bindVAO(this._fadeVao),n.drawArrays(_t.MX.TRIANGLE_STRIP,0,this._fadeVaoCount))}},{key:"renderHaze",value:function(){}},{key:"_update",value:function(e){var t=(0,U.Ue)(),n=this._planetRadius,i=(0,et.l)(e.eye),r=i-n;if(r<0){var a=Math.min(-r/5e3,1);this._passParameters.undergroundFadeAlpha=a}else this._passParameters.undergroundFadeAlpha=0;var o=Math.max(50,r),s=n+An;this._passParameters.innerScale=function(e,t,n){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-n*n)+t*n)}(n+o,n,s)-1,this._passParameters.altitudeFade=(0,lt.yx)(r),(0,et.j)(t,e.eye,(n+50)/i),In(t,e.center,e.up,n,this._passParameters.silhouette);var l=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),u=1-511/512,c=Dn(r),h=this._texV0+u*this._texVScale,d=this._texV0+l*c*this._texVScale;if(r>50){In(e.eye,e.center,e.up,n,this._passParameters.silhouette);var f=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),v=(0,Se.uZ)((f-1.5)/(l-1.5),0,1);h=this._texV0+v*u*this._texVScale,d=this._texV0+(0,Se.t7)(this._texV1,l*c,v)*this._texVScale}(0,at.t8)(this._passParameters.texV,h,d)}},{key:"_createRibbon",value:function(e){var t=(0,Pn.xx)(1155),n=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(var i=0;i<On;i++){var r=9*i+3;t[r]=i,t[r+1]=this._innerRimFactor,t[r+2]=-1,t[r+3]=i,t[r+4]=this._middleRimFactor,t[r+5]=0,t[r+6]=i,t[r+7]=this._outerRimFactor,t[r+8]=1;var a=3*i+1,o=127===i?1:a+3,s=15*i;n[s]=a,n[s+1]=a+1,n[s+2]=o+1,n[s+3]=o+1,n[s+4]=o,n[s+5]=a,n[s+6]=a+1,n[s+7]=a+2,n[s+8]=o+2,n[s+9]=o+2,n[s+10]=o+1,n[s+11]=a+1,n[s+12]=a,n[s+13]=o,n[s+14]=0}for(var l=Hn.createBuffer(n.length),u=l.position,c=0;c<n.length;++c){var h=3*n[c];u.set(c,0,t[h]),u.set(c,1,t[h+1]),u.set(c,2,t[h+2])}return new bn.U(e,vt.i,{geometry:(0,mn.K)(Hn)},{geometry:Cn.f.createVertex(e,_t.l1.STATIC_DRAW,l.buffer)})}},{key:"_computeScreenRimWidth",value:function(e,t,n,i){return(0,et.g)(Nn,i.center,i.v2),(0,et.j)(Un,Nn,this._outerRimFactor),(0,Nt.zB)(Ln,t,Nn,n),(0,En.iV)(Nn,Ln,e.projectionMatrix,e.viewport,Nn),(0,En.iV)(Un,Ln,e.projectionMatrix,e.viewport,Un),(0,et.p)(Nn,Un)/e.height}}]),e}();function In(e,t,n,i,r){var a=(0,et.l)(e),o=i*Math.sqrt(a*a-i*i)/a,s=Math.sqrt(i*i-o*o),l=r.v1,u=r.v2;return(0,et.j)(r.center,e,s/a),(0,et.b)(l,e,t),(0,et.q)(l)<1&&(0,et.b)(l,e,n),(0,et.j)(l,l,o/(0,et.l)(l)),(0,et.b)(u,l,e),(0,et.j)(u,u,o/(0,et.l)(u)),o}var Ln=(0,Ut.Ue)(),Nn=(0,U.Ue)(),Un=(0,U.Ue)();var Hn=(0,gn.U$)().vec3f(wn.T.POSITION),Fn=n(38499),Vn=n(19159),zn=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).time=0,e.radius=1,e.width=500,e.opacity=1,e}return(0,s.Z)(n)}(ht.K),qn=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),Bn)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.ONE,_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:_t.wb.LEQUAL},colorWrite:mt.BK})}}]),n}(ft.A);qn.shader=new dt.J(Vn.P,(function(){return n.e(79090).then(n.bind(n,79090))}));var Bn=new Map([[wn.T.POSITION,0],[wn.T.INSTANCEFEATUREATTRIBUTE,1]]),Gn=n(96916),jn=n(96856),Wn=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._numParticles=25e4,i._rainSpeed=.1,i._snowSpeed=.01,i._passParameters=new zn,i._animation=new jn.d,i._passParameters.time=0,i._passParameters.radius=(0,nt.Iu)(e.view.spatialReference).radius,i._techniques=e.context.techniques,i}return(0,s.Z)(n,[{key:"destroy",value:function(){this._numParticles=0,this._snowTechniqueCached=(0,x.RY)(this._snowTechniqueCached),this._rainTechniqueCached=(0,x.RY)(this._rainTechniqueCached),this._vao=(0,x.M2)(this._vao),this._instanceIdBuffer=(0,x.M2)(this._instanceIdBuffer)}},{key:"_rainTechnique",get:function(){if(null==this._rainTechniqueCached){var e=new Gn.Y;e.type=Gn.H.Rain,this._rainTechniqueCached=this._techniques.acquire(qn,e)}return this._rainTechniqueCached}},{key:"_snowTechnique",get:function(){if(null==this._snowTechniqueCached){var e=new Gn.Y;e.type=Gn.H.Snow,this._snowTechniqueCached=this._techniques.acquire(qn,e)}return this._snowTechniqueCached}},{key:"update",value:function(e){return this._animation.advance(e)}},{key:"render",value:function(e,t,n){var i="rainy"===n?this._rainTechnique:this._snowTechnique;if(i.compiled){var r=e.rctx;if(this._ensureResources(r),null!=i&&null!=this._vao&&null!=this._instanceIdBuffer&&(null!=e.bindParameters.cloudsFade.data&&(this._passParameters.opacity=e.bindParameters.cloudsFade.opacity),!(this._passParameters.opacity<=0))){t=t<.5?(0,Se.t7)(0,.35,2*t):(0,Se.t7)(.35,1,2*(t-.5)),this._passParameters.time=("rainy"===n?this._rainSpeed:this._snowSpeed)*(0,Fn.D9)(this._animation.time)%1e5;var a=r.bindTechnique(i,e.bindParameters,this._passParameters);r.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),(0,Tn.XP)(r,Bn,this._instanceIdBuffer,Qn,0),r.drawArraysInstanced(_t.MX.TRIANGLES,0,3,this._numParticles*t),(0,Tn.UF)(r,Bn,this._instanceIdBuffer,Qn)}}else this.context.requestRender()}},{key:"_ensureResources",value:function(e){null==this._vao&&(this._vao=function(e){var t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new bn.U(e,Bn,{geometry:(0,mn.K)(Xn)},{geometry:Cn.f.createVertex(e,_t.l1.STATIC_DRAW,t)})}(e)),null==this._instanceIdBuffer&&(this._instanceIdBuffer=this._createInstanceIndices(e))}},{key:"_createInstanceIndices",value:function(e){for(var t=[],n=0;n<this._numParticles;n++)t.push(n);return Cn.f.createVertex(e,_t.l1.STATIC_DRAW,new Float32Array(t))}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],Wn.prototype,"context",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Wn.prototype,"view",void 0),Wn=(0,f._)([(0,A.j)("esri.views.3d.environment.Precipitation")],Wn);var Xn=(0,gn.U$)().vec3f(wn.T.POSITION),Qn=(0,mn.K)((0,gn.U$)().f32(wn.T.INSTANCEFEATUREATTRIBUTE),1),Yn=n(65905),Jn=n(46634),Kn=n(96894),$n=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).modelMatrix=(0,Ut.Ue)(),e}return(0,s.Z)(n)}(ht.K),ei=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),i=t.call(this,e,new bt.m,(function(){return i.destroy()}))}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.SRC_ALPHA,_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:_t.wb.LEQUAL},colorWrite:mt.BK})}}]),n}(ft.A);ei.shader=new dt.J(Kn.S,(function(){return n.e(98080).then(n.bind(n,98080))}));var ti=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._loadDataTask=null,i._numPoints=0,i._passParameters=new $n,i._updatingTracking=new Jn.R,i}return(0,s.Z)(n,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return null!=this._loadDataTask&&!this._loadDataTask.finished}},{key:"initialize",value:function(){this._loadDataTask=this._createLoadDataTask()}},{key:"destroy",value:function(){this._loadDataTask=(0,x.IM)(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=(0,x.RY)(this._technique),this._vao=(0,x.M2)(this._vao),hi=null}},{key:"render",value:function(e){var t=e.rctx;if(this._ensureResources(t),null!=this._technique&&null!=this._vao)if(this._technique.compiled){var n=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(_t.MX.POINTS,0,this._numPoints)}else this.requestRender()}},{key:"_ensureResources",value:function(e){var t=this;if(null==this._technique&&null!=hi){this._technique=new ei({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=hi.byteLength/ui;var n=new Float32Array(hi,0,2*this._numPoints),i=new Uint8Array(hi,2*this._numPoints*4,this._numPoints);this._vao=function(e,t,n,i){for(var r=ci.createBuffer(i),a=r.position,o=r.color,s=r.size,l=0;l<i;l++){var u=t[2*l],c=t[2*l+1];a.set(l,0,-Math.cos(u)*Math.sin(c)),a.set(l,1,-Math.sin(u)*Math.sin(c)),a.set(l,2,-Math.cos(c));var h=ri(n[l]),d=ii(oi[h[1]]);o.set(l,0,255*d[0]),o.set(l,1,255*d[1]),o.set(l,2,255*d[2]),o.set(l,3,255),s.set(l,h[0])}return new bn.U(e,vt.i,{geometry:(0,mn.K)(ci)},{geometry:Cn.f.createVertex(e,_t.l1.STATIC_DRAW,r.buffer)})}(e,n,i,this._numPoints),this._updatingTracking.add((function(){return"virtual"!==t.view.environment.lighting.type?t.view.environment.lighting.date:null}),(function(e){return t._update(e)}),k.initial)}}},{key:"_update",value:function(e){if(e){var t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,n=2*function(e){var t=e,n=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+n)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+n)}(e),i=(0,Nt.JG)(this._passParameters.modelMatrix,li);(0,Nt.jI)(i,i,-n*Math.PI),(0,Nt.Jp)(i,si,i),(0,Nt.jI)(i,i,-t*Math.PI),this.requestRender()}}},{key:"_createLoadDataTask",value:function(){var e=this;if(null!=hi)return null;var t=(0,ye.vr)(function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n,i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,Yn.b)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});case 2:n=e.sent,ni(i=n.data),hi=i;case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());return t.promise.catch((function(t){(0,S.D_)(t)||C.Z.getLogger(e).error(t)})).then((function(){e.destroyed||(e.requestRender(),e.notifyChange("updating"))})),t}}]),n}(Z.default);function ni(e){if(!e)throw new g.Z("stars:no-data-received","Failed to create stars because star catalogue is missing");var t=e.byteLength/ui;if(t%1!=0||t>5e4||t<5e3)throw new g.Z("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function ii(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}function ri(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}(0,f._)([(0,E.Cb)({constructOnly:!0})],ti.prototype,"view",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],ti.prototype,"requestRender",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ti.prototype,"updating",null),(0,f._)([(0,E.Cb)()],ti.prototype,"_loadDataTask",void 0),(0,f._)([(0,E.Cb)()],ti.prototype,"_updatingTracking",void 0),ti=(0,f._)([(0,A.j)("esri.views.3d.environment.Stars")],ti);var ai,oi=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],si=(0,Ut.al)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),li=(0,Ut.al)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),ui=9,ci=(0,gn.U$)().vec3f(wn.T.POSITION).vec4u8(wn.T.COLOR).f32(wn.T.SIZE),hi=null,di=n(70374),fi=n(93822);!function(e){e[e.Immediate=0]="Immediate",e[e.Faded=1]="Faded"}(ai||(ai={}));var vi=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).produces=new Map([[fi.r.OPAQUE_ENVIRONMENT,function(){return!(null===i._atmosphere&&null===i._stars)}],[fi.r.TRANSPARENT_ENVIRONMENT,function(){return!(null===i._atmosphere)}]]),i._context=null,i._atmosphere=null,i._oldWeatherParameters=new pi,i._newWeatherParameters=new pi,i._fadedWeatherParameters=new pi,i._weatherParameters=i._newWeatherParameters,i}return(0,s.Z)(n,[{key:"initialize",value:function(){this.view._stage.addRenderPlugin(this)}},{key:"destroy",value:function(){var e;this.removeHandles(),this.uninitializeRenderContext(),null!=(null===(e=this.view)||void 0===e?void 0:e._stage)&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}},{key:"atmosphere",get:function(){return this._atmosphere}},{key:"_atmosphereType",get:function(){return null!=this.atmosphere?this.atmosphere.type:Je.None}},{key:"consumes",value:function(){return this._atmosphereType===Je.Realistic?di.of:di.jt}},{key:"updateAnimation",value:function(e){return null!=this._precipitation&&this._precipitation.update(e)}},{key:"updating",get:function(){return null!=this._stars&&this._stars.updating||null!=this._clouds&&this._clouds.running}},{key:"weatherVisible",get:function(){return(0,et.l)(this.view.state.camera.eye)-(0,nt.Iu)(this.view.spatialReference).radius<=ln.nq}},{key:"usedMemory",get:function(){var e,t;return null!==(e=null===(t=this._clouds)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}},{key:"_stars",get:function(){var e,t,n=this,i=this.view,r=null!==(e=null===(t=i.environment)||void 0===t?void 0:t.starsEnabled)&&void 0!==e&&e,a=this._get("_stars");return r&&null!=this._context?null!=a?a:new ti({view:i,requestRender:function(){return n._setNeedsRender()}}):((0,x.SC)(a),null)}},{key:"_precipitation",get:function(){var e=this._get("_precipitation");if(!this._precipitationEnabled||null==this._context)return(0,x.SC)(e),null;var t=this.view,n=this._context;return null!=e&&e.context===n?e:((0,x.SC)(e),new Wn({context:n,view:t}))}},{key:"_clouds",get:function(){var e=this,t=this._get("_clouds");if(!this.weatherEnabled||null==this._context)return(0,x.SC)(t),null;if(null!=t)return t;var n=this.view,i=this._context;return(0,x.SC)(t),new tn({context:i,view:n,requestRender:function(){return e._setNeedsRender()}})}},{key:"_cloudsComposition",get:function(){var e=this,t=this._get("_cloudsComposition");if(!this.weatherEnabled||null==this._context)return(0,x.SC)(t),null;var n=this.view.state.viewingMode,i=this._context.renderContext.rctx,r=(0,nt.Iu)(this.view.spatialReference).radius;return null!=t&&t.viewingMode===n&&t.planetRadius===r?t:((0,x.SC)(t),new Dt({rctx:i,viewingMode:n,planetRadius:r,requestRender:function(){return e._setNeedsRender()}}))}},{key:"_fog",get:function(){var e=this._get("_fog");if(!this.weatherEnabled||null==this._context)return(0,x.SC)(e),null;if(null!=e)return e;var t=this.view,n=this._context,i=this._context.renderContext.rctx,r=this.view.state.viewingMode;return new un({context:n,view:t,rctx:i,viewingMode:r})}},{key:"weatherEnabled",get:function(){var e,t;return!(null===(e=this.view)||void 0===e||null===(t=e.environmentManager)||void 0===t||!t.weatherEnabled)}},{key:"_precipitationEnabled",get:function(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}},{key:"initializeRenderContext",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._context=t;var n=function(){return e._setNeedsRender()};this.addHandles([(0,k.watch)((function(){return{viewingMode:e.view.state.viewingMode,enabled:e.view.environment.atmosphereEnabled}}),(function(t){return e._updateAtmosphere(t)}),k.syncAndInitial),(0,k.watch)((function(){return e._stars}),n),(0,k.watch)((function(){return e._precipitation}),n),(0,k.watch)((function(){return e._clouds}),(function(){return e._updateWeather()}),k.initial),(0,k.watch)((function(){return e._fog}),(function(){return e._updateFogHaze()}),k.initial),(0,k.watch)((function(){return e.view.state.mode}),(function(){return e._setNeedsRender()}),k.sync),(0,k.watch)((function(){return e._weatherUpdateParameters}),(function(){e._updateWeather(),e._updateFogHaze()}),k.syncAndInitial)])}},{key:"uninitializeRenderContext",value:function(){this._context=null,this._atmosphere=(0,x.SC)(this._atmosphere),this._set("_stars",(0,x.SC)(this._stars)),this._set("_precipitation",(0,x.SC)(this._precipitation)),this._set("_clouds",(0,x.SC)(this._clouds)),this._set("_cloudsComposition",(0,x.SC)(this._cloudsComposition)),this._set("_fog",(0,x.SC)(this._fog))}},{key:"prepareRender",value:function(e){var t;e.bindParameters.cloudsFade.data=(0,It.Ck)(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&null!=(null===(t=e.bindParameters.cloudsFade.data)||void 0===t?void 0:t.cubeMap)&&(this._updateWeatherFading(e.bindParameters,e.time),e.bindParameters.cloudsFade.renderingStage===It.jL.FINISHED&&null!=this._clouds&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))}},{key:"renderNode",value:function(e){var t,n,i,r,a,o,s,l;switch(e.bindParameters.slot){case fi.r.OPAQUE_ENVIRONMENT:null!==(t=this._stars)&&void 0!==t&&t.render(e),null!=this.atmosphere&&(this.atmosphere.render(e,null===(n=this.view)||void 0===n||null===(i=n._stage)||void 0===i||null===(r=i.renderer)||void 0===r?void 0:r.fullResolutionAtmosphere),this._cloudsComposition&&null!=e.bindParameters.cloudsFade.data&&(this.weatherVisible&&null!=this._clouds&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),e.bindParameters.cloudsFade.isFading&&this._context&&null!=(null===(a=e.bindParameters.cloudsFade.data)||void 0===a?void 0:a.cubeMap)&&this._context.requestRender());break;case fi.r.TRANSPARENT_ENVIRONMENT:if(null!=this.atmosphere&&(this.atmosphere.renderHaze(e,this._weatherParameters.hazeAmount,null===(o=this.view)||void 0===o||null===(s=o._stage)||void 0===s||null===(l=s.renderer)||void 0===l?void 0:l.fullResolutionAtmosphere),this._weatherParameters.fog.amount>0&&null!=this._fog&&this._fog.render(e,this._weatherParameters.fog),this._precipitation)){var u=this.view.environment.weather;"rainy"!==u.type&&"snowy"!==u.type||this._precipitation.render(e,u.precipitation,u.type)}}}},{key:"updateLightSources",value:function(e,t,n,i){if(null!=this._context){var r=this._context.renderContext;r.bindParameters.oldLighting.copyFrom(r.bindParameters.lighting),r.bindParameters.newLighting.noonFactor=t,r.bindParameters.newLighting.globalFactor=n,r.bindParameters.newLighting.set(e),i===ai.Faded||r.bindParameters.weatherFading?r.bindParameters.fadeLighting(0):r.bindParameters.fadeLighting(1),this._context.requestRender()}}},{key:"_weatherUpdateParameters",get:function(){var e=this.weatherEnabled?this.view.environment.weather:null;return null==e?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}},{key:"_updateWeatherFading",value:function(e,t){e.cloudsFade.updateFading(e.camera,this.view.state.mode,t,this.view.qualitySettings.fadeDuration),e.cloudsFade.updateParallax(e.camera),e.weatherFading&&(function(e){e.cloudsFade.fadeMode!==Vt.lL.CROSS_FADE&&e.cloudsFade.fadeMode!==Vt.lL.FADE_IN?e.fadeLighting(0):e.fadeLighting(e.cloudsFade.fadeFactor)}(e),this._updateFogAtmoshpere(e))}},{key:"_updateFogAtmoshpere",value:function(e){e.cloudsFade.fadeMode!==Vt.lL.CROSS_FADE&&e.cloudsFade.fadeMode!==Vt.lL.FADE_IN?this._fadeWeather(0):this._fadeWeather(e.cloudsFade.fadeFactor)}},{key:"_fadeWeather",value:function(e){var t=this._newWeatherParameters,n=this._oldWeatherParameters;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(n,t,e),this._weatherParameters=this._fadedWeatherParameters)}},{key:"_updateWeather",value:function(){var e=this._weatherUpdateParameters;null!=e&&null!=this._clouds&&(this._clouds.applyPreset(zt.L[e.type],e.weatherAdjustment),this._setNeedsRender())}},{key:"_setNeedsRender",value:function(){null!=this._context&&this._context.requestRender()}},{key:"_updateFogHaze",value:function(){var e,t,n=this._weatherUpdateParameters;if(null!=this._fog&&null!=n&&null!=this._context){var i=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),n.type){case"foggy":this._newWeatherParameters.fog.strength=(0,Se.t7)(3e-5,.005,Math.pow(n.weatherAdjustment,3)),(0,et.c)(this._newWeatherParameters.fog.color,mi),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=(0,Se.t7)(4e-6,2e-4,Math.pow(null!==(e=n.effect)&&void 0!==e?e:0,3)),(0,et.c)(this._newWeatherParameters.fog.color,_i),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=(0,Se.t7)(4e-6,2e-4,Math.pow(null!==(t=n.effect)&&void 0!==t?t:0,3)),(0,et.c)(this._newWeatherParameters.fog.color,mi),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}i.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}}},{key:"_updateAtmosphere",value:function(e){var t=this._selectAtmosphereType(e);if(t!==Je.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==t){this._atmosphere=(0,x.SC)(this._atmosphere);var n=this._getAtmosphereClass(t);n&&(this._atmosphere=new n(this.view,this._context))}}else this._atmosphere=(0,x.SC)(this._atmosphere);this._setNeedsRender()}},{key:"_getAtmosphereClass",value:function(e){switch(e){case Je.Realistic:return Et;case Je.Local:return Sn;case Je.Mars:return Zn;default:case Je.None:return null}}},{key:"_selectAtmosphereType",value:function(e){var t=e.enabled,n=e.viewingMode;return!t||(0,tt.V2)(this.view.spatialReference)?Je.None:n===he.JY.Local?Je.Local:null!=this._context&&(0,tt.N$)(this.view.spatialReference)?Je.Realistic:(0,tt.BZ)(this.view.spatialReference)?Je.Mars:Je.None}},{key:"test",get:function(){}}]),n}(di.tY);(0,f._)([(0,E.Cb)({constructOnly:!0})],vi.prototype,"view",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"atmosphere",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"_atmosphereType",null),(0,f._)([(0,E.Cb)({type:Boolean,readOnly:!0})],vi.prototype,"updating",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"weatherVisible",null),(0,f._)([(0,E.Cb)()],vi.prototype,"_context",void 0),(0,f._)([(0,E.Cb)()],vi.prototype,"_atmosphere",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"_stars",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"_precipitation",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"_clouds",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"_cloudsComposition",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"_fog",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"weatherEnabled",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"_precipitationEnabled",null),(0,f._)([(0,E.Cb)({readOnly:!0})],vi.prototype,"_weatherUpdateParameters",null),vi=(0,f._)([(0,A.j)("esri.views.3d.environment.EnvironmentRenderer")],vi);var pi=function(){function e(){(0,o.Z)(this,e),this.fog=new cn,this.hazeAmount=1}return(0,s.Z)(e,[{key:"copyFrom",value:function(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,(0,et.c)(this.fog.color,e.fog.color)}},{key:"lerp",value:function(e,t,n){this.fog.amount=(0,Se.t7)(e.fog.amount,t.fog.amount,n),this.hazeAmount=(0,Se.t7)(e.hazeAmount,t.hazeAmount,n),this.fog.strength=(0,Se.t7)(e.fog.strength,t.fog.strength,n),(0,et.o)(this.fog.color,e.fog.color,t.fog.color,n)}}]),e}();var _i=(0,U.al)(.5,.5,.5),mi=(0,U.al)(1.5,1.5,1.5),gi=n(696),yi=n(28961),bi=n(11954),wi=n(4914),Ci=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.call(this))._referencePointUpdateDelay=200,e._referencePointUpdateInterval=3e3,e._referencePointUpdateDistThreshold=1e6,e._referencePosUpdateQuery=null,e._referencePosMapCoordsRequested=null,e._viewHandlesKey="viewHandles",e._preserveAbsoluteDateTime=!1,e._trackingEnabled=!1,e._referencePosResetPreserveAbsoluteTime=!1,e._referencePosUpdateTimer=null,e._referencePosMapCoords=null,e._mainLight=new bi.Eg,e._ambientLight=new bi.Mi,e._moonLight=new bi.AM,e.disableQueries=!1,e._disableWeather=!1,e._renderer=null,e._referencePositionGeographic=null,e._resetReferencePosition(),e}return(0,s.Z)(n,[{key:"destroy",value:function(){this.disconnectView()}},{key:"_view",get:function(){var e;return null===(e=this._renderer)||void 0===e?void 0:e.view}},{key:"updating",get:function(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&(null===(e=this._renderer)||void 0===e||!e.updating))}},{key:"weatherEnabled",get:function(){var e,t,n;return(null===(e=this._view)||void 0===e?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&(null===(t=this._view)||void 0===t||null===(n=t.state)||void 0===n?void 0:n.viewingMode)===he.JY.Global&&(0,tt.N$)(this._view.spatialReference)}},{key:"weatherVisible",get:function(){var e;return this.weatherEnabled&&(null===(e=this._renderer)||void 0===e?void 0:e.weatherVisible)}},{key:"referencePositionGeographic",get:function(){return this._referencePositionGeographic}},{key:"connectView",value:function(e){var t=this;if(!this._renderer){this._renderer=new vi({view:e});var n=function(){return t._updateRenderParameters()},i=function(){return t._cameraHandler()};this.addHandles([(0,k.watch)((function(){return e.environment.lighting}),(function(e){return t._updateLightingHandler(e)}),k.sync),(0,k.watch)((function(){return"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null}),(function(e){return t._lightingDateHandler(e)}),k.sync),(0,k.watch)((function(){return e.stationary}),(function(){return t._interactingStationaryHandler()})),(0,k.watch)((function(){return e.environment.lighting.directShadowsEnabled}),n,k.sync),(0,k.watch)((function(){return e.qualitySettings.ambientOcclusion}),n,k.sync),(0,k.watch)((function(){return e.qualitySettings.reflections}),n,k.sync),(0,k.watch)((function(){return e.spatialReference}),(function(){return t._resetReferencePosition(!0)}),k.sync),(0,k.watch)((function(){return e.environment.weather.type}),(function(){return t._updateLighting(null,ai.Faded)}),k.sync),(0,k.watch)((function(){return t.weatherEnabled}),(function(){return t._updateLighting(null,ai.Faded)}),k.sync),(0,k.watch)((function(){return e.viewingMode}),(function(){return t._resetReferencePosition(!0)}),k.syncAndInitial),(0,k.watch)((function(){return"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled}),(function(e){return t._updateCameraTracking(e)}),k.syncAndInitial),(0,k.watch)((function(){return e.state.camera}),i,k.syncAndInitial),(0,k.watch)((function(){return t.disableQueries}),i)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}}},{key:"disconnectView",value:function(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=(0,x.SC)(this._renderer)}},{key:"_updateLightingHandler",value:function(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}},{key:"_updateCameraTracking",value:function(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{var t=this._view.environment.lighting;"virtual"!==(null===t||void 0===t?void 0:t.type)&&(t.positionTimezoneInfo.autoUpdated=!1)}}},{key:"_lightingDateHandler",value:function(e){var t=this._view.environment.lighting;if("virtual"!==(null===t||void 0===t?void 0:t.type)){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;var n=this._view.spatialReference;if(!(0,V.canProjectWithoutEngine)(n,ee.Z.WGS84)){var i=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(i))return void this._requestReferencePositionUpdate(i)}if(this._preupdateTracking(e),null!=this._referencePositionGeographic){var r=(0,gi.dF)(this._referencePositionGeographic,Ri);null!=r&&(t.autoUpdate(null,r),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}},{key:"_preupdateTracking",value:function(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}},{key:"_cameraHandler",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._view;if(t.ready){var n=t.stateManager.camera;n&&(this._cameraHandlerClientSide(n,e)||this._cameraHandlerServerSide(n))}}},{key:"_cameraHandlerClientSide",value:function(e,t){var n,i,r,a,o=(0,tt.N$)(this._view.spatialReference);if(o&&!(0,V.canProjectWithoutEngine)(this._view.spatialReference,ee.Z.WGS84))return"virtual"===this._view.environment.lighting.type&&this._updateLighting(),!1;var s=e.position;return null!==(n=this._referencePositionGeographic)&&void 0!==n||(this._referencePositionGeographic=(0,U.Ue)()),o?(0,q.K)(s,this._referencePositionGeographic,ee.Z.WGS84):(0,et.s)(this._referencePositionGeographic,null!==(i=s.longitude)&&void 0!==i?i:0,null!==(r=s.latitude)&&void 0!==r?r:0,null!==(a=s.z)&&void 0!==a?a:0),this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(this._referencePositionGeographic,t)||this._updateLighting(t),!0}},{key:"_cameraHandlerServerSide",value:function(e){var t,n=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(n))&&this._requestReferencePositionUpdate(n,!0),this._view.mapCoordsHelper&&this._referencePositionGeographic&&(this._referencePositionGeographic[2]=(null!==(t=n.z)&&void 0!==t?t:0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}},{key:"_interactingStationaryHandler",value:function(){this._view.stationary&&this._executePendingReferencePositionUpdate()}},{key:"_updateLighting",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ai.Immediate,n=this._view;e=e||("virtual"===n.environment.lighting.type?null:n.environment.lighting.date);var i=this._referencePositionGeographic,r=i?ki:Mi,a=this.weatherVisible?n.environment.weather.type:"disabled";null!=i?(0,yi.WA)(e,i,n.state.viewingMode,a,n.state.camera,r):"virtual"===n.environment.lighting.type&&(0,yi.H3)(n.state.camera,n.state.viewingMode,r.direct.directionToLightSource);var o=this._mainLight,s=r.direct;(0,et.j)(o.intensity,s.color,s.intensity*Math.PI),(0,et.c)(o.direction,s.directionToLightSource),o.specularStrength=r.specularStrength,o.environmentStrength=r.environmentStrength;var l=this._ambientLight;(0,et.j)(l.intensity,r.ambient.color,r.ambient.intensity);var u=this._moonLight;(0,et.o)(u.intensity,Ei,Oi,r.globalFactor);var c=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));(0,et.j)(u.intensity,u.intensity,c),(0,et.c)(u.direction,s.directionToLightSource),this._renderer.updateLightSources([o,l,u],r.noonFactor,r.globalFactor,t),this._updateRenderParameters()}},{key:"_autoUpdateTimezone",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;var n=Pi;n.setTime((t||this._view.environment.lighting.date).getTime());var i=(0,gi.dF)(e,Ri);if(null==i)return!1;var r=this._view.environment.lighting.positionTimezoneInfo;if(r.autoUpdated){if(r.hours===i.hours&&r.minutes===i.minutes&&r.seconds===i.seconds)return!1}else r=i;var a=n.getUTCHours()-(i.hours-r.hours),o=n.getUTCMinutes()-(i.minutes-r.minutes),s=n.getUTCSeconds()-(i.seconds-r.seconds);return n.setUTCHours(a),n.setUTCMinutes(o),n.setUTCSeconds(s),!t&&this._view.environment.lighting.autoUpdate(n,i)}},{key:"_updateRenderParameters",value:function(){var e=this._view._stage;if(e){var t=null==this._referencePositionGeographic||(0,yi.XO)(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})}}},{key:"_resetReferencePosition",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePositionGeographic=null,this.notifyChange("updating"),e&&this._cameraHandler()}},{key:"_requestReferencePositionUpdate",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!n,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){var i=this._referencePosUpdateQuery=(0,S.e4)(this._referencePointUpdateDelay).then((function(){if(t._referencePosUpdateQuery===i){return t._doReferencePositionUpdateQuery((function(){return t._referencePosUpdateQuery!==i}))}})).catch((function(e){"mapcoordshelper:missing-geometry-service"===e.name&&(t.disableQueries=!0)})).then((function(){t._referencePosUpdateQuery===i&&(t._referencePosUpdateQuery=null,t._referencePosUpdateTimer||t._executePendingReferencePositionUpdate(),t.notifyChange("updating"))})),r=this._referencePosUpdateTimer=(0,S.e4)(this._referencePointUpdateInterval).then((function(){t._referencePosUpdateTimer===r&&(t._referencePosUpdateTimer=null,t._referencePosUpdateQuery||t._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}},{key:"_doReferencePositionUpdateQuery",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n,i,a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null,e.next=3,this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);case 3:n=e.sent,t()||isNaN(n[0])||isNaN(n[1])||(a=(null!==(i=this._referencePosMapCoords.z)&&void 0!==i?i:0)*this._view.mapCoordsHelper.unitInMeters,this._referencePositionGeographic?(0,et.s)(this._referencePositionGeographic,n[0],n[1],a):this._referencePositionGeographic=(0,U.al)(n[0],n[1],a),this._referencePosChanged());case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_executePendingReferencePositionUpdate",value:function(){var e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}},{key:"_referencePosChanged",value:function(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePositionGeographic)||this._updateLighting(),this.notifyChange("referencePositionGeographic")}},{key:"_exceedsReferencePosDistThreshold",value:function(e){var t=this._referencePosMapCoords;if(null==t)return!0;var n=(0,wi.Z1)(t,e);return null==n||(0,$e.nn)(n,"meters").value>this._referencePointUpdateDistThreshold}},{key:"_cancelReferencePosUpdates",value:function(){var e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}},{key:"test",get:function(){}}]),n}($.Z.EventedAccessor);(0,f._)([(0,E.Cb)({type:Boolean,readOnly:!0})],Ci.prototype,"updating",null),(0,f._)([(0,E.Cb)()],Ci.prototype,"disableQueries",void 0),(0,f._)([(0,E.Cb)()],Ci.prototype,"_disableWeather",void 0),(0,f._)([(0,E.Cb)()],Ci.prototype,"weatherEnabled",null),(0,f._)([(0,E.Cb)()],Ci.prototype,"weatherVisible",null),(0,f._)([(0,E.Cb)()],Ci.prototype,"referencePositionGeographic",null),(0,f._)([(0,E.Cb)()],Ci.prototype,"_renderer",void 0),(0,f._)([(0,E.Cb)()],Ci.prototype,"_referencePositionGeographic",void 0),Ci=(0,f._)([(0,A.j)("esri.views.3d.environment.SceneViewEnvironmentManager")],Ci);var xi,Ti,Si,ki=new yi.GD,Mi=new yi.GD,Pi=new Date,Ri={hours:0,minutes:0,seconds:0},Ei=(0,U.al)(.22,.22,.33),Oi=(0,U.al)(.22,.22,.22),Ai=n(23470),Di=n(40885);!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(xi||(xi={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(Ti||(Ti={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(Si||(Si={}));var Zi=(0,s.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:xi.ALL,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ti.NONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Si.TUMBLE;(0,o.Z)(this,e),this.selection=t,this.interactionType=n,this.interactionFactor=i,this.interactionStartCamera=r,this.interactionDirection=a,this.tiltMode=s}));function Ii(e,t){return!!(e&t)}function Li(e,t,n,i,r,a){0!==e&&(n?(a.min=Math.min(a.min,t),a.max=Math.max(a.max,t)):null!=i?(a.min-=Math.max(0,(t-a.min)*(1-i)),a.max+=Math.max(0,(t-a.max)*(1-i))):r&&(a.min-=Math.max(0,t-a.min-r),a.max+=Math.max(0,t-a.max-r)))}var Ni=new Zi(xi.NONE);function Ui(e,t,n,i){return t=t||e.viewForward,(0,et.c)(i,t),(0,et.j)(i,i,Math.sign((0,et.m)(t,n))),i}var Hi=n(83281);function Fi(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ni;if(!Vi(e,n)||!e.state.constraints.altitude)return 0;var i=Bi(e.state.constraints.altitude,Gi);zi(e,n,i);var r=e.renderCoordsHelper.getAltitude(t.eye),a=(0,Se.uZ)(r,i.min,i.max)-r;return Math.abs(a)<=1e-6?0:a}function Vi(e,t){var n=e.state.constraints.altitude;return!(!e.state.isGlobal||!n)&&(t.interactionType!==Ti.TUMBLE||!Ii(t.selection,xi.TILT))}function zi(e,t,n){var i=t.interactionType;if(i!==Ti.NONE){var r=n.min,a=n.max,o=t.interactionStartCamera,s=t.interactionFactor;if(o){var l=i===Ti.TUMBLE||i===Ti.ZOOM,u=Fi(e,o),c=0===u?0:e.renderCoordsHelper.getAltitude(o.eye);n.min=r,n.max=a,Li(u,c,l,s,.05*c,n)}}}function qi(e,t,n,i){return e.renderCoordsHelper.worldUpAtPosition(t.eye,i),(0,et.j)(i,i,n),i}function Bi(e,t){return t.min=e.min,t.max=e.max,t}var Gi={min:0,max:0},ji=(0,U.Ue)(),Wi=(0,U.Ue)(),Xi=(0,U.Ue)(),Qi=(0,U.Ue)();function Yi(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ni;if(!e.state.isLocal)return 0;var i=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||i===1/0)return 0;tr.min=0,tr.max=i,Ji(e,n,tr);var r=Ki(e,t),a=tr.max-r;return a>=-1e-6?0:a}function Ji(e,t,n){var i=t.interactionType;if(i!==Ti.NONE){var r=n.min,a=n.max,o=t.interactionStartCamera,s=t.interactionFactor;if(o){var l=i===Ti.ZOOM||i===Ti.PAN,u=Yi(e,o),c=0===u?0:Ki(e,o);n.min=r,n.max=a,Li(u,c,l,s,.05*c,n)}}}function Ki(e,t){var n=e.pointsOfInterest.surfaceOrigin;return n.renderLocation?(0,et.p)(t.eye,n.renderLocation):0}function $i(e,t,n){return(0,et.E)(n,e.eye,t)}var er,tr={min:0,max:0},nr=(0,U.Ue)(),ir=(0,U.Ue)(),rr=(0,U.Ue)(),ar=(0,U.Ue)(),or=(0,U.Ue)(),sr=n(87532);function lr(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:er.EYE,i=e.state.constraints;if(!i.collision.enabled)return!1;var r=(0,sr.wH)(e,t.eye),a=e.renderCoordsHelper.getAltitude(t.eye),o=r+i.collision.elevationMargin;if(a>=o)return!1;var s=(0,et.l)(t.eye);if((0,et.f)(ur,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(cr,o,t.eye),n===er.EYE_AND_CENTER)t.center=(0,et.g)(ur,t.eye,ur);else if(n===er.EYE_AND_CENTER_SCALE){var l=(s-a+o)/s;t.center=(0,et.j)(ur,t.center,l)}return!0}!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(er||(er={}));var ur=(0,U.Ue)(),cr=(0,U.Ue)();function hr(e,t,n){e.worldUpAtPosition(t,dr),(0,et.f)(fr,n,t);var i=(0,et.l)(fr);return 0===i?0:(0,Se.ZF)((0,et.m)(fr,dr)/i)}var dr=(0,U.Ue)(),fr=(0,U.Ue)();function vr(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ni,r=arguments.length>4?arguments[4]:void 0;if(!e.state.constraints.tilt)return 0;var a=t.distance,o=e.state.constraints.tilt(a,Sr);return yr(e,n,o),i.interactionType===Ti.TUMBLE&&Ii(i.selection,xi.ALTITUDE)&&br(e,i.interactionStartCamera,o),n.tiltMode===Si.LOOK_AROUND||i.tiltMode===Si.LOOK_AROUND?_r(e,t,o,r):pr(e,t,o)}function pr(e,t,n){var i=hr(e.renderCoordsHelper,t.center,t.eye),r=i-(0,Se.uZ)(i,n.min,n.max);return mr(r)?r:0}function _r(e,t,n,i){switch(i&&(i.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,n,i){var r,a,o=function(e,t,n){var i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=i+(0,nt.Iu)(e.spatialReference).radius,a=e.renderCoordsHelper.intersectManifold(t.ray,i,xr);return n.eyeCenterDistance=t.distance,n.centerIsOnSurface=!1,null!=a?(n.eyeCenterDistance=(0,et.p)(t.eye,a),n.tiltAtCenter=hr(e.renderCoordsHelper,a,t.eye),n.centerIsOnSurface=!0):e.state.isLocal?n.tiltAtCenter=hr(e.renderCoordsHelper,t.center,t.eye):((0,Ai.e)((0,Ai.h)(Ai.t,r),t.ray,xr),n.eyeCenterDistance=(0,et.p)(t.eye,xr),n.tiltAtCenter=(0,Se.ZF)(-(0,et.m)(t.viewForward,(0,et.n)(xr,xr)))),n.radius=r,n.eyeRadius=(0,et.l)(t.eye),n.constraints=e.state.constraints,n}(e,t,kr),s=(0,Se.uZ)(o.tiltAtCenter,n.min,n.max);return mr(o.tiltAtCenter-s)?(o.centerIsOnSurface?(r=function(e){var t=e.constraints,n=e.eyeCenterDistance,i=e.tiltAtCenter,r=i,a=t.clampTilt(n,i),o=gr(e,a);if(t.clampTilt(o,i)===a)return a;for(var s=0;s<10&&mr(a-r);){var l=(r+a)/2,u=gr(e,l);mr(t.clampTilt(u,l)-l)?r=l:a=l,s++}return a}(o),a=function(e,t){var n=(0,Se.Kt)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),i=(0,Se.Kt)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?n-i:i-n}(o,r)):(r=o.constraints.clampTilt(o.eyeCenterDistance,o.tiltAtCenter),i&&r<Math.PI/2&&(i.requiresTwoSteps=!0,r=Math.PI/2-1e-5),a=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(o,r)),i&&(i.eyeCenterDistance=gr(o,r)),a):0}(e,t,n,i);case"local":return function(e,t,n,i){var r=hr(e.renderCoordsHelper,t.center,t.eye),a=(0,Se.uZ)(r,n.min,n.max),o=r-a;if(!mr(o))return 0;if(i){var s=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=e.renderCoordsHelper.getAltitude(t.eye)-s,u=Math.cos(a);Math.abs(u)>1e-4?i.eyeCenterDistance=l/u:i.eyeCenterDistance=t.distance}return o}(e,t,n,i)}}function mr(e){return Math.abs(e)>1e-9}function gr(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;var n=Math.PI-(0,Se.uZ)(t,0,Math.PI),i=(0,Se.Kt)(e.radius/e.eyeRadius*Math.sin(n)),r=Math.PI-n-i,a=Math.sin(r)/Math.sin(n);if(e.eyeRadius<e.radius&&a>1){var o=Math.PI-i,s=Math.PI-n-o;return Math.sin(s)/Math.sin(n)*e.eyeRadius}return a*e.eyeRadius}function yr(e,t,n){if(t.interactionType!==Ti.NONE){var i=t.interactionStartCamera,r=t.interactionFactor;if(i){var a=n.min,o=n.max,s=vr(e,i,Ni,t),l=0===s?0:hr(e.renderCoordsHelper,i.center,i.eye);n.min=a,n.max=o,t.interactionType===Ti.TUMBLE?(Ii(t.selection,xi.ALTITUDE)&&br(e,i,n),Li(s,l,!0,r,Tr,n)):Li(s,l,!1,r,Tr,n)}}}function br(e,t,n){var i=e.state.constraints;if(!e.state.isLocal&&i.altitude&&t){var r=(0,et.q)(t.center),a=Math.sqrt(r),o=t.distance,s=(0,nt.Iu)(e.spatialReference).radius,l=i.altitude.min+s,u=i.altitude.max+s,c=(l*l-o*o-r)/(-2*a*o),h=(u*u-o*o-r)/(-2*a*o);n.min=Math.max(n.min,Math.min(Math.PI-(0,Se.ZF)(h),n.max)),n.max=Math.min(n.max,Math.PI-(0,Se.ZF)(c))}}var wr=(0,U.Ue)(),Cr=(0,Ut.Ue)(),xr=(0,U.Ue)(),Tr=(0,Se.Vl)(5),Sr={min:0,max:0},kr={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Mr={eyeCenterDistance:0,requiresTwoSteps:!1},Pr=n(64006);function Rr(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Dr,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);for(var a=!1,o=0;o<Zr;o++){var s,l=0,u=(0,i.Z)(Ar);try{for(u.s();!(s=u.n()).done;){var c=s.value;if(Ii(n.selection,c.type)){var h=Math.abs(c.error(e,r,n));c.apply(e,r,n)&&(a=!0,l+=h)}}}catch(v){u.e(v)}finally{u.f()}if(0===l)break}var d=Ii(n.selection,xi.COLLISION),f=Er(n.interactionType,e);return d&&lr(e,r,f)&&(a=!0),a&&r.computeUp(e.state.viewingMode),a}function Er(e,t){switch(e){case Ti.PAN:return er.EYE_AND_CENTER;case Ti.ASCEND:return t.state.isGlobal?er.EYE_AND_CENTER_SCALE:er.EYE_AND_CENTER;default:return er.EYE}}function Or(e){var t=Math.min(1,e/150);return(0,Pr.FT)(t)}var Ar=[{type:xi.TILT,error:function(e,t,n){return vr(e,t,n)*t.distance},apply:function e(t,n,i){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];Mr.eyeCenterDistance=0,Mr.requiresTwoSteps=!1;var a=vr(t,n,i,Ni,Mr);if(0===a)return!1;switch((0,Nt.Us)(Cr,-a,n.viewRight),i.tiltMode){case Si.LOOK_AROUND:(0,et.h)(wr,n.viewForward,Cr),(0,et.j)(wr,wr,Mr.eyeCenterDistance),n.center=(0,et.g)(xr,n.eye,wr);break;case Si.TUMBLE:(0,et.f)(wr,n.center,n.eye),(0,et.h)(wr,wr,Cr),n.eye=(0,et.f)(xr,n.center,wr);break;default:(0,Fe.Bg)(i.tiltMode)}return n.up=(0,et.h)(xr,n.up,Cr),!Mr.requiresTwoSteps||!r||e(t,n,i,!1)}},{type:xi.ALTITUDE,error:Fi,apply:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ni,i=Fi(e,t,n);if(0===i)return!1;var r=e.renderCoordsHelper,a=r.getAltitude(t.eye)+i,o=Ui(t,n.interactionDirection,qi(e,t,Math.sign(i),Wi),ji),s=(0,et.c)(Xi,t.viewForward),l=r.intersectInfiniteManifold((0,Di.re)(t.eye,o),a,Qi);return t.eye=null!=l?l:r.setAltitude(Qi,a,t.eye),t.center=(0,Hi.W8)(Qi,t.eye,s,t.center),!0}},{type:xi.DISTANCE,error:Yi,apply:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ni,i=Yi(e,t,n);if(0===i)return!1;var r=e.pointsOfInterest.surfaceOrigin;if(!r.renderLocation)return!1;var a=Ki(e,t)+i,o=(0,et.c)(nr,t.eye),s=Ui(t,n.interactionDirection,$i(t,r.renderLocation,ar),rr);if(!(0,Ai.i)((0,Ai.k)(r.renderLocation,a),(0,Di.re)(t.eye,s),or))return!1;t.eye=or;var l=(0,et.f)(ir,t.eye,o);t.center=(0,et.g)(or,t.center,l);var u=e.renderCoordsHelper.getAltitude(t.center),c=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,u,or);return null!=c&&(t.center=c),!0}}],Dr=new Zi,Zr=5,Ir=n(21389),Lr=function(){function e(t){(0,o.Z)(this,e),this.viewingMode=t,this.center=(0,U.Ue)(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=(0,U.d9)(Gr),this._fov=55,this._size=1}return(0,s.Z)(e,[{key:"pitch",get:function(){return this._pitch}},{key:"yaw",get:function(){return this._yaw}},{key:"distance",get:function(){return this._distance}},{key:"fov",get:function(){return this._fov}},{key:"size",get:function(){return this._size}},{key:"pixelsPerPanAtZoom",value:function(e){return this._size/2/(this._zoomToPanScale*e)}},{key:"zoomAtPixelsPerPan",value:function(e){return this._size/2/(this._zoomToPanScale*e)}},{key:"pixelsPerRotateAtZoom",value:function(){var e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}},{key:"compareTo",value:function(e,t){if(this.viewingMode===he.JY.Global){var n=((0,et.l)(this.center)+(0,et.l)(e.center))/2;t.pan=(0,Me.EU)(this.center,e.center)*n}else t.pan=(0,et.p)(this.center,e.center);var i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);var r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}},{key:"interpolate",value:function(e,t,n){this.viewingMode===he.JY.Global?(0,Me.ZA)(e.center,t.center,n.pan,this.center):(0,et.o)(this.center,e.center,t.center,n.pan),this._distance=isFinite(t.distance)?(0,Se.t7)(e.distance,t.distance+n.zoomOffset,n.zoom):e.distance,this._pitch=(0,Se.t7)(e.pitch,t.pitch,n.rotate);var i=e._yaw,r=t._yaw;Math.abs(r-i)>=Math.PI&&(i+=2*(i<r?1:-1)*Math.PI),this._yaw=(0,Se.t7)(i,r,n.rotate),this._fov=(0,Se.t7)(e.fov,t.fov,n.fov)}},{key:"copyFrom",value:function(e){(0,et.c)(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,(0,et.c)(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}},{key:"copyFromRenderCamera",value:function(e){var t=this._lookAtOrientation(e.center,Wr);(0,et.c)(this.center,e.center),(0,et.f)(Vr,e.center,e.eye),(0,et.t)(Vr,Vr,t),(0,et.t)(zr,e.up,t),this._distance=(0,et.l)(Vr),0!==this._distance&&(Vr[0]/=this._distance,Vr[1]/=this._distance,Vr[2]/=this._distance),this._pitch=this._eyeUpToPitch(Vr),this._yaw=function(e,t){var n=qr;return Math.abs(t[2])<.5?((0,et.c)(n,t),e[2]>0&&(0,et.j)(n,n,-1)):(0,et.c)(n,e),(0,et.b)(Hr,n,Br),(0,et.n)(Hr,Hr),(0,Me.EU)(jr,Hr,Br)}(Vr,zr),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}},{key:"copyToRenderCamera",value:function(e){var t=this._lookAtOrientation(this.center,Wr);(0,Lt.p4)(t,t),this._axisAngleVec3(jr,this._pitch-Math.PI/2,Gr,Vr),this._axisAngleVec3(Br,this._yaw,Vr,Vr),this._axisAngleVec3(jr,this._pitch-Math.PI/2,Br,zr),this._axisAngleVec3(Br,this._yaw,zr,zr),(0,et.j)(Vr,Vr,this._distance),(0,et.t)(Vr,Vr,t),(0,et.t)(zr,zr,t),e.center=this.center,e.eye=(0,et.f)(Vr,this.center,Vr),e.up=zr,e.fov=this._fov}},{key:"_axisAngleVec3",value:function(e,t,n,i){var r=Math.cos(t),a=Math.sin(t);return(0,et.j)(Ur,n,r),(0,et.b)(Hr,e,n),(0,et.j)(Hr,Hr,a),(0,et.j)(Fr,e,(1-r)*(0,et.m)(e,n)),(0,et.g)(i,(0,et.g)(i,Ur,Hr),Fr)}},{key:"_lookAtOrientation",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Ir.Ue)();return this._upAtLookAt(e,Fr),(0,et.b)(Ur,this.direction,Fr),(0,et.n)(Ur,Ur),0===Ur[0]&&0===Ur[1]&&0===Ur[2]&&(0,et.c)(Ur,jr),(0,et.b)(Hr,Fr,Ur),(0,et.n)(Hr,Hr),t[0]=Ur[0],t[1]=Hr[0],t[2]=Fr[0],t[3]=Ur[1],t[4]=Hr[1],t[5]=Fr[1],t[6]=Ur[2],t[7]=Hr[2],t[8]=Fr[2],t}},{key:"_upAtLookAt",value:function(e,t){return this.viewingMode===he.JY.Local?(0,et.c)(t,Br):(0,et.n)(t,e)}},{key:"_eyeUpToPitch",value:function(e){return Math.PI-(0,Me.EU)(Br,e)}}]),e}();var Nr,Ur=(0,U.Ue)(),Hr=(0,U.Ue)(),Fr=(0,U.Ue)(),Vr=(0,U.Ue)(),zr=(0,U.Ue)(),qr=(0,U.Ue)(),Br=U.eG,Gr=U.IO,jr=U.E9,Wr=(0,Ir.Ue)(),Xr=n(81296),Qr=n(90973),Yr=function(){function e(t){(0,o.Z)(this,e),this.currentTime=(0,Fn.HA)(0),this._animation=new Qr.f((function(){return new Lr(t)})),this._current=new Lr(t)}return(0,s.Z)(e,[{key:"finished",get:function(){return this.currentTime>=this._animation.time}},{key:"time",get:function(){return this._animation.time}},{key:"update",value:function(e,t,n){var i=this._animation.definition,r=i.source,a=i.target,o=(0,et.f)(Jr,t.center,e.center),s=(0,et.l)(o);s>=1e-5?(o[0]/=s,o[1]/=s,o[2]/=s):(o[0]=0,o[1]=1,o[0]=0),(0,et.c)(r.direction,o),(0,et.c)(a.direction,o),r.copyFromRenderCamera(e),a.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,a,n),this.currentTime=(0,Fn.HA)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}},{key:"cameraAt",value:function(e,t){return this._animation.cameraAt(e,this._current),t=t||new Xr.Z,this._current.copyToRenderCamera(t),t}},{key:"step",value:function(e,t){return this.finished||(this.currentTime=(0,Fn.HA)(this.currentTime+(0,Fn.up)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}]),e}(),Jr=(0,U.Ue)();!function(e){e[e.Ready=0]="Ready",e[e.Rejected=1]="Rejected",e[e.Running=2]="Running",e[e.Stopped=3]="Stopped",e[e.Finished=4]="Finished"}(Nr||(Nr={}));var Kr=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).state=Nr.Ready,i}return(0,s.Z)(n,[{key:"active",get:function(){return this.state===Nr.Running}},{key:"isInteractive",get:function(){return!1}},{key:"canStop",get:function(){return!1}},{key:"stopController",value:function(){return!!this.canStop&&(this.state=Nr.Stopped,!0)}},{key:"finishController",value:function(){this.state=Nr.Finished}},{key:"steppingFinished",get:function(){return!1}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],Kr.prototype,"view",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Kr.prototype,"active",null),(0,f._)([(0,E.Cb)()],Kr.prototype,"state",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Kr.prototype,"isInteractive",null);var $r=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._asyncResult=null,e}return(0,s.Z)(n,[{key:"canStop",get:function(){return!0}},{key:"asyncResult",get:function(){return this._asyncResult},set:function(e){this._asyncResult&&(this._asyncResult.reject((0,S.zE)()),this._asyncResult=null),this.state===Nr.Finished||this.state===Nr.Stopped?((0,x.O3)(e),this.state===Nr.Finished?e.resolve():e.reject((0,S.zE)())):this._asyncResult=e}},{key:"onControllerStart",value:function(){var e=this;this.state=Nr.Running,null!=this.viewAnimation&&this.viewAnimation.when((function(){return e.updateStateFromViewAnimation()}),(function(){return e.updateStateFromViewAnimation()}))}},{key:"updateStateFromViewAnimation",value:function(){null==this.viewAnimation||this.state!==Nr.Ready&&this.state!==Nr.Running||(this.viewAnimation.state===ce.Z.State.FINISHED?this.finish():this.viewAnimation.state===ce.Z.State.STOPPED&&(this.state=Nr.Stopped))}},{key:"onControllerEnd",value:function(){null==this.viewAnimation||this.viewAnimation.done||(this.state===Nr.Finished?this.viewAnimation.finish():this.state===Nr.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Nr.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,S.zE)()))}},{key:"finish",value:function(){this.finishController()}}]),n}(Kr=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.CameraController")],Kr));$r=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.AnimationController")],$r);var ea=n(88153),ta=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).mode="interaction",i._hasTarget=!1,i}return(0,s.Z)(n,[{key:"intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"initialize",value:function(){this.animation=new Yr(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new ce.Z}},{key:"isInteractive",get:function(){return"interaction"===this.mode}},{key:"begin",value:function(e,t){this._hasTarget=!0;var n=this.animationSettings(t);na.copyFrom(this.view.state.camera);var i=(0,ea.Z8)(this.view.state.viewingMode);this.intersectionHelper.intersectRay(na.ray,i,ia)&&(na.center=ia),this.animation.update(na,e,n),this.animation.finished&&this.finish()}},{key:"finish",value:function(){this.animation.currentTime=this.animation.time,(0,u.Z)((0,c.Z)(n.prototype),"finish",this).call(this)}},{key:"steppingFinished",get:function(){return this._hasTarget&&this.animation.finished}},{key:"stepController",value:function(e,t){this._hasTarget&&this.animation.step(e,t)}},{key:"onControllerEnd",value:function(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),(0,u.Z)((0,c.Z)(n.prototype),"onControllerEnd",this).call(this,e)}},{key:"animationSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,He.Z)((0,He.Z)({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},e),{},{easing:"string"==typeof e.easing?Pr.q8[e.easing]:e.easing})}}]),n}($r);(0,f._)([(0,E.Cb)({constructOnly:!0})],ta.prototype,"mode",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ta.prototype,"isInteractive",null),ta=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.PointToPointAnimationController")],ta);var na=new Xr.Z,ia=(0,U.Ue)(),ra=n(17768),aa=n(68700),oa=n(50894),sa=n(40927),la=n(51378);function ua(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fa;return[e[0],e[1],e[2],e[3]]}function ca(e,t){return ha(e[0],e[1],e[2],t,la.o6.get())}function ha(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ua();return r[0]=e,r[1]=t,r[2]=n,r[3]=i,r}function da(e,t,n){return(0,et.b)(n,e,t),(0,et.n)(n,n),n[3]=(0,sa.EU)(e,t),n}var fa=[0,0,1,0],va=((0,oa.Ue)(),(0,oa.Ue)(),n(55652)),pa=n(81703);function _a(e,t,n,i){var r=(0,pa.iE)(t,n,ga);return(0,Ai.i)(e,r,i)}var ma,ga=(0,Di.Ue)(),ya=n(76783);!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(ma||(ma={}));var ba=[1,3e8],wa=1508e5,Ca={exclude:new Set([ya.xX])};function xa(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function Ta(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Sa(e,t,n){var i=(0,Nt.Us)(la.MP.get(),n[3],n);null==i||(0,Nt.I6)(i,Ut.Wd)||((0,et.f)(go,e.eye,t),(0,et.h)(go,go,i),e.eye=(0,et.g)(go,go,t),(0,et.f)(go,e.center,t),(0,et.h)(go,go,i),e.center=(0,et.g)(go,go,t),e.up=(0,et.h)(go,e.up,i))}function ka(e,t,n,i){return(0,va.BR)(e,(0,pa.iE)(t,n,xo),i)}function Ma(e,t,n,i){var r=la.WM.get(),a=1-n;(0,et.f)(r,t,e.eye);var o=(0,et.l)(r),s=o*(1-a);a>=0&&s<i&&(a=-((s=i)-o)/o),Math.abs(o-s)<1e-6||((0,et.j)(r,r,a),e.eye=(0,et.g)(go,e.eye,r),e.center=(0,et.o)(go,e.center,t,a))}function Pa(e,t,n){t.getScreenCenter(Ea),_a(e,t,Ea,go)&&(t.center=go);var i=t.distance,r=i*n;if(!(Math.abs(i-r)<1e-6)){var a=(0,et.j)(la.WM.get(),t.viewForward,r);t.eye=(0,et.f)(go,t.center,a)}}var Ra,Ea=(0,P.s1)();function Oa(e,t){(0,et.s)(t,0,0,0);var n,r=(0,i.Z)(e);try{for(r.s();!(n=r.n()).done;){var a=n.value;(0,et.g)(t,t,a)}}catch(o){r.e(o)}finally{r.f()}(0,et.j)(t,t,1/e.length)}function Aa(e,t,n,i){return Math.sin(e/(0,et.l)(t))*(n+i.radius)}function Da(e,t,n,i){return Aa(Math.PI/2,t,n,i)+(e-Math.PI/2)}!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(Ra||(Ra={}));var Za={Elevation:3e4,Angle:(0,Se.Vl)(16)},Ia=.95,La=(0,Se.Vl)(18),Na=45,Ua=(0,Se.Vl)(80);function Ha(e,t,n,i,r,a){var o=(0,U.Ue)(),s=(0,Ai.c)(),l=!0,u=!0;return e.intersectScreen(n,o,a)?s[3]=(0,et.l)(o):(u=!1,t.aboveGround&&r!==ma.Ellipsoid?s[3]=Math.max((0,et.l)(t.center),.9*i.radius):s[3]=(0,et.l)(t.eye)-t.relativeElevation,r===ma.Silhouette?qa(s,t,n,o):l=_a(s,t,n,o)),{sphere:s,scenePickPoint:l?o:null,hasGeometryIntersection:u}}function Fa(e,t,n,i){var r=e.relativeElevation;if(r>Za.Elevation&&"global"===i)return Ra.Horizontal;(0,pa.iE)(e,t,To);var a=Math.sign(r),o=n.worldUpAtPosition(e.eye,go);return-a*(0,et.m)(o,To.direction)<Math.sin(Za.Angle)*(0,et.l)(To.direction)?Ra.Vertical:Ra.Horizontal}function Va(e,t,n){(0,et.f)(za,n,t),e.eye=(0,et.f)(go,e.eye,za),e.center=(0,et.f)(go,e.center,za)}var za=(0,U.Ue)();function qa(e,t,n,i){var r=(0,pa.iE)(t,n,xo);return null!=r&&((0,Ai.e)(e,r,Ba),(0,Ai.i)(e,r,i)?!((0,et.a)(Ba,r.origin)<(0,et.a)(i,r.origin))||((0,et.c)(i,Ba),!1):((0,et.f)(Ga,t.eye,t.center),(0,et.n)(Ga,Ga),(0,va.Oy)(Ga,-(0,et.m)((0,et.n)(Ga,Ga),Ba),ja),(0,va.BR)(ja,r,i),!1))}var Ba=(0,U.Ue)(),Ga=(0,U.Ue)(),ja=(0,va.Ue)();function Wa(e,t,n,i,r,a){var o=0;if((0,et.b)(wo,e,t),(0,et.f)(yo,e,t),(0,et.l)(e)<=r||!i.aboveGround){(0,et.b)(n,yo,i.eye);var s=(0,et.m)(e,t)/((0,et.l)(e)*(0,et.l)(t));if(s<.9999)o=(0,Se.ZF)(s);else{var l=(0,et.l)((0,et.b)((0,U.Ue)(),e,t))/((0,et.l)(e)*(0,et.l)(t));o=(0,Se.Kt)(l)}var u=Math.cos((0,Se.uZ)(ra.Q4.normalize((0,Se.Vl)(a)),0,Ua));o=-o-Math.max(0,(0,et.l)(t)-r)/(u*r)}else(0,et.f)(Xa,i.eye,i.center),(0,et.b)(n,yo,Xa),o=-(0,et.l)(yo)/r;return(0,et.n)(n,n),(0,et.j)(n,n,(0,et.l)(wo)),o}var Xa=(0,U.Ue)();function Qa(e,t,n,i){var r,a=Math.cos((0,Se.uZ)(ra.Q4.normalize((0,Se.Vl)(i)),0,Ua));return r=t>n?-(t-n)/(a*n):t<-n?Math.PI-(t+n)/(a*n):(0,Se.ZF)(t/n),((e>n?-(e-n)/(a*n):e<-n?Math.PI-(e+n)/(a*n):(0,Se.ZF)(e/n))-r)*n}function Ya(e,t,n,i,r,a,o,s,l,u){(0,et.b)(wo,e,t),(0,j.Tz)(a.up,a.eye,oo,so,lo),(0,j.Tz)([0,0,1],a.eye,io,ro,ao),(0,et.c)(n,ro),(0,et.c)(i,io),(0,et.n)(n,n),(0,et.j)(n,n,(0,et.l)(wo)),(0,j.yS)(e,(0,et.n)(so,so),(0,et.n)(lo,lo),(0,et.n)(oo,oo),uo),(0,j.yS)(t,so,lo,oo,co),function(e,t,n,i,r,a,o,s,l,u){var c=Qa(e[2],t[2],a[3],s),h=l?Qa(e[0],t[0],a[3],180):t[0]-e[0],d=Math.sin(o)*h-Math.cos(o)*c,f=Math.cos(o)*h+Math.sin(o)*c;(0,et.n)(go,r);var v=l?d/Math.sqrt(Math.abs(Math.pow(a[3],2)-Math.pow((0,et.m)(n,go),2))):d/a[3],p=f/Math.sqrt(Math.abs(Math.pow(a[3],2)-Math.pow((0,et.m)(n,i),2)));(0,at.t8)(u,v,p)}(uo,co,e,io,ro,o,s,l,u,r)}function Ja(e,t,n,i,r,a,o){(0,Nt.Us)(vo,r,i),(0,Nt.Us)(po,o,a),(0,Nt.Jp)(_o,vo,po),(0,et.f)(t,e,n),(0,et.h)(t,t,_o),(0,et.g)(t,t,n)}function Ka(e,t,n,i,r,a){(0,Nt.Us)(vo,i,n),(0,Nt.Us)(po,a,r),(0,Nt.Jp)(_o,vo,po),(0,et.f)(go,e.eye,t),(0,et.h)(go,go,_o),e.eye=(0,et.g)(go,go,t),(0,et.f)(go,e.center,t),(0,et.h)(go,go,_o),e.center=(0,et.g)(go,go,t),(0,et.f)(go,e.up,t),(0,et.h)(go,go,_o),e.up=(0,et.g)(go,go,t)}function $a(e,t,n,i,r,a){return(Math.abs(i)>Math.PI-La||Math.abs(i)<La)&&(Math.abs(e[2])<n*Ia||Math.abs(t)>n)&&a.aboveGround&&r<Na}function eo(e,t,n,i,r,a){if(a)da(n,i,fo),Sa(t,(0,Ai.g)(e),fo);else{var o=Wa(n,i,Co,t,e[3],r);Sa(t,(0,Ai.g)(e),ca(Co,o))}}function to(e,t,n,i,r,a,o){var s,l=o?20:1;(0,et.c)(mo,i),bo.copyFrom(t);for(var u=0;u<l&&(0,et.a)(n,mo)>1e-12&&(s=(0,et.a)(n,mo),Ya(n,mo,ro,io,ho,bo,e,r,a,o),Ka(bo,(0,Ai.g)(e),io,ho[1],ro,ho[0]),Ja(mo,mo,(0,Ai.g)(e),io,ho[1],ro,ho[0]),(0,et.a)(n,mo)<s||0===u);u++)t.copyFrom(bo)}function no(e,t,n,i,r,a,o,s,l){$a(e.center,(0,et.m)(e.up,e.center),(0,et.l)(e.center),-ra.Q4.normalize((0,Se.Vl)(a)),o,t)?function(e,t,n,i,r,a){var o=e.eye;(0,j.Tz)([0,0,1],o,io,ro,ao);var s=t.translation[0]*n.pan,l="zoom"===r.mode?0:t.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-Math.pow((0,et.m)(e.center,io),2)/Math.pow((0,et.l)(e.center),2))),.5),c=(Math.sin(a)*l+Math.cos(a)*s)/u,h=-Math.cos(a)*l+Math.sin(a)*s;switch((0,Nt.U1)(i.pan.matrix,i.pan.matrix,c,io),i.pan.enabled=!0,r.mode){case"pan":(0,Nt.U1)(i.pan.matrix,i.pan.matrix,h,ro),i.pan.enabled=!0;break;case"zoom":i.zoom=-t.translation[1]*n.zoom}}(t,n,i,s,l,-ra.Q4.normalize((0,Se.Vl)(r))):function(e,t,n,i,r){var a=e.eye,o=e.viewRight,s=(0,et.b)(la.WM.get(),o,a),l=t.translation[0]*n.pan;switch(0!==l&&((0,Nt.U1)(i.pan.matrix,i.pan.matrix,-l,s),i.pan.enabled=!0),r.mode){case"pan":var u=t.translation[1]*n.pan;0!==u&&((0,Nt.U1)(i.pan.matrix,i.pan.matrix,u,o),i.pan.enabled=!0);break;case"zoom":i.zoom=-t.translation[1]*n.zoom}}(t,n,i,s,l)}var io=(0,U.Ue)(),ro=(0,U.Ue)(),ao=(0,U.Ue)(),oo=(0,U.Ue)(),so=(0,U.Ue)(),lo=(0,U.Ue)(),uo=(0,U.Ue)(),co=(0,U.Ue)(),ho=(0,ut.Ue)(),fo=ua(),vo=(0,Ut.Ue)(),po=(0,Ut.Ue)(),_o=(0,Ut.Ue)(),mo=(0,U.Ue)(),go=(0,U.Ue)(),yo=(0,U.Ue)(),bo=new Xr.Z,wo=(0,U.Ue)(),Co=(0,U.Ue)(),xo={origin:(0,U.Ue)(),direction:(0,U.Ue)()},To={origin:(0,U.Ue)(),direction:(0,U.Ue)()},So=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._zoomLocation=(0,U.Ue)(),e._tmpCamera=new Xr.Z,e._tmpViewDir=(0,U.Ue)(),e._tmpRayDir={origin:(0,U.Ue)(),direction:(0,U.Ue)()},e._targetOnSphere=(0,U.Ue)(),e._tmpCenter=(0,U.Ue)(),e._beginCamera=new Xr.Z,e._constraintOptions=new Zi(xi.ALL_EXCEPT_COLLISION,Ti.ZOOM,null,e._beginCamera),e._sphere=(0,Ai.c)(),e}return(0,s.Z)(n,[{key:"initialize",value:function(){this._intersector=(0,ea.Z8)(this.view.state.viewingMode)}},{key:"zoomStep",value:function(e,t){if(this.active){var n=this.view.state;this.animation.finished?this._beginCamera.copyFrom(n.camera):this.animation.cameraAt(1,this._beginCamera);var i=!1,r=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?Ca:{})&&(i=e>0,r=!0),this._tmpCamera.copyFrom(n.camera),i?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,et.c)(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,r),this.begin(this._tmpCamera)}}},{key:"animationSettings",value:function(){return{duration:(0,Fn.HA)(600),easing:Pr.cZ}}},{key:"_updateCamera",value:function(e,t,n,i,r){var a=Fa(e,i,this.view.renderCoordsHelper,this.view.viewingMode),o=Math.abs(this.view.camera.position.z);(0,et.n)(Mo,e.eye),(0,et.j)(Mo,Mo,-1),(0,pa.iE)(e,i,this._tmpRayDir),(0,et.n)(this._tmpRayDir.direction,this._tmpRayDir.direction);var s=(0,Se.uZ)(Math.min(8,1/Math.abs((0,et.m)(Mo,this._tmpRayDir.direction)))*o,200,wa);if(a===Ra.Horizontal){var l=Math.pow(.6,t);this._sphere[3]=(0,et.l)(n),(0,et.f)(this._tmpViewDir,e.center,e.eye);var u=Math.min((0,et.l)(this._tmpViewDir),s),c=u*l;if(l<=1&&c<4&&(l=(c=4)/u),Math.abs(u-c)<1e-6)return;var h=(0,et.l)(e.center);if(this._sphere[3]!==h){var d=this._sphere[3]+l*(h-this._sphere[3]);e.center=(0,et.j)(ko,e.center,d/h)}(0,et.j)(this._tmpViewDir,this._tmpViewDir,-l),e.eye=(0,et.g)(ko,e.center,this._tmpViewDir),Rr(this.view,e,this._constraintOptions),(0,et.a)(n,e.center)>1e-12&&_a(this._sphere,e,i,this._targetOnSphere)&&function(e,t,n,i,r,a,o){$a(n,(0,et.m)(t.up,n),e[3],-ra.Q4.normalize((0,Se.Vl)(r)),a,t)?to(e,t,n,i,-ra.Q4.normalize((0,Se.Vl)(r)),a,o):eo(e,t,n,i,a,o)}(this._sphere,e,n,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{var f=Math.pow(.6,Math.abs(t)),v=t>0?1:-1;(0,et.f)(this._tmpViewDir,n,e.eye);var p=(0,et.l)(this._tmpViewDir),_=this.view._stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,60),m=null!=_?_:s;m=r&&t>0?Math.min(m,p):m,(0,et.j)(this._tmpRayDir.direction,this._tmpRayDir.direction,m),(0,et.g)(n,this._tmpRayDir.origin,this._tmpRayDir.direction);var g=m*f,y=Math.max(4,1.01*e.nearFar[0]);if(t>0&&g<y&&(f=(g=y)/m),Math.abs(m-g)<1e-6)return;(0,et.j)(this._tmpRayDir.direction,this._tmpRayDir.direction,v*(1-f)),e.eye=(0,et.g)(ko,e.eye,this._tmpRayDir.direction),e.center=(0,et.g)(ko,e.center,this._tmpRayDir.direction)}lr(this.view,e)}}]),n}(ta);So=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],So);var ko=(0,U.Ue)(),Mo=(0,U.Ue)(),Po=n(39261),Ro=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._zoomLocation=(0,U.Ue)(),e._tmpCamera=new Xr.Z,e._tmpRayDir=(0,U.Ue)(),e._tmpCenter=(0,U.Ue)(),e._beginCamera=new Xr.Z,e._constraintOptions=new Zi(xi.ALL,Ti.ZOOM,null,e._beginCamera),e}return(0,s.Z)(n,[{key:"zoomStep",value:function(e,t){if(this.active){var n=this.view.state;this.animation.finished?this._beginCamera.copyFrom(n.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(n.camera);var i=(0,ea.Z8)(this.view.state.viewingMode),r=!1;e>0?(r=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,0===this.view.map.ground.opacity?Ca:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,i,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,i,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,et.c)(this._zoomLocation,this._tmpCamera.center);var a=Math.pow(.6,e),o=this.view._stage.renderView.getMinimalDepthForArea((0,Po.$L)(this.view),t[0],t[1],this.view.state.camera,60);(0,et.f)(Ao,this._tmpCamera.eye,this._zoomLocation),(0,et.n)(Ao,Ao);var s=(0,Se.uZ)(Math.min(8,1/Math.abs((0,et.m)(Oo,Ao)))*Math.abs(this.view.camera.position.z),200,wa);if(o=null!=o?o:s){var l=(0,U.Ue)();(0,et.f)(l,this._zoomLocation,this._tmpCamera.eye),(o<(0,et.l)(l)||!r)&&((0,et.n)(l,l),(0,et.g)(this._zoomLocation,this._tmpCamera.eye,(0,et.j)(l,l,o)))}this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}}},{key:"animationSettings",value:function(){return{duration:(0,Fn.HA)(600),easing:Pr.cZ}}},{key:"_updateCamera",value:function(e,t,n){(0,et.f)(this._tmpRayDir,n,e.eye);var i=(0,et.l)(this._tmpRayDir),r=i*t,a=t<=1,o=Math.max(4,1.01*e.nearFar[0]);0!==r&&(a&&r<o&&(t=(r=o)/i),Math.abs(i-r)<1e-6||((0,et.j)(this._tmpRayDir,this._tmpRayDir,t),e.eye=(0,et.f)(Eo,n,this._tmpRayDir),e.center=(0,et.o)(Eo,e.center,n,1-t),Rr(this.view,e,this._constraintOptions)))}}]),n}(ta);Ro=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.ZoomStepControllerLocal")],Ro);var Eo=(0,U.Ue)(),Oo=(0,U.al)(0,0,1),Ao=(0,U.Ue)(),Do=n(45371),Zo=n(41722),Io=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i){var r;return(0,o.Z)(this,n),(r=t.call(this,!0))._view=e,r.registerIncoming("double-click",i,(function(e){return r._handleDoubleClick(e)})),r}return(0,s.Z)(n,[{key:"_handleDoubleClick",value:function(e){var t=e.data;if((0,Zo.h)(t,"primary")){var n=this._view.state.isGlobal?new So({view:this._view,mode:"animation"}):new Ro({view:this._view,mode:"animation"});this._view.state.switchCameraController(n),n.zoomStep(Math.log(.5)/Math.log(.6),(0,P.s1)(t.x,t.y)),e.stopPropagation()}}}]),n}(Do.a),Lo=n(53866),No=n(848),Uo=n(68860);var Ho=function(){function e(t,n){(0,o.Z)(this,e),this._elevationProvider=t,this._referenceEllipsoid=(0,nt.Iu)(n),this._unitInMeters=(0,Uo.c9)(n,this._referenceEllipsoid.metersPerDegree)}return(0,s.Z)(e,[{key:"compute",value:function(e,t,n,i,r){var a;r||(r={near:0,far:0});var o=e[2]*this._unitInMeters,s=o,l=o-i,u=null===(a=this._elevationProvider)||void 0===a?void 0:a.visibleElevationBounds;u&&(o=l>=0?s-this._unitInMeters*u.min:this._unitInMeters*u.max-s);var c={x:(n=null!=n?n:new Lo.Z({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-n.xmin,y:n.ymax-n.ymin,z:4*Math.max(n.xmax-n.xmin,n.ymax-n.ymin)},h=Math.max(c.x,c.y,c.z);(0,et.f)(Wo,t,e),jo[0]=Wo[0]>0?n.xmax:n.xmin,jo[1]=Wo[1]>0?n.ymax:n.ymin,jo[2]=Wo[2]>0?h/2:-h/2,(0,et.f)(jo,jo,e),(0,et.n)(Wo,Wo);var d=1.1*(0,et.m)(jo,Wo)*this._unitInMeters,f=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),v=Math.max(n.xmax-n.xmin,n.ymax-n.ymin),p=v*Bo*this._unitInMeters,_=v*Go*this._unitInMeters,m=Math.pow((0,Se.uZ)((o-_)/(p-_),0,1),3),g=Math.min((0,Se.t7)(f,d,m),f)*Math.max(Math.log(Math.abs(l)),1);return Vo(Math.min(g,Math.max(34064e4,h))/this._unitInMeters,zo,this._unitInMeters,r)}}]),e}(),Fo=function(){function e(t){(0,o.Z)(this,e),this._referenceEllipsoid=(0,nt.Iu)(t)}return(0,s.Z)(e,[{key:"compute",value:function(e,t,n,i,r){r||(r={near:0,far:0});var a=(0,et.l)(e),o=a-this._referenceEllipsoid.radius,s=this._referenceEllipsoid.radius+Math.min(0,i),l=Math.abs(o-i),u=Math.max(l,Math.abs(o)),c=Math.sqrt(u*(u+2*s)),h=a+this._referenceEllipsoid.radius;return Vo(1.2*(0,Se.t7)(c,h,(0,lt.yx)(u)),(0,Se.uZ)(2e4-(Math.log(u)-7.983)/9.011*19900,100,2e4),1,r)}}]),e}();function Vo(e,t,n,i){var r=qo/n;return e/t>r?(i.far=e,i.near=i.far/t):(i.near=r,i.far=i.near*t),i}var zo=2e4,qo=2,Bo=.001,Go=1e-4,jo=(0,U.Ue)(),Wo=(0,U.Ue)(),Xo=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){return(0,o.Z)(this,n),t.call(this,e)}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles(this.view.basemapTerrain.on("elevation-change",(function(t){return e._handleElevationChangeEvent(t)})))}},{key:"_handleElevationChangeEvent",value:function(e){if(!this.view.state.cameraController){var t=this.view.state.camera;null!=e.spatialReference&&(0,sr.lM)(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}}},{key:"_applyToCurrentCamera",value:function(){var e=this;this.view.state.updateCamera((function(t){return lr(e.view,t,er.EYE_AND_CENTER)}))}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],Xo.prototype,"view",void 0),Xo=(0,f._)([(0,A.j)("esri.views.3d.state.SurfaceCollisionConstraint")],Xo);var Qo=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).nearFarHeuristic=function(e,t,n){return e===he.JY.Global?new Fo(n):new Ho(t,n)}(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference),i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([(0,k.watch)((function(){var t,n,i,r;return[null===(t=e.view.constraints)||void 0===t||null===(n=t.clipDistance)||void 0===n?void 0:n.near,null===(i=e.view.constraints)||void 0===i||null===(r=i.clipDistance)||void 0===r?void 0:r.far]}),(function(){return e._clipDistanceNearFarChanged()})),(0,k.watch)((function(){var t,n;return null===(t=e.view.constraints)||void 0===t||null===(n=t.clipDistance)||void 0===n?void 0:n.mode}),(function(){return e._updateNearFar()})),this.view.state.events.on("before-camera-change",(function(t){return e._updateCameraNearFar(t)})),(0,k.watch)((function(){return e.view.renderDataExtent}),(function(){return e._updateNearFar()}),k.sync),(0,k.watch)((function(){var t,n,i,r;return[null===(t=e.view.constraints)||void 0===t||null===(n=t.altitude)||void 0===n?void 0:n.min,null===(i=e.view.constraints)||void 0===i||null===(r=i.altitude)||void 0===r?void 0:r.max]}),(function(){return e._updateAltitude()}),k.sync),(0,k.watch)((function(){var t,n;return null===(t=e.view.constraints)||void 0===t||null===(n=t.tilt)||void 0===n?void 0:n.max}),(function(){return e._updateTiltMax()}),k.sync),(0,k.watch)((function(){var t,n;return null===(t=e.view.constraints)||void 0===t||null===(n=t.tilt)||void 0===n?void 0:n.mode}),(function(){return e._updateTilt()}),k.sync),(0,k.watch)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(){return e._updateTiltAutoMax()}),k.sync),(0,k.watch)((function(){var t,n,i,r,a,o;return[null===(t=e.view.map)||void 0===t||null===(n=t.ground)||void 0===n||null===(i=n.navigationConstraint)||void 0===i?void 0:i.type,null===(r=e.view.state)||void 0===r||null===(a=r.constraints)||void 0===a||null===(o=a.collision)||void 0===o?void 0:o.enabled]}),(function(){return e._updateCollision()}),k.sync)]),this.view.state.isLocal&&this.addHandles((0,k.watch)((function(){return e.view.renderDataExtent}),(function(t){return e._updateLocalSurfaceDistance(t)}),k.initial)),this._updateNearFar(),this.view.state.viewingMode!==he.JY.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Xo({view:this.view}))}},{key:"destroy",value:function(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}},{key:"_clipDistanceNearFarChanged",value:function(){var e,t=null===(e=this.view.constraints)||void 0===e?void 0:e.clipDistance;t&&"auto"!==t.mode&&this.view.state.updateCamera((function(e){return Yo(e,t)}))}},{key:"_updateNearFar",value:function(){var e=this;this.view.state.updateCamera((function(t){return e._updateCameraNearFar(t)}))}},{key:"_updateCameraNearFar",value:function(e){var t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?Yo(e,t):this._updateCameraNearFarAuto(e,t)}},{key:"_updateCameraNearFarAuto",value:function(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,(0,sr.wH)(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}},{key:"_updateCollision",value:function(){var e,t,n,i=null===(e=this.view.map)||void 0===e||null===(t=e.ground)||void 0===t||null===(n=t.navigationConstraint)||void 0===n?void 0:n.type,r=!i||"stay-above"===i,a=this.view.state.constraints.collision;if(r!==a.enabled){a.enabled=r,r&&this._reapplyConstraints(xi.COLLISION);var o=this.view.constraints&&this.view.constraints.tilt;o&&"auto"!==o.mode||this._updateTiltAuto()}}},{key:"_updateAltitude",value:function(){var e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==he.JY.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}},{key:"_updateTiltMax",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}},{key:"_updateTilt",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}},{key:"_updateTiltManual",value:function(e){var t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,Se.Vl)(e.max))}},{key:"_updateTiltAuto",value:function(){var e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}},{key:"_updateTiltAutoMax",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;if(e&&"auto"===e.mode){var t=this.view.state.constraints;if(t.tilt){var n=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,Se.BV)(n))}}}},{key:"_updateLocalSurfaceDistance",value:function(e){if(null!=e){var t=Math.max(e.width,e.height);if(!(t<=0)){null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));var n=this.view.state,i=3*t/Math.atan(n.camera.fov/2);i!==n.constraints.distance&&(n.constraints.distance=i)}}}},{key:"_reapplyConstraints",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:xi.ALL;this.view.state.updateCamera((function(n){return Rr(e.view,n,new Zi(t,Ti.NONE,null))}))}}]),n}(Z.default);function Yo(e,t){t&&(e.near=t.near,e.far=t.far)}(0,f._)([(0,E.Cb)({constructOnly:!0})],Qo.prototype,"view",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Qo.prototype,"surfaceCollisionConstraint",void 0),Qo=(0,f._)([(0,A.j)("esri.views.3d.state.ConstraintsManager")],Qo);var Jo=n(38161),Ko=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){return(0,o.Z)(this,n),t.call(this,e)}return(0,s.Z)(n,[{key:"desiredCamera",set:function(e){this._set("desiredCamera",e.clone())}},{key:"canStop",get:function(){return!0}},{key:"constraintEnabled",get:function(){return this.view.state.constraints.collision.enabled}},{key:"onControllerStart",value:function(){var e=this;this.state=Nr.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",(function(t){return e._handleElevationChangeEvent(t)}))),this._applyCorrection()}},{key:"onControllerEnd",value:function(){this.removeAllHandles()}},{key:"stepController",value:function(){}},{key:"_handleElevationChangeEvent",value:function(e){(null==e.spatialReference||(0,sr.lM)(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}},{key:"_applyCorrection",value:function(){var e=this;this.view.state.updateCamera((function(t){t.copyViewFrom(e.desiredCamera),lr(e.view,t,er.EYE_AND_CENTER)||e.constraintEnabled||(e.state=Nr.Stopped)}))}}]),n}(Kr);(0,f._)([(0,E.Cb)({constructOnly:!0})],Ko.prototype,"desiredCamera",null),Ko=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Ko);var $o=n(90647),es=function(){function e(t,n,i){var r=this;(0,o.Z)(this,e),this._target=t,this._options=n,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise((function(e,t){r._resolveCallback=e,r._rejectCallback=t;var n=new AbortController;null!=r._options.signal&&(0,S.fu)(r._options.signal,(function(){r.abort()})),r._abortController=n,r._waitForReady()}))}return(0,s.Z)(e,[{key:"_resolve",value:function(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}},{key:"_reject",value:function(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}},{key:"abort",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this._reject((0,S.zE)())}},{key:"_waitForReady",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){var t=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state="wait-for-ready",this.view.ready){e.next=9;break}return e.prev=1,e.next=4,(0,k.whenOnce)((function(){return t.view.ready}),this._abortController.signal);case 4:e.next=9;break;case 6:return e.prev=6,e.t0=e.catch(1),e.abrupt("return",this._reject(e.t0));case 9:this._createViewPoint();case 10:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createViewPoint",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){var t,n;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("finished"===this.state){e.next=23;break}return this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null,e.prev=2,e.next=5,(0,$o.create)(this.view,this._target,this._abortController.signal);case 5:if(t=e.sent,"finished"!==this.state){e.next=8;break}return e.abrupt("return");case 8:if(null!=(n=t?this._getCameraFromViewpoint(t):null)){e.next=11;break}return e.abrupt("return");case 11:if(!this._options.animate){e.next=17;break}if(null!=this._animationController){e.next=14;break}return e.abrupt("return");case 14:this._startAnimation(n,this._animationController),e.next=18;break;case 17:this.view.stateManager.setStateCamera(n.camera,{applyConstraints:!n.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve();case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(2),this._reject(e.t0);case 23:case"end":return e.stop()}}),e,this,[[2,20]])})));return function(){return e.apply(this,arguments)}}()},{key:"_getCameraFromViewpoint",value:function(e){var t=!!(this._target instanceof p.Z&&this._target.camera||this._target instanceof v.Z),n=e.camera;if(null==n)return null;if(!this.view.stateManager.isCompatible(n)){var i,r=n.position,a=r&&r.spatialReference,o=a?a.wkid:"none",s=null===(i=this.view.spatialReference)||void 0===i?void 0:i.wkid;return this._reject(new g.Z("GotoAnimation:incompatible-spatialreference","Resulting camera has an incompatible spatial reference (camera: ".concat(o,", view: ").concat(s,")"),{camera:n})),null}var l=(0,K.n3)(this.view,n);return null==l?(this._reject(new g.Z("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:l,isFullySpecified:t}}},{key:"_startAnimation",value:function(e,t){var n=this;this.state="wait-for-animation-finish";var i=t.viewAnimation;if(null!=i){if(i.update(e.viewpoint,"running"),!t.active||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();var r;e.isFullySpecified?(r=new Ko({view:this.view,desiredCamera:e.camera}),lr(this.view,e.camera,er.EYE_AND_CENTER)):Rr(this.view,e.camera),t.begin(e.camera,this._options);var a=function(e){if(null!=n.view.state)switch(t.state){case Nr.Finished:switch(n.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":n._resolve()}break;case Nr.Ready:case Nr.Rejected:case Nr.Running:case Nr.Stopped:switch(n.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":n._reject(e)}}};i.when((function(){var i=n.view.state.cameraController;r&&(i&&i.active?i instanceof ta&&null!=i.viewAnimation&&i.viewAnimation.target===e.viewpoint&&(n.view.state.cameraController=r):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&t.state===Nr.Finished&&(n.view.state.cameraController=r))}),(function(e){return a(e)})),t.asyncResult={resolve:function(){return a()},reject:function(e){return a(e)}}}else this._reject(new g.Z("GotoAnimation:missing-animation","Unreachable code in view.stateManager"))}},{key:"_getAnimationController",value:function(){var e=null,t=null,n=this.view.state.cameraController;return n instanceof ta&&(n.updateStateFromViewAnimation(),n.active&&(t=(e=n).viewAnimation)),null!=e||(t=(e=new ta({view:this.view,mode:"animation"})).viewAnimation,this.view.state.switchCameraController(e))?e:(null!=t&&t.stop(),this._reject(new g.Z("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}]),e}(),ts=n(76419),ns=n(41947),is=n(2263),rs=n(75248),as=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).ready=!1,i._windowDevicePixelRatio=1,i._devicePixelRatioOverride=null,i._idleTimeout=_s,i.test={viewStateManager:(0,l.Z)(i),contentCameraResetState:new Map,setDevicePixelRatio:function(e){return i._devicePixelRatioOverride=e},renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?_s:0}},i._propertiesPool=new ts.L({frustum:Jo.i},(0,l.Z)(i)),i._cameraSetByUser=!1,i._gotoOperation=null,i._cameraChangeTime=0,i._tmpCanvasSize=new ss,i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this._cameraChangeTime=performance.now(),this.addHandles([(0,k.on)((function(){return e.view.state.events}),"before-camera-change",(function(t){return t&&e._updateElevation(t)})),(0,k.watch)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(t,n){return e._cameraChangedHandler(t,n)}),k.sync)]),(0,k.when)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(t){return e._updateElevation(t)}),{once:!0,sync:!0}),this.addHandles([(0,M.A)({prepare:function(){return e._prepareFrame()}}),(0,k.watch)((function(){return e.view.state.cameraController}),(function(){e._cameraSetByUser=!0,e.removeHandles(vs)})),(0,k.on)((function(){return e.view.state.events}),"camera-projection-changed",(function(){return e.notifyChange("scale")}))])}},{key:"destroy",value:function(){this.exit(),this._propertiesPool=(0,x.SC)(this._propertiesPool)}},{key:"camera",get:function(){var e=this._get("camera");if(!this.ready)return e;var t=(0,K.l0)(this.view,this.view.state.camera,hs);return t&&e&&t.equals(e)?e:t.clone()},set:function(e){var t,n;this._updatePropertyBeforeReady("camera",e)||(null!==(t=this.view.elevationProvider)&&void 0!==t&&t.enableCache(!0),this.setStateCamera((0,K.n3)(this.view,e),{applyConstraints:!1})||C.Z.getLogger(this).error("#camera=","Invalid camera",e),null===(n=this.view.elevationProvider)||void 0===n||n.enableCache(!1))}},{key:"contentCamera",get:function(){var e=this._get("contentCamera");if(!this.ready)return e;var t=(0,K.l0)(this.view,this.view.state.contentCamera,hs);return t&&e&&t.equals(e)?e:t.clone()},set:function(e){if(!this._updatePropertyBeforeReady("contentCamera",e)){var t=(0,K.n3)(this.view,e);null!=t?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}}},{key:"installContentCameraReset",value:function(e){var t=this;if(this.removeHandles(ps),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;var n=this.zoom,i=Math.pow(this.view.state.camera.distance,2),r=(0,U.nI)(this.view.state.camera.center),a=e.sticky?this.contentCamera.clone():null;return this.addHandles([(0,k.watch)((function(){return t.contentCamera}),(function(){e.sticky||(t.removeHandles(ps),t.test.contentCameraResetState.clear())})),(0,k.watch)((function(){return t.zoom}),(function(e){void 0!==e&&void 0!==n&&(t.test.contentCameraResetState.set("view.zoom",Math.abs(e-n)/2),Math.abs(e-n)>2?t.contentCamera=null:t.view.state.fixedContentCamera||(t.contentCamera=a))})),(0,k.watch)((function(){return t.view.state.camera}),(function(e){var n=(0,et.a)(r,e.center);t.test.contentCameraResetState.set("camera.center",n/i),n>i?t.contentCamera=null:t.view.state.fixedContentCamera||(t.contentCamera=a)}))],ps),!0}},{key:"center",get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():C.Z.getLogger(this).error("#center=","Invalid center",e):C.Z.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e):C.Z.getLogger(this).error("#center=","Center may not be null or undefined"))}},{key:"extent",get:function(){if(!this.ready)return this._get("extent");var e=this.view,t=(0,K.HH)(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")},set:function(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||C.Z.getLogger(this).error("#extent=","Invalid extent",e):C.Z.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e):C.Z.getLogger(this).error("#extent=","Extent may not be null or undefined"))}},{key:"frustum",get:function(){var e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}},{key:"constraintsManager",get:function(){return this._constraintsManager}},{key:"_initialViewpoint",get:function(){var e,t=this.view.map;return t&&"initialViewProperties"in t?null===(e=t.initialViewProperties)||void 0===e?void 0:e.viewpoint:void 0}},{key:"hasInitialView",get:function(){return!!this._initialViewpoint}},{key:"scale",get:function(){if(this.ready){var e=this.view.pointsOfInterest.centerOnContent;return(0,K.Xt)(this.view,e.distance,e.location.latitude)}return this._get("scale")},set:function(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||C.Z.getLogger(this).error("#scale=","Invalid scale",e)}},{key:"terrainScale",get:function(){if(!this.ready)return this._get("scale");var e=this.view,t=e.basemapTerrain.tilingScheme,n=e.pointsOfInterest.cameraOnSurface.scale;if(!t||!n)return this._get("scale");var i=e.state.contentCamera,r=(0,K.t_)(e,i.eye,i.viewForward,i.up).tilt;r>90&&(r=180-r);var a=2*Math.pow(r/90,2),o=t.levelAtScale(n)-a;return o<0?this._get("scale"):t.scaleAtLevel(o)}},{key:"padding",get:function(){if(!this.ready)return this._get("padding");var e=this.view.state.camera,t=e.padding,n=e.pixelRatio,i=this._get("padding"),r=Math.round(t[ns.Np.TOP]/n),a=Math.round(t[ns.Np.RIGHT]/n),o=Math.round(t[ns.Np.BOTTOM]/n),s=Math.round(t[ns.Np.LEFT]/n);return null!=i&&i.top===r&&i.right===a&&i.bottom===o&&i.left===s?i:{top:r,right:a,bottom:o,left:s}},set:function(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,fs),this.view.state.updateCamera((function(e){return e.padding=fs})))}},{key:"_paddingToArray",value:function(e,t,n){e?(0,ot.s)(n,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,ot.s)(n,0,0,0,0);for(var i=0;i<4;i++)n[i]=Math.round(n[i]*t)}},{key:"screenCenter",get:function(){var e=this.padding;return(0,P.vW)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}},{key:"viewpoint",get:function(){return this.ready?(0,$o.fromCamera)(this.view,this.camera):this._get("viewpoint")},set:function(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||C.Z.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{var t,n=null!=e.camera?e.camera.position:e.targetGeometry,i=null!=n&&n.spatialReference;C.Z.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e)}else C.Z.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}},{key:"zoom",get:function(){return this.ready?(0,K.sO)(this.view,this.scale):this._get("zoom")},set:function(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||C.Z.getLogger(this).error("#zoom=","Invalid zoom",e)}},{key:"_computeCanvasSize",value:function(){var e;if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;var t=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),n=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:t)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*n),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*n);var i=null===(e=this.view._stage.renderView.renderingContext)||void 0===e?void 0:e.parameters.maxTextureSize;return i&&(0,Qt.d)(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:n,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}},{key:"_rasterPixelRatio",get:function(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}},{key:"_usePhysicalPixelRendering",get:function(){var e,t,n;return null!==(e=null===(t=this.view)||void 0===t||null===(n=t._stage)||void 0===n?void 0:n.renderer.isFeatureEnabled(is.Y.PhysicalPixelRendering))&&void 0!==e&&e}},{key:"_usePhysicalPixelRenderingAny",get:function(){var e,t,n=null===(e=this.view)||void 0===e||null===(t=e._stage)||void 0===t?void 0:t.renderer;return n&&(n.isFeatureEnabled(is.Y.PhysicalPixelRendering,rs.n.IDLE)||n.isFeatureEnabled(is.Y.PhysicalPixelRendering,rs.n.INTERACTING)||n.isFeatureEnabled(is.Y.PhysicalPixelRendering,rs.n.ANIMATING))}},{key:"preinit",value:function(e){var t,n,i;return!(this._isOverridden("center")&&!(0,V.isLoadedOrLoadFor)(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!(0,V.isLoadedOrLoadFor)(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!(0,V.isLoadedOrLoadFor)(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||(0,V.isLoadedOrLoadFor)(null===(t=this.viewpoint.targetGeometry)||void 0===t?void 0:t.spatialReference,e)&&(0,V.isLoadedOrLoadFor)(null===(n=this.viewpoint.camera)||void 0===n||null===(i=n.position)||void 0===i?void 0:i.spatialReference,e))}},{key:"init",value:function(){var e=this;this._constraintsManager=new Qo({view:this.view}),this._prepareFrame();var t=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;this.set(a.name,a.value)}}catch(s){r.e(s)}finally{r.f()}if(!this._cameraSetByUser){var o=this._initialViewpoint||this.view.initialExtent;o&&this.isCompatible(o)?this._setInitialView(o):this.view.state.viewingMode===he.JY.Local&&this.addHandles((0,k.when)((function(){return e.view.basemapTerrain.ready}),(function(){e.removeHandles(vs),e._setInitialView(e.view.dataExtent)}),{once:!0,initial:!0}),vs)}}},{key:"exit",value:function(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(vs),this._constraintsManager=(0,x.SC)(this._constraintsManager))}},{key:"goTo",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(n=(0,He.Z)({animate:!0},n),null!=this._gotoOperation&&this._gotoOperation.abort(n.animate),this._gotoOperation=new es(t,n,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"debugSetCameraOnContent",value:function(){this.setStateCamera((0,sr.dP)(this.view),{applyConstraints:!1})}},{key:"step",value:function(e){var t=this.view.state,n=null===t||void 0===t?void 0:t.cameraController;n&&(t.updateCamera((function(t){return n.stepController(e,t)})),n.steppingFinished&&n.finishController())}},{key:"_cancelGoToOperation",value:function(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}},{key:"_getInitialProperties",value:function(){var e,t=new Set,n=[],r=(0,i.Z)(us);try{for(r.s();!(e=r.n()).done;){var a=e.value,o=a.propertyName,s=a.overrides,l=t.has(o),u=this._isOverridden(o);!l&&u&&n.push({name:o,value:this._get(o)}),this._clearOverride(o),(l||u)&&s.forEach((function(e){return t.add(e)}))}}catch(c){r.e(c)}finally{r.f()}return n}},{key:"_setInitialView",value:function(e){if(null!=e&&!this._cameraSetByUser)if(e instanceof v.Z)this.setStateCamera((0,K.n3)(this.view,e),{applyConstraints:!1});else if(e instanceof p.Z){if(e.targetGeometry instanceof Lo.Z){var t=(0,K.S9)(this.view,e.targetGeometry,0,.5,K.Q8.LOCKED);return void(null!=t&&this.setStateCamera((0,K.n3)(this.view,t),{applyConstraints:!0}))}var n={applyConstraints:!e.camera},i=this._viewpointToCamera(e);this.setStateCamera(i,n)}else{var r=(0,K.S9)(this.view,e,0,.5,K.Q8.LOCKED);null!=r&&this.setStateCamera((0,K.n3)(this.view,r),{applyConstraints:!0})}}},{key:"_updatePropertyBeforeReady",value:function(e,t){return!this.ready&&(this._override(e,t),t&&ls.has(e)&&this._override("hasInitialView",!0),!0)}},{key:"isCompatible",value:function(e){return null!=e&&(e instanceof p.Z?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof v.Z?this.isCompatible(e.position):e.spatialReference&&!(0,V.requiresLoad)(e.spatialReference,this.view.spatialReference))}},{key:"_getPreservingHeadingTilt",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:cs;return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}},{key:"_centerPointAtDistanceToCamera",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ds,i=this._getPreservingHeadingTilt(),r=i.heading,a=i.tilt,o=(0,K.P$)(this.view,r,a,e,t,K.Q8.ADJUST);return null==o?null:(n.copyFrom(this.view.state.camera),n.eye=o.eye,n.center=o.center,n.up=o.up,n)}},{key:"_centerToCamera",value:function(e){var t=this.view.pointsOfInterest.centerOnContent;t.runTask();var n=t.distance;return this._centerPointAtDistanceToCamera(e,n)}},{key:"_extentToCamera",value:function(e){var t=this._getPreservingHeadingTilt(),n=t.heading,i=t.tilt,r=(0,K.S9)(this.view,e,n,i,K.Q8.ADJUST,hs);return r?(0,K.n3)(this.view,r):null}},{key:"_scaleToCamera",value:function(e){if(null==e)return null;var t=this.view.pointsOfInterest.centerOnContent;t.runTask();var n=t.renderLocation,i=t.location.latitude,r=(0,K._U)(this.view,e,i);return this._centerPointAtDistanceToCamera(n,r)}},{key:"_zoomToCamera",value:function(e){return this._scaleToCamera((0,K.EO)(this.view,e))}},{key:"_viewpointToCamera",value:function(e){return(0,K.n3)(this.view,(0,$o.toCameraSync)(this.view,e))}},{key:"setStateCamera",value:function(e,t){var n=this;return!(null==e||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((function(i){t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&Rr(n.view,i)})),t.applyConstraints||(this.view.state.cameraController=new Ko({view:this.view,desiredCamera:e})),!0)}},{key:"_prepareFrame",value:function(){var e=this.view,t=e.surface,n=e.canvas;if(t&&n){this._windowDevicePixelRatio=window.devicePixelRatio;var i=this._computeCanvasSize();if(0!==i.width&&0!==i.height&&(n.width===i.width&&n.height===i.height||(n.width=i.width,n.height=i.height),this.view.state)){var r=this.view.state.camera;r.fullWidth===i.width&&r.fullHeight===i.height&&r.pixelRatio===i.pixelRatio||(ds.copyFrom(r),ds.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,fs),ds.padding=fs),ds.fullWidth=i.width,ds.fullHeight=i.height,ds.pixelRatio=i.pixelRatio,this.view.state.camera=ds),this._updateViewState()}}}},{key:"_updateElevation",value:function(e){var t,n,i,r=null===(t=this.view.basemapTerrain)||void 0===t?void 0:t.spatialReference,a=null!==(n=null===(i=this.view.renderCoordsHelper)||void 0===i?void 0:i.getAltitude(e.eye))&&void 0!==n?n:0,o=r?(0,sr.wH)(this.view,e.eye):0;e.relativeElevation=a-o}},{key:"_updateViewState",value:function(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=rs.n.ANIMATING:this.view.interacting?this.view.state.mode=rs.n.INTERACTING:(this.view.state.mode===rs.n.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=rs.n.INTERACTING:this.view.state.mode=rs.n.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}},{key:"_cameraChangedHandler",value:function(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}}]),n}(Z.default);(0,f._)([(0,E.Cb)({type:v.Z,dependsOn:["view.state.camera","ready"]})],as.prototype,"camera",null),(0,f._)([(0,E.Cb)({type:v.Z,dependsOn:["view.state.contentCamera","ready"]})],as.prototype,"contentCamera",null),(0,f._)([(0,E.Cb)({type:No.Z})],as.prototype,"center",null),(0,f._)([(0,E.Cb)({type:Lo.Z})],as.prototype,"extent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],as.prototype,"frustum",null),(0,f._)([(0,E.Cb)()],as.prototype,"_constraintsManager",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],as.prototype,"constraintsManager",null),(0,f._)([(0,E.Cb)()],as.prototype,"_initialViewpoint",null),(0,f._)([(0,E.Cb)({readOnly:!0})],as.prototype,"hasInitialView",null),(0,f._)([(0,E.Cb)({readOnly:!0,type:Boolean})],as.prototype,"ready",void 0),(0,f._)([(0,E.Cb)({type:Number})],as.prototype,"scale",null),(0,f._)([(0,E.Cb)({type:Number})],as.prototype,"terrainScale",null),(0,f._)([(0,E.Cb)()],as.prototype,"padding",null),(0,f._)([(0,E.Cb)({readOnly:!0})],as.prototype,"screenCenter",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],as.prototype,"view",void 0),(0,f._)([(0,E.Cb)({type:p.Z})],as.prototype,"viewpoint",null),(0,f._)([(0,E.Cb)({type:Number})],as.prototype,"zoom",null),(0,f._)([(0,E.Cb)({readOnly:!0})],as.prototype,"_rasterPixelRatio",null),(0,f._)([(0,E.Cb)({readOnly:!0})],as.prototype,"_usePhysicalPixelRendering",null),(0,f._)([(0,E.Cb)({readOnly:!0})],as.prototype,"_usePhysicalPixelRenderingAny",null),(0,f._)([(0,E.Cb)()],as.prototype,"_windowDevicePixelRatio",void 0),(0,f._)([(0,E.Cb)()],as.prototype,"_devicePixelRatioOverride",void 0),as=(0,f._)([(0,A.j)("esri.views.3d.state.ViewStateManager")],as);var os,ss=(0,s.Z)((function e(){(0,o.Z)(this,e),this.width=0,this.height=0,this.pixelRatio=1})),ls=new Set(["camera","viewpoint","extent","scale","center","zoom"]),us=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],cs={heading:0,tilt:0},hs=new v.Z,ds=new Xr.Z,fs=(0,st.Ue)(),vs="pending-initial-view",ps="content-camera-reset",_s=300,ms=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).startCamera=new Xr.Z,e.currentCamera=new Xr.Z,e._lastInteraction=0,e}return(0,s.Z)(n,[{key:"isInteractive",get:function(){return performance.now()-this._lastInteraction<100}},{key:"stepController",value:function(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}},{key:"onControllerStart",value:function(e){this.state=Nr.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}},{key:"onControllerEnd",value:function(e){e.copyViewFrom(this.currentCamera)}},{key:"commitCamera",value:function(){var e=this;this._lastInteraction=performance.now(),setTimeout((function(){return e.notifyChange("isInteractive")}),100),this.view.state.updateCamera((function(t){return e.stepController(0,t)})),this.steppingFinished&&this.finishController()}}]),n}(Kr);(0,f._)([(0,E.Cb)({readOnly:!0})],ms.prototype,"isInteractive",null),(0,f._)([(0,E.Cb)()],ms.prototype,"_lastInteraction",void 0),ms=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.InteractiveController")],ms),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(os||(os={}));var gs=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).pivot=os.CENTER,i._rotScale=0,i._lastPoint=(0,ut.Ue)(),i._tmpWorldUp=(0,U.Ue)(),i._tmpViewDir=(0,U.Ue)(),i._tmpRotCurPoint=(0,ut.Ue)(),i._tmpTransf=(0,Ut.Ue)(),i._tmpAxis=(0,U.Ue)(),i._tmpPivotPoint=(0,U.Ue)(),i._pivotPos=(0,U.Ue)(),i._constraintOptions=new Zi(xi.ALL,Ti.TUMBLE,0,i.startCamera),i}return(0,s.Z)(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"initialize",value:function(){this._rotScale=this.pivot===os.CENTER?3:1.5}},{key:"begin",value:function(e){if(this.active){switch(this.pivot){case os.EYE:(0,et.c)(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Ti.LOOK_AROUND,this._constraintOptions.tiltMode=Si.LOOK_AROUND,this._constraintOptions.selection=xi.NONE;break;case os.CENTER:var t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?Ca:{});t||(0,et.c)(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Ti.TUMBLE,this._constraintOptions.tiltMode=Si.TUMBLE,this._constraintOptions.selection=xi.ALL&~xi.DISTANCE}xa(this.startCamera,e,this._lastPoint)}}},{key:"_constrainPivotPoint",value:function(e,t){var n,i,r=this.startCamera,a=(0,U.Ue)();(0,et.f)(a,this._pivotPos,r.eye);var o=(0,et.l)(a),s=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(r.eye,bs);var l=Math.max(Math.min(5,1/Math.abs((0,et.m)(bs,r.viewForward)))*s,10);t&&(l=Math.min(o,l));var u=(0,P.s1)(r.width/r.pixelRatio*.5,r.height/r.pixelRatio*.5),c=Fa(this.startCamera,u,this.view.renderCoordsHelper,this.view.viewingMode),h=this.view._stage.renderView.getMinimalDepthForArea((0,Po.$L)(this.view),r.fullWidth/r.pixelRatio*.5,r.fullHeight/r.pixelRatio*.5,r,225,90),d=this.view._stage.renderView.getMinimalDepthForArea((0,Po.$L)(this.view),e[0],e[1],r,90);null==h&&null==d||(l=(h=null!==(n=null!==(i=h)&&void 0!==i?i:d)&&void 0!==n?n:0)>(d=null==d||c===Ra.Horizontal?h:d)?d:h,l=t?Math.min(l,o):l),(0,et.n)(a,a),(0,et.c)(this._pivotPos,(0,et.g)(this._tmpPivotPoint,r.eye,(0,et.j)(this._tmpPivotPoint,a,l)))}},{key:"update",value:function(e){if(this.active){switch(this.pivot){case os.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case os.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Rr(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}},{key:"end",value:function(){this.active&&this.finishController()}},{key:"_applyRotation",value:function(e,t,n,i){this.view.renderCoordsHelper.worldUpAtPosition(i,this._tmpWorldUp),xa(e,t,this._tmpRotCurPoint);var r=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;(0,et.f)(this._tmpViewDir,n,i);var o=(0,et.l)(this._tmpViewDir),s=(0,Se.ZF)((0,et.m)(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===os.EYE){r*=-.5;var l=.5*Math.PI-s,u=.5*Math.PI*.99;r=l-Math.max(-u,Math.min(u,l+r))}return r=(0,Se.uZ)(r+s,Ee.min,Ee.max)-s,(0,et.b)(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===os.CENTER&&(a=-a),(0,Nt.Us)(this._tmpTransf,a,this._tmpWorldUp),(0,Nt.U1)(this._tmpTransf,this._tmpTransf,r,this._tmpAxis),(0,et.h)(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=(0,et.h)(ys,e.up,this._tmpTransf),(0,et.g)(ys,i,this._tmpViewDir),(0,at.JG)(this._lastPoint,this._tmpRotCurPoint),ys}}]),n}(ms);(0,f._)([(0,E.Cb)()],gs.prototype,"pivot",void 0),gs=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.RotateController")],gs);var ys=(0,U.Ue)(),bs=(0,U.Ue)(),ws=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a){var s;return(0,o.Z)(this,n),(s=t.call(this,!0))._view=e,s.pointerAction=i,s._pivot=r,s.registerIncoming("drag",a,(function(e){return s._handleDrag(e)})),s}return(0,s.Z)(n,[{key:"_handleDrag",value:function(e){var t=e.data;if(!(t.pointers.size>1)&&(0,Zo.b)(e.data,this.pointerAction)){var n=(0,P.s1)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new gs({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(n);break;case"update":this._cameraController&&this._cameraController.update(n);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}}]),n}(Do.a),Cs=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._pickPoint=(0,U.Ue)(),e._tmpP0=(0,ut.Ue)(),e._panAxisAngle=ua(),e._tmpRayDir=(0,U.Ue)(),e._tmpRayDirPick=(0,U.Ue)(),e._targetOnSphere=(0,U.Ue)(),e._navMode=Ra.Horizontal,e._tmpRay={origin:(0,U.Ue)(),direction:(0,U.Ue)()},e.dragBeginPoint=(0,P.s1)(),e._normalizedAnchorPoint=(0,ut.Ue)(),e._constraintOptions=new Zi(xi.ALL_EXCEPT_COLLISION,Ti.ZOOM,0,e.startCamera),e._sphere=(0,Ai.c)(),e._hasPickPoint=!1,e}return(0,s.Z)(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){var t;if(this.active){(0,at.JG)(this.dragBeginPoint,e),xa(this.startCamera,e,this._normalizedAnchorPoint);var n=(0,nt.Iu)(this.view.spatialReference),i=Ha(this._intersectionHelper,this.startCamera,e,n,ma.Ellipsoid,0===this.view.map.ground.opacity?Ca:{});if(this._navMode=Fa(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Ra.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=null!==(t=i.scenePickPoint)&&void 0!==t?t:this._pickPoint,this._sphere=i.sphere;else{var r;(0,pa.iE)(this.startCamera,e,this._tmpRay),(0,et.n)(this._tmpRay.direction,this._tmpRay.direction),null!=i.scenePickPoint&&((0,et.f)(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),r=(0,et.l)(this._tmpRayDirPick));var a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Ts);var o=(0,Se.uZ)(Math.min(30,1/Math.abs((0,et.m)(Ts,this._tmpRay.direction)))*a,ba[0],ba[1]),s=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);o=null!=s?s:o,o=null!=r?Math.min(o,r):o,this._hasPickPoint=!0,(0,et.j)(this._tmpRay.direction,this._tmpRay.direction,o),(0,et.g)(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}}},{key:"update",value:function(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Ra.Horizontal){(0,et.f)(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);var t=(0,et.l)(this._tmpRayDir);xa(this.currentCamera,e,this._tmpP0);var n=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),i=t*Math.pow(2,n),r=this.view.state.constraints.minimumPoiDistance;if(n<0&&i<r&&(i=r),Math.abs(t-i)<1e-6)return;if(this._hasPickPoint&&i<t){var a=1-(1-i/t)*(1-this._sphere[3]/(0,et.l)(this.currentCamera.center));this.currentCamera.center=(0,et.j)(xs,this.currentCamera.center,a)}(0,et.j)(this._tmpRayDir,this._tmpRayDir,-i/t),this.currentCamera.eye=(0,et.g)(xs,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Or((0,at.TE)(this.dragBeginPoint,e)),Rr(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(qa(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),da(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Sa(this.currentCamera,(0,Ai.g)(this._sphere),this._panAxisAngle))}else{var o=(0,et.l)(this._tmpRay.direction);xa(this.currentCamera,e,this._tmpP0);var s=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),l=o*Math.pow(2,s),u=this.view.state.constraints.minimumPoiDistance;if(s<0&&l<u&&(l=u),Math.abs(o-l)<1e-6)return;(0,et.j)(this._tmpRayDir,this._tmpRay.direction,1-l/o),this.currentCamera.eye=(0,et.g)(xs,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=(0,et.g)(xs,this.currentCamera.center,this._tmpRayDir)}lr(this.view,this.currentCamera),this.commitCamera()}}},{key:"end",value:function(){this.active&&this.finishController()}}]),n}(ms);Cs=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.ZoomControllerGlobal")],Cs);var xs=(0,U.Ue)(),Ts=(0,U.Ue)(),Ss=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._tmpP=(0,U.Ue)(),e._tmpDir=(0,U.Ue)(),e._tmpN=(0,U.Ue)(),e._tmpP0=(0,ut.Ue)(),e._tmpPoi=(0,U.Ue)(),e._tmpRayDir=(0,U.Ue)(),e.dragBeginPoint=(0,P.s1)(),e._normalizedAnchorPoint=(0,ut.Ue)(),e._constraintOptions=new Zi(xi.ALL,Ti.ZOOM,0,e.startCamera,(0,U.Ue)()),e._plane=(0,va.Ue)(),e}return(0,s.Z)(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){if(this.active){(0,at.JG)(this.dragBeginPoint,e),xa(this.startCamera,e,this._normalizedAnchorPoint);var t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,0===this.view.map.ground.opacity?Ca:{});(0,et.f)(this._tmpDir,this._tmpP,this.startCamera.eye);var n=(0,et.l)(this._tmpDir);(0,et.n)(this._tmpDir,this._tmpDir);var i=Math.abs(this.view.camera.position.z),r=(0,Se.uZ)(Math.min(30,1/Math.abs((0,et.m)(Ms,this._tmpDir)))*i,ba[0],ba[1]),a=this.view._stage.renderView.getMinimalDepthForArea((0,Po.$L)(this.view),e[0],e[1],this.view.state.camera,80);r=null!=a?a:r,r=t?Math.min(r,n):r,(0,et.j)(this._tmpDir,this._tmpDir,r),(0,et.g)(this._tmpP,this.startCamera.eye,this._tmpDir),(0,et.f)(this._tmpN,this.startCamera.eye,this.startCamera.center),(0,et.n)(this._tmpN,this._tmpN),this._tmpN[1]<0&&(0,et.k)(this._tmpN,this._tmpN),(0,va.Yq)(this._tmpP,this._tmpN,this._plane)}}},{key:"update",value:function(e){if(this.active){(function(e,t,n,i){return(0,va.BR)(e,(0,pa.u4)(t,n,xo),i)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||(0,et.c)(this._tmpPoi,this.currentCamera.center),xa(this.currentCamera,e,this._tmpP0);var t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);(0,at.JG)(this._normalizedAnchorPoint,this._tmpP0),(0,et.f)(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);var n=(0,et.l)(this._tmpRayDir),i=n*(1-t);this._constraintOptions.interactionDirection&&((0,et.c)(this._constraintOptions.interactionDirection,this._tmpRayDir),(0,et.j)(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/n));var r=this.view.state.constraints.minimumPoiDistance;t>=0&&i<r&&(t=-((i=r)-n)/n),Math.abs(n-i)<1e-6||((0,et.j)(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=(0,et.g)(ks,this.currentCamera.eye,this._tmpRayDir),(0,et.o)(ks,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?ks[2]=Math.max(this.startCamera.center[2],ks[2]):ks[2]=Math.min(this.startCamera.center[2],ks[2]),this.currentCamera.center=ks,this._constraintOptions.interactionFactor=Or((0,at.TE)(this.dragBeginPoint,e)),Rr(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}}},{key:"end",value:function(){this.active&&this.finishController()}}]),n}(ms);Ss=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.ZoomControllerLocal")],Ss);var ks=(0,U.Ue)(),Ms=(0,U.al)(0,0,1),Ps=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,!0))._view=e,a.pointerAction=i,a.registerIncoming("drag",r,(function(e){return a._handleDrag(e)})),a}return(0,s.Z)(n,[{key:"_handleDrag",value:function(e){var t=e.data;if(!(t.pointers.size>1)&&(0,Zo.b)(e.data,this.pointerAction)){var n=(0,P.s1)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new Cs({view:this._view}):this._cameraController=new Ss({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(n);break;case"update":this._cameraController&&this._cameraController.update(n);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}}]),n}(Do.a),Rs=n(71917),Es=n(73320),Os=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._filteredSurfaceElevation=0,i._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},i._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],i._tmpCamera=new Xr.Z,i._headingStart=0,i._constraintOptions=new Zi(xi.ALL,Ti.NONE,0,new Xr.Z,null,Si.LOOK_AROUND),i}return(0,s.Z)(n,[{key:"handleEventGamepad",value:function(e){var t=(0,Es.CY)(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||(0,Es._r)(t))&&this.finishController()}},{key:"activateDirection",value:function(e){this._keysButtonState[e]=1,(0,Es.U_)(this._keysButtonState,this._transformation)}},{key:"deactivateDirection",value:function(e){this._keysButtonState[e]=0;var t=(0,Es.U_)(this._keysButtonState,this._transformation);(0,Es._r)(t)&&this.finishController()}},{key:"onControllerStart",value:function(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,(0,u.Z)((0,c.Z)(n.prototype),"onControllerStart",this).call(this,e)}},{key:"_updateFilteredSurfaceElevation",value:function(e){var t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}},{key:"stepController",value:function(e,t){var i;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),null!==(i=this._constraintOptions.interactionStartCamera)&&void 0!==i&&i.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Hs),this._applyDisabledMovementTypes(Hs),this._applyPan(Hs.pan),this._applyRotate(Hs.rotate),this._applyZoom(Hs.zoom),this._applyAscend(Hs.ascend),this._constraintOptions.interactionType=Ti.NONE,this._constraintOptions.selection=xi.COLLISION,Rr(this.view,this.currentCamera,this._constraintOptions),(0,u.Z)((0,c.Z)(n.prototype),"stepController",this).call(this,e,t)}},{key:"_updateStartHeading",value:function(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}},{key:"_applyRotate",value:function(e){if(e.enabled){var t=this.currentCamera;(0,et.f)(Fs,t.center,t.eye),(0,et.h)(Fs,Fs,e.matrix),t.center=(0,et.g)(Fs,Fs,t.eye),t.up=(0,et.h)(Fs,t.up,e.matrix),this._constraintOptions.interactionType=Ti.LOOK_AROUND,this._constraintOptions.selection=xi.ALL_EXCEPT_COLLISION,Rr(this.view,t,this._constraintOptions)}}},{key:"_applyPan",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.currentCamera;e.enabled&&(t.eye=(0,et.h)(Fs,t.eye,e.matrix),t.center=(0,et.h)(Fs,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,et.h)(Fs,t.up,e.matrix)),this._constraintOptions.interactionType=Ti.PAN,this._constraintOptions.selection=xi.ALL,Rr(this.view,t,this._constraintOptions))}},{key:"_applyZoom",value:function(e){if(e){var t=this.currentCamera.viewForward;this.currentCamera.eye=(0,et.g)(Fs,this.currentCamera.eye,(0,et.j)(la.WM.get(),t,e)),(0,et.c)(Vs,t),(0,et.k)(Vs,Vs),this._constraintOptions.interactionDirection=Vs,this._constraintOptions.interactionType=Ti.ZOOM,this._constraintOptions.selection=xi.ALL_EXCEPT_COLLISION,Rr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}}},{key:"_applyAscend",value:function(e){if(e){var t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,la.WM.get());if(this._constraintOptions.interactionDirection=(0,et.c)(Vs,t),this.view.state.isGlobal){var n=(0,et.l)(this.currentCamera.eye),i=(n+e)/n;this.currentCamera.eye=(0,et.j)(Fs,this.currentCamera.eye,i),this.currentCamera.center=(0,et.j)(Fs,this.currentCamera.center,i)}else{var r=(0,et.j)(la.WM.get(),t,e);this.currentCamera.eye=(0,et.g)(Fs,this.currentCamera.eye,r),this.currentCamera.center=(0,et.g)(Fs,this.currentCamera.center,r)}this._updateCameraCenter(),this._constraintOptions.interactionType=Ti.ASCEND,this._constraintOptions.selection=xi.COLLISION,Rr(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=xi.ALL_EXCEPT_COLLISION,Rr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}}},{key:"_calculateControlTransformation",value:function(e,t,n){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,Nt.yR)(e.pan.matrix),e.rotate.enabled=!1,(0,Nt.yR)(e.rotate.matrix)}(n);var i=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(i,t,n):this._calculateControlTransformationGlobal(i,t,n)}},{key:"_updateCameraCenter",value:function(){var e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,n=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(n,e,Fs)}},{key:"_calculateControlTransformationLocal",value:function(e,t,n){var i=t.viewRight,r=t.viewForward,a=this._transformation,o=this.view.navigation.gamepad,s=(0,et.s)(la.WM.get(),r[0],r[1],0);(0,et.n)(s,s);var l=a.translation[0]*e.pan;if(0!==l){var u=(0,et.j)(la.WM.get(),i,l);(0,Nt.Iu)(n.pan.matrix,n.pan.matrix,u),n.pan.enabled=!0}switch(o.mode){case"pan":var c=-a.translation[1]*e.pan;if(0!==c){var h=(0,et.j)(la.WM.get(),s,c);(0,Nt.Iu)(n.pan.matrix,n.pan.matrix,h),n.pan.enabled=!0}n.zoom=a.zoom*e.zoom;break;case"zoom":n.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:(0,Fe.Bg)(o.mode)}var d=a.translation[2]*e.ascend;n.ascend=d;var f=-a.heading*e.rotate;0!==f&&((0,Nt.U1)(n.rotate.matrix,n.rotate.matrix,f,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,la.WM.get())),n.rotate.enabled=!0);var v=a.tilt*e.rotate,p=hr(this.view.renderCoordsHelper,t.center,t.eye),_=(0,Se.uZ)(p+v,Ee.min,Ee.max)-p;_&&((0,Nt.U1)(n.rotate.matrix,n.rotate.matrix,_,i),n.rotate.enabled=!0)}},{key:"_calculateControlTransformationGlobal",value:function(e,t,n){var i=t.eye,r=t.viewRight,a=this._transformation,o=this.view.navigation.gamepad,s=(0,et.b)(la.WM.get(),r,i);(0,et.n)(s,s),(0,et.k)(s,s),no(this.startCamera,t,a,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,n,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Hs.pan,this._tmpCamera);var l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,u=a.translation[2]*e.ascend;n.ascend=u;var c=-a.heading*e.rotate;0!==c&&((0,Nt.U1)(n.rotate.matrix,n.rotate.matrix,c,this._tmpCamera.eye),n.rotate.enabled=!0);var h=a.tilt*e.rotate,d=this._clampTiltDeltaGlobalToValidRange(h,t.ray,l);0!==d&&((0,Nt.U1)(n.rotate.matrix,n.rotate.matrix,d,this._tmpCamera.viewRight),n.rotate.enabled=!0),n.zoom+=a.zoom*e.zoom}},{key:"_clampTiltDeltaGlobalToValidRange",value:function(e,t,n){var i=(0,nt.Iu)(this.view.spatialReference),r=Aa(Ee.min,t.origin,n,i),a=0,o=0,s=la.WM.get();this.view.renderCoordsHelper.intersectManifold(t,n,s)?(a=Aa(hr(this.view.renderCoordsHelper,s,t.origin),t.origin,n,i),o=Aa(Ee.max,t.origin,n,i)):((0,Ai.e)((0,Ai.h)(Ai.t,n+i.radius),t,s),a=Da(Math.PI+(0,sa.EU)(t.direction,s),t.origin,n,i),o=Da(Ee.max,t.origin,n,i));return(0,Se.uZ)(a+e,r,o)-a}},{key:"_getPointAbsoluteSurfaceElevation",value:function(e,t,n){var i=this.view.renderCoordsHelper,r=i.getAltitude(e),a=t+Math.abs(r-t);return i.setAltitude(n,a,e),a}},{key:"_clampedDistanceToSurface",value:function(e,t){var n=this.view.renderCoordsHelper,i=this.view.state.camera,r=(0,K.kE)(this.view,t,0,Ds,zs).direction,a=n.intersectManifoldClosestSilhouette((0,Di.re)(t,r),e,la.WM.get()),o=(0,et.p)(t,a),s=n.intersectManifoldClosestSilhouette((0,Di.re)(t,(0,et.E)(la.WM.get(),t,i.center)),e,la.WM.get()),l=(0,et.p)(t,s);return Math.min(o,l)}},{key:"_computeHeadingRotateRadius",value:function(e){var t=this.view,n=t.renderCoordsHelper,i=t.state,r=i.camera,a=i.isGlobal,o=n.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,la.WM.get());if(a){var s=(0,et.f)(la.WM.get(),e,o),l=(0,et.l)(s);(0,et.j)(s,s,1/l);var u=(0,et.n)(la.WM.get(),e),c=(0,Se.ZF)((0,et.m)(u,s));return l*Math.sin(Math.min(Zs,c))}var h=(0,et.c)(la.WM.get(),e);return n.setAltitude(h,this._filteredSurfaceElevation),(0,et.p)(o,h)}},{key:"_minimumAscendVelocity",value:function(){return this.view.state.constraints.collision.enabled?0:Ls}},{key:"_computeVelocities",value:function(e){var t=this._filteredSurfaceElevation,n=t+(0,nt.Iu)(this.view.spatialReference).radius,i=this.view.state,r=i.camera,a=i.isGlobal,o=la.WM.get(),s=this._getPointAbsoluteSurfaceElevation(r.eye,t,o),l=this._clampedDistanceToSurface(t,o),u=r.width/2,c=Is*r.width,h=Is*r.width,d=l*Math.tan(.5*r.fovX)/u,f=d/n,v=d/this._computeHeadingRotateRadius(o),p=s-t;return{pan:(a?f:d)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,Math.pow(2,c*e/u)*p-p),zoom:Math.pow(2,c*e/u)*l-l,rotate:(0,Se.uZ)(v*h,Ns,Us)*e}}},{key:"_applyDisabledMovementTypes",value:function(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,Nt.yR)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,Nt.yR)(e.rotate.matrix))}}],[{key:"activatesFor",value:function(e,t){var n=(0,Es.CY)(t,e.navigation.gamepad,As);return!("end"===t.action||(0,Es._r)(n))}}]),n}(ms);(0,f._)([(0,E.Cb)({constructOnly:!0})],Os.prototype,"gamepadDevice",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Os.prototype,"disableMovements",void 0),Os=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.GamepadKeyboardController")],Os);var As={translation:[0,0,0],heading:0,tilt:0,zoom:0},Ds=80,Zs=(0,Se.Vl)(Ds),Is=.75,Ls=5,Ns=(0,Se.Vl)(30),Us=(0,Se.Vl)(80),Hs={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,Ut.Ue)()},rotate:{enabled:!1,matrix:(0,Ut.Ue)()}},Fs=(0,U.Ue)(),Vs=(0,U.Ue)(),zs=(0,Rs.d)();var qs,Bs=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,!0))._view=e,i._watchHandles=new rt.Z,i._handle=i.registerIncoming("gamepad",(function(e){return i._handleEventGamepad(e)})),i._handle.pause(),i}return(0,s.Z)(n,[{key:"onInstall",value:function(e){var t=this;(0,u.Z)((0,c.Z)(n.prototype),"onInstall",this).call(this,e),this._watchHandles.add([(0,k.watch)((function(){return t._view.navigation.gamepad.enabled}),(function(e){e?t._handle.resume():(t._handle.pause(),t._cameraControllerGamepad&&(t._cameraControllerGamepad.finishController(),t._cameraControllerGamepad=null))}),k.initial),(0,k.watch)((function(){return t._view.navigation.gamepad.device}),(function(e){t._cameraControllerGamepad&&e&&t._cameraControllerGamepad.gamepadDevice!==e&&(t._cameraControllerGamepad.finishController(),t._cameraControllerGamepad=null)}))])}},{key:"onUninstall",value:function(){this._watchHandles.removeAll(),(0,u.Z)((0,c.Z)(n.prototype),"onUninstall",this).call(this)}},{key:"_handleEventGamepad",value:function(e){var t,n=this._view.navigation.gamepad.device;if(!n||e.data.device===n){var i=null===(t=this._cameraControllerGamepad)||void 0===t?void 0:t.active;if(i||Os.activatesFor(this._view,e.data)){if(!i){var r=new Os({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(r)&&(this._cameraControllerGamepad=r)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}}]),n}(Do.a),Gs=n(4942),js=n(65638);!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(qs||(qs={}));var Ws=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i){var r,a;return(0,o.Z)(this,n),(a=t.call(this,!0))._view=e,a._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:he.JY.Local},a._keyToNumber=(r={},(0,Gs.Z)(r,i.left,qs.LEFT),(0,Gs.Z)(r,i.right,qs.RIGHT),(0,Gs.Z)(r,i.forward,qs.FORWARD),(0,Gs.Z)(r,i.backward,qs.BACKWARD),(0,Gs.Z)(r,i.up,qs.UP),(0,Gs.Z)(r,i.down,qs.DOWN),(0,Gs.Z)(r,i.headingLeft,qs.HEADINGLEFT),(0,Gs.Z)(r,i.headingRight,qs.HEADINGRIGHT),(0,Gs.Z)(r,i.tiltUp,qs.TILTUP),(0,Gs.Z)(r,i.tiltDown,qs.TILTDOWN),(0,Gs.Z)(r,i.zoomIn,qs.ZOOMIN),(0,Gs.Z)(r,i.zoomOut,qs.ZOOMOUT),r),a.registerIncoming("key-down",null,(function(e){return a._handleKeyDown(e)})),a.registerIncoming("key-up",null,(function(e){return a._handleKeyUp(e)})),a.registerIncoming("blur",null,(function(){return a._handleStop()})),a._visibilityHandle=(0,js.$)((function(e){return e?null:a._handleStop()})),a}return(0,s.Z)(n,[{key:"onUninstall",value:function(){var e;null!==(e=this._visibilityHandle)&&void 0!==e&&e.remove(),this._handleStop()}},{key:"_handleKeyDown",value:function(e){if(!e.data.native.ctrlKey&&!e.data.native.metaKey){var t=this._keyToNumber[e.data.key];null!=t&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new Os({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}}},{key:"_handleStop",value:function(){var e;(null===(e=this._cameraControllerKeyboard)||void 0===e?void 0:e.active)&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}},{key:"_handleKeyUp",value:function(e){var t;if(!e.data.native.ctrlKey&&!e.data.native.metaKey){var n=this._keyToNumber[e.data.key];null!=n&&(null===(t=this._cameraControllerKeyboard)||void 0===t?void 0:t.active)&&(this._cameraControllerKeyboard.deactivateDirection(n),e.stopPropagation())}}}]),n}(Do.a),Xs=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i){var r;return(0,o.Z)(this,n),(r=t.call(this,!0))._view=e,r.registerIncoming("mouse-wheel",i,(function(e){return r._handleMouseWheel(e)})),r}return(0,s.Z)(n,[{key:"_handleMouseWheel",value:function(e){if(this._view.navigation.mouseWheelZoomEnabled){var t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new So({view:this._view,mode:"interaction"}):new Ro({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,(0,P.s1)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}}]),n}(Do.a),Qs=function(){function e(t){(0,o.Z)(this,e),this._gain=t}return(0,s.Z)(e,[{key:"reset",value:function(e){this._value=e}},{key:"gain",set:function(e){this._gain=e}},{key:"value",get:function(){return void 0===this._value?0:this._value}},{key:"update",value:function(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}]),e}(),Ys=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._beginCamera=new Xr.Z,e._elapsedTimeSec=0,e.constraintOptions=new Zi(xi.ALL,Ti.PAN,0,e._beginCamera),e}return(0,s.Z)(n,[{key:"initialize",value:function(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ce.Z}},{key:"steppingFinished",get:function(){return this.momentum.isFinished(this._elapsedTimeSec)}},{key:"onControllerStart",value:function(e){this._beginCamera.copyFrom(e),(0,u.Z)((0,c.Z)(n.prototype),"onControllerStart",this).call(this,e)}},{key:"stepController",value:function(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Rr(this.view,t,this.constraintOptions)}}]),n}($r),Js=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).interactionType=Ti.PAN,i._tmpPan=(0,U.Ue)(),i}return(0,s.Z)(n,[{key:"momentumStep",value:function(e,t){var n=this.momentum.value(e);(0,et.j)(this._tmpPan,this.momentum.direction,n),t.eye=(0,et.f)(Ks,t.eye,this._tmpPan),t.center=(0,et.f)(Ks,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}}]),n}(Ys=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.momentum.MomentumController")],Ys));(0,f._)([(0,E.Cb)({constructOnly:!0})],Js.prototype,"momentum",void 0),Js=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Js);var Ks=(0,U.Ue)(),$s=(0,U.Ue)(),el=(0,U.Ue)(),tl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).interactionType=Ti.PAN,i}return(0,s.Z)(n,[{key:"momentumStep",value:function(e,t){var n=this.momentum.value1(e),i=this.momentum.value2(e);(0,et.c)(el,t.eye),(0,et.n)(el,el),(0,et.b)(this.momentum.axis2,el,this.momentum.axis1),Ka(t,$s,this.momentum.axis1,n,this.momentum.axis2,i)}}]),n}(Ys);(0,f._)([(0,E.Cb)({constructOnly:!0})],tl.prototype,"momentum",void 0),tl=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],tl);var nl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).interactionType=Ti.TUMBLE,i}return(0,s.Z)(n,[{key:"center",set:function(e){this._set("center",(0,U.d9)(e))}},{key:"axis",set:function(e){this._set("axis",(0,U.d9)(e))}},{key:"momentumStep",value:function(e,t){var n=this.momentum.value(e);Sa(t,this.center,ca(this.axis,n))}}]),n}(Ys);(0,f._)([(0,E.Cb)({constructOnly:!0})],nl.prototype,"momentum",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],nl.prototype,"center",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],nl.prototype,"axis",null),nl=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.momentum.RotationMomentumController")],nl);var il=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).interactionType=Ti.ZOOM,i.constraintOptions.interactionDirection=(0,U.Ue)(),i}return(0,s.Z)(n,[{key:"zoomCenter",set:function(e){this._set("zoomCenter",(0,U.d9)(e))}},{key:"momentumStep",value:function(e,t){var n=this.constraintOptions.interactionDirection;if(n){(0,et.c)(n,t.eye);var i=this.momentum.valueDelta(0,e);Ma(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),(0,et.E)(n,t.eye,n)}}}]),n}(Ys);(0,f._)([(0,E.Cb)({constructOnly:!0})],il.prototype,"momentum",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],il.prototype,"zoomCenter",null),il=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],il);var rl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).interactionType=Ti.ZOOM,i.radius=0,i._tmpSceneCenter=(0,U.Ue)(),i._tmpZoomAxisAngle=ua(),i._sphere=(0,Ai.c)(),i}return(0,s.Z)(n,[{key:"screenCenter",set:function(e){this._set("screenCenter",(0,P.s1)(e[0],e[1]))}},{key:"sceneCenter",set:function(e){this._set("sceneCenter",(0,U.d9)(e))}},{key:"initialize",value:function(){this._sphere[3]=this.radius}},{key:"momentumStep",value:function(e,t){var n=this.momentum.valueDelta(0,e);Pa(this._sphere,t,n),this.constraintOptions.interactionType=Ti.ZOOM,Rr(this.view,t,this.constraintOptions),qa(this._sphere,t,this.screenCenter,this._tmpSceneCenter),da(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Sa(t,(0,Ai.g)(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Ti.PAN}}]),n}(Ys);(0,f._)([(0,E.Cb)({constructOnly:!0})],rl.prototype,"momentum",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],rl.prototype,"screenCenter",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],rl.prototype,"sceneCenter",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],rl.prototype,"radius",void 0),rl=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],rl);var al=n(87022),ol=n(78738),sl=function(){function e(t){(0,o.Z)(this,e),this._gain=t}return(0,s.Z)(e,[{key:"update",value:function(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}},{key:"reset",value:function(){this.filteredValue=void 0}},{key:"hasFilteredValue",get:function(){return void 0!==this.filteredValue}}]),e}(),ll=n(99742),ul=1e-5,cl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a,s){var l,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6?arguments[6]:void 0;return(0,o.Z)(this,n),(l=t.call(this,e,i,r))._angularVelocity1=a,l.axis1=s,l.angularVelocity2=u,l.axis2=c,l}return(0,s.Z)(n,[{key:"value1",value:function(e){return(0,u.Z)((0,c.Z)(n.prototype),"valueFromInitialVelocity",this).call(this,this._angularVelocity1,e)}},{key:"value2",value:function(e){return(0,u.Z)((0,c.Z)(n.prototype),"valueFromInitialVelocity",this).call(this,this.angularVelocity2,e)}}]),n}(ll.X),hl=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;(0,o.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=n,this._friction=i,this.enabled=!0,this._tmpAxis1=(0,U.Ue)(),this._tmpAxis2=(0,U.Ue)(),this._tmpAngles=(0,ut.Ue)(),this._time=new ol.J(.3),this._screen=[new ol.J(.4),new ol.J(.4)],this._angle1=new sl(.6),this._angle2=new sl(.6),this._axis1=(0,U.Ue)(),this._axis2=(0,U.Ue)(),this._lastScene=(0,U.Ue)()}return(0,s.Z)(e,[{key:"addMomentumDirectRotation",value:function(e,t,n,i,r,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(n)<.01)return;var o=Wa(this._lastScene,t,this._tmpAxis2,i,r,a);this._angle2.update(0),(0,et.q)(this._tmpAxis2)<ul?o=0:(0,et.n)(this._axis1,this._tmpAxis2),this._angle1.update(o),(0,et.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(n)}}},{key:"addMomentumPreserveHeading",value:function(e,t,n,i,r,a,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(n)<.01)return;Ya(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,i,r,a,o,!1),(0,et.q)(this._tmpAxis2)<ul?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),(0,et.n)(this._axis1,this._tmpAxis1),(0,et.n)(this._axis2,this._tmpAxis2)),(0,et.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(n)}}},{key:"reset",value:function(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;var e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,n=null==e||null==t?null:Math.sqrt(e*e+t*t),i=this._time.filteredDelta,r=null==n||null==i?0:n/i;return Math.abs(r)<this._minimumInitialVelocity?null:this.createMomentum(r,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,n){var i=this._time.filteredDelta,r=this._angle1.filteredValue,a=this._angle2.filteredValue,o=null==i||null==a?0:a/i;return new cl(e,t,n,null==i||null==r?0:r/i,this._axis1,o,this._axis2)}}]),e}(),dl=n(19475),fl=n(62124),vl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._smoothRotation=new Qs(.05),e._rotationAxis=(0,U.Ue)(),e._beginAngle=0,e._beginHeading=0,e._panningPlane=(0,va.Ue)(),e._beginRadius=0,e._smoothScaling=new Qs(.05),e._zoomCenterScreen=(0,P.s1)(),e._zoomMomentumEstimator=new fl.D,e._rotationMomentumEstimator=new dl.y,e._panSphericalMomentumEstimator=new hl,e._panPlanarMomentumEstimator=new al.G,e._adjustedSphere=(0,Ai.c)(),e._tmp3d=(0,U.Ue)(),e._tmpScreenPointArray=(0,P.s1)(),e._beginScreenPoint=(0,P.s1)(),e._beginScenePoint=(0,U.Ue)(),e._screenPickPoint=(0,P.s1)(),e._scenePickPoint=(0,U.Ue)(),e._navMode=Ra.Horizontal,e._sphere=(0,Ai.c)(),e._pointerCount=0,e._tmpInteractionDirection=(0,U.Ue)(),e._beginCamera=new Xr.Z,e._constraintOptions=new Zi(xi.ALL,Ti.NONE,0,e._beginCamera),e}return(0,s.Z)(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){if(this.active){this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-ra.Q4.normalize((0,Se.Vl)(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),(0,P.md)(e.center,this._screenPickPoint),(0,at.JG)(this._beginScreenPoint,this._screenPickPoint);var t=(0,nt.Iu)(this.view.spatialReference),n=Ha(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,ma.Silhouette,0===this.view.map.ground.opacity?Ca:{});null!=n.scenePickPoint&&(this._scenePickPoint=n.scenePickPoint,this._sphere=n.sphere,(0,et.c)(this._beginScenePoint,this._scenePickPoint),this._navMode=Fa(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Ra.Vertical&&this._preparePlanarPanMode(e,n.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}}},{key:"update",value:function(e){if(this.active){this.currentCamera.copyFrom(this.startCamera);var t=e.pointers.size>1;this._navMode===Ra.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}}},{key:"end",value:function(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();var t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===Ra.Horizontal?new rl({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new il({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});var n=this._rotationMomentumEstimator.evaluateMomentum();if(n)return new nl({view:this.view,momentum:n,center:(0,Ai.g)(this._sphere),axis:this._rotationAxis});if(this._navMode===Ra.Horizontal){var i=this._panSphericalMomentumEstimator.evaluateMomentum();if(i)return new tl({view:this.view,momentum:i})}else{var r=this._panPlanarMomentumEstimator.evaluateMomentum();if(r)return new Js({view:this.view,momentum:r})}return null}},{key:"_preparePlanarPanMode",value:function(e,t){var n=(0,et.k)(this._tmp3d,this.startCamera.viewForward);(0,va.Yq)(this._scenePickPoint,n,this._panningPlane);var i=(0,P.s1)(this._screenPickPoint[0],0),r=(0,U.Ue)(),a=(0,et.l)(this.startCamera.eye);this._adjustedSphere[3]=a<this._sphere[3]?a-100:this._sphere[3],qa(this._adjustedSphere,this.startCamera,i,r);var o=(0,P.J$)();this.startCamera.projectToRenderScreen(r,o);var s=(0,U.Ue)(),l=(0,U.Ue)(),u=(0,U.Ue)();(0,et.f)(s,this._scenePickPoint,this.currentCamera.eye);var c=(0,et.l)(s);(0,et.n)(s,s);var h=5*Math.max(Math.abs(this.view.camera.position.z),50),d=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80),f=null!=d?d:h;f=t?Math.min(f,c):f,(0,et.c)(u,(0,et.g)(l,this.currentCamera.eye,(0,et.j)(l,s,f))),this._panningPlane[3]=-(0,et.m)((0,va.st)(this._panningPlane),u),this.startCamera.center=(0,et.g)(l,this.startCamera.eye,(0,et.j)(l,this.startCamera.viewForward,f));var v=(0,P.md)(e.center,this._tmpScreenPointArray);ka(this._panningPlane,this.startCamera,v,this._beginScenePoint)}},{key:"_zoomSpherical",value:function(e){var t=this._beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=n,this._smoothScaling.update(t),Pa(this._sphere,this.currentCamera,this._smoothScaling.value),(0,P.md)(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Ti.ZOOM,this._constraintOptions.interactionFactor=Or(e.radius-this._beginRadius),Rr(this.view,this.currentCamera,this._constraintOptions)}},{key:"_panningSpherical",value:function(e){var t=(0,P.md)(e.center,this._tmpScreenPointArray);qa(this._sphere,this.currentCamera,t,this._tmp3d),$a(this._beginScenePoint,(0,et.m)(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(to(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(eo(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Ti.PAN,this._constraintOptions.interactionFactor=Or((0,at.TE)(this._screenPickPoint,t)),Rr(this.view,this.currentCamera,this._constraintOptions)}},{key:"_rotateSpherical",value:function(e){(0,et.n)(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||(0,et.k)(this._rotationAxis,this._rotationAxis);var t=this._smoothRotation.value,n=t+Ta(e.angle-t),i=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=i,this._smoothRotation.update(n);var r=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(r,.001*e.timestamp),Sa(this.currentCamera,(0,Ai.g)(this._sphere),ca(this._rotationAxis,r)),this._constraintOptions.interactionType=Ti.TUMBLE,this._constraintOptions.interactionFactor=Or(e.radius*n),Rr(this.view,this.currentCamera,this._constraintOptions)}},{key:"_panningPlanar",value:function(e){var t=(0,P.md)(e.center,this._tmpScreenPointArray);ka(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(Va(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Ti.PAN,this._constraintOptions.interactionFactor=Or((0,at.TE)(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Rr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}},{key:"_zoomPlanar",value:function(e){var t=this._beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=n,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Ma(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Ti.ZOOM,this._constraintOptions.interactionFactor=Or(e.radius-this._beginRadius),Rr(this.view,this.currentCamera,this._constraintOptions)}},{key:"_rotatePlanar",value:function(e){(0,et.c)(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||(0,et.k)(this._rotationAxis,this._rotationAxis);var t=this._smoothRotation.value,n=e.angle-t,i=t+(n=Ta(n)),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);var a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),Sa(this.currentCamera,(0,Ai.g)(this._sphere),ca(this._rotationAxis,a)),this._constraintOptions.interactionType=Ti.TUMBLE,this._constraintOptions.interactionFactor=Or(e.radius*a),Rr(this.view,this.currentCamera,this._constraintOptions)}}]),n}(ms);vl=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],vl);var pl=(0,U.al)(0,0,1),_l=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._rotationValueSmooth=new Qs(.05),e._scalingValueSmooth=new Qs(.05),e._planeHorizontal=(0,va.Ue)(),e._planeVertical=(0,va.Ue)(),e._rotationMomentumEstimator=new dl.y,e._panMomentumEstimator=new al.G(300,12,.9),e._zoomMomentumEstimator=new fl.D,e._beginRadius=0,e._beginCenter=(0,U.Ue)(),e._beginAngle=0,e._tmpPoints=[],e._navMode=Ra.Horizontal,e._beginCenterScreen=(0,P.s1)(),e._tmpCentroid3d=(0,U.Ue)(),e._tmpCentroid2d=(0,P.s1)(),e._tmp2d=(0,P.s1)(),e._pointerCount=0,e._beginCamera=new Xr.Z,e._constraintOptions=new Zi(xi.ALL,Ti.NONE,0,e._beginCamera),e}return(0,s.Z)(n,[{key:"begin",value:function(e){if(this.active){var t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),(0,P.md)(e.center,this._beginCenterScreen),(0,va.Oy)(pl,0,this._planeHorizontal);var n=(0,U.Ue)(),i=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,n,0===this.view.map.ground.opacity?Ca:{}),r=(0,U.Ue)();(0,et.k)(r,this.startCamera.viewForward);var a=(0,U.Ue)();(0,et.c)(a,pl);var o=(0,et.m)(r,a);this._navMode=Fa(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);var s=Math.min(5,1/Math.abs((0,et.m)(a,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);(0,va.T5)(this._planeHorizontal,this._planeHorizontal,n),this.startCamera.aboveGround||(0,va.tk)(this._planeHorizontal,this._planeHorizontal);var l=(0,U.Ue)(),u=(0,U.Ue)(),c=(0,U.Ue)();(0,et.f)(l,n,this.currentCamera.eye);var h=(0,et.l)(l);if((0,et.n)(l,l),this._navMode===Ra.Vertical){(0,et.j)(a,a,o),(0,et.f)((0,va.st)(this._planeVertical),r,a),(0,et.n)((0,va.st)(this._planeVertical),(0,va.st)(this._planeVertical)),(0,va.T5)(this._planeVertical,this._planeVertical,n);var d=this.view._stage.renderView.getMinimalDepthForArea((0,Po.$L)(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80),f=null!=d?d:s;f=i?Math.min(f,h):f,(0,et.c)(c,(0,et.g)(u,this.currentCamera.eye,(0,et.j)(u,l,f))),this._planeVertical[3]=-(0,et.m)((0,va.st)(this._planeVertical),c),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),Oa(this._tmpPoints,this._beginCenter)}else{var v=i?h:s;(0,et.c)(c,(0,et.g)(u,this.currentCamera.eye,(0,et.j)(u,l,v))),this._planeHorizontal[3]=-(0,et.m)((0,va.st)(this._planeHorizontal),c),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),Oa(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}}},{key:"update",value:function(e){if(this.active){this.currentCamera.copyFrom(this.startCamera);var t=e.pointers.size>1,n=this._navMode===Ra.Horizontal?this._planeHorizontal:this._planeVertical,i=this._beginCenter;if(t){var r=this._beginRadius/e.radius,a=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=a,this._scalingValueSmooth.update(r),Ma(this.currentCamera,i,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Ti.ZOOM,this._constraintOptions.interactionFactor=Or(Math.abs(e.radius-this._beginRadius)),Rr(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,n,this.currentCamera,this._tmpPoints),Oa(this._tmpPoints,this._tmpCentroid3d),(0,P.md)(e.center,this._tmpCentroid2d),Va(this.currentCamera,i,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Ti.PAN,this._constraintOptions.interactionFactor=Or((0,at.TE)(this._beginCenterScreen,this._tmpCentroid2d)),Rr(this.view,this.currentCamera,this._constraintOptions),t){var o=i,s=this._rotationValueSmooth.value,l=s+Ta(e.angle-s),u=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=u,this._rotationValueSmooth.update(l);var c=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(c,.001*e.timestamp);var h=(0,va.st)(this._planeHorizontal);Sa(this.currentCamera,o,ca(h,c)),this._constraintOptions.interactionType=Ti.TUMBLE,this._constraintOptions.interactionFactor=Or(Math.abs(e.radius*c)),Rr(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}}},{key:"end",value:function(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();var t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new il({view:this.view,momentum:t,zoomCenter:this._beginCenter});var n=this._rotationMomentumEstimator.evaluateMomentum();if(n)return new nl({view:this.view,momentum:n,center:this._beginCenter,axis:(0,va.st)(this._planeHorizontal)});var i=this._panMomentumEstimator.evaluateMomentum();return i?new Js({view:this.view,momentum:i}):null}},{key:"_computePlanePoints",value:function(e,t,n,i){i.length=e.size;var r=this._tmp2d,a=0;return e.forEach((function(e){r[0]=e.x,r[1]=e.y,void 0===i[a]&&(i[a]=(0,U.Ue)()),ka(t,n,r,i[a]),a+=1})),i}},{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),n}(ms);_l=(0,f._)([(0,A.j)("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],_l);var ml=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,!0))._view=e,a.pointerAction=i,a._lastEndTimestamp=0,a._lastTimestamp=0,a.registerIncoming("drag",r,(function(e){return a._handleDrag(e)})),a}return(0,s.Z)(n,[{key:"_handleDrag",value:function(e){if("mouse"!==e.data.pointerType||(0,Zo.b)(e.data,this.pointerAction)){var t=e.timestamp-this._lastEndTimestamp,n=this._momentum&&this._momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(n)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}}},{key:"_endController",value:function(e,t){var n;if(null!==(n=this._controller)&&void 0!==n&&n.active){this._lastEndTimestamp=e.timestamp;var i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}},{key:"_startController",value:function(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}},{key:"_createController",value:function(){return this._view.state.isGlobal?new vl({view:this._view}):new _l({view:this._view})}}]),n}(Do.a),gl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i){var r;return(0,o.Z)(this,n),(r=t.call(this,!0)).view=e,r.registerIncoming("pointer-down",i,(function(){return r.view.state.stopActiveCameraController()})),r}return(0,s.Z)(n)}(Do.a),yl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i){var r;return(0,o.Z)(this,n),(r=t.call(this,!0)).key=e,r.registerIncoming("key-down",i,(function(e){return r._handleKeyDown(e)})),r}return(0,s.Z)(n,[{key:"_handleKeyDown",value:function(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}]),n}(Do.a),bl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,i,r)).view=e,a}return(0,s.Z)(n,[{key:"activate",value:function(){this.view.goTo({heading:0}).catch((function(){}))}}]),n}(yl),wl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,i,r)).view=e,a}return(0,s.Z)(n,[{key:"activate",value:function(){this.view.goTo({tilt:0}).catch((function(){}))}}]),n}(yl),Cl=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,o.Z)(this,n),(i=t.call(this,!0))._view=e,i._invert=r,i.registerIncoming("vertical-two-finger-drag",(function(e){return i._handleTwoFinger(e)})),i}return(0,s.Z)(n,[{key:"_handleTwoFinger",value:function(e){var t,n,i,r=this._invert?-1:1,a=(0,P.s1)(0,e.data.delta*r);switch(e.data.action){case"begin":null!==(t=this._cameraController)&&void 0!==t&&t.end(),this._cameraController=new gs({view:this._view,pivot:os.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(a);break;case"update":null===(n=this._cameraController)||void 0===n||n.update(a);break;case"end":null!==(i=this._cameraController)&&void 0!==i&&i.end(),this._cameraController=null}}}]),n}(Do.a),xl=n(31822),Tl=n(1614),Sl=n(83659),kl=n(33666),Ml=n(11802),Pl=n(64544),Rl=n(46525),El=n(43308),Ol=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:40;return(0,o.Z)(this,n),(e=t.call(this,!1))._threshold=i,e._maxDelta=r,e._state="ready",e._emittedArtificalEnd2=!1,e._vertical=e.registerOutgoing("vertical-two-finger-drag"),e._artificalDrag=e.registerOutgoing("drag"),e._dragEventSeparator=new El.H({start:function(t,n){return e._observeStart(t,n)},update:function(t,n,i){return e._observeUpdate(t,n,i)},end:function(t,n){return e._observeEnd(n)}}),e.registerIncoming("drag",(function(t){return e._dragEventSeparator.handle(t)})),e}return(0,s.Z)(n,[{key:"failed",get:function(){return"failed"===this._state}},{key:"_observeStart",value:function(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}},{key:"_observeUpdate",value:function(e,t,n){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,n.data)?this._checkVerticalThresholdReached(t.data,n.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}},{key:"_observeEnd",value:function(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}},{key:"_checkMovementWithinLimits",value:function(e,t){var n,r=-1/0,a=1/0,o=-1/0,s=1/0,l=(0,i.Z)(t.pointers.values());try{for(l.s();!(n=l.n()).done;){var u=n.value,c=u.x,h=u.y;r=Math.max(r,c),a=Math.min(a,c),o=Math.max(o,h),s=Math.min(s,h)}}catch(S){l.e(S)}finally{l.f()}var d,f=-1/0,v=1/0,p=-1/0,_=1/0,m=(0,i.Z)(e.pointers.values());try{for(m.s();!(d=m.n()).done;){var g=d.value,y=g.x,b=g.y;f=Math.max(f,y),v=Math.min(v,y),p=Math.max(p,b),_=Math.min(_,b)}}catch(S){m.e(S)}finally{m.f()}var w=r-a,C=o-s,x=f-v,T=p-_;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(x-w)<=this._maxDelta&&Math.abs(T-C)<=this._maxDelta}},{key:"_checkVerticalThresholdReached",value:function(e,t){var n=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((function(e,i){var r=t.pointers.get(i);n=Math.min(n,Math.abs(e.y-r.y))})),n>=this._threshold}}]),n}(Do.a),Al=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"destroy",value:function(){this.disconnect()}},{key:"primaryDragAction",get:function(){return this._get("primaryDragAction")},set:function(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}},{key:"mode",get:function(){return this._get("mode")},set:function(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}},{key:"updating",get:function(){var e;return!(null===(e=this._inputManager)||void 0===e||!e.updating)}},{key:"latestPointerType",get:function(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerType}},{key:"latestPointerLocation",get:function(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerLocation}},{key:"multiTouchActive",get:function(){var e,t;return null!==(e=null===(t=this._inputManager)||void 0===t?void 0:t.multiTouchActive)&&void 0!==e&&e}},{key:"disconnect",value:function(){this.view.viewEvents.disconnect(),this._inputManager=(0,x.SC)(this._inputManager)}},{key:"connect",value:function(){var e=this,t=this.view;this._source=new xl.z(this.view.surface,t.input);var n=[new Ml.y,new Pl.e,new Rl.y,new kl.n(this.view.navigation),new Ol],i=new Tl.$({eventSource:this._source,recognizers:n});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Sl.G],Tl.f.INTERNAL),this._modeDragPan=new ml(t,"primary"),this._modeDragRotate=new ws(t,"secondary",os.CENTER),this._modeDragZoom=new Ps(t,"tertiary");var r="b",a={left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},o="n",s="p";i.installHandlers("navigation",[new gl(t),new Io(t),new Bs(t),new Ws(t,a),new Xs(t),new wl(t,s),new bl(t,o),new ws(t,"primary",os.EYE,[r]),new ws(t,"secondary",os.CENTER,[r]),new ml(t,"tertiary",[r]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Cl(t)],Tl.f.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this.addHandles((0,k.watch)((function(){var t;return null===(t=e.view.navigation)||void 0===t?void 0:t.browserTouchPanEnabled}),(function(t){e._source.browserTouchPanningEnabled=!t}),k.initial))}},{key:"isModifierKeyDown",value:function(e){var t,n;return null!==(t=null===(n=this._inputManager)||void 0===n?void 0:n.isModifierKeyDown(e))&&void 0!==t&&t}},{key:"_updateMode",value:function(){var e,t=this.mode,n=this.primaryDragAction,i=null===(e=Dl.get(t))||void 0===e?void 0:e.get(n);i&&(this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom))}},{key:"test",get:function(){}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],Al.prototype,"view",void 0),(0,f._)([(0,E.Cb)({value:"pan"})],Al.prototype,"primaryDragAction",null),(0,f._)([(0,E.Cb)({value:"default"})],Al.prototype,"mode",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Al.prototype,"updating",null),(0,f._)([(0,E.Cb)()],Al.prototype,"latestPointerType",null),(0,f._)([(0,E.Cb)()],Al.prototype,"latestPointerLocation",null),(0,f._)([(0,E.Cb)()],Al.prototype,"multiTouchActive",null),(0,f._)([(0,E.Cb)()],Al.prototype,"_inputManager",void 0),Al=(0,f._)([(0,A.j)("esri.views.3d.input.SceneInputManager")],Al);var Dl=new Map,Zl=new Map,Il=new Map;Zl.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Zl.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Il.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Il.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),Dl.set("default",Zl),Dl.set("pro",Il);var Ll,Nl,Ul=Al,Hl=n(77427),Fl=n(27546),Vl=n(94463),zl=!1,ql=!1,Bl=!1,Gl=!1,jl=null;function Wl(e){Bl=Vl.h.DECONFLICTOR_SHOW_VISIBLE,Gl=Vl.h.DECONFLICTOR_SHOW_INVISIBLE,zl=Bl||Gl,ql=Vl.h.DECONFLICTOR_SHOW_GRID,jl=null,zl||ql?jl=function(){return function(e){null==Ll&&((Ll=document.createElement("canvas")).setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Ll));var t=e.state,n=t.camera,i=t.pixelRatio,r=n.width,a=n.height,o=r*i,s=a*i;Ll.setAttribute("width","".concat(o,"px")),Ll.setAttribute("height","".concat(s,"px")),Ll.setAttribute("style","position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:".concat(r,"px;height:").concat(a,"px")),(Nl=Ll.getContext("2d")).clearRect(0,0,r,a),Nl.font="12px Arial"}(e)}:Ll&&(Ll.parentElement.removeChild(Ll),Ll=null)}function Xl(){jl&&(jl(),jl=null)}function Ql(e,t,n,i,r){Xl();var a=Ll.height,o=Nl;o.beginPath(),o.lineWidth=1,o.strokeStyle=r,o.moveTo(e,a-n),o.lineTo(t,a-n),o.stroke(),o.lineTo(t,a-i),o.stroke(),o.lineTo(t,a-n),o.stroke(),o.lineTo(e,a-n),o.stroke(),o.lineTo(e,a-n),o.stroke(),o.closePath()}function Yl(e,t){zl&&(t&&Bl||!t&&Gl)&&Ql(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var Jl,Kl=n(70446),$l=n(65216),eu=n(21400),tu=n(21166),nu=(0,r.Z)().mark(mu),iu=(0,r.Z)().mark(gu),ru=(0,U.Ue)(),au=(0,st.Ue)(),ou=(0,st.Ue)(),su=(0,U.Ue)(),lu=(0,Ut.Ue)(),uu=(0,Ai.c)(),cu=(0,Di.Ue)(),hu=(0,U.Ue)(),du=(0,B.Ue)(),fu=(0,s.Z)((function e(){(0,o.Z)(this,e),this.aabr=(0,B.Ue)(),this.distance=0,this.culled=!1,this.visible=!1})),vu=(0,s.Z)((function e(t,n){(0,o.Z)(this,e),this.graphics3DGraphic=t,this.slicePlaneEnabled=n,this.info={}}));!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(Jl||(Jl={}));var pu=function(){function e(){(0,o.Z)(this,e),this.camera=new Xr.Z,this.slicePlane=(0,G.a)(),this.slicePlaneEnabled=!1}return(0,s.Z)(e,[{key:"copyFrom",value:function(e){this.camera.copyFrom(e.camera),(0,G.c)(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}]),e}(),_u=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._dirty=!1,i._viewState=new pu,i._state=Jl.Idle,i._active=new Map,i._visible=new Map,i._iterators=new bu,i._accBinsNumX=15,i._accBinsNumY=20,i._accBinsSizeX=0,i._accBinsSizeY=0,i._accBins=null,i.accNumTests=0,i}return(0,s.Z)(n,[{key:"dirty",get:function(){return this._dirty}},{key:"state",get:function(){return this._state}},{key:"destroy",value:function(){this._active.clear(),this._visible.clear(),this._iterators=null}},{key:"setDirty",value:function(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}},{key:"updating",get:function(){return this._state!==Jl.Idle||this._dirty}},{key:"updatingProgress",get:function(){if(!this.updating)return 1;var e=this._state/Jl.NumStates;return this._dirty?.5*e:e}},{key:"running",get:function(){return this.view.ready&&null!=this.view.state&&this.updating}},{key:"runTask",value:function(e){switch(this._state){case Jl.Idle:this._startUpdate(),e.madeProgress();case Jl.Process:if(this._state=Jl.Process,!this._processActiveGraphics(e))return;case Jl.Sort:if(this._state=Jl.Sort,!this._sortVisibleGraphics(e))return;case Jl.Deconflict:if(this._state=Jl.Deconflict,!this._deconflictVisibleGraphics(e))return;default:(function(e,t){if(ql&&Nl){Xl();for(var n=Nl,i=0,r=0;r<e.accBinsNumX;r++)for(var a=0;a<e.accBinsNumY;a++){var o=e.accBins[r][e.accBinsNumY-1-a];i+=o.length;var s=r*e.accBinsSizeX,l=(r+1)*e.accBinsSizeX,u=a*e.accBinsSizeY,c=(a+1)*e.accBinsSizeY;n.fillText(o.length.toFixed(),s+5,u+15),Ql(s,l,u,c,"blue")}n.fillText("total totalShownLabels: "+i,70,40),n.fillText("total visible labels: "+t.size,70,50),n.fillText("total numTests: "+e.accNumTests,70,30)}})(this,this._visible),this._state=Jl.Idle,this.notifyChange("updating")}}},{key:"modifyGraphics",value:function(e,t){var n=this;t?e.forEach((function(e){return n.addToActiveGraphics(e)})):e.forEach((function(e){return n.removeFromActiveGraphics(e)})),this.setDirty()}},{key:"layerSupportsDeconfliction",value:function(e){var t;if(null==e||"object3d"!==e.type)return!1;var n=e.stageObject;if(1!==(null!==(t=null===n||void 0===n?void 0:n.geometries.length)&&void 0!==t?t:0))return!1;var i=null===n||void 0===n?void 0:n.geometries[0];return(null===i||void 0===i?void 0:i.material)instanceof eu.A}},{key:"_startUpdate",value:function(){Wl(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);var e=this._viewState.camera,t=e.fullWidth,n=e.fullHeight;this._initBins(t,n),this._resetIterators()}},{key:"addToActiveGraphics",value:function(e){e.info[this.visibilityGroup]=new fu,this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}},{key:"removeFromActiveGraphics",value:function(e){this._visible.delete(e.graphics3DGraphic.graphic.uid),function(e,t){var n=e.graphics3DGraphic;n.destroyed||n.setVisibilityFlag(t,Kl.P.DECONFLICTION,!0)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}},{key:"_processActiveGraphics",value:function(e){var t=this._ensureActiveGraphicsIterator(),n=(0,Nt.iS)(lu,this._viewState.camera.projectionMatrix),i="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._viewState.camera.relativeElevation>0?uu:null,r=0;for(null!=i&&((0,et.h)((0,Ai.g)(i),U.AG,this._viewState.camera.viewMatrix),i[3]=(0,nt.Iu)(this.view.spatialReference).radius,r=(0,Ai.d)(i,U.AG));!e.done;){e.madeProgress();var a=t.next();if(!0===a.done)return this._resetActiveGraphicsIterator(),!0;var o=a.value,s=null===o||void 0===o?void 0:o.info[this.visibilityGroup];s&&(this._collectGraphics3DGraphics(o,n,i,r),s.culled?this._visible.delete(o.graphics3DGraphic.graphic.uid):this._visible.set(o.graphics3DGraphic.graphic.uid,o))}return!1}},{key:"_sortVisibleGraphics",value:function(e){for(var t=this._ensureSortGraphicsIterator();!e.done;){var n=t.next();if(e.madeProgress(),!0===n.done)return this._resetSortGraphicsIterator(),!0}return!1}},{key:"_deconflictVisibleGraphics",value:function(e){for(var t=this._ensureVisibleGraphicsIterator(),n=this.visibilityGroup===Kl.E.LABEL;!e.done;){e.madeProgress();var i=t.next();if(!0===i.done)return this._resetVisibleGraphicsIterator(),!0;var r=i.value,a=r.info[this.visibilityGroup];if(a&&!a.culled){var o=r.graphics3DGraphic,s=!n||o.isVisible();a.visible=s&&!this._isConflicted(r),a.visible&&this._addToBins(r),this._setGraphicVisibility(r,a.visible),Yl(a,a.visible)}else this._setGraphicVisibility(r,!1)}return!1}},{key:"_resetIterators",value:function(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}},{key:"_ensureActiveGraphicsIterator",value:function(){return this._iterators.active||(this._iterators.active=mu(this._active)),this._iterators.active}},{key:"_resetActiveGraphicsIterator",value:function(){this._iterators.active=null}},{key:"_ensureVisibleGraphicsIterator",value:function(){return this._iterators.visible||(this._iterators.visible=mu(this._visible)),this._iterators.visible}},{key:"_resetVisibleGraphicsIterator",value:function(){this._iterators.visible=null}},{key:"_ensureSortGraphicsIterator",value:function(){return this._iterators.sort||(this._iterators.sort=gu(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}},{key:"_resetSortGraphicsIterator",value:function(){this._iterators.sort=null}},{key:"_collectGraphics3DGraphics",value:function(e,t,n,r){var a=e.graphics3DGraphic;if(!a.destroyed){var o=e.info[this.visibilityGroup];if(a.isVisible(Kl.E.GRAPHIC,Kl.P.DECONFLICTION)){var s=this.getGraphicsLayers(a);(0,B.cS)(o.aabr);var l,u=null,c=(0,i.Z)(s);try{for(c.s();!(l=c.n()).done;){var h=l.value;if(this.layerSupportsDeconfliction(h)){var d=h.stageObject.geometries[0].material;if(null==u&&(u=Tu,this._getProjectionInfo(h,t,u),u.isOutsideScreen||this._isCulledBySlice(e,ru)||null!=n&&xu(u,n,r)))return void(o.culled=!0);this._expandBoundingRect(o,h,d,u)}}}catch(f){c.e(f)}finally{c.f()}null==u?o.culled=!0:(o.distance=u.distance,o.culled=!1)}else o.culled=!0}}},{key:"_getProjectionInfo",value:function(e,t,n){var i=this._viewState.camera,r=e.stageObject,a=r.geometries[0],o=a.material,s=(0,Ai.g)(r.boundingVolumeWorldSpace.bounds);(0,et.h)(ru,s,i.viewMatrix);var l=a.attributes,u=l.get(wn.T.NORMAL).data,c=l.get(wn.T.CENTEROFFSETANDDISTANCE).data;o.applyShaderOffsetsView(ru,u,r.transformation,c,i,n.scaleInfo,ru),(0,ot.s)(au,ru[0],ru[1],ru[2],1),(0,ot.t)(ou,au,i.projectionMatrix),(0,et.j)(n.positionNDC,ou,1/ou[3]),o.applyShaderOffsetsNDC(n.positionNDC,c,i,n.positionNDC,su),n.distanceWithoutPolygonOffset=i.depthNDCToWorld(su[2]),n.distance=su[2]===n.positionNDC[2]?n.distanceWithoutPolygonOffset:i.depthNDCToWorld(n.positionNDC[2]),(0,ot.s)(ou,n.positionNDC[0],n.positionNDC[1],n.positionNDC[2],1),(0,ot.t)(au,ou,t),(0,ot.b)(au,au,1/au[3]),(0,et.s)(n.positionView,ru[0],ru[1],ru[2])}},{key:"_isCulledBySlice",value:function(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&(0,G.e)(this._viewState.slicePlane,t)}},{key:"_expandBoundingRect",value:function(e,t,n,i){var r=i.positionNDC,a=i.scaleInfo,o=this._viewState.camera,s=t.getScreenSize(wu);(0,$l.TU)(s,a.factor,s),s[0]*=o.pixelRatio,s[1]*=o.pixelRatio;var l=(0,B.cv)(n.calculateRelativeScreenBounds(s,a.factorAlignment.scale,du),(0,Se.t7)(0,o.fullWidth,.5+.5*r[0]),(0,Se.t7)(0,o.fullHeight,.5+.5*r[1])),u=this.marginFactor;if(0!==u){var c=u*Math.min((0,B.d_)(l),(0,B.Cb)(l));l[0]-=c,l[1]-=c,l[2]+=c,l[3]+=c}(0,B.jn)(e.aabr,l,e.aabr)}},{key:"_isConflicted",value:function(e){for(var t=e.graphics3DGraphic.graphic.uid,n=e.info[this.visibilityGroup],i=!0,r=Math.floor(n.aabr[0]/this._accBinsSizeX);r<=Math.floor(n.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(var a=Math.floor(n.aabr[1]/this._accBinsSizeY);a<=Math.floor(n.aabr[3]/this._accBinsSizeY);a++)if(!(a<0||a>=this._accBinsNumY)){i=!1;for(var o=this._accBins[r][a],s=0;s<o.length;s++){var l=o.data[s],u=l.info[this.visibilityGroup];if(u&&u.visible&&l.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,(0,B.kK)(u.aabr,n.aabr)))return!0}}return i}},{key:"_initBins",value:function(e,t){if(null==this._accBins){this._accBins=[];for(var n=0;n<this._accBinsNumX;n++){this._accBins.push([]);for(var i=this._accBins[this._accBins.length-1],r=0;r<this._accBinsNumY;r++)i.push(new Fl.Z)}}else for(var a=0;a<this._accBinsNumX;a++)for(var o=0;o<this._accBinsNumY;o++)this._accBins[a][o].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}},{key:"_addToBins",value:function(e){for(var t=e.info[this.visibilityGroup],n=Math.floor(t.aabr[0]/this._accBinsSizeX),i=Math.floor(t.aabr[2]/this._accBinsSizeX),r=Math.floor(t.aabr[1]/this._accBinsSizeY),a=Math.floor(t.aabr[3]/this._accBinsSizeY),o=n;o<=i;o++)if(!(o<0||o>=this._accBinsNumX))for(var s=r;s<=a;s++)s<0||s>=this._accBinsNumY||this._accBins[o][s].push(e)}},{key:"_setGraphicVisibility",value:function(e,t){var n=e.graphics3DGraphic;n.destroyed||(n.setVisibilityFlag(this.visibilityGroup,Kl.P.DECONFLICTION,t),this.visibilityGroup===Kl.E.LABEL&&this.view.labeler.setLabelGraphicVisibility(n,t))}}]),n}(Z.default);function mu(e){var t,n;return(0,r.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!Map.prototype.entries){i.next=11;break}t=e.entries(),n=t.next();case 3:if(n.done){i.next=9;break}return i.next=6,n.value[1];case 6:n=t.next(),i.next=3;break;case 9:i.next=12;break;case 11:return i.delegateYield(e.values(),"t0",12);case 12:case"end":return i.stop()}}),nu)}function gu(e,t,n){var i,a;return(0,r.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return t.clear(),e.forEach((function(e,i){var r,a=t.pushNew();a.id=i,a.visible=e.graphics3DGraphic.getVisibilityFlag(n,Kl.P.DECONFLICTION);var o=null===(r=e.info)||void 0===r?void 0:r[n];a.prio=e.graphics3DGraphic.deconflictionPriority,a.distance=o?o.distance:Number.MAX_VALUE})),void(r.next=4);case 4:i=t.iterableSort((function(e,t){return e.prio!==t.prio?t.prio-e.prio:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?e.visible?-1:1:e.id-t.id})),a=i.next();case 6:if(a.done){r.next=12;break}return void(r.next=9);case 9:a=i.next(),r.next=6;break;case 12:t.forAll((function(t){var n=e.get(t.id);n&&(e.delete(t.id),e.set(t.id,n))})),t.clear();case 13:case"end":return r.stop()}}),iu)}(0,f._)([(0,E.Cb)({constructOnly:!0})],_u.prototype,"view",void 0),(0,f._)([(0,E.Cb)({type:Boolean,readOnly:!0})],_u.prototype,"updating",null),_u=(0,f._)([(0,A.j)("esri.views.3d.layers.graphics.Deconflictor")],_u);var yu=(0,s.Z)((function e(){(0,o.Z)(this,e),this.id=0,this.visible=!1,this.prio=0,this.distance=0})),bu=(0,s.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,o.Z)(this,e),this.active=t,this.visible=n,this.sort=i,this.sortArray=new Fl.Z({allocator:function(e){return e||new yu}})})),wu=(0,ut.Ue)(),Cu=function(){function e(){(0,o.Z)(this,e),this.positionView=(0,U.Ue)(),this.positionNDC=(0,U.Ue)(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new tu.G}return(0,s.Z)(e,[{key:"isOutsideScreen",get:function(){var e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}]),e}();function xu(e,t,n){return(0,et.c)(cu.direction,e.positionView),(0,et.s)(cu.origin,0,0,0),!!(0,Ai.i)(t,cu,hu)&&e.distanceWithoutPolygonOffset>n}var Tu=new Cu,Su=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).visibilityGroup=Kl.E.LABEL,i.marginFactor=.05,i._lastDeconfliction=0,i}return(0,s.Z)(n,[{key:"viewState",get:function(){return this.parent.viewState}},{key:"runTask",value:function(e){if(this.parent.running)return en.J;var t=performance.now();if(e.state!==rs.n.IDLE&&t-this._lastDeconfliction<2e3)return en.J;(0,u.Z)((0,c.Z)(n.prototype),"runTask",this).call(this,e),this.state===Jl.Idle&&(this._lastDeconfliction=t)}},{key:"enabledChanged",value:function(e,t){this.modifyGraphics(t,e.labelsEnabled)}},{key:"getGraphicsLayers",value:function(e){return e.labelLayers}}]),n}(_u);(0,f._)([(0,E.Cb)({constructOnly:!0})],Su.prototype,"parent",void 0),Su=(0,f._)([(0,A.j)("esri.views.3d.layers.graphics.LabelDeconflictor")],Su);var ku=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._contexts=new Map,e.visibilityGroup=Kl.E.GRAPHIC,e._marginFactor=-.1,e.test={overrideMarginFactor:function(t){e._marginFactor=t,e.setDirty()}},e}return(0,s.Z)(n,[{key:"labels",get:function(){return this._labels}},{key:"viewState",get:function(){return this._viewState}},{key:"initialize",value:function(){var e=this;this.addHandles([(0,k.watch)((function(){var t,n;return null===(t=e.view)||void 0===t||null===(n=t.state)||void 0===n?void 0:n.camera}),(function(){e._updateViewState(),e.setDirty()})),(0,k.watch)((function(){var t,n,i;return null===(t=e.view)||void 0===t||null===(n=t.map)||void 0===n||null===(i=n.ground)||void 0===i?void 0:i.opacity}),(function(t,n){1!==t&&1!==n||e.setDirty()})),(0,k.watch)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.slicePlane}),(function(){e._updateSlicePlane(),e._slicePlaneChanged()}),k.initial)]),this._frameTask=this.view.resourceController.scheduler.registerTask($t.T8.GRAPHICS_DECONFLICTOR,this),this._labels=new Su({view:this.view,parent:this})}},{key:"destroy",value:function(){this._labels=(0,x.SC)(this._labels),this._frameTask=(0,x.hw)(this._frameTask)}},{key:"marginFactor",get:function(){return this._marginFactor}},{key:"setDirty",value:function(){this._contexts.size>0&&((0,u.Z)((0,c.Z)(n.prototype),"setDirty",this).call(this),this._labels.setDirty())}},{key:"runTask",value:function(e){(0,u.Z)((0,c.Z)(n.prototype),"runTask",this).call(this,e),this.running||this._labels.setDirty()}},{key:"_updateViewState",value:function(){var e;(null===(e=this.view)||void 0===e?void 0:e.state)&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}},{key:"_updateSlicePlane",value:function(){var e=this.view?this.view.slicePlane:null;null!=e&&(0,G.t)(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}},{key:"_slicePlaneChanged",value:function(){(0,Hl.oE)(this._contexts,(function(e,t){return t.symbolCreationContext.slicePlaneEnabled}))&&this.setDirty()}},{key:"addGraphicsOwner",value:function(e){var t=this,n=this._getGraphicsContext(e);return{addGraphic:function(i){return t._addGraphic(e,n,i)},removeGraphic:function(e){return t._removeGraphic(n,e)},labelingInfoChange:function(){return t._labels.enabledChanged(e,n)},featureReductionChange:function(){return t.enabledChanged(e,n)},slicePlaneEnabledChange:function(){return t._slicePlaneEnabledChanged(e,n)},clear:function(){return n.forEach((function(e){return t._removeGraphic(n,e.graphics3DGraphic)}))},remove:function(){return t._removeGraphicsOwner(e)},setDirty:function(){return t.setDirty()}}}},{key:"_removeGraphicsOwner",value:function(e){var t=this,n=this._contexts.get(e);n&&(n.forEach((function(e){return t._removeGraphic(n,e.graphics3DGraphic)})),this._contexts.delete(e),this.setDirty())}},{key:"_addGraphic",value:function(e,t,n){var i=n.graphic.uid,r=new vu(n,e.symbolCreationContext.slicePlaneEnabled);t.set(i,r),Mu(e)&&this.addToActiveGraphics(r),e.labelsEnabled&&this._labels.addToActiveGraphics(r);var a=!this._graphicSupportsDeconfliction(n)||!Mu(e);n.setVisibilityFlag(Kl.E.GRAPHIC,Kl.P.DECONFLICTION,a)}},{key:"_removeGraphic",value:function(e,t){var n=t.graphic.uid,i=e.get(n);i&&(this.removeFromActiveGraphics(i),this._labels.removeFromActiveGraphics(i),e.delete(n),this.setDirty())}},{key:"enabledChanged",value:function(e,t){var n=Mu(e);n||function(e){var t=e.graphics3DGraphics;t&&t.forEach((function(e){return e.setVisibilityFlag(Kl.E.GRAPHIC,Kl.P.DECONFLICTION,!0)}))}(e),this.modifyGraphics(t,n)}},{key:"_slicePlaneEnabledChanged",value:function(e,t){var n=e.symbolCreationContext.slicePlaneEnabled;t.forEach((function(e){return e.slicePlaneEnabled=n})),this.setDirty()}},{key:"getGraphicsLayers",value:function(e){return e.layers}},{key:"_graphicSupportsDeconfliction",value:function(e){if(e.isDraped)return!1;var t=e.layers;if(null===t||void 0===t||!t.length)return!1;var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(this.layerSupportsDeconfliction(a))return!0}}catch(o){r.e(o)}finally{r.f()}return!1}},{key:"_getGraphicsContext",value:function(e){var t=this._contexts.get(e);if(t)return t;var n=new Map;return this._contexts.set(e,n),this.setDirty(),n}}]),n}(_u);function Mu(e){var t=e.layer;return!(null===t||void 0===t||!t.featureReduction||"selection"!==t.featureReduction.type)}ku=(0,f._)([(0,A.j)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],ku);var Pu=n(31901),Ru=n(93433),Eu=n(95439),Ou=n(13470),Au=n(95773),Du=n(74702),Zu=n(29439),Iu=n(13005),Lu=n(29691),Nu=n(50628),Uu=n(96334);var Hu=n(57557),Fu=function(){function e(t,n){(0,o.Z)(this,e),this._renderCoordsHelper=t,this._getIsGroundOpaque=n,this._surfaceElevation=0,this._isGroundOpaque=!1,this._cache=new Map,this._frustumBoundingSphereCenter=(0,U.Ue)(),this._frustumBoundingSphereRadius=0,this._frustum=new Jo.i(t),this._extendedFrustum=new Jo.i(t),this._intersector=new Hu.q({renderCoordsHelper:t}),this._renderSR=t.spatialReference;var i=(0,Lu.rS)(this._renderSR);this._renderSREllipsoidRadius=(0,nt.Iu)(i).radius,this._renderCoordsHelper=t}return(0,s.Z)(e,[{key:"begin",value:function(e,t){this._surfaceElevation=t,this._aboveGround=e.aboveGround,this._isGroundOpaque=this._getIsGroundOpaque(),this._frustum.update(e),Qu(this._frustum),this._updateExtendedFrustum(e),this._updateFrustumBoundingSphere()}},{key:"end",value:function(){this._cache.clear()}},{key:"calculate",value:function(e){var t=this._renderCoordsHelper.viewingMode===he.JY.Global&&e.lij[0]>=Vu&&e.lij[0]<zu,n=this._getOrCalculateSingleTileVisibility(e,!t);return n!==Ou.E.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):n}},{key:"_calculateAggregatedChildrenVisibility",value:function(e){var t=Ou.E.INVISIBLE,n=this._cache.get(e.id);if(null!=n)return n;var r=Xu.acquire();e.getChildren(r);var a,o=(0,i.Z)(r);try{for(o.s();!(a=o.n()).done;){var s=a.value,l=this.calculate(s);if(l!==Ou.E.INVISIBLE&&(t=l,l===Ou.E.VISIBLE_ON_SURFACE))break}}catch(u){o.e(u)}finally{o.f()}return Xu.release(r),this._cache.set(e.id,t),t}},{key:"_getOrCalculateSingleTileVisibility",value:function(e,t){var n=this._cache.get(e.id);if(null!=n)return n;var i=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,i),i}},{key:"_calculateSingleTileVisibility",value:function(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===he.JY.Global&&e.lij[0]<qu?this._calculateSingleTileVisibilitySided(e,!1)===Ou.E.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}},{key:"_isTileVisibleInFrustum",value:function(e){return this._renderCoordsHelper.viewingMode===he.JY.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}},{key:"_updateFrustumBoundingSphere",value:function(){var e=this._frustum,t=e.origin,n=pc;(0,et.n)(n,e.direction);var i=e.points,r=_c;(0,et.z)(r,i[4],t);var a=.5*(0,et.m)(r,r)/(0,et.m)(n,r),o=this._frustumBoundingSphereCenter;(0,et.r)(o,t,n,a);var s=1+a;this._frustumBoundingSphereRadius=s}},{key:"_isTileVisibleInFrustumLocal",value:function(e){var t=e.tilingScheme.spatialReference,n=e.extent,i=this._renderSR,r=ac;if(r[0]=n[0],r[1]=n[1],r[2]=0,r[3]=n[2],r[4]=n[3],r[5]=0,!(0,Nu.projectBuffer)(r,t,0,r,i,0,2))return!1;var a=oc;(0,et.s)(a[0],r[0],r[1],0),(0,et.s)(a[1],r[3],r[1],0),(0,et.s)(a[2],r[3],r[4],0),(0,et.s)(a[3],r[0],r[4],0);var o=sc;(0,et.s)(o,.5*(r[0]+r[3]),.5*(r[1]+r[4]),.5*(r[2]+r[5]));var s=lc;(0,et.s)(s,0,0,1);var l=.5*(0,et.F)(a[0],a[2]),u=this._frustum,c=this._frustumBoundingSphereRadius,h=this._frustumBoundingSphereCenter,d=gc;(0,et.z)(d,h,o);var f=(0,et.m)(s,d),v=mc;if((0,et.r)(v,o,s,f),(0,et.F)(v,h)>l+c)return!1;for(var p=rc,_=this._isGroundOpaque&&this._aboveGround,m=this._isGroundOpaque&&!this._aboveGround,g=Math.min(m?zc:1/0,f+c),y=Math.max(_?-zc:-1/0,f-c),b=0;b<4;++b)(0,et.r)(p[b],a[b],s,g),(0,et.r)(p[b+4],a[b],s,y);return!tc(u.planes,p,8)}},{key:"_isTileVisibleInFrustumGlobal",value:function(e){var t=e.tilingScheme.spatialReference,n=e.extent,r=this._isGroundOpaque&&this._aboveGround,a=this._isGroundOpaque&&!this._aboveGround;if(e.lij[0]<nc)return!0;var o=oc,s=.5*(n[0]+n[2]);if((0,et.s)(o[0],n[0],n[1],0),(0,et.s)(o[1],n[2],n[1],0),(0,et.s)(o[2],n[2],n[3],0),(0,et.s)(o[3],n[0],n[3],0),(0,et.s)(o[4],s,n[1],0),(0,et.s)(o[5],s,n[3],0),!function(e,t,n,i,r,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,s=(0,Uu.R8)(t,r,Uu._U);if(null==s)return!1;if(s===Uu.iq){if(e===i&&n===a)return!0;for(var l=n+o,u=n,c=a;u<l;++u,++c)(0,et.c)(i[c],e[u]);return!0}for(var h=n+o,d=n,f=a;d<h;++d,++f)s(e[d],0,i[f],0);return!0}(o,t,0,o,this._renderSR,0,6))return!1;var l=o[0][2]>0,u=o[3][2]<0,c=l||u,h=this._renderSREllipsoidRadius;if(c){var d=(0,U.al)(0,0,1),f=cc;Yu(f,d,o[0]);var v=hc;if(Yu(v,d,o[1]),l){var p=uc,_=o[4],m=dc;Yu(m,_,d),Yu(p,m,_);var g=o[0];(0,et.b)(g,f,p),Ku(g,h);var y=o[1];(0,et.b)(y,v,p),Ku(y,h)}else if(u){var b=uc,w=o[5],C=dc;Yu(C,w,d),Yu(b,w,C);var x=o[3];(0,et.b)(x,b,f),Ku(x,h);var T=o[2];(0,et.b)(T,b,v),Ku(T,h)}}var S=sc,k=(0,et.z)(xc,o[3],o[0]);(0,et.n)(k,k);var M=(0,et.g)(Tc,o[0],o[3]);(0,et.j)(M,M,.5);var P=-(0,et.m)(M,k),R=(0,et.g)(Sc,o[0],o[1]);(0,et.j)(R,R,.5);var E=(0,et.g)(kc,o[2],o[3]);(0,et.j)(E,E,.5);var O=(0,et.z)(Mc,E,R);(0,et.n)(O,O);var A=-(P+(0,et.m)(k,R))/(0,et.m)(k,O);(0,et.r)(S,R,O,A),Ku(S,h);var D=this._frustumBoundingSphereRadius,Z=this._frustumBoundingSphereCenter,I=this._frustum,L=I.planes,N=fc;(0,et.n)(N,S);var H=(0,et.m)(o[0],N)/(0,et.H)(o[0]),F=I.origin,V=I.points,z=!1;if(r){z=!0;for(var q=(0,et.n)((0,U.Ue)(),F),B=0;B<4;++B){var G=V[4+B],j=(0,et.z)((0,U.Ue)(),G,F);(0,et.n)(j,j);var W=(0,et.b)((0,U.Ue)(),q,j);(0,et.n)(W,W);var X=(0,et.b)((0,U.Ue)(),j,W);if((0,et.n)(X,X),(0,et.m)(F,X)>h){z=!1;break}}if(z&&(0,et.m)(F,N)<h*H-zc)return!1;var Q=(0,et.n)(qc,I.origin);if((0,et.m)(Q,N)<0)return!1;var Y=(0,et.n)(Bc,I.direction);if((0,et.m)(Y,N)>Gc)return!1}var J=Math.sqrt(1-H*H);if(J>.9)return!0;var K=!1,$=(0,et.m)(N,Z),ee=(0,et.H)(Z);if(ee<=D&&!L.some((function(e){return(0,va.jH)(e,yc)>0}))){if(!r)return!0;K=!0}var te=$/ee;if(!K&&$<=0&&-$>D)return!1;var ne=D/ee;if(Math.sqrt(1-te*te)*Math.sqrt(1-ne*ne)-ne*te>J)return!1;if(!z){if(o.some((function(e){return I.intersectsPoint(e)})))return!0;if(I.intersectsPoint(S))return!0}var ie=bc;(0,et.z)(ie,Z,yc);var re=(0,et.m)(ie,N),ae=vc;(0,et.j)(ae,N,re);var oe=(0,et.F)(ae,Z),se=t.isWGS84,le=e.lij,ue=se&&le[2]===Math.pow(2,le[0])-1,ce=se&&0===le[2],he=ce?Nc:ue?Ic:Dc,de=ce?Uc:ue?Lc:Zc;if(!K){var fe,ve=o,pe=Hc,_e=Pc,me=Rc,ge=yc,ye=(0,i.Z)(he);try{for(ye.s();!(fe=ye.n()).done;){var be=fe.value,we=ve[be];if(Ju(_e,ve[(be+1)%4],we),Ju(me,ge,we),Yu(pe,me,_e),ic(pe,V,1))return!1}}catch(je){ye.e(je)}finally{ye.f()}}var Ce=null;if(!r&&re<1.01*D){var xe=2.5*D;if(oe>H*xe+D)return!1;for(var Te=Cc,Se=xe/H,ke=0;ke<4;++ke)(0,et.j)(Te[ke],o[ke],Se/h);(0,et.s)(Te[4],0,0,0),Ce=Te}else{for(var Me=(a?h+zc:re+D)/H,Pe=r?h-zc:(re-D)/H,Re=wc,Ee=0;Ee<4;++Ee){var Oe=o[Ee];(0,et.j)(Re[Ee],Oe,Pe/h),(0,et.j)(Re[Ee+4],Oe,Me/h)}Ce=Re}if(tc(L,Ce,Ce.length))return!1;var Ae,De=I.lines,Ze=Ec,Ie=Oc,Le=(0,i.Z)(De);try{for(Le.s();!(Ae=Le.n()).done;){var Ne=Ae.value;(0,et.n)(Ie,Ne.direction);var Ue,He=(0,i.Z)(de);try{for(He.s();!(Ue=He.n()).done;){var Fe=Ue.value,Ve=Ce[Fe];if((0,et.n)(Ze,Ve),Vc(Ie,Ze,Ce,V))return!1;var ze=(Fe+1)%4;if(r){var qe=Ce[ze];if((0,et.z)(Ze,qe,Ve),(0,et.n)(Ze,Ze),Vc(Ie,Ze,Ce,V))return!1}if(a){var Be=Ce[4+Fe],Ge=Ce[4+ze];if((0,et.z)(Ze,Ge,Be),(0,et.n)(Ze,Ze),Vc(Ie,Ze,Ce,V))return!1}}}catch(je){He.e(je)}finally{He.f()}}}catch(je){Le.e(je)}finally{Le.f()}return!0}},{key:"_calculateSingleTileVisibilitySided",value:function(e,t){return this._isTileVisibleInFrustum(e)?(this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t),this._intersector.isVisibleInFrustum(this._frustum,this._renderSREllipsoidRadius,!0)?Ou.E.VISIBLE_ON_SURFACE:Ou.E.VISIBLE_WHEN_EXTENDED):Ou.E.INVISIBLE}},{key:"_updateExtendedFrustum",value:function(e){this._extendedFrustum.update(e),Qu(this._extendedFrustum);var t=this._renderCoordsHelper.worldUpAtPosition(e.eye,Gu);this._aboveGround||(0,et.k)(t,t);var n=(0,Se.ZF)(-(0,et.m)(t,e.viewForward));if(this._hasExtendedFrustum=n>e.fovY/2,this._hasExtendedFrustum){for(var i=this._extendedFrustumParameters(),r=this._extendedFrustum.mutablePoints,a=0;a<4;a++){var o=i.pointIndices[a],s=r[o],l=this._renderCoordsHelper.getAltitude(s);if(i.needsAltitudeAdjustment(l)){switch(this._renderCoordsHelper.worldUpAtPosition(s,Gu),o){case Au.NQ.FAR_BOTTOM_LEFT:case Au.NQ.FAR_TOP_LEFT:case Au.NQ.NEAR_BOTTOM_LEFT:case Au.NQ.NEAR_TOP_LEFT:(0,va._l)(this._extendedFrustum.planes[Au.Nu.LEFT],Gu,Gu);break;case Au.NQ.FAR_BOTTOM_RIGHT:case Au.NQ.FAR_TOP_RIGHT:case Au.NQ.NEAR_BOTTOM_RIGHT:case Au.NQ.NEAR_TOP_RIGHT:(0,va._l)(this._extendedFrustum.planes[Au.Nu.RIGHT],Gu,Gu)}(0,et.j)(Gu,Gu,i.direction),this._renderCoordsHelper.intersectInfiniteManifold((0,Di.re)(s,Gu),i.zWithMargin,s)}}if(this._extendedFrustum.updatePoints(r),(0,va.zk)(r[Au.NQ.NEAR_BOTTOM_LEFT],r[Au.NQ.NEAR_BOTTOM_RIGHT],r[Au.NQ.NEAR_TOP_RIGHT],ju),(0,va.zk)(r[Au.NQ.NEAR_BOTTOM_RIGHT],r[Au.NQ.NEAR_TOP_RIGHT],r[Au.NQ.NEAR_TOP_LEFT],Wu),(0,et.m)((0,va.st)(ju),(0,va.st)(Wu))<0){var u,c,h=this._extendedFrustum.mutablePoints;this._aboveGround?(u=[h[Au.NQ.NEAR_BOTTOM_RIGHT],h[Au.NQ.NEAR_BOTTOM_LEFT]],h[Au.NQ.NEAR_BOTTOM_LEFT]=u[0],h[Au.NQ.NEAR_BOTTOM_RIGHT]=u[1]):(c=[h[Au.NQ.NEAR_TOP_RIGHT],h[Au.NQ.NEAR_TOP_LEFT]],h[Au.NQ.NEAR_TOP_LEFT]=c[0],h[Au.NQ.NEAR_TOP_RIGHT]=c[1]),this._extendedFrustum.updatePoints(h)}}}},{key:"_extendedFrustumParameters",value:function(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}},{key:"_extendedFrustumParametersAboveSurface",value:function(){var e=this._surfaceElevation-Bu;return{zWithMargin:e,pointIndices:Jo.i.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:function(t){return t>e}}}},{key:"_extendedFrustumParametersBelowSurface",value:function(){var e=this._surfaceElevation+Bu;return{zWithMargin:e,pointIndices:Jo.i.planePointIndices.top,direction:1,needsAltitudeAdjustment:function(t){return t<e}}}}]),e}(),Vu=2,zu=6,qu=12,Bu=1,Gu=(0,U.Ue)(),ju=(0,va.Ue)(),Wu=(0,va.Ue)(),Xu=new Iu.Z(Array,(function(e){4!==e.length&&(e[0]=new Ou.C,e[1]=new Ou.C,e[2]=new Ou.C,e[3]=new Ou.C)}),(function(e){e[0].release(),e[1].release(),e[2].release(),e[3].release()}));function Qu(e){var t,n=Jo.i.nearFarLineIndices,r=e.mutablePoints,a=(0,i.Z)(n);try{for(a.s();!(t=a.n()).done;){var o=t.value,s=(0,Zu.Z)(o,2),l=s[0],u=s[1],c=r[l],h=r[u];(0,et.f)(Gu,h,c),(0,et.j)(Gu,Gu,.95),(0,et.g)(r[u],c,Gu)}}catch(d){a.e(d)}finally{a.f()}e.updatePoints(r)}function Yu(e,t,n){return(0,et.b)(e,t,n),(0,et.n)(e,e),e}function Ju(e,t,n){return(0,et.z)(e,t,n),(0,et.n)(e,e),e}function Ku(e,t){return(0,et.j)(e,e,t/(0,et.H)(e)),e}var $u=[Au.Nu.LEFT,Au.Nu.RIGHT,Au.Nu.BOTTOM,Au.Nu.TOP,Au.Nu.FAR];function ec(e,t,n){for(var i=0;i<n;++i)if((0,va.jH)(e,t[i])<=0)return!1;return!0}function tc(e,t,n){var r,a=(0,i.Z)($u);try{for(a.s();!(r=a.n()).done;){if(ec(e[r.value],t,n))return!0}}catch(o){a.e(o)}finally{a.f()}return!1}var nc=4;function ic(e,t,n){var r,a=(0,i.Z)(t);try{for(a.s();!(r=a.n()).done;){var o=r.value;if((0,et.m)(o,e)<n)return!1}}catch(s){a.e(s)}finally{a.f()}return!0}var rc=[(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)()],ac=[0,0,0,0,0,0],oc=[(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)()],sc=(0,U.Ue)(),lc=(0,U.Ue)(),uc=(0,U.Ue)(),cc=(0,U.Ue)(),hc=(0,U.Ue)(),dc=(0,U.Ue)(),fc=(0,U.Ue)(),vc=(0,U.Ue)(),pc=(0,U.Ue)(),_c=(0,U.Ue)(),mc=(0,U.Ue)(),gc=(0,U.Ue)(),yc=(0,U.al)(0,0,0),bc=(0,U.Ue)(),wc=[(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)()],Cc=[(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)()],xc=(0,U.Ue)(),Tc=(0,U.Ue)(),Sc=(0,U.Ue)(),kc=(0,U.Ue)(),Mc=(0,U.Ue)(),Pc=(0,U.Ue)(),Rc=(0,U.Ue)(),Ec=(0,U.Ue)(),Oc=(0,U.Ue)(),Ac=(0,U.Ue)(),Dc=[0,1,2,3],Zc=[0,1,2,3],Ic=[0,1,3],Lc=[0,1,3],Nc=[1,2,3],Uc=[1,2,3],Hc=(0,U.Ue)();var Fc=[0,0];function Vc(e,t,n,r){if(0===n.length||0===r.length)return!0;var a=Ac;Yu(a,e,t);var o=r[0]<n[0],s=o?n:r,l=Fc;return function(e,t,n){var r,a=1/0,o=-1/0,s=(0,i.Z)(n);try{for(s.s();!(r=s.n()).done;){var l=r.value,u=(0,et.m)(t,l);a=Math.min(a,u),o=Math.max(o,u)}}catch(c){s.e(c)}finally{s.f()}e[0]=a,e[1]=o}(l,a,o?r:n),function(e,t,n,r){var a,o=1/0,s=-1/0,l=(0,i.Z)(r);try{for(l.s();!(a=l.n()).done;){var u=a.value,c=(0,et.m)(n,u);if(o=Math.min(o,c),s=Math.max(s,c),o<=t&&s>=e)return!1}}catch(h){l.e(h)}finally{l.f()}return!0}(l[0],l[1],a,s)}var zc=430,qc=(0,U.Ue)(),Bc=(0,U.Ue)(),Gc=Math.cos(.25*Math.PI),jc=function(){function e(t){(0,o.Z)(this,e),this._camera=new Xr.Z,this._focusOnMap=[0,0],this._screenRect=(0,B.Ue)(),this._tileSize=t.tileSize,this._renderCoordsHelper=t.renderCoordsHelper,this._tilingScheme=t.tilingScheme,this._visibility=new Fu(t.renderCoordsHelper,t.getIsGroundOpaque)}return(0,s.Z)(e,[{key:"begin",value:function(e,t,n){this._camera.copyFrom(e),this._surfaceElevation=n,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,(0,B.al)(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,n)}},{key:"end",value:function(){this._visibility.end()}},{key:"updateTile",value:function(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=(0,B.TE)(e.extent,this._focusOnMap),e.measures.visibility!==Ou.E.INVISIBLE&&this._updateScreenMeasure(e)}},{key:"_updateScreenMeasure",value:function(e){var t=Wc,n=1<<t,i=e.measures.screenRect;(0,B.cS)(i);var r=0,a=e.lij,o=a[0],s=o+t,l=a[1]<<t,u=a[2]<<t,c=this._tileSizeWithBias(e),h=c*c,d=this._camera,f=d.frustum,v=d.viewport;if(this._renderCoordsHelper.viewingMode===he.JY.Local||o>nc){var p=Yc;this._tilingScheme.getExtent(a[0],a[1],a[2],p);for(var _=Qc,m=nh,g=(0,B.cS)(),y=0;y<4;++y)this._toRenderCoords(p,ih[y][0],ih[y][1],m[y]),d.projectToScreen(m[y],_[y]),(0,B.Ho)(g,_[y]);var b=tc(f,m,4),w=g[0]>v[2]||g[1]>v[3]||g[2]<v[0]||g[3]<v[1];if(b||w)return void(e.measures.shouldSplit=!1)}for(var C=0;C<n;C++)for(var x=0;x<n;x++)if((r+=this._computeScreenArea(s,l+C,u+x,i))>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}},{key:"_tileSizeWithBias",value:function(e){return e.measures.visibility===Ou.E.VISIBLE_WHEN_EXTENDED?this._tileSize*Xc:this._tileSize}},{key:"_computeScreenArea",value:function(e,t,n,i){this._tilingScheme.ensureMaxLod(e);var r=Yc;this._tilingScheme.getExtent(e,t,n,r);var a=Kc;return this._toRenderCoords(r,0,3,a[0]),this._toRenderCoords(r,2,3,a[1]),this._toRenderCoords(r,2,1,a[2]),this._toRenderCoords(r,0,1,a[3]),this._computeTriangleScreenArea([a[0],a[1],a[2]],i)+this._computeTriangleScreenArea([a[2],a[1],a[3]],i)}},{key:"_computeTriangleScreenArea",value:function(e,t){for(var n=this._camera.frustum[Au.Nu.NEAR],i=0,r=-1,a=-1,o=0;o<3;++o)(0,va.jH)(n,e[o])>0?(i++,-1===r&&(r=o)):-1===a&&(a=o);if(0===i)return this._computeTriangleScreenAreaInside(e,t);if(1===i){var s=eh,l=(r+1)%3,u=(r+2)%3,c=r;(0,et.c)(s[0],e[l]),(0,et.c)(s[1],e[u]),th(s[2],e[u],e[c],n);var h=this._computeTriangleScreenAreaInside(s,t);return th(s[1],e[l],e[c],n),h+this._computeTriangleScreenAreaInside(s,t)}if(2===i){var d=eh,f=a;(0,et.c)(d[0],e[f]);var v=(a+1)%3,p=(a+2)%3;return th(d[1],e[f],e[v],n),th(d[2],e[f],e[p],n),this._computeTriangleScreenAreaInside(d,t)}return 0}},{key:"_computeTriangleScreenAreaInside",value:function(e,t){for(var n=0;n<3;n++)this._camera.projectToRenderScreen(e[n],$c),this._camera.renderToScreen($c,Qc[n]),(0,B.jn)(t,Qc[n],t);return(0,Du.wu)(Qc[0],Qc[1],Qc[2])}},{key:"_toRenderCoords",value:function(e,t,n,i){return Jc[0]=e[t],Jc[1]=e[n],Jc[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(Jc,this._tilingScheme.spatialReference,i),i}}]),e}(),Wc=2,Xc=5,Qc=[(0,P.s1)(),(0,P.s1)(),(0,P.s1)(),(0,P.s1)()],Yc=(0,B.Ue)(),Jc=(0,U.Ue)(),Kc=[(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)()],$c=(0,P.J$)(),eh=[(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)()];function th(e,t,n,i){var r=(0,va.jH)(i,t),a=(0,va.jH)(i,n),o=Math.abs(a-r);(0,et.j)(e,t,Math.abs(a)/o),(0,et.r)(e,e,n,Math.abs(r)/o)}var nh=[(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)(),(0,U.Ue)()],ih=[[0,3],[2,3],[2,1],[0,1]],rh=n(65206),ah=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).tiles=new _.Z,i.tileSize=512,i._idToTile=new Map,i._clients=new Set,i._dirty=!1,i._pendingTiles=null,i._newTiles=new Fl.Z,i}return(0,s.Z)(n,[{key:"tilingScheme",get:function(){var e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}},{key:"filterExtent",set:function(e){if(null==e||e.spatialReference.equals(this.viewState.spatialReference)){var t=this._get("filterExtent");if(!(t===e||null!=t&&e&&t.equals(e))){var n=null!=e?e.clone():null;this._set("filterExtent",n),this._setDirty()}}else C.Z.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view")}},{key:"_filterExtentRect",get:function(){if(null==this.filterExtent)return null;var e=(0,B.Ue)();return(0,rh.G)(this.filterExtent,e,this.tilingScheme.spatialReference),e}},{key:"_rootTileIds",get:function(){var e=this.tilingScheme;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}},{key:"suspended",set:function(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}},{key:"updating",get:function(){return this._dirty||!!this._pendingTiles}},{key:"initialize",value:function(){var e=this;this.addHandles([(0,k.watch)((function(){return[e.tilingScheme,e.tileSize]}),(function(){return e._reset()}),k.sync),(0,k.watch)((function(){var t,n,i;return[e.tileSize,null===(t=e.cameraOnSurface)||void 0===t?void 0:t.location,e.tilingScheme,null===(n=e.viewState)||void 0===n?void 0:n.contentCamera,null===(i=e.focus)||void 0===i?void 0:i.location]}),(function(){return e._setDirty()}),k.syncAndInitial),(0,k.watch)((function(){var t,n;return null!==(t=null===(n=e.terrain)||void 0===n?void 0:n.baseOpacity)&&void 0!==t?t:1}),(function(){return e._setDirty()}))]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask($t.T8.FEATURE_TILE_TREE,this))}},{key:"destroy",value:function(){this._frameWorker=(0,x.hw)(this._frameWorker)}},{key:"addClient",value:function(){var e=this,t=(0,Eu.D)();return this._clients.add(t),1===this._clients.size&&this._setDirty(),(0,b.kB)((function(){return e._removeClient(t)}))}},{key:"_removeClient",value:function(e){this._clients.delete(e),this._hasClients||this._clear()}},{key:"_hasClients",get:function(){return this._clients.size>0}},{key:"_setDirty",value:function(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask($t.G5))}},{key:"_clear",value:function(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),null!=this._frameWorker&&(this._frameWorker.priority=$t.T8.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||null==this._frameWorker||(this._frameWorker.priority=$t.T8.FEATURE_TILE_TREE),this.notifyChange("updating")}},{key:"_startUpdate",value:function(){var e,t=this;if(!this.suspended)if(this.tilingScheme){this._tileMeasurements||(this._tileMeasurements=new jc({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize,getIsGroundOpaque:function(){var e,n;return 1===(null!==(e=null===(n=t.terrain)||void 0===n?void 0:n.baseOpacity)&&void 0!==e?e:1)}}));var n=this.viewState.contentCamera;this._tileMeasurements.begin(n,this.focus.location,null!==(e=this.cameraOnSurface.location.z)&&void 0!==e?e:0),this._pendingTiles=this._getRootTiles()}else this._clear()}},{key:"_reset",value:function(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}},{key:"_getRootTiles",value:function(){var e=this.tilingScheme;return this._rootTileIds.map((function(t){return new Ou.C(t[0],t[1],t[2],e)}))}},{key:"_purgeHorizonTiles",value:function(e){if(e.sort((function(e,t){var n=e.measures.screenRect,i=t.measures.screenRect;return n[1]+n[3]-(i[1]+i[3])})),!(e.length>lh))return e.toArray();(0,B.cS)(oh);for(var t=0;t<e.length;t++)if((0,B.jn)(oh,e.data[t].measures.screenRect,oh),(0,B.Cb)(oh)>sh)return e.data.slice(t,e.length);return[]}},{key:"_subdivideTilesForView",value:function(e){if(this._pendingTiles){for(var t=this.tilingScheme;this._pendingTiles.length>0&&!e.done;){var n,i=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!(0,B.kK)(this._filterExtentRect,i.extent)||(this._tileMeasurements.updateTile(i),i.measures.visibility!==Ou.E.INVISIBLE&&(i.measures.shouldSplit?(t.ensureMaxLod(i.lij[0]+1),(n=this._pendingTiles).push.apply(n,(0,Ru.Z)(i.getChildren()))):this._newTiles.push(i)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}},{key:"_updateTiles",value:function(e){var t,n=this,r=(0,i.Z)(this.tiles.items);try{for(r.s();!(t=r.n()).done;){t.value.used=!1}}catch(s){r.e(s)}finally{r.f()}var a=e.filter((function(e){var t=n._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):n._idToTile.set(e.id,e),!t})),o=this.tiles.items.filter((function(e){return!e.used&&(n._idToTile.delete(e.id),!0)}));this.tiles.removeMany(o),this.tiles.addMany(a),this._sortTiles()}},{key:"_sortTiles",value:function(){this.viewState.fixedContentCamera||this.tiles.sort((function(e,t){return e.measures.visibility!==t.measures.visibility?e.measures.visibility===Ou.E.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance})),this.tiles.forEach((function(e,t){return e.loadPriority=t}))}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],ah.prototype,"scheduler",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],ah.prototype,"renderCoordsHelper",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],ah.prototype,"tilingSchemeOwner",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],ah.prototype,"cameraOnSurface",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],ah.prototype,"focus",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],ah.prototype,"viewState",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],ah.prototype,"terrain",void 0),(0,f._)([(0,E.Cb)()],ah.prototype,"tiles",void 0),(0,f._)([(0,E.Cb)()],ah.prototype,"tileSize",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ah.prototype,"tilingScheme",null),(0,f._)([(0,E.Cb)()],ah.prototype,"filterExtent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ah.prototype,"_filterExtentRect",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ah.prototype,"_rootTileIds",null),(0,f._)([(0,E.Cb)({value:!1})],ah.prototype,"suspended",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ah.prototype,"updating",null),ah=(0,f._)([(0,A.j)("esri.views.3d.layers.support.FeatureTileTree3D")],ah);var oh=(0,B.Ue)(),sh=10,lh=50,uh=n(3073),ch=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._propertiesPool=new ts.L({camera:Xr.Z},(0,l.Z)(e)),e._lastSeenCameraProjectionValues=new Xr.Z,e.mode=rs.n.ANIMATING,e._cssCamera=new Xr.Z,e._camera=new Xr.Z,e.rasterPixelRatio=1,e.contentPixelRatio=1,e.events=new $.Z,e.viewingMode=he.JY.Global,e._cameraChanged=!1,e._updateQueue=new Array,e._processingUpdates=!1,e}return(0,s.Z)(n,[{key:"init",value:function(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new Pe({mode:this.viewingMode}))}},{key:"exit",value:function(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new ts.L({camera:Xr.Z},this)}},{key:"destroy",value:function(){var e;this.cameraController=null,null!==(e=this._propertiesPool)&&void 0!==e&&e.destroy(),this._propertiesPool=null}},{key:"createInitialCamera",value:function(){if(this.viewingMode===he.JY.Global){var e=(0,nt.Iu)(this.spatialReference).radius;this.camera=new Xr.Z({eye:(0,U.al)(4*e,0,0),center:(0,U.al)(e,0,0),up:(0,U.al)(0,0,1)})}else this.camera=new Xr.Z({eye:(0,U.al)(0,0,100),center:(0,U.al)(0,0,0),up:(0,U.al)(0,1,0)})}},{key:"animation",get:function(){return this.cameraController instanceof $r&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}},{key:"cssCamera",get:function(){var e=this._cssCamera.copyFrom(this.camera),t=this.camera,n=t.height,i=t.width,r=t.pixelRatio;return e.pixelRatio=1,e.height=Math.round(n/r),e.width=Math.round(i/r),e}},{key:"camera",get:function(){return this._camera},set:function(e){var t=this;e!==fh&&fh.copyFrom(e),fh.computeUp(this.viewingMode),this.events.emit("before-camera-change",fh);var n=this._camera;if(function(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[ns.Np.TOP]!==t.padding[ns.Np.TOP]||e.padding[ns.Np.RIGHT]!==t.padding[ns.Np.RIGHT]||e.padding[ns.Np.BOTTOM]!==t.padding[ns.Np.BOTTOM]||e.padding[ns.Np.LEFT]!==t.padding[ns.Np.LEFT]}(this._lastSeenCameraProjectionValues,fh)&&(this._lastSeenCameraProjectionValues.copyFrom(fh),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!n.equals(fh)&&(this._camera=this._propertiesPool.get("camera").copyFrom(fh),this._cameraChanged=!n.almostEquals(fh),this._cameraChanged))var i=(0,uh.Fs)((function(){t._cameraChanged=!1,i.remove()}))}},{key:"pixelRatio",get:function(){return this.camera.pixelRatio}},{key:"alignPixelEnabled",get:function(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===rs.n.IDLE}},{key:"updating",get:function(){return this.mode!==rs.n.IDLE}},{key:"contentCamera",get:function(){var e;return null!==(e=this._contentCamera)&&void 0!==e?e:this.camera},set:function(e){this._contentCamera=null!=e?e.clone():null}},{key:"fixedContentCamera",get:function(){return null!=this._contentCamera}},{key:"isGlobal",get:function(){return this.viewingMode===he.JY.Global}},{key:"isLocal",get:function(){return this.viewingMode===he.JY.Local}},{key:"navigating",get:function(){var e;return!(null===(e=this.cameraController)||void 0===e||!e.isInteractive)}},{key:"stationary",get:function(){return!this._cameraChanged&&!this.navigating}},{key:"cameraController",get:function(){return this._get("cameraController")},set:function(e){var t,n=this;this.stopActiveCameraController()?(null!==(t=this.cameraController)&&void 0!==t&&t.destroy(),e&&(this.removeHandles(vh),this.addHandles((0,k.when)((function(){return e.state===Nr.Finished||e.state===Nr.Stopped}),(function(){n._set("cameraController",null),n.updateCamera((function(t){return e.onControllerEnd(t)}))}),{sync:!0,once:!0}),vh),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=Nr.Rejected)}},{key:"switchCameraController",value:function(e){return this.cameraController=e,e.state!==Nr.Rejected}},{key:"stopActiveCameraController",value:function(){return!(this.cameraController&&!this.cameraController.stopController())}},{key:"updateCamera",value:function(e){this._updateQueue.push(e),this._processUpdateQueue()}},{key:"_processUpdateQueue",value:function(){if(0!==this._updateQueue.length&&!this._processingUpdates){this._processingUpdates=!0;var e=this._updateQueue.shift();fh.copyFrom(this._get("camera")),e(fh),this.camera=fh,this._processingUpdates=!1,this._processUpdateQueue()}}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],ch.prototype,"mode",void 0),(0,f._)([(0,E.Cb)({readOnly:!0,type:ce.Z})],ch.prototype,"animation",null),(0,f._)([(0,E.Cb)({type:Xr.Z})],ch.prototype,"cssCamera",null),(0,f._)([(0,E.Cb)()],ch.prototype,"_cssCamera",void 0),(0,f._)([(0,E.Cb)({type:Xr.Z})],ch.prototype,"camera",null),(0,f._)([(0,E.Cb)()],ch.prototype,"_camera",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"pixelRatio",null),(0,f._)([(0,E.Cb)()],ch.prototype,"rasterPixelRatio",void 0),(0,f._)([(0,E.Cb)()],ch.prototype,"contentPixelRatio",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"alignPixelEnabled",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"updating",null),(0,f._)([(0,E.Cb)({})],ch.prototype,"_contentCamera",void 0),(0,f._)([(0,E.Cb)({type:Xr.Z})],ch.prototype,"contentCamera",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"fixedContentCamera",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"constraints",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"events",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"isGlobal",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"isLocal",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"viewingMode",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ch.prototype,"spatialReference",void 0),(0,f._)([(0,E.Cb)()],ch.prototype,"navigating",null),(0,f._)([(0,E.Cb)()],ch.prototype,"stationary",null),(0,f._)([(0,E.Cb)()],ch.prototype,"_cameraChanged",void 0),(0,f._)([(0,E.Cb)()],ch.prototype,"cameraController",null);var hh=ch=(0,f._)([(0,A.j)("esri.views.3d.state.ViewState")],ch);var dh,fh=new Xr.Z,vh="ViewStateHandles",ph=n(74509),_h=n(9985),mh=n(54463),gh=n(22178),yh=function(){function e(t,n,i){(0,o.Z)(this,e),this.viewingMode=t,this._forEachLayer=n,this._view=i,this._externalIntersectionHandlers=new Fl.Z,this._tolerance=ea.jb,this._tmpRay=(0,Di.Ue)(),this._tmpRegion=(0,B.Ue)(),this._validateHUDIntersector=(0,ea.Z8)(this.viewingMode),this._validateHUDIntersector.options.hud=!1}return(0,s.Z)(e,[{key:"intersectScreen",value:function(e,t,n){return this.intersectRay(this._getPickRay(e,this._tmpRay),xh(this.viewingMode),t,n)}},{key:"intersectScreenFreePointFallback",value:function(e,t,n){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,n)}},{key:"intersectRayFreePointFallback",value:function(e,t,n){return this.intersectRay(e,xh(this.viewingMode),t,n)||this._intersectRayFreePointLocal(e,t)}},{key:"intersectRay",value:function(e,t,n,i){return t.options.selectionMode=!1,t.options.store=mh.eC.MIN,this.computeIntersection(e,t,i),!!t.results.min&&t.results.min.getIntersectionPoint(n)}},{key:"getCenterRayWithSubpixelOffset",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.5;return e.getRenderCenter(Ph,n,i),Ph[0]+=.0466,Ph[1]-=.0123,(0,pa.eW)(e,Ph,t)}},{key:"intersectIntersectorScreen",value:function(e,t,n){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,n)}},{key:"intersectToolIntersectorScreen",value:function(e,t,n){var i=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(i,t,n)}},{key:"intersectToolIntersectorRay",value:function(e,t,n){t.options.selectionMode=!0,this.computeIntersection(e,t,n);var i=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||(0,gh.nn)(i)&&i.intersector!==mh.q7.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,n))}},{key:"setTolerance",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ea.jb;this._tolerance=e}},{key:"addIntersectionHandler",value:function(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((function(e,t){return e.type===mh.q7.TERRAIN?1:t.type===mh.q7.TERRAIN?-1:0}))}},{key:"removeIntersectionHandler",value:function(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort((function(e,t){return e.type===mh.q7.TERRAIN?1:t.type===mh.q7.TERRAIN?-1:0}))}},{key:"_getPickRay",value:function(e,t){var n=this._view.state.camera;return(0,pa.u4)(n,e,t)}},{key:"_intersectRayFreePointLocal",value:function(e,t){return this.viewingMode!==he.JY.Local||null==e||(0,et.g)(t,e.origin,(0,et.n)(la.WM.get(),e.direction)),!1}},{key:"intersectElevationFromScreen",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,n,i)}},{key:"_intersectElevation",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null==e)return null;var r=this._view,a=r.renderCoordsHelper,o=(0,Uo._R)(r.spatialReference),s=null!=t?t.mode:"absolute-height",l=(0,ph.fm)(t)/o,u=("on-the-ground"!==s?l+n:0)*o/a.unitInMeters,c=r.state.camera;if("absolute-height"===s){var h=null===a||void 0===a?void 0:a.getAltitude(c.eye),d=(0,et.m)((0,et.n)(kh,e.direction),a.worldUpAtPosition(c.eye,Mh));if(h<u&&d<0||h>=u&&d>0)return null;if(a.intersectInfiniteManifold(e,u,kh)){var f,v=(0,_h.K0)(r,kh);return null!==(f=v.z)&&void 0!==f||(v.z=0),v.z-=l,v}return null}var p=(0,P.Wv)(la.WM.get());c.projectToRenderScreen(e.origin,p);var _=new Th(null,this._forEachLayer),m=r.slicePlane,g=null!=m?(0,gh.e4)(m):null,y=(0,ea.Z8)(this.viewingMode);y.options.store=mh.eC.MIN,y.options.verticalOffset=u,y.options.normalRequired=!1;var b=e.origin,w=(0,et.g)(la.WM.get(),b,e.direction);y.reset(b,w,c),y.point=p;var C=i?"type"in i&&"graphics"===i.type?function(e){return e.layerUid!==i.uid}:function(e){return e.graphicUid!==i.uid}:null;switch(s){case"relative-to-scene":var x=function(e){return(!C||C(e))&&!!e.lastValidElevationBB};y.intersect(_.layers,p,this._tolerance,null,x),this._externalIntersectionHandlers.forAll((function(e){if(e.type===mh.q7.I3S||e.type===mh.q7.TERRAIN||e.type===mh.q7.TILES3D){var t=e.slicePlaneEnabled?g:null;e.intersect(y,t,y.rayBegin,y.rayEnd,p)}}));break;case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((function(e){if(e.isGround){var t=e.slicePlaneEnabled?g:null;e.intersect(y,t,y.rayBegin,y.rayEnd,p)}}))}if(y.results.min.getIntersectionPoint(kh)){var T=(0,_h.K0)(r,kh);return T.z=n,T}return null}},{key:"computeIntersection",value:function(e,t,n,r){if(null!=e){var a=this._view.state.camera,o=(0,P.Wv)(la.WM.get());a.projectToRenderScreen(e.origin,o);var s=new Th(n,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!n||!("include"in n||"exclude"in n);var l=e.origin,u=(0,et.g)(la.WM.get(),e.origin,e.direction);t.reset(l,u,a),t.intersect(s.layers,o,this._tolerance);var c=this._view.slicePlane,h=null!=c?(0,gh.e4)(c):null;t.intersect(s.sliceableLayers,o,this._tolerance,h);var d=n&&(n.requiresGroundFeedback||n.enableDraped);this._externalIntersectionHandlers.forAll((function(e){var n=e.layerUid,a=Array.isArray(n),c=a?n:[n];a&&(t.options.filteredLayerUids=[]);var f,v=!1,p=(0,i.Z)(c);try{for(p.s();!(f=p.n()).done;){var _=f.value;s.filterLayerUid(_)?v=!0:a&&t.options.filteredLayerUids.push(_)}}catch(g){p.e(g)}finally{p.f()}if(t.options.isFiltered=!v,e.isGround&&d||!t.options.isFiltered){var m=e.slicePlaneEnabled?h:null;e.intersect(t,m,l,u,o,r)}}));var f=la.WM.get(),v=this._view.basemapTerrain;if(n&&n.enableDraped&&null!=v.spatialReference&&t.results.ground.getIntersectionPoint(f)){var p,_,m=v.overlayManager.renderer,g=this._view.renderCoordsHelper.spatialReference,y=la.WM.get();this._view.renderCoordsHelper.fromRenderCoords(f,y,v.spatialReference),y[2]=null!==(p=null===(_=this._view.elevationProvider)||void 0===_?void 0:_.getElevation(f[0],f[1],f[2],g,"ground"))&&void 0!==p?p:0,m.intersect(t,y,t.results.ground,(function(e){return s.filterRenderGeometry(e)}))}t.sortResults(),this._processHUDResults(t)}}},{key:"_processHUDResults",value:function(e){var t=e.results.hud;(0,B.JG)(this._tmpRegion,B.G_);var n=this._view.state.camera,r=[],a=this._tmpRegion,o=function(e){var t=new Ch(e);n.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),r.push(t),(0,B.Ho)(a,t.screenPoint)};e.sortResults(t.all),null!=t.min.dist&&o(t.min);var s,l=(0,i.Z)(t.all);try{for(l.s();!(s=l.n()).done;){var u=s.value;t.min.target.object!==u.target.object&&t.max.target.object!==u.target.object&&o(u)}}catch(M){l.e(M)}finally{l.f()}if(null!=t.max.dist&&t.max.target.object!==t.min.target.object&&o(t.max),r.length){a[0]===a[2]&&(a[2]+=1),a[1]===a[3]&&(a[3]+=1);var c=n.fullWidth,h=n.fullHeight,d=Math.max(0,a[0]-bh),f=Math.max(0,a[1]-bh),v=Math.min((0,B.d_)(a)+2*bh,c-d),p=Math.min((0,B.Cb)(a)+2*bh,h-f);if(!(v<=0||p<=0)){var _=new Uint8Array(v*p*4);this._view._stage.renderer.readHUDVisibility(d,f,v,p,_);for(var m=!0,g=null==e.results.max.dist,y=0,b=0,w=r;b<w.length;b++){var C,x=w[b],T=(0,i.Z)(wh);try{for(T.s();!(C=T.n()).done;){var S=C.value,k=4*(Math.min(x.screenPoint[0]+S[0],c)-a[0]+(Math.min(x.screenPoint[1]+S[1],h)-a[1])*v);if(!(k<0||k>=_.length)&&_[k]){m&&(e.results.min.copy(x.result),m=!1),g&&e.results.max.copy(x.result),e.options.store===mh.eC.ALL&&e.results.all.splice(y++,0,x.result);break}}}catch(M){T.e(M)}finally{T.f()}}}}}}]),e}(),bh=1,wh=function(){for(var e=[],t=bh,n=-t;n<=t;n++)for(var i=-t;i<=t;i++)e.push([i+t,n+t]);return e}(),Ch=(0,s.Z)((function e(t){(0,o.Z)(this,e),this.result=t,this.screenPoint=(0,P.J$)()}));function xh(e){return dh&&dh.viewingMode===e||(dh=(0,ea.Z8)(e)),dh}var Th=function(){function e(t,n){var i=this;(0,o.Z)(this,e),this.layers=new Array,this.sliceableLayers=new Array,this.include=null===t||void 0===t?void 0:t.include,this.exclude=null===t||void 0===t?void 0:t.exclude,n((function(e){e.pickable&&i.filterLayerUid(e.apiLayerUid)&&(e.sliceable?i.sliceableLayers:i.layers).push(e)}))}return(0,s.Z)(e,[{key:"filterLayerUid",value:function(e){var t=this.include,n=this.exclude;return null==e?null==t&&null==n:(null==t||t.has(e))&&(null==n||!n.has(e))}},{key:"filterRenderGeometry",value:function(e){return this.filterLayerUid(e.layerUid)}}]),e}();function Sh(e){return"object"==typeof e&&"intersect"in e}var kh=(0,U.Ue)(),Mh=(0,U.Ue)(),Ph=(0,P.J$)(),Rh=n(91293),Eh=n(2985),Oh=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._im=new Array,i._ground=new Array,i._scene=new Array,i.lastElevationQuery=null,i._cacheEnabled=!1,i}return(0,s.Z)(n,[{key:"spatialReference",get:function(){var e,t;return null===(e=this.view)||void 0===e||null===(t=e.basemapTerrain)||void 0===t?void 0:t.spatialReference}},{key:"destroy",value:function(){this._cachedQuery=(0,x.SC)(this._cachedQuery)}},{key:"enableCache",value:function(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}},{key:"getElevation",value:function(e,t,n,i,r){if(this._cacheEnabled&&null!=this.lastElevationQuery){var a=this.lastElevationQuery;if(e===a.x&&t===a.y&&n===a.z&&(0,tt.fS)(i,a.spatialReference)&&r===a.queryContext)return a.result}var o=null;return null==(o=Ah(o,this._im,e,t,n,i,r))&&(o=Ah(o,this._ground,e,t,n,i,r)),"scene"===r&&(o=Ah(o,this._scene,e,t,n,i,r)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:n,spatialReference:i,queryContext:r,result:o}),o}},{key:"getSphereElevationBounds",value:function(e,t,n){var r=new Eh.r;function a(a){var o,s=(0,i.Z)(a);try{for(s.s();!(o=s.n()).done;){var l=o.value;if(l.getSphereElevationBounds){var u=l.getSphereElevationBounds(e,t,n);null!=u&&r.expandElevationRangeValues(u.elevationRangeMin,u.elevationRangeMax)}}}catch(c){s.e(c)}finally{s.f()}}return a(this._ground),a(this._im),"scene"===n&&a(this._scene),r}},{key:"getRootElevationBounds",value:function(){for(var e=new Eh.r,t=0,n=[this._im,this._ground,this._scene];t<n.length;t++){n[t].forEach((function(t){if(t.getRootElevationBounds){var n=t.getRootElevationBounds();null!=n&&e.expandElevationRangeValues(n.elevationRangeMin,n.elevationRangeMax)}}))}return e}},{key:"queryElevation",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n,i,a,o){var s,l,u,c,h=arguments;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=h.length>5&&void 0!==h[5]?h[5]:null,l=h.length>6&&void 0!==h[6]?h[6]:0,u=this._getElevationQuery(a),e.prev=3,e.next=6,u.queryElevation(t,n,s,l);case 6:return c=e.sent,e.abrupt("return","scene"===o?Ah(c,this._scene,t,n,i,a,o):c);case 10:return e.prev=10,e.t0=e.catch(3),e.abrupt("return",((0,S.r9)(e.t0),this.getElevation(t,n,i,a,o)));case 13:case"end":return e.stop()}}),e,this,[[3,10]])})));return function(t,n,i,r,a){return e.apply(this,arguments)}}()},{key:"register",value:function(e,t){var n=this;this.addHandles(t.on("elevation-change",(function(e){return n.emit("elevation-change",e)})),t),this._providersFromContext(e).push(t)}},{key:"unregister",value:function(e){this.removeHandles(e);for(var t=0,n=[this._im,this._ground,this._scene];t<n.length;t++){var i=n[t],r=i.indexOf(e);r>-1&&i.splice(r,1)}}},{key:"_providersFromContext",value:function(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}},{key:"_getElevationQuery",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.view.spatialReference,n=this._cachedQuery;if(null!=n&&(0,tt.fS)(t,n.spatialReference))return n;null===n||void 0===n||n.destroy({completeTasks:!0});var i=t.wkid,r=t.wkt,a=t.wkt2,o=t.latestWkid,s=new Rh.K(this.view.resourceController.scheduler,new ee.Z({wkid:i,wkt:r,wkt2:a,latestWkid:o}),(function(){var t;return null===(t=e.view.map)||void 0===t?void 0:t.ground}),{maximumAutoTileRequests:4});return this._cachedQuery=s,s}}]),n}($.Z.EventedMixin(Z.default));function Ah(e,t,n,r,a,o,s){var l,u=(0,i.Z)(t);try{for(u.s();!(l=u.n()).done;){var c=l.value.getElevation(n,r,a,o,s);null!=c&&(e=null!=e?Math.max(c,e):c)}}catch(h){u.e(h)}finally{u.f()}return e}(0,f._)([(0,E.Cb)({constructOnly:!0})],Oh.prototype,"view",void 0),(0,f._)([(0,E.Cb)()],Oh.prototype,"spatialReference",null),Oh=(0,f._)([(0,A.j)("esri.views.3d.support.CombinedElevationProvider")],Oh);var Dh=function(){function e(){(0,o.Z)(this,e)}return(0,s.Z)(e,null,[{key:"isValidProfile",value:function(t){return t in e.profiles}},{key:"getDefaultProfile",value:function(){return(0,w.Z)("esri-iPhone")?"low":"medium"}},{key:"apply",value:function(t,n){var i=e.profiles[t];n.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,n.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,n.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,n.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,n.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,n.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,n.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods,n.graphics3D.uncompressedTextureDownsamplingEnabled=i.graphics3D.uncompressedTextureDownsamplingEnabled;var r=n.sceneService.object,a=i.sceneService.object;r.lodFactor=a.lodFactor,n.sceneService.point.lodFactor=i.sceneService.point.lodFactor,n.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,n.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,n.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,n.tiledSurface.lodBias=i.tiledSurface.lodBias,n.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,n.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,n.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,n.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,n.heatmap.pixelRatio=i.heatmap.pixelRatio,n.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,n.fadeDuration=i.fadeDuration,n.antialiasingEnabled=i.antialiasingEnabled,n.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,n.highQualityTransparency=i.highQualityTransparency,n.highResolutionAtmosphere=i.highResolutionAtmosphere,n.reflections=i.reflections,n.ambientOcclusion=i.ambientOcclusion,n.memoryLimit=i.memoryLimit,n.additionalCacheMemory=i.additionalCacheMemory,n.frameRate=i.frameRate,n.maximumPixelRatio=i.maximumPixelRatio}}]),e}();Dh.test={reset:function(){for(var e=Hh(),t=0,n=Object.keys(e);t<n.length;t++){var i=n[t];Dh.profiles[i]=e[i]}}};var Zh=120,Ih=200,Lh=240,Nh=300,Uh=430;function Hh(){var e=!!(0,w.Z)("esri-mobile"),t=!!(0,w.Z)("ios"),n=(0,Fn.HA)(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:(0,Fn.HA)(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+Zh,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:e},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!(0,w.Z)("disable-feature:reduce-map-tile-levels")},fadeDuration:n,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:e?600+Ih:750+Lh,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!(0,w.Z)("disable-feature:reduce-map-tile-levels")},fadeDuration:n,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:e?900+Nh:1500+Uh,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}!function(e){e.profiles=Hh()}(Dh||(Dh={}));var Fh=Dh,Vh=n(77648),zh=n(51995),qh=new zh.Z([0,255,255]),Bh=.25,Gh=new zh.Z([0,0,0]),jh=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).color=qh.clone(),e.haloColor=null,e.haloOpacity=1,e.fillOpacity=Bh,e.shadowOpacity=.4,e.shadowColor=Gh.clone(),e.shadowDifference=.2,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)({type:zh.Z})],jh.prototype,"color",void 0),(0,f._)([(0,E.Cb)({type:zh.Z})],jh.prototype,"haloColor",void 0),(0,f._)([(0,E.Cb)()],jh.prototype,"haloOpacity",void 0),(0,f._)([(0,E.Cb)()],jh.prototype,"fillOpacity",void 0),(0,f._)([(0,E.Cb)()],jh.prototype,"shadowOpacity",void 0),(0,f._)([(0,E.Cb)({type:zh.Z})],jh.prototype,"shadowColor",void 0),(0,f._)([(0,E.Cb)()],jh.prototype,"shadowDifference",void 0);var Wh,Xh=jh=(0,f._)([(0,A.j)("esri.views.3d.support.HighlightOptions")],jh),Qh=n(67387),Yh=n(45362),Jh=n(81943),Kh=function(){function e(t,n){(0,o.Z)(this,e),this.spatialReference=n,this.unitInMeters=(0,Uo.c9)(this.spatialReference,(0,nt.Iu)(this.spatialReference).metersPerDegree);var i=t&&"portalItem"in t?t.portalItem:void 0;this._geometryServiceURLPromise=(0,Qh.getGeometryServiceURL)(i).catch((function(){throw new g.Z("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}return(0,s.Z)(e,[{key:"toGeographic",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n,i,a,o,s,l,u=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._geometryServiceURLPromise;case 2:return n=e.sent,a=!0,Array.isArray(t[0])&&"number"!=typeof t[0]?i=t:(i=[t],a=!1),o=i.map((function(e){return e instanceof No.Z?e:new No.Z(e,u.spatialReference)})),s=new Jh.Z({geometries:o,outSpatialReference:ee.Z.WGS84}),e.next=9,(0,Yh.i)(n,s);case 9:return l=e.sent.map((function(e){return"point"===e.type?[e.x,e.y]:void 0})).filter((function(e){return!!e})),e.abrupt("return",a?l:l[0]);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(Wh||(Wh={}));var $h=[Wh.ELEVATION,Wh.MAP],ed=n(74923);function td(e,t){return nd.apply(this,arguments)}function nd(){return nd=(0,a.Z)((0,r.Z)().mark((function e(t,n){var i,a,o,s,l,u,c,h,d,f,v,p,_,m,g,y,b,w,C,x,T,S,k;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,ed.ZV)(t,n);case 2:a=e.sent,o=a.results,s=a.ground,l=(!s.layer||!(0,X.nx)(s.layer.type))&&s.mapPoint,u=[],c=ad(t),h=l?id(t,c):rd,d=0,f=0,v=function(){var e=h.layerViews[f];l&&e&&"fetchPopupFeaturesAtLocation"in e&&u.push({mapPoint:s.mapPoint,layerView:e}),++f},p=null;case 12:if(!(d<o.length||f<h.layerViews.length)){e.next=33;break}if(!(y=o[d])||"graphic"===y.type){e.next=18;break}++d,e.next=31;break;case 18:if("scene"===(null===y||void 0===y||null===(_=y.layer)||void 0===_?void 0:_.type)&&(null===y||void 0===y||null===(m=y.layer)||void 0===m?void 0:m.parent)===(null===t||void 0===t||null===(g=t.map)||void 0===g?void 0:g.basemap)){e.next=30;break}if(!y){e.next=27;break}if(T=null===(b=y.layer)||void 0===b?void 0:b.uid,S=h.layerUids.has(T)&&y.distance===s.distance,k=c.get(null===(w=y.layer)||void 0===w?void 0:w.uid),null!==(C=p)&&void 0!==C||(p=y.mapPoint),!(f<h.layerViews.length&&(S||(null!==(x=y.distance)&&void 0!==x?x:0)>s.distance)&&h.layerViews[f]!==k)){e.next=24;break}return v(),e.abrupt("continue",31);case 24:u.push({graphic:y.graphic,layerView:k}),++d,e.next=28;break;case 27:v();case 28:e.next=31;break;case 30:++d;case 31:e.next=12;break;case 33:return e.abrupt("return",(null!==(i=p)&&void 0!==i||(p=s.mapPoint),{hits:u,location:p}));case 34:case"end":return e.stop()}}),e)}))),nd.apply(this,arguments)}function id(e,t){for(var n=new Set,r=[],a=e.basemapTerrain.numLayers(Wh.MAP)-1;a>=0;a--){var o=e.basemapTerrain.layerViewByIndex(a,Wh.MAP);n.add(o.layer.uid),r.push(o)}var s,l=e.basemapTerrain.overlayManager.renderer.layers,u=(0,i.Z)(l);try{for(u.s();!(s=u.n()).done;){var c=s.value.uid,h=t.get(c);h&&(n.add(c),r.push(h))}}catch(d){u.e(d)}finally{u.f()}return r.reverse(),{layerUids:n,layerViews:r}}var rd={layerUids:new Set,layerViews:[]};function ad(e){var t,n=new Map,r=(0,i.Z)(e.allLayerViews);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=a.layer.uid;n.set(o,a)}}catch(s){r.e(s)}finally{r.f()}return n}var od=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).minTotalNumberOfFeatures=2e3,e.maxTotalNumberOfFeatures=5e4,e.maxNumberOfDrawCalls=17e3,e.maxTotalNumberOfVertices=17e5,e.snapshotAvailable=!0,e.polygonLodFactor=1,e.polylineLodFactor=1,e.skipHighSymbolLods=!1,e.uncompressedTextureDownsamplingEnabled=!1,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)()],od.prototype,"minTotalNumberOfFeatures",void 0),(0,f._)([(0,E.Cb)()],od.prototype,"maxTotalNumberOfFeatures",void 0),(0,f._)([(0,E.Cb)()],od.prototype,"maxNumberOfDrawCalls",void 0),(0,f._)([(0,E.Cb)()],od.prototype,"maxTotalNumberOfVertices",void 0),(0,f._)([(0,E.Cb)()],od.prototype,"snapshotAvailable",void 0),(0,f._)([(0,E.Cb)()],od.prototype,"polygonLodFactor",void 0),(0,f._)([(0,E.Cb)()],od.prototype,"polylineLodFactor",void 0),(0,f._)([(0,E.Cb)()],od.prototype,"skipHighSymbolLods",void 0),(0,f._)([(0,E.Cb)()],od.prototype,"uncompressedTextureDownsamplingEnabled",void 0),od=(0,f._)([(0,A.j)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],od);var sd=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).lodFactor=1,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)()],sd.prototype,"lodFactor",void 0),sd=(0,f._)([(0,A.j)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],sd);var ld=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).object=new sd,e.point=new sd,e.integratedMesh=new sd,e.pointCloud=new sd,e.uncompressedTextureDownsamplingEnabled=!1,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)({type:sd})],ld.prototype,"object",void 0),(0,f._)([(0,E.Cb)({type:sd})],ld.prototype,"point",void 0),(0,f._)([(0,E.Cb)({type:sd})],ld.prototype,"integratedMesh",void 0),(0,f._)([(0,E.Cb)({type:sd})],ld.prototype,"pointCloud",void 0),(0,f._)([(0,E.Cb)()],ld.prototype,"uncompressedTextureDownsamplingEnabled",void 0),ld=(0,f._)([(0,A.j)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],ld);var ud=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).lodBias=0,e.angledSplitBias=1,e.vtlContentZoom=1,e.elevationLevelDelta=3,e.reduceTileLevelDifferences=!0,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)()],ud.prototype,"lodBias",void 0),(0,f._)([(0,E.Cb)()],ud.prototype,"angledSplitBias",void 0),(0,f._)([(0,E.Cb)()],ud.prototype,"vtlContentZoom",void 0),(0,f._)([(0,E.Cb)()],ud.prototype,"elevationLevelDelta",void 0),(0,f._)([(0,E.Cb)()],ud.prototype,"reduceTileLevelDifferences",void 0),ud=(0,f._)([(0,A.j)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],ud);var cd=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).pixelRatio=1,e.maxTotalNumberOfFeatures=5e4,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)()],cd.prototype,"pixelRatio",void 0),(0,f._)([(0,E.Cb)()],cd.prototype,"maxTotalNumberOfFeatures",void 0),cd=(0,f._)([(0,A.j)("esri.views.3d.support.QualitySettings.HeatmapSettings")],cd);var hd=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).graphics3D=new od,e.sceneService=new ld,e.tiledSurface=new ud,e.heatmap=new cd,e.fadeDuration=(0,Fn.HA)(400),e.antialiasingEnabled=!0,e.physicallyBasedRenderingEnabled=!1,e.highQualityTransparency=!0,e.highResolutionAtmosphere=!1,e.reflections=!1,e.ambientOcclusion=!1,e.memoryLimit=750,e.additionalCacheMemory=0,e.frameRate=void 0,e.maximumPixelRatio=1/0,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)({type:od})],hd.prototype,"graphics3D",void 0),(0,f._)([(0,E.Cb)({type:ld})],hd.prototype,"sceneService",void 0),(0,f._)([(0,E.Cb)({type:ud})],hd.prototype,"tiledSurface",void 0),(0,f._)([(0,E.Cb)({type:cd})],hd.prototype,"heatmap",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"fadeDuration",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"antialiasingEnabled",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"physicallyBasedRenderingEnabled",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"highQualityTransparency",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"highResolutionAtmosphere",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"reflections",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"ambientOcclusion",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"memoryLimit",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"additionalCacheMemory",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"frameRate",void 0),(0,f._)([(0,E.Cb)()],hd.prototype,"maximumPixelRatio",void 0);var dd=hd=(0,f._)([(0,A.j)("esri.views.3d.support.QualitySettings")],hd),fd=n(91643),vd=n(76432),pd=n(45888),_d=n(31195),md=n(76200),gd=n(63780),yd=(0,s.Z)((function e(t){(0,o.Z)(this,e),this.client=t,this._cancelled=!1,this.size=0,this.duration=0})),bd=(0,s.Z)((function e(t){(0,o.Z)(this,e),this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new wd})),wd=(0,s.Z)((function e(){(0,o.Z)(this,e),this.requests=0,this.size=0,this.duration=0,this.speed=0})),Cd=function(){function e(t,n,i,r){(0,o.Z)(this,e),this._workerFunc=t,this._callbackFunc=n,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map((function(e){return new bd(e)}))}return(0,s.Z)(e,[{key:"destroy",value:function(){this._clients.length=0}},{key:"hasQuota",value:function(e){var t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}},{key:"push",value:function(e){var t=this,n=this._clients[e.client];n&&(this._totalNumWorkers<this._maxTotalNumWorkers?(n.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(function(e,n){return t._taskCallback(e,n)}))):n.tasks.push(e))}},{key:"cancel",value:function(e){this._taskFinished(e),e._cancelled=!0}},{key:"_taskFinished",value:function(e){var t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,(0,En.hu)(t.numWorkers>=0)),this._next()}},{key:"_next",value:function(){var e,t=(0,i.Z)(this._clients);try{for(t.s();!(e=t.n()).done;){var n=e.value;if(n&&n.numWorkers<n.typeWorkerQuota&&this._processQueue(n))return}}catch(s){t.e(s)}finally{t.f()}var r,a=(0,i.Z)(this._clients);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o&&this._processQueue(o))return}}catch(s){a.e(s)}finally{a.f()}}},{key:"_processQueue",value:function(e){for(var t=this;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(function(e,n){return t._taskCallback(e,n)})))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}},{key:"_taskCallback",value:function(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}},{key:"getStatsForType",value:function(e){var t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}},{key:"test",get:function(){}}]),e}(),xd=(0,s.Z)((function e(t,n){(0,o.Z)(this,e),this.element=t,this.type="image+type",this.isOpaque="image/jpeg"===n})),Td=n(55468),Sd=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._tasks=new Map,e._onLoadQueue=new Array,e._doneQueue=new Array,e.updating=!1,e}return(0,s.Z)(n,[{key:"setup",value:function(e,t,n){var i=this;this._loadQueue=new Cd((function(e,t){return i._startLoading(e,t)}),(function(e,t){return i._doneLoadingCB(e,t)}),e,t),n&&(this._frameTask=n.registerTask($t.T8.STREAM_DATA_LOADER,this))}},{key:"destroy",value:function(){this._frameTask=(0,x.hw)(this._frameTask),this._tasks.forEach((function(e){return(0,x.IM)(e.abortController)})),this._loadQueue=(0,x.SC)(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}},{key:"hasDownloadSlots",value:function(e){return this._loadQueue.hasQuota(e)}},{key:"request",value:function(e,t,n){var i=this,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=(0,S.hh)();a.__signal=null!=r?r.signal:null;var o=this._createOrUpdateTask(e,t,n,r,a);return(0,S.fu)(r,(function(){return i._cancelRequest(o,a)})),a.promise}},{key:"_createTask",value:function(e,t,n,i,r,a){var o=new Pd(e,t,n,i,r);return this._updateTask(o,a),this._tasks.set(r,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}},{key:"_cancelRequest",value:function(e,t){var n;(0,gd.e$)(e.resolvers,t),t.reject((0,S.zE)()),0===e.resolvers.length&&(e.status===Md.DOWNLOADING&&(e.status=Md.CANCELLED,this._loadQueue.cancel(e),null!==(n=e.abortController)&&void 0!==n&&n.abort(),e.request=null,e.abortController=null),e.status=Md.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}},{key:"_updateTask",value:function(e,t){e.resolvers.push(t)}},{key:"_createOrUpdateTask",value:function(e,t,n,i,r){var a=function(e,t,n){return"".concat(e,":").concat(t,":").concat(n)}((null===i||void 0===i?void 0:i.uid)||e,t,n),o=this._tasks.get(a);return o?(this._updateTask(o,r),o):this._createTask(e,i,t,n,a,r)}},{key:"_doneLoadingCB",value:function(e,t){this._loadQueue&&((0,En.hu)(e.status===Md.DOWNLOADING),e.status=Md.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}},{key:"running",get:function(){return this._doneQueue.length>0||this._onLoadQueue.length>0}},{key:"runTask",value:function(e){for(;!e.done&&this._onLoadQueue.length>0;){var t=this._onLoadQueue.shift();(0,S.k_)(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){var n=this._doneQueue.shift();n.task.status!==Md.DOWNLOADED&&(n.err=n.err||(0,S.zE)()),this._doneLoading(n.task,n.err),e.madeProgress()}}},{key:"_doneLoading",value:function(e,t){if(t&&!(0,S.D_)(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);var n,r=(0,Td.Cm)(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length,a=(0,i.Z)(e.resolvers);try{for(a.s();!(n=a.n()).done;){var o=n.value;if(t)(0,S.D_)(t)?o.reject(t):o.reject(new g.Z("stream-data-loader:request-error","Failed to request resource at '".concat(e.url,"'. ").concat(t),{url:e.url,error:t}));else{var s=--r>0?(0,Ve.d9)(e.result):e.result;o.resolve(s)}}}catch(l){a.e(l)}finally{a.f()}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}},{key:"_startLoading",value:function(e,t){var n,i,r=this;if(e.status===Md.CANCELLED)return!1;switch(e.startTime=performance.now(),e.status=Md.DOWNLOADING,e.docType){case"binary":i="array-buffer",n=0;break;case"image":i="image";break;case"image+type":i="array-buffer";break;default:i="json"}e.abortController=new AbortController;var a=e.abortController.signal;e.request=(0,md.Z)(e.url,(0,He.Z)((0,He.Z)({},e.options),{},{responseType:i,timeout:n,signal:a}));var o=function(n){e.duration=performance.now()-e.startTime,e.size=n instanceof ArrayBuffer?n.byteLength:e.size||0,e.result=n,r._frameTask?r._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},s=function(n){e.status===Md.DOWNLOADING&&t(e,n)};return"image+type"!==e.docType?(e.request.then((function(e){return o(e.data)}),s),!0):(e.request.then((function(t){var r=t.data,l=function(e){if(e.byteLength<2)return"unknown";var t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(r);if(i="image",e.size=r.byteLength,"unknown"===l)return e.request=(0,md.Z)(e.url,{responseType:i,timeout:n,signal:a}),void e.request.then((function(e){return o(e.data)}),s);var u=new Blob([r],{type:l}),c=window.URL.createObjectURL(u);e.request=(0,md.Z)(c,{responseType:i,timeout:n,signal:a}),e.request.then((function(e){return o(new xd(e.data,l))}),s).finally((function(){return window.URL.revokeObjectURL(c)}))}),s),!0)}},{key:"test",get:function(){}}]),n}(Z.default);(0,f._)([(0,E.Cb)({readOnly:!0})],Sd.prototype,"updating",void 0),Sd=(0,f._)([(0,A.j)("esri.views.3d.support.StreamDataLoader")],Sd);var kd=0;var Md,Pd=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a,s){var l;return(0,o.Z)(this,n),(l=t.call(this,a)).url=e,l.options=i,l.docType=r,l.key=s,l.result=null,l.status=Md.QUEUED,l.request=null,l.abortController=null,l.resolvers=new Array,l.startTime=0,l.numRetries=kd,l}return(0,s.Z)(n)}(yd);!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(Md||(Md={}));var Rd=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).updating=!1,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)({readOnly:!0})],Rd.prototype,"updating",void 0);var Ed=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._immediateTask=$t.sq,e._normalTask=$t.sq,e._updatingObjects=(0,vd.t)([]),e._frameTask=null,e}return(0,s.Z)(n,[{key:"immediate",get:function(){return this._immediateTask}},{key:"normal",get:function(){return this._normalTask}},{key:"initialize",value:function(){var e=this;this._scheduler=(0,$t.z4)(),this._memoryController=(0,_d.c)(this.view),this._streamDataLoader=new Sd,this._streamDataLoader.setup(pd.NT,pd.Ty,this._scheduler),this.addHandles([(0,k.watch)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.mode}),(function(t){null!=t&&(e._scheduler.state=t)}),k.sync),(0,k.watch)((function(){return e.view.stationary}),(function(){return e._stationaryChangedHandler()}))]),this._frameTask=(0,M.A)({update:function(t){return e._frame(t)}}),this._immediateTask=this._scheduler.registerTask($t.T8.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask($t.T8.RESOURCE_CONTROLLER)}},{key:"destroy",value:function(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=(0,x.hw)(this._frameTask),this._streamDataLoader=(0,x.SC)(this._streamDataLoader),this._memoryController=(0,x.SC)(this._memoryController),this._scheduler=(0,x.SC)(this._scheduler),this.view=null}},{key:"updating",get:function(){var e,t,n,i;return!!(null!==(e=this._memoryController)&&void 0!==e&&e.updating||null!==(t=this._streamDataLoader)&&void 0!==t&&t.updating||null!==(n=this._immediateTask)&&void 0!==n&&n.updating)||(null===(i=this._updatingObjects)||void 0===i?void 0:i.value.some((function(e){return e.updating})))}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"createStreamDataRequester",value:function(e){var t=this._streamDataLoader;return{request:function(n,i,r){return t.request(n,i,e,r)},get busy(){return!t.hasDownloadSlots(e)}}}},{key:"addUpdatingObject",value:function(e){var t=this._updatingObjects;return t.value=[].concat((0,Ru.Z)(t.value),[e]),(0,b.kB)((function(){t.value=t.value.filter((function(t){return t!==e}))}))}},{key:"_frame",value:function(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,Fn.D9)(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.updateBudget(e)&&this._scheduler.frame())}},{key:"_stationaryChangedHandler",value:function(){this.memoryController.resetStableQuality()}},{key:"test",get:function(){}}]),n}(Rd=(0,f._)([(0,A.j)("esri.views.3d.support.ResourceController.ResourceControllerMain")],Rd));(0,f._)([(0,E.Cb)()],Ed.prototype,"view",void 0),(0,f._)([(0,E.Cb)()],Ed.prototype,"_scheduler",void 0),(0,f._)([(0,E.Cb)()],Ed.prototype,"_memoryController",void 0),(0,f._)([(0,E.Cb)()],Ed.prototype,"_streamDataLoader",void 0),(0,f._)([(0,E.Cb)()],Ed.prototype,"_immediateTask",void 0),(0,f._)([(0,E.Cb)()],Ed.prototype,"_normalTask",void 0),(0,f._)([(0,E.Cb)()],Ed.prototype,"_updatingObjects",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Ed.prototype,"updating",null),Ed=(0,f._)([(0,A.j)("esri.views.3d.support.ResourceController")],Ed);var Od=n(70116),Ad=n(20488),Dd=(0,s.Z)((function e(t){(0,o.Z)(this,e),this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer;var n=t.performanceInfo;this.memory=n.usedMemory,this.displayedNumberOfFeatures=n.displayedFeatures,this.maximumNumberOfFeatures=n.maximumFeatures,this.totalNumberOfFeatures=n.totalFeatures})),Zd=(0,s.Z)((function e(t){var n,i,r,a,s,l,u,c=this;if((0,o.Z)(this,e),this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,null!=t.resourceController){var h,d=t.resourceController.memoryController;this.totalMemory=(null!==(h=d.maxMemory)&&void 0!==h?h:0)*Od.Y.MEGABYTES,this.usedMemory=Math.round(d.usedMemory*this.totalMemory),this.quality=t.quality,this.load=t.resourceController.scheduler.load,this.cachedMemory=d.usedCacheMemory}this.terrainMemory=null!==(n=null===(i=t.basemapTerrain)||void 0===i?void 0:i.usedMemory)&&void 0!==n?n:0,this.edgesMemory=null!==(r=null===(a=t._stage)||void 0===a?void 0:a.renderer.usedMemory.edges)&&void 0!==r?r:0,this.fboMemory=null!==(s=null===(l=t._stage)||void 0===l?void 0:l.renderer.usedMemory.fbos)&&void 0!==s?s:0,null!==(u=t.allLayerViews)&&void 0!==u&&u.items.forEach((function(e){(0,Ad.l)(e)&&c.layerPerformanceInfos.push(new Dd(e))})),this.layerPerformanceInfos.sort((function(e,t){return t.memory-e.memory}))})),Id=n(27053),Ld=n(57516),Nd=n(13041),Ud=function(){function e(t){(0,o.Z)(this,e),this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=t("gltf-resources",(function(){})),this._wosrMemCache=t("wosr-resources",(function(){}))}return(0,s.Z)(e,[{key:"destroy",value:function(){this._gltfLoading.forEach((function(e){return e.abortController.abort()})),this._wosrLoading.forEach((function(e){return e.abortController.abort()})),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}},{key:"loadGLTF",value:function(e,t,n){var i=n?"gltfPBR:".concat(e):"gltf:".concat(e),r=this._gltfMemCache.get(i);return null!=r?Promise.resolve(r):Hd(this._gltfLoading,this._gltfMemCache,i,(function(t){return(0,Ld.Q)(new Id.C(t.streamDataRequester),e,t,n)}),t)}},{key:"loadWOSR",value:function(e,t){var n="wosr:".concat(e,":").concat(t.disableTextures),i=this._wosrMemCache.get(n);return null!=i?Promise.resolve(i):Hd(this._wosrLoading,this._wosrMemCache,n,(function(t){return(0,Nd.zD)(e,t)}),t)}}]),e}();function Hd(e,t,n,i,r){return Fd.apply(this,arguments)}function Fd(){return Fd=(0,a.Z)((0,r.Z)().mark((function e(t,n,i,a,o){var s,l,u,c;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,S.k_)(o),s=(0,S.fu)(o,(function(){return Vd(t,i)})),(l=t.get(i))?l.refCount++:(u=new AbortController,l={refCount:1,abortController:u,promise:a((0,He.Z)((0,He.Z)({},o),{},{signal:u.signal}))},t.set(i,l)),e.prev=4,e.next=7,l.promise;case 7:return c=e.sent,e.abrupt("return",(n.put(i,c,c.size),t.delete(i),(0,S.k_)(o),c));case 9:return e.prev=9,(0,x.hw)(s),e.finish(9);case 12:case"end":return e.stop()}}),e,null,[[4,,9,12]])}))),Fd.apply(this,arguments)}function Vd(e,t){var n=e.get(t);null!=n&&--n.refCount>0||(e.delete(t),null!=n&&n.abortController.abort())}var zd=n(35995),qd=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i){var r,a;return(0,o.Z)(this,n),(a=t.call(this,{}))._stage=e,a._textureRequests=new Map,a._frameTask=null!==(r=null===i||void 0===i?void 0:i.registerTask($t.T8.TEXTURE_UNLOAD))&&void 0!==r?r:$t.sq,a}return(0,s.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"destroy",value:function(){var e,t,i,r=this;(0,u.Z)((0,c.Z)(n.prototype),"destroy",this).call(this),null!==(e=this._frameTask)&&void 0!==e&&e.remove(),null!==(t=this._textureRequests)&&void 0!==t&&t.forEach((function(e){return r._releaseTextureRequest(e)})),null===(i=this._textureRequests)||void 0===i||i.clear()}},{key:"updating",get:function(){return this._frameTask.updating}},{key:"fromData",value:function(e,t){var n=this,i=this.makeUid(e),r=this._textureRequests.get(i);if(!r){var a=new Gd;a.texture=t(),this._stage&&(a.texture.load(this._stage.renderView.renderingContext),this._stage.add(a.texture)),this._textureRequests.set(i,a),r=a}return r.referenceCount++,new Bd(i,r.texture,(function(){return n._release(i)}))}},{key:"_release",value:function(e){var t=this,n=this._textureRequests.get(e);n?(n.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),n.referenceCount--,n.referenceCount<1&&this._frameTask.schedule((function(){return t._releaseNow(e)}))):console.warn("TextureCollection: texture doesn't exist: '".concat(e,"'"))}},{key:"test",get:function(){}},{key:"_releaseNow",value:function(e){var t;if(this._textureRequests){var n=this._textureRequests.get(e);!n||n.referenceCount>0||(null!==(t=n.texture)&&void 0!==t&&t.unload(),this._releaseTextureRequest(n),this._textureRequests.delete(e))}}},{key:"_releaseTextureRequest",value:function(e){var t;e.texture?null===(t=this._stage)||void 0===t||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}},{key:"makeUid",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!=t?"".concat(e,".").concat(t,"px"):e}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],qd.prototype,"_frameTask",void 0),(0,f._)([(0,E.Cb)()],qd.prototype,"updating",null),qd=(0,f._)([(0,A.j)("esri.views.3d.support.TextureCollection")],qd);var Bd=(0,s.Z)((function e(t,n,i){(0,o.Z)(this,e),this.uid=t,this.texture=n,this.release=i})),Gd=(0,s.Z)((function e(){(0,o.Z)(this,e),this.referenceCount=0})),jd=n(1487),Wd=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,i,r))._streamDataRequester=e,a}return(0,s.Z)(n,[{key:"fromUrl",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n,i){var o,s,l,u,c,h,d=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,S.k_)(i),o=null===i||void 0===i?void 0:i.signal,s=this.makeUid(t,n),(l=this._textureRequests.get(s))||(u=new AbortController,c=this._streamDataRequester.request(t,"image",{uid:s,signal:u.signal}),(l=new Gd).abortController=u,h=l,this._textureRequests.set(s,l),l.textureAsync=c.then(function(){var e=(0,a.Z)((0,r.Z)().mark((function e(i){var a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=d._createTexture(t,i,n),h.texture=a,h.abortController=null,e.next=5,a.load(d._stage.renderView.renderingContext);case 5:return d._stage.add(a),e.abrupt("return",new Bd(s,a,(function(){return d._release(s)})));case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),(function(e){throw h.abortController=null,e}))),l.referenceCount++,e.prev=5,e.next=8,(0,S.Hl)(l.textureAsync,o);case 8:return e.abrupt("return",e.sent);case 11:throw e.prev=11,e.t0=e.catch(5),this._release(s),e.t0;case 14:case"end":return e.stop()}}),e,this,[[5,11]])})));return function(t,n,i){return e.apply(this,arguments)}}()},{key:"_createTexture",value:function(e,t,n){var i={width:t.width,height:t.height,wrap:{s:_t.e8.CLAMP_TO_EDGE,t:_t.e8.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if((0,zd.zd)(e)){var r;if(n||0===t.width&&0===t.height){var a=t.width?t.height/t.width:1;n=n||64,a>1?(t.width=Math.round(n/a),t.height=n):(t.width=n,t.height=Math.round(n*a))}(null===(r=this._stage.renderView)||void 0===r?void 0:r.renderingContext.driverTest.svgPremultipliesAlpha.result)&&(i.preMultiplyAlpha=!1)}return new jd.x(t,i)}}]),n}(qd),Xd=function(){function e(t){(0,o.Z)(this,e),this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=t.viewState,this._view=t.view,this._pointsOfInterest=t.pointsOfInterest,this.streamDataRequester=t.resourceController.createStreamDataRequester(pd.Bh.SYMBOLOGY),this.objectResourceCache=new Ud((function(e,n){return t.resourceController.memoryController.newCache(e,n)})),this.textures=new Wd(this.streamDataRequester,t.view._stage,t.resourceController.scheduler);var n=(0,nt.Iu)(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,$l.Gw)(t.viewingMode,n),this.screenSizePerspectiveSettingsLabels=(0,$l.n9)(t.viewingMode,n)}return(0,s.Z)(e,[{key:"destroy",value:function(){this.textures.destroy(),this.streamDataRequester=null}},{key:"addGraphicsOwner",value:function(e){var t=this;if(!e)return(0,b.kB)();this._graphicsOwners.push(e);var n=(0,k.watch)((function(){var t;return null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled}),(function(){return t._updateScreenSizePerspectiveEnabled()}));return this._updateScreenSizePerspectiveEnabled(),(0,b.kB)((function(){n.remove(),(0,gd.e$)(t._graphicsOwners,e),t._updateScreenSizePerspectiveEnabled()}))}},{key:"_updateScreenSizePerspectiveEnabled",value:function(){var e=this,t=this._graphicsOwners.some((function(e){var t;return!0===(null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled)}));if(t&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new rt.Z;var n=function(){return e._updateScreenSizePerspectiveSettings()};this._screenSizePerspectiveHandles.add([(0,k.watch)((function(){return e._pointsOfInterest.centerOnSurfaceInfrequent.distance}),n,k.sync),this._viewState.events.on("camera-projection-changed",n)]),this._updateScreenSizePerspectiveSettings()}else t||(this._screenSizePerspectiveHandles=(0,x.SC)(this._screenSizePerspectiveHandles))}},{key:"_updateScreenSizePerspectiveSettings",value:function(){var e=this._pointsOfInterest;Qd.distance=e.centerOnSurfaceInfrequent.distance,Qd.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(Qd),this.screenSizePerspectiveSettingsLabels.update(Qd),this._view._stage.renderView.requestRender()}},{key:"test",get:function(){}}]),e}(),Qd={distance:0,fovY:0},Yd=n(52639),Jd=(n(51508),n(62554)),Kd=n(36365),$d=n(87037),ef=function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";(0,o.Z)(this,e),this.graphics=t,this._symbol=new Jd.Z({symbolLayers:new _.Z([new Kd.Z({material:{color:n},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new $d.Z({text:i,halo:{color:"white",size:1/.75},material:{color:n},size:12})])})}return(0,s.Z)(e,[{key:"show",value:function(e,t){if(null!=t){this.hide();var n=new No.Z({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new Yd.Z({geometry:n,symbol:this._symbol}),this.graphics.add(this._graphic)}}},{key:"hide",value:function(){null!=this._graphic&&(this.graphics.remove(this._graphic),this._graphic=null)}}]),e}(),tf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){return(0,o.Z)(this,n),t.call(this,e)}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],tf.prototype,"renderCoordsHelper",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],tf.prototype,"surface",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],tf.prototype,"state",void 0),tf=(0,f._)([(0,A.j)("esri.views.3d.support.pointsOfInterest.PointOfInterest")],tf);var nf=Array,rf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._dirty=!1,i._propertiesPool=new ts.L({location:No.Z,renderLocation:nf},(0,l.Z)(i)),i._estimatedSurfaceAltitude=0,i._pendingElevationQueryController=null,i.renderLocation=(0,U.Ue)(),i._tmpPoint=new No.Z,i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){var t=function(){return e._setDirty()};this.addHandles((0,k.on)((function(){var t,n;return null===(t=e.map)||void 0===t||null===(n=t.ground)||void 0===n?void 0:n.layers}),"change",t,{onListenerAdd:t,onListenerRemove:t}))}this._updateRenderLocation()}},{key:"destroy",value:function(){this._cancelPendingRequest(),this._propertiesPool=(0,x.SC)(this._propertiesPool)}},{key:"_camera",get:function(){return this.state.contentCamera}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}},{key:"scale",get:function(){var e=this._camera,t=(0,et.p)(e.eye,this.renderLocation),n={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return(0,K.Xt)(n,t,0)}},{key:"updating",get:function(){return this._dirty||null!=this._pendingElevationQueryController}},{key:"updateRenderLocation",value:function(){this._setDirty(),this._updateRenderLocation()}},{key:"_setDirty",value:function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}},{key:"_cancelPendingRequest",value:function(){var e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}},{key:"running",get:function(){return!this._pendingElevationQueryController&&this._dirty}},{key:"runTask",value:function(){var e,t,n=this;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),null===(e=this.map)||void 0===e||!e.ground)return this._updateSurfaceAltitude(0),en.J;var i=this.state.spatialReference;this._tmpPoint.spatialReference=i,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);var r=(null!==(t=this._tmpPoint.z)&&void 0!==t?t:0)>of&&this.renderCoordsHelper.viewingMode===he.JY.Global&&(i.isWGS84||i.isWebMercator),a=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:a.signal,cache:this.cache,minDemResolution:r?sf:0}).then((function(e){var t;return n._updateSurfaceAltitude(null!==(t=e.geometry.z)&&void 0!==t?t:0)})).catch((function(e){(0,S.D_)(e)||n._updateSurfaceAltitude(0)})).catch((function(){})).then((function(){n._pendingElevationQueryController===a&&(n._pendingElevationQueryController=null,n.notifyChange("updating")),a=null})),this._pendingElevationQueryController=a,en.J}},{key:"_updateSurfaceAltitude",value:function(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}},{key:"_updateRenderLocation",value:function(){this.renderCoordsHelper.setAltitude(af,this._estimatedSurfaceAltitude,this._camera.eye),(0,et.e)(this._get("renderLocation"),af)||(this._set("renderLocation",(0,et.c)(this._propertiesPool.get("renderLocation"),af)),this.notifyChange("renderLocation"))}}]),n}(tf);(0,f._)([(0,E.Cb)({constructOnly:!0})],rf.prototype,"scheduler",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],rf.prototype,"cache",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],rf.prototype,"task",void 0),(0,f._)([(0,E.Cb)()],rf.prototype,"location",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],rf.prototype,"map",void 0),(0,f._)([(0,E.Cb)()],rf.prototype,"renderLocation",void 0),(0,f._)([(0,E.Cb)()],rf.prototype,"scale",null),(0,f._)([(0,E.Cb)()],rf.prototype,"updating",null),rf=(0,f._)([(0,A.j)("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],rf);var af=(0,U.Ue)(),of=1e5,sf=1e6,lf=Array,uf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._propertiesPool=new ts.L({location:No.Z,renderLocation:lf},(0,l.Z)(i)),i._currentSurfaceAltitude=0,i._latestSurfaceAltitude=0,i.distance=0,i.renderLocation=(0,U.Ue)(),i.updating=!1,i}return(0,s.Z)(n,[{key:"initialize",value:function(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}},{key:"destroy",value:function(){this._frameWorker=(0,x.hw)(this._frameWorker),this._propertiesPool=(0,x.SC)(this._propertiesPool)}},{key:"_camera",get:function(){return this.state.contentCamera}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}},{key:"updateRenderLocation",value:function(){this.updating=!0,this._updateRenderLocation()}},{key:"estimatedSurfaceAltitude",get:function(){return this._latestSurfaceAltitude}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,en.J}},{key:"_updateRenderLocation",value:function(){var e=hf,t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e),n=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&n&&((t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e))&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));var i=df;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,i)&&((0,et.c)(e,i),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=(0,et.p)(this._camera.eye,e):((0,et.j)(e,this._camera.viewForward,this._get("distance")),(0,et.g)(e,e,this._camera.eye)),(0,et.e)(this._get("renderLocation"),e)||this._set("renderLocation",(0,et.c)(this._propertiesPool.get("renderLocation"),e))}},{key:"_calculateSurfaceIntersection",value:function(e,t){var n=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(n.ray,e,t))return!1;if(this.state.isGlobal){var i=(0,nt.Iu)(this.renderCoordsHelper.spatialReference).radius,r=i+e,a=(0,et.q)(n.eye),o=a<r*r,s=(0,et.p)(n.eye,t);if(o&&s>i/4){var l=r-Math.sqrt(a);return(0,et.j)(t,n.viewForward,l),(0,et.g)(t,t,n.eye),!0}}else{var u,c,h=null!==(u=this.surface)&&void 0!==u&&u.ready?this.surface.extent:null;null!=h&&(0,z.d)(h,null===(c=this.surface)||void 0===c?void 0:c.spatialReference,ff,this.renderCoordsHelper.spatialReference)&&(t[0]=(0,Se.uZ)(t[0],ff[0],ff[2]),t[1]=(0,Se.uZ)(t[1],ff[1],ff[3]))}return!0}},{key:"_latestSurfaceAltitudeChangesDistanceSignificantly",value:function(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(Vl.h.TESTS_DISABLE_OPTIMIZATIONS)return!0;var n=this._camera.eye,i=(0,et.p)(n,e),r=(0,et.p)(n,t);if(Math.abs(r-i)/i>cf)return!0}return!1}}]),n}(tf);(0,f._)([(0,E.Cb)({constructOnly:!0})],uf.prototype,"scheduler",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],uf.prototype,"task",void 0),(0,f._)([(0,E.Cb)()],uf.prototype,"distance",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],uf.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],uf.prototype,"location",null),(0,f._)([(0,E.Cb)({readOnly:!0})],uf.prototype,"renderLocation",void 0),(0,f._)([(0,E.Cb)()],uf.prototype,"updating",void 0),uf=(0,f._)([(0,A.j)("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],uf);var cf=.05,hf=(0,U.Ue)(),df=(0,U.Ue)(),ff=(0,B.Ue)(),vf=function(){function e(t){var n=this;(0,o.Z)(this,e),this._handles=new rt.Z,this.events=new $.Z,this._contentLayerViews=t.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",(function(e){return n._layerViewsChanged(e)}))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}return(0,s.Z)(e,[{key:"destroy",value:function(){this._handles=(0,x.SC)(this._handles),this._contentLayerViews.destroy()}},{key:"_layerViewsChanged",value:function(e){var t=this;e.added.forEach((function(e){"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&t._handles.add(e.on("visible-geometry-changed",(function(){return t._contentChanged()})),e.uid)})),e.removed.forEach((function(e){return t._handles.remove(e.uid)}))}},{key:"_contentChanged",value:function(){this.events.emit("request-update",pf)}}]),e}(),pf={},_f=Array,mf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._propertiesPool=new ts.L({location:No.Z,renderLocation:_f},(0,l.Z)(i)),i._dirty=!0,i.renderLocation=i._propertiesPool.get("renderLocation"),i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([(0,k.watch)((function(){return e.centerOnSurface.renderLocation}),(function(){return e.updateRenderLocation()})),(0,k.watch)((function(){return e.state.contentCamera}),(function(){return e.updateRenderLocation()}))]),this.scheduler&&this.addHandles(this.scheduler.registerTask($t.T8.POINT_OF_INTEREST_FREQUENT,this))}},{key:"destroy",value:function(){this._propertiesPool=(0,x.SC)(this._propertiesPool)}},{key:"updating",get:function(){return this._dirty||this.centerOnSurface.updating}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}},{key:"worldUnitsPerContentPixel",get:function(){var e=this.state,t=e.camera,n=e.contentPixelRatio;return t.computeRenderPixelSizeAt(this.renderLocation)*(t.pixelRatio/n)}},{key:"running",get:function(){return this._dirty}},{key:"runTask",value:function(){var e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,n=this.renderCoordsHelper,i=this.state.contentCamera;this._dirty=!1,n.worldUpAtPosition(t,gf);var r=Math.max(0,(Math.acos((0,et.m)(gf,i.viewForward))-.5*Math.PI)*(i.aboveGround?1:-1));if(Number.isNaN(r)){if(!e||!(0,et.G)(e,t)){var a=this._propertiesPool.get("renderLocation");(0,et.c)(a,t),this._set("renderLocation",a)}return en.J}var o=1-(0,Se.uZ)(r/(.5*Math.PI),0,1),s=o*o*o;this._calculateScreenHorizontalEdgeOnSurface(bf);var l=this._propertiesPool.get("renderLocation");return(0,et.o)(l,t,bf,s),e&&(0,et.G)(e,l)||this._set("renderLocation",l),en.J}},{key:"_calculateScreenHorizontalEdgeOnSurface",value:function(e){var t=this.state.contentCamera,n=t.getRenderCenter((0,P.J$)());if(n[1]=t.aboveGround?t.padding[ns.Np.BOTTOM]:t.fullHeight-t.padding[ns.Np.TOP],this.estimateSurfaceIntersectionAtRenderPoint(n,e))return e;var i=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(n,yf)){(0,et.f)(yf,yf,t.eye);var r=(0,et.n)(yf,yf);if(this.renderCoordsHelper.intersectInfiniteManifold((0,Di.re)(t.eye,r),i,e))return e}return this.renderCoordsHelper.setAltitude(e,i,t.eye)}},{key:"updateRenderLocation",value:function(){this._dirty=!0}}]),n}(tf);(0,f._)([(0,E.Cb)()],mf.prototype,"_dirty",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],mf.prototype,"scheduler",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],mf.prototype,"centerOnSurface",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],mf.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,f._)([(0,E.Cb)()],mf.prototype,"updating",null),(0,f._)([(0,E.Cb)()],mf.prototype,"location",null),(0,f._)([(0,E.Cb)()],mf.prototype,"renderLocation",void 0),(0,f._)([(0,E.Cb)()],mf.prototype,"worldUnitsPerContentPixel",null),mf=(0,f._)([(0,A.j)("esri.views.3d.support.pointsOfInterest.Focus")],mf);var gf=(0,U.Ue)(),yf=(0,U.Ue)(),bf=(0,U.Ue)(),wf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).location=null,i._updateController=null,i}return(0,s.Z)(n,[{key:"surface",get:function(){var e;return null===(e=this.view.map)||void 0===e?void 0:e.ground}},{key:"surfaceView",get:function(){return this.view.basemapTerrain}},{key:"renderLocation",get:function(){if(!this.location)return null;var e=(0,U.Ue)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}},{key:"initialize",value:function(){var e=this;this.view.state.isLocal&&(this.addHandles([(0,k.watch)((function(){var t,n;return[null===(t=e.surfaceView)||void 0===t?void 0:t.spatialReference,null===(n=e.surfaceView)||void 0===n?void 0:n.extent]}),(function(){return e._update()})),(0,k.on)((function(){var t;return null===(t=e.surface)||void 0===t?void 0:t.layers}),"change",(function(){return e._update()}))]),this._update())}},{key:"_update",value:function(){var e,t=this;if(this._updateController&&(this._updateController.abort(),this._updateController=null),null!=(null===(e=this.surfaceView)||void 0===e?void 0:e.extent)&&null!=this.surfaceView.spatialReference){var n=(0,B.be)(this.surfaceView.extent),i=new No.Z({x:n[0],y:n[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(i,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((function(e){t._updateController=null,t._set("location",e.geometry)})).catch((function(e){}))):this._set("location",i)}else this._set("location",null)}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],wf.prototype,"view",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],wf.prototype,"cache",void 0),(0,f._)([(0,E.Cb)()],wf.prototype,"surface",null),(0,f._)([(0,E.Cb)()],wf.prototype,"surfaceView",null),(0,f._)([(0,E.Cb)({readOnly:!0})],wf.prototype,"location",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],wf.prototype,"renderLocation",null),wf=(0,f._)([(0,A.j)("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],wf);var Cf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._tileGeometryUpdateExtent=(0,B.cS)(),i._tileGeometryUpdateSpatialReference=null,i.events=new $.Z,i.updating=!1,i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([this.surface.on("elevation-change",(function(t){return e._tileGeometryChanged(t)})),this.scheduler.registerTask($t.T8.SURFACE_GEOMETRY_UPDATES,this)])}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",xf),(0,B.cS)(this._tileGeometryUpdateExtent),this._set("updating",!1),en.J):en.J}},{key:"_tileGeometryChanged",value:function(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,(0,B.jn)(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}},{key:"_furthestCenterOnSurface",value:function(){for(var e=this.centerOnSurfaces[0],t=1;t<this.centerOnSurfaces.length;t++){var n=this.centerOnSurfaces[t];n.distance>e.distance&&(e=n)}return e}},{key:"_centerIntersectsExtent",value:function(e,t){var n=this.state.contentCamera.eye,i=kf,r=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(n,Tf,t),this.renderCoordsHelper.fromRenderCoords(r.renderLocation,Sf,t),Tf[0]<Sf[0]?(i[0]=Tf[0],i[2]=Sf[0]):(i[0]=Sf[0],i[2]=Tf[0]),Tf[1]<Sf[1]?(i[1]=Tf[1],i[3]=Sf[1]):(i[1]=Sf[1],i[3]=Tf[1]),(0,B.kK)(i,e)}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],Cf.prototype,"state",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Cf.prototype,"centerOnSurfaces",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Cf.prototype,"renderCoordsHelper",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Cf.prototype,"scheduler",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Cf.prototype,"surface",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Cf.prototype,"updating",void 0),Cf=(0,f._)([(0,A.j)("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],Cf);var xf={},Tf=(0,U.Ue)(),Sf=(0,U.Ue)(),kf=(0,B.cS)(),Mf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).renderPointOfView=(0,U.Ue)(),i._pois=new Array,i._debugCenters=new Map,i._tmpRay=(0,Di.Ue)(),i._centerRayDirty=!0,i._surfaceAltitudeAtCenter=0,i._surfaceAltitudeAtCenterDirty=!0,i._contentAltitudeAtCenter=0,i._contentAltitudeAtCenterDirty=!0,i._propertiesPool=new ts.L({renderPointOfView:Pf},(0,l.Z)(i)),i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e,t=this,n=this.view,r=n.state,a=n.basemapTerrain,o=n.renderCoordsHelper,s=n.map;this._surfaceIntersector=(0,ea.Z8)(r.viewingMode),r.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=mh.eC.MIN,this._contentIntersector=(0,ea.Z8)(r.viewingMode);var l=function(){return t._estimateSurfaceAltitudeAtCenter()},u=this.view.resourceController.scheduler,c=null===(e=this.view.basemapTerrain)||void 0===e?void 0:e.elevationQueryCache,h={state:r,scheduler:u,surface:a,renderCoordsHelper:o};this._set("centerOnSurfaceInfrequent",new uf((0,He.Z)((0,He.Z)({},h),{},{task:$t.T8.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:l}))),this._set("centerOnSurfaceFrequent",new uf((0,He.Z)((0,He.Z)({},h),{},{task:$t.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:l}))),this._set("centerOnContent",new uf((0,He.Z)((0,He.Z)({},h),{},{task:$t.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:function(){return t._estimateContentAltitudeAtCenter()}}))),this._set("cameraOnSurface",new rf((0,He.Z)((0,He.Z)({},h),{},{cache:c,task:$t.T8.POINT_OF_INTEREST_INFREQUENT,map:s}))),this._set("surfaceGeometryUpdates",new Cf((0,He.Z)((0,He.Z)({},h),{},{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new vf({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:o})),this._set("surfaceOrigin",new wf({cache:c,view:this.view})),this._set("focus",new mf({state:r,scheduler:u,surface:a,renderCoordsHelper:o,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:function(e,n){return t._estimateSurfaceIntersectionAtRenderPoint(e,t.view.state.contentCamera,n)}})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);var d=this.view.graphics;this._debugCenters.set(this.centerOnContent,new ef(d,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new ef(d,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new ef(d,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new ef(d,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new ef(d,"green","Focus")),this.addHandles([(0,k.watch)((function(){return r.contentCamera}),(function(e){return t._cameraChanged(e)}),k.sync),(0,k.watch)((function(){return a.extent}),(function(){return t._updateCenterPointsOfInterest()})),(0,k.when)((function(){return!a.updating}),(function(){return t._updateCenterPointsOfInterest()}),k.sync),(0,k.on)((function(){return t.surfaceGeometryUpdates.events}),"request-update",(function(){return t._updateCenterPointsOfInterest()})),(0,k.on)((function(){return t.contentGeometryUpdates.events}),"request-update",(function(){return t._updateCenterOnContent()})),(0,k.when)((function(){return Vl.h.SHOW_POI}),(function(e){return t._setDebug(e)}),k.initial)]),this._cameraChanged(this.view.state.contentCamera);var f,v=(0,i.Z)(this._pois);try{for(v.s();!(f=v.n()).done;){f.value.runTask()}}catch(p){v.e(p)}finally{v.f()}}},{key:"destroy",value:function(){this._setDebug(!1),this._propertiesPool.destroy();var e,t=(0,i.Z)(this._pois);try{for(t.s();!(e=t.n()).done;){e.value.destroy()}}catch(n){t.e(n)}finally{t.f()}this.surfaceOrigin.destroy()}},{key:"updating",get:function(){var e;return!((null===(e=this.surfaceGeometryUpdates)||void 0===e||!e.updating)&&!this._pois.some((function(e){return e.updating})))}},{key:"_centerRay",get:function(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}},{key:"_estimateContentAltitudeAtCenter",value:function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;var e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Rf,Of)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Rf):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}},{key:"_estimateSurfaceAltitudeAtCenter",value:function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;var e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;var t=e.origin,n=(0,et.g)(Rf,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,n),this._surfaceIntersector.results.min.getIntersectionPoint(Rf)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Rf)),this._surfaceAltitudeAtCenter}},{key:"_estimateSurfaceIntersectionAtRenderPoint",value:function(e,t,n){var i=(0,pa.eW)(t,e,Ef);if(null==i)return null;var r=i.origin,a=(0,et.g)(Rf,i.origin,i.direction);return this._surfaceIntersector.resetWithRay(i,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,a),this._surfaceIntersector.results.min.getIntersectionPoint(n)?n:null}},{key:"_cameraChanged",value:function(e){this._updateCenterPointsOfInterest();var t=e.eye;(0,et.e)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,et.c)(this._propertiesPool.get("renderPointOfView"),t))}},{key:"_updateCenterPointsOfInterest",value:function(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;var e,t=(0,i.Z)(this._pois);try{for(t.s();!(e=t.n()).done;){e.value.updateRenderLocation()}}catch(n){t.e(n)}finally{t.f()}}},{key:"_updateCenterOnContent",value:function(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}},{key:"_setDebug",value:function(e){var t=this;if(!e)return this._debugCenters.forEach((function(e){return e.hide()})),void this.removeHandles("debug");var n,r=(0,i.Z)(this._pois);try{var a=function(){var e=n.value;t.addHandles((0,k.watch)((function(){return e.renderLocation}),(function(n){var i;return null===(i=t._debugCenters.get(e))||void 0===i?void 0:i.show(n,e.renderCoordsHelper.spatialReference)}),k.initial),"debug")};for(r.s();!(n=r.n()).done;)a()}catch(o){r.e(o)}finally{r.f()}}},{key:"test",get:function(){}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],Mf.prototype,"centerOnContent",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"centerOnSurfaceFrequent",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"centerOnSurfaceInfrequent",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"cameraOnSurface",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"focus",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"renderPointOfView",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"surfaceOrigin",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"contentGeometryUpdates",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"surfaceGeometryUpdates",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Mf.prototype,"view",void 0),(0,f._)([(0,E.Cb)()],Mf.prototype,"updating",null),Mf=(0,f._)([(0,A.j)("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],Mf);var Pf=Array,Rf=(0,U.Ue)(),Ef=(0,Di.Ue)(),Of={exclude:new Set([ya.xX])},Af=n(77178),Df=n(76861),Zf=n(5986),If=n(22689),Lf=n(72291),Nf=n(4035),Uf=n(58890),Hf=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,o.Z)(this,e),this.min=t,this.max=n,this.level=0,this.hasNoDataValues=!1}return(0,s.Z)(e,[{key:"copyFrom",value:function(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}]),e}(),Ff=n(11939),Vf=function(){function e(t,n,i){(0,o.Z)(this,e),this.type="elevation",this.level=t[0],this.i=t[1],this.j=t[2],this.extent=n,this.samplerData=new Ff.K(i,n)}return(0,s.Z)(e,[{key:"computeMinMaxValue",value:function(e,t,n,i){i.min=1/0,i.max=-1/0,i.hasNoDataValues=!1;var r=e-this.level;if(r<=0)return i;var a=Math.pow(2,r);if(Math.floor(t/a)!==this.i||Math.floor(n/a)!==this.j)return i;var o=1/0,s=-1/0,l=this.samplerData.data.width,u=this.samplerData.data.values,c=.5*ie.zl,h=(l-1)/a,d=(n-this.j*a)*h,f=(t-this.i*a)*h;if(h<1){var v=Math.floor(d),p=Math.floor(f),_=v+p*l,m=u[_],g=u[_+1],y=u[_+l],b=u[_+l+1];if(m+g+y+b<c){var w=d-v,C=f-p,x=(0,Me.bX)(m,g,y,b,w,C),T=(0,Me.bX)(m,g,y,b,w+h,C),S=(0,Me.bX)(m,g,y,b,w,C+h),k=(0,Me.bX)(m,g,y,b,w+h,C+h);return i.min=Math.min(x,T,S,k),i.max=Math.max(x,T,S,k),i}d=v,f=p,h=1}else d=Math.floor(d),f=Math.floor(f),h=Math.ceil(h);for(var M=d;M<=d+h;M++)for(var P=f;P<=f+h;P++){var R=u[M+P*l];R<c?(o=Math.min(o,R),s=Math.max(s,R)):i.hasNoDataValues=!0}return i.min=o,i.max=s,i}}]),e}(),zf=.5*ie.zl;function qf(e,t,n){if(null==n)return null;var r,a=(0,i.Z)(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o){var s=o.safeWidth,l=(0,Se.uZ)(o.dy*(o.y1-t),0,s),u=(0,Se.uZ)(o.dx*(e-o.x0),0,s),c=Math.floor(l),h=Math.floor(u),d=o.data.width,f=c*d+h,v=o.data.values,p=v[f],_=v[f+1],m=f+d,g=v[m],y=v[m+1];if(p+g+_+y<zf){var b=p+(_-p)*(u-=h);return b+(g+(y-g)*u-b)*(l-=c)}}}}catch(w){a.e(w)}finally{a.f()}return null}var Bf=n(53379),Gf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){return(0,o.Z)(this,n),t.call(this,e)}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([this.layerViews.on("change",(function(){return e.notifyChange("stencilEnabledExtents")}))])}},{key:"destroy",value:function(){}},{key:"layerViewsExtent",get:function(){return this._computeLayerViewsExtent()}},{key:"tiledLayersExtent",get:function(){return this._computeTiledLayersExtent()}},{key:"stencilEnabledExtents",get:function(){return this._computeStencilEnabledExtents()}},{key:"_computeStencilEnabledExtents",value:function(){var e=this,t=[];return this.layerViews.forEach((function(n){var i=n.layer;if("operationalLayerType"in i&&(0,X.$4)(i.operationalLayerType)&&null!=e.viewSpatialReference){var r=Xf(i.fullExtent,e.viewSpatialReference);null!=r&&t.push((0,B.oJ)(r))}})),t}}]),n}(Z.default);(0,f._)([(0,E.Cb)({readOnly:!0})],Gf.prototype,"layerViewsExtent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gf.prototype,"tiledLayersExtent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gf.prototype,"stencilEnabledExtents",null),(0,f._)([(0,E.Cb)()],Gf.prototype,"viewSpatialReference",void 0),(0,f._)([(0,E.Cb)()],Gf.prototype,"tilingScheme",void 0),(0,f._)([(0,E.Cb)()],Gf.prototype,"defaultTiledLayersExtent",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Gf.prototype,"layers",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Gf.prototype,"layerViews",void 0);var jf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"_computeLayerViewsExtent",value:function(){return this._globalExtent}},{key:"_computeTiledLayersExtent",value:function(){return this._globalExtent}},{key:"_globalExtent",get:function(){return this.viewSpatialReference.isWebMercator?ie.uU:ie.JR}}]),n}(Gf=(0,f._)([(0,A.j)("esri.views.3d.terrain.ExtentHelper")],Gf));jf=(0,f._)([(0,A.j)("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],jf);var Wf=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"_computeLayerViewsExtent",value:function(){var e=(0,B.cS)(),t=this.viewSpatialReference;this.layerViews.forEach((function(n){var i=n.layer;if(n.isResolved()&&("graphics"!==i.type||!i.internal)){var r=Xf("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,t);(0,B.jn)(e,r,e)}}));var n=(0,B.sU)(e)?e:null,i=this._get("layerViewsExtent");return(0,B.fS)(n,i)?i:n}},{key:"_computeTiledLayersExtent",value:function(){var e=this.tilingScheme;if(!e)return null;var t=this.viewSpatialReference,n=(0,B.cS)();this.layers.forEach((function(i){if(i.loaded&&(0,X.iC)(i)){var r,a=(0,Bf.E_)(i,t,he.JY.Local);if(null==a)return;var o=a.tileInfo,s=a.fullExtent,l="tilemapCache"in i?null===(r=i.tilemapCache)||void 0===r?void 0:r.effectiveMaxLOD:void 0;null!=o&&null!=s&&((0,Bf.x4)(i)||e.compatibleWith(o,l)&&s.spatialReference.equals(e.spatialReference))&&(0,B.jn)(n,s,n)}})),(0,B.jn)(n,this.defaultTiledLayersExtent,n);var i=(0,B.sU)(n)?n:null,r=this._get("tiledLayersExtent");return(0,B.fS)(i,r)?r:i}}]),n}(Gf);function Xf(e,t){return null==e||e.spatialReference.equals(t)?e:(0,V.projectWithoutEngine)(e,e.spatialReference,t)}Wf=(0,f._)([(0,A.j)("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],Wf);var Qf=n(54134),Yf=n(81753),Jf=n(19265),Kf=n(68401),$f=n(61403),ev=n(56529),tv=n(81341);function nv(){var e,t=null===(e=globalThis.require)||void 0===e?void 0:e.modules;if(t)for(var n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];r.includes(".glsl")&&delete t[r]}}var iv,rv=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],av=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._spatialReference=null,i._renderSR=null,i._overlaySREqualsRenderSR=!0,i._drapeSources=new Set,i._drapeTargets=new Set,i._placementDirty=!1,i._contentUpdated=!1,i._drawTexturesDirty=!1,i._drawTexturesAnimateDirty=!1,i._longitudeCyclical=null,i._latestOriginId=0,i._maxResolution=(0,w.Z)("esri-mobile")?2048:4096,i._animationTimeLast=0,i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this,t=this.view;this.renderer=new Jf.CB({view:t,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),t._stage.renderer.plugins.add(this.renderer);var n=function(){return e.setDrawTexturesDirty()};this._groundIntersector=(0,ea.Z8)(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([(0,k.watch)((function(){return e.renderer.hasHighlights}),n),this.renderer.events.on("has-water",(function(e){var n;return null===(n=t._stage)||void 0===n?void 0:n.renderer.setParameters({hasOverlayWater:e})})),this.renderer.events.on("content-changed",n),(0,k.watch)((function(){return t.state.camera.pixelRatio}),n),(0,k.watch)((function(){return t.state.alignPixelEnabled}),n),this.renderer.events.on("textures-disposed",(function(){return e.surface.requestRender()})),(0,k.watch)((function(){var e,n,i;return[null===(e=t.pointsOfInterest)||void 0===e?void 0:e.renderPointOfView,null===(n=t.pointsOfInterest)||void 0===n||null===(i=n.centerOnSurfaceFrequent)||void 0===i?void 0:i.location]}),(function(){return e.setPlacementDirty()})),(0,k.watch)((function(){var e,n;return[null===(e=t.state)||void 0===e?void 0:e.pixelRatio,null===(n=t.state)||void 0===n?void 0:n.contentPixelRatio]}),(function(){return e.setPlacementDirty()}),k.sync),this.surface.on("elevation-change",(function(){return e.setPlacementDirty()})),t.on("resize",(function(){return e.setPlacementDirty()})),t.resourceController.scheduler.registerTask($t.T8.OVERLAY,this),t._stage.renderView.events.on("force-camera-for-screenshot",(function(t){e._updateOverlays($t.G5,t.camera,Kf.Xx.BACKGROUND),e.renderer.hasOverlays&&e._drawOverlays(Kf.Xx.BACKGROUND,t)}))]),t._stage.renderer.renderOverlay=function(t){return e._renderOverlay(t)}}},{key:"destroy",value:function(){var e;null!==(e=this.view)&&void 0!==e&&e._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.renderOverlay=function(){}),iv&&(iv.hide(),iv=null),this.renderer=(0,x.SC)(this.renderer)}},{key:"running",get:function(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||Vl.h.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}},{key:"_isSpherical",get:function(){return this.view.state.isGlobal}},{key:"_worldToPCSRatio",get:function(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?(0,nt.Iu)(this._spatialReference).metersPerDegree:1}},{key:"_overlayStretch",get:function(){return 1.3/this.view.resolutionScale}},{key:"suspended",get:function(){return this.surface.suspended}},{key:"updating",get:function(){return this.running||this.renderer.updating||this._contentUpdated}},{key:"rendersOccludedDraped",get:function(){return this.renderer.rendersOccludedDraped}},{key:"_renderOverlay",value:function(e){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._dispatchAnimationUpdate(e),this._drawOverlays(Kf.Xx.UPDATE,this.view.state)}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},{key:"setSpatialReference",value:function(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;var t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new ra.pE(-20037508.342787,20037508.342787):new ra.pE(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}},{key:"registerDrapeSource",value:function(e,t,n){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);var i=this.renderer.createDrapeSourceRenderer(e,t,n);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),i}},{key:"registerGeometryDrapeSource",value:function(e){return this.registerDrapeSource(e,tv.S)}},{key:"_updateDrapeSourceExtent",value:function(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}},{key:"unregisterDrapeSource",value:function(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}},{key:"registerDrapeTarget",value:function(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}},{key:"unregisterDrapeTarget",value:function(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}},{key:"_setContentDirty",value:function(){this.setPlacementDirty(),this.setDrawTexturesDirty()}},{key:"setPlacementDirty",value:function(){this._placementDirty=!0}},{key:"runTask",value:function(e){return this._updateOverlays(e,this.view.state.contentCamera,Kf.Xx.UPDATE)}},{key:"_updateOverlays",value:function(e,t,n){var i=this;if(!this._spatialReference)return en.J;var r=this._computeOverlayResolution(t);this._computeOverlayExtents(t,r,cv),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,cv.stretch);var a=this._updateOverlay(Qf.fu.INNER,cv.inner,r,1*cv.pixelRatioAdjustment,cv.mapUnitsPerPixel),o=(0,B.d_)(cv.inner)/(0,B.d_)(cv.outer),s=this._updateOverlay(Qf.fu.OUTER,cv.outer,r,o*cv.pixelRatioAdjustment,cv.mapUnitsPerPixel);a!==ov.EXTENT&&s!==ov.EXTENT||(this._drapeSources.forEach((function(e){return i._updateDrapeSourceExtent(e)})),this.surface.updateTileOverlayParams(n)),a===ov.NONE&&s===ov.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}},{key:"_computeOverlayResolution",value:function(e){var t=this.view.state.contentPixelRatio*this.view.resolutionScale,n=e.fullWidth/e.pixelRatio*t,i=e.fullHeight/e.pixelRatio*t,r=Math.ceil(1.5*Math.max(n,i));return Math.min((0,kt.nq)(r),this._maxResolution)}},{key:"_updateOverlay",value:function(e,t,n,i,r){if(0===this.renderer.overlays.length)return ov.NONE;var a=this.renderer.overlays[e],o=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=r,a.pixelRatio=i,function(e,t){var n=1e-5,i=Vl.h.TESTS_DISABLE_OPTIMIZATIONS?0:n*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i}(t,a.extent)&&n===a.resolution)return o===r?ov.NONE:ov.RERENDER_ONLY;(0,B.JG)(a.extent,t),a.resolution=n;var s=(0,B.be)(a.extent);return a.renderLocalOrigin=(0,$f.a)(s[0],s[1],0,"OV_"+this._latestOriginId++),ov.EXTENT}},{key:"setTileParameters",value:function(e){var t=e.renderData.overlay;if(this.renderer.overlays.length>0){var n=this.renderer.overlays[Qf.fu.INNER],i=this.renderer.overlays[Qf.fu.OUTER],r=e.extent;this._rectInsideRect(n.extent,r)||this._rectanglesOverlap(r,n.extent)||this._rectanglesOverlap(r,i.extent)?(this._setTileOverlayData(r,Qf.fu.INNER,t),this._setTileOverlayData(r,Qf.fu.OUTER,t)):(this._clearTileOverlayData(Qf.fu.INNER,t),this._clearTileOverlayData(Qf.fu.OUTER,t))}else this._clearTileOverlayData(Qf.fu.INNER,t),this._clearTileOverlayData(Qf.fu.OUTER,t)}},{key:"overlayPixelSizeInMapUnits",value:function(e,t){if(0===this.renderer.overlays.length)return t();var n=this.renderer.overlays[Qf.fu.INNER],i=this.renderer.overlays[Qf.fu.OUTER],r=this._pointIsInExtent(e,n.extent)?n:i;return(r.extent[2]-r.extent[0])/r.resolution}},{key:"_setTileOverlayData",value:function(e,t,n){if(0!==this.renderer.overlays.length){var i=this.renderer.overlays[t].extent,r=(0,B.d_)(i),a=(0,B.Cb)(i),o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(i[0],o);var s=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);o>s&&(o=s-(e[2]-e[0]))}n.setScale(t,(0,B.d_)(e)/r,(0,B.Cb)(e)/a),n.setOffset(t,(o-i[0])/r,(e[1]-i[1])/a)}}},{key:"_clearTileOverlayData",value:function(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}},{key:"reloadShaders",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nv(),e.next=3,this.renderer.reloadShaders();case 3:this.setDrawTexturesDirty(),this.runTask($t.G5);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_dispatchAnimationUpdate",value:function(e){var t=(0,Fn.HA)(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||null!=this.view.state.forcedAnimationTime||this._drawTexturesDirty||this._drawTexturesAnimateDirty){var n=(0,Fn.HA)(t/this.surface.view._stage.renderer.animationTimeDilation),i=new ev._o(this.view.state.camera,n,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(i)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}},{key:"setDrawTexturesDirty",value:function(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}},{key:"_intersectGroundFromView",value:function(e,t,n,i){var r=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,fv,t,n);if(null==r)return!1;var a=r.origin,o=(0,et.g)(uv,r.origin,r.direction);return this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,o),this._groundIntersector.results.min.getIntersectionPoint(i)}},{key:"_findHorizonBasedPointOfInterest",value:function(e,t){var n=.5,i=.55,r=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,s=(0,Se.uZ)(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:r+o,e.aboveGround?r-o:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){var u=uv;(0,Ai.e)((0,Ai.h)(Ai.t,(0,nt.Iu)(this.view.spatialReference).radius+s),(0,Di.re)(e.eye,e.viewForward),u),(0,et.f)(u,u,e.eye);var c=ra.Q4.normalize((0,sa.cp)(e.viewForward,u,e.viewRight))/e.fovY+.5,h=c<=0||c>=1?.5:i;n=l?h*c:c+h*(1-c)}else{var d=.5*Math.PI-Math.acos(-e.viewForward[2]),f=Math.tan(d),v=(0,st.al)(0,f,1,0),p=(0,ot.t)(v,v,e.projectionMatrix)[1],_=(0,Se.uZ)(.5+.5*p,0,1);n=1===_||0===_?.5:l?_*i:1-(1-_)*i}return!!this._intersectGroundFromView(e,.5,n,t)&&(0,et.w)(t,e.eye)<a.distance*a.distance}},{key:"_computeOverlayExtents",value:function(e,t,n){var i,r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a=(0,U.Ue)();this._findHorizonBasedPointOfInterest(e,a)||(0,et.c)(a,r),Vl.h.OVERLAY_SHOW_CENTER?(null==iv&&(iv=new ef(this.view.graphics,"red")),iv.show(a,this._renderSR)):null!=iv&&iv.hide();var o=Math.max(.1,(0,et.p)(e.eye,a)),s=hr(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||(0,Zf.S)(a,this._renderSR,a,this._spatialReference);var l=this.surface.extent,u=!this._isSpherical&&(null===(i=this._spatialReference)||void 0===i?void 0:i.isGeographic),c=u&&this._spatialReference?1/(0,nt.Iu)(this._spatialReference).metersPerDegree:1,h=this.view.state.contentPixelRatio,d=e.perScreenPixelRatio/h*o*c;n.mapUnitsPerPixel=d/this._worldToPCSRatio,n.stretch=this._overlayStretch;var f=t*d/2*n.stretch,v=!1,p=u?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(f/=Math.cos((0,Yf.mZ)(a[1])),p=l[3]):(v=!0,f/=(0,nt.Iu)(this._spatialReference).metersPerDegree,p=90),f>=p&&(f=p,a[1]=0,this._spatialReference.isWebMercator&&(a[0]=0)));var _=1;v&&(f*(_=1/Math.max(.2,Math.cos(Math.abs((0,Se.Vl)(a[1])))))>180&&(_=180/f),n.mapUnitsPerPixel*=_);var m=Math.log(2)/12,g=(f=Math.exp(Math.round(Math.log(f)/m)*m))*_,y=.5*t/(32*g),b=.5*t/(32*f);a[0]=Math.round(a[0]*y)/y,a[1]=Math.round(a[1]*b)/b;var w=n.inner;w[0]=a[0]-g,w[1]=a[1]-f,w[2]=a[0]+g,w[3]=a[1]+f,this._isSpherical&&this._shiftExtentToFitBounds(w,1/0,p);var C=n.outer;if(6*g>(0,B.d_)(l))(0,B.JG)(C,l);else if(Math.PI/2-Math.abs(s-Math.PI/2)<=.25*Math.PI)C[0]=w[0]-g,C[1]=w[1]-f,C[2]=w[2]+g,C[3]=w[3]+f;else{(0,Zf.S)(e.eye,this._renderSR,uv,this._spatialReference),(0,at.$X)(lv,a,uv);var x=-Math.atan2(lv[1],lv[0])+.125*Math.PI;x<0&&(x+=2*Math.PI);var T=Math.floor(x/(.25*Math.PI));(0,ot.b)(lv,rv[T],2*f),lv[0]*=_,lv[2]*=_,(0,ot.f)(C,w,lv)}if(this._isSpherical)C[0]=this._longitudeCyclical.clamp(C[0]),C[2]=this._longitudeCyclical.clamp(C[2]),C[1]=Math.max(C[1],-p),C[3]=Math.min(C[3],p);else{var S=(0,B.jV)(w,l,hv),k=(0,B.jV)(C,l,dv);(0,B.r3)(S,k)&&(C[2]=C[0],C[3]=C[1])}var M=Math.abs(w[2]-w[0])/t;n.mapUnitsPerPixel=Math.max(n.mapUnitsPerPixel,M),n.pixelRatioAdjustment=n.mapUnitsPerPixel/M}},{key:"_drawOverlays",value:function(e,t){if(this.renderer.hasOverlays){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;var n=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;var i=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),i!==this.renderer.computeValidity()&&this.surface.updateTileOverlayParams(Kf.Xx.UPDATE),n?(this.surface.requestRender(e),e===Kf.Xx.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Kf.Xx.BACKGROUND),this.renderer}}},{key:"_rectanglesOverlap",value:function(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,B.kK)(e,t))}},{key:"_rectInsideRect",value:function(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:(0,B.r3)(e,t))}},{key:"_pointIsInExtent",value:function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var n=e.x,i=e.y;return n>t[0]&&n<t[2]&&i>t[1]&&i<t[3]}},{key:"_shiftExtentToFitBounds",value:function(e,t,n){var i=0,r=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-n?r=e[1]+n:e[3]>n&&(r=n-e[3]),(0,B.cv)(e,i,r)}},{key:"test",get:function(){}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],av.prototype,"_spatialReference",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],av.prototype,"running",null),(0,f._)([(0,E.Cb)()],av.prototype,"_placementDirty",void 0),(0,f._)([(0,E.Cb)()],av.prototype,"_contentUpdated",void 0),(0,f._)([(0,E.Cb)()],av.prototype,"_isSpherical",null),(0,f._)([(0,E.Cb)()],av.prototype,"_worldToPCSRatio",null),(0,f._)([(0,E.Cb)()],av.prototype,"renderer",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],av.prototype,"view",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],av.prototype,"surface",void 0),(0,f._)([(0,E.Cb)()],av.prototype,"suspended",null),(0,f._)([(0,E.Cb)()],av.prototype,"updating",null),(0,f._)([(0,E.Cb)({type:Boolean})],av.prototype,"rendersOccludedDraped",null),av=(0,f._)([(0,A.j)("esri.views.3d.terrain.OverlayManager")],av);var ov,sv=(0,s.Z)((function e(){(0,o.Z)(this,e),this.inner=(0,B.Ue)(),this.outer=(0,B.Ue)(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3})),lv=(0,st.Ue)(),uv=(0,U.Ue)(),cv=new sv,hv=(0,B.Ue)(),dv=(0,B.Ue)(),fv=(0,Di.Ue)();!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(ov||(ov={}));var vv=n(41414),pv=n(35367),_v=n(52920),mv=function(){function e(){(0,o.Z)(this,e),this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=(0,vv.cS)(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}return(0,s.Z)(e,[{key:"release",value:function(){this.vertexAttributes=(0,x.RY)(this.vertexAttributes),this.indices=null}},{key:"reset",value:function(){this.indices=null,this.vertexAttributes=null,(0,vv.cS)(this.boundingBox),this.numVerticesPerSide=0}},{key:"getEdgeFirstVertexIndex",value:function(e){return this.outerEdgesOffsetAndLength[2*e]}},{key:"getEdgeCount",value:function(e){return this.outerEdgesOffsetAndLength[2*e+1]}},{key:"getEdgeVertexIndex",value:function(e,t){return this.getEdgeAttributeIndex(e,t)}},{key:"getEdgeVertexPosition",value:function(e,t,n,i){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,i),t),(0,et.g)(t,t,n)}},{key:"getEdgeNormal",value:function(e,t,n){var i=this.vertexAttributes.normalCompressed,r=i.typedBuffer,a=i.typedBufferStride;(0,_v.rc)(t,r,this.getEdgeAttributeIndex(e,n),a)}},{key:"setEdgeNormalFromValues",value:function(e,t,n,i,r){this._setNormal(this.getEdgeAttributeIndex(e,t),n,i,r)}},{key:"setEdgeVertexFromValuesRawPositionUV",value:function(e,t,n,i,r,a,o){var s=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(s,n,i,r),this._setUV(s,a,o)}},{key:"setEdgeVertexFromValuesRawPositionUVNormal",value:function(e,t,n,i,r,a,o,s,l,u){var c=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(c,n,i,r),this._setUV(c,a,o),this._setNormal(c,s,l,u)}},{key:"_getEdgeVertexRaw",value:function(e,t){this.vertexAttributes.position.getVec(e,t)}},{key:"_setNormal",value:function(e,t,n,i){var r=this.vertexAttributes.normalCompressed,a=r.typedBuffer,o=r.typedBufferStride;(0,_v.hd)(a,e,t,n,i,o)}},{key:"_setUV",value:function(e,t,n){gv(this.vertexAttributes.uv0,e,t,n)}},{key:"getEdgeAttributeIndex",value:function(e,t){return(0,Bf.Fp)(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}}]),e}();function gv(e,t,n,i){e.setValues(t,16384*n,16384*i)}var yv,bv=function(){function e(){(0,o.Z)(this,e),this.sinLonLUT=new Array(ie.Cf+1),this.cosLonLUT=new Array(ie.Cf+1),this.sinLatLUT=new Array(ie.Cf+1),this.cosLatLUT=new Array(ie.Cf+1)}return(0,s.Z)(e,[{key:"update",value:function(e,t,n){for(var i=t[0],r=t[2],a=0;a<=e;a++){var o=a/e,s=i*(1-o)+r*o;this.sinLonLUT[a]=Math.sin(s),this.cosLonLUT[a]=Math.cos(s);var l=n(o);this.sinLatLUT[a]=Math.sin(l),this.cosLatLUT[a]=Math.cos(l)}}}]),e}(),wv=(0,s.Z)((function e(){(0,o.Z)(this,e),this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]})),Cv=function(){function e(t){(0,o.Z)(this,e),this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}return(0,s.Z)(e,[{key:"clear",value:function(){this._current=(0,x.SC)(this._current),this._next=(0,x.SC)(this._next),this._waiting=(0,x.SC)(this._waiting),this._delayed=(0,x.SC)(this._delayed)}},{key:"current",get:function(){if(null==this._current)return null;if(!this._isFadingEnabled){var t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}var n=e.test.fadeMoment;if(null!=this._delayed&&((n=n||performance.now())>=this._delayedTime&&(this._push(this._delayed,yv.Immediate),this._delayed=null)),null!=this._next){n=n||performance.now();var i=this._fadeDuration,r=null!=this._current&&this._next.texture===this._current.texture,a=this._next.type!==Qf.Ns.FADING,o=n-this._fadeStart>=i;(r||a||o)&&((0,x.SC)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(n))}return this._current}},{key:"next",get:function(){return this._next}},{key:"fadeFactor",get:function(){if(null==this._next)return 1;var t=e.test.fadeMoment||performance.now(),n=Math.max(0,t-this._fadeStart),i=this._fadeDuration;return n>i?0:1-n/i}},{key:"isFading",get:function(){return null!=this._next||null!=this._delayed}},{key:"push",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:yv.Immediate;this._delayed=(0,x.SC)(this._delayed),this._push(e,t)}},{key:"_push",value:function(t,n){if(this._isFadingEnabled||this.clear(),null!=this._current){var i=e.test.fadeMoment||performance.now();return n!==yv.Immediate?(this._delayed=t,void(this._delayedTime=i+n)):null==this._next?(this._next=t,void(this._fadeStart=this._alignFadeStart(i))):void(null!=t&&((0,x.SC)(this._waiting),this._waiting=t))}this._current=t}},{key:"_fadeDuration",get:function(){return null==this._waiting?this._getFadeDuration():.5*this._getFadeDuration()}},{key:"_alignFadeStart",value:function(e){var t=this._getFadeDuration();return e+t-e%t}},{key:"_isFadingEnabled",get:function(){return this._getFadeDuration()>0}}]),e}();Cv.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(yv||(yv={}));var xv=n(5647),Tv=n(24204),Sv=n(36734),kv=function(){function e(){(0,o.Z)(this,e)}return(0,s.Z)(e,[{key:"updating",get:function(){return!!this._tileRequested}},{key:"init",value:function(e,t,n,i){this.tile=e,this._layerIdx=t,this._layerClass=n,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,n),this._tileRequested=null;var r=this._findAncestorWithData();this._setUpsampleTile(r)}},{key:"startLoading",value:function(){return this._requestNext()}},{key:"dispose",value:function(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}},{key:"setSuspension",value:function(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}},{key:"update",value:function(){var e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}},{key:"dataArrived",value:function(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,Qf.Ns.FADING,t):this._requestNext()}},{key:"dataMissing",value:function(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}},{key:"_agentDone",value:function(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}},{key:"_requestNext",value:function(){if(this._suspended)return!0;var e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}},{key:"_findNextDownload",value:function(){for(var e,t=this._layerIdx,n=this._layerClass,i=this.tile.surface.layerViewByIndex(t,n),r=(0,Bf.RB)(i),a=i.dataLevelRange,o=a.minLevel,s=a.maxLevel,l=this._desiredMinLevelDelta,u=this._progressiveLevelModulo+l,c=this._scaleRangeEnabled?Sv.yf:function(){return!0},h=this.tile,d=h.level,f=this._tileLayerInfo.upsampleInfo,v=null!=f?f.tile.level:-1,p=null!=f&&v-d>=l,_=null===r||void 0===r?void 0:r.tilemapCache,m="vector-tile-3d"===i.type?i.schemaHelper:null;h&&c(h,r,!1)&&h.level>=o;){var g,y=h.level,b=d-y,w=h.layerInfo[n][t];if(w.data&&b>=l){(!p||y>v)&&this._setUpsampleTile(h),w.dataInvalidated&&(e=h);break}var C=null!==(g=null===m||void 0===m?void 0:m.getLevelRowColumn(h.lij))&&void 0!==g?g:h.lij;if("unavailable"!==(null===_||void 0===_?void 0:_.getAvailability(C[0],C[1],C[2]))&&y<=s&&!w.data&&!w.dataMissing&&((!e||h.level===o||y%ie.GZ==0||d-e.level<l)&&(e=h),b>=u))break;h=h.parent}if(null!=e&&d-e.level<l)if(f)e=null;else{var x=this._findAncestorWithData();null!=x&&(this._setUpsampleTile(x),e=x.layerInfo[n][t].dataInvalidated?x:null)}return e}},{key:"_findAncestorWithData",value:function(){for(var e,t=this.tile.elevationLevel,n=this._desiredMinLevelDelta,i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(t-i.level>=n)return i;e=i}return e}},{key:"_setUpsampleTile",value:function(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,Qf.Ns.FADING,t)}},{key:"test",get:function(){}}]),e}(),Mv=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).type="none",e}return(0,s.Z)(n,[{key:"_desiredMinLevelDelta",get:function(){throw Pv}},{key:"_progressiveLevelModulo",get:function(){throw Pv}},{key:"dispose",value:function(){}}]),n}(kv),Pv=new Error("Abstract method called on TileAgent"),Rv=new Mv,Ev=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).type="elevation",e._scaleRangeEnabled=!1,e}return(0,s.Z)(n,[{key:"_desiredMinLevelDelta",get:function(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}},{key:"_progressiveLevelModulo",get:function(){return 0}}]),n}(kv);var Ov,Av=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.call(this)).type="map",e._scaleRangeEnabled=!0,e}return(0,s.Z)(n,[{key:"_desiredMinLevelDelta",get:function(){return 0}},{key:"_progressiveLevelModulo",get:function(){return ie.GZ}}]),n}(kv);!function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"}(Ov||(Ov={}));var Dv,Zv=function(){function e(){(0,o.Z)(this,e),this.waitingAgents=new Fl.Z,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}return(0,s.Z)(e,[{key:"release",value:function(){this.dispose(),Lv.delete(this),Iv.release(this)}},{key:"dispose",value:function(){this.loadingAgent=(0,x.M2)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=(0,Bf.ep)(this._data)}},{key:"_init",value:function(e){this.waitingAgents.clear(),this._data=(0,Bf.ep)(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}},{key:"invalidateSourceData",value:function(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}},{key:"abortRequest",value:function(){this.requestAbort=(0,x.IM)(this.requestAbort),this.requestPromise=null}},{key:"upsampleInfo",get:function(){return this._upsampleInfo}},{key:"_unsetUpsampleInfo",value:function(){null!=this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}},{key:"setUpsampleInfo",value:function(e,t){if(e!==t&&null!=t){if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),(0,Sv.QT)(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}},{key:"data",get:function(){return this._data},set:function(e){(0,Bf.ep)(this._data),this._data=e}}],[{key:"acquire",value:function(e){var t=Iv.acquire();return t._init(e),t}},{key:"prune",value:function(){Iv.prune(0)}}]),e}(),Iv=new Iu.Z(Zv,null,(function(){})),Lv=new Map;!function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.GEOMETRY=8]="GEOMETRY",e[e.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=32]="TEXTURE_FADING"}(Dv||(Dv={}));var Nv=function(){function e(){(0,o.Z)(this,e),this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,B.Ue)(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=(0,B.Ue)(),this.centerAtSeaLevel=(0,U.Ue)(),this._center=[(0,U.Ue)(),(0,Ai.c)(),(0,U.Ue)()],this.up=(0,U.tN)(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=(0,U.Ue)(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}return(0,s.Z)(e,[{key:"lij",get:function(){return this._lij}},{key:"elevationLevelDelta",get:function(){return this._surface.getElevationLevelDelta(this.level)}},{key:"_isCached",get:function(){return!this.isLeaf&&this._mapDataRefCount<=0}},{key:"maxTesselation",get:function(){return this._maxTesselation}},{key:"isWithinClippingArea",get:function(){return this._isWithinClippingArea}},{key:"intersectsClippingArea",get:function(){return this._intersectsClippingArea}},{key:"clippingArea",get:function(){return this._clippingArea}},{key:"parent",get:function(){return this._parent}},{key:"children",get:function(){return this._children}},{key:"surface",get:function(){return this._surface}},{key:"elevationBoundsMin",get:function(){return this._elevationBoundsMin}},{key:"elevationBoundsMax",get:function(){return this._elevationBoundsMax}},{key:"level",get:function(){return this._lij[0]}},{key:"key",get:function(){return"".concat(this._lij[0],"/").concat(this._lij[1],"/").concat(this._lij[2])}},{key:"edgeLen",get:function(){return this._edgeLen}},{key:"radius",get:function(){return this._center[Fv.MIDDLE][3]}},{key:"visible",get:function(){return this._dirty&&this.computeVisibility(),this._visible}},{key:"frustumVisibility",get:function(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}},{key:"computeVisibility",value:function(){var e;this._dirty=!1;var t=this.parent,n=null!==(e=null===t||void 0===t?void 0:t.frustumVisibility)&&void 0!==e?e:Ov.INTERSECTS;this._frustumVisibility=n===Ov.INSIDE?Ov.INSIDE:n===Ov.OUTSIDE?Ov.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);var i=this._frustumVisibility!==Ov.OUTSIDE&&this._intersectsClippingArea;i!==this._visible&&(this._visible=i,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}},{key:"loadable",get:function(){return this.visible||this._surface.view.state.fixedContentCamera}},{key:"rendered",get:function(){var e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}},{key:"init",value:function(e,t,n,r,a){this._lij[0]=e,this._lij[1]=t,this._lij[2]=n,this.ellipsoid=(0,nt.Iu)(a.tilingScheme.spatialReference),a.tilingScheme.getExtent(e,t,n,this.extent),a.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,a.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Fv.MIDDLE][3]=0,this.elevationLevel=e,r&&!Number.isNaN(r.elevationBoundsMin)?(this._elevationBoundsMin=r.elevationBoundsMin,this._elevationBoundsMax=r.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.unsetChildren(),this._surface=a,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;var o,s=(0,i.Z)($h);try{for(s.s();!(o=s.n()).done;){var l,u=o.value,c=a.numLayers(u),h=this.layerInfo[u],d=(0,i.Z)(h);try{for(d.s();!(l=d.n()).done;){l.value.release()}}catch(v){d.e(v)}finally{d.f()}h.length=c;for(var f=0;f<c;f++)h[f]=Zv.acquire(this._surface.upsampleInfoPool),u===Wh.ELEVATION&&this.findElevationBoundsForLayer(f,-1)}}catch(v){s.e(v)}finally{s.f()}this.computeElevationBounds(),this._maxTesselation=Math.min(a.tilingScheme.pixelSize,ie.Cf)}},{key:"dispose",value:function(){(0,Bf.wu)(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);var e,t=(0,i.Z)($h);try{for(t.s();!(e=t.n()).done;){var n,r=e.value,a=(0,i.Z)(this.layerInfo[r]);try{for(a.s();!(n=a.n()).done;){n.value.release()}}catch(s){a.e(s)}finally{a.f()}this.layerInfo[r].length=0}}catch(s){t.e(s)}finally{t.f()}this._parent=null;for(var o=0;o<4;++o)this._children[o]=null;this._surface=null,this.setMemoryDirty()}},{key:"refMapData",value:function(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}},{key:"unrefMapData",value:function(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();var e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}},{key:"setMemoryDirty",value:function(){this._usedMemory=null}},{key:"usedMemory",get:function(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}},{key:"_cachedMemory",get:function(){return this._isCached?this._mapTileMemory:0}},{key:"_mapTileMemory",get:function(){return this._ensureUsedMemory(),this.layerInfo[Wh.MAP].reduce((function(e,t){var n=t.data;return e+((0,Td.AK)(n)?n.usedMemory/n.referenced:0)}),this._mapTileMemoryInternal)}},{key:"_cpuImageMemorySize",get:function(){var e=this._surface.tilingScheme.pixelSize;return e*e*4}},{key:"_ensureUsedMemory",value:function(){var e,t;if(null!=this._usedMemory)return this._usedMemory;this._usedMemory=this._baseUsedMemory,this._mapTileMemoryInternal=0;var n,r=0,a=(0,i.Z)(this.layerInfo[Wh.MAP]);try{for(a.s();!(n=a.n()).done;){var o=n.value.data;(0,Td.AK)(o)?r+=this._getTerrainDataMemory(o):this._mapTileMemoryInternal+=this._getTerrainDataMemory(o)}}catch(h){a.e(h)}finally{a.f()}var s,l=this._cpuImageMemorySize,u=(0,i.Z)(this.layerInfo[Wh.ELEVATION]);try{for(u.s();!(s=u.n()).done;){var c=s.value;this._usedMemory+=c.data?l:0}}catch(h){u.e(h)}finally{u.f()}return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=null!==(e=null===(t=this.renderData.texture)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+r),this._usedMemory}},{key:"getUsedMemoryForLayer",value:function(e,t){var n=this.layerInfo[e][t];return null!==n&&void 0!==n&&n.data?e===Wh.MAP?this._isCached?0:this._getTerrainDataMemory(n.data):e===Wh.ELEVATION?this._cpuImageMemorySize:0:0}},{key:"_getTerrainDataMemory",value:function(e){return(0,Td.Q_)(e)?e.texture.usedMemory:(0,Td.yd)(e)?e.memoryUsage:(0,Td.AK)(e)?e.usedMemory/e.referenced:(0,Td.Cm)(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}},{key:"updateScreenDepth",value:function(e){var t=this._center[Fv.MIDDLE],n=e,i=t[0],r=t[1],a=t[2],o=n[2]*i+n[6]*r+n[10]*a+n[14];this.screenDepth=o<0?0:o/(n[3]*i+n[7]*r+n[11]*a+n[15])}},{key:"shouldSplit",value:function(e,t,n){var i=this;if(!this.visible)return Dv.NONE;if(e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===Ov.OUTSIDE))return Dv.NONE;var r=this.level;(0,et.f)(Qv,(0,Ai.g)(this._center[Fv.MIDDLE]),t);var a=(0,et.q)(Qv),o=Qv,s=(0,Ai.g)(this._center[Fv.MIDDLE]);(0,et.f)(Yv,this._center[Fv.TOP],t);var l=(0,et.q)(Yv);l<a&&(a=l,o=Yv,s=this._center[Fv.TOP]),(0,et.f)(Jv,this._center[Fv.BOTTOM],t);var u=(0,et.q)(Jv);if(u<a&&(a=u,o=Jv,s=this._center[Fv.BOTTOM]),this._edgeLen2>a&&r<e.maxLod)return Dv.SPLIT;var c=Math.sqrt(a),h=e.fovX*c*2,d=this._edgeLen/h,f=function(){if(r<e.maxLod)return i.elevationLevel=r,Dv.NONE;var t=r+Math.ceil(-Math.log2(e.relativeWidthLimit/d));return t!==i.elevationLevel?(i.elevationLevel=t,Dv.ELEVATION):Dv.NONE},v=null!=n?n-r:1/0;if(v<=.5)return f();var p=(0,et.m)(this.up,Qv),_=this._elevationBoundsMax-this._elevationBoundsMin,m=_/this.edgeLen;if(e.aboveGround&&p>0&&m<.001&&p/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-m>0)return Dv.NONE;var g=null!=n?3-Math.min(v,2):1;if(d*g<e.relativeWidthLimit||r>=e.maxLod)return f();if(r<7)return Dv.SPLIT;(0,et.j)(Kv,this.up,p),(0,et.f)(Kv,Kv,o);var y=(0,et.q)(Kv);if(y<=this.radius*this.radius)return Dv.SPLIT;(0,et.j)(Kv,Kv,this.radius/Math.sqrt(y)),(0,et.g)(Kv,Kv,s),(0,et.f)(Kv,t,Kv);var b=Math.min(1,(Math.abs((0,et.m)(Kv,this.up))+.5*_+this._curvatureHeight)/(0,et.l)(Kv)),w=.1/e.angledSplitBias,C=e.fovY*c*2;return b*(this._edgeLen/C*g)<w*e.relativeHeightLimit?Dv.NONE:Dv.SPLIT}},{key:"setChildren",value:function(e,t,n,i){(0,Bf.wu)(!!(e&&t&&n&&i),"Null child passed");var r=this._children;return r[0]=e,r[1]=t,r[2]=n,r[3]=i,r}},{key:"unsetChildren",value:function(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}},{key:"isLoaded",get:function(){var e,t;return null!==(e=null===(t=this.renderData)||void 0===t?void 0:t.hasGeometry)&&void 0!==e&&e}},{key:"load",value:function(){this.refMapData();var e,t=(0,i.Z)($h);try{for(t.s();!(e=t.n()).done;){var n=e.value;this._createOrUpdateAgents(0,n)}}catch(r){t.e(r)}finally{t.f()}this.surface.renderer.loadTile(this)}},{key:"unload",value:function(e){e.unloadTile(this);var t,n=(0,i.Z)($h);try{for(n.s();!(t=n.n()).done;){var r,a=t.value,o=this.layerInfo[a],s=(0,i.Z)(o);try{for(s.s();!(r=s.n()).done;){var l=r.value;l.loadingAgent&&l.loadingAgent!==Rv&&(Hv(l.loadingAgent),l.loadingAgent=null),l.pendingUpdates=0}}catch(u){s.e(u)}finally{s.f()}}}catch(u){n.e(u)}finally{n.f()}this.resetPendingUpdate(Dv.GEOMETRY),this.resetPendingUpdate(Dv.TEXTURE_NOFADING),this.resetPendingUpdate(Dv.TEXTURE_FADING),this.unrefMapData()}},{key:"unloadMapData",value:function(){var e,t=this.layerInfo[Wh.MAP],n=(0,i.Z)(t);try{for(n.s();!(e=n.n()).done;){var r=e.value;r.loadingAgent&&r.loadingAgent!==Rv&&(Hv(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0}}catch(a){n.e(a)}finally{n.f()}this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}},{key:"updateClippingStatus",value:function(e){if((0,B.fS)(e,this._clippingArea))return!1;var t=this._intersectsClippingArea,n=this._isWithinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();var i=n&&this._isWithinClippingArea,r=!(n||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||i||r||this.setPendingUpdate(Dv.GEOMETRY),!0}},{key:"updateVisibility",value:function(){this._dirty=!0,this._surface.setTileTreeDirty()}},{key:"getLayerInfo",value:function(e,t){return this.layerInfo[t][e]}},{key:"hasLayerData",value:function(e,t){var n=this.layerInfo[t][e];return!(null===n||void 0===n||!n.data||n.dataInvalidated)}},{key:"updating",get:function(){if(this.hasPendingUpdates)return!0;var e,t=(0,i.Z)($h);try{for(t.s();!(e=t.n()).done;){var n,r=e.value,a=this.layerInfo[r],o=(0,i.Z)(a);try{for(o.s();!(n=o.n()).done;){var s=n.value;if(s.loadingAgent&&s.loadingAgent!==Rv&&s.loadingAgent.updating)return!0}}catch(l){o.e(l)}finally{o.f()}}}catch(l){t.e(l)}finally{t.f()}return!1}},{key:"_isSuspended",value:function(e){return!!this.hasPendingUpdate(Dv.SPLIT)||e!==Wh.ELEVATION&&!this.loadable}},{key:"hasPendingUpdates",get:function(){return 0!==this._pendingUpdates}},{key:"hasPendingUpdate",value:function(e){return(this._pendingUpdates&e)===e}},{key:"setPendingUpdate",value:function(e){var t=this._pendingUpdates;return this._pendingUpdates|=e,e===Dv.SPLIT||e===Dv.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}},{key:"resetPendingUpdate",value:function(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}},{key:"requestLayerData",value:function(e,t,n){var i=this.layerInfo[t][e];if(i.waitingAgents.has(n))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),n.tile.lij.toString(),t,e),!0;if(i.waitingAgents.push(n),i.data&&!i.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),n.tile.lij.toString(),t,e);var r=(0,Td.AK)(i.data);return n.dataArrived(this,r),!0}if(i.requestPromise)return!0;(0,x.IM)(i.requestAbort),i.requestAbort=new AbortController;var a=this._surface.requestTileData(this,e,t,i.requestAbort);if(!a)return i.requestAbort=null,!1;var o=function(){i.requestPromise===a&&(i.requestPromise=null,i.requestAbort=null)};return i.requestPromise=a,a.then(o,o),!0}},{key:"isLeaf",get:function(){return null==this._children[0]}},{key:"hasLij",value:function(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}},{key:"findByLij",value:function(e){if(this.hasLij(e))return this;var t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}},{key:"distanceToSquared",value:function(e){return(0,et.q)((0,et.f)(Kv,(0,Ai.g)(this._center[Fv.MIDDLE]),e))}},{key:"containsPoint",value:function(e){var t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}},{key:"containsPointXY",value:function(e,t){var n=this.extent;return e>=n[0]&&t>=n[1]&&e<=n[2]&&t<=n[3]}},{key:"unrequestLayerData",value:function(e,t,n){var i=this.layerInfo[t][e],r=i.waitingAgents,a=null!=r.removeUnordered(n);(0,Bf.wu)(a,"agent has not requested this piece of map data"),r.length<1&&(i.abortRequest(),this.setMemoryDirty())}},{key:"dataArrived",value:function(e,t,n){var i=this,r=(0,Td.AK)(n),a=this.layerInfo[t][e];a.data=n,a.dataInvalidated=!1,a.waitingAgents.forAll((function(e){return e.dataArrived(i,r)})),a.waitingAgents.clear(),this.setMemoryDirty()}},{key:"dataMissing",value:function(e,t){var n=this.layerInfo[t][e];n.dataMissing=!0,n.waitingAgents.forAll((function(e){return e.dataMissing()})),n.waitingAgents.clear(),this.setMemoryDirty()}},{key:"updateRenderData",value:function(e,t,n){switch(n&&this.forEachLoadedNeighbor((function(n){return n.updateRenderData(e,t)})),e){case Wh.MAP:return this._updateTexture(t);case Wh.ELEVATION:return this._updateGeometry()}}},{key:"_updateTexture",value:function(e){this.renderData&&(this.resetPendingUpdate(e===Qf.Ns.FADING?Dv.TEXTURE_NOFADING:Dv.TEXTURE_FADING),this.setPendingUpdate(e===Qf.Ns.FADING?Dv.TEXTURE_FADING:Dv.TEXTURE_NOFADING))}},{key:"_updateGeometry",value:function(){this.setPendingUpdate(Dv.GEOMETRY);var e,t=(0,i.Z)(this.layerInfo[Wh.ELEVATION]);try{for(t.s();!(e=t.n()).done;){e.value.pendingUpdates|=Dv.GEOMETRY}}catch(n){t.e(n)}finally{t.f()}}},{key:"invalidateLayerData",value:function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}},{key:"computeElevationBounds",value:function(){var e,t=this._elevationBoundsMin,n=this._elevationBoundsMax,r=1/0,a=-1/0,o=this.layerInfo[Wh.ELEVATION],s=!0,l=(0,i.Z)(o);try{for(l.s();!(e=l.n()).done;){var u=e.value;null!=u.elevationBounds&&(r=Math.min(r,u.elevationBounds.min),a=Math.max(a,u.elevationBounds.max),u.elevationBounds.hasNoDataValues||(s=!1))}}catch(c){l.e(c)}finally{l.f()}s&&(r=Math.min(r,0),a=Math.max(a,0)),t===r&&n===a||(this._elevationBoundsMin=r,this._elevationBoundsMax=a,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}},{key:"_updateCenter",value:function(){var e=this._elevationBoundsMin,t=this._elevationBoundsMax,n=.5*(e+t),i=this._center;(0,et.j)(Kv,this.up,n),(0,et.g)((0,Ai.g)(i[Fv.MIDDLE]),this.centerAtSeaLevel,Kv),(0,et.j)(Kv,this.up,e),(0,et.g)(i[Fv.TOP],this.centerAtSeaLevel,Kv),(0,et.j)(Kv,this.up,t),(0,et.g)(i[Fv.BOTTOM],this.centerAtSeaLevel,Kv)}},{key:"findElevationBoundsForLayer",value:function(e,t){var n=this.layerInfo[Wh.ELEVATION][e],i=this.elevationLevelDelta,r=Math.max(this.elevationLevel-i,0),a=n.elevationBounds;if(!(null!=a&&a.level>=t&&a.level<=r)){var o=this._surface.layerViewByIndex(e,Wh.ELEVATION),s=(0,Bf.RB)(o);if((0,Sv.yf)(this,s,!1)){var l=qv,u=!1,c=n.data;if(c&&c.level<=r){var h=n.data;l.min=h.samplerData.data.minValue,l.max=h.samplerData.data.maxValue,l.hasNoDataValues=h.samplerData.data.hasNoDataValues,l.level=this.level,u=!0}else{for(var d,f,v=0,p=this._parent;p&&(!f||v<i)&&(v=this.elevationLevel-p.level,d=f||d,!(!(f=p.layerInfo[Wh.ELEVATION][e].data)&&d&&p.level<=r));p=p.parent);(f=f||d)&&(f.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=f.level,u=!0))}u&&(null==n.elevationBounds&&(n.elevationBounds=new Hf),n.elevationBounds.copyFrom(l))}}}},{key:"modifyLayers",value:function(e,t,n){var r,a=this.layerInfo[n],o=(0,i.Z)(a);try{for(o.s();!(r=o.n()).done;){var s=r.value;s.loadingAgent&&s.loadingAgent!==Rv&&(Hv(s.loadingAgent),s.loadingAgent=null),s.waitingAgents.clear()}}catch(f){o.e(f)}finally{o.f()}for(var l=0;l<a.length;++l)void 0===e[l]&&a[l].release();var u=(0,xv.Z)(Array,(0,Ru.Z)(a)),c=t.length;a.length=c;for(var h=0;h<c;h++){var d=t[h];a[h]=d>-1?u[d]:Zv.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}},{key:"restartAgents",value:function(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,Qf.Ns.FADING))}},{key:"updateAgents",value:function(e){if(this.renderData){var t,n=this.layerInfo[e],r=(0,i.Z)(n);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.loadingAgent===Rv&&(a.loadingAgent=null)}}catch(o){r.e(o)}finally{r.f()}this._createOrUpdateAgents(0,e)}}},{key:"updateAgentSuspension",value:function(){var e,t=(0,i.Z)($h);try{for(t.s();!(e=t.n()).done;){var n,r=e.value,a=this._isSuspended(r),o=(0,i.Z)(this.layerInfo[r]);try{for(o.s();!(n=o.n()).done;){var s=n.value;s.loadingAgent&&s.loadingAgent!==Rv&&(s.loadingAgent.setSuspension(a),s.loadingAgent===Rv&&this.updateRenderData(r,Qf.Ns.FADING))}}catch(l){o.e(l)}finally{o.f()}}}catch(l){t.e(l)}finally{t.f()}}},{key:"removeLayerAgent",value:function(e,t){var n=this.layerInfo[t][e];n.loadingAgent&&n.loadingAgent!==Rv&&n.loadingAgent.dispose(),n.loadingAgent=null}},{key:"agentDone",value:function(e,t){var n=this.layerInfo[t][e];n.loadingAgent=Rv,n.data||null!=n.upsampleInfo||this._createOrUpdateAgents(e+1,t)}},{key:"_hasBlendableAncestor",value:function(e){return"normal"!==e.blendMode||(0,X.CY)(e.parent)&&this._hasBlendableAncestor(e.parent)}},{key:"_hasBlendModes",value:function(e,t,n){for(var i=e;i<t;++i){var r,a,o,s=this._surface.layerViewByIndex(i,n);if((0,Bf.TK)(s)&&"normal"!==(null===s||void 0===s||null===(r=s.layer)||void 0===r?void 0:r.blendMode)||(0,X.CY)(null===s||void 0===s||null===(a=s.layer)||void 0===a?void 0:a.parent)&&this._hasBlendableAncestor(null===s||void 0===s||null===(o=s.layer)||void 0===o?void 0:o.parent))return!0}return!1}},{key:"_createOrUpdateAgents",value:function(e,t){var n=this.layerInfo[t];if(0!==n.length)for(var i=this._isSuspended(t),r=e;r<n.length;++r){var a=n[r],o=!1,s=this._surface.layerViewByIndex(r,t),l=(0,Bf.RB)(s);if(a.loadingAgent?(0,Sv.yf)(this,l,!1)?(a.loadingAgent!==Rv&&a.loadingAgent.setSuspension(i),a.loadingAgent!==Rv&&(o=a.loadingAgent.update())):a.dispose():(0,Sv.yf)(this,l,!1)&&(a.loadingAgent=Uv(this,r,t,i),(o=a.loadingAgent.startLoading())?a.loadingAgent===Rv&&this.setPendingUpdate(Dv.GEOMETRY):(Hv(a.loadingAgent),a.loadingAgent=Rv)),a.loadingAgent===Rv&&this.updateRenderData(t,Qf.Ns.FADING),!this._hasBlendModes(e,n.length,t)&&o&&s.isOpaque)return}}},{key:"_isWithinExtent",value:function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}},{key:"intersectsExtent",value:function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}},{key:"getElevationVerticesPerSide",value:function(e){var t=this.elevationLevel-this.level,n=Math.max(this.level-e,this.elevationLevelDelta-t),i=(0,Se.uZ)(1+(this.maxTesselation>>n),2,this.maxTesselation+1),r=this.getDefaultVerticesPerSide();return Math.max(i,r)}},{key:"_findLIJ",value:function(e,t){if(!e)return null;var n=this.surface.rootTiles;if(null!=n){var r,a=(0,i.Z)(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(Bv(o,e)){for(var s=o,l=e[0]-s.level-1;l>=0&&!s.isLeaf&&!t(s);){var u=e[1]>>l&1,c=e[2]>>l&1;s=s.children[2*u+c],l--}return t(s)?s:null}}}catch(h){a.e(h)}finally{a.f()}}return null}},{key:"findNeighborTile",value:function(e,t){var n=this._lij,i=this.getNeighborLIJ(n,e);return i?Gv(n,i)?t(this)?this:null:this._findLIJ(i,t):null}},{key:"findCorner",value:function(e,t){for(var n=e===pv.X.NORTH_EAST?1:e===pv.X.NORTH_WEST?0:e===pv.X.SOUTH_WEST?2:3,i=this;i.children[0]&&(!t||!t(i));)i=i.children[n];return i}},{key:"findNeighborCornerTileExact",value:function(e,t){var n,i=this;return(null===(n=this.findNeighborTile(e,(function(e){return t(e)||e.level===i.level})))||void 0===n?void 0:n.findCorner((0,Bf.$v)(e),t))||null}},{key:"forAllSubtreeOnSide",value:function(e,t){var n=e===pv.X.NORTH?[0,1]:e===pv.X.NORTH_EAST?[1]:e===pv.X.EAST?[1,3]:e===pv.X.SOUTH_EAST?[3]:e===pv.X.SOUTH?[2,3]:e===pv.X.SOUTH_WEST?[2]:e===pv.X.WEST?[0,2]:[0];!function e(i){var r=i.children;!t(i)&&r[0]&&n.forEach((function(t){return e(r[t])}))}(this)}},{key:"getNeighborEdgeStartVertexIndex",value:function(e,t){if(!t)return 0;var n=this.level-t.level;if((0,Bf.Fp)(!Bf.T9||n>=0),0===n)return 0;var i=Math.pow(2,n),r=!(1&~e),a=r?0:1,o=t.lij[a+1]*i,s=this._lij[a+1],l=s-o,u=r?i-1-l:l;return Bf.T9&&((0,Bf.Fp)(o<=s&&s<o+i),(0,Bf.Fp)(0<=u&&u<i)),u}},{key:"forEachLoadedNeighbor",value:function(e){var t=this,n=this.level,i=function(e){return e.level===n||e.isLoaded};Bf.OC.forEach((function(n){var r=t.findNeighborTile(n,i);null!=r&&r!==t&&r.forAllSubtreeOnSide((0,Bf._F)(n),(function(t){return!!t.isLoaded&&(e(t,n),!0)}))})),Bf.cA.forEach((function(n){var r,a=null===(r=t.findNeighborTile(n,i))||void 0===r?void 0:r.findCorner((0,Bf.$v)(n),(function(e){return e.isLoaded}));(0,Bf.Fp)(!a||jv(t,a,n)),(null===a||void 0===a?void 0:a.isLoaded)&&e(a,n)}))}},{key:"getNeighborLIJ",value:function(e,t){var n=(0,Bf.Mw)(t)?-1:(0,Bf.uv)(t)?1:0,i=(0,Bf.OD)(t)?-1:(0,Bf.Eu)(t)?1:0,r=[e[0],e[1]+n,e[2]+i];return r[1]<0?null:this.surface.isGlobal?this.wrapLIJ(r):r[2]<0?null:r}},{key:"wrapLIJ",value:function(e){return!e||e[1]<0||e[1]>=Math.pow(2,e[0])?null:this.surface.wrapEastWest(e)}},{key:"westNeighborWestExtent",get:function(){return this.extent[0]*(this.isWestEnd?-1:1)}},{key:"eastNeighborEastExtent",get:function(){return this.extent[2]*(this.isEastEnd?-1:1)}},{key:"isEastEnd",get:function(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}},{key:"isWestEnd",get:function(){return 0===this._lij[2]}},{key:"isNorthEnd",get:function(){return 0===this._lij[1]}},{key:"isSouthEnd",get:function(){var e,t=this.surface.extent,n=null!==(e=null===t||void 0===t?void 0:t[1])&&void 0!==e?e:null;return null!=n&&this.extent[1]+(0,Tv.bn)()>=n}},{key:"checkGeometryWaterproofness",value:function(){var e;Bf.V0&&((0,Bf.Fp)(this.isLoaded),null===(e=this.renderData)||void 0===e||e.checkGeometryWaterproofness())}},{key:"shouldHaveNeighbor",value:function(e){var t=this.extent,n=this.surface.rootTilesExtent,i=.25*(t[2]-t[0]);if((0,Bf.Mw)(e)&&t[3]+i>=n[3])return!1;if((0,Bf.uv)(e)&&t[1]-i<=n[1])return!1;var r=this.surface.isGlobal;return!(!r&&(0,Bf.OD)(e)&&t[0]-i<=n[0])&&!(!r&&(0,Bf.Eu)(e)&&t[2]+i>=n[2])}},{key:"updateDistanceToPOI",value:function(e){var t=this._lastPOI;if(!(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])){(0,et.c)(this._lastPOI,e);var n=this._center[Fv.MIDDLE],i=e[0]-n[0],r=e[1]-n[1],a=e[2]-n[2];this.distanceToPOI=i*i+r*r+a*a}}},{key:"test",get:function(){return{cachedMemory:this._cachedMemory}}}],[{key:"prune",value:function(){Vv.prune(0),zv.prune(0),Zv.prune()}}]),e}();function Uv(e,t,n,i){var r=n===Wh.ELEVATION?zv.acquire():Vv.acquire();return r.init(e,t,n,i),r}function Hv(e){e.dispose(),function(e){return"elevation"===e.type}(e)?zv.release(e):function(e){return"map"===e.type}(e)&&Vv.release(e)}var Fv,Vv=new Iu.Z(Av),zv=new Iu.Z(Ev),qv=new Hf;function Bv(e,t){var n=e.lij,i=t[0]-n[0];return!(i<0)&&t[1]>>i===n[1]&&t[2]>>i===n[2]}function Gv(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function jv(e,t,n){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?Wv(e,t,n):Wv(t,e,(0,Bf.$v)(n)))}function Wv(e,t,n){(0,Bf.Fp)(e.level>=t.level);var i=(0,Bf._0)(n),r=(0,Bf.wt)(n),a=e.extent,o=t.extent,s=[i?a[0]:a[2],r?a[3]:a[1]],l=[i?o[2]:o[0],r?o[1]:o[3]],u=1e-5*(a[2]-a[0]),c=(0,Bf.Wq)(s[0],l[0],u)||e.surface.isGlobal&&(0,Bf.Wq)(s[0],-l[0],u),h=(0,Bf.Wq)(s[1],l[1],u);if(c&&h)return!0;if(e.level===t.level)return(0,Bf.Fp)(!1),!1;if(!c&&!h)return(0,Bf.Fp)(!1),!1;var d=c?Xv(o[1],o[3],a[1],a[3],u):Xv(o[0],o[2],a[0],a[2],u);return(0,Bf.Fp)(d),d}function Xv(e,t,n,i,r){return e-r<=n&&n<=i&&i<=t+r}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(Fv||(Fv={}));var Qv=(0,U.Ue)(),Yv=(0,U.Ue)(),Jv=(0,U.Ue)(),Kv=(0,U.Ue)(),$v=function(){function e(){(0,o.Z)(this,e),this._scales=(0,st.al)(-1,-1,-1,-1),this._offsets=(0,st.al)(-1,-1,-1,-1)}return(0,s.Z)(e,[{key:"clear",value:function(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}},{key:"setScale",value:function(e,t,n){this._scales[2*e]=t,this._scales[2*e+1]=n}},{key:"setOffset",value:function(e,t,n){this._offsets[2*e]=t,this._offsets[2*e+1]=n}},{key:"scales",get:function(){return this._scales}},{key:"offsets",get:function(){return this._offsets}}]),e}(),ep=n(37081),tp=n(89438),np=n(50411),ip=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).useStencil=!1,e}return(0,s.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.spherical=e.viewingMode===he.JY.Global}},{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),rp)}},{key:"initializePipeline",value:function(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}},{key:"_createPipeline",value:function(e){var t=this.configuration,n=t.backfaceCullingEnabled&&!t.renderOccluded;return(0,mt.sm)({blending:t.renderOccluded?(0,mt.if)(_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA):null,culling:n?mt.Rd:null,depthTest:t.renderOccluded?null:{func:_t.wb.LESS},depthWrite:t.renderOccluded?null:mt.LZ,colorWrite:mt.BK,stencilTest:e?(0,np.iV)(Kf.hU.IntegratedMeshMaskExcluded):null,drawBuffers:t.output===ep.H_.Depth?{buffers:[_t.Xg.NONE]}:null})}},{key:"getPipeline",value:function(){return this.useStencil?this._stencilPipelineState:(0,u.Z)((0,c.Z)(n.prototype),"getPipeline",this).call(this)}}]),n}(ft.A);ip.shader=new dt.J(tp.a,(function(){return n.e(28268).then(n.bind(n,28268))}));var rp=new Map([[wn.T.POSITION,0],[wn.T.UV0,1],[wn.T.NORMALCOMPRESSED,2]]),ap=function(){function e(){var t=this;(0,o.Z)(this,e),this.geometry=new mv,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureRef=new Cv((function(){return t.tile.surface.fadeDuration})),this.overlay=new $v,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}return(0,s.Z)(e,[{key:"tile",get:function(){return this._tile}},{key:"localOrigin",get:function(){return this._localOrigin}},{key:"init",value:function(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new wv,this._localOrigin=t,this.overlay.clear()}},{key:"clear",value:function(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}},{key:"updateGeometryIfNeeded",value:function(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),Bf.T9&&this.tile.intersectsClippingArea)for(var t=0;t<4;++t)(0,Bf.Fp)(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}},{key:"_calculateEdgeResolution",value:function(e,t){var n,i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){var a=i.surface.extent;if(null!=a&&(0===e&&i.extent[3]>a[3]||1===e&&i.extent[2]>a[2]||2===e&&i.extent[1]<a[1]||3===e&&i.extent[0]<a[0]))return r}var o=i.level,s=Bf.OC[e];if(!t)return(0,Bf.Fp)(null==(null===(n=i.surface)||void 0===n?void 0:n.rootTiles)||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(s)),r;if(t.isLoaded){var l=t,u=l.renderData.geometryState,c=o-l.level;if((0,Bf.Fp)(c>=0),0===c){var h=u.numVerticesPerSide-1;return Math.max(h,r)}var d=Math.pow(2,c),f=u.edgeResolutions[(e+2)%4]/d;return Math.max(1,f)}(0,Bf.Fp)(!t.isLeaf);var v=r;return t.forAllSubtreeOnSide((0,Bf._F)(s),(function(e){return e===i||(e.isLoaded?(v=Math.max(v,Math.pow(2,e.level-o)),!0):((0,Bf.Fp)(!e.isLeaf),!1))})),v}},{key:"updateNeighborData",value:function(){var e=this,t=this.tile;if(t.intersectsClippingArea){for(var n=t.renderData.geometryState,i=function(e){return(e.isLoaded||e.level===t.level)&&(null===e||void 0===e?void 0:e.intersectsClippingArea)},r=n.edgePeerNeighbors,a=n.edgePeerNeighborSamplerVersions,o=0;o<4;++o){var s,l,u=t.findNeighborTile(Bf.OC[o],i),c=vp(t,u),h=null!==(s=null===c||void 0===c||null===(l=c.renderData)||void 0===l?void 0:l.geometryState.samplerDataVersion)&&void 0!==s?s:-1,d=r[o],f=c!==vp(t,d),v=a[o]!==h;Bf.T9&&u&&((0,Bf.Fp)(t.level>=u.level),(0,Bf.Fp)(t.level-u.level<=ie.qC)),r[o]=u,(f||v)&&(a[o]=h,this._markEdgeDirty(o));var p=n.edgeResolutions[o],_=this._calculateEdgeResolution(o,u);(0,Bf.Fp)((0,Se.wt)(_)),(0,Bf.Fp)(_>=1),n.edgeResolutions[o]=_,p!==_&&this._markEdgeResolutionDirty(o)}for(var m=function(a){var o=t.findNeighborTile(Bf.cA[a],i);n.cornerPeerNeighbors[a]=o;var s=vp(t,r[a]),l=vp(t,r[(a+1)%4]),u=vp(t,o);fp[a]=u,fp[(a+1)%4]=l,fp[(a+2)%4]=t,fp[(a+3)%4]=s,(0,Bf.Fp)(fp.some((function(e){return(null===e||void 0===e?void 0:e.isLoaded)||e===t})));var c=fp.reduce((function(e,t){var n;return Math.min(e,null!==(n=null===t||void 0===t?void 0:t.level)&&void 0!==n?n:1/0)}),1/0);fp.forEach((function(e,t){e&&(null===e||void 0===e?void 0:e.level)>c&&(fp[t]=null)})),(0,Bf.Fp)(fp.some((function(e){return(null===e||void 0===e?void 0:e.isLoaded)||e===t})));for(var h=n.cornerNeighborCornerTiles,d=n.cornerNeighborCornerTileSamplerVersions,f=0;f<4;++f){var v,p=fp[f],_=null!==(v=null===p||void 0===p?void 0:p.renderData.geometryState.samplerDataVersion)&&void 0!==v?v:-1,m=4*a+f,g=h[m]!==p,y=!g&&d[m]!==_;(g||y)&&(h[m]=p,d[m]=_,e._markCornerDirty(a))}Bf.T9&&(0,Bf.Fp)(Cp.some((function(e){var n;return(null===(n=h[4*a+e])||void 0===n?void 0:n.isLoaded)||h[4*a+e]===t})))},g=0;g<4;++g)m(g);Bf.T9&&(0,Bf.Fp)(this.geometryState.edgeResolutions.every((function(e){return e>0})));for(var y=0;y<4;++y)fp[y]=null}}},{key:"_updateGeometry",value:function(e){var t;if(this.tile.intersectsClippingArea){Bf.T9&&(0,Bf.Fp)(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every((function(e){return e>0}))),this.intersectionData=null;var n=this.tile,i=this._vao,r=this.geometry,a=this.geometryState,o=!i||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,s=0!==this.dirtyEdgeResolutions,l=a.edgeResolutions.reduce((function(e,t){return e+t+1}),0),u=o||s&&l>(null!==(t=null===r||void 0===r?void 0:r.maxEdgeVertexCount)&&void 0!==t?t:0),c=!u&&s,h=!c&&(0!==this.dirtyEdges||s),d=!h&&0!==this.dirtyCorners;u?(this.releaseGeometry(),this._createGeometry(e)):c?n.updateEdgeElevationsAndResolutions():h||d?n.updateEdgeElevations():d?n.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}}},{key:"hasGeometry",get:function(){return this._hasGeometry}},{key:"releaseGeometry",value:function(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=(0,x.M2)(this._vao),this.geometry.release(),!0)}},{key:"ensureTexture",value:function(e,t,n){var i=t?_t.VI.RGBA:_t.VI.RGB;return null==this._texture||this._texture.descriptor.width===e&&this._texture.descriptor.pixelFormat===i||this.releaseTexture(),null==this._texture&&(this._texture=n(),this.tile.setMemoryDirty()),this._texture}},{key:"releaseTexture",value:function(){null!=this._texture&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}},{key:"numVerticesPerSideChanged",get:function(){return!!(this._modifiedFlags&pp)}},{key:"samplerDataChanged",get:function(){return!!(this._modifiedFlags&_p)}},{key:"clippingAreaChanged",get:function(){return!!(this._modifiedFlags&mp)}},{key:"wireframeChanged",get:function(){return!!(this._modifiedFlags&gp)}},{key:"dirtyEdges",get:function(){return this._modifiedFlags>>yp&15}},{key:"dirtyCorners",get:function(){return this._modifiedFlags>>bp&15}},{key:"dirtyEdgeResolutions",get:function(){return this._modifiedFlags>>wp&15}},{key:"_markCornerDirty",value:function(e){var t=1<<e<<bp;this._modifiedFlags|=t}},{key:"_markEdgeDirty",value:function(e){var t=1<<e<<yp;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}},{key:"_markEdgeResolutionDirty",value:function(e){var t=1<<e<<wp;this._modifiedFlags|=t,this._markEdgeDirty(e)}},{key:"_markAllEdgesAndCornersDirty",value:function(){this._modifiedFlags|=15<<bp|15<<yp|15<<wp}},{key:"updateGeometryState",value:function(){var e=this._getElevationInfo(),t=this.tile,n=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),i=Math.max(n,5),r=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(r=null);var a=this.geometryState,o=!1;a.numVerticesPerSide!==i&&(this._modifiedFlags|=1,a.numVerticesPerSide=i,a.samplerDataVersion++,o=!0),e.changed&&(this._modifiedFlags|=2,a.samplerData=e.samplerData,a.samplerDataVersion++,o=!0),(0,gd.fS)(a.clippingArea,r)||(this._modifiedFlags=4,a.clippingArea=r,o=!0);var s=t.surface.wireframe;return a.wireframe!==s&&(this._modifiedFlags=8,a.wireframe=s,o=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=o),o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}},{key:"_createGeometry",value:function(e){this.tile.createGeometry();var t=this.geometry.vertexAttributes,n=this.geometry.indices,i=e.gl;this._vao=new bn.U(e,rp,{geometry:(0,mn.K)(t.layout)},{geometry:Cn.f.createVertex(e,i.STATIC_DRAW,t.buffer)},Cn.f.createIndex(e,i.STATIC_DRAW,n)),this._hasGeometry=!0}},{key:"vao",get:function(){return this._vao}},{key:"setTextureReference",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:yv.Immediate;null!=e&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}},{key:"textureReference",get:function(){return this._textureRef.current}},{key:"nextTextureReference",get:function(){return this._textureRef.next}},{key:"textureFadeFactor",get:function(){return this._textureRef.fadeFactor}},{key:"textureIsFading",get:function(){return this._textureRef.isFading}},{key:"_getElevationInfo",value:function(){for(var e=this.geometryState.samplerData,t=this.tile.layerInfo[Wh.ELEVATION],n=t.length,i=new Array(n),r=0,a=0,o=!1,s=0;s<n;s++){var l=t[s];if(null!=l.upsampleInfo){var u=l.upsampleInfo.tile,c=u.layerInfo[Wh.ELEVATION][s].data,h=c&&c.samplerData;e&&e[r]===h||(o=!0),i[r++]=h,a=Math.max(a,u.lij[0])}else if(l.data){var d=this.tile.surface.layerViewByIndex(s,Wh.ELEVATION);if((0,Sv.yf)(this.tile,d.layer,!1)){var f=l.data;e&&e[r]===f.samplerData||(o=!0),i[r++]=f.samplerData,a=this.tile.level}}}null!=e&&e.length!==r&&(o=!0);var v=r>0,p=v?i:null;return v&&(i.length=r),{changed:o,samplerData:p,maxTileLevel:a}}},{key:"estimatedGeometryMemoryUsage",get:function(){var e,t,n,i,r,a,o=null!==(e=null===(t=this.intersectionData)||void 0===t?void 0:t.estimatedMemoryUsage)&&void 0!==e?e:0;return(null!==(n=null===(i=this.geometry.indices)||void 0===i?void 0:i.byteLength)&&void 0!==n?n:0)+(null!==(r=null===(a=this.geometry.vertexAttributes)||void 0===a?void 0:a.byteLength)&&void 0!==r?r:0)+o}},{key:"texture",get:function(){return this._texture}},{key:"test",get:function(){}},{key:"checkGeometryWaterproofness",value:function(){var e=this;if(Bf.T9){var t=this.tile;if(t.isLoaded&&t.intersectsClippingArea&&0!==t.level){var n=t.surface.extent;if(null==n||t.intersectsExtent(n)){var i=Bf.OC.map((function(e,i){return null!=n&&(i<2?-1:1)*(t.extent[3-i]-n[3-i])<0})),r=t.level;(0,Bf.Fp)(0===this.dirtyCorners),(0,Bf.Fp)(0===this.dirtyEdges),(0,Bf.Fp)(0===this.dirtyEdgeResolutions),(0,Bf.Fp)(!this.numVerticesPerSideChanged),(0,Bf.Fp)(!this.samplerDataChanged),(0,Bf.Fp)(!this.clippingAreaChanged),(0,Bf.Fp)(!this.wireframeChanged);for(var a=Bf.cA.map((function(e){var n;return null!==(n=t.findNeighborCornerTileExact(e,(function(e){return!e.intersectsClippingArea||e.isLoaded||e.level===t.level})))&&void 0!==n?n:null})).map((function(e){return null!==e&&void 0!==e&&e.intersectsClippingArea?e:null})),o=this.geometryState,s=0;s<4;++s){var l=o.cornerPeerNeighbors[s],u=a[s];(0,Bf.Fp)(u===l,"Tile[".concat(t.lij,"].corner[").concat(s,"] out of date: cur=[").concat(null===l||void 0===l?void 0:l.lij,"] exp=[").concat(null===u||void 0===u?void 0:u.lij,"]"))}Bf.OC.forEach((function(n,a){if(!i[a]){var o=t.findNeighborTile(n,(function(e){return(e.level===r||(null===e||void 0===e?void 0:e.isLoaded))&&(null===e||void 0===e?void 0:e.intersectsClippingArea)}));if(o){(0,Bf.Fp)(o.isLoaded||o.level===t.level),(0,Bf.Fp)(o===e.geometryState.edgePeerNeighbors[a]);var s=r-o.level;if(!o.isLoaded)return(0,Bf.Fp)(!o.isLeaf),void(0,Bf.Fp)(0===s);var l=o.renderData;(0,Bf.Fp)(function(e,t,n){if(null==e||null==t)return!1;if(0===e.level&&0===t.level){if(e.isEastEnd&&t.isWestEnd&&n===pv.X.EAST)return!0;if(e.isWestEnd&&t.isEastEnd&&n===pv.X.WEST)return!0}var i=Math.max(1e-6*(e.extent[2]-e.extent[0]),1);switch(n){case pv.X.NORTH:return(0,Bf.Wq)(e.extent[3],t.extent[1],i);case pv.X.SOUTH:return(0,Bf.Wq)(e.extent[1],t.extent[3],i);case pv.X.EAST:return(0,Bf.Wq)(e.extent[2],t.extent[0],i)||(0,Bf.Wq)(e.extent[2],-t.extent[0],i);case pv.X.WEST:return(0,Bf.Wq)(e.extent[0],t.extent[2],i)||(0,Bf.Wq)(e.extent[0],-t.extent[2],i)}}(t,o,n)),(0,Bf.Fp)(s>=0);var u=Math.pow(2,s);if(s<0)(0,Bf.Fp)(!1);else{var c=t.renderData,h=c.geometry,d=c.localOrigin,f=h.getEdgeCount(a),v=h.numVerticesPerSide-1,p=l.geometry;if(p){var _=l.localOrigin,m=e.geometryState.edgePeerNeighbors[a];if(null!==m&&void 0!==m&&m.isLoaded){var g=m.renderData;(0,Bf.Fp)(c.geometryState.edgePeerNeighborSamplerVersions[a]===g.geometryState.samplerDataVersion),(0,Bf.Fp)(e.geometryState.edgePeerNeighborSamplerVersions[a]===g.geometryState.samplerDataVersion)}var y=(a+2)%4,b=p.getEdgeCount(y),w=f-1,C=b-1;(0,Bf.Fp)(w*u===C,"Tile[".concat(t.lij,"]:e").concat(a,",res=").concat(w," edgeRes mismatch with Neighbor[").concat(o.lij,"]:e").concat(y,",res=").concat(C," (expected:").concat(w*u,")"));var x=t.extent,T=n===pv.X.NORTH||n===pv.X.SOUTH,S=b-1,k=S>>s,M=f-1;if(k<1)(0,Bf.Fp)(1===M);else{(0,Bf.Fp)(k===M),(0,Bf.Fp)((0,Se.wt)(k));var P=p.numVerticesPerSide-1;(0,Bf.Fp)(s>0||k===Math.max(P,v));var R=t.getNeighborEdgeStartVertexIndex(a,o);(0,Bf.Fp)(0<=R&&R<u);var E=R*k;(0,Bf.Fp)(0<=E&&E<=S-k);var O=0,A=E;h.getEdgeVertexPosition(a,op,d,0),h.getEdgeVertexPosition(a,sp,d,f-1);for(var D=(0,et.p)(op,sp),Z=Math.max(dp,1e-4*D),I=0;I<=k;++I){h.getEdgeVertexPosition(a,op,d,O),p.getEdgeVertexPosition(y,sp,_,A);var L=I/k,N=T?x[0]+L*(x[2]-x[0]):n===pv.X.WEST?x[0]:x[2],H=T?n===pv.X.SOUTH?x[1]:x[3]:x[1]+L*(x[3]-x[1]),F=t.surface.extent;(null==F||(0,B.jE)(F,N,H))&&function(){var e=(0,et.F)(op,sp),n=(0,et.H)(op)-ke.sv.radius,i=(0,et.H)(sp)-ke.sv.radius,r=e<Z;if(!r){console.warn("Tile edge vertex position mismatch: between [".concat(t.lij,"].edge").concat(a,"[").concat(O,"/").concat(f,"] and [").concat(o.lij,"].edge").concat(y,"[").concat(A,"/").concat(b,"]")),null!=F&&console.warn("  surface extent= ",F," x,y=",N,",",H);var s=(0,U.Ue)();(0,et.f)(s,c.localOrigin,l.localOrigin),(0,et.H)(s)>0&&console.warn("   localOrigins: ".concat(c.localOrigin," vs ").concat(l.localOrigin," d=").concat((0,et.H)(s)," [").concat(s,"]")),function(){var e=(0,U.d9)(op),n=(0,U.d9)(sp);t.updateEdgeElevations(),o.updateEdgeElevations(),h.getEdgeVertexPosition(a,op,d,O),p.getEdgeVertexPosition(y,sp,_,A);var i=(0,U.Ue)();(0,et.z)(i,op,e),(0,et.H)(i)>0&&console.warn("  XXX Tile[".concat(t.lij,"] edge out of date: ").concat(e," vs ").concat(op," d=").concat((0,et.H)(i)," [").concat(i,"]")),(0,et.z)(i,sp,n),(0,et.H)(i)>0&&console.warn("  XXX Neighbor[".concat(o.lij,"] edge out of date: ").concat(n," vs ").concat(sp," d=").concat((0,et.H)(i)," [").concat(i,"]"))}();var u=h.getEdgeCount(a),v=p.getEdgeCount(b);(0,Bf.Fp)(r,"Mismatch in tile [".concat(t.lij,"].edge[").concat(a,"][").concat(O,"/").concat(u,"] vs neighbor [").concat(o.lij,"].edge[").concat(y,"][").concat(A,"/").concat(v,"] ").concat((0,Bf.zT)(op)," vs ").concat((0,Bf.zT)(sp),"  dist=").concat(e," h(t|n|d)=").concat(n,"|").concat(i,"|").concat(i-n))}h.getEdgeNormal(a,lp,O),p.getEdgeNormal(y,up,A),(0,et.n)(cp,lp),(0,et.n)(hp,up);var m=(0,et.m)(cp,hp),g=1-m<.01||t===o;if(!g){var w=(0,U.Ue)();(0,et.z)(w,lp,up);var C=function(){return"Mismatch in tile edge normal ".concat((0,Bf.sP)(t.lij)," (").concat(O,"/").concat(f-1,") edge ").concat(a," vs neighbor ").concat((0,Bf.sP)(o.lij),"  (").concat(A,"/").concat(b-1,") nedge ").concat(y," :").concat((0,Bf.zT)(lp)," vs ").concat((0,Bf.zT)(up),"  dot = ").concat(m," : ").concat((0,Bf.zT)(w))};console.warn("Mismatch in tile edge normal: ",C()),t.updateEdgeElevations(),o.updateEdgeElevations();var x=(0,U.Ue)(),T=(0,U.Ue)();h.getEdgeNormal(a,x,O),p.getEdgeNormal(y,T,A),(0,et.G)(lp,x)||console.warn("Missing update in tile normal: ",(0,Bf.zT)(lp)," => ",(0,Bf.zT)(x)),(0,et.G)(up,T)||console.warn("Missing update in neighbor normal: ",(0,Bf.zT)(up)," => ",(0,Bf.zT)(T)),(0,Bf.Fp)(g,C())}}(),O+=1,A+=1}}}else(0,Bf.Fp)(!1)}}else{var V=!t.surface.updatingRootTiles&&null!=t.surface.rootTiles&&t.surface.rootTiles.length>0&&t.shouldHaveNeighbor(n);(0,Bf.Fp)(!V)}}}))}}else(0,Bf.Fp)(null===t||void 0===t?void 0:t.isLoaded)}}}]),e}(),op=(0,U.Ue)(),sp=(0,U.Ue)(),lp=(0,U.Ue)(),up=(0,U.Ue)(),cp=(0,U.Ue)(),hp=(0,U.Ue)(),dp=1,fp=[null,null,null,null];function vp(e,t){return null!==t&&void 0!==t&&t.isLoaded||t===e?t:null}var pp=1,_p=2,mp=4,gp=8,yp=4,bp=8,wp=12,Cp=[0,1,2,3];function xp(e,t){var n=e.tile,i=e.geometry,r=e.geometryState,a=n.extentInRadians,o=n.surface,s=o.isWebMercator,l=o.renderer,u=r.numVerticesPerSide,c=r.wireframe,h=u-1,d=Math.pow(u-2,2),f=s&&(t===Qf.tk.HAS_SOUTH_POLE||t===Qf.tk.HAS_BOTH_POLES),v=s&&(t===Qf.tk.HAS_NORTH_POLE||t===Qf.tk.HAS_BOTH_POLES),p=((f?1:0)+(v?1:0))*n_*u,_=$p(r),m=d+p+4*_,g=l.tileGeometryCache.acquire(m);i.numVerticesPerSide=u,i.vertexAttributes=g,i.maxEdgeVertexCount=_;var y=i.boundingBox;(0,vv.cS)(y);var b=Pp(e);jp.update(h,a,b),function(e){var t=e.tile;if(!t.intersectsClippingArea)return;var n=e.geometry,i=e.geometryState,r=e.localOrigin,a=i.numVerticesPerSide,o=i.samplerData,s=a-2,l=a-1,u=n.vertexAttributes,c=n.boundingBox,h=u.position,d=u.uv0,f=u.normalCompressed,v=f.typedBuffer,p=f.typedBufferStride,_=t.extent,m=_[0],g=_[2],y=_[1],b=_[3],w=t.ellipsoid.radius,C=r[0],x=r[1],T=r[2],S=h.typedBuffer,k=h.typedBufferStride,M=1/l,P=0;if(1<=s)for(var R=M,E=y*(1-R)+b*R,O=jp.sinLatLUT[1],A=jp.cosLatLUT[1],D=1;D<=s;D++){var Z=D*M,I=m*(1-Z)+g*Z,L=jp.sinLonLUT[D],N=jp.cosLonLUT[D],U=w+qf(I,E,o),H=U*N*A-C,F=U*L*A-x,V=U*O-T;Kp(H,F,V,c);var z=(D-1)*k;S[z]=H,S[z+1]=F,S[z+2]=V,gv(d,D-1,Z,R)}for(var q=1;q<=s;q++)for(var B=q*M,G=y*(1-B)+b*B,j=jp.sinLatLUT[q],W=jp.cosLatLUT[q],X=q+1,Q=X*M,Y=y*(1-Q)+b*Q,J=jp.sinLatLUT[X],K=jp.cosLatLUT[X],$=jp.sinLonLUT[0],ee=jp.cosLonLUT[0],te=w+qf(m,G,o),ne=ee*W*te-C,ie=$*W*te-x,re=j*te-T,ae=P*k,oe=S[ae],se=S[ae+1],le=S[ae+2],ue=1;ue<=s;ue++){var ce=ue*M,he=m*(1-ce)+g*ce,de=jp.sinLonLUT[ue],fe=jp.cosLonLUT[ue],ve=0,pe=0,_e=0;if(ue<s){var me=(P+1)*k;ve=S[me],pe=S[me+1],_e=S[me+2]}else{var ge=jp.sinLonLUT[l],ye=jp.cosLonLUT[l],be=w+qf(g,G,o);ve=ye*W*be-C,pe=ge*W*be-x,_e=j*be-T}var we=ne,Ce=ie,xe=re;ne=oe,ie=se,re=le,oe=ve,se=pe,le=_e;var Te=ve-we,Se=pe-Ce,ke=_e-xe,Me=0,Pe=0,Re=0;if(q>1){var Ee=(P-s)*k;Me=S[Ee],Pe=S[Ee+1],Re=S[Ee+2]}else{var Oe=jp.sinLatLUT[0],Ae=jp.cosLatLUT[0],De=w+qf(he,y,o);Me=fe*Ae*De-C,Pe=de*Ae*De-x,Re=Oe*De-T}var Ze=w+qf(he,Y,o),Ie=fe*K*Ze-C,Le=de*K*Ze-x,Ne=J*Ze-T;if(q<s){var Ue=P+s,He=Ue*k;S[He]=Ie,S[He+1]=Le,S[He+2]=Ne,Kp(Ie,Le,Ne,c),gv(d,Ue,ce,Q)}var Fe=Me-Ie,Ve=Pe-Le,ze=Re-Ne,qe=fe*W,Be=de*W,Ge=j;Ge*Ge<.999&&(qe=ke*Ve-Se*ze,Be=Te*ze-ke*Fe,Ge=Se*Fe-Te*Ve);var je=1/Math.sqrt(qe*qe+Be*Be+Ge*Ge);(0,_v.hd)(v,P,qe*je,Be*je,Ge*je,p),++P}}(e),i.poleVerticesStartIndex=d;var w=function(e,t,n){var i=e.tile,r=e.localOrigin,a=e.geometry,o=i.extent,s=i.ellipsoid,l=a.boundingBox,u=a.numVerticesPerSide,c=a.vertexAttributes,h=a.poleVerticesStartIndex,d=u-1,f=r[0],v=r[1],p=r[2],_=s.radius,m=o[1],g=o[3],y=[],b=h,w=function(e,t){var n=t*u;Kp(-f,-v,e*_-p,l),y.push(new Bp(1===e,n,1===e?0:2,b,n_));for(var i=Mp(-1===e?m:g,_),r=e*Math.PI/2-i,a=.99*(1===e?1:-1),o=_+0,s=c.position,h=c.uv0,w=c.normalCompressed,C=w.typedBuffer,x=w.typedBufferStride,T=1;T<=n_;++T)for(var S=i+r*(T/n_),k=Math.cos(S),M=Math.sin(S),P=0;P<=d;P++){var R=P/d,E=jp.sinLonLUT[P],O=jp.cosLonLUT[P]*k,A=E*k,D=M,Z=O*o-f,I=A*o-v,L=D*o-p;Kp(Z,I,L,l),s.setValues(b,Z,I,L),gv(h,b,R,a),(0,_v.hd)(C,b,O,A,D,x),++b}};return t&&w(-1,0),n&&w(1,d),y}(e,f,v);i.edgeVerticesStartIndex=d+p,Np(e),Tp(e),Zp(i,w,c),e.intersectionData=null}function Tp(e){e.tile.intersectsClippingArea&&(kp(e),Sp(e))}function Sp(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e.geometry,i=e.geometryState,r=e.tile,a=e.localOrigin,o=r.level,s=r.extent,l=r.extentInRadians,u=r.ellipsoid,c=u.radius,h=l[0],d=l[2],f=l[1],v=l[3],p=i.samplerData,_=s[0],m=s[2],g=s[1],y=s[3],b=Pp(e),w=n.boundingBox,C=n.vertexAttributes,x=a[0],T=a[1],S=a[2],k=C.position,M=k.typedBuffer,P=k.typedBufferStride,R=C.uv0,E=function(a){var l=1===a||3===a,u=i.edgeResolutions[a];(0,Bf.Fp)((0,Se.wt)(u));var C=u+1,k=vp(r,i.edgePeerNeighbors[a]);if(Qp(r,k,a))return Hp(e,a,k),"continue";var E=null!=k;(0,Bf.Fp)(!E||k.level===r.level),(0,Bf.Fp)(!E||(0,Sv.gl)(r,k)<=0);var O=null===k||void 0===k?void 0:k.renderData,A=null===O||void 0===O?void 0:O.geometryState;if(Bf.T9){var D=r.surface;if(!k&&D&&!D.updatingRootTiles){var Z=Bf.OC[a],I=r.findNeighborTile(Z,(function(e){return e.isLoaded||e.isLeaf||e.level===r.level}));I?I.intersectsClippingArea&&((0,Bf.Fp)(!I.isLoaded),(0,Bf.Fp)(!I.isLeaf),(0,Bf.Fp)(I.level===o)):(0,Bf.Fp)(null==(null===D||void 0===D?void 0:D.rootTiles)||!r.shouldHaveNeighbor(Z))}}var L=1===a?s[2]:s[0],N=null===k||void 0===k?void 0:k.extent,U=N&&l?1===a?N[0]:N[2]:L,H=0===a?s[3]:s[1],F=1===a?1:0,V=0===a?1:0,z=1===a?d:h,q=0===a?v:f,B=Math.sin(z),G=Math.cos(z),j=Math.sin(q),W=Math.cos(q),X=null===A||void 0===A?void 0:A.samplerData,Q=E?function(e,t,n){return.5*(qf(e,t,p)+qf(n,t,X))}:function(e,t,n){return qf(e,t,p)},Y=n.outerEdgesOffsetAndLength[2*a+0],J=t&&C>3?C-3:1,K=null!=p&&p.some((function(e){return null!=e})),$=null!=X&&X.some((function(e){return null!=e})),ee=K||$,te=1/u,ne=Y;(0,Bf.Fp)(!N||(0,Bf.Wq)(N[2]-N[0],s[2]-s[0])),function(){var e=1===a?-1:3===a?1:0,t=0===a?-1:2===a?1:0,i=(s[2]-s[0])*te,r=e*i,o=t*i,u=l?e*((d-h)*te):0,f=l?0:t*te,v=V,k=l?z+u:z,O=l?Math.sin(k):B,A=l?Math.cos(k):G,D=l?z-u:z,Z=l?Math.sin(D):B,I=l?Math.cos(D):G,N=l?q:b(v+f),Y=l?j:Math.sin(N),K=l?W:Math.cos(N),$=l?q:b(v-f),ie=l?j:Math.sin($),re=l?W:Math.cos($),ae=0,oe=0,se=0,le=0*te,ue=l?L:_*(1-le)+m*le,ce=l?U:ue,he=l?g*(1-le)+y*le:H,de=l?z:h*(1-le)+d*le,fe=l?B:Math.sin(de),ve=l?G:Math.cos(de),pe=l?b(le):q,_e=l?Math.sin(pe):j,me=l?Math.cos(pe):W,ge=c+Q(ue,he,ce);ae=ve*me*ge,oe=fe*me*ge,se=_e*ge;var ye=0,be=0,we=0,Ce=1*te,xe=l?L:_*(1-Ce)+m*Ce,Te=l?U:xe,Se=l?g*(1-Ce)+y*Ce:H,ke=l?z:h*(1-Ce)+d*Ce,Me=l?B:Math.sin(ke),Pe=l?G:Math.cos(ke),Re=l?b(Ce):q,Ee=l?Math.sin(Re):j,Oe=l?Math.cos(Re):W,Ae=c+Q(xe,Se,Te);ye=Pe*Oe*Ae,be=Me*Oe*Ae,we=Ee*Ae;for(var De=1;De<C-1;De+=J){var Ze=(De+1)*te,Ie=l?L:_*(1-Ze)+m*Ze,Le=l?U:Ie,Ne=l?g*(1-Ze)+y*Ze:H,Ue=l?z:h*(1-Ze)+d*Ze,He=l?B:Math.sin(Ue),Fe=l?G:Math.cos(Ue),Ve=l?b(Ze):q,ze=l?Math.sin(Ve):j,qe=l?Math.cos(Ve):W,Be=c+Q(Ie,Ne,Le),Ge=Fe*qe*Be,je=He*qe*Be,We=ze*Be,Xe=ye,Qe=be,Ye=we;ye=Ge,be=je,we=We;var Je=ne+De,Ke=Je*P,$e=Xe-x,et=Qe-T,tt=Ye-S;M[Ke]=$e,M[Ke+1]=et,M[Ke+2]=tt,Kp($e,et,tt,w);var nt=De*te;gv(R,Je,l?F:nt,l?nt:V);var it=ae,rt=oe,at=se;ae=Xe,oe=Qe,se=Ye;var ot=Xe,st=Qe,lt=Ye,ut=1/Math.sqrt(ot*ot+st*st+lt*lt),ct=lt*ut,ht=0,dt=0,ft=0;if(ee&&ct*ct<.999){var vt,pt,_t,mt=0===a?-1:1;vt=mt*(Ge-it),pt=mt*(je-rt),_t=mt*(We-at);var gt=De*te,yt=l?L:_*(1-gt)+m*gt,bt=l?U:yt,wt=l?g*(1-gt)+y*gt:H,Ct=l?z:h*(1-gt)+d*gt,xt=l?B:Math.sin(Ct),Tt=l?G:Math.cos(Ct),St=l?b(gt):q,kt=l?Math.sin(St):j,Mt=l?Math.cos(St):W,Pt=ot,Rt=st,Et=lt;if(E){var Ot=c+qf(bt-r,wt-o,X),At=l?Mt:re;Pt=(l?I:Tt)*At*Ot,Rt=(l?Z:xt)*At*Ot,Et=(l?kt:ie)*Ot}var Dt=c+qf(yt+r,wt+o,p),Zt=l?Mt:K,It=(l?A:Tt)*Zt*Dt,Lt=(l?O:xt)*Zt*Dt,Nt=(l?kt:Y)*Dt;E||(Pt=2*ot-It,Rt=2*st-Lt,Et=2*lt-Nt);var Ut=3===a?-1:1,Ht=Ut*(Pt-It),Ft=Ut*(Rt-Lt),Vt=Ut*(Et-Nt);ht=_t*Ft-pt*Vt,dt=vt*Vt-_t*Ht,ft=pt*Ht-vt*Ft;var zt=1/Math.sqrt(ht*ht+dt*dt+ft*ft);ht*=zt,dt*=zt,ft*=zt}else ht=ot*ut,dt=st*ut,ft=lt*ut;n.setEdgeNormalFromValues(a,De,ht,dt,ft)}}()},O=0;O<4;++O)E(O)}function kp(e){Fp(e)}function Mp(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function Pp(e){var t=e.tile;if(t.surface.isWebMercator){var n=t.extent,i=t.ellipsoid.radius;return function(e){return function(e,t,n,i){return Mp(e*(1-i)+t*i,n)}(n[1],n[3],i,e)}}var r=t.extentInRadians;return function(e){return function(e,t,n){return e*(1-n)+t*n}(r[1],r[3],e)}}function Rp(e,t){var n=e.tile,i=e.geometryState,r=e.geometry,a=n.extent,o=n.surface,s=i.wireframe,l=a[0],u=a[1],c=a[2]-l,h=a[3]-u,d=i.numVerticesPerSide,f=i.clippingArea,v=null!=f?Math.max(0,(f[0]-l)/c):0,p=null!=f?Math.max(0,(f[1]-u)/h):0,_=null!=f?Math.min(1,(f[2]-l)/c):1,m=null!=f?Math.min(1,(f[3]-u)/h):1,g=Math.pow(d-2,2),y=$p(i),b=g+4*y,w=o.renderer.tileGeometryCache.acquire(b),C=r.boundingBox;(0,vv.cS)(C),r.numVerticesPerSide=d,r.vertexAttributes=w,r.maxEdgeVertexCount=y,r.minu=v,r.minv=p,r.maxu=_,r.maxv=m,function(e){var t=e.tile;if(!t.intersectsClippingArea)return;for(var n=e.geometry,i=e.geometryState,r=e.localOrigin,a=i.samplerData,o=i.clippingArea,s=i.numVerticesPerSide,l=t.surface,u=t.extent,c=t.ellipsoid,h=l.isWebMercatorOnPlateCarree,d=null!=o?o:Wp,f=u[0],v=u[1],p=u[2],_=u[3],m=Math.max(f,d[0]),g=Math.min(p,d[2]),y=Math.max(v,d[1]),b=Math.min(_,d[3]),w=c.radius,C=t.horizontalScale,x=s-1,T=s-2,S=n.minu,k=n.minv,M=n.maxu,P=n.maxv,R=n.boundingBox,E=n.vertexAttributes,O=E.position,A=E.uv0,D=E.normalCompressed,Z=D.typedBuffer,I=D.typedBufferStride,L=r[0],N=r[1],U=r[2],H=O.typedBuffer,F=O.typedBufferStride,V=0,z=(0,Se.uZ)(v,y,b),q=h?(Math.PI/2-2*Math.atan(Math.exp(-z/w)))*w:z*C,B=1/x,G=(0,Se.uZ)(v*(1-B)+_*B,y,b),j=q,W=h?(Math.PI/2-2*Math.atan(Math.exp(-G/w)))*w:G*C,X=1;X<=T;X++){var Q=X/x,Y=(0,Se.uZ)(v*(1-Q)+_*Q,y,b),J=(0,Se.uZ)(Q,k,P),K=W,$=(X-1)/x,ee=(0,Se.uZ)(v*(1-$)+_*$,y,b),te=j,ne=(X+1)/x,ie=(0,Se.uZ)(v*(1-ne)+_*ne,y,b),re=h?(Math.PI/2-2*Math.atan(Math.exp(-ie/w)))*w:ie*C,ae=(0,Se.uZ)(ne,k,P);j=W,W=re;var oe=(0,Se.uZ)(f,m,g),se=oe*C,le=qf(oe,Y,a),ue=1/x,ce=(0,Se.uZ)(ue,S,M),he=(0,Se.uZ)(f*(1-ce)+p*ce,m,g),de=ce,fe=he,ve=he*C,pe=qf(he,Y,a);if(1===X){var _e=ve-L,me=j-N,ge=pe-U,ye=0*F;H[ye]=_e,H[ye+1]=me,H[ye+2]=ge,Kp(_e,me,ge,R),gv(A,V,(0,Se.uZ)(ue,S,M),J)}for(var be=1;be<=T;be++){var we=ve,Ce=pe,xe=(be+1)/x,Te=(0,Se.uZ)(xe,S,M),ke=(0,Se.uZ)(f*(1-xe)+p*xe,m,g),Me=fe;fe=ke;var Pe=V+1,Re=Pe*F;if(1===X||be===T){var Ee=ke*C,Oe=qf(ke,Y,a);if(1===X&&be<T){var Ae=Ee-L,De=K-N,Ze=Oe-U;H[Re]=Ae,H[Re+1]=De,H[Re+2]=Ze,Kp(Ae,De,Ze,R),gv(A,Pe,Te,J)}ve=Ee,pe=Oe}else ve=H[Re]+L,pe=H[Re+2]+U;var Ie=ve,Le=pe,Ne=se,Ue=le;se=we,le=Ce;var He=(V-T)*F,Fe=1===X?qf(Me,ee,a):H[He+2]+U,Ve=qf(Me,ie,a);if(X<T){var ze=V+T,qe=ze*F,Be=we-L,Ge=re-N,je=Ve-U;H[qe]=Be,H[qe+1]=Ge,H[qe+2]=je,Kp(Be,Ge,je,R);var We=de;de=Te,gv(A,ze,We,ae)}var Xe=Ie-Ne,Qe=te-re,Ye=Qe*(Le-Ue),Je=Xe*(Fe-Ve),Ke=-Qe*Xe,$e=Ye*Ye+Je*Je+Ke*Ke;if(0===$e)(0,_v.hd)(Z,V,0,0,1,I);else{var et=1/Math.sqrt($e);(0,_v.hd)(Z,V,Ye*et,Je*et,Ke*et,I)}++V}}}(e),r.edgeVerticesStartIndex=g,Np(e),Ep(e),Zp(r,[],s),e.intersectionData=null}function Ep(e,t){e.tile.intersectsClippingArea&&(Ap(e),Op(e,!1))}function Op(e,t){for(var n=e.geometry,i=e.geometryState,r=e.localOrigin,a=e.tile,o=a.surface,s=a.extent,l=i.clippingArea,u=i.samplerData,c=null!=l?l:Wp,h=s[0],d=s[2],f=s[1],v=s[3],p=[v>c[3],d>c[2],f<c[1],h<c[0]],_=a.horizontalScale,m=Dp(o.isWebMercatorOnPlateCarree,a.ellipsoid.radius,_),g=n.minu,y=n.minv,b=n.maxu,w=n.maxv,C=n.boundingBox,x=Math.max(h,c[0]),T=Math.min(d,c[2]),S=Math.max(f,c[1]),k=Math.min(v,c[3]),M=r[0],P=r[1],R=r[2],E=function(r){var s=1===r||3===r,l=i.edgeResolutions[r];(0,Bf.Fp)((0,Se.wt)(l));var c=l+1,E=p[r],O=vp(a,i.edgePeerNeighbors[r]);if(!E&&Qp(a,O,r))return Hp(e,r,O),"continue";var A=null!=O&&!E,D=null===O||void 0===O?void 0:O.renderData,Z=null===D||void 0===D?void 0:D.geometryState;if(Bf.T9&&((0,Bf.Fp)(!A||O.level===a.level),(0,Bf.Fp)(!A||(0,Sv.gl)(a,O)<=0),a&&!O&&!o.updatingRootTiles)){var I=Bf.OC[r],L=a.findNeighborTile(I,(function(e){return e.isLoaded||e.isLeaf||e.level===a.level}));o.updatingRootTiles||(L?L.intersectsClippingArea&&((0,Bf.Fp)(!L.isLoaded),(0,Bf.Fp)(!L.isLeaf),(0,Bf.Fp)(L.level===a.level)):(0,Bf.Fp)(null==(null===o||void 0===o?void 0:o.rootTiles)||!a.shouldHaveNeighbor(I)))}var N=(0,Se.uZ)(1===r?d:h,x,T),U=(0,Se.uZ)(0===r?v:f,S,k),H=null===Z||void 0===Z?void 0:Z.samplerData,F=t&&c>3?c-3:1,V=(0,Se.uZ)(1===r?1:0,g,b),z=(0,Se.uZ)(0===r?1:0,y,w),q=A?function(e,t){return.5*(qf(e,t,H)+qf(e,t,u))}:function(e,t){return qf(e,t,u)},B=(d-h)/l,G=s?1===r?B:-B:0,j=s?0:0===r?B:-B,W=-G,X=-j,Q=0,Y=0,J=0,K=0/l,$=s?N:(0,Se.uZ)(h*(1-K)+d*K,x,T),ee=s?(0,Se.uZ)(f*(1-K)+v*K,S,k):U,te=q($,ee);Q=$*_,Y=m(ee),J=te;var ne=0,ie=0,re=0,ae=1/l,oe=s?N:(0,Se.uZ)(h*(1-ae)+d*ae,x,T),se=s?(0,Se.uZ)(f*(1-ae)+v*ae,S,k):U,le=q(oe,se);ne=oe*_,ie=m(se),re=le;for(var ue=1;ue<c-1;ue+=F){var ce=ue/l,he=ne,de=ie,fe=re,ve=s?V:(0,Se.uZ)(ce,g,b),pe=s?(0,Se.uZ)(ce,y,w):z,_e=he-M,me=de-P,ge=fe-R;Kp(he,me,ge,C),n.setEdgeVertexFromValuesRawPositionUV(r,ue,_e,me,ge,ve,pe);var ye=(ue+1)/l,be=s?N:(0,Se.uZ)(h*(1-ye)+d*ye,x,T),we=s?(0,Se.uZ)(f*(1-ye)+v*ye,S,k):U,Ce=q(be,we);ne=be*_,ie=m(we);var xe=ne,Te=re=Ce,ke=Q,Me=Y,Pe=J;Q=he,Y=de,J=fe;var Re=0,Ee=0,Oe=0;if(s){var Ae=ie-de,De=Te-fe,Ze=Me-de,Ie=Pe-fe,Le=(0,Se.uZ)(f*(1-ce)+v*ce,S,k),Ne=N+W,Ue=Ne*_-he,He=qf(Ne,Le,u)-fe,Fe=3===r?-1:1;if(Re=Fe*(-Ze+Ae)*He,Ee=Fe*Ue*(-Ie+De),Oe=-Fe*Ue*(-Ze+Ae),A){var Ve=N+G,ze=Ve*_-he;Re=(-Ze+Ae)*(He-(qf(Ve,Le,H)-fe)),Ee=(Ue-ze)*(-Ie+De),Oe=-(Ue-ze)*(-Ze+Ae)}}else{var qe=xe-he,Be=Te-fe,Ge=ke-he,je=Pe-fe,We=(0,Se.uZ)(h*(1-ce)+d*ce,x,T),Xe=U+X,Qe=qf(We,Xe,u)-fe,Ye=m(Xe)-de,Je=2===r?-1:1;if(Re=Je*Ye*(-je+Be),Ee=Je*(-Ge+qe)*Qe,Oe=-Je*Ye*(-Ge+qe),A){var Ke=We,$e=U+j,et=m($e)-de;Re=(-Ye+et)*(-je+Be),Ee=(-Ge+qe)*(-Qe+(qf(Ke,$e,H)-fe)),Oe=-(-Ye+et)*(-Ge+qe)}}var tt=1/Math.sqrt(Re*Re+Ee*Ee+Oe*Oe);n.setEdgeNormalFromValues(r,ue,Re*tt,Ee*tt,Oe*tt)}},O=0;O<4;++O)E(O)}function Ap(e,t){Fp(e)}function Dp(e,t,n){return e?function(e){return function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t)}:function(e){return function(e,t){return e*t}(e,n)}}function Zp(e,t,n){for(var r=e.numVerticesPerSide,a=e.vertexAttributes,o=e.maxEdgeVertexCount,s=r-1,l=a.count,u=2*(r-3)*(r-3),c=4*(s+o-3),h=Cp.reduce((function(t,n){return t+(s+e.getEdgeCount(n)-3)}),0),d=t.reduce((function(e,t){return e+s*(2*(t.latitudeResolution-1)+1)}),0),f=3*(n?2:1),v=(u+c+d)*f,p=l>=65536?new Uint32Array(v):new Uint16Array(v),_=0;_<v;++_)p[_]=0;e.indices=p,e.indexCount=(u+h+d)*f,e.poleIndicesStartIndex=u*f,e.edgeIndicesStartIndex=(u+d)*f,n?(function(e){for(var t=e.indices,n=e.numVerticesPerSide,i=e.vertexAttributes.position,r=i.typedBuffer,a=i.typedBufferStride,o=n-2,s=0,l=0;l<n-3;++l)for(var u=l*o,c=0;c<n-3;++c){var h=l*o+c,d=h+1,f=d+o,v=f-1,p=u+c,_=p+1,m=_+o;e_(p,_,m,m-1,a,r)?(t_(t,s,h,d,f),t_(t,s+=6,f,v,h)):(t_(t,s,h,d,v),t_(t,s+=6,v,f,d)),s+=6}}(e),function(e,t){var n,r=e.indices,a=e.numVerticesPerSide,o=e.poleIndicesStartIndex,s=a-1,l=o,u=(0,i.Z)(t);try{for(u.s();!(n=u.n()).done;)for(var c=n.value,h=c.connectedOuterEdgeOffset,d=e.getEdgeVertexIndex(h,0),f=1,v=0;v<c.latitudeResolution;++v){for(var p=0===v?c.rowOffset:d+a,_=0;_<s;_++)t_(r,l,d,d+1,p+_),l+=6,v<c.latitudeResolution-1&&(t_(r,l,d+1,p+_+1,p+_),l+=6),d+=f;d=p,f=1}}catch(m){u.e(m)}finally{u.f()}}(e,t),Lp(e)):(function(e){for(var t=e.numVerticesPerSide,n=e.indices,i=e.vertexAttributes.position,r=i.typedBuffer,a=i.typedBufferStride,o=t-2,s=t-3,l=0,u=t-3,c=0,h=0;h<s;++h)for(var d=h*o,f=l;f<u;++f){var v=d+f,p=v+1,_=p+o,m=_-1;e_(v,p,_,m,a,r)?(n[c]=v,n[c+1]=p,n[c+2]=_,n[c+3]=_,n[c+4]=m,n[c+5]=v):(n[c]=v,n[c+1]=p,n[c+2]=m,n[c+3]=m,n[c+4]=p,n[c+5]=_),c+=6}}(e),function(e,t){var n,r=e.numVerticesPerSide,a=e.indices,o=e.poleIndicesStartIndex,s=r-1,l=o,u=(0,i.Z)(t);try{for(u.s();!(n=u.n()).done;)for(var c=n.value,h=c.isNorth?1:2,d=c.isNorth?2:1,f=c.isNorth?3:4,v=c.isNorth?4:3,p=e.getEdgeVertexIndex(c.connectedOuterEdgeOffset,0),_=1,m=0;m<c.latitudeResolution;++m){for(var g=0===m?c.rowOffset:p+r,y=0;y<s;y++){var b=g+y;a[l]=p,a[l+h]=p+1,a[l+d]=b,m<c.latitudeResolution-1?(a[l+f]=p+1,a[l+v]=b+1,a[l+5]=b,l+=6):l+=3,p+=_}p=g,_=1}}catch(w){u.e(w)}finally{u.f()}}(e,t),Ip(e))}function Ip(e){for(var t=e.indices,n=e.numVerticesPerSide-1,i=n-2,r=e.edgeIndicesStartIndex,a=0;a<4;++a){var o=Jp[a],s=0,l=0,u=e.getEdgeCount(a),c=o.count;(0,Bf.Fp)(c===n-1);for(var h=1===a||2===a,d=h?1:2,f=h?2:1,v=e.getEdgeFirstVertexIndex(a),p=o.vertex0Index,_=o.stride;s<u-1||l<c-1;){var m=p+l*_,g=v+1*s,y=s<u-1,b=l<c-1,w=y&&(!b||(y?0+n*(s+.5)/(u-1):0)<=(b?1+i*(l+.5)/(c-1):0));w?++s:++l;var C=w?g+1:m+_;t[r]=m,t[r+d]=g,t[r+f]=C,r+=3}}e.indexCount=r}function Lp(e){for(var t=e.indices,n=e.numVerticesPerSide-1,i=n-2,r=e.edgeIndicesStartIndex,a=0;a<4;++a){var o=Jp[a],s=0,l=0,u=e.getEdgeCount(a),c=o.count;(0,Bf.Fp)(c===n-1);for(var h=1===a||2===a,d=h?1:3,f=h?3:1,v=e.getEdgeFirstVertexIndex(a),p=o.vertex0Index,_=o.stride;s<u-1||l<c-1;){var m=p+l*_,g=v+1*s,y=s<u-1,b=l<c-1,w=y&&(!b||(y?0+n*(s+.5)/(u-1):0)<=(b?1+i*(l+.5)/(c-1):0));w?++s:++l;var C=w?g+1:m+_;t[r]=m,t[r+d]=g,t[r+d+1]=g,t[r+f]=C,t[r+f+1]=C,t[r+5]=m,r+=6}}e.indexCount=r}function Np(e){for(var t=e.geometry,n=e.geometryState.edgeResolutions,i=t.numVerticesPerSide-2,r=t.edgeVerticesStartIndex,a=0;a<4;++a){var o=0===a||2===a,s=(0===a?i-1:0)*i+(1===a?i-1:0),l=(o?0:1)*i+(o?1:0),u=Jp[a];u.vertex0Index=s,u.stride=l,u.count=i;var c=n[a]+1;t.outerEdgesOffsetAndLength[2*a+0]=r,t.outerEdgesOffsetAndLength[2*a+1]=c,r+=c}}function Up(e){Np(e),e.geometryState.wireframe?Lp(e.geometry):Ip(e.geometry)}function Hp(e,t,n){var i=e.geometryState,r=e.geometry,a=e.tile,o=e.localOrigin,s=1===t||3===t,l=i.edgeResolutions[t];(0,Bf.Fp)((0,Se.wt)(l));var u=l+1,c=r.boundingBox,h=r.minu,d=r.minv,f=r.maxu,v=r.maxv,p=r.vertexAttributes,_=(0,Se.uZ)(1===t?1:0,h,f),m=(0,Se.uZ)(0===t?1:0,d,v),g=n.renderData,y=g.geometryState,b=g.geometry,w=(t+2)%4,C=b.getEdgeCount(w),x=a.getNeighborEdgeStartVertexIndex(t,n)*l,T=l*Math.pow(2,a.level-n.level);(0,Bf.Fp)(y.edgeResolutions[w]===T),(0,Bf.Fp)(C-1===T);for(var S=g.localOrigin[0]-o[0],k=g.localOrigin[1]-o[1],M=g.localOrigin[2]-o[2],P=r.getEdgeFirstVertexIndex(t),R=p.position,E=R.typedBuffer,O=R.typedBufferStride,A=p.normalCompressed,D=A.typedBuffer,Z=A.typedBufferStride,I=p.uv0,L=b.vertexAttributes,N=b.getEdgeFirstVertexIndex(w),U=L.position.typedBuffer,H=L.position.typedBufferStride,F=L.normalCompressed.typedBuffer,V=L.normalCompressed.typedBufferStride,z=1;z<u-1;++z){var q=P+z,B=N+(x+z),G=q*O,j=B*H,W=U[j]+S,X=U[j+1]+k,Q=U[j+2]+M;E[G]=W,E[G+1]=X,E[G+2]=Q,Kp(W,X,Q,c);var Y=q*Z,J=B*V;D[Y]=F[J],D[Y+1]=F[J+1];var K=z/l;gv(I,q,s?_:(0,Se.uZ)(K,h,f),s?(0,Se.uZ)(K,d,v):m)}}function Fp(e){for(var t,n=e.geometry,i=e.geometryState,r=e.localOrigin,a=i.clippingArea,o=i.samplerData,s=n.minu,l=n.minv,u=n.maxu,c=n.maxv,h=n.boundingBox,d=n.vertexAttributes,f=e.tile,v=f.surface,p=f.ellipsoid,_=f.extent,m=f.extentInRadians,g=f.horizontalScale,y="local"===(null===(t=v.view)||void 0===t?void 0:t.viewingMode),b=p.radius,w=0,C=0,x=0,T=y?function(){var e=a,t=null!=e&&(_[3]>e[3]||_[2]>e[2]||_[1]<e[1]||_[0]<e[0]),n=Dp(v.isWebMercatorOnPlateCarree,b,g);return function(i,r,a){var o=0===i?_[0]:_[2],s=0===r?_[1]:_[3],l=t?(0,Se.uZ)(o,e[0],e[2]):o,u=t?(0,Se.uZ)(s,e[1],e[3]):s,c=a;w=l*g,C=n(u),x=c}}():function(e,t,n){var i=m[0===t?1:3],r=m[0===e?0:2],a=Math.cos(i),o=Math.sin(i),s=Math.sin(r),l=Math.cos(r),u=b+n;w=l*a*u,C=s*a*u,x=o*u},S=0,k=0,M=0,P=0,R=0,E=0,O=0,A=0,D=0,Z=y&&v.isWebMercatorOnPlateCarree,I=function(e,t,n,i,r){var a=0,o=0,s=0;if(y){var l=t*g,u=Z?(Math.PI/2-2*Math.atan(Math.exp(-n/b)))*b:n*g;a=l-w,o=u-C,s=i-x}else{var c=Pp(e),h=e.tile,d=h.extent,f=h.extentInRadians,v=(t-d[0])/(d[2]-d[0]),p=(n-d[1])/(d[3]-d[1]),_=f[0]*(1-v)+f[2]*v,m=c(p),T=Math.cos(m),S=Math.sin(m),k=Math.sin(_),M=Math.cos(_),I=b+i;a=M*T*I-w,o=k*T*I-C,s=S*I-x}switch(r){case 0:O+=a,A+=o,D+=s;break;case 1:P-=a,R-=o,E-=s;break;case 2:O-=a,A-=o,D-=s;break;case 3:P+=a,R+=o,E+=s}},L=null!==a&&void 0!==a?a:Wp,N=_[0],U=_[2],H=_[1],F=_[3],V=[F>L[3],U>L[2],H<L[1],N<L[0]],z=Math.max(N,L[0]),q=Math.min(U,L[2]),B=Math.max(H,L[1]),G=Math.min(F,L[3]),j=function(e){return Math.max(L[0],Math.min(L[2],e))},W=function(e){return Math.max(L[1],Math.min(L[3],e))},X=function(e){var t=i.cornerNeighborCornerTiles;S=0,k=0,M=1,P=0,R=0,E=0,O=0,A=0,D=0;for(var n=1/0,r=0;r<4;++r){var a,o=t[4*e+r];n=Math.min(n,null!==(a=null===o||void 0===o?void 0:o.level)&&void 0!==a?a:1/0)}for(var s=0;s<4;++s){var l=t[4*e+s];Xp[s]=(null===l||void 0===l?void 0:l.level)===n?l:null}for(var u=1,c=0,h=0;h<4;++h){var d=Xp[h];d&&(u=Math.max(u,null===d||void 0===d?void 0:d.renderData.geometryState.numVerticesPerSide),c=d.extent[2]-d.extent[0])}var f=c,v=u;(0,Bf.Fp)(v>1);for(var p=f/v,_=0;_<4;++_){var m=Xp[(_+3)%4],g=Xp[_%4];if(m||g){var b=0===_?1:1===_?2:2===_?3:0,T=0===_?2:1===_?3:2===_?0:1;if(m&&g){var Z=Gp[_][0]*p,L=Gp[_][1]*p,N=m.extent,U=j(N[0===b||1===b?2:0]+Z),H=W(N[0===b||3===b?3:1]+L),F=g.extent,V=j(F[0===T||1===T?2:0]+Z),z=W(F[0===T||3===T?3:1]+L),q=m.renderData,B=g.renderData,G=qf(U,H,q.geometryState.samplerData),X=qf(V,z,B.geometryState.samplerData);I(q,U,H,.5*(G+X),_)}else{var Q=null!==m&&void 0!==m?m:g,Y=m?b:T,J=Q.extent,K=Gp[_],$=j(J[0===Y||1===Y?2:0]+K[0]*p),ee=W(J[0===Y||3===Y?3:1]+K[1]*p),te=Q.renderData,ne=qf($,ee,te.geometryState.samplerData);I(te,$,ee,ne,_)}}}if(!y){var ie=Math.sqrt(w*w+C*C+x*x);S=w/ie,k=C/ie,M=x/ie}if(y||M*M<.999){var re=Math.sqrt(P*P+R*R+E*E);P/=re,R/=re,E/=re;var ae=Math.sqrt(O*O+A*A+D*D);S=E*(A/=ae)-R*(D/=ae),k=P*D-E*(O/=ae),M=R*O-P*A;var oe=1/Math.sqrt(S*S+k*k+M*M);S*=oe,k*=oe,M*=oe}},Q=i.cornerNeighborCornerTiles,Y=0;Y<4;++Y){for(var J=Y,K=(Y+1)%4,$=0===Y||1===Y?1:0,ee=0===Y||3===Y?1:0,te=(0,Se.uZ)($,s,u),ne=(0,Se.uZ)(ee,l,c),ie=n.getEdgeFirstVertexIndex(J),re=n.getEdgeCount(J),ae=0===Y||3===Y?re-1:0,oe=n.getEdgeFirstVertexIndex(K),se=n.getEdgeCount(K),le=0===Y||1===Y?se-1:0,ue=-1,ce=0;ce<4;++ce){var he=Q[4*Y+ce],de=Q[4*Y+ue];he&&(-1===ue||(0,Sv.gl)(de,he)>0)&&(ue=ce)}var fe=ue,ve=Q[4*Y+fe];if(ve!==f){var pe=f.level-ve.level,_e=Math.pow(2,pe),me=[ve.lij[0]+pe,ve.lij[1]*_e,ve.lij[2]*_e],ge=[me[1]+_e===f.lij[1],0===Y&&(1===fe||0===fe&&ve!==Q[4*Y+3])||1===Y&&(0===fe||1===fe&&ve!==Q[4*Y+2]),me[1]===f.lij[1]+1,2===Y&&(3===fe||2===fe&&ve!==Q[4*Y+1])||3===Y&&(2===fe||3===fe&&ve!==Q[4*Y+0])],ye=ge.reduce((function(e,t){return e+(t?1:0)}),0);(0,Bf.Fp)(1===ye||2===ye);var be=-1,we=-1,Ce=ve.renderData;if(1===ye){var xe=ge.findIndex((function(e){return e}));(0,Bf.Fp)(0<=xe&&xe<=3),be=(xe+2)%4;var Te=i.edgeResolutions[xe];we=f.getNeighborEdgeStartVertexIndex(xe,ve)*Te+Te*(0===xe&&0===Y||1===xe&&0===Y||2===xe&&1===Y||3===xe&&3===Y?1:0)}else{(0,Bf.Fp)(ge[1]||ge[3]),be=ge[1]?3:1;var ke=Ce.geometryState.edgeResolutions[be];we=0===Y||3===Y?0:ke}var Me=Ce.geometry,Pe=ie+ae,Re=oe+le,Ee=Me.getEdgeFirstVertexIndex(be)+we,Oe=Me.vertexAttributes,Ae=Ce.localOrigin,De=Oe.position,Ze=De.typedBuffer,Ie=Ee*De.typedBufferStride,Le=Ze[Ie]+Ae[0]-r[0],Ne=Ze[Ie+1]+Ae[1]-r[1],Ue=Ze[Ie+2]+Ae[2]-r[2];Kp(Le,Ne,Ue,h);var He=d.position,Fe=He.typedBuffer,Ve=Pe*He.typedBufferStride;Fe[Ve]=Le,Fe[Ve+1]=Ne,Fe[Ve+2]=Ue;var ze=Re*He.typedBufferStride;Fe[ze]=Le,Fe[ze+1]=Ne,Fe[ze+2]=Ue;var qe=d.uv0;gv(qe,Pe,te,ne),gv(qe,Re,te,ne);var Be=Oe.normalCompressed.typedBuffer,Ge=Ee*Oe.normalCompressed.typedBufferStride,je=d.normalCompressed,We=je.typedBuffer,Xe=Pe*je.typedBufferStride;We[Xe]=Be[Ge],We[Xe+1]=Be[Ge+1];var Qe=Re*je.typedBufferStride;We[Qe]=Be[Ge],We[Qe+1]=Be[Ge+1]}else{var Ye=void 0;if(V[J]||V[K])Ye=qf((0,Se.uZ)(N*(1-$)+U*$,z,q),(0,Se.uZ)(H*(1-ee)+F*ee,B,G),o);else Ye=Vp(Q,Y);T($,ee,Ye),X(Y);var Je=w-r[0],Ke=C-r[1],$e=x-r[2];Kp(Je,Ke,$e,h),n.setEdgeVertexFromValuesRawPositionUVNormal(J,ae,Je,Ke,$e,te,ne,S,k,M),n.setEdgeVertexFromValuesRawPositionUVNormal(K,le,Je,Ke,$e,te,ne,S,k,M)}}for(var et=0;et<4;++et)Xp[et]=null}function Vp(e,t){var n=4*t,i=Cp.reduce((function(t,i){var r,a;return Math.min(t,null!==(r=null===(a=e[n+i])||void 0===a?void 0:a.level)&&void 0!==r?r:1/0)}),1/0);Bf.T9&&((0,Bf.Fp)(!e[n+0]||!e[n+2]||jv(e[n+0],e[n+2],pv.X.SOUTH_WEST)),(0,Bf.Fp)(!e[n+1]||!e[n+3]||jv(e[n+1],e[n+3],pv.X.NORTH_WEST)));for(var r=0,a=0,o=0;o<4;++o){var s=e[n+o];if(s&&s.level===i){var l,u,c=0===o||1===o,h=0===o||3===o,d=s.extent;a+=qf(d[c?0:2],d[h?1:3],null===(l=s.renderData)||void 0===l||null===(u=l.geometryState)||void 0===u?void 0:u.samplerData),r++}}var f=r?a/r:0;return(0,Bf.Fp)(null!=f),f}function zp(e){var t=e.vao,n=e.geometry,i=n.vertexAttributes,r=n.edgeVerticesStartIndex,a=i.position.typedBuffer;t.vertexBuffers.geometry.setSubData(a,r,r,a.length)}function qp(e){var t=e.vao,n=e.geometry,i=n.indices,r=n.indexCount,a=n.edgeIndicesStartIndex;t.indexBuffer.setSubData(i,a,a,r)}var Bp=(0,s.Z)((function e(t,n,i,r,a){(0,o.Z)(this,e),this.isNorth=t,this.connectedRowOffset=n,this.connectedOuterEdgeOffset=i,this.rowOffset=r,this.latitudeResolution=a})),Gp=[[0,1],[1,0],[0,-1],[-1,0]],jp=new bv,Wp=(0,B.al)(-1/0,-1/0,1/0,1/0),Xp=[null,null,null,null];function Qp(e,t,n){if(!t)return!1;var i=(0,Sv.gl)(e,t);return i>0||0===i&&n>=2}var Yp=function(){function e(){(0,o.Z)(this,e),this.vertex0Index=0,this.stride=1,this.count=0}return(0,s.Z)(e,[{key:"getVertexIndex",value:function(e){return(0,Bf.Fp)(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}]),e}(),Jp=[new Yp,new Yp,new Yp,new Yp];function Kp(e,t,n,i){e<i[0]?i[0]=e:e>i[3]&&(i[3]=e),t<i[1]?i[1]=t:t>i[4]&&(i[4]=t),n<i[2]?i[2]=n:n>i[5]&&(i[5]=n)}function $p(e){var t=e.edgeResolutions,n=e.numVerticesPerSide,i=1+Math.max.apply(Math,(0,Ru.Z)(t));return Math.max(n,i)}function e_(e,t,n,i,r,a){var o=e*r,s=a[o],l=a[o+1],u=a[o+2],c=t*r,h=a[c],d=a[c+1],f=a[c+2],v=n*r,p=a[v],_=a[v+1],m=a[v+2],g=i*r,y=a[g],b=a[g+1],w=a[g+2];return(h-y)*(h-y)+(d-b)*(d-b)+(f-w)*(f-w)>(s-p)*(s-p)+(l-_)*(l-_)+(u-m)*(u-m)}function t_(e,t,n,i,r){e[t]=n,e[t+1]=i,e[t+2]=i,e[t+3]=r,e[t+4]=r,e[t+5]=n}var n_=6,i_=n(42235),r_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a,s){var l;return(0,o.Z)(this,n),(l=t.call(this))._horizontalScaleFactor=1,l._extentInRenderSR=(0,B.Ue)(),l._baseUsedMemory=900,l._subtreeGeometryElevationBoundMin=0,l._subtreeGeometryElevationBoundMax=0,l.init(e,i,r,a,s),l}return(0,s.Z)(n,[{key:"init",value:function(e,t,i,r,a){(0,u.Z)((0,c.Z)(n.prototype),"init",this).call(this,e,t,i,r,a);var o=a.view.renderSpatialReference,s=a.spatialReference,l=null!=o&&(0,tt.QM)(o)&&null!=s&&s.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=l;var h=a.isWebMercatorOnPlateCarree,d=this._extentInRenderSR,f=this.extent;if(h){var v=(0,U.al)(f[0],f[1],0);(0,Zf.S)(v,ee.Z.WebMercator,v,ee.Z.PlateCarree);var p=(0,U.al)(f[2],f[3],0);(0,Zf.S)(p,ee.Z.WebMercator,p,ee.Z.PlateCarree),d[0]=v[0],d[1]=v[1],d[2]=p[0],d[3]=p[1]}else for(var _=0;_<4;++_)d[_]=f[_]*l;this.centerAtSeaLevel[0]=.5*(d[0]+d[2]),this.centerAtSeaLevel[1]=.5*(d[1]+d[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(d[2]-d[0],d[3]-d[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}},{key:"updateRadiusAndCenter",value:function(){this._updateCenter();var e=this._extentInRenderSR,t=.5*(e[2]-e[0]),n=.5*(e[3]-e[1]),i=Math.sqrt(t*t+n*n),r=.5*(this.elevationBoundsMax-this.elevationBoundsMin),a=Math.max(i,r);this._center[Fv.MIDDLE][3]=a}},{key:"_calculateFrustumVisibilityStatus",value:function(e){for(var t=this._aabb(),n=t[0],i=t[1],r=t[2],a=t[3],o=t[4],s=t[5],l=!0,u=0;u<6;u++){var c=e[u],h=c[0],d=c[1],f=c[2],v=c[3];if(h*(h>0?n:a)+d*(d>0?i:o)+f*(f>0?r:s)+v>=0)return Ov.OUTSIDE;l=l&&h*(h<0?n:a)+d*(d<0?i:o)+f*(f<0?r:s)+v<=0}return l?Ov.INSIDE:Ov.INTERSECTS}},{key:"_aabb",value:function(){var e=this._extentInRenderSR;return(0,vv.re)(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}},{key:"intersectsRay",value:function(e,t,n,i){return a_[0]=1/t[0],a_[1]=1/t[1],a_[2]=1/t[2],(0,i_.Fw)(this._aabb(),e,a_,n,i)}},{key:"createGeometry",value:function(){Rp(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}},{key:"_updateSubtreeGeometryElevationsBounds",value:function(){var e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,n=this.renderData,r=e,a=t;if(n){var o=n.geometry.boundingBox;r=o[2],a=o[5]}else if(!this.isLeaf){r=1/0,a=-1/0;var s,l=(0,i.Z)(this.children);try{for(l.s();!(s=l.n()).done;){var u=s.value;r=Math.min(r,u._subtreeGeometryElevationBoundMin),a=Math.max(a,u._subtreeGeometryElevationBoundMax)}}catch(h){l.e(h)}finally{l.f()}}if(r!==this._subtreeGeometryElevationBoundMin||a!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=a;var c=this.parent;null===c||void 0===c||c._updateSubtreeGeometryElevationsBounds()}}},{key:"getDefaultVerticesPerSide",value:function(){return this.level<9?3:2}},{key:"updateCornerElevations",value:function(){(function(e,t){e.tile.intersectsClippingArea&&(Ap(e),Op(e,!0),zp(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}},{key:"updateEdgeElevations",value:function(){(function(e,t){e.tile.intersectsClippingArea&&(Ep(e),zp(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}},{key:"updateEdgeElevationsAndResolutions",value:function(){(function(e,t){e.tile.intersectsClippingArea&&(Up(e),Ep(e),zp(e),qp(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}},{key:"horizontalScale",get:function(){return this._horizontalScaleFactor}}]),n}(Nv),a_=(0,U.Ue)(),o_=n(82394),s_=(0,s.Z)((function e(){(0,o.Z)(this,e),this.extent=(0,st.Ue)(),this.minLevel=0,this.maxLevel=0,this.callback=null})),l_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._queries=new Fl.Z({initialSize:10}),e._queriesInvPtr=0,e._queryQueue=new Fl.Z({initialSize:30}),e._queryPool=new Iu.Z(s_),e}return(0,s.Z)(n,[{key:"queryVisibleLevelRange",value:function(e,t,n,i){var r=this._queryPool.acquire();(0,ot.c)(r.extent,e),r.minLevel=null!==t&&void 0!==t?t:-Number.MAX_VALUE,r.maxLevel=null!==n&&void 0!==n?n:Number.MAX_VALUE,r.callback=i,this._queryQueue.push(r),this.notifyChange("updating")}},{key:"updating",get:function(){return 0!==this._queryQueue.length}},{key:"prepare",value:function(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){var e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}},{key:"process",value:function(){for(var e=0;e<this._queries.length;e++){var t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}},{key:"queriesForTile",value:function(e){for(var t=e.level,n=0;n<this._queriesInvPtr;){var i=this._queries.data[n],r=i.extent;t>=i.minLevel&&t<=i.maxLevel&&r[0]<=e.extent[2]&&r[2]>=e.extent[0]&&r[1]<=e.extent[3]&&r[3]>=e.extent[1]?(this._queries.swapElements(n,this._queriesInvPtr-1),this._queriesInvPtr--):n++}}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],l_.prototype,"updating",null),l_=(0,f._)([(0,A.j)("esri.views.3d.terrain.ScaleRangeQueries")],l_);var u_=n(86372),c_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a,s){var l;return(0,o.Z)(this,n),(l=t.call(this))._convexHull=new Array(24),l._boundingSphere=(0,Ai.c)(),l._baseUsedMemory=1816,l.init(e,i,r,a,s),l}return(0,s.Z)(n,[{key:"init",value:function(e,t,i,r,a){(0,u.Z)((0,c.Z)(n.prototype),"init",this).call(this,e,t,i,r,a);var o=this.ellipsoid.radius,s=this.extentInRadians[0],l=this.extentInRadians[1],h=this.extentInRadians[2],d=this.extentInRadians[3],f=(0,Se.t7)(l,d,.5),v=(0,Se.t7)(s,h,.5),p=0===e?0:Math.min(Math.abs(l),Math.abs(d));this._edgeLen=(h-s)*Math.cos(p)*o,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=o-Math.sqrt(o*o-this._edgeLen2/4),function(e,t,n,i){var r=Math.cos(n);e[0]=Math.cos(t)*r*i,e[1]=Math.sin(t)*r*i,e[2]=Math.sin(n)*i}(this.centerAtSeaLevel,v,f,this.ellipsoid.radius),(0,et.n)(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}},{key:"updateRadiusAndCenter",value:function(){this._updateBoundingVolumes();var e=this._center;if(0===this.lij[0])(0,et.s)((0,Ai.g)(e[Fv.MIDDLE]),0,0,0),(0,et.s)(e[Fv.TOP],0,0,0),(0,et.s)(e[Fv.BOTTOM],0,0,0),e[Fv.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();for(var t=e[Fv.MIDDLE],n=this.convexHull,i=0,r=0;r<8;++r)i=Math.max(i,d_((0,Ai.g)(t),n,3*r));e[Fv.MIDDLE][3]=Math.sqrt(i)}}},{key:"_calculateFrustumVisibilityStatus",value:function(e){if(!(0,Au.hr)(e,this._boundingSphere))return Ov.OUTSIDE;if(this.lij[0]<10)return Ov.INTERSECTS;for(var t=this.convexHull,n=this.surface.view.state.camera.near,i=!0,r=0;r<Au.N9;r++){for(var a=r===Au.Nu.NEAR,o=e[r],s=o[0],l=o[1],u=o[2],c=o[3]-(a?n:0),h=!1,d=0;d<8;++d){var f=3*d;if(s*t[f]+l*t[f+1]+u*t[f+2]+c<0){if(h=!0,!i)break}else i=!1}if(!h)return Ov.OUTSIDE}return i?Ov.INSIDE:Ov.INTERSECTS}},{key:"computeElevationBounds",value:function(){(0,u.Z)((0,c.Z)(n.prototype),"computeElevationBounds",this).call(this),this._updateBoundingVolumes()}},{key:"createGeometry",value:function(){xp(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}},{key:"_updateBoundingVolumes",value:function(){this._updateConvexHull(),this._updateBoundingSphere(),Bf.T9&&this._checkBVs()}},{key:"_updateBoundingSphere",value:function(){var e=this._boundingSphere,t=(0,Ai.g)(e),n=this.elevationBoundsMin,i=this.elevationBoundsMax,r=this.ellipsoid.radius,a=i;if(0===this.level)(0,et.s)(t,0,0,0),e[3]=r+a;else{var o=this.extentInRadians,s=.5*(o[0]+o[2]),l=o[1],u=o[3];v_(__,s,l,r),v_(m_,s,u,r),(0,et.g)(t,__,m_),(0,et.j)(t,t,(r+.5*(n+i))/(0,et.H)(t));for(var c=this.convexHull,h=0,d=function(e,t){var n=e[0]-c[3*t],i=e[1]-c[3*t+1],r=e[2]-c[3*t+2];return Math.sqrt(n*n+i*i+r*r)},f=0;f<8;++f){var v=d(t,f);h=Math.max(h,v)}var p=h;e[3]=p+2}}},{key:"_updateConvexHull",value:function(){var e=this,t=this.extentInRadians,n=this.ellipsoid.radius;if(0!==this.level){var i=this.elevationBoundsMin,r=this.elevationBoundsMax,a=this._getPatchType(),o=this.surface.isWebMercator,s=o&&a===Qf.tk.HAS_NORTH_POLE,l=o&&a===Qf.tk.HAS_SOUTH_POLE,u=l||s,c=Math.PI/2,h=t[0],d=t[2],f=l?-c:t[1],v=s?c:t[3],p=.5*(h+d),_=i,m=n+(u?Math.min(0,_-1):_),g=function(e,t,n){return v_(e,t,n,m)},y=(0,U.Ue)(),b=(0,U.Ue)(),w=(0,U.Ue)(),C=(0,U.Ue)();g(y,h,f),g(b,h,v),g(w,d,v),g(C,d,f);var x=function(t,n){for(var i=0;i<3;++i)e._convexHull[3*n+i]=t[i]};x(y,0),x(b,1),x(w,2),x(C,3);var T=r,S=n+(u?Math.max(0,T+1):T),k=(0,U.Ue)(),M=(0,U.Ue)(),P=(0,U.Ue)();v_(M,p,v,m),v_(P,p,f,m),(0,et.g)(k,M,P),(0,et.n)(k,k);var R=(0,U.Ue)(),E=(0,U.Ue)(),O=function(e,t){(0,et.z)(E,e,t),(0,et.n)(E,E);var n=-(0,et.m)(e,R)/(0,et.m)(E,R);(0,Bf.Fp)(n>=0),(0,et.j)(E,E,n),(0,et.g)(e,e,E)};if(Math.pow(2,this.lij[0])>2*this.lij[1]){var A=P,D=(0,U.Ue)();(0,et.b)(D,p_,A),(0,et.n)(D,D),(0,et.b)(R,A,D),(0,et.n)(R,R),(0,Bf.Fp)((0,Bf.Wq)((0,et.m)(R,A)/(0,et.H)(A),0)),O(y,b),O(C,w),x(y,0),x(C,3)}else if(Math.pow(2,this.lij[0])!==2*this.lij[1]){var Z=M,I=(0,U.Ue)();(0,et.b)(I,p_,Z),(0,et.n)(I,I),(0,et.b)(R,I,Z),(0,et.n)(R,R),O(b,y),O(w,C),x(b,1),x(w,2)}var L=function(t,n){for(var i=S/(0,et.m)(n,k),r=0;r<3;++r)e._convexHull[3*t+r]=n[r]*i};L(4,y),L(5,b),L(6,w),L(7,C)}}},{key:"_getPatchType",value:function(){var e=this.lij[1],t=0===e,n=e===(1<<this.level)-1;return t?n?Qf.tk.HAS_BOTH_POLES:Qf.tk.HAS_NORTH_POLE:n?Qf.tk.HAS_SOUTH_POLE:Qf.tk.REGULAR}},{key:"intersectsRay",value:function(e,t,n,i){var r=this._boundingSphere,a=r[3]+n,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=r[0]-e[0],l=r[1]-e[1],u=r[2]-e[2],c=(s*t[0]+l*t[1]+u*t[2])/o,h=t[0]*c-s,d=t[1]*c-l,f=t[2]*c-u;return h*h+d*d+f*f<a*a}},{key:"getDefaultVerticesPerSide",value:function(){return this.level<h_.length?h_[this.level]+1:2}},{key:"updateCornerElevations",value:function(){(function(e){e.tile.intersectsClippingArea&&(kp(e),Sp(e,!0),zp(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}},{key:"updateEdgeElevations",value:function(){(function(e){e.tile.intersectsClippingArea&&(Tp(e),zp(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}},{key:"updateEdgeElevationsAndResolutions",value:function(){(function(e){e.tile.intersectsClippingArea&&(Up(e),Tp(e),zp(e),qp(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}},{key:"_checkBVs",value:function(){var e,t=this;if(Bf.T9&&!(this.level<=2)){var n=this._boundingSphere,i=n[3],r=(0,Ai.g)(n),a=(0,U.Ue)(),o=this.ellipsoid.radius,s=this.elevationBoundsMin,l=this.elevationBoundsMax,u=o+s,c=this._center[Fv.MIDDLE][3],h=this.convexHull,d=function(e,t){for(var n=0;n<3;++n)e[n]=h[3*t+n]},f=(0,U.Ue)(),v=(0,U.Ue)(),p=(0,U.Ue)(),_=(0,U.Ue)(),m=(0,U.Ue)(),g=function(e,t,n,i){d(v,e),d(p,t),d(_,n),(0,et.z)(v,v,p),(0,et.z)(_,_,p),(0,et.b)(f,v,_),(0,et.n)(f,f);var r=(0,et.m)(f,p);d(m,i);var a=(0,et.m)(f,m),o=Math.abs(a-r);(0,Bf.Fp)((0,Bf.Wq)(o,0),"Non coplanar ".concat(e,",").concat(t,",").concat(n,",").concat(i," diff = ").concat(o))};g(0,1,2,3),g(4,5,6,7),g(0,1,4,5),g(1,2,5,6),g(2,3,6,7),g(3,0,7,4);var y=(0,u_.bg)(24),b=(0,U.Ue)(),w=(0,U.Ue)(),C=(0,U.Ue)(),x=(0,U.Ue)(),T=function(e,t,n,i){d(b,t),d(w,n),d(C,i),(0,et.z)(b,b,w),(0,et.n)(b,b),(0,et.z)(C,C,w),(0,et.n)(C,C),(0,et.b)(x,b,C),(0,et.n)(x,x);var r=(0,et.m)(x,w);!function(e,t,n){for(var i=4*e,r=0;r<3;++r)y[i+r]=t[r];y[i+3]=n}(e,x,r)};T(0,0,1,2),T(1,1,0,4),T(2,1,5,2),T(3,3,2,6),T(4,4,0,3),T(5,4,6,5);var S=function(e,t,n,i){var r=4*e;return y[r]*t+y[r+1]*n+y[r+2]*i-y[r+3]},k=function(e,t,n,i){return S(e,t,n,i)>=-1},M=function(e,t){return k(e,t[0],t[1],t[2])},P=Math.pow(2,this.lij[0])>2*this.lij[1],R=function(e,t,n){return Math.sqrt(f_(e,t,n,r[0],r[1],r[2]))<i},E=function(e){return R(e[0],e[1],e[2])},O=function(e,t){return R(e[t],e[t+1],e[t+2])},A=this.extentInRadians,D=.5*(A[0]+A[2]),Z=A[1],I=A[3],L=(0,U.Ue)(),N=(0,U.Ue)();v_(L,D,I,u),v_(N,D,Z,u);for(var H=P?"Upper":"Lower",F=!0,V=0;V<6;++V){for(var z=0;z<8;++z){var q=3*z,B=k(V,h[q],h[q+1],h[q+2]);F&&(F=B),(0,Bf.Fp)(B,"Tile[".concat(this.lij,"] Convex hull point ").concat(z," outside of plane ").concat(V))}(0,Bf.Fp)(M(V,N),"Tile[".concat(this.lij,"] (").concat(H,") bottom mid outside of plane ").concat(V)),(0,Bf.Fp)(M(V,L),"Tile[".concat(this.lij,"] (").concat(H,") top mid outside of plane ").concat(V))}(0,Bf.Fp)(F,"Not all convex hull points are inside  convex hull polyhedron"),(0,Bf.Fp)(E(N),"Tile[".concat(this.lij,"] (").concat(H,") bottom mid outside of bounding sphere")),(0,Bf.Fp)(E(L),"Tile[".concat(this.lij,"] (").concat(H,") top mid outside of bounding sphere"));for(var G=0;G<8;++G){var j=O(h,3*G);(0,Bf.Fp)(j,"Tile[".concat(this.lij,"] Convex hull point ").concat(G," outside of bounding sphere"))}for(var W=0;W<6;++W)for(var X=0;X<8;++X){var Q=3*X;k(W,h[Q],h[Q+1],h[Q+2])||console.error("Tile[".concat(this.lij,"] Convex hull point ").concat(X," outside of plane ").concat(W))}var Y=this.extentInRadians,J=Math.max(Y[2]-Y[0],Y[3]-Y[1]),K=Math.round(J*o),$=this.renderData;if($){var ee=$.geometry,te=$.geometryState,ne=$.localOrigin,ie=null===(e=ee.vertexAttributes)||void 0===e?void 0:e.position;if(ie){var re=(0,U.Ue)(),ae=ee.numVerticesPerSide-2,oe=ee.indices,se=ee.indexCount,le=ee.edgeVerticesStartIndex,ue=ee.poleVerticesStartIndex;if(oe)for(var ce=new Set,he=function(e){var n=oe[e];if(ce.has(n))return"continue";ce.add(n);var u=n<ue,h=n>=le,d=!1,f=-1;if(h)for(var v=le,p=0;p<4;++p){var _=te.edgeResolutions[p];if(n===v||n===v+_-1){d=!0;break}if(n<(v+=_)){f=p;break}}var m=h?te.edgePeerNeighbors[f]:null,g=h&&m&&(0,Sv.gl)(t,m)>0;ie.getVec(n,a),(0,et.g)(re,a,ne);var y=(0,et.H)(re)-o,b=0,w=!1,C=s-y,x=y-l,T=C>1,M=x>1,P=T||M,R=function(){var e=u?"internal":h&&!d?"edge":d?"corner":"pole";return"Tile[".concat(t.lij,"].vertex[").concat(n,"]:").concat(e)+(T?"(below)":M?"(above)":"")+(g?"(Neighbor)":"")},E=(0,et.F)(re,r);if(E>=i+0){var O=E-i;P||(console.error("".concat(R()," is out of the bounding sphere by ").concat(O.toFixed(0)," / ").concat(i.toFixed(0),"[tol=").concat(0,"] h=").concat(y.toFixed(0)," / [").concat(s.toFixed(0),"..").concat(l.toFixed(0),"] (").concat((O/i).toFixed(0),")")),w=!0)}for(var A=0;A<6;++A)if(!k(A,re[0],re[1],re[2])){var D=S(A,re[0],re[1],re[2]),Z=n%ae,I=(n-Z)/ae;0===A&&C||5===A&&x||(console.error("".concat(R()," (").concat(Z,",").concat(I,")|").concat(ae,"] is out of the bounding trapezoid plane ").concat(A," h=").concat(Math.round(y)," / [").concat(Math.round(s),"..").concat(Math.round(l),"] dist=").concat(Math.round(D)," radii = ").concat(Math.round(i),"/").concat(Math.round(c),"} : maxL = ").concat(K)),++b)}return w||b>0?"break":void 0},de=0;de<se;++de){var fe=he(de);if("continue"!==fe&&"break"===fe)break}}}}}},{key:"convexHull",get:function(){return this._convexHull}}]),n}(Nv),h_=[128,64,64,32,16,8,8,4];function d_(e,t,n){return f_(e[0],e[1],e[2],t[n],t[n+1],t[n+2])}function f_(e,t,n,i,r,a){var o=i-e,s=r-t,l=a-n;return o*o+s*s+l*l}var v_=function(e,t,n,i){var r=Math.cos(t),a=Math.sin(t),o=Math.cos(n),s=Math.sin(n);e[0]=i*o*r,e[1]=i*o*a,e[2]=i*s},p_=[0,0,1],__=(0,U.Ue)(),m_=(0,U.Ue)(),g_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).fovX=0,e.fovY=0,e.relativeWidthLimit=0,e.relativeHeightLimit=0,e.maxLod=0,e.angledSplitBias=0,e.aboveGround=!0,e}return(0,s.Z)(n)}(Z.default);(0,f._)([(0,E.Cb)()],g_.prototype,"fovX",void 0),(0,f._)([(0,E.Cb)()],g_.prototype,"fovY",void 0),(0,f._)([(0,E.Cb)()],g_.prototype,"relativeWidthLimit",void 0),(0,f._)([(0,E.Cb)()],g_.prototype,"relativeHeightLimit",void 0),(0,f._)([(0,E.Cb)()],g_.prototype,"maxLod",void 0),(0,f._)([(0,E.Cb)()],g_.prototype,"angledSplitBias",void 0),(0,f._)([(0,E.Cb)()],g_.prototype,"aboveGround",void 0),(0,f._)([(0,E.Cb)()],g_.prototype,"frustum",void 0),g_=(0,f._)([(0,A.j)("esri.views.3d.terrain.SplitLimits")],g_);var y_=n(25158),b_=n(92015),w_=(0,gn.U$)().vec3f(wn.T.POSITION).vec2i16(wn.T.UV0).vec2i16(wn.T.NORMALCOMPRESSED,{glNormalized:!0}),C_=function(){function e(t){(0,o.Z)(this,e),this._storage=new Df.N((function(e,n){return t.newCache(e,n)}),"TileGeometry")}return(0,s.Z)(e,[{key:"acquire",value:function(e){var t=4*Math.ceil(e/4),n=this._storage,i=function(e){return e.toString()}(t),r=n.pop(i);if(r)return r;var a=w_.createBuffer(t);return a.release=function(){return n.put(i,a)},a}},{key:"clear",value:function(){this._storage.clear()}},{key:"destroy",value:function(){this._storage.destroy()}}]),e}();var x_=n(35600),T_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).blendMode=x_.iM.Normal,e}return(0,s.Z)(n)}(bt.m);(0,f._)([(0,bt.o)({count:x_.iM.COUNT})],T_.prototype,"blendMode",void 0);var S_=n(57017),k_=n(8966),M_=n(25012),P_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).output=k_.l.Composite,e.baseOpacityMode=S_.I.NotRequired,e.premultipliedSource=M_.m.Off,e}return(0,s.Z)(n)}(T_);(0,f._)([(0,bt.o)({count:k_.l.COUNT})],P_.prototype,"output",void 0),(0,f._)([(0,bt.o)({count:S_.I.COUNT})],P_.prototype,"baseOpacityMode",void 0),(0,f._)([(0,bt.o)()],P_.prototype,"premultipliedSource",void 0);var R_=n(32426),E_=n(86868),O_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).opacity=1,e.baseOpacity=1,e.texture=null,e.fboTexture=null,e.backgroundColor=U.AG,e}return(0,s.Z)(n)}(R_.R),A_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.if)(_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA),colorWrite:mt.BK})}}]),n}(ft.A);A_.shader=new dt.J(E_.B,(function(){return n.e(96654).then(n.bind(n,96654))}));var D_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).background=E_.a.BelowLayer,e}return(0,s.Z)(n)}(P_);(0,f._)([(0,bt.o)()],D_.prototype,"background",void 0);var Z_=function(){function e(t,n,i,r,a,s){(0,o.Z)(this,e),this.texture=t,this.type=n,t.retain(),this.offsetAndScale=(0,st.al)(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=(0,U.al)(r,a,s)}return(0,s.Z)(e,[{key:"destroy",value:function(){this.texture.release()}}]),e}(),I_=n(39395),L_=(n(37995),n(73828)),N_=(n(32344),n(85269),n(8768)),U_=n(38684),H_=n(42121),F_=n(12463),V_=n(36210),z_=n(50127),q_=n(21391);var B_=(0,N_.Ue)(),G_=n(87071),j_=n(47566),W_=function(){function e(){(0,o.Z)(this,e),this._renderParams={reshuffleManager:new j_.y,context:null,drawPhase:1,state:new X_,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new G_.H(new L_.Z(0,0,0,0),0,0,0,512,512,4096,4096),this._heading=0,this._declutteredForHeading=new WeakMap}return(0,s.Z)(e,[{key:"dispose",value:function(){this._renderParams=null}},{key:"renderBackground",value:function(e,t,n,i,r,a,o,s,l,u){var c=this._backgroundTile;this._updateRenderParameters(e,t,c,n,r,a,o,s,l,u),this._renderParams.stencilSymbols=!1,n.drawBackground(this._renderParams,c,i)}},{key:"renderContent",value:function(e,t,n,i,r,a,o,s,l,u,c,h){var d=this;this._declutter(n),i.forAll((function(e){return d._declutter(e.sourceLayerInfo.data)})),this._stencilSymbols(e,t,n,i,r,a,o,Math.round(1/s),l,u,c,h);var f=1;n.stencilRef=f++,e.setStencilFunction(_t.wb.EQUAL,n.stencilRef,255),this._render(e,t,n,r,a,o,s,l,u,c,h),i.forAll((function(t){t.sourceLayerInfo.data.stencilRef=f++,d._renderSymbols(e,t.sourceLod,t.sourceLayerInfo.data,r,a,o,Math.round(1/s),t.offset,u,c,h)}))}},{key:"_stencilSymbols",value:function(e,t,n,r,a,o,s,l,u,c,h,d){var f=1;n.stencilRef=f++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(_t.xS.KEEP,_t.xS.KEEP,_t.xS.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(_t.wb.ALWAYS,n.stencilRef,255),this._stencilTileSymbols(e,t,n,a,o,s,l,u,c,h,d);var v,p=(0,i.Z)(r.toArray());try{for(p.s();!(v=p.n()).done;){var _=v.value,m=_.sourceLod,g=_.offset,y=_.sourceLayerInfo;y.data.stencilRef=f++,e.setStencilFunction(_t.wb.ALWAYS,y.data.stencilRef,255),this._stencilTileSymbols(e,m,y.data,a,o,s,l,g,c,h,d)}}catch(b){p.e(b)}finally{p.f()}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}},{key:"_renderSymbols",value:function(e,t,n,i,r,a,o,s,l,u,c){e.setStencilFunction(_t.wb.EQUAL,n.stencilRef,255),this._render(e,t,n,i,r,a,o,s,l,u,c,q_.fR.SYMBOL)}},{key:"_render",value:function(e,t,n,i,r,a,o,s,l,u,c,h){this._updateRenderParameters(e,t,n,i,a,o,s,l,u,c),this._renderParams.stencilSymbols=!1,i.drawTile(this._renderParams,n,r,h)}},{key:"_stencilTileSymbols",value:function(e,t,n,i,r,a,o,s,l,u,c){this._updateRenderParameters(e,t,n,i,a,o,s,l,u,c),this._renderParams.stencilSymbols=!0,n.triangleCount=0,i.drawSymbols(this._renderParams,n,r)}},{key:"_updateRenderParameters",value:function(e,t,n,i,r,a,o,s,l,u){"type"in n&&"vector-tile"===n.type&&!n.stage&&n.attachWithContext(e);var c=t[0]-r.getLevelShift(t[0]),h=this._renderParams;h.context=e,h.painter=i,h.glyphMosaic=i.glyphMosaic,h.spriteMosaic=i.spriteMosaic,h.pixelRatio=l*u,h.displayLevel=c,h.requiredLevel=c;var d=r.getScale(t[0]),f=r.getOffset(t,a*d),v=(0,Zu.Z)(f,2),p=v[0],_=v[1],m=.125*a*d/s,g=n.transforms.displayViewScreenMat3;g[0]=m,g[4]=-m,g[6]=-1-p-o[0]*a*2,g[7]=1+_+(1-o[1])*a*2-2;var y=h.state,b=s/u;y.size[0]=b,y.size[1]=b,y.pixelRatio=u,y.rotation=(360-this._heading)%360;var w=2/b;(0,Lt.t8)(y.displayViewMat3,w,0,0,0,-w,0,-1,1,1);var C=(0,Lt.yR)(y.displayMat3),x=(0,Tv.c$)(this._heading);(0,Lt.Iu)(C,C,[b/2,b/2]),(0,Lt.U1)(C,C,x),(0,Lt.Iu)(C,C,[-b/2,-b/2]),(0,Lt.Jp)(C,y.displayViewMat3,C)}},{key:"updateHeading",value:function(e){this._heading=e}},{key:"_declutter",value:function(e){this._declutteredForHeading.get(e)!==this._heading&&(function(e,t){var n=e.transforms.tileUnitsToPixels,i=(0,Tv.c$)(t),r=Math.cos(i),a=Math.sin(i),o=Math.ceil(512*(Math.abs(a)+Math.abs(r)));(0,Lt.yR)(B_),(0,Lt.Iu)(B_,B_,[o/2,o/2]),(0,Lt.U1)(B_,B_,i),(0,Lt.Iu)(B_,B_,[-256,-256]),(0,Lt.bA)(B_,B_,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=B_;var s=[],l=new V_.L(4096,s,(function(){return new U_.J})),u=new F_.g(s,l,(function(n,i,r){return new H_.f(n,i,r,e.styleRepository,e.key.level,t)}),(function(e,t){(0,z_.C$)(e,t,!1)}),(function(){return 0}),(function(t){var n=e.styleRepository.getStyleLayerByUID(t).getLayoutProperty("visibility");return!n||n.getValue()!==q_.EE.NONE}));s.push(e),l.add(e),u.setScreenSize(o,o),u.continue(1/0),l.removeTile(e),e.transforms.tileUnitsToPixels=n}(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}}]),e}(),X_=(0,s.Z)((function e(){(0,o.Z)(this,e),this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=(0,Ir.Ue)(),this.displayViewMat3=(0,Ir.Ue)(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null})),Q_=n(87016),Y_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.if)(_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA),colorWrite:mt.BK})}}]),n}(ft.A);Y_.shader=new dt.J(Q_.R,(function(){return n.e(11454).then(n.bind(n,11454))}));var J_=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).colorizerType=I_.U.Stretch,e.stretchType=I_.H.Noop,e.applyColormap=!0,e.requireBilinearWithNN=!1,e}return(0,s.Z)(n)}(P_);(0,f._)([(0,bt.o)({count:I_.U.COUNT})],J_.prototype,"colorizerType",void 0),(0,f._)([(0,bt.o)({count:I_.H.COUNT})],J_.prototype,"stretchType",void 0),(0,f._)([(0,bt.o)()],J_.prototype,"applyColormap",void 0),(0,f._)([(0,bt.o)()],J_.prototype,"requireBilinearWithNN",void 0);var K_=n(3479),$_=function(){function e(t){(0,o.Z)(this,e),this._rctx=t,this._fbos=new Map}return(0,s.Z)(e,[{key:"get",value:function(e){return this._getPool(e)}},{key:"dispose",value:function(){this._fbos.forEach((function(e){return e.dispose()})),this._fbos.clear()}},{key:"_getPool",value:function(e){var t=this._fbos.get(e);if(t)return t;var n=new Qt.X(this._rctx,new Yt.X(e),new K_.Y(_t.Tg.DEPTH24_STENCIL8,e));return this._fbos.set(e,n),n}}]),e}(),em=function(){function e(t,n){(0,o.Z)(this,e),this._rctx=t,this._techniques=n,this._fbos=[],this._vectorTileHelper=new W_,this._bindParameters=new Kt.p(null,null),this._blendLayersTechniqueConfig=new D_,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=(0,St.o)(this._rctx,Tt.Bn)}return(0,s.Z)(e,[{key:"dispose",value:function(){this._fbos.forEach(x.M2),this._fbos=null,this._vtFBO=(0,x.M2)(this._vtFBO),this._vaoQuad=(0,x.M2)(this._vaoQuad),this._vectorTileHelper=(0,x.M2)(this._vectorTileHelper),this._backgroundTechnique=(0,x.RY)(this._backgroundTechnique),this._applyOpacityTechnique=(0,x.RY)(this._applyOpacityTechnique),this._blendLayersTechnique=(0,x.RY)(this._blendLayersTechnique)}},{key:"updateHeading",value:function(e){var t;null===(t=this._vectorTileHelper)||void 0===t||t.updateHeading(e)}},{key:"_getBlendLayersTechnique",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:M_.m.Off,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:E_.a.BelowLayer;return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=n,this._blendLayersTechniqueConfig.premultipliedSource=i,this._blendLayersTechniqueConfig.background=r,this._blendLayersTechnique=this._techniques.releaseAndAcquire(A_,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}},{key:"drawBackground",value:function(e,t){var n=this._getBlendLayersTechnique(x_.iM.Normal,t?k_.l.ColorComposite:k_.l.GridComposite,S_.I.NotRequired,M_.m.Off,E_.a.Only),i=this._rctx.bindTechnique(n,this._bindParameters,e);this._render(i)}},{key:"_render",value:function(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(_t.MX.TRIANGLE_STRIP,0,(0,Tn._V)(this._vaoQuad,"geometry"))}},{key:"drawGroup",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:M_.m.On;t===k_.l.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(n).colorTexture),e.texture=this.currentFBO(n).colorTexture,this.closeGroup(n);var a=e.baseOpacity<1?S_.I.Required:S_.I.NotRequired,o=this._getBlendLayersTechnique(i,t,a,r),s=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(s)}},{key:"drawImageData",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:M_.m.Off;if(null!=e.texture){var a=e.baseOpacity<1?S_.I.Required:S_.I.NotRequired;e.fboTexture=t===k_.l.GroupBackgroundComposite||i===x_.iM.Normal&&a===S_.I.NotRequired&&r===M_.m.Off?null:this.switch(n).colorTexture;var o=this._getBlendLayersTechnique(i,t,a,r),s=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(s)}}},{key:"drawRasterData",value:function(e,t,n,i,r){var a=r.sourceLayerInfo.data;if(a.source&&(r.tile.surface.layerViewByIndex(r.layerIndex,Wh.MAP).ensureSymbolizerParameters(a),a.bind(this._rctx))){var o=e.baseOpacity<1?S_.I.Required:S_.I.NotRequired;e.fboTexture=i===x_.iM.Normal&&o===S_.I.NotRequired?null:this.switch(n).colorTexture;var s=this._getRasterColorizerTechnique(a,t,i,o);a.opacity=e.opacity;var l=a.getUniforms();l.scale=r.scale,l.offset=r.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;var u=this._rctx.bindTechnique(s,null,l);this._render(u)}}},{key:"_getRasterColorizerTechnique",value:function(e,t,n,i){var r=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(r.type);return null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new J_,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=n,this._rasterColorizerConfig.baseOpacityMode=i,this._rasterColorizerConfig.colorizerType=a,this._rasterColorizerConfig.applyColormap=!!r.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?I_.H.Noop:I_.H.PerBand,this._rasterColorizerTechnique=this._techniques.releaseAndAcquire(Y_,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}},{key:"drawVectorData",value:function(e,t,n,i,r,a,o,s){var l=this._rctx,u=r.sourceLayerInfo.data,c=r.tile.surface.layerViewByIndex(r.layerIndex,Wh.MAP),h=e.baseOpacity<1?S_.I.Required:S_.I.NotRequired,d=h===S_.I.Required||e.opacity<1||i!==x_.iM.Normal||t!==k_.l.Composite,f=d?M_.m.On:M_.m.Off,v=this._getBlendLayersTechnique(i,t,h,f);l.setPipelineState(v.getPipeline());var p=null,_=null;d?(_=this.currentFBO(n),null==this._vtFBO&&(this._vtFBO=new $_(this._rctx)),p=this._vtFBO.get(n),l.bindFramebuffer(p),this._clearCurrentFBO()):s&&l.clear(_t.lk.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.renderBackground(l,r.sourceLod,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/r.scale),r.offset,o,a,c.contentZoom),u&&this._vectorTileHelper.renderContent(l,r.sourceLod,u,r.vtlNeighborInfos,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/r.scale),r.offset,o,a,c.contentZoom)}catch(m){C.Z.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",m)}return null==p||(l.bindFramebuffer(_),e.texture=p.colorTexture,e.offset=ut.AG,e.scale=1,this.drawImageData(e,t,n,i,f),s)}},{key:"copyFBOToTexture",value:function(e){var t=this._rctx,n=t.bindTexture(e.texture,xn.x.TEXTURE_UNIT_FOR_UPDATES),i=e.descriptor;t.gl.copyTexImage2D(_t.No.TEXTURE_2D,0,i.pixelFormat,0,0,i.width,i.height,0),e.generateMipmap(),t.bindTexture(n,xn.x.TEXTURE_UNIT_FOR_UPDATES)}},{key:"_clearCurrentFBO",value:function(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(_t.lk.COLOR_BUFFER_BIT|_t.lk.DEPTH_BUFFER_BIT|_t.lk.STENCIL_BUFFER_BIT)}},{key:"_initFBO",value:function(e,t,n){this._rctx.bindFramebuffer(e),n&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}},{key:"ensureBuffer",value:function(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}},{key:"bind",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._current=t,t>=this._fbos.length)for(var i=this._fbos.length;i<=t;i++)this._fbos.push(new $_(this._rctx));this._initFBO(this._fbos[t].get(e),e,n)}},{key:"_bindNextFreeBuffer",value:function(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}},{key:"openGroup",value:function(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}},{key:"switch",value:function(e){var t=this.currentFBO(e),n=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(n),t}},{key:"getLastOnHoldId",value:function(){return this._onHoldIds[this._onHoldIds.length-1]}},{key:"closeGroup",value:function(e){var t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}},{key:"unbind",value:function(){this._rctx.bindFramebuffer(null)}},{key:"currentFBO",value:function(e){return this._fbos[this._current].get(e)}}]),e}(),tm=(0,s.Z)((function e(){(0,o.Z)(this,e),this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new Fl.Z({allocator:function(e){return e||new nm}})})),nm=(0,s.Z)((function e(){(0,o.Z)(this,e),this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]})),im=function(){function e(t,n){(0,o.Z)(this,e),this._texture=t,this._cache=n,this.type="tile-texture",this._refCount=1}return(0,s.Z)(e,[{key:"retain",value:function(){++this._refCount}},{key:"release",value:function(){if(--this._refCount,0===this._refCount)if(this._cache){var e="".concat(this._texture.descriptor.width," ").concat(this._texture.descriptor.pixelFormat);this._cache.put(e,this)}else this.dispose()}},{key:"dispose",value:function(){this._texture.dispose()}},{key:"texture",get:function(){return this._texture}},{key:"generateMipmap",value:function(){this._texture.generateMipmap()}},{key:"descriptor",get:function(){return this._texture.descriptor}},{key:"usedMemory",get:function(){return this._texture.usedMemory}}]),e}(),rm=(0,s.Z)((function e(t,n,i,r,a,s){(0,o.Z)(this,e),this.start=t,this.end=n,this.blendMode=i,this.opacity=r,this.output=a,this.baseOpacity=s})),am=function(){function e(t,n,i,r){(0,o.Z)(this,e),this._rctx=t,this.tileSize=n,this._techniques=i,this._cache=r,this._passParameters=new O_,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new em(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}return(0,s.Z)(e,[{key:"dispose",value:function(){this._compositor=(0,x.M2)(this._compositor),this._backgroundTexture=(0,x.RY)(this._backgroundTexture)}},{key:"backgroundIsGrid",get:function(){return null==this._backgroundColor}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"updateHeading",value:function(e){var t;null===(t=this._compositor)||void 0===t||t.updateHeading(e)}},{key:"updateTileTexture",value:function(e,t){if(e.renderData){var n=e.surface,i=n.baseOpacity,r=0,a=0,o=this.tileSize,s=!1,l=!1,u=n.view.state.contentPixelRatio,c=!1;cm.clear(),hm.length=0;for(var h=e.layerInfo[Wh.MAP],d=0,f=null;d<h.length;d++){var v=n.layerViewByIndex(d,Wh.MAP),p=v.layer.opacity,_=v.fullOpacity;if(l=l||(0,X.sy)(v.layer),(0,Bf.TK)(v)){var m="normal"!==v.layer.blendMode;if((0,X.CY)(v.layer.parent)){var g=sm(v.layer.parent);null!=g&&""!==g&&(m=lm(v.layer.parent)||m)}m&&(c=m,s=!1)}if(0!==p||c){++a;var y=(0,Bf.Q)(v),b=om(e,d,y);if(b){if(h[d].pendingUpdates&=~(Dv.TEXTURE_NOFADING&Dv.TEXTURE_FADING),(0,X.CY)(v.layer.parent)){var w=sm(v.layer.parent);null!=w&&""!==w&&um(v.layer.parent,d)}y?o=Math.max(o,this.tileSize*u):1===i&&1===_&&(v.isOpaque||this._dataToTexture(b)&&b.sourceLayerInfo.data.descriptor.isOpaque)&&(s=!0),++r,null===f&&(f=d)}}else h[d].pendingUpdates&=~(Dv.TEXTURE_NOFADING&Dv.TEXTURE_FADING)}var C=o/this.tileSize,x=this._ensureBackgroundTexture(this.tileSize);0!==r&&null!==f?1===r&&!c&&this._useLayerTexture(e,f)||this._composeLayers(e,t,d-1,l,o,C,!s||c,cm,c):function(e,t,n,i){var r=e.renderData,a=!i&&null!=r.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?yv.Delayed:yv.Immediate;r.setTextureReference(new Z_(n,Qf.Ns.FADING,fm,e.surface.baseOpacity,0,1),a)}(e,a,x,t!==Qf.Ns.FADING)}}},{key:"_ensureBackgroundTexture",value:function(e){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(e),this._passParameters.offset=ut.AG,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}},{key:"_useLayerTexture",value:function(e,t){var n=e.surface.layerViewByIndex(t,Wh.MAP),i=(0,X.sy)(n.layer),r=i?e.surface.baseOpacity:1,a=i?1:e.surface.baseOpacity,o=n.fullOpacity,s=om(e,t,!1);return!!this._dataToTexture(s)&&(e.renderData.setTextureReference(new Z_(s.sourceLayerInfo.data,Qf.Ns.FADING,s,r,a,o)),!0)}},{key:"_composeLayers",value:function(e,t,n,i,r,a,o,s,l){var u=this;this._compositor.ensureBuffer(r);for(var c=e.surface.baseOpacity,h=!1,d=_t.cw.LINEAR_MIPMAP_LINEAR,f=!1,v=0,p=function(t){var n=e.surface.layerViewByIndex(t,Wh.MAP),p=(0,Bf.Q)(n),_=om(e,t,p),m=n.layer.opacity;if(!_||0===m&&!l)return"continue";var g=!(0,X.sy)(n.layer)&&!h;g&&(h=!0);var y=!1;s.forEach((function(e){e.start===t&&(e.output=i?k_.l.Composite:o&&g?u.backgroundIsGrid?k_.l.GridComposite:k_.l.ColorComposite:k_.l.Composite,e.baseOpacity=g?c:1,hm.push(e),u._compositor.openGroup(r),y=!0)}));var b=0===v,w=y?k_.l.GroupBackgroundComposite:o&&b?u.backgroundIsGrid?k_.l.GridComposite:k_.l.ColorComposite:k_.l.Composite,C=x_.pU[(0,Bf.TK)(n)?n.layer.blendMode:"normal"];for(u._passParameters.baseOpacity=g&&!y&&c<1?c:1,u._passParameters.opacity=m,(0,Bf.Ke)(_)?f=u._compositor.drawVectorData(u._passParameters,w,r,C,_,a,u.tileSize,f):(0,Bf.Ay)(_)?(u._compositor.drawRasterData(u._passParameters,w,r,C,_),function(e){var t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}(_)&&(d=_t.cw.NEAREST)):u._dataToTexture(_)&&(u._passParameters.texture=_.sourceLayerInfo.data.texture,u._passParameters.offset=_.offset,u._passParameters.scale=_.scale,u._compositor.drawImageData(u._passParameters,w,r,C));hm.length>0&&hm[hm.length-1].end===t;){var x=hm.pop();u._passParameters.baseOpacity=x.baseOpacity,u._passParameters.opacity=x.opacity,u._passParameters.offset=ut.AG,u._passParameters.scale=1,u._compositor.drawGroup(u._passParameters,x.output,r,x_.pU[x.blendMode])}v++},_=n;_>=0;_--)p(_);var m=e.renderData,g=l||h&&c<1,y=m.ensureTexture(r,g,(function(){return u._buildTexture(r,g,d)}));this._compositor.copyFBOToTexture(y),this._compositor.unbind(),m.setTextureReference(new Z_(y,t,fm,h?1:c,0,1))}},{key:"_dataToTexture",value:function(e){if((0,Bf.S3)(e)){var t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return(0,Bf.z7)(e)}},{key:"setBackground",value:function(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}},{key:"_buildTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:_t.cw.LINEAR_MIPMAP_LINEAR;if(null==e)return null;var i=new Yt.X;i.wrapMode=_t.e8.CLAMP_TO_EDGE,i.samplingMode=n,i.maxAnisotropy=this._maxAnisotropy,i.preMultiplyAlpha=!0,i.flipped=!0,i.hasMipmap=!0,t||(i.pixelFormat=_t.VI.RGB);var r,a=this._rctx;if("number"==typeof e)i.width=i.height=e,r=this._buildTileTexture(i,e);else if((0,Td.Cm)(e))i.isOpaque=e.isOpaque,i.isOpaque&&(i.pixelFormat=_t.VI.RGB),r=this._buildTileTexture(i,e.element.width,e.element);else try{i.width=e.width,i.height=e.height,r=this._buildTileTexture(i,e.width,e)}catch(s){r=new im((0,St.l)(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}var o=a.bindTexture(r.texture,xn.x.TEXTURE_UNIT_FOR_UPDATES);return r.generateMipmap(),a.bindTexture(o,xn.x.TEXTURE_UNIT_FOR_UPDATES),r}},{key:"_buildTileTexture",value:function(e,t,n){var i="".concat(t," ").concat(e.pixelFormat),r=this._cache.pop(i);return r?(r.retain(),r.texture.setData(n),r):new im(new xn.x(this._rctx,e,n),this._cache)}},{key:"test",get:function(){}}]),e}();function om(e,t,n){dm.layerIndex=t,dm.vtlNeighborInfos.clear();var i=e.layerInfo[Wh.MAP][t];if((0,at.t8)(dm.offset,0,0),dm.tile=e,dm.scale=1,dm.sourceLod=e.lij,dm.sourceLayerInfo=i,dm.isVTLBackground=n,i.data)return n&&e.forEachLoadedNeighbor((function(n,r){if(n.level===e.level){var a=n.layerInfo[Wh.MAP][t];if((0,Bf.B9)(a)&&i.data!==a.data){var o=dm.vtlNeighborInfos.pushNew();o.offset=vm[r],o.sourceLod=n.lij,o.sourceLayerInfo=a}}})),dm;var r=i.upsampleInfo;if(r){var a=r.tile.layerInfo[Wh.MAP][t];return dm.tile=r.tile,(0,at.JG)(dm.offset,r.offset),dm.scale=r.scale,dm.sourceLod=r.tile.lij,dm.sourceLayerInfo=a,dm}return n?dm:null}function sm(e){return e.uid}function lm(e){var t="normal"!==e.blendMode;return(0,X.CY)(e.parent)&&(t=lm(e.parent)||t),t}function um(e,t){(0,X.CY)(e.parent)&&um(e.parent,t);var n=sm(e);if(null!=n&&""!==n){var i=cm.get(n);i?i.start=t:cm.set(n,new rm(t,t,e.blendMode,e.opacity,k_.l.Composite,1))}}var cm=new Map,hm=new Array,dm=new tm,fm={offset:[0,0],scale:1},vm=new Array;vm[pv.X.NORTH]=[0,-1],vm[pv.X.NORTH_EAST]=[-1,-1],vm[pv.X.EAST]=[-1,0],vm[pv.X.SOUTH_EAST]=[-1,1],vm[pv.X.SOUTH]=[0,1],vm[pv.X.SOUTH_WEST]=[1,1],vm[pv.X.WEST]=[1,0],vm[pv.X.NORTH_WEST]=[1,-1];var pm=1e-6;var _m=(0,s.Z)((function e(t,n,i,r,a){(0,o.Z)(this,e),this.aabb=t,this.axis=n,this.d=i,this.midStartIndex=r,this.rightStartIndex=a})),mm=function(){function e(t,n,i,r){var a=this;(0,o.Z)(this,e),this.globalTriangleVertexIndices=t,this.firstTriangleIndex=n,this.positions=r,this._rayDirection=(0,U.Ue)(),this._callback=xm,this._intersectionOptions=Cm,this.bspNodeTree=new Array;var s=i-n,l=new(s<bm?Uint8Array:s<wm?Uint16Array:Uint32Array)(s);this.triangleIndexMap=l;for(var u=0;u<s;++u)l[u]=u;var c=function(e,t,n,i,r){for(var a=n-t,o=new Float32Array(6*a),s=0;s<a;++s)for(var l=3*(s+t),u=e[l]*r,c=e[l+1]*r,h=e[l+2]*r,d=0;d<3;++d){var f=i[u+d],v=i[c+d],p=i[h+d];o[6*s+d]=Math.min(f,v,p),o[6*s+3+d]=Math.max(f,v,p)}return o}(t,n,i,r.data,r.stride),h=(0,Se.uZ)(Math.log2(s/40),2,10);!function e(t,n,i){var r=function(e,t,n,i){if(i<=n)return(0,vv.al)(NaN,NaN,NaN,NaN,NaN,NaN);for(var r=6*e[n],a=0;a<3;++a)gm[a]=t[r+0+a],ym[a]=t[r+3+a];for(var o=n+1;o<i;++o)for(var s=6*e[o],l=0;l<3;++l)gm[l]=Math.min(gm[l],t[s+0+l]),ym[l]=Math.max(ym[l],t[s+3+l]);return(0,vv.al)(gm[0],gm[1],gm[2],ym[0],ym[1],ym[2])}(l,c,t,n),o=n-t;if(o<=40){var s=new _m(r,void 0,0,t,n);return a.bspNodeTree.push(s),s}var u=function(e){var t=e[3]-e[0],n=e[4]-e[1],i=e[5]-e[2],r=t>n?t>i?0:n>i?1:2:n>i?1:i>t?2:0;return{axis:r,midValue:(e[r]+e[r+3])/2}}(r),d=u.axis,f=u.midValue,v=function(e,t,n,i,r,a){for(var o=n,s=i;o<s;){var l=e[o];t[6*l+r+3]<=a?++o:(--s,e[o]=e[s],e[s]=l)}var u=o;for(s=i;u<s;){var c=e[s-1];t[6*c+r]>=a?--s:(e[s-1]=e[u],e[u]=c,++u)}return{next:o,mid:u}}(l,c,t,n,d,f),p=function(t,n){if(!(i>h)){var r=n-t;return r<40||r>=.8*o?void 0:e(t,n,i+1)}},_=new _m(r,d,f,v.next,v.mid);return a.bspNodeTree.push(_),_.leftNode=p(t,v.next),_.rightNode=p(v.mid,n),_}(0,s,0)}return(0,s.Z)(e,[{key:"intersectRayTriangleRange",value:function(t,n){if(!(t>=n)){var i=this.positions;(0,i_.ET)(this._rayFrom,this._rayDirection,t,n,this.globalTriangleVertexIndices,i.data,i.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),e.numFacesTested+=n-t}}},{key:"intersectRay",value:function(t,n,i,r){e.numFacesTested=0;var a=t,o=n,s=o[0]-a[0],l=o[1]-a[1],u=o[2]-a[2];if(!(s*s+l*l+u*u<pm)){this._rayFrom=a;var c=this._rayDirection;c[0]=s,c[1]=l,c[2]=u;var h=this.triangleIndexMap.length;this._callback=r,this._intersectionOptions=i,this.intersectRayBSP(this.bspNodeTree[0],0,h),this._callback=xm,this._intersectionOptions=Cm}}},{key:"intersectRayBSP",value:function(e,t,n){var i=this._rayFrom,r=this._rayDirection;if(function(e,t,n){for(var i=t,r=n,a=0,o=1/0,s=0;s<3;++s){var l=e[s];if(i[s]<l){if(r[s]<=pm)return!1;var u=(l-i[s])/r[s];a=Math.max(a,u)}else if(r[s]<=-1e-6){var c=(l-i[s])/r[s];o=Math.min(o,c)}if(a>o)return!1;var h=e[s+3];if(i[s]>h){if(r[s]>=-1e-6)return!1;var d=(h-i[s])/r[s];a=Math.max(a,d)}else if(r[s]>=pm){var f=(h-i[s])/r[s];o=Math.min(o,f)}if(a>o)return!1}return!0}(e.aabb,i,r)){var a=e.axis,o=e.d;if(i[a]<o||r[a]<0){var s=t,l=e.midStartIndex;if(s<l){var u=e.leftNode;void 0!==u?this.intersectRayBSP(u,s,l):this.intersectRayTriangleRange(s,l)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),i[a]>o||r[a]>0){var c=e.rightStartIndex,h=n;if(c<h){var d=e.rightNode;void 0!==d?this.intersectRayBSP(d,c,h):this.intersectRayTriangleRange(c,h)}}}}},{key:"estimatedMemoryUsage",get:function(){return this.triangleIndexMap.byteLength}}]),e}();mm.numFacesTested=0;var gm=[1/0,1/0,1/0],ym=[-1/0,-1/0,-1/0];var bm=255,wm=65535,Cm=new i_.sT,xm=function(){},Tm=n(55375),Sm=n(91526),km=n(73059),Mm=n(16010),Pm=n(60113),Rm=n(41481),Em=n(22702),Om=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).output=ep.H_.Color,e.overlayMode=Em.gT.Disabled,e.tileBlendInput=Tm.R.LayerOnly,e.spherical=!1,e.doublePrecisionRequiresObfuscation=!1,e.receiveShadows=!1,e.hasSlicePlane=!1,e.backfaceCullingEnabled=!1,e.textureFadingEnabled=!1,e.renderOccluded=!1,e.hasScreenSpaceReflections=!1,e.hasCloudsReflections=!1,e.invisible=!1,e.opaque=!0,e.tileBorders=!1,e.visualizeNormals=!1,e.screenSizePerspective=!1,e.receiveAmbientOcclusion=!1,e.pbrMode=Rm.f7.Simplified,e}return(0,s.Z)(n)}(n(8883).W);(0,f._)([(0,bt.o)({count:ep.H_.COUNT})],Om.prototype,"output",void 0),(0,f._)([(0,bt.o)({count:Em.gT.COUNT})],Om.prototype,"overlayMode",void 0),(0,f._)([(0,bt.o)({count:Tm.R.COUNT})],Om.prototype,"tileBlendInput",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"spherical",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"receiveShadows",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"hasSlicePlane",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"backfaceCullingEnabled",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"textureFadingEnabled",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"renderOccluded",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"hasScreenSpaceReflections",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"hasCloudsReflections",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"invisible",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"opaque",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"tileBorders",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"visualizeNormals",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"screenSizePerspective",void 0),(0,f._)([(0,bt.o)()],Om.prototype,"receiveAmbientOcclusion",void 0),(0,f._)([(0,bt.o)({count:Rm.f7.COUNT})],Om.prototype,"pbrMode",void 0),(0,f._)([(0,bt.o)({constValue:Mm.r.Compressed})],Om.prototype,"normalType",void 0),(0,f._)([(0,bt.o)({constValue:Pm.N.Compressed})],Om.prototype,"textureCoordinateType",void 0),(0,f._)([(0,bt.o)({constValue:!1})],Om.prototype,"highStepCount",void 0),(0,f._)([(0,bt.o)({constValue:!1})],Om.prototype,"useCustomDTRExponentForWater",void 0),(0,f._)([(0,bt.o)({constValue:!1})],Om.prototype,"useFillLights",void 0),(0,f._)([(0,bt.o)({constValue:!0})],Om.prototype,"hasColorTexture",void 0);var Am,Dm=(0,vv.Ue)();!function(e){e[e.Opaque=0]="Opaque",e[e.Semitransparent=1]="Semitransparent",e[e.TransparentWithDraped=2]="TransparentWithDraped",e[e.Empty=3]="Empty"}(Am||(Am={}));var Zm=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a,s){var l;return(0,o.Z)(this,n),(l=t.call(this,{}))._overlayRenderer=e,l._stage=i,l._allTiles=r,l._ellipsoidRadius=a,l.type=mh.q7.TERRAIN,l.isGround=!0,l._tileSize=256,l._techniqueConfiguration=new Om,l._passParameters=new tp.T,l._drawParameters=new km.w,l._renderDataPool=new Iu.Z(ap),l._visiblePatchesByOrigin=new Map,l._allPatchesByOrigin=new Map,l._patchesByOriginDirty=!0,l._patchSortingDirty=!0,l._tileIterator=new Sv.AA,l._transparencyState=Am.Opaque,l._castShadows=!1,l._inViewshed=!1,l._emptyTex=null,l._tileRenderer=null,l._stencilEnabledLayerExtents=new Array,l._numTilesRendered=0,l._numTilesCulled=0,l._numOriginsRendered=0,l.renderOccludedFlags=ev.yD.Occlude,l.produces=new Map([[fi.r.OPAQUE_TERRAIN,function(){return l._produces()}],[fi.r.TRANSPARENT_TERRAIN,function(){return l._produces()}],[fi.r.OCCLUDED_TERRAIN,function(){return l._produces()}]]),l._tileTextureCache=new Df.N((function(e,t){return s.newCache(e,t)}),"TileTexture"),l.tileGeometryCache=new C_(s),l}return(0,s.Z)(n,[{key:"_isGlobal",get:function(){return this._stage.viewingMode===he.JY.Global}},{key:"_techniques",get:function(){return this._context.techniques}},{key:"_rctx",get:function(){return this._context.renderContext.rctx}},{key:"normalizeCtorArgs",value:function(){return{}}},{key:"initialize",value:function(){var e=this;this._stage.addRenderPlugin(this),this.addHandles((0,k.watch)((function(){return e._overlayRenderer.rendersOccludedDraped}),(function(t){e.renderOccludedFlags=t?Jf.Qi:ev.yD.Occlude,e.setNeedsRender()}),k.sync))}},{key:"destroy",value:function(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}},{key:"_produces",value:function(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}},{key:"consumes",value:function(){return this._overlayRenderer.hasWater?di.of:di.jt}},{key:"renderingDisabled",set:function(e){this._set("renderingDisabled",!!e),this.setDirty()}},{key:"visible",set:function(e){this._set("visible",!!e),this.setDirty()}},{key:"updateHeading",value:function(e){var t;null===(t=this._tileRenderer)||void 0===t||t.updateHeading(e)}},{key:"transparency",get:function(){return this._transparencyState},set:function(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===Am.TransparentWithDraped||e===Am.Empty,this._techniqueConfiguration.opaque=e===Am.Opaque,this._transparencyState=e,this.setNeedsRender())}},{key:"renderPatchBorders",get:function(){return!!this._techniqueConfiguration.tileBorders},set:function(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}},{key:"visualizeNormals",get:function(){return!!this._techniqueConfiguration.visualizeNormals},set:function(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}},{key:"cullBackFaces",get:function(){return this._techniqueConfiguration.backfaceCullingEnabled},set:function(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}},{key:"renderOrder",set:function(e){this._set("renderOrder",e),this._setSortingDirty()}},{key:"layerUid",get:function(){return ya.xX}},{key:"slicePlaneEnabled",get:function(){return this._techniqueConfiguration.hasSlicePlane},set:function(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}},{key:"textureFadingEnabled",set:function(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}},{key:"pbrMode",set:function(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}},{key:"setDebugScreenSizePerspective",value:function(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}},{key:"setRootTiles",value:function(e){this._rootTiles=e,this.setDirty()}},{key:"setStencilEnabledLayerExtents",value:function(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}},{key:"setTileSize",value:function(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}},{key:"_prepareTileForLoading",value:function(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}},{key:"loadTile",value:function(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,Dv.TEXTURE_FADING)}},{key:"updateTileTexture",value:function(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===Dv.TEXTURE_FADING?Qf.Ns.FADING:Qf.Ns.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}},{key:"updateTileGeometryState",value:function(e){var t,n=(0,i.Z)(e.layerInfo[Wh.ELEVATION]);try{for(n.s();!(t=n.n()).done;){t.value.pendingUpdates&=~Dv.GEOMETRY}}catch(a){n.e(a)}finally{n.f()}e.resetPendingUpdate(Dv.GEOMETRY);var r=e.renderData.updateGeometryState();return r&&this.setDirty(),r}},{key:"updateGeometryIfNeeded",value:function(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}},{key:"unloadTile",value:function(e){var t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}},{key:"_getLocalOriginOfTile",value:function(e){var t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return U.AG;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}},{key:"getStats",value:function(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}},{key:"wireframe",set:function(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}},{key:"setDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Kf.Xx.UPDATE;this._patchesByOriginDirty=!0,this._context.requestRender(e)}},{key:"_setSortingDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Kf.Xx.UPDATE;this._patchSortingDirty=!0,this._context.requestRender(e)}},{key:"setNeedsRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Kf.Xx.UPDATE;this._context.requestRender(e)}},{key:"initializeRenderContext",value:function(e){this._context=e,this._tileRenderer=new am(this._rctx,this._tileSize,this._techniques,this._tileTextureCache),this.updateTileBackground(),this._emptyTex=(0,St.l)(this._rctx)}},{key:"uninitializeRenderContext",value:function(){this._emptyTex=(0,x.M2)(this._emptyTex),this._tileRenderer=(0,x.M2)(this._tileRenderer)}},{key:"intersect",value:function(e,t,n,i){var r=this;if(!(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==Am.Opaque)){var a=Im,o=Lm;(0,et.f)(a,i,n),(0,et.s)(o,1/a[0],1/a[1],1/a[2]);var s,l=e.results.min,u=e.results.max,c=e.results.ground,h=e.options.store===mh.eC.MIN,d=!!e.results.ground.target,f=(0,ya.lV)(e.verticalOffset),v=e.tolerance,p=h&&null!=l.dist?l.dist:1/0,_=e.options,m=_.normalRequired||!_.backfacesTerrain,g=new i_.sT(!1,m),y=function(d){var y=d.renderData;if(null!==y&&void 0!==y&&y.vao){var b=y.geometry;(0,vv.t8)(Dm,b.boundingBox);var w=y.localOrigin;null!=f&&(f.localOrigin=w,f.applyToAabb(Dm));var C=Dm;if(Nm[0]=n[0]-w[0],Nm[1]=n[1]-w[1],Nm[2]=n[2]-w[2],(0,i_.Fw)(C,Nm,o,v,p)){var x=function(e,t,n){e.set(r.type,d,t,n,Ut.Wd),p=h&&null!=l.dist?l.dist:1/0},T=function(r,o,h){if((!m||null!=h)&&r>=0&&(_.backfacesTerrain||(0,et.m)(h,a)<0)&&(_.invisibleTerrain||!_.selectionMode||null==t||t(n,i,r))){if((null==c.dist||r<c.dist)&&x(c,r,h),_.isFiltered)return;_.store===mh.eC.ALL&&(null==s?(s=(0,ea.LP)(e.ray),x(s,r,h),e.results.all.push(s)):r<s.dist&&x(s,r,h)),(null==l.dist||r<l.dist)&&x(l,r,h),_.store!==mh.eC.MIN&&(null==u.dist||r>u.dist)&&x(u,r,h)}},S=Um;(0,et.f)(S,i,w);var k=b.indices,M=b.indexCount,P=b.vertexAttributes,R=P.getField(wn.T.POSITION,y_.ct),E=new Sm.U(R.typedBuffer,3,P.stride/4),O=M/3;if(!f&&O>200){var A=d.renderData;null==A.intersectionData&&(A.intersectionData=new mm(k,0,O,E)),A.intersectionData.intersectRay(Nm,S,g,T)}else(0,i_.CN)(Nm,S,0,O,k,E,f,g,T)}}},b=this._rootTiles;null!=b&&function(){var t=r._tileIterator;t.reset(b);for(var i=e.options.invisibleTerrain,o=t.next();o;o=t.next())!(o.visible||i&&o.intersectsClippingArea)||null==f&&!o.intersectsRay(n,a,v,p)||d&&r._useStencilForTile(o)?t.skipSubtree():y(o)}()}}},{key:"processScaleRangeQueries",value:function(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();var n,r=(0,i.Z)(this._visiblePatchesByOrigin.values());try{for(r.s();!(n=r.n()).done;){var a,o=n.value,s=(0,i.Z)(o);try{for(s.s();!(a=s.n()).done;){var l,u=a.value;null!=(null===(l=u.renderData)||void 0===l?void 0:l.textureReference)&&e.queriesForTile(u)}}catch(c){s.e(c)}finally{s.f()}}}catch(c){r.e(c)}finally{r.f()}e.process(),t.madeProgress()}}},{key:"prepareTechnique",value:function(e){var t=(0,w.Z)("enable-feature:terrain-shadows")&&e.bindParameters.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);var n=e.bindParameters.viewshedEnabled;if(this._inViewshed!==n&&(this._inViewshed=n,this._patchesByOriginDirty=!0),e.bindParameters.slot===fi.r.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&Jf.Qi))return null}else{var i=this.transparency===Am.Opaque?fi.r.OPAQUE_TERRAIN:fi.r.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==i)return null}if(this.transparency===Am.Empty)return null;switch(e.output){case ep.H_.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=null!=e.bindParameters.ssr.lastFrameColor,this._techniqueConfiguration.hasCloudsReflections=null!=e.bindParameters.cloudsFade.data,this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=null!=e.bindParameters.ssao,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,this._updateTechnique(ep.H_.Color,e.bindParameters.slot===fi.r.OCCLUDED_TERRAIN);case ep.H_.Shadow:case ep.H_.ShadowExcludeHighlight:return this._castShadows?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ep.H_.Shadow,!1)):null;case ep.H_.ViewshedShadow:return this._inViewshed?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ep.H_.ViewshedShadow,!1)):null;case ep.H_.Depth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ep.H_.Depth,!1);case ep.H_.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ep.H_.Normal,!1);case ep.H_.ObjectAndLayerIdColor:return this._updateTechnique(ep.H_.ObjectAndLayerIdColor,!1);case ep.H_.Highlight:return this._overlayRenderer.hasHighlights?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ep.H_.Highlight,!1)):null}return null}},{key:"renderNode",value:function(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case ep.H_.Color:var n=e.bindParameters.slot===fi.r.OCCLUDED_TERRAIN?b_.D.Occluded:b_.D.Color;this._renderMaterialPass(e,t,n);break;case ep.H_.Depth:case ep.H_.Normal:this._renderAuxiliaryPass(e,t,b_.D.Color,this._visiblePatchesByOrigin);break;case ep.H_.Highlight:this._renderAuxiliaryPass(e,t,b_.D.Highlight,this._visiblePatchesByOrigin);break;case ep.H_.Shadow:case ep.H_.ShadowExcludeHighlight:case ep.H_.ViewshedShadow:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case ep.H_.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,b_.D.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}},{key:"updateTileBackground",value:function(e){if(null!=this._tileRenderer){var t,n=this._tileRenderer;if(null!=e){var i=zh.Z.toUnitRGBA(e);t=(0,U.al)(i[0]||0,i[1]||0,i[2]||0)}n.setBackground(t),this._allTiles.forAll((function(e){return n.updateTileTexture(e,Qf.Ns.FADING)})),this._techniqueConfiguration.tileBlendInput=n.backgroundIsGrid?Tm.R.GridComposite:null!=n.backgroundColor?Tm.R.ColorComposite:Tm.R.LayerOnly,this.setNeedsRender()}}},{key:"_updatePatchGroups",value:function(){var e=this;if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==o_.z.NONE){for(var t=Array.from(this._visiblePatchesByOrigin.values()),n=this._stencilEnabledLayerExtents,i=0,r=t;i<r.length;i++){var a=r[i];(0,Sv.zW)(this.renderOrder,a,n)}t.sort((function(t,n){return(0,Sv.dF)(t[0],n[0],e.renderOrder)})),this._visiblePatchesByOrigin=new Map(t.map((function(e){return[e[0].renderData.localOrigin,e]}))),this._patchSortingDirty=!1}}},{key:"_rebuildPatchGroups",value:function(){var e=this._rootTiles;if(null!=e){var t;null!==(t=e[0])&&void 0!==t&&t.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();var n,r=(0,i.Z)(e);try{for(r.s();!(n=r.n()).done;){var a=n.value;this._rebuildPatchGroupsForRootTile(a)}}catch(o){r.e(o)}finally{r.f()}}}},{key:"_rebuildPatchGroupsForRootTile",value:function(e){var t=this._tileIterator;for(t.resetOne(e);!t.done;){var n=t.next(),i=n.renderData;if(i){var r=i.localOrigin;if(this._castShadows||this._inViewshed){var a=this._allPatchesByOrigin.get(r);a||(a=[],this._allPatchesByOrigin.set(r,a)),a.push(n)}if(n.visible){var o=this._visiblePatchesByOrigin.get(r);o||(o=[],this._visiblePatchesByOrigin.set(r,o)),o.push(n),t.skipSubtree()}else this._numTilesCulled++,t.skipSubtree()}else this._numTilesCulled++}}},{key:"_useStencilForTile",value:function(e){var t,n=(0,i.Z)(this._stencilEnabledLayerExtents);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(e.intersectsExtent(r))return!0}}catch(a){n.e(a)}finally{n.f()}return!1}},{key:"_renderAuxiliaryPass",value:function(e,t,n,i){var r=this,a=e.rctx;this._passParameters.overlayContent=n,a.bindTechnique(t,e.bindParameters,this._passParameters);var o=this._stencilEnabledLayerExtents.length>0;i.forEach((function(i){r._drawParameters.origin=i[0].renderData.localOrigin,t.program.bindDraw(r._drawParameters,e.bindParameters,r._passParameters);for(var a=0;a<i.length;a++)r._renderPatch(e,t,i[a],_t.MX.TRIANGLES,o,n)})),e.rctx.bindVAO(null)}},{key:"_renderMaterialPass",value:function(e,t,n){var r,a=e.rctx;this._passParameters.overlayContent=n,a.bindTechnique(t,e.bindParameters,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;var o=e.bindParameters.camera,s=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){var l=(0,$l.Gw)(this._stage.viewingMode,this._ellipsoidRadius),u=this.pointsOfInterest.centerOnSurfaceFrequent.distance;l.update({distance:u,fovY:o.fovY})}var c=this._stencilEnabledLayerExtents.length>0,h=n===b_.D.Occluded;h&&(s.bindTexture("tex",this._emptyTex),s.setUniform3fv("textureOpacities",U.AG),s.setUniform4fv("texOffsetAndScale",st.AG));var d=null!=(null===(r=this._tileRenderer)||void 0===r?void 0:r.backgroundColor)?this._tileRenderer.backgroundColor:U.AG;this._techniqueConfiguration.tileBlendInput===Tm.R.ColorComposite&&s.setUniform3fv("backgroundColor",d);var f=this.wireframe?_t.MX.LINES:_t.MX.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&s.bindTexture("texNext",this._emptyTex);var v,p=this._visiblePatchesByOrigin,_=(0,i.Z)(p.values());try{for(_.s();!(v=_.n()).done;){var m=v.value,g=m[0].renderData.localOrigin;t.program.bindDraw(new km.w(g),e.bindParameters,this._passParameters),this._numOriginsRendered++;var y,b=(0,i.Z)(m);try{for(b.s();!(y=b.n()).done;){var w=y.value,C=w.renderData,x=C.textureReference;if(null!=x){if(!h){s.setUniform4fv("texOffsetAndScale",x.offsetAndScale),s.bindTexture("tex",x.texture.texture);var T=C.textureFadeFactor,S=T<1?C.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&null!=S&&T<1?(s.setUniform1f("fadeFactor",T),s.setUniform4fv("nextTexOffsetAndScale",S.offsetAndScale),s.setUniform3fv("nextTexOpacities",S.opacities),s.bindTexture("texNext",S.texture.texture)):s.setUniform1f("fadeFactor",1),C.textureIsFading&&this.setNeedsRender(),s.setUniform3fv("textureOpacities",x.opacities)}this._renderPatch(e,t,w,f,c,n),w.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}catch(k){b.e(k)}finally{b.f()}}}catch(k){_.e(k)}finally{_.f()}e.rctx.bindVAO(null)}},{key:"_renderPatch",value:function(e,t,n,i,r,a){var o=n.renderData,s=o.vao,l=null===s||void 0===s?void 0:s.indexBuffer;if(s&&null!=l){var u=t.program;null==a||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(u,o.overlay),r&&(t.useStencil=this._useStencilForTile(n),e.rctx.setPipelineState(t.getPipeline()));var c=o.geometry.indexCount;e.rctx.bindVAO(s),u.assertCompatibleVertexAttributeLocations(s),e.rctx.drawElements(i,c,l.indexType,0)}else Bf.T9&&console.error("Rendered tile with no indices: ",n.lij," : ",o)}},{key:"_bindOverlayPatchData",value:function(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}},{key:"_updateTechnique",value:function(e,t){return this._techniqueConfiguration.output=e,this._techniqueConfiguration.renderOccluded=t,this._shaderTechnique=this._techniques.releaseAndAcquire(ip,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}},{key:"test",get:function(){}}]),n}(di.He);(0,f._)([(0,E.Cb)({readOnly:!0})],Zm.prototype,"_isGlobal",null),(0,f._)([(0,E.Cb)()],Zm.prototype,"renderOccludedFlags",void 0),(0,f._)([(0,E.Cb)({value:!1})],Zm.prototype,"renderingDisabled",null),(0,f._)([(0,E.Cb)({value:!0})],Zm.prototype,"visible",null),(0,f._)([(0,E.Cb)()],Zm.prototype,"renderPatchBorders",null),(0,f._)([(0,E.Cb)()],Zm.prototype,"visualizeNormals",null),(0,f._)([(0,E.Cb)()],Zm.prototype,"cullBackFaces",null),(0,f._)([(0,E.Cb)({value:o_.z.FRONT_TO_BACK})],Zm.prototype,"renderOrder",null),(0,f._)([(0,E.Cb)()],Zm.prototype,"wireframe",null),Zm=(0,f._)([(0,A.j)("esri.views.3d.terrain.TerrainRenderer")],Zm);var Im=(0,U.Ue)(),Lm=(0,U.Ue)(),Nm=(0,U.Ue)(),Um=(0,U.Ue)(),Hm=(0,s.Z)((function e(){(0,o.Z)(this,e),this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array})),Fm=n(82575),Vm=n(62140),zm=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){return(0,o.Z)(this,n),t.call(this,e)}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([this.layers.on("change",(function(){return e._update()})),(0,k.watch)((function(){return e.extentHelper.layerViewsExtent}),(function(){return e._setAdHocTilingScheme()}))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}},{key:"destroy",value:function(){this._waitTask=null,this.layers.destroy()}},{key:"_update",value:function(){var e,t=this;if((this._waitTask=null,!this.tilingSchemeLocked)&&(this.layers.some((function(n){return!(!(0,X.iC)(n)||n.isRejected())&&!(n.isFulfilled()&&!function(e,t,n){return null!=(0,Bf.E_)(e,t,n)}(n,t.viewSpatialReference,t.viewingMode))&&(e=n,!("vector-tile"===(null===n||void 0===n?void 0:n.type)||(0,Bf.x4)(n)))})),e))if(e.isResolved()){var n=(0,Bf.E_)(e,this.viewSpatialReference,this.viewingMode);if(null!=n){var i=new Vm.t(n.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}},{key:"_updateWhen",value:function(e){var t=this,n=e.when().catch((function(){})).then((function(){n!==t._waitTask||t.destroyed||t._update()}));this._waitTask=n}},{key:"_lockTilingScheme",value:function(e){var t=this;if(this.viewingMode===he.JY.Global){var n=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=Vm.t.makeWebMercatorAuxiliarySphere(n):(0,Fm.O)(i)&&(e=Vm.t.makeGCSWithTileSize(e.spatialReference,e.pixelSize,n))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles((0,k.watch)((function(){return t.extentHelper.tiledLayersExtent}),(function(){return t._updateTiledLayerExtent()})))}},{key:"_updateTiledLayerExtent",value:function(){this._set("extent",this.extentHelper.tiledLayersExtent)}},{key:"_setAdHocTilingScheme",value:function(){if(this.viewingMode===he.JY.Global){var e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=Vm.t.WebMercatorAuxiliarySphere:(0,Fm.M)(e)&&(this.tilingScheme=Vm.t.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{var t=this.extentHelper.layerViewsExtent;null==t||(0,B.fS)(t,this.extent)||(this.tilingScheme=Vm.t.fromExtent(t,this.extentHelper.viewSpatialReference),this._set("extent",t))}}},{key:"test",get:function(){}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],zm.prototype,"tilingScheme",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],zm.prototype,"extent",void 0),(0,f._)([(0,E.Cb)({value:!1})],zm.prototype,"tilingSchemeLocked",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],zm.prototype,"viewSpatialReference",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],zm.prototype,"layers",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],zm.prototype,"extentHelper",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],zm.prototype,"viewingMode",void 0),zm=(0,f._)([(0,A.j)("esri.views.3d.terrain.TilingSchemeLogic")],zm);var qm,Bm=function(){function e(){(0,o.Z)(this,e),this.offset=(0,ut.Ue)(),this.scale=0,this.tile=null}return(0,s.Z)(e,[{key:"init",value:function(e,t,n,i){this.tile=e,this.offset[0]=t,this.offset[1]=n,this.scale=i}},{key:"dispose",value:function(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}]),e}(),Gm=qm=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(e){var n,i,a,s,u;return(0,o.Z)(this,r),(u=t.call(this,e))._scaleRangeQueries=new l_,u._iteratorPool=new Iu.Z(Sv.AA,(function(e){return e.remove=function(){return u._iteratorPool.release(e)}})),u._postorderIterator=new Sv.rv,u._hasPendingUpdates=!1,u._pendingUpdates=0,u._asyncWorkItems=0,u._allTilesDirty=!0,u._allTilesSorted=!0,u._usedMemory=null,u._performanceInfo=new Hm,u._viewChanged=!1,u.heading=0,u._inFrameTask=!1,u._viewChangeUpdateDirty=!1,u._eyePosRenderSR=(0,U.Ue)(),u._eyePosSurfaceSR=(0,U.Ue)(),u._splitLimits=new g_,u._frustum=(0,Au.Ue)(),u._viewProjectionMatrix=(0,Ut.Ue)(),u._layerViews=[new Array,new Array],u._layerIndexByUid=[new Map,new Map],u._basemapLayerViewHandles=new Map,u._watchUpdatingTracking=new Jn.R,u._frameTask=$t.sq,u._allTiles=new Fl.Z,u._upsampleInfoPool=new Iu.Z(Bm),u._shouldEmitChangeEvent=!1,u._rootTilesExtent=(0,B.Ue)(),u.updatingProgress=.5,u._maxNumUpdating=1,u.maxTextureScale=1.2,u._spatialReference=ee.Z.WebMercator,u._elevationProjectorCache=new Map,u.visibleElevationBounds=new Hf(1/0,-1/0),u.rootTileElevationBounds=new Hf(1/0,-1/0),u._sebProjectorMap=new Map,u._sebProjectorCache=(0,Uu.sw)(),u._tilingSchemeSpatialReference=null,u._updatingRootTiles=!1,u._pendingTilesForElevationUpdateEvent=new Set,u._pendingTilesToUpdate=new Set,u.totalGeometryUpdates=0,u.totalTileUpdates=0,u._oneBatchPerFrameTask=!0,u._layerViewsDirty=!1,u.unloadedMemory=0,u.ignoresMemoryFactor=!1,u._isWebMercator=!1,u._isWebMercatorOnPlateCarree=!1,u.overlayManager=new av((0,He.Z)((0,He.Z)({},e),{},{surface:(0,l.Z)(u)})),u._isGlobal=!(null!==(n=e.view)&&void 0!==n&&null!==(i=n.state)&&void 0!==i&&i.isLocal),u._isGeographic=null!==(a=null===(s=u._spatialReference)||void 0===s?void 0:s.isGeographic)&&void 0!==a&&a,u._tileConstructor=u._isGlobal?c_:r_,u}return(0,s.Z)(r,[{key:"initialize",value:function(){var e=this,t=this.view,i=t.resourceController,r=i.memoryController;this._tileCache=new Df.N((function(e,t){return r.newCache(e,t)}),"terrain-tile"),this._upsampleMapCache=r.newCache("terrain-upsample",(function(e){return e.unloadMapData()})),this._elevationQueryCache=new If.b(r.newCache("elevation-query"));var a=this.overlayManager;this._renderer=new Zm(a.renderer,t._stage,this._allTiles,(0,nt.Iu)(t.spatialReference).radius,r),this.addHandles([(0,k.watch)((function(){return a.renderer.isEmpty}),(function(){return e._evaluateTransparency()})),(0,k.watch)((function(){return e.renderer.visible}),(function(t){return e.suspended=!t})),(0,k.watch)((function(){return e.heading}),(function(t){e._renderer.updateHeading(t),e._updateTileTextures(Qf.Ns.FADING)})),(0,k.watch)((function(){var e,n;return{heading:null===(e=t.camera)||void 0===e?void 0:e.heading,state:null===(n=t.state)||void 0===n?void 0:n.mode}}),(function(t){var n=t.heading,i=t.state;if(null!=n)if(e.isGlobal&&e.isGeographic||e.isWebMercatorOnPlateCarree)e.heading=90*Math.round(n/90)%360;else{var r=Math.round(n)%360,a=Math.abs(r-e.heading);(i===rs.n.IDLE||Math.min(a,360-a)>=30)&&(e.heading=r)}}))],"overlayManager"),this.addHandles([(0,k.watch)((function(){return e.baseOpacity}),(function(){e._handleLayerViewChanges(),e._updateTileTextures(e._evaluateTransparency()?Qf.Ns.UNFADED:Qf.Ns.IMMEDIATE)}),k.syncAndInitial),(0,k.watch)((function(){return e.hasCompositeBlendMode}),(function(){return e._updateTileTextures(e._evaluateTransparency()?Qf.Ns.UNFADED:Qf.Ns.IMMEDIATE)}),k.syncAndInitial),(0,k.watch)((function(){return e.backgroundColor}),(function(t,n){(null===t||void 0===t?void 0:t.equals(n))||(e._handleLayerViewChanges(),e._renderer.updateTileBackground(t))}),k.sync),(0,k.watch)((function(){return e.snapLevel}),(function(){return e._viewChanged=!0}),k.sync),(0,k.watch)((function(){return e.view.pointsOfInterest}),(function(t){e._renderer.pointsOfInterest=t,e._watchUpdatingTracking.removeAll(),t&&e._watchUpdatingTracking.add((function(){return t.focus.renderLocation}),(function(){return e._allTilesSorted=!1}))})),(0,k.watch)((function(){return Vl.h.TERRAIN_TILE_TREE_SHOW_TILES}),(function(i){i&&!e._treeDebugger?n.e(62782).then(n.bind(n,62782)).then((function(n){var i=n.TerrainTileTree3DDebugger;!e._treeDebugger&&Vl.h.TERRAIN_TILE_TREE_SHOW_TILES&&(e._treeDebugger=new i({view:t}))})):i||(e._treeDebugger=(0,x.SC)(e._treeDebugger))}),k.initial)]);var o=t.spatialReference;this._extentHelper=function(e,t){return e===he.JY.Global?new jf(t):new Wf(t)}(this.viewingMode,{layers:t.map.allLayers,layerViews:t.allLayerViews,viewSpatialReference:o});var s=new Af.Z({getCollections:function(){var e,n;return null===(e=t.defaultsFromMap)||void 0===e||null===(n=e.mapCollections)||void 0===n?void 0:n.map((function(e){return e.layers}))},getChildrenFunction:function(e){return e&&"layers"in e?e.layers:null}}),l=new zm({layers:s,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:o});this._set("tilingSchemeLogic",l),this._updateTilingScheme(),this._elevationDataRequester=i.createStreamDataRequester(pd.Bh.ELEVATION),this._mapDataRequester=i.createStreamDataRequester(pd.Bh.BASEMAP);var u=i.scheduler;this._frameTask=u.registerTask($t.T8.TERRAIN_SURFACE,this),this.addHandles([(0,k.watch)((function(){return e._extentHelper.stencilEnabledExtents}),(function(t){return e._renderer.setStencilEnabledLayerExtents(t)}),k.initial),(0,k.watch)((function(){return e.tilingSchemeLogic.tilingScheme}),(function(){return e._updateTilingScheme()}),k.sync),(0,k.watch)((function(){return e.extent}),(function(){return e._updateRootTiles()}),k.initial),t.on("resize",(function(){return e._viewChangeUpdate()})),(0,k.watch)((function(){var n=t.state;return[e._lodBias,e.lodSnapping,t.quality,n.camera,n.contentCamera,n.fixedContentCamera]}),(function(){return e._viewChangeUpdate()}),k.syncAndInitial),(0,k.watch)((function(){var e;return null===(e=t.qualitySettings)||void 0===e?void 0:e.fadeDuration}),(function(t){return e._renderer.textureFadingEnabled=t>0}),k.initial),(0,k.watch)((function(){var e;return null===(e=t.qualitySettings)||void 0===e?void 0:e.physicallyBasedRenderingEnabled}),(function(t){return e._renderer.pbrMode=t?Rm.f7.Simplified:Rm.f7.Disabled}),k.initial),(0,k.watch)((function(){var e;return null===(e=t.qualitySettings)||void 0===e?void 0:e.tiledSurface.elevationLevelDelta}),(function(){return e._updateAllTileGeometries()})),(0,k.watch)((function(){return e._userClippingExtent}),(function(){return e._updateClippingExtent()}),k.sync)]),this.addHandles(t.allLayerViews.on("after-changes",(function(){return e._layerViewsDirty=!0}))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}},{key:"destroy",value:function(){var e=this;this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",(0,x.SC)(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((function(t,n){return e._unregisterTiledLayerView(n)})),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,x.SC)(this.overlayManager)),this._tileCache=(0,x.SC)(this._tileCache),Nv.prune(),this._treeDebugger=(0,x.SC)(this._treeDebugger),this._renderer=(0,x.SC)(this._renderer),this._iteratorPool=(0,x.SC)(this._iteratorPool),this._upsampleMapCache=(0,x.SC)(this._upsampleMapCache),this._elevationQueryCache=(0,x.SC)(this._elevationQueryCache),this._set("view",null),this._extentHelper=(0,x.SC)(this._extentHelper),this._upsampleInfoPool=(0,x.SC)(this._upsampleInfoPool),(0,Lf.K)(),Lv.size>0&&(console.log("".concat(Lv.size," live TilePerLayerInfo allocations:")),Lv.forEach((function(e){return console.log(e,"\n")})))}},{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){if(this.lodSnapping===Qf.VB.ON){var e=this.view,t=this.tilingScheme,n=e.terrainScale;if(t&&n){var i=t.levelAtScale(n)+e.qualitySettings.tiledSurface.lodBias,r=t.getMaxLod();return Math.min(i,r||1/0)}}return null}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?Qf.VB.ON:Qf.VB.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"_userClippingExtent",get:function(){var e=this.spatialReference,t=this.view.clippingArea;if(null==t||null==e)return null;var n=(0,B.Ue)(),i=(0,rh.G)(t,n,e)?n:null,r=this._get("extent");return(0,B.fS)(i,r)?r:i}},{key:"rootTilesExtent",get:function(){return this._rootTilesExtent}},{key:"extent",get:function(){var e=(0,B.jV)(this.groundExtent,this._userClippingExtent,(0,B.Ue)()),t=this._get("extent");return(0,B.fS)(e,t)?t:e}},{key:"groundExtent",get:function(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){var e;return null===(e=this.tilingSchemeLogic)||void 0===e?void 0:e.extent}},{key:"updating",get:function(){var e,t;return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||null!==(e=this._watchUpdatingTracking)&&void 0!==e&&e.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||null!==(t=this.overlayManager)&&void 0!==t&&t.updating)}},{key:"running",get:function(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}},{key:"updatingProgressValue",get:function(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}},{key:"baseOpacity",get:function(){var e,t,n,i;return null!==(e=null===(t=this.view)||void 0===t||null===(n=t.map)||void 0===n||null===(i=n.ground)||void 0===i?void 0:i.opacity)&&void 0!==e?e:1},set:function(e){this.view.map.ground.opacity=e}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return null!=this._rootTiles}},{key:"renderOrder",set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}},{key:"rootTiles",get:function(){return this._rootTiles}},{key:"spatialReference",get:function(){var e,t;return null!==(e=null===(t=this.tilingScheme)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:null}},{key:"backgroundColor",get:function(){var e,t,n;return null===(e=this.view)||void 0===e||null===(t=e.map)||void 0===t||null===(n=t.ground)||void 0===n?void 0:n.surfaceColor},set:function(e){this.view.map.ground.surfaceColor=e}},{key:"slicePlaneEnabled",set:function(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}},{key:"tilingSchemeLocked",get:function(){var e,t;return null!==(e=null===(t=this.tilingSchemeLogic)||void 0===t?void 0:t.tilingSchemeLocked)&&void 0!==e&&e}},{key:"wireframe",get:function(){var e;return null===(e=this._renderer)||void 0===e?void 0:e.wireframe},set:function(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}},{key:"opaque",get:function(){return this._renderer.transparency===Am.Opaque}},{key:"suspended",set:function(e){this._set("suspended",e),this._viewChangeUpdate()}},{key:"fadeDuration",get:function(){var e;return null!==(e=this.view.qualitySettings.fadeDuration)&&void 0!==e?e:0}},{key:"intersect",value:function(e,t,n,i){this._renderer.intersect(e,t,n,i)}},{key:"getElevationLevelDelta",value:function(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}},{key:"getElevation",value:function(e,t,n,i){var r,a=this._rootTiles;if(null===a||void 0===a||!a.length)return null;if(0===a[0].layerInfo[Wh.ELEVATION].length)return null;var o=this._elevationProjectorCache.get(i);if(void 0===o&&(o=null!==(r=(0,Uu.R8)(i,this._spatialReference))&&void 0!==r?r:null,this._elevationProjectorCache.set(i,o)),null==o)return C.Z.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;var s=(0,et.s)(Wm,e,t,n);return o(s,0,s,0),Km(a,s[0],s[1])}},{key:"getElevations",value:function(e,t,n){var i=this._rootTiles,r=i?i[0].layerInfo[Wh.ELEVATION].length:0;if(null!==i&&void 0!==i&&i.length&&0!==r)for(var a=0;a<t;++a){var o=3*a;n(a,Km(i,e[o],e[o+1]))}else for(var s=0;s<t;++s)n(s,null)}},{key:"getScale",value:function(e){if(!this.tilingScheme)return null;if(!(0,q.K)(e,Wm,this.spatialReference))return C.Z.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;var t=this._rootTiles;if(null!=t){var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(null!==a&&void 0!==a&&a.containsPoint(Wm)){for(var o=a;o.children[0]&&!o.rendered;){var s=o.children[0].extent,l=0;Wm[0]>s[2]&&(l+=1),Wm[1]<s[1]&&(l+=2),o=o.children[l]}return this._getLodBiasCorrectedScale(o.level)}}}catch(u){r.e(u)}finally{r.f()}}return 1/0}},{key:"_ensureSEBProject",value:function(e){var t,n=this._sebProjectorMap.get(e);if(n)return n;var i=null!==(t=(0,Uu.R8)(e,this._tilingSchemeSpatialReference,this._sebProjectorCache))&&void 0!==t?t:null;return this._sebProjectorMap.set(e,i),i}},{key:"getSphereElevationBounds",value:function(e,t){var n=this._ensureSEBProject(t);if(null==n)return C.Z.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;(0,Ai.a)(e,Xm);var r=(0,Ai.g)(Xm);n(r,0,r,0);var a=new Eh.r,o=this._rootTiles;if(null!=o){var s,l=[],u=(0,i.Z)(o);try{for(u.s();!(s=u.n()).done;){var c=s.value;l.push(c)}}catch(m){u.e(m)}finally{u.f()}for(var h=0;h<l.length;){var d=l[h];if(++h,(0,B.hr)(d.extent,Xm)){var f=d.children;if(null==f[0]||d.rendered)a.expandElevationRangeValues(d.elevationBoundsMin,d.elevationBoundsMax);else{var v,p=(0,i.Z)(f);try{for(p.s();!(v=p.n()).done;){var _=v.value;l.push(_)}}catch(m){p.e(m)}finally{p.f()}}}}}return a}},{key:"getRootElevationBounds",value:function(){return new Eh.r(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}},{key:"getSphereScale",value:function(e,t){var n=this;if(!this.tilingScheme)return null;if(!(0,q.K)(e,(0,Ai.g)(Xm),this.spatialReference))return C.Z.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Xm[3]=t;var r=null,a=function e(t){if(t&&(0,B.hr)(t.extent,Xm)){var a=t.children;if(a[0]&&!t.rendered){var o,s=(0,i.Z)(a);try{for(s.s();!(o=s.n()).done;){e(o.value)}}catch(u){s.e(u)}finally{s.f()}}else{var l=n._getLodBiasCorrectedScale(t.level);r=null==r?l:Math.min(r,l)}}},o=this._rootTiles;if(null!=o){var s,l=(0,i.Z)(o);try{for(l.s();!(s=l.n()).done;){a(s.value)}}catch(u){l.e(u)}finally{l.f()}}return r}},{key:"queryVisibleScaleRange",value:function(e,t,n,i){var r=t?this.tilingScheme.levelAtScale(t):0,a=n?this.tilingScheme.levelAtScale(n):1/0,o=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,r+o,a+o,i)}},{key:"_evaluateTransparency",value:function(){var e,t,n=this.baseOpacity,i=this.overlayManager.renderer.isEmpty,r=this._renderer.transparency,a=this._allSurfaceLayersTransparent()?i?Am.Empty:Am.TransparentWithDraped:n>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?Am.Opaque:Am.Semitransparent,o=r!==a;return o&&(this._renderer.transparency=a,null!==(e=this.view)&&void 0!==e&&null!==(t=e._stage)&&void 0!==t&&t.renderer.setParameters({terrainTransparency:this._renderer.transparency})),o}},{key:"_updateTilingScheme",value:function(){var e,t,n,i,r,a,o=this.tilingSchemeLogic.tilingScheme;if(o!==this.tilingScheme){(0,Bf.wu)(!!o,"tiling scheme cannot be reset to undefined"),this._isGlobal=!(null!==(e=this.view)&&void 0!==e&&null!==(t=e.state)&&void 0!==t&&t.isLocal),this.tilingScheme&&this._removeAllTiles();var s=null!==(n=null===o||void 0===o?void 0:o.spatialReference)&&void 0!==n?n:ee.Z.WebMercator;this._spatialReference=s,this._isWebMercator=!(null===s||void 0===s||!s.isWebMercator),this._isWebMercatorOnPlateCarree=this._isWebMercator&&(0,tt.QM)(null===(i=this.view)||void 0===i?void 0:i.renderSpatialReference),this._isGeographic=null!==(r=null===s||void 0===s?void 0:s.isGeographic)&&void 0!==r&&r,this._set("tilingScheme",o),this._tilingSchemeSpatialReference=null===(a=this.tilingScheme)||void 0===a?void 0:a.spatialReference,this._sebProjectorMap.clear(),this._updateClippingExtent(),o&&(this._updateTiledLayers(),this._renderer.setTileSize(o.pixelSize),this.overlayManager.setSpatialReference(o.spatialReference),this._updateRootTiles())}}},{key:"_acquireTile",value:function(e,t,n,i){var r=this._tileCache.pop(qm._tileMemcacheKey);return r?(r.init(e,t,n,i,this),r):new this._tileConstructor(e,t,n,i,this)}},{key:"updatingRootTiles",get:function(){return this._updatingRootTiles}},{key:"_updateRootTiles",value:function(){var e=this,t=this.extent,n=this.tilingScheme;if(n){var i=Qm,r=n.rootTilesInExtent(t,i,5*ie.$X);if(null!=this._rootTiles){if(r.length>ie.$X)return void C.Z.getLogger(this).warn(ie.C5);var a=this._rootTiles.map((function(e){return e.lij})),o=(0,gd.e5)(a,r,Gv);if(this._updatingRootTiles=!0,o.removed.length>0||o.added.length>0){var s=this._rootTiles.filter((function(t){return!(o.removed.findIndex((function(e){return Gv(e,t.lij)}))>-1)||(e._purgeTile(t),!1)}));o.added.forEach((function(t){return s.push(e._newRootTile(t))})),this._setRootTiles(s)}}else this._updatingRootTiles=!0,r.length>ie.$X&&(C.Z.getLogger(this).warn(ie.p1),r=n.rootTilesInExtent(t,i,ie.$X)),this._setRootTiles(r.map((function(t){return e._newRootTile(t)})));(0,B.fS)(i,this._rootTilesExtent)||(this._rootTilesExtent=(0,B.Ue)(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}}},{key:"_updateAllTileGeometries",value:function(){var e=this,t=this._allTiles.filter((function(e){return e.isLoaded&&e.intersectsClippingArea}));t.sort(Sv.gl),t.forEach((function(t){return e._renderer.updateTileGeometryState(t)})),t.forEach((function(e){return e.renderData.updateNeighborData()})),this._updateTilesGeometries(t),this._pendingTilesToUpdate.clear()}},{key:"_updateTilesGeometries",value:function(e){var t=this;if(0!==e.length){e.sort(Sv.gl);var n=this.renderer;e.forEach((function(e){return n.updateGeometryIfNeeded(e)})),e.forEach((function(e){return t._pendingTilesForElevationUpdateEvent.add(e)}))}}},{key:"_shouldSplit",value:function(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===Dv.SPLIT}},{key:"_newRootTile",value:function(e){var t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(Dv.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}},{key:"_setRootTiles",value:function(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){var t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}},{key:"_runViewChangeUpdateIfDirty",value:function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}},{key:"_viewChangeUpdate",value:function(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}},{key:"_updateClippingStatus",value:function(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(Dv.GEOMETRY)&&this._updateTileGeometryState(e)}},{key:"_updateTilesVisibility",value:function(e){if(null!=e){var t=(0,Sv.t8)(e),n=this.visibleElevationBounds,i=t?n.min:1/0,r=t?n.max:-1/0,a=this.extent,o=this._viewProjectionMatrix;this.setTileTreeDirty();var s=this._iteratorPool.acquire();for(s.reset(e);!s.done;){var l=s.next();l.updateClippingStatus(a)&&l.resetPendingUpdate(Dv.GEOMETRY)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(o),l.renderData&&(i=Math.min(l.elevationBoundsMin,i),r=Math.max(l.elevationBoundsMax,r))}s.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(i)&&isFinite(r)&&(n.min!==i||n.max!==r)&&(this.visibleElevationBounds=new Hf(i,r))}}},{key:"_updateRootTileElevationBounds",value:function(){var e=1/0,t=-1/0,n=this._rootTiles;null!=n&&n.forEach((function(n){var i=n.elevationBoundsMin,r=n.elevationBoundsMax;e=Math.min(e,i),t=Math.max(t,r)}));var i=this.rootTileElevationBounds;i.min===e&&i.max===t||(this.rootTileElevationBounds=new Hf(e,t))}},{key:"_updateViewDependentParameters",value:function(){var e,t=this.view.state,n=t.camera,i=t.contentCamera,r=Math.tan(.5*i.fovX),a=Math.tan(.5*i.fovY),o=this.tilingScheme.pixelSize,s=Math.pow(2,-this._lodBias)*n.pixelRatio;this._splitLimits.aboveGround=n.aboveGround,this._splitLimits.fovX=r,this._splitLimits.fovY=a,this._splitLimits.relativeWidthLimit=o/n.width*this.maxTextureScale*s,this._splitLimits.relativeHeightLimit=o/n.height*this.maxTextureScale*s,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=(0,Au.JG)(null!==(e=this._splitLimits.frustum)&&void 0!==e?e:(0,Au.Ue)(),i.frustum):this._splitLimits.frustum=null,(0,Au.JG)(this._frustum,n.frustum),(0,Nt.Jp)(this._viewProjectionMatrix,i.projectionMatrix,i.viewMatrix),(0,et.c)(this._eyePosRenderSR,i.eye),(0,Zf.S)(n.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}},{key:"_updateTileGeometryState",value:function(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}},{key:"_markAllTileNeighborsForUpdate",value:function(e){var t=this;e.forEachLoadedNeighbor((function(e){t._layerViews[Wh.MAP].some(Bf.Q)&&e.setPendingUpdate(Dv.TEXTURE_FADING),t._pendingTilesToUpdate.add(e)}))}},{key:"_updateTileTexture",value:function(e,t){var n=e.resetPendingUpdate(Dv.TEXTURE_FADING)?Dv.TEXTURE_FADING:!!e.resetPendingUpdate(Dv.TEXTURE_NOFADING)&&Dv.TEXTURE_NOFADING;n&&(this._renderer.updateTileTexture(e,n),this._usedMemory=null,t.madeProgress())}},{key:"_emitElevationUpdateEventForTiles",value:function(){if(this._shouldEmitChangeEvent){var e=Ym.extent;(0,B.cS)(e),this._pendingTilesForElevationUpdateEvent.forEach((function(t){return(0,B.jn)(e,t.extent,e)})),this._pendingTilesForElevationUpdateEvent.clear(),Ym.spatialReference=this.spatialReference,this.emit("elevation-change",Ym),this._shouldEmitChangeEvent=!1}}},{key:"runTask",value:function(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);var t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),Bf.T9&&this._checkTileInvariant(),!e.hasProgressed)return en.J}},{key:"_checkTileInvariant",value:function(){var e=new Map;this._allTiles.forAll((function(t){return e.set(t,new Set)})),this._allTiles.forAll((function(t){if((0,Bf.wu)(t.rendered===t.isLeaf," rendered ".concat(t.rendered," != ").concat(t.isLeaf," leaf")),!t.isLeaf){var n=t.children.reduce((function(e,t){return e+(function(e){return 0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount}(t)?0:1)}),0);if((0,Bf.wu)(t.unmergableChildCount===n," Tile[".concat(t.lij.toString(),"] unmergeable child count mismatch: actual ").concat(t.unmergableChildCount," vs ").concat(n)),t.hasPendingUpdate(Dv.MERGE)){(0,Bf.wu)(!t.hasPendingUpdate(Dv.SPLIT),"Tile can be both split and merge at the same time");var r,a=(0,i.Z)(t.children);try{for(a.s();!(r=a.n()).done;){var o=r.value;(0,Bf.wu)(o.isLeaf||o.hasPendingUpdate(Dv.MERGE),"Child of tile to merge must also merge")}}catch(p){a.e(p)}finally{a.f()}}}for(var s=0;s<4;++s){if(t.rendered){var l,u=null===(l=t.renderData)||void 0===l?void 0:l.geometryState.edgePeerNeighbors[s];if(null!=u){var c=t.level-u.level<=ie.qC;c||(console.log("tile level delta [".concat(t.lij.toString(),"] vs [").concat(u.lij.toString(),"] > ").concat(ie.qC,"  (edge[").concat(s,"])")),(0,Bf.wu)(c,"tile level delta [".concat(t.level,"] vs [").concat(u.level,"] > ").concat(ie.qC))),(0,Bf.wu)(t.level-u.level<=ie.qC,"Max tile lod delta exceeded: [".concat(t.lij.toString(),"] vs [").concat(u.lij.toString(),"]"))}}var h=t.level-ie.qC,d=t.findNeighborTile(Bf.OC[s],(function(e){return e.isLeaf||e.level===t.level}));if(null!=d){if(t.isLeaf&&t.level>=ie.qC){for(var f=d;t.level-f.level<ie.qC;)f=f.parent;if(!Gv([h,t.lij[1]>>ie.qC,t.lij[2]>>ie.qC],f.lij)){var v=e.get(f);(0,Bf.wu)(!v.has(t),"Cannot already have neighbor"),v.add(t)}}(0,Bf.wu)(d.rendered||d.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),(0,Bf.wu)(t.level-d.level<=ie.qC,"Tile level delta [".concat(t.level,"] vs [").concat(d.level,"] > ").concat(ie.qC))}}})),this._allTiles.forAll((function(t){var n=t.maxLevelDeltaNeighborCount,i=e.get(t);(0,Bf.wu)(n===i.size,"Tile[".concat(t.lij.toString(),"] merge-blocker mismatch: actual ").concat(n," vs ").concat(i.size))}))}},{key:"_updateAllTilesStatus",value:function(e){if(this._viewChanged&&this._rootTiles&&!e.done){this._viewChanged=!1;var t=new $m(this._allTiles.length);t.pushAll(this._rootTiles);var n=this.snapLevel,i=this._splitLimits,r=this._eyePosRenderSR;this._allTiles.forAll((function(e){e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0}));for(var a=this._viewProjectionMatrix;!t.empty;){var o=t.pop(),s=o.parent,l=null!=s&&s.hasPendingUpdate(Dv.MERGE),u=l?Dv.MERGE:o.shouldSplit(i,r,n),c=u===Dv.SPLIT;o.isLeaf?eg(o,c):t.pushAll(o.children),l?(o.resetPendingUpdate(Dv.SPLIT),o.isLeaf||o.setPendingUpdate(Dv.MERGE),this._updateClippingStatus(o),o.updateVisibility(),o.updateScreenDepth(a)):c?(o.resetPendingUpdate(Dv.MERGE),o.isLeaf&&o.setPendingUpdate(Dv.SPLIT)):(o.resetPendingUpdate(Dv.SPLIT)&&o.updateAgentSuspension(),u===Dv.ELEVATION&&o.updateAgents(Wh.ELEVATION),o.isLeaf||(o.setPendingUpdate(Dv.MERGE),o.resetPendingUpdate(Dv.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}}},{key:"_sortTiles",value:function(e){e.done||this._allTilesSorted||((0,Sv.b)(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}},{key:"_markTileToUpdate",value:function(e){(0,Bf.Fp)(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}},{key:"_updatePendingTileGeometries",value:function(){var e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter((function(e){return e.isLoaded&&e.intersectsClippingArea}));if(0!==t.length){var n=function(n,i){null===i||void 0===i||!i.isLoaded||!i.intersectsClippingArea||i.level<n.level||e.has(i)||(e.add(i),t.push(i),i.renderData.updateNeighborData())};t.sort(Sv.gl);for(var i=t.length,r=function(i){var r=t[i];(0,Bf.Fp)(r.isLoaded),(0,Bf.Fp)(r.intersectsClippingArea);var a=r.renderData;a.updateNeighborData();for(var o=a.dirtyEdgeResolutions,s=a.geometryState,l=function(e){var t,i=Bf.cA[e];n(r,null===(t=s.cornerPeerNeighbors[e])||void 0===t?void 0:t.findCorner((0,Bf.$v)(i),(function(e){return e.isLoaded})))},u=0;u<4;++u)if(o&1<<u){var c=a.geometryState.edgePeerNeighbors[u];c&&(null===c||void 0===c?void 0:c.level)>=r.level&&c.forAllSubtreeOnSide((0,Bf._F)(Bf.OC[u]),(function(t){return!(!t.isLoaded||!t.intersectsClippingArea)&&((0,Bf.Fp)(e.has(t)||(0,Sv.gl)(r,t)<0),n(r,t),!0)})),l((u+1)%4),l(u)}},a=0;a<i;++a)r(a);e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,Bf.T9&&Bf.V0&&this.checkAllTilesWaterproofness()}else e.clear()}},{key:"_mergeAndSplit",value:function(e,t){var n=this;if(!this.suspended&&!e.done&&this._allTilesDirty){this._allTilesDirty=!1,this.requestUpdate();for(var i=!1,r=this.view.state.fixedContentCamera,a=!1;!e.done;){a=!0;var o=!1,s=!this._allTiles.some((function(a){if(!i&&!r&&!a.visible)return e.done;var s=a;if(a.hasPendingUpdate(Dv.MERGE)){if(!t||a.unmergableChildCount>0)return e.done;for(a.resetPendingUpdate(Dv.MERGE);null!=s.parent&&0===s.parent.unmergableChildCount&&s.parent.resetPendingUpdate(Dv.MERGE);)s=s.parent;n._mergeTile(s),o=!0,e.madeProgress()}else if(a.resetPendingUpdate(Dv.SPLIT)){var l=!0,u=a.level;if(u>=ie.qC)for(var c=function(e){return e.isLeaf||u-e.level<ie.qC},h=0;h<4;++h){var d=a.findNeighborTile(Bf.OC[h],c);null!=d&&u-d.level===ie.qC&&(l=!1,Bf.T9&&((0,Bf.Fp)(d.isLeaf),(0,Bf.Fp)(d.hasPendingUpdate(Dv.SPLIT))))}l?(n._splitTile(a),e.madeProgress(),o=!0):a.setPendingUpdate(Dv.SPLIT)}return e.done}));if(o&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),s){if(!i){i=!0;continue}if(!o)break}else this._allTilesDirty=!0}a?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}}},{key:"_updateElevation",value:function(e){var t=this;e.done||(this._allTiles.some((function(n){return n.resetPendingUpdate(Dv.GEOMETRY)&&(t._updateTileGeometryState(n),t._shortBatches&&t._updatePendingTileGeometries(),e.madeProgress()),e.done})),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}},{key:"_updateTextures",value:function(e){var t=this;e.done||this._allTiles.some((function(n){return t._updateTileTexture(n,e),e.done}))}},{key:"_updateClippingExtent",value:function(){this.spatialReference&&(this.updateTileOverlayParams(Kf.Xx.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}},{key:"_lodBias",get:function(){var e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*ie.if}},{key:"_getLodBiasCorrectedScale",value:function(e){var t=this.tilingScheme.levels,n=(0,Se.uZ)(e-this._lodBias,0,t.length-1),i=n-Math.floor(n);return t[Math.floor(n)].scale*(1-i)+t[Math.ceil(n)].scale*i}},{key:"_removeAllTiles",value:function(){var e=this;null!=this._rootTiles&&(this._rootTiles.forEach((function(t){return e._purgeTile(t)})),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}},{key:"_purgeDescendantTiles",value:function(e){if(e.children[0]){var t=e.children.slice();e.unsetChildren();for(var n=0;n<4;++n)this._purgeTile(t[n])}}},{key:"_purgeTile",value:function(e){e.isLeaf?ng(e):this._purgeDescendantTiles(e),this._allTiles.removeUnordered(e),this._unloadTile(e),this._tileCache.put(qm._tileMemcacheKey,e)}},{key:"_unloadTile",value:function(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}},{key:"_splitTile",value:function(e){var t=this;(0,Bf.wu)(e.isLeaf,"Tile that is already split should not be split again!"),(0,Bf.wu)(e.rendered,"Tile marked to split is not rendered"),ng(e);var n=e.level+1,i=2*e.lij[1],r=2*e.lij[2],a=e.setChildren(this._createTile(n,i,r,e),this._createTile(n,i,r+1,e),this._createTile(n,i+1,r,e),this._createTile(n,i+1,r+1,e));this._allTiles.pushArray(a),e.updateAgentSuspension(),(0,Bf.wu)(e.rendered,"parent should be rendered"),this._unloadTile(e),a.forEach((function(e){return t._loadTile(e)})),a.forEach((function(e){return t._pendingTilesToUpdate.add(e)})),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),a.forEach((function(e){return eg(e,e.hasPendingUpdate(Dv.SPLIT))})),++this._performanceInfo.numSplit}},{key:"_emitTileScaleChange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.level;Jm.spatialReference=this.spatialReference,Jm.extent=e.extent,Jm.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Jm)}},{key:"_createTile",value:function(e,t,n,i){(0,Bf.wu)(!!i,"_createTile sanity check");var r=this._acquireTile(e,t,n,i);return r.updateClippingStatus(this.extent),r.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(r)&&r.setPendingUpdate(Dv.SPLIT),r}},{key:"_shortBatches",get:function(){return this.view.state.mode!==rs.n.IDLE}},{key:"_mergeTile",value:function(e){(0,Bf.wu)(!e.hasPendingUpdate(Dv.SPLIT),"_mergeTile sanity check"),(0,Bf.wu)(!e.isLeaf,"Cannot merge a leaf"),e.isLeaf||(this._purgeDescendantTiles(e),(0,Bf.wu)(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),eg(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}},{key:"_loadTile",value:function(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}},{key:"_handleLayerViewChanges",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$t.G5;if(this._layerViewsDirty){this._layerViewsDirty=!1;for(var n=!1,i=new Set,r=-1,a=this.view.allLayerViews.length-1;a>=0;a--){var o=this.view.allLayerViews.items[a];if(i.add(o.uid),(0,Bf.wP)(o)||(0,Bf.a_)(o))if(this._basemapLayerViewHandles.has(o.uid)&&!(0,Bf.a_)(o)){var s=this._layerClassFromLayerView(o),l=this._getLayerIdxByUID(s,o.uid);null!=l&&((l<r||null==r)&&(n=!0),r=l)}else this._registerTiledLayerView(o),o.layer.loaded&&(n=!0)}this._basemapLayerViewHandles.forEach((function(t,r){i.has(r)||(e._unregisterTiledLayerView(r),n=!0)})),n&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),t.madeProgress()}}},{key:"_allSurfaceLayersTransparent",value:function(){var e,t,n,r=0===(null===(e=this.view.map)||void 0===e||null===(t=e.ground)||void 0===t?void 0:t.opacity),a=(0,i.Z)(this.view.allLayerViews.items);try{for(a.s();!(n=a.n()).done;){var o=n.value;if((0,Bf.GL)(o)&&!(0,X.sy)(o.layer)&&0!==o.fullOpacity)return r=!1}}catch(s){a.e(s)}finally{a.f()}return r}},{key:"_hasCompositeBlendMode",value:function(){var e,t=(0,i.Z)(this.view.allLayerViews.items);try{for(t.s();!(e=t.n()).done;){var n=e.value;if(((0,Bf.TK)(n)||(0,Bf.a_)(n))&&(0,x_.MV)(x_.pU[n.layer.blendMode]))return!0}}catch(r){t.e(r)}finally{t.f()}return!1}},{key:"_layerClassFromLayerView",value:function(e){return(0,Bf._1)(e)?Wh.ELEVATION:Wh.MAP}},{key:"_registerTiledLayerView",value:function(e){var t=this,n=[];if(((0,Bf.TK)(e)||(0,Bf.a_)(e))&&n.push((0,k.watch)((function(){return e.layer.blendMode}),(function(){t.hasCompositeBlendMode=t._hasCompositeBlendMode(),t._updateTileTextures(Qf.Ns.UNFADED)}))),!(0,Bf.a_)(e)){var i=this._layerClassFromLayerView(e);n.push((0,k.watch)((function(){return e.suspended}),(function(){return t._updateTiledLayers()}))),n.push((0,k.watch)((function(){return e.fullOpacity}),(function(){return t._updateTileTextures(Qf.Ns.UNFADED)}))),n.push((0,k.watch)((function(){return"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null}),(function(){return t._restartAllAgents(i)}))),n.push(e.on("data-changed",(function(){var n=t._getLayerIdxByUID(i,e.uid);null!=n&&t._invalidateLayerData(n,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,n)}},{key:"_unregisterTiledLayerView",value:function(e){var t=this._basemapLayerViewHandles.get(e);if(t){var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){n.value.remove()}}catch(a){r.e(a)}finally{r.f()}this._basemapLayerViewHandles.delete(e)}}},{key:"_updateTiledLayers",value:function(){var e=this;if(this.tilingScheme&&!this.view.suspended){var t=this.view.allLayerViews,n=[[],[]],r=null;t.forEach((function(t){if(t.layer&&!t.suspended&&(0,Bf.wP)(t)&&t.fullExtent){var i=e._layerClassFromLayerView(t);if(i===Wh.MAP){var a=t.displayLevelRange.maxLevel;a!==1/0&&(null===r||a>r)&&(r=a)}n[i].push(t)}}));var a,o=(0,i.Z)($h);try{for(o.s();!(a=o.n()).done;){var s=a.value,l=this._layerViews[s],u=n[s];u.reverse();var c=u.length,h=l.length!==c,d=new Array(c),f=new Array(l.length);this._layerIndexByUid[s].clear();for(var v=0;v<c;v++){var p=u[v].uid;this._layerIndexByUid[s].set(p,v);var _=l.indexOf(u[v]);d[v]=_,v!==_&&(h=!0),_>-1&&(f[_]=v)}if(h){var m=this._postorderIterator;for(m.reset(this._rootTiles);!m.done;)m.next().modifyLayers(f,d,s);this._layerViews[s]=u,this._restartAllAgents(s),this._updateTilesVisibility(this._rootTiles)}}}catch(g){o.e(g)}finally{o.f()}this.tilingScheme.ensureMaxLod(r)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}}},{key:"_restartAllAgents",value:function(e){var t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){var n=t.next();n.restartAgents(e),e===Wh.ELEVATION&&n.computeElevationBounds()}this._updateRootTileElevationBounds()}},{key:"layerViewByIndex",value:function(e,t){return this._layerViews[t][e]}},{key:"numLayers",value:function(e){return this._layerViews[e].length}},{key:"_updateTileTextures",value:function(e){var t=this;this._allTiles.forAll((function(n){n.updateAgents(Wh.MAP),e===Qf.Ns.IMMEDIATE?t.renderer.updateTileTexture(n,Dv.TEXTURE_NOFADING):n.updateRenderData(Wh.MAP,e)})),this._evaluateTransparency()}},{key:"_invalidateLayerData",value:function(e,t){this._allTiles.forAll((function(n){return n.removeLayerAgent(e,t)})),this._allTiles.forAll((function(n){return n.invalidateLayerData(e,t)}))}},{key:"setTileTreeDirty",value:function(){this._allTilesDirty=!0}},{key:"requestRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Kf.Xx.UPDATE;this.renderer.setNeedsRender(e)}},{key:"requestUpdate",value:function(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}},{key:"requestTileData",value:function(e,t,n,i){var r=this,a=this.layerViewByIndex(t,n),o=a.layer;return!o.tilemapCache||(0,Bf.Q)(a)?this._requestTileData(e,n,a,i):(++this._asyncWorkItems,o.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],(0,He.Z)((0,He.Z)({},i),{},{timeout:6e3})).then((function(){return--r._asyncWorkItems})).catch((function(t){throw--r._asyncWorkItems,(0,S.k_)(i),(0,S.D_)(t)||r._dataMissing(e,n,a),t})).then((function(){return r._frameTask.schedule((function(){return r._requestTileData(e,n,a,i)}),i.signal)})))}},{key:"_requestTileData",value:function(e,t,n,i){var r,a=t===Wh.ELEVATION;return null!==(r=i.requester)&&void 0!==r||(i.requester=a?this._elevationDataRequester:this._mapDataRequester),a?(0,Bf._1)(n)?this._requestElevationTileData(e,n,i):Promise.reject():(0,Bf.GL)(n)?this._requestMapTileData(e,n,i):Promise.reject()}},{key:"_requestElevationTileData",value:function(e,t,n){var i=this;++this._asyncWorkItems;var r=function(r){!(0,S.Hc)(n)&&r&&(i._usedMemory=null,i.requestUpdate(),i._elevationDataArrived(e,t,r))};return t.fetchTile(e.lij,n).then((function(e){return i._frameTask.schedule((function(){return r(e)}))}),(function(n){(0,S.D_)(n)||(C.Z.getLogger(i).error("Tile ".concat(e.lij.toString()," layer ").concat(Wh.ELEVATION,"/").concat(t.uid," error ").concat(n)),i._dataMissing(e,Wh.ELEVATION,t),i.requestUpdate())})).finally((function(){return--i._asyncWorkItems}))}},{key:"_elevationDataArrived",value:function(e,t,n){var i=this._layerIndexByUid[Wh.ELEVATION].get(t.uid);if(null!=i){var r=new Vf(e.lij,e.extent,n);e.dataArrived(i,Wh.ELEVATION,r);var a=[e],o=e.level,s=this._iteratorPool.acquire();for(s.reset(a);!s.done;){var l=s.next();l.findElevationBoundsForLayer(i,o),l.computeElevationBounds()}0===o&&this._updateRootTileElevationBounds(),s.remove(),this._updateTilesVisibility(a)}else C.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",Wh.ELEVATION,e.lij.toString())}},{key:"_requestMapTileData",value:function(e,t,n){var i=this;++this._asyncWorkItems;var r=function(r,a){(0,Bf.ep)(a),(0,S.Hc)(n)||(console.error("Tile ".concat(e.lij.toString()," layer ").concat(Wh.MAP,"/").concat(t.uid," error ").concat(r)),i._dataMissing(e,Wh.MAP,t),i.requestUpdate())},a=function(e){return function(t){return r(t,e)}};return t.fetchTile(e.lij,n).then((function(r){return i._frameTask.schedule((function(){i.requestUpdate(),(0,S.Hc)(n)?(0,Bf.ep)(r):i._mapTileDataArrived(e,t,r)}),n.signal,a(r)).catch(a(r))}),(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return i._frameTask.schedule((function(){return r(e,t)}))})).finally((function(){return--i._asyncWorkItems}))}},{key:"_mapTileDataArrived",value:function(e,t,n){var i=this._getLayerIdxByUID(Wh.MAP,t.uid);if(null==i)return(0,Bf.ep)(n),void C.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(i,Wh.MAP,n)}},{key:"_getLayerIdxByUID",value:function(e,t){return this._layerIndexByUid[e].get(t)}},{key:"_dataMissing",value:function(e,t,n){var i=this._getLayerIdxByUID(t,n.uid);null!=i?e.dataMissing(i,t):C.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer")}},{key:"updateTileOverlayParams",value:function(e){var t=this;this._rootTiles&&this.overlayManager&&(this._allTiles.forAll((function(e){e.renderData&&t.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))}},{key:"performanceInfo",get:function(){var e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((function(t){t.isLeaf&&e.numLeaves++;var n=t.level;t.renderData&&(e.numLoadedPerLevel[n]=(e.numLoadedPerLevel[n]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[n]=(e.numRenderedPerLevel[n]||0)+1,e.numRendered++))})),e}},{key:"usedMemory",get:function(){var e;return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),null!==(e=this._usedMemory)&&void 0!==e?e:0):0}},{key:"_recalculateUsedMemory",value:function(){return this.tilingScheme?Math.round(this._allTiles.reduce((function(e,t){return e+t.usedMemory}),0)):null}},{key:"getUsedMemoryForLayerView",value:function(e){var t=0,n=this._layerClassFromLayerView(e),i=this._getLayerIdxByUID(n,e.uid);return null!=i&&this._allTiles.forAll((function(e){return t+=e.getUsedMemoryForLayer(n,i)})),t}},{key:"getTile",value:function(e){if(null==e||null==this._rootTiles)return null;var t=e.split("/").map((function(e){return+e}));if(0===t[0])return this._rootTiles.find((function(e){return e.lij[1]===t[1]&&e.lij[2]===t[2]}));var n,i=t[0],r=t[1]>>i,a=t[2]>>i;if(this._rootTiles.some((function(e){return e.lij[1]===r&&e.lij[2]===a&&(n=e,!0)})),n){for(var o=1<<t[0]-1;n.lij[0]<t[0];){var s=t[1]&o?2:0;if((t[2]&o)>0&&s++,!n.children[s])return null;n=n.children[s],o>>=1}return(0,Bf.wu)(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null}},{key:"renderPatchBorders",get:function(){return this._renderer.renderPatchBorders},set:function(e){this._renderer.renderPatchBorders=e}},{key:"visualizeNormals",get:function(){return this._renderer.visualizeNormals},set:function(e){this._renderer.visualizeNormals=e}},{key:"renderingDisabled",get:function(){return this._renderer.renderingDisabled},set:function(e){this._renderer.renderingDisabled=e}},{key:"test",get:function(){}},{key:"checkAllTilesWaterproofness",value:function(){if(Bf.V0){var e=this._rootTiles;if(null!=e){var t,n=function(e){var t,n,i;return(null===e||void 0===e||null===(t=e.renderData)||void 0===t||null===(n=t.geometry)||void 0===n||null===(i=n.indices)||void 0===i?void 0:i.length)>0},r=function(e,t){n(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",t.lij,"] has geom")},a=function e(t){var a,o,s;if(t.intersectsClippingArea)if(t.renderData&&!t.renderData.geometryState&&console.error("Tile[",t.lij,"] has renderData but not geometryState"),t.renderData&&!t.renderData.geometry&&console.error("Tile[",t.lij,"] has renderData but not geometryInfo"),!(null!==(a=t.renderData)&&void 0!==a&&a.geometry)||(null!==(o=null===(s=t.renderData.geometry.indices)||void 0===s?void 0:s.length)&&void 0!==o?o:0)>0||console.error("Tile[",t.lij,"] has renderData but no indices - geometryInfo: ",t.renderData.geometry),n(t)){t.checkGeometryWaterproofness();var l,u=(0,i.Z)(t.children);try{for(u.s();!(l=u.n()).done;){var c=l.value;r(c,t)}}catch(f){u.e(f)}finally{u.f()}}else if(t.isLeaf)console.error("Tile[",t.lij,"] has no geometry and no children, from root to leaf");else{var h,d=(0,i.Z)(t.children);try{for(d.s();!(h=d.n()).done;){e(h.value)}}catch(f){d.e(f)}finally{d.f()}}},o=function e(t){var n,r,a=null===(n=null===(r=t.parent)||void 0===r?void 0:r.visible)||void 0===n||n,o=t.visible;t.computeVisibility();var s=t.visible;if(o!==s&&a&&console.error(" Tile[",t.lij,"] has out of date visibility: ",o," instead of ",s),!t.isLeaf){var l,u=(0,i.Z)(t.children);try{for(u.s();!(l=u.n()).done;){e(l.value)}}catch(c){u.e(c)}finally{u.f()}}},s=(0,i.Z)(e);try{for(s.s();!(t=s.n()).done;){var l=t.value;a(l),o(l)}}catch(u){s.e(u)}finally{s.f()}}}}},{key:"isGlobal",get:function(){return this._isGlobal}},{key:"isGeographic",get:function(){return this._isGeographic}},{key:"isWebMercator",get:function(){return this._isWebMercator}},{key:"isWebMercatorOnPlateCarree",get:function(){return this._isWebMercatorOnPlateCarree}},{key:"isEastEndWrap",value:function(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}},{key:"isWestEndWrap",value:function(e){return this._isGlobal&&0===e[2]}},{key:"lijEastEnd",value:function(e){return 1<<e+(this._isGeographic?1:0)}},{key:"wrapEastWest",value:function(e){var t=this.lijEastEnd(e[0]),n=e[2];if(0<=n&&n<t)return e;if(!this._isGlobal)return null;var i=(n+(n<0?t:0))%t;return[e[0],e[1],i]}},{key:"enableInternalChecks",value:function(e){(0,Bf.qA)(e)}},{key:"enableWaterproofnessChecks",value:function(e){(0,Bf.HK)(e)}}]),r}($.Z.EventedMixin(Z.default));Gm._tileMemcacheKey="TerrainTileMemcache",(0,f._)([(0,E.Cb)()],Gm.prototype,"_renderer",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Gm.prototype,"_scaleRangeQueries",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Gm.prototype,"view",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Gm.prototype,"overlayManager",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"_hasPendingUpdates",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"_asyncWorkItems",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"_allTilesDirty",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"_allTilesSorted",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"_viewChanged",void 0),(0,f._)([(0,E.Cb)({type:Number})],Gm.prototype,"heading",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"_splitLimits",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"_watchUpdatingTracking",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"_frameTask",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"snapLevel",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"lodSnapping",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"_userClippingExtent",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"_rootTilesExtent",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"extent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"groundExtent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"_tilingSchemeExtent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"updating",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"running",null),(0,f._)([(0,E.Cb)(Uf.q)],Gm.prototype,"updatingProgress",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"updatingProgressValue",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"_maxNumUpdating",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"baseOpacity",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"hasCompositeBlendMode",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"viewingMode",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"maxTextureScale",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"ready",null),(0,f._)([(0,E.Cb)({value:o_.z.FRONT_TO_BACK})],Gm.prototype,"renderOrder",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"rootTiles",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"_rootTiles",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"spatialReference",null),(0,f._)([(0,E.Cb)({type:zh.Z})],Gm.prototype,"backgroundColor",null),(0,f._)([(0,E.Cb)({value:!1})],Gm.prototype,"slicePlaneEnabled",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"tilingScheme",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"tilingSchemeLocked",null),(0,f._)([(0,E.Cb)({readOnly:!0})],Gm.prototype,"tilingSchemeLogic",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"wireframe",null),(0,f._)([(0,E.Cb)({value:!1})],Gm.prototype,"suspended",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"fadeDuration",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"visibleElevationBounds",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"rootTileElevationBounds",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"_layerViewsDirty",void 0),(0,f._)([(0,E.Cb)()],Gm.prototype,"renderPatchBorders",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"visualizeNormals",null),(0,f._)([(0,E.Cb)()],Gm.prototype,"renderingDisabled",null);var jm=Gm=qm=(0,f._)([(0,A.j)("esri.views.3d.terrain.TerrainSurface")],Gm),Wm=(0,U.Ue)(),Xm=(0,Ai.c)(),Qm=(0,B.Ue)();new Fl.Z;var Ym=new Nf.c("ground"),Jm={spatialReference:null,extent:null,scale:0};function Km(e,t,n){var r,a=(0,i.Z)(e);try{for(a.s();!(r=a.n()).done;){var o,s,l,u=r.value;if(u.containsPointXY(t,n)){for(var c=u;c&&!c.renderData;){var h=(t>c.extentMidX?1:0)+(n<c.extentMidY?2:0);c=c.children[h]}return qf(t,n,null!==(o=null===(s=c)||void 0===s||null===(l=s.renderData)||void 0===l?void 0:l.geometryState.samplerData)&&void 0!==o?o:null)}}}catch(d){a.e(d)}finally{a.f()}return null}var $m=function(){function e(t){(0,o.Z)(this,e),this.capacity=t,this._head=0,this._tail=0,this._data=new Array(t)}return(0,s.Z)(e,[{key:"push",value:function(e){var t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}},{key:"pushAll",value:function(e){var t=e.length;if(0!==t){var n=this._tail;if(!(n+t<=this.capacity))throw new Error("Queue full");for(var i=0;i<t;++i)this._data[n+i]=e[i];this._tail=n+t}}},{key:"pop",value:function(){var e=this._head;if(e<this._tail){var t=this._data[e];return this._head=e+1,t}}},{key:"empty",get:function(){return this._head>=this._tail}},{key:"full",get:function(){return this._tail>=this._data.length}}]),e}();function eg(e,t){!e.isLeaf||e.level<ie.qC||rg(e,(function(e){t&&tg(e);var n=ig(e);if(e.maxLevelDeltaNeighborCount++,n)for(var i=e.parent;i;){var r=ig(i);if(i.unmergableChildCount++,!r)break;i=i.parent}}))}function tg(e){if(!e.hasPendingUpdate(Dv.SPLIT)){for(var t=e.parent;null!==(n=t)&&void 0!==n&&n.resetPendingUpdate(Dv.MERGE);){var n;t=t.parent}e.resetPendingUpdate(Dv.MERGE),e.isLeaf&&e.setPendingUpdate(Dv.SPLIT),e.level<ie.qC||rg(e,(function(e){tg(e)}))}}function ng(e){e.level<ie.qC||rg(e,(function(e){if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount)for(var t=e.parent;t&&(t.unmergableChildCount--,ig(t));)t=t.parent}))}function ig(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function rg(e,t){if(!(e.level<ie.qC))for(var n=e.level-ie.qC,i=e.lij[1]>>ie.qC,r=e.lij[2]>>ie.qC,a=function(e){return e.isLeaf||e.level===n},o=0;o<4;++o){var s=e.findNeighborTile(Bf.OC[o],a);if(s&&s.level===n){var l=s.lij;l[1]===i&&l[2]===r||t(s)}}}var ag=n(78976),og=n(78485),sg=n(97882),lg=n(79100),ug=n(19962),cg=n(78289),hg=(0,s.Z)((function e(t,n,i,r){(0,o.Z)(this,e),this.operation=t,this.geometry=n,this.states=i,this.sync=r})),dg=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._residentGeomRecords=new Map,i._dirtyGeomRecords=new Map,i.dirty=!1,i}return(0,s.Z)(n,[{key:"commitLayer",value:function(e,t){var n=this,i=this._dirtyGeomRecords.get(e);i&&(i.forEach((function(i,r){var a=n._ensureGeomRecord(e,r);i.forEach((function(e,i){var o=e.geometry,s=e.operation,l=e.states,u=!1;if(s===cg.T.UPDATE){var c=a.get(i);if(c){if(l&cg.$.TRANSFORMATION){var h=n.model.getObject(r);n.model.updateRenderGeometryTransformation(h,o,c)&&(u=!0)}u||t.updates.push({renderGeometry:c,updateType:l})}else(0,En.hu)(!1,"ModelDirtySet.commitLayer: invalid update")}if(s===cg.T.REMOVE||u){var d=a.get(i);d?(t.removes.push(d),a.delete(i)):s===cg.T.REMOVE&&(0,En.hu)(!1,"ModelDirtySet.commitLayer: invalid remove")}if(s===cg.T.ADD||u){var f=n.model.getObject(r);if(null!=f){var v=n.model.getRenderGeometry(f,o);t.adds.push(v),a.set(i,v)}}})),0===a.size&&n._residentGeomRecords.get(e).delete(r)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}},{key:"commitSyncUpdates",value:function(e,t){var n=this,i=this._dirtyGeomRecords.get(e);i&&i.forEach((function(i,r){var a=n._ensureGeomRecord(e,r);i.forEach((function(e,i){var o=e.geometry,s=e.operation,l=e.states,u=e.sync,c=!1;if(s===cg.T.UPDATE&&u){var h=a.get(i);if(h){if(l&cg.$.TRANSFORMATION){var d=n.model.getObject(r);n.model.updateRenderGeometryTransformation(d,o,h)&&(c=!0)}c||t.updates.push({renderGeometry:h,updateType:l})}else(0,En.hu)(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}}))}))}},{key:"getResidentRenderGeometries",value:function(e,t){var n=this._residentGeomRecords.get(e);n&&n.forEach((function(e){return e.forEach((function(e){return t.push(e)}))}))}},{key:"_objectStateChanged",value:function(e,t){var n,r=(0,i.Z)(t.geometries);try{for(r.s();!(n=r.n()).done;){var a=n.value;this._updateOrCreateDirtyRecord(t,a,null,cg.T.UPDATE,e)}}catch(o){r.e(o)}finally{r.f()}}},{key:"visibilityChanged",value:function(e){this._objectStateChanged(cg.$.VISIBILITY,e)}},{key:"highlightChanged",value:function(e){this._objectStateChanged(cg.$.HIGHLIGHT,e)}},{key:"occlusionChanged",value:function(e){this._objectStateChanged(cg.$.OCCLUDEE,e)}},{key:"attributesChanged",value:function(e){var t=e.object,n=e.geometry,i=e.sync;this._updateOrCreateDirtyRecord(t,n,null,cg.T.UPDATE,cg.$.GEOMETRY,i)}},{key:"layerAdded",value:function(e){var t=this;e.objects.forAll((function(n){return t._layerObjectAdded(e,n)}))}},{key:"layerRemoved",value:function(e){var t=this;e.objects.forAll((function(n){return t._layerObjectRemoved(e,n)}))}},{key:"layerObjectAdded",value:function(e){this._layerObjectAdded(e.layer,e.object)}},{key:"_layerObjectAdded",value:function(e,t){var n,r=e.id,a=(0,i.Z)(t.geometries);try{for(a.s();!(n=a.n()).done;){var o=n.value;this._geometryAdded(t,o,r)}}catch(s){a.e(s)}finally{a.f()}}},{key:"layerObjectRemoved",value:function(e){this._layerObjectRemoved(e.layer,e.object)}},{key:"layerObjectsAdded",value:function(e){var t,n=(0,i.Z)(e.objects);try{for(n.s();!(t=n.n()).done;){var r=t.value;this._layerObjectAdded(e.layer,r)}}catch(a){n.e(a)}finally{n.f()}}},{key:"layerObjectsRemoved",value:function(e){var t,n=(0,i.Z)(e.objects);try{for(n.s();!(t=n.n()).done;){var r=t.value;this._layerObjectRemoved(e.layer,r)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_layerObjectRemoved",value:function(e,t){var n,r=e.id,a=(0,i.Z)(t.geometries);try{for(a.s();!(n=a.n()).done;){var o=n.value;this._geometryRemoved(t,o,r)}}catch(s){a.e(s)}finally{a.f()}}},{key:"transformationChanged",value:function(e){var t=this,n=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(n,i).forEach((function(i){t._updateOrCreateDirtyRecord(e,i.geometry,n,cg.T.UPDATE,cg.$.TRANSFORMATION)}))}},{key:"shaderTransformationChanged",value:function(e){var t=this._getParentLayerId(e),n=e.id;this._ensureGeomRecord(t,n).forEach((function(t){t.objectShaderTransformationChanged(e.shaderTransformation)}))}},{key:"geometryAdded",value:function(e){this._geometryAdded(e.object,e.geometry)}},{key:"_geometryAdded",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,n,cg.T.ADD)}},{key:"geometryRemoved",value:function(e){this._geometryRemoved(e.object,e.geometry)}},{key:"_geometryRemoved",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,n,cg.T.REMOVE)}},{key:"_updateOrCreateDirtyRecord",value:function(e,t,n,i){var r,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:cg.$.NONE,o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];n=null!==(r=n)&&void 0!==r?r:this._getParentLayerId(e);var s=e.id,l=t.id,u=this._ensureDirtyRecord(n,s),c=u.get(l),h=!1;if(c){var d=c.operation;d===cg.T.REMOVE&&i===cg.T.ADD&&c.states!==cg.$.NONE?c.operation=cg.T.UPDATE:d===cg.T.REMOVE&&i===cg.T.ADD||d===cg.T.ADD&&i===cg.T.REMOVE?(u.delete(l),h=!0):d!==cg.T.UPDATE||i!==cg.T.REMOVE&&i!==cg.T.UPDATE?((0,En.hu)((d===cg.T.REMOVE||d===cg.T.ADD)&&i===cg.T.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=a):(c.operation=i,c.states|=a),c.sync=c.sync||o}else u.set(l,new hg(i,t,a,o));this.dirty=!h||this._hasDirtyGeometryRecords}},{key:"_ensureGeomRecord",value:function(e,t){var n=this._residentGeomRecords.get(e);n||(n=new Map,this._residentGeomRecords.set(e,n));var i=n.get(t);return i||(i=new Map,n.set(t,i)),i}},{key:"_hasDirtyGeometryRecords",get:function(){var e,t=(0,i.Z)(this._dirtyGeomRecords.values());try{for(t.s();!(e=t.n()).done;){var n,r=e.value,a=(0,i.Z)(r.values());try{for(a.s();!(n=a.n()).done;){if(n.value.size>0)return!0}}catch(o){a.e(o)}finally{a.f()}}}catch(o){t.e(o)}finally{t.f()}return!1}},{key:"_ensureDirtyRecord",value:function(e,t){var n=this._dirtyGeomRecords.get(e);n||(n=new Map,this._dirtyGeomRecords.set(e,n));var i=n.get(t);return i||(i=new Map,n.set(t,i)),i}},{key:"_getParentLayerId",value:function(e){return e.parentLayer?e.parentLayer.id:Eu.J}},{key:"formatDebugInfo",value:function(){var e=["ADD","UPD",void 0,"REM"],t="";return this._dirtyGeomRecords.forEach((function(n,i){n.forEach((function(n,r){t.length>0&&(t+="\n"),t+=i+"."+r;var a=[];n.forEach((function(e){var t=e.operation;a[t]||(a[t]=[]),a[t].push(e.geometry.id)}));for(var o=0;o<a.length;o++)if(a[o]){t+=" "+e[o-1]+": ";for(var s=0;s<a[o].length;s++)t+=a[o][s]+", "}}))})),t}},{key:"test",get:function(){}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],dg.prototype,"model",void 0),(0,f._)([(0,E.Cb)()],dg.prototype,"dirty",void 0);var fg=dg=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],dg),vg=n(39077),pg=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).dirtySet=new fg({model:(0,l.Z)(e)}),e._content=new Map,e._originFactory=new ug.C(null),e}return(0,s.Z)(n,[{key:"getObject",value:function(e){return this._content.get(e)}},{key:"add",value:function(e){var t=e.id;(0,En.hu)(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),(0,sg.e)(e)&&this.dirtySet.layerAdded(e)}},{key:"remove",value:function(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),(0,sg.e)(e)&&this.dirtySet.layerRemoved(e),!0)}},{key:"addMany",value:function(e){var t,n=(0,i.Z)(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;r&&((0,En.hu)(!this._content.has(r.id),"Model/Stage already contains object to be added"),this._content.set(r.id,r))}}catch(a){n.e(a)}finally{n.f()}}},{key:"removeMany",value:function(e){var t,n=(0,i.Z)(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;r&&((0,En.hu)(this._content.has(r.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(r.id))}}catch(a){n.e(a)}finally{n.f()}}},{key:"has",value:function(e){return this._content.has(e.id)}},{key:"forEachOfType",value:function(e,t){this._content.forEach((function(n){n.type===e&&t(n)}))}},{key:"getRenderGeometry",value:function(e,t){var n=new vg.z(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});n.transformation=e.getCombinedStaticTransformation(t,_g);var i=t.localOrigin;return n.localOrigin=null!=i?i:this._originFactory.getOrigin((0,Ai.g)(n.boundingSphere)),n}},{key:"updateRenderGeometryTransformation",value:function(e,t,n){if(null==e)return!1;n.transformation=e.getCombinedStaticTransformation(t,_g);var i=this._originFactory.getOrigin((0,Ai.g)(n.boundingSphere));return n.localOrigin!==i}},{key:"getStats",value:function(){for(var e={},t=Array.from(this._content.values()),n=function(n){e[n]=t.filter((function(e){return e.type===n})).length},i=0;i<lg.U.COUNT;++i)n(i);return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}},{key:"test",get:function(){}}]),n}(Z.default);(0,f._)([(0,E.Cb)({constructOnly:!0})],pg.prototype,"dirtySet",void 0),pg=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.parts.Model")],pg);var _g=(0,Ut.Ue)(),mg=n(82963),gg=n(18722),yg=n(39406),bg=n(11186),wg=n(92770),Cg=n(49420),xg=n(89414),Tg=function(){function e(t){(0,o.Z)(this,e),this._totalCount=t,this._componentCountCache=-1,this._indexRanges=[0,t]}return(0,s.Z)(e,[{key:"allVisible",value:function(){return this.componentCount===this._totalCount}},{key:"allInvisible",value:function(){return 0===this._indexRanges.length}},{key:"isVisible",value:function(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;var t=this._indexRanges,n=0,i=t.length/2;if(e<t[2*n]||e>t[2*i]+t[2*i+1])return!1;for(;i-n>0;){var r=Math.floor(.5*(n+i)),a=t[2*r];if(e<a){if(i-n==1)return!1;i=r}else{if(e<a+t[2*r+1])return!0;if(i-n==1)return!1;n=r+1}}return!1}},{key:"componentCount",get:function(){if(-1===this._componentCountCache){for(var e=this._indexRanges,t=0,n=0;n<e.length;n+=2)t+=e[n+1];this._componentCountCache=t}return this._componentCountCache}},{key:"reset",value:function(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){var t=new Array;if(0===e.length)return t;for(var n=e[0],i=1,r=1;r<e.length;r++){var a=e[r];n+i===a?i+=1:(t.push(n),t.push(i),n=a,i=1)}return t.push(n),t.push(i),t}(e),this._componentCountCache=-1}},{key:"forEachComponent",value:function(e){for(var t=this._indexRanges,n=0;n<t.length;n+=2)for(var i=t[n],r=i+t[n+1],a=i;a<r;a++)if(!e(a))return!1;return!0}},{key:"forEachComponentRange",value:function(e){for(var t=this._indexRanges,n=0;n<t.length;n+=2){var i=t[n];if(!e(i,i+t[n+1]))return!1}return!0}},{key:"computeOffsetRanges",value:function(e){for(var t=new Array(this._indexRanges.length),n=this._indexRanges,i=0;i<n.length;i+=2){var r=n[i],a=r+n[i+1],o=e[r],s=e[a];t[i]=o,t[i+1]=s-o}return t}}]),e}();var Sg=function(){function e(t,n){(0,o.Z)(this,e),this.offsets=n,this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;var i=this.count;this.visibility=new Tg(i),this.materialDataBuffer=t.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(var r=0;r<i;r++)this.materialDataIndices[r]=this.materialDataBuffer.acquireIndex()}return(0,s.Z)(e,[{key:"destroy",value:function(){for(var e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}},{key:"count",get:function(){return this.offsets.length-1}},{key:"geometryRanges",get:function(){return null==this.cachedGeometryRanges&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}},{key:"highlightRanges",get:function(){return null==this.highlightCounts?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}},{key:"defaultShadowMapRanges",get:function(){return null==this.highlightCounts?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}},{key:"highlightsDirty",value:function(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}},{key:"visibilityDirty",value:function(){this.cachedGeometryRanges=null,this.highlightsDirty()}},{key:"_updateCachedHighlightRanges",value:function(){if((null==this.cachedHighlightRanges||null==this.cachedDefaultRanges)&&null!=this.highlightCounts){var e=function(e,t,n){var i=[],r=[],a=n.length,o=n.length;return t.forEachComponent((function(t){return e[t]>0?(a!==t-1&&(i.length&&i.push(n[a+1]-i[i.length-1]),i.push(n[t])),a=t):(o!==t-1&&(r.length&&r.push(n[o+1]-r[r.length-1]),r.push(n[t])),o=t),!0})),i.length&&i.push(n[a+1]-i[i.length-1]),r.length&&r.push(n[o+1]-r[r.length-1]),{highlightRanges:i,defaultRanges:r}}(this.highlightCounts,this.visibility,this.offsets),t=e.highlightRanges,n=e.defaultRanges;this.cachedHighlightRanges=t,this.cachedDefaultRanges=n}}}]),e}();var kg=function(){function e(t,n,i,r,a,s){(0,o.Z)(this,e),this.transform=t,this.toMapSpace=n,this.obb=i,this.components=r,this.renderable=a,this.intersectionGeometry=s,this.visible=!1,this.offsetObb=null}return(0,s.Z)(e,[{key:"destroy",value:function(){this.intersectionGeometry=(0,x.SC)(this.intersectionGeometry),this.renderable=(0,x.SC)(this.renderable),this.components=(0,x.SC)(this.components)}}]),e}();function Mg(e,t){return new(function(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}(e))(t)}var Pg=function(){function e(t,n){var i,r,a;(0,o.Z)(this,e),this.elementCount=t,this.model=n,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=n.localMode,this.planetCenterZ=n.planetCenterZ,this.geometryMinZ=n.geometryMinZ,this.planetCenter=(0,U.al)(0,0,this.planetCenterZ),this.maxBspNodeDepth=null!==(i=n.maxBspNodeDepth)&&void 0!==i?i:8,this.minElementCountForBVH=null!==(r=n.minElementCountForBVH)&&void 0!==r?r:15,this.minBspNodeElementCount=null!==(a=n.minBspNodeElementCount)&&void 0!==a?a:5}return(0,s.Z)(e,[{key:"elementIndexMap",get:function(){return this._ensureBVH(),this._elementIndexMap}},{key:"_skipBVH",get:function(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}},{key:"_ensureBVH",value:function(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}},{key:"intersectRay",value:function(e,t,n){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(n):this._intersectRayWithBVH(e,t,n))}},{key:"_intersectRayWithoutBVH",value:function(e){this._intersectRange(0,this.elementCount)}},{key:"_intersectRange",value:function(e,t){this.model.intersectRange(e,t)}},{key:"_intersectRayWithBVH",value:function(e,t,n){this._ensureBVH(),n?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}},{key:"_intersectGeometryWithBVHVerticalRay",value:function(e){var t=e[0],n=e[1];if(!this.localMode){var i=this.geometryMinZ,r=this.planetCenterZ,a=(i-r)/(e[2]-r);t=e[0]*a,n=e[1]*a}for(var o=this._bspNodes,s=0;s>=0;){var l=o[s],u=l.d,c=l.dim,h=l.minIndexIndex,d=l.minMidIndexIndex,f=l.maxMidIndexIndex,v=l.maxIndexIndex,p=l.aabb2D;if(t<p[0]||t>p[2]||n<p[1]||n>p[3])break;if(-1===c||-1===l.child0&&-1===l.child1){this._intersectRange(h,v);break}this._intersectRange(d,f);var _=(0===c?t:n)-u;if(_<0){if(-1===l.child0){this._intersectRange(h,d);break}s=l.child0}else{if(!(_>0))break;if(-1===l.child1){this._intersectRange(f,v);break}s=l.child1}}}},{key:"_intersectGeometryWithBVHGeneralRay",value:function(e,t){var n=e[0],i=e[1],r=t[0],a=t[1],o=this.geometryMinZ;if(!this.localMode){var s=0,l=1,u=Math.min(.5*this.planetCenterZ,o),c=e[2],h=t[2];if(c<u&&h<u)return;if(c<u&&(s=(u-c)/(h-c)),h<u&&(l=(u-c)/(h-c)),s>l)return;var d=(1-s)*e[0]+s*t[0],f=(1-s)*e[1]+s*t[1],v=(1-s)*e[2]+s*t[2],p=(1-l)*e[0]+l*t[0],_=(1-l)*e[1]+l*t[1],m=(1-l)*e[2]+l*t[2],g=this.planetCenterZ,y=o-g,b=y/(v-g);n=d*b,i=f*b;var w=y/(m-g);r=p*w,a=_*w}var C=r-n,x=a-i,T=this._bspNodes,S=1,k=T[0].aabb2D,M=function(e,t,n,i){if(Math.abs(t)<1e-5*Math.max(i-n,1))return!1;var r=t>0,a=r?i:n,o=e+S*t;return(r?o<a:o>a)&&(S=Math.max((a-e)/t,S),!0)},P=function(){return M(n,C,k[0],k[2])},R=function(){return M(i,x,k[1],k[3])};Math.abs(C)>=Math.abs(x)?P()||R():R()||P();for(var E=[0,0,S],O=0;O<E.length;){var A=E[O],D=E[O+1],Z=E[O+2];if(O+=3,!(D>Z)){var I=T[A],L=I.minIndexIndex,N=I.maxIndexIndex,U=I.child0,H=I.child1,F=I.minMidIndexIndex,V=I.maxMidIndexIndex,z=I.aabb2D,q=I.d,B=I.dim,G=n+D*C,j=n+Z*C,W=Math.min(G,j),X=Math.max(G,j),Q=z[0],Y=z[2];if(!(X<Q||Y<W)){if(W<Q){var J=(Q-n)/C;C>0?D=Math.max(D,J):Z=Math.min(Z,J)}if(Y<X){var K=(Y-n)/C;C>0?Z=Math.min(Z,K):D=Math.max(D,K)}var $=i+D*x,ee=i+Z*x,te=Math.min($,ee),ne=Math.max($,ee),ie=z[1],re=z[3];if(!(ne<ie||re<te)){if(te<ie){var ae=(ie-i)/x;x>0?D=Math.max(D,ae):Z=Math.min(Z,ae)}if(re<ne){var oe=(re-i)/x;x>0?Z=Math.min(Z,oe):D=Math.max(D,oe)}if(-1===U&&-1===H)this._intersectRange(L,N);else{var se=0===B?n:i,le=0===B?C:x,ue=se+D*le,ce=se+Z*le,he=Math.min(ue,ce),de=Math.max(ue,ce),fe=(0,Se.uZ)((q-se)/le,0,S);L<F&&he<=q&&(-1!==U?(E.push(U),E.push(le>=0?D:Math.max(D,fe)),E.push(le>=0?Math.min(Z,fe):Z)):this._intersectRange(L,F)),this._intersectRange(F,V),V<N&&q<=de&&(-1!==H?(E.push(H),E.push(le>=0?Math.max(D,fe):D),E.push(le>=0?Z:Math.min(Z,fe))):this._intersectRange(V,N))}}}}}}},{key:"_generateBsp",value:function(){var e=this.elementCount;if(!(e<1)){var t=Mg(e,e);this._elementIndexMap=t;for(var n=0;n<e;++n)t[n]=n;var i=this.model.getAabbs2D(),r=0,a=this._bspNodes;a.length=0;var o=this.localMode,s=!1;if(!o){var l=this.planetCenterZ,u=this.geometryMinZ;s=l>=0||u<.5*l}var c=[],h=function(e,t,n,i,r){c.push(e),c.push(t),c.push(n),c.push(i<0?-1:(r?0:1)+2*i)},d=this.maxBspNodeDepth,f=this.minBspNodeElementCount,v=function(e,n,r,l,u){var c=a.length;if(!(c>0&&(s||r>=d||n-e<f))){var v=[0,0,0,0];!function(e,t,n,i,r){for(var a=1/0,o=1/0,s=-1/0,l=-1/0,u=t;u<n;++u){var c=4*i[u];a=Math.min(a,r[c+0]),o=Math.min(o,r[c+1]),s=Math.max(s,r[c+2]),l=Math.max(l,r[c+3])}e[0]=a,e[1]=o,e[2]=s,e[3]=l}(v,e,n,t,i);var p=o?function(e){var t,n,i=e[0],r=e[1],a=e[2],o=e[3];return a-i>=o-r?(n=.5*(i+a),t=0):(n=.5*(r+o),t=1),{d:n,dim:t}}(v):function(e){var t,n,i=e[0],r=e[1],a=e[2],o=e[3];return a-i>=o-r?(t=0,n=.5*(i+a)):(t=1,n=.5*(r+o)),{dim:t,d:n}}(v),_=p.d,m=p.dim,g=function(e,t,n,i,r,a){for(var o=e,s=t;o<s;){var l=r[o];Rg(l,n,i,a)<0?++o:(--s,r[o]=r[s],r[s]=l)}for(var u=o,c=o,h=t;c<h;){var d=r[h-1];Rg(d,n,i,a)>0?--h:(r[h-1]=r[c],r[c]=d,++c)}return{rangeMidStart:u,rangeMidEnd:h}}(e,n,m,_,t,i),y=g.rangeMidStart,b=g.rangeMidEnd,w=r===d-1,C=!w&&y>=e+f,x=!w&&n>=b+f;if(C||x||0===c){var T=new Eg(e,y,b,n,m,_,v);if(C&&h(e,y,r+1,c,!0),x&&h(b,n,r+1,c,!1),a.push(T),-1!==l){var S=a[l];u?S.child0=c:S.child1=c}}}};for(h(0,e,0,-1,!1);r<c.length;){var p=c[r],_=c[r+1],m=c[r+2],g=c[r+3];r+=4;var y=g>>1;v(p,_,m,y,g-(y<<1)==0)}this._generatedBVH=!0}}}]),e}();function Rg(e,t,n,i){var r=4*e,a=i[r+0+t];return i[r+2+t]<n?-1:a>n?1:0}var Eg=(0,s.Z)((function e(t,n,i,r,a,s,l){(0,o.Z)(this,e),this.minIndexIndex=t,this.minMidIndexIndex=n,this.maxMidIndexIndex=i,this.maxIndexIndex=r,this.dim=a,this.d=s,this.aabb2D=l,this.child0=-1,this.child1=-1})),Og=function(){function e(t,n,i,r,a,s,l,u,c){(0,o.Z)(this,e),this.componentIndex=t,this.vertexData=n,this.vertexStride=i,this.indexData=r,this.startTriangleNumber=a,this.endTriangleNumber=s,this.geometryMinZ=l,this.planetCenterZ=u,this.localMode=c,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=(0,U.Ue)(),this.ray0=(0,U.Ue)(),this.isVerticalRay=!1,this._triangleHitCallback=Dg,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new Pg(s-a,this)}return(0,s.Z)(e,[{key:"getAabbs2D",value:function(){return this.localMode?function(e,t,n,i,r){for(var a=t-e,o=new Float64Array(4*a),s=0;s<a;++s){var l=3*(s+e),u=r*n[l+0],c=i[u+0],h=i[u+1],d=r*n[l+1],f=i[d+0],v=i[d+1],p=r*n[l+2],_=i[p+0],m=i[p+1],g=4*s;o[g+0]=Math.min(c,f,_),o[g+1]=Math.min(h,v,m),o[g+2]=Math.max(c,f,_),o[g+3]=Math.max(h,v,m)}return o}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):function(e,t,n,i,r,a,o){for(var s=a-o,l=t-e,u=new Float64Array(4*l),c=0;c<l;++c){var h=3*(c+e),d=r*n[h+0],f=i[d+0],v=i[d+1],p=s/(i[d+2]-o),_=f*p,m=v*p,g=r*n[h+1],y=i[g+0],b=i[g+1],w=s/(i[g+2]-o),C=y*w,x=b*w,T=r*n[h+2],S=i[T+0],k=i[T+1],M=s/(i[T+2]-o),P=S*M,R=k*M,E=4*c;u[E+0]=Math.min(_,C,P),u[E+1]=Math.min(m,x,R),u[E+2]=Math.max(_,C,P),u[E+3]=Math.max(m,x,R)}return u}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}},{key:"numTriangles",get:function(){return this.endTriangleNumber-this.startTriangleNumber}},{key:"intersectRay",value:function(e,t,n,i,r,a){(0,et.c)(this.ray0,e),(0,et.z)(this.rayDirection,t,e),this.isVerticalRay=n,this.totalElevationOffset=i,this.normalRequired=a,this._triangleHitCallback=r,this._bvh.intersectRay(e,t,n),this._triangleHitCallback=Dg}},{key:"intersectRange",value:function(e,t){var n=this._bvh.elementIndexMap;Ag(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,n,this.startTriangleNumber)}},{key:"getTriangleElevationOffset",value:function(e){return this.totalElevationOffset}}]),e}();function Ag(e,t,n,i,r,a,o,s,l,u,c){var h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,d=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0;0!==s?(0,i_.ko)(e,t,n,i,r,a,o,s,l,u,c,h,d):(0,i_.ET)(e,t,n,i,r,a,o,u,c,h,d)}function Dg(){}function Zg(e,t,n,i){if(n>=t)return e;null==e&&(e=function(){return{isVisibleBit:!(!(arguments.length>0&&void 0!==arguments[0])||arguments[0]),data:new Uint32Array(0)}}());var r=e.isVisibleBit,a=e.data,o=Lg(a),s=n/o|0,l=n-o*s,u=(t-1)/o|0,c=a,h=i===r;if(!(n<c.length*o)&&h){var d=s+1,f=Math.ceil(c.length*gd._x),v=u+1,p=Math.max(d,f);p=Math.min(p,v),(a=new Uint32Array(p)).set(c)}return s<a.length&&(a[s]=function(e,t,n){return e&~(1<<t)|(n?1:0)<<t}(a[s],l,h)),e.data=a,e}function Ig(e,t){if(null==e)return!0;var n=e.isVisibleBit,i=e.data,r=Lg(i);return t<i.length*r?function(e,t,n,i){var r=n/i|0,a=n-r*i;return function(e,t){return!!(e&1<<t)}(t[r],a)===e}(n,i,t,r):!e.isVisibleBit}function Lg(e){return 8*e.BYTES_PER_ELEMENT}var Ng=function(){function e(t,n,i,r,a,s,l,u){(0,o.Z)(this,e),this.vertexData=t,this.vertexStride=n,this.indexData=i,this._components=r,this._componentAabbs3D=a,this.geometryMinZ=s,this.planetCenterZ=l,this.localMode=u,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=Vg,this._ray1=zg,this._invDir=(0,U.Ue)(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=Bg,this._callback=qg,this.rayDirectionC=(0,U.Ue)(),this._componentIndexMap=null,this._bvh=new Pg(r.count,this),this.componentIntersectionData=new Array(r.count)}return(0,s.Z)(e,[{key:"numComponents",get:function(){return this._components.count}},{key:"minZGlobal",get:function(){return this.geometryMinZ-this.planetCenterZ}},{key:"getAabbs2D",value:function(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}},{key:"getAabbs2DGlobal",value:function(){for(var e=this.numComponents,t=this.planetCenterZ,n=this.minZGlobal,i=new Float64Array(4*e),r=this._componentAabbs3D,a=0;a<e;++a){var o=6*a,s=r[o+0],l=r[o+1],u=r[o+2],c=r[o+3],h=r[o+4],d=n/(u-t),f=n/(r[o+5]-t),v=Math.min(s*d,s*f),p=Math.min(l*d,l*f),_=Math.max(c*d,c*f),m=Math.max(h*d,h*f),g=4*a;i[g+0]=v,i[g+1]=p,i[g+2]=_,i[g+3]=m}return i}},{key:"getAabbs2DLocal",value:function(){for(var e=this.numComponents,t=new Float64Array(4*e),n=this._componentAabbs3D,i=0;i<e;++i){var r=6*i,a=n[r+0],o=n[r+1],s=n[r+3],l=n[r+4],u=4*i;t[u+0]=a,t[u+1]=o,t[u+2]=s,t[u+3]=l}return t}},{key:"intersectRay",value:function(e,t,n,i,r,a,o){var s=o.isVerticalRay;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=n,this._verticalOffset=i,this._tolerance=a,this._intersectionOptions=o,this._componentIndexMap=this._bvh.elementIndexMap,(0,i_.Ue)(e,t,this._invDir),this._callback=r,this._bvh.intersectRay(e,t,s),this._callback=qg}},{key:"intersectRange",value:function(e,t){for(var n=this._componentIndexMap,i=this._components,r=i.pickability,a=i.visibility,o=e;o<t;++o){var s=n?n[o]:o;Ig(r,s)&&a.isVisible(s)&&this._intersectComponent(s)}}},{key:"getComponentTriangleCount",value:function(e){var t=this._components.offsets,n=t[e]/3;return t[e+1]/3-n}},{key:"getComponentAabb3D",value:function(e,t){var n=this._componentAabbs3D,i=6*e;return t[0]=n[i],t[1]=n[i+1],t[2]=n[i+2],t[3]=n[i+3],t[4]=n[i+4],t[5]=n[i+5],t}},{key:"_intersectComponent",value:function(e){var t,n,i=this;if(Ig(this._components.pickability,e)){var r=this.getComponentAabb3D(e,Ug),a=!1,o=this.localMode,s=this._componentVerticalOffsets,l=this._verticalOffset,u=this._ray0,c=this._ray1,h=this._invDir,d=this.planetCenterZ,f=this._tolerance,v=this.rayDirectionC,p=this.componentIntersectionData,_=this._intersectionOptions.isVerticalRay,m=this._components.offsets,g=(0,et.c)(Hg,u),y=(0,et.c)(Fg,c),b=null!==(t=null===s||void 0===s?void 0:s[e])&&void 0!==t?t:0,w=b+(null!==(n=null===l||void 0===l?void 0:l.offset)&&void 0!==n?n:0);if(0!==w&&(o?(g[2]=u[2]-w,y[2]=c[2]-w,a=!0):null!=l&&(l.componentOffset=b)),null==l||a||0===w||l.applyToAabb(r),(0,i_.Tw)(r,g,h,f)){(0,et.z)(v,y,g);var C=m[e]/3,x=m[e+1]/3,T=x-C,S=function(t,n,r){i._callback(t,n,e,r)},k=this.vertexData,M=this.vertexStride,P=this.indexData,R=this._intersectionOptions.normalRequired;if(T>Gg){var E=p[e];null==E&&(E=new Og(e,k,M,P,C,x,this.geometryMinZ,d,o),p[e]=E),E.intersectRay(g,y,_,a?0:w,S,R)}else Ag(g,v,C,x,P,k,M,a?0:w,d,R,S)}}}}]),e}(),Ug=(0,vv.Ue)(),Hg=(0,U.Ue)(),Fg=(0,U.Ue)(),Vg=(0,U.Ue)(),zg=(0,U.Ue)(),qg=function(){},Bg=new i_.sT,Gg=40,jg=function(){function e(t,n,i){(0,o.Z)(this,e),this.viewingMode=t,this.positionData=n,this._components=i,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=(0,U.Ue)(),this._componentBvh=null,this._aabb=[0,0,0,0,0,0],this._indices=n.indices?(0,yg.mi)(n.indices):(0,yg.KF)(n.positions.length/3),this._positions=n.positions}return(0,s.Z)(e,[{key:"destroy",value:function(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}},{key:"getComponentAabb",value:function(e,t){var n=this._ensureComponentAabbs(),i=6*e;return t[0]=n[i],t[1]=n[i+1],t[2]=n[i+2],t[3]=n[i+3],t[4]=n[i+4],t[5]=n[i+5],t}},{key:"getComponentAabbs",value:function(){return this._ensureComponentAabbs()}},{key:"_ensureComponentAabbs",value:function(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}},{key:"getComponentPositions",value:function(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}},{key:"intersect",value:function(e,t,n,i,r,a,o,s){this.verticalOffset=i,this.componentVerticalOffsets=r;var l=a.position,u=(0,et.z)(Wg,e,l),c=(0,et.z)(Xg,t,l),h=(0,Lt.U_)(Qg,a.rotationScale);(0,et.t)(u,u,h),(0,et.t)(c,c,h);var d=(0,Lt.p4)(Jg,h);if(this.viewingMode===he.JY.Global){var f=this._planetCenter;(0,et.k)(f,l),(0,et.t)(f,f,h)}this._intersectComponents(u,c,r,i,(function(e,t,n,i){s(n,e,i?(0,et.t)(Yg,i,d):null,t)}),n,o)}},{key:"_computePerComponentAabbs",value:function(){for(var e=this._aabb,t=.5*(e[0]+e[3]),n=.5*(e[1]+e[4]),i=.5*(e[2]+e[5]),r=this._components.count,a=(0,Pn.xx)(6*r),o=this._indices,s=this._positions,l=this._components.offsets,u=0,c=1/0,h=1/0,d=1/0,f=-1/0,v=-1/0,p=-1/0,_=0;_<r;_++){var m=l[_],g=l[_+1],y=1/0,b=1/0,w=1/0,C=-1/0,x=-1/0,T=-1/0;if(m<g)for(var S=m;S<g;S++){var k=3*o[S],M=s[k],P=s[k+1],R=s[k+2];y=Math.min(y,M),b=Math.min(b,P),w=Math.min(w,R),C=Math.max(C,M),x=Math.max(x,P),T=Math.max(T,R)}else y=t,b=n,w=i,C=t,x=n,T=i;a[u++]=y,a[u++]=b,a[u++]=w,a[u++]=C,a[u++]=x,a[u++]=T,c=Math.min(c,y),h=Math.min(h,b),d=Math.min(d,w),f=Math.max(f,C),v=Math.max(v,x),p=Math.max(p,T)}return this._aabb[0]=c,this._aabb[1]=h,this._aabb[2]=d,this._aabb[3]=f,this._aabb[4]=v,this._aabb[5]=p,a}},{key:"_intersectComponents",value:function(e,t,n,i,r,a,o){var s=this._componentBvh;null==s&&(s=new Ng(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=s),s.intersectRay(e,t,n,i,r,a,o)}},{key:"geometryMinZ",get:function(){return this._aabb[2]}},{key:"planetCenterZ",get:function(){return this._planetCenter[2]}},{key:"numTriangles",get:function(){return this._indices.length/3}},{key:"localMode",get:function(){return this.viewingMode===he.JY.Local}},{key:"positions",get:function(){return this._positions}},{key:"indices",get:function(){return this._indices}},{key:"aabb",get:function(){return this._ensureComponentAabbs(),this._aabb}}]),e}(),Wg=(0,U.Ue)(),Xg=(0,U.Ue)(),Qg=(0,Ir.Ue)(),Yg=(0,U.Ue)(),Jg=(0,Ir.Ue)(),Kg=function(){function e(t,n,i){(0,o.Z)(this,e),this.material=t,this.geometry=n,this.meta=i}return(0,s.Z)(e,[{key:"destroy",value:function(){this.material.dispose(),this.geometry.dispose()}}]),e}(),$g=function(){function e(t,n,i,r){(0,o.Z)(this,e),this.vao=t,this.primitiveType=n,this.parameters=i,this.indexed=r}return(0,s.Z)(e,[{key:"dispose",value:function(){this.vao.dispose()}}]),e}(),ey=(0,s.Z)((function e(){(0,o.Z)(this,e),this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}));function ty(e){return e?ny(e,1/0,-1/0):function(e,t){return{near:e,far:t}}(1/0,-1/0)}function ny(e,t,n){return e.near=t,e.far=n,e}function iy(e,t){null!=t&&(e.near=Math.min(e.near,t.near),e.far=Math.max(e.far,t.far))}function ry(e,t){return e.near<=t&&t<=e.far}var ay={near:0,far:0};function oy(e,t){var n=ty(),i=e.eye,r=e.frustum,a=e.viewForward;t.forAll((function(e){var t=null!=e.offsetObb?e.offsetObb:e.obb,o=(0,et.m)((0,et.z)(by,t.center,i),a),s=t.projectedRadius(a);if(!ry(n,o-s)||!ry(n,o+s)){var l=function(e,t){for(var n=0,i=0;i<my;i++){var r=e.intersectPlane(t[i]);if(r>0)return-1;0===r&&(n|=1<<i)}return n}(t,r);if(-1!==l){if(0===l)return ly.far=o+s,ly.near=o-s,void iy(n,ly);var u=sy.pushNew();u.near=o-s,u.far=o+s,u.mask=l,u.object=e}}}));for(var o=function(e){var t=sy.data[e];if(ry(n,t.near)&&ry(n,t.far))return"continue";ly.far=t.far,ly.near=1/0;var o=function(e,t,n,i){(0,aa.Kx)(yy,e.quaternion),(0,et.z)(by,t,e.center),(0,et.u)(by,by,yy);var r=e.halfSize,a=8*((by[0]<-r[0]?-1:by[0]>r[0]?1:0)+3*(by[1]<-r[1]?-1:by[1]>r[1]?1:0)+9*(by[2]<-r[2]?-1:by[2]>r[2]?1:0)+13),o=_y[a];if(0===o)return o;(0,Lt.en)(gy,e.quaternion),(0,Lt.bA)(gy,gy,e.halfSize);var s=function(t,n){var i=_y[a+n+1];return(0,et.s)(t,((1&i)<<1)-1,(2&i)-1,((4&i)>>1)-1),(0,et.t)(t,t,gy),(0,et.g)(t,e.center,t)};return n.length=0,py(n,s(wy,0)),py(n,s(Cy,1)),py(n,s(by,2)),py(n,s(xy,3)),i(n),1===o||(n.length=0,py(n,wy),py(n,xy),py(n,s(by,4)),py(n,s(Ty,5)),i(n),2===o||(n.length=0,py(n,wy),py(n,Ty),py(n,s(by,6)),py(n,Cy),i(n))),o}(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,i,hy,(function(e){for(var n=dy,o=0;o<my&&e.length>0;o++)if(t.mask&1<<o){fy(r[o],e,n);var s=e;e=n,n=s}for(var l=0;l<e.length;l+=3){(0,et.s)(uy,e.data[l],e.data[l+1],e.data[l+2]);var u=(0,et.m)((0,et.z)(uy,uy,i),a);ly.near=Math.min(ly.near,u)}}));0===o&&(ly.near=0),iy(n,ly)},s=0;s<sy.length;s++)o(s);return sy.length=0,n}var sy=new Fl.Z({allocator:function(e){return e||{near:1/0,far:-1/0,mask:0,object:null}},deallocator:function(e){return e.object=null,e}}),ly=ty(),uy=(0,U.Ue)(),cy=(0,U.Ue)(),hy=new Fl.Z({deallocator:null}),dy=new Fl.Z({deallocator:null});function fy(e,t,n){n.length=0;var i=t.length-3;vy(uy,t,i);var r=(0,va.jH)(e,uy);r<=0&&(n.push(uy[0]),n.push(uy[1]),n.push(uy[2]));for(var a=0,o=r;a<i;a+=3){vy(cy,t,a);var s=(0,va.jH)(e,cy);o*s<0&&((0,et.o)(uy,cy,uy,s/(s-o)),py(n,uy)),s<=0&&py(n,cy),o=s,(0,et.c)(uy,cy)}o*r<0&&(vy(cy,t,i),(0,et.o)(uy,cy,uy,r/(r-o)),py(n,uy))}function vy(e,t,n){return(0,et.s)(e,t.data[n],t.data[n+1],t.data[n+2])}function py(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}var _y=function(){var e=new Array(216),t=0,n=function(n){for(var i=0;i<n.length;i++)e[t+i]=n[i];t+=8};return n([3,0,6,2,3,1,5,4]),n([2,0,2,3,1,5,4,0]),n([3,1,0,2,3,7,5,4]),n([2,0,1,3,2,6,4,0]),n([1,0,1,3,2,0,0,0]),n([2,1,5,7,3,2,0,0]),n([3,2,0,1,3,7,6,4]),n([2,2,0,1,3,7,6,0]),n([3,3,0,1,5,7,6,2]),n([2,0,1,5,4,6,2,0]),n([1,0,1,5,4,0,0,0]),n([2,1,3,7,5,4,0,0]),n([1,0,2,6,4,0,0,0]),n([0,0,0,0,0,0,0,0]),n([1,1,3,7,5,0,0,0]),n([2,2,3,7,6,4,0,0]),n([1,2,3,7,6,0,0,0]),n([2,3,1,5,7,6,2,0]),n([3,4,0,1,5,7,6,2]),n([2,5,7,6,4,0,1,0]),n([3,5,0,1,3,7,6,4]),n([2,4,5,7,6,2,0,0]),n([1,4,5,7,6,0,0,0]),n([2,5,1,3,7,6,4,0]),n([3,6,0,2,3,7,5,4]),n([2,6,2,3,7,5,4,0]),n([3,7,6,2,3,1,5,4]),e}(),my=4;var gy=(0,Ir.Ue)(),yy=(0,oa.Ue)(),by=(0,U.Ue)(),wy=(0,U.Ue)(),Cy=(0,U.Ue)(),xy=(0,U.Ue)(),Ty=(0,U.Ue)(),Sy=function(){function e(t){(0,o.Z)(this,e),this._objects=t}return(0,s.Z)(e,[{key:"submit",value:function(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((function(n){return n.renderable.material.submit(e,t,n)}))}},{key:"queryShadowCasterDepthRange",value:function(e){return this._objects.visibleObjects.length?oy(e,this._objects.visibleObjects):null}}]),e}(),ky=n(92911),My=(0,s.Z)((function e(){(0,o.Z)(this,e),this.externalColor=(0,st.Ue)(),this.externalColorMixMode=Cg.a9.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0})),Py=n(46987),Ry=n(9028),Ey=n(37107),Oy=n(67009),Ay=n(79762),Dy=n(99905),Zy=n(45412),Iy=function(){return C.Z.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection")},Ly=function(){function e(t,n){(0,o.Z)(this,e),this._renderManager=t,this._viewingMode=n,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._visible=new Fl.Z,this._hidden=new Fl.Z,this._renderSubmit=new Sy(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=(0,w.Z)("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new Dy.g(t.rctx,2+(this._hasObjectAndLayerId?1:0))}return(0,s.Z)(e,[{key:"destroy",value:function(){(0,En.hu)(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll((function(e){return e.destroy()})),this._hidden.forAll((function(e){return e.destroy()})),this._visible.clear(),this._hidden.clear()}},{key:"createObject",value:function(e){var t=e.geometry,n=new Sg(this._componentBufferManager,(0,yg.mi)(t.componentOffsets)),i=this._createRenderable(e,n),r=new jg(this._viewingMode,t.positionData,n),a=new kg(e.transform,e.toMapSpace,e.obb.clone(),n,i,r);return(a.visible?this._visible:this._hidden).push(a),a}},{key:"destroyObject",value:function(e){var t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}},{key:"setObjectVisibility",value:function(e,t){var n=e;t!==n.visible&&(t?(this._hidden.removeUnordered(n),this._visible.push(n)):(this._visible.removeUnordered(n),this._hidden.push(n)),n.visible=t,this._notifyDirty())}},{key:"preSubmit",value:function(e){var t=e.camera.eye;this.visibleObjects.forAll((function(e){return e.renderable.meta.cameraDepthSquared=(0,et.a)(t,e.obb.center)}))}},{key:"getMaterial",value:function(e){return e.renderable.material}},{key:"updateMaterial",value:function(e,t){var n=e.renderable.material;t(n),n.dirty&&this._notifyDirty()}},{key:"setAllComponentVisibilities",value:function(e,t){var n=e;n.components.visibility.reset(t),n.components.visibilityDirty(),this._notifyDirty()}},{key:"forEachVisibleComponent",value:function(e,t){return e.components.visibility.forEachComponent(t)}},{key:"getComponentCount",value:function(e){var t=e,n=t.components.visibility.componentCount;return{visible:n,invisible:t.components.count-n}}},{key:"setComponentData",value:function(e,t){for(var n,i=e,r=i.renderable.material,a=i.components,o=a.materialDataBuffer,s=a.materialDataIndices,l=new My,u=o.textureBuffer,c=new Uint8Array(4),h=new Uint32Array(c.buffer),d=0,f=0,v=0,p=a.verticalOffsets,_=1/0,m=-1/0,g=!1,y=!1,b=0,w=0;w<a.count;w++){t(w,l),d+=+(l.externalColor[3]<1),f+=+(l.externalColorMixMode===Cg.a9.Replace&&1===l.externalColor[3]),v+=+l.castShadows,(0,Cg.HB)(l.externalColor,l.externalColorMixMode,c),c[2]=254&c[2]|+l.castShadows,u.setData(s[w],0,c[0],c[1],c[2],c[3]),g||(g=w>0&&b!==h[0]),b=h[0],y||(y=0!==l.elevationOffset),y&&null==p&&(p=new Array(w).fill(0)),null!=p&&(p[w]=l.elevationOffset),_=Math.min(_,l.elevationOffset),m=Math.max(m,l.elevationOffset),(0,Ey.nO)(l.elevationOffset,c),u.setData(s[w],1,c[0],c[1],c[2],c[3]);var C=l.objectAndLayerIdColor;null!=C&&u.setData(s[w],2,C[0],C[1],C[2],C[3]),l.pickable!==Ig(a.pickability,w)&&(a.pickability=Zg(a.pickability,a.count,w,l.pickable))}a.verticalOffsets=y?p:null,i.offsetObb=y?(0,xg.gI)(i.obb,_,m,this._viewingMode,null!==(n=i.offsetObb)&&void 0!==n?n:i.obb.clone()):null,g||y||this._hasObjectAndLayerId?(r.componentParameters=new Py.Qu,r.componentParameters.castShadows=Uy(v,a.count),r.componentParameters.transparent=Uy(d,a.count),r.componentParameters.opaqueOverride=Uy(f,a.count),r.componentParameters.texture=u,u.updateTexture()):(r.componentParameters=new Py.zO,r.componentParameters.castShadows=l.castShadows?Py.ws.All:Py.ws.None,r.componentParameters.externalColor=l.externalColor,r.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}},{key:"getComponentAabb",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e.intersectionGeometry.getComponentAabb(t,n);var r=e,a=r.components.verticalOffsets;if(i||null==a)return n;var o=a[t];if(this._viewingMode===he.JY.Local||0===o)return n[2]+=o,n[5]+=o,n;var s=(0,ya.iO)(o);return s.localOrigin=r.transform.position,s.applyToAabb(n)}},{key:"getComponentObb",value:function(e){return e.obb}},{key:"getObjectTransform",value:function(e){return e.transform}},{key:"getComponentPositions",value:function(e,t,n){return e.intersectionGeometry.getComponentPositions(t,n)}},{key:"expandRangeWithComponentObjectElevationRange",value:function(e,t,n,i){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||i.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);for(var r=e,a=r.components,o=a.count,s=a.verticalOffsets,l=r.intersectionGeometry,u=this._viewingMode===he.JY.Local,c=l.getComponentAabbs(),h=Hy,d=1/0,f=-1/0,v=0;v<o;v++){var p,_=6*v,m=null!==(p=null===s||void 0===s?void 0:s[v])&&void 0!==p?p:0,g=1/0,y=-1/0;if(u)g=c[_+2]+m+t,y=c[_+5]+m+t;else{if(h[0]=c[_],h[1]=c[_+1],h[2]=c[_+2],h[3]=c[_+3],h[4]=c[_+4],h[5]=c[_+5],0!==m){var b=(0,ya.iO)(m);b.localOrigin=r.transform.position,b.applyToAabb(h)}var w=Math.max(Math.abs(h[3]),Math.abs(h[0])),C=Math.max(Math.abs(h[4]),Math.abs(h[1])),x=t+h[5]+n;i.expandElevationRangeValues(t+h[2],Math.sqrt(w*w+C*C+x*x)-n)}i.expandElevationRangeValues(g,y),d=Math.min(d,g),f=Math.max(f,y)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=d,this._elevationRangeCacheMax=f}},{key:"intersect",value:function(e,t,n,i,r,a,o){var s=e,l=s.transform,u=l.position;return null!=r&&(r.localOrigin=u),s.intersectionGeometry.intersect(t,n,i,r,s.components.verticalOffsets,l,a,o)}},{key:"addEdges",value:function(e,t,n,i,r){var a=e,o=a.intersectionGeometry,s=o.indices,l=o.positions,u=a.components.offsets;return t.addComponentObject(a,l,s,u,n,i,r)}},{key:"extractEdgeInformation",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n,i){var a,o,s,l,u,c,h,d,f;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o=(a=t).components.visibility).allInvisible()){e.next=3;break}return e.abrupt("return",{buffer:Ay.n_.createBuffer(0),origin:[0,0,0]});case 3:return s=a.intersectionGeometry,l=s.indices,u=s.positions,c=a.components.offsets,h=Oy.tf.createBuffer(u.length/3),(0,wg.c)(h.position.typedBuffer,u,h.position.typedBufferStride,3),(0,bg.c)(h.position,h.position,a.transform.rotationScale),this._setComponentIndices(h.componentIndex,l,c),d=h.count,f=this._computeVisibilityIndices(l,o,c,d),e.t0=(0,U.d9)(a.transform.position),e.next=9,n.extractComponentsEdgeLocations({indices:f,indicesLength:f.length,skipDeduplicate:!0,data:h,writerSettings:{reducedPrecision:!1,variants:0}},i);case 9:return e.t1=e.sent,e.abrupt("return",{origin:e.t0,buffer:e.t1});case 11:case"end":return e.stop()}}),e,this)})));return function(t,n,i){return e.apply(this,arguments)}}()},{key:"_setComponentIndices",value:function(e,t,n){for(var i=0,r=0;r<n.length-1;r++){for(var a=n[r],o=n[r+1],s=a;s<o;s++){var l=t?t[s]:s;e.set(l,i)}i++}}},{key:"_computeVisibilityIndices",value:function(e,t,n,i){if(e&&t.allVisible())return e;var r=0;t.forEachComponentRange((function(e,t){return r+=n[t]-n[e],!0}));var a=(0,gg.kJ)(e)?new Array(r):2===(null===e||void 0===e?void 0:e.BYTES_PER_ELEMENT)||i<=65536?new Uint16Array(r):new Uint32Array(r),o=0;return t.forEachComponentRange((function(t,i){for(var r=n[t],s=n[i],l=r;l<s;l++)a[o++]=e?e[l]:l;return!0})),a}},{key:"addComponentHighlight",value:function(e,t){var n=e.components;null==n.highlightCounts&&(n.highlightCounts=new Uint32Array(n.count+1)),0===n.highlightCounts[t]++&&(n.highlightsDirty(),this._notifyDirty()),n.highlightCounts[n.count]++}},{key:"removeComponentHighlight",value:function(e,t){var n=e.components;if(null!=n.highlightCounts){var i=n.highlightCounts[t],r=n.highlightCounts[n.count];if(0!==i){if(i>1)return n.highlightCounts[t]=i-1,void(n.highlightCounts[n.count]=r-1);n.highlightCounts[t]=0,n.highlightsDirty(),this._notifyDirty(),1===r?n.highlightCounts=null:n.highlightCounts[n.count]=r-1}else Iy().warn("Removing non-existing highlight.")}else Iy().warn("Removing non-existing highlight.")}},{key:"clearHighlights",value:function(e){var t=e.components;null!=t.highlightCounts&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}},{key:"getObjectGPUMemoryUsage",value:function(e){return e.renderable.meta.gpuMemoryEstimate}},{key:"visibleObjects",get:function(){return this._visible}},{key:"_createRenderable",value:function(e,t){for(var n=this._renderManager.rctx,i=e.geometry,r=i.vertices.layoutParameters,a=Cn.f.createVertex(n,_t.l1.STATIC_DRAW,i.vertices.data),o=i.indices?Cn.f.createIndex(n,_t.l1.STATIC_DRAW,i.indices):null,s=(0,mn.K)((0,ky.N)(r)),l=new Uint16Array(i.vertices.count),u=0;u<t.count;u++){var c=t.offsets[u],h=t.offsets[u+1],d=t.materialDataIndices[u];if(null!=i.indices)for(var f=c;f<h;f++)l[i.indices[f]]=d;else for(var v=c;v<h;v++)l[v]=d}var p=Cn.f.createVertex(n,_t.l1.STATIC_DRAW,l.buffer),_=new Py.Un(e.transform,e.toMapSpace),m=new Zy.U(n,Ry.V,{data:s,componentIndices:Ny},{data:a,componentIndices:p},o),g=new $g(m,_t.MX.TRIANGLES,r,null!=o),y={cameraDepthSquared:.5,gpuMemoryEstimate:a.usedMemory+p.usedMemory+(null!=o?o.usedMemory:0)};return new Kg(_,g,y)}},{key:"_notifyDirty",value:function(){this._renderManager.notifyDirty()}}]),e}(),Ny=(0,mn.K)((0,gn.U$)().u16(wn.T.COMPONENTINDEX));function Uy(e,t){return e===t?Py.ws.All:0===e?Py.ws.None:Py.ws.Some}var Hy=(0,vv.Ue)(),Fy=n(51992),Vy=n(31239),zy=n(90765),qy=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.SRC_ALPHA,_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),colorWrite:mt.BK})}}]),n}(ft.A);qy.shader=new dt.J(zy.H,(function(){return n.e(14958).then(n.bind(n,14958))}));var By=n(56384),Gy=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({colorWrite:mt.BK})}}]),n}(ft.A);Gy.shader=new dt.J(By.a,(function(){return n.e(61507).then(n.bind(n,61507))}));var jy=n(69012),Wy=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({colorWrite:mt.BK})}}]),n}(ft.A);Wy.shader=new dt.J(jy.a,(function(){return n.e(72771).then(n.bind(n,72771))}));var Xy=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).color=(0,st.al)(1,0,1,1),e.haloColor=(0,st.al)(1,0,1,1),e.haloOpacity=1,e.haloOpacityOccluded=.25,e.fillOpacity=.2,e.fillOpacityOccluded=.05,e.coverageRounding=(0,ut.al)(1,1),e}return(0,s.Z)(n)}(ht.K),Qy=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).produces="highlight-color",i.consumes={required:["highlight-color","highlights"]},i._passParameters=new Xy,i._downsampleDrawParameters=new jy.H,i._blurDrawParameters=new By.H,i._blurColorFormat=(0,w.Z)("mac")?xt.q.RGBA:xt.q.RGBA4,i._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0},i._blurTechnique=e.techniques.acquire(Gy),i._downsampleTechnique=e.techniques.acquire(Wy),i._applyTechnique=e.techniques.acquire(qy),i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([(0,k.watch)((function(){return e.view.highlightOptions.color}),(function(t){e._passParameters.color=(0,it.O)(null!==t&&void 0!==t?t:qh),e.view.highlightOptions.haloColor||(e._passParameters.haloColor=e._passParameters.color),e.requestRender(Kf.Xx.UPDATE)}),k.syncAndInitial),(0,k.watch)((function(){return e.view.highlightOptions.haloColor}),(function(t){e._passParameters.haloColor=null!=t?(0,it.O)(t):e._passParameters.color,e.requestRender(Kf.Xx.UPDATE)}),k.syncAndInitial),(0,k.watch)((function(){return e.view.highlightOptions.haloOpacity}),(function(t){e._passParameters.haloOpacity=null!==t&&void 0!==t?t:1,e._passParameters.haloOpacityOccluded=.25*e._passParameters.haloOpacity,e.requestRender(Kf.Xx.UPDATE)}),k.syncAndInitial),(0,k.watch)((function(){return e.view.highlightOptions.fillOpacity}),(function(t){e._passParameters.fillOpacity=null!==t&&void 0!==t?t:Bh,e._passParameters.fillOpacityOccluded=.25*e._passParameters.fillOpacity,e.requestRender(Kf.Xx.UPDATE)}),k.syncAndInitial)])}},{key:"destroy",value:function(){this._blurTechnique.release(),this._downsampleTechnique.release(),this._applyTechnique.release(),this._grid.coverage=(0,x.RY)(this._grid.coverage),this._grid.vao=(0,x.M2)(this._grid.vao)}},{key:"render",value:function(e){var t,n,i;if(this.bindParameters.decorations===Kf.Iq.OFF)return e.find((function(e){return"highlight-color"===e.name}));if(!(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled))return this.requestRender(Kf.Xx.UPDATE),e.find((function(e){return"highlight-color"===e.name}));var r=e.find((function(e){return"highlights"===e.name})).getTexture(),a=this.bindParameters.camera,o=a.fullWidth,s=a.fullHeight,l=a.pixelRatio,u=Math.ceil(o/l),c=Math.ceil(s/l),h=this.renderingContext;this._gridUpdateResources(r),this._gridComputeCoverage(r,this.bindParameters),this._passParameters.highlightTexture=r,this._passParameters.coverageTexture=null===(t=this._grid.coverage)||void 0===t?void 0:t.getTexture();var d=r.descriptor,f=d.width,v=d.height;(0,at.t8)(this._passParameters.coverageRounding,f/(Math.ceil(f/jy.g)*jy.g),v/(Math.ceil(v/jy.g)*jy.g));var p=this._grid.vao;h.bindVAO(p);var _=this.fboCache.acquire(u,c,"highlight blur",this._blurColorFormat);h.unbindTexture(null===(n=_.fbo)||void 0===n?void 0:n.colorTexture),h.bindFramebuffer(_.fbo),h.setClearColor(0,0,0,0),h.clear(_t.lk.COLOR_BUFFER_BIT),h.setViewport(0,0,u,c),this._blurDrawParameters.blurInputTexture=r,(0,at.t8)(this._blurDrawParameters.blurSize,1/u,0);var m=h.bindTechnique(this._blurTechnique,this.bindParameters,this._passParameters,this._blurDrawParameters);h.drawArrays(this._blurTechnique.primitiveType,0,(0,Tn._V)(p,"geometry"));var g=this.fboCache.acquire(u,c,"highlight blur",this._blurColorFormat);h.unbindTexture(null===(i=g.fbo)||void 0===i?void 0:i.colorTexture),h.bindFramebuffer(g.fbo),h.setClearColor(0,0,0,0),h.clear(_t.lk.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=_.getTexture(),(0,at.t8)(this._blurDrawParameters.blurSize,0,1/c),m.bindDraw(this._blurDrawParameters,this.bindParameters,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,(0,Tn._V)(p,"geometry"));var y=e.find((function(e){return"highlight-color"===e.name}));return h.bindFramebuffer(y.fbo),h.setViewport4fv(a.fullViewport),this._passParameters.blurTexture=g.getTexture(),h.bindTechnique(this._applyTechnique,this.bindParameters,this._passParameters),h.drawArrays(this._applyTechnique.primitiveType,0,(0,Tn._V)(p,"geometry")),_.release(),g.release(),y}},{key:"_gridUpdateResources",value:function(e){var t,n=this.renderingContext,i=this._grid,r=Math.ceil(e.descriptor.height/jy.g),a=Math.ceil(e.descriptor.width/jy.g);if(!i.vao||i.verticalCellCount!==r||i.horizontalCellCount!==a){i.verticalCellCount=r,i.horizontalCellCount=a;for(var o=r+1,s=a+1,l=1/r,u=1/a,c=new Float32Array(24*o*s),h=0,d=0;d<o;d++)for(var f=0;f<s;f++)c[h++]=(f-.5)*u*2-1,c[h++]=(d-.5)*l*2-1,c[h++]=f*u,c[h++]=d*l,c[h++]=(f+.5)*u*2-1,c[h++]=(d-.5)*l*2-1,c[h++]=f*u,c[h++]=d*l,c[h++]=(f-.5)*u*2-1,c[h++]=(d+.5)*l*2-1,c[h++]=f*u,c[h++]=d*l,c[h++]=(f-.5)*u*2-1,c[h++]=(d+.5)*l*2-1,c[h++]=f*u,c[h++]=d*l,c[h++]=(f+.5)*u*2-1,c[h++]=(d-.5)*l*2-1,c[h++]=f*u,c[h++]=d*l,c[h++]=(f+.5)*u*2-1,c[h++]=(d+.5)*l*2-1,c[h++]=f*u,c[h++]=d*l;null!==(t=i.vao)&&void 0!==t&&t.dispose(),i.vao=new bn.U(n,vt.i,{geometry:Tt.Bn},{geometry:Cn.f.createVertex(n,_t.l1.STATIC_DRAW,c)})}}},{key:"_gridComputeCoverage",value:function(e,t){var n,i,r=this.renderingContext,a=this._grid,o=e.descriptor,s=Math.ceil(o.width/jy.g),l=Math.ceil(o.height/jy.g);this._downsampleDrawParameters.input=e,null!==(n=a.coverage)&&void 0!==n&&n.release(),a.coverage=this.fboCache.acquire(s,l,"highlight coverage",xt.q.RG),r.unbindTexture(null===(i=a.coverage.fbo)||void 0===i?void 0:i.colorTexture),r.bindFramebuffer(a.coverage.fbo),r.bindTechnique(this._downsampleTechnique,t,this._passParameters,this._downsampleDrawParameters),r.setViewport(0,0,s,l),r.screen.draw()}},{key:"test",get:function(){}}]),n}(Vy.Z);(0,f._)([(0,E.Cb)()],Qy.prototype,"produces",void 0),(0,f._)([(0,E.Cb)()],Qy.prototype,"consumes",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],Qy.prototype,"techniques",void 0),Qy=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Qy);var Yy=n(93511),Jy=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).receiveShadows=!0,e}return(0,s.Z)(n)}(bt.m);(0,f._)([(0,bt.o)()],Jy.prototype,"receiveShadows",void 0);var Ky=n(38727),$y=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).shadowColor=(0,st.al)(1,0,1,1),e.shadowOpacity=.2,e.occludedShadowOpacity=.1,e.opacityElevation=1,e.dayNightTerminator=1,e}return(0,s.Z)(n)}(Yy.nj),eb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),i=t.call(this,e,new Jy,(function(){return i.destroy()}))}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.SRC_ALPHA,_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),colorWrite:mt.BK,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return _t.MX.TRIANGLE_STRIP}}]),n}(ft.A);eb.shader=new dt.J(Ky.S,(function(){return n.e(39245).then(n.bind(n,39245))}));var tb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).produces="composite-color",i.consumes={required:["composite-color","highlights"]},i._passParameters=new $y,i._maxOpacity=1,i._shadowDifference=.2,i._technique=e.techniques.acquire(eb),i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([(0,k.watch)((function(){return e.view.highlightOptions.shadowOpacity}),(function(t){e._passParameters.shadowOpacity=null!==t&&void 0!==t?t:.4,e._updateOccludedShadowOpacity(),e._updateMaxOpacity()}),k.syncAndInitial),(0,k.watch)((function(){return e.view.highlightOptions.shadowDifference}),(function(t){e._shadowDifference=null!==t&&void 0!==t?t:.2,e._updateOccludedShadowOpacity(),e._updateMaxOpacity()}),k.syncAndInitial),(0,k.watch)((function(){return e.view.highlightOptions.shadowColor}),(function(t){e._passParameters.shadowColor=(0,it.O)(null!==t&&void 0!==t?t:Gh),e._updateMaxOpacity()}),k.syncAndInitial)])}},{key:"destroy",value:function(){this._technique.release()}},{key:"_updateOccludedShadowOpacity",value:function(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}},{key:"_updateMaxOpacity",value:function(){var e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}},{key:"render",value:function(e){var t,n=e.find((function(e){return"composite-color"===e.name})),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return n;if(!this._technique.compiled)return this.requestRender(Kf.Xx.UPDATE),n;this._passParameters.highlight=null===(t=e.find((function(e){return"highlights"===e.name})))||void 0===t?void 0:t.getTexture(),this._passParameters.origin=i.camera.center;var r=this.renderingContext;return r.bindFramebuffer(n.fbo),r.bindTechnique(this._technique,i,this._passParameters),r.screen.draw(),n}},{key:"_ensureIfVisible",value:function(e,t){this._passParameters.opacityElevation=1-(0,Se.CW)(4e4,5e4,e.relativeElevation);var n=this.viewingMode===he.JY.Global?(0,et.n)(nb,e.center):(0,et.s)(nb,0,0,1),i=(0,et.m)(n,t);return this._passParameters.dayNightTerminator=(0,Se.CW)(0,1,(0,Se.uZ)(30*i,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=.001953125}}]),n}(Vy.Z);(0,f._)([(0,E.Cb)()],tb.prototype,"produces",void 0),(0,f._)([(0,E.Cb)()],tb.prototype,"consumes",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],tb.prototype,"viewingMode",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],tb.prototype,"techniques",void 0),tb=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],tb);var nb=(0,U.Ue)(),ib=n(38330),rb=n(19388),ab=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.if)(_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:mt.BK})}}]),n}(ft.A);ab.shader=new dt.J(rb.a,(function(){return n.e(54545).then(n.bind(n,54545))}));var ob=n(4583),sb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).produces="magnifier-color",i.consumes={required:["magnifier-color"]},i._imageSources=null,i._imageLoadTask=null,i._passParameters=new rb.M,i._vao=null,i._technique=null,i._magnifier=null,i._tmpScreenPoint=(0,P.s1)(),i._tmpRenderPoint=(0,P.gX)(),i}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([(0,k.watch)((function(){return e.view.magnifier}),(function(t){return e._update(t)}),k.syncAndInitial)])}},{key:"_update",value:function(e){var t=this;if(e!==this._magnifier){this.removeAllHandles(),this._magnifier=e;var n=function(){var e=t._validMagnifier;e?(t._loadResources(e),t.produces="magnifier-color"):t.produces="disabled",t.requestRender()};this._magnifier&&this.addHandles((0,k.watch)((function(){var e;return null===(e=t._magnifier)||void 0===e?void 0:e.version}),n)),n()}}},{key:"_validMagnifier",get:function(){var e,t,n;return null!==(e=this._magnifier)&&void 0!==e&&e.visible&&null!==(t=this._magnifier)&&void 0!==t&&t.position&&(null===(n=this._magnifier)||void 0===n?void 0:n.size)>0?this._magnifier:null}},{key:"_factor",get:function(){var e;return(null===(e=this._magnifier)||void 0===e?void 0:e.factor)||1}},{key:"destroy",value:function(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=(0,x.M2)(this._vao)}},{key:"_disposeTextures",value:function(){this._passParameters.mask=(0,x.M2)(this._passParameters.mask),this._passParameters.overlay=(0,x.M2)(this._passParameters.overlay),this._passParameters.input=(0,x.M2)(this._passParameters.input)}},{key:"render",value:function(e){var t,n,i,r=this._validMagnifier,a=e.find((function(e){return"magnifier-color"===e.name}));if(null==r)return a;if(null==this._imageSources)return this.requestRender(Kf.Xx.UPDATE),a;var o=this.renderingContext,s=this.camera.pixelRatio,l=Math.ceil(s*r.size);if(null!==(t=this._vao)&&void 0!==t||(this._vao=(0,St.o)(o,Tt.QI,vt.i,0,1)),null!==(n=this._technique)&&void 0!==n||(this._technique=this.techniques.acquire(ab)),this._ensureTextureResources(o,l),null===(i=this._technique)||void 0===i||!i.compiled||!this._passParameters.input)return this.requestRender(Kf.Xx.UPDATE),a;var u=Math.ceil(1/this._factor*l),c=this._passParameters.input;c.resize(u,u),(0,P.md)(r.position,this._tmpScreenPoint);var h=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),d=this.camera.fullWidth,f=this.camera.fullHeight,v=.5*u,p=.5*u;h[0]=(0,Se.uZ)(h[0],v,d-v-1),h[1]=(0,Se.uZ)(h[1],p,f-p-1);var _=Math.floor(h[0]-v),m=Math.floor(h[1]-p);return o.bindFramebuffer(a.fbo),this._technique.program.bindTexture("textureInput",c),o.gl.copyTexImage2D(c.descriptor.target,0,c.descriptor.pixelFormat,_,m,u,u,0),this._passParameters.magnifier=r,o.bindTechnique(this._technique,this.bindParameters,this._passParameters),o.bindVAO(this._vao),o.drawArrays(_t.MX.TRIANGLE_STRIP,0,4),a}},{key:"_loadResources",value:function(e){var t,n,i,o=this,s=e.maskUrl,l=e.overlayUrl;(null===(t=this._imageLoadTask)||void 0===t?void 0:t.maskUrl)===s&&(null===(n=this._imageLoadTask)||void 0===n?void 0:n.overlayUrl)===l||(null!==(i=this._imageLoadTask)&&void 0!==i&&i.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:s,overlayUrl:l,task:(0,ye.vr)(function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n,i,a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null==s||null==l?(0,ob.e)(t):null,i=null!=s?(0,ib.t)(s,{signal:t}):n.then((function(e){return e.mask})),a=null!=l?(0,ib.t)(l,{signal:t}):n.then((function(e){return e.overlay})),e.next=3,i;case 3:return e.t0=e.sent,e.next=6,a;case 6:e.t1=e.sent,o._imageSources={mask:e.t0,overlay:e.t1};case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())})}},{key:"_ensureTextureResources",value:function(e,t){if(!(null==this._imageSources||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)){this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t;var n=new Yt.X;n.internalFormat=_t.VI.RGBA,n.wrapMode=_t.e8.CLAMP_TO_EDGE,n.flipped=!0,n.preMultiplyAlpha=!(0,zd.zd)(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new xn.x(e,n,this._imageSources.overlay),n.pixelFormat=n.internalFormat=_t.VI.ALPHA,n.preMultiplyAlpha=!1,this._passParameters.mask=new xn.x(e,n,this._imageSources.mask),n.pixelFormat=n.internalFormat=_t.VI.RGBA,n.flipped=!1,this._passParameters.input=new xn.x(e,n)}}}]),n}(Vy.Z);(0,f._)([(0,E.Cb)()],sb.prototype,"produces",void 0),(0,f._)([(0,E.Cb)()],sb.prototype,"consumes",void 0),(0,f._)([(0,E.Cb)()],sb.prototype,"_imageSources",void 0),(0,f._)([(0,E.Cb)()],sb.prototype,"_imageLoadTask",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],sb.prototype,"techniques",void 0),sb=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.effects.magnifier.MagnifierRenderNode")],sb);var lb=n(98757),ub=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({colorWrite:mt.BK})}}]),n}(ft.A);ub.shader=new dt.J(lb.B,(function(){return n.e(61738).then(n.bind(n,61738))}));var cb=n(40051),hb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({colorWrite:mt.BK})}}]),n}(ft.A);hb.shader=new dt.J(cb.B,(function(){return n.e(79063).then(n.bind(n,79063))}));var db=n(82396),fb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({colorWrite:mt.BK})}}]),n}(ft.A);fb.shader=new dt.J(db.E,(function(){return n.e(53953).then(n.bind(n,53953))}));var vb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n)}(ht.K),pb=function(e){(0,h.Z)(i,e);var t=(0,d.Z)(i);function i(e){var n;return(0,o.Z)(this,i),(n=t.call(this,e)).produces="disabled",n.consumes={required:["aa-color","composite-color"]},n._areaTexture=null,n._searchTexture=null,n._smaaParameters=new vb,n._edgeTechnique=e.techniques.acquire(fb),n._blendTechnique=e.techniques.acquire(ub),n._blurTechnique=e.techniques.acquire(hb),n}return(0,s.Z)(i,[{key:"initialize",value:function(){var e=this;this.addHandles([(0,k.watch)((function(){return e.isEnabled()}),(function(t){return t?e.enable():e.disable()}),k.syncAndInitial)])}},{key:"enable",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){var t,i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.produces="aa-color",!(this._abortController||this._areaTexture&&this._searchTexture)){e.next=2;break}return e.abrupt("return");case 2:return this._abortController=new AbortController,t=this._abortController.signal,e.prev=4,e.next=7,n.e(75224).then(n.bind(n,75224));case 7:return i=e.sent,e.next=10,this._loadTextures(i,t);case 10:this.requestRender(Kf.Xx.UPDATE),e.next=15;break;case 13:e.prev=13,e.t0=e.catch(4);case 15:this._abortController=null;case 16:case"end":return e.stop()}}),e,this,[[4,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_loadTextures",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n){var i,a,o,s,l;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,S.k_)(n),e.next=3,Promise.allSettled([(0,ib.t)(t.areaTexture,{signal:n}),(0,ib.t)(t.searchTexure,{signal:n})]);case 3:if(i=e.sent,a=(0,Zu.Z)(i,2),o=a[0],s=a[1],(0,S.k_)(n),"fulfilled"===o.status&&"fulfilled"===s.status){e.next=9;break}return e.abrupt("return");case 9:l=this.renderingContext,this._areaTexture=_b(l,_t.cw.LINEAR,_t.VI.RGB,o.value),this._searchTexture=_b(l,_t.cw.NEAREST,_t.VI.LUMINANCE,s.value);case 11:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"disable",value:function(){this.produces="disabled"}},{key:"destroy",value:function(){this._searchTexture=(0,x.M2)(this._searchTexture),this._areaTexture=(0,x.M2)(this._areaTexture),this._blurTechnique.release(),this._blendTechnique.release(),this._edgeTechnique.release()}},{key:"render",value:function(e){var t,n,i=e.find((function(e){return"aa-color"===e.name}));if(!(this._edgeTechnique.compiled&&this._blendTechnique.compiled&&this._blurTechnique.compiled&&this._areaTexture&&this._searchTexture))return this.requestRender(Kf.Xx.UPDATE),i;var r=e.find((function(e){return"composite-color"===e.name})),a=r.fbo.width,o=r.fbo.height,s=this.renderingContext;s.setViewport(0,0,a,o);var l=this.fboCache.acquire(a,o,"smaa edges",xt.q.RG);s.unbindTexture(null===(t=l.fbo)||void 0===t?void 0:t.colorTexture),s.bindFramebuffer(l.fbo),s.setClearColor(0,0,0,1),s.clear(_t.lk.COLOR_BUFFER_BIT),this._smaaParameters.color=r.getTexture(),s.bindTechnique(this._edgeTechnique,null,this._smaaParameters),s.screen.draw();var u=this.fboCache.acquire(a,o,"smaa blend");return s.unbindTexture(null===(n=u.fbo)||void 0===n?void 0:n.colorTexture),s.bindFramebuffer(u.fbo),s.setClearColor(0,0,1,1),s.clear(_t.lk.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=l.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,s.bindTechnique(this._blendTechnique,null,this._smaaParameters),s.screen.draw(),l.release(),s.bindFramebuffer(i.fbo),s.setClearColor(0,1,0,1),s.clear(_t.lk.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=u.getTexture(),s.bindTechnique(this._blurTechnique,null,this._smaaParameters),s.screen.draw(),u.release(),i}}]),i}(Vy.Z);function _b(e,t,n,i){var r=new Yt.X;return r.pixelFormat=n,r.wrapMode=_t.e8.CLAMP_TO_EDGE,r.width=i.width,r.height=i.height,r.samplingMode=t,new xn.x(e,r,i)}(0,f._)([(0,E.Cb)()],pb.prototype,"produces",void 0),(0,f._)([(0,E.Cb)()],pb.prototype,"consumes",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],pb.prototype,"isEnabled",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],pb.prototype,"techniques",void 0),(0,f._)([(0,E.Cb)()],pb.prototype,"_abortController",void 0),pb=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.effects.smaa.SMAA")],pb);var mb,gb=n(14472),yb=n(4170);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(mb||(mb={}));var bb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).alphaMode=mb.None,e.hasOpacityFactor=!1,e.isDepthBlit=!1,e}return(0,s.Z)(n)}(bt.m);(0,f._)([(0,bt.o)({count:mb.COUNT})],bb.prototype,"alphaMode",void 0),(0,f._)([(0,bt.o)()],bb.prototype,"hasOpacityFactor",void 0),(0,f._)([(0,bt.o)()],bb.prototype,"isDepthBlit",void 0);var wb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){switch(this.configuration.alphaMode){case mb.None:return(0,mt.sm)({colorWrite:mt.BK});case mb.Alpha:return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.SRC_ALPHA,_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),colorWrite:mt.BK});case mb.PremultipliedAlpha:case mb.COUNT:return(0,mt.sm)({blending:(0,mt.if)(_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA),colorWrite:mt.BK})}}}]),n}(ft.A);wb.shader=new dt.J(yb.a,(function(){return n.e(44016).then(n.bind(n,44016))}));var Cb=n(67273),xb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}]),n}(ft.A);xb.shader=new dt.J(Cb.a,(function(){return n.e(58323).then(n.bind(n,58323))}));var Tb=n(90829),Sb=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.SRC_ALPHA,_t.zi.ONE,_t.zi.ONE_MINUS_SRC_ALPHA,_t.zi.ONE_MINUS_SRC_ALPHA),colorWrite:mt.BK})}}]),n}(ft.A);Sb.shader=new dt.J(Tb.a,(function(){return n.e(19409).then(n.bind(n,19409))}));var kb=function(){function e(t,n){(0,o.Z)(this,e),this._rctx=t,this._techniques=n,this._configuration=new bb,this._passParameters=new yb.C,this._oitParameters=new Tb.O,this._hudParameters=new Cb.H}return(0,s.Z)(e,[{key:"compositeOIT",value:function(e,t,n,i){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=n,this._oitParameters.frontFaceTexture=i;var r=this._techniques.acquire(Sb);this._rctx.bindTechnique(r,e,this._oitParameters),this._rctx.screen.draw(),r.release()}},{key:"compositeHUD",value:function(e,t){this._hudParameters.texture=t;var n=this._techniques.acquire(xb);this._rctx.bindTechnique(n,e,this._hudParameters),this._rctx.screen.draw(),n.release()}},{key:"composite",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:mb.None,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this._configuration.alphaMode=n,this._configuration.hasOpacityFactor=1!==i,this._passParameters.texture=t,this._passParameters.opacity=i;var r=this._techniques.acquire(wb,this._configuration);this._rctx.bindTechnique(r,e,this._passParameters),this._rctx.screen.draw(),r.release()}},{key:"blitDepthToLinearDepth",value:function(e,t){this._configuration.isDepthBlit=!0,this.composite(e,t),this._configuration.isDepthBlit=!1}}]),e}(),Mb=n(46228),Pb=n(78329);function Rb(e,t,n){return(0,Mb.v)(t,e)*(n[1]-n[0])+n[0]}function Eb(e,t,n){var i=0;if(!t.some((function(e){return!!e.materialReference&&(i+=e.numGeometries)>=1e4})))return Wb.compute(e,t);var r=ty();return n.forAll((function(t){return iy(r,function(e,t){if(!t.visible)return;var n=ty(),i=t.getSpatialQueryAccelerator();return i?function(e,t,n){var i=t.eye,r=t.viewForward,a=t.frustum,o=function(e){return e.visible},s=n.objectCount;if(s<500)ny(Gb,t.near,Math.min(e.near,t.far)),n.forEachInDepthRange(i,r,Pb.Z.DepthOrder.FRONT_TO_BACK,Gb,(function(n,i){Ob(e,t,n),Gb.far=e.near,i.setRange(Gb)}),a,o),ny(Gb,Math.max(e.far,t.near),t.far),n.forEachInDepthRange(i,r,Pb.Z.DepthOrder.BACK_TO_FRONT,Gb,(function(n,i){Ob(e,t,n),Gb.near=e.far,i.setRange(Gb)}),a,o);else{var l=Math.max(Math.min(s,500),Math.ceil(.1*s)),u=n.findClosest(r,Pb.Z.DepthOrder.FRONT_TO_BACK,a,o,l),c=n.findClosest(r,Pb.Z.DepthOrder.BACK_TO_FRONT,a,o,l);u&&c&&(Db(e,t,u.boundingVolumeWorldSpace.bounds),Db(e,t,c.boundingVolumeWorldSpace.bounds))}}(n,e,i):function(e,t,n){jb.clear(),n.forAll((function(e){e.visible&&0!==e.geometries.length&&jb.add(e)})),jb.empty||(jb.sort(t),ny(Gb,t.near,Math.min(e.near,t.far)),jb.forEachInDepthRange(Gb,Pb.Z.DepthOrder.FRONT_TO_BACK,(function(n,i){i<e.near&&Ob(e,t,n)})),ny(Gb,Math.max(e.far,t.near),t.far),jb.forEachInDepthRange(Gb,Pb.Z.DepthOrder.BACK_TO_FRONT,(function(t,n,i){e.far=Math.max(e.far,i)})))}(n,e,t.objects),n}(e,t))})),r}function Ob(e,t,n){if(n.visible&&(0,Au.hr)(t.frustum,n.boundingVolumeWorldSpace.bounds)){var i=n.transformation,r=Bb;n.geometries.forEach((function(n){(0,Nt.Jp)(r,i,n.transformation);var a=(0,Me.u1)(r);Ab(e,t,n.boundingInfo,r,a)}))}}function Ab(e,t,n,r,a){if(null!=n){(0,et.h)((0,Ai.g)(qb),n.center,r);var o=t.eye,s=t.viewForward,l=s[0]*(qb[0]-o[0])+s[1]*(qb[1]-o[1])+s[2]*(qb[2]-o[2]);if(qb[3]=n.radius*a,!(l-qb[3]>e.near&&l+qb[3]<e.far)&&(0,Au.hr)(t.frustum,qb))if(n.radius>100&&n.getChildren()){var u,c=(0,i.Z)(n.getChildren());try{for(c.s();!(u=c.n()).done;){Ab(e,t,u.value,r,a)}}catch(h){c.e(h)}finally{c.f()}}else Xb.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,n.bbMin,n.bbMax)}}function Db(e,t,n){var i=t.eye,r=t.viewForward,a=(n[0]-i[0])*r[0]+(n[1]-i[1])*r[1]+(n[2]-i[2])*r[2];e.near=Math.min(e.near,a-n[3]),e.far=Math.max(e.far,a+n[3])}var Zb=function(){function e(){(0,o.Z)(this,e),this._items=new Fl.Z({allocator:function(e){return e||{object:null,distance:0,near:0,far:0}},deallocator:function(e){return e.object=null,e.distance=0,e.near=0,e.far=0,e}})}return(0,s.Z)(e,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}},{key:"clear",value:function(){this._items.clear()}},{key:"add",value:function(e){this._items.pushNew().object=e}},{key:"sort",value:function(e){var t=e.eye,n=e.viewForward;this._items.forAll((function(e){var i=e.object.boundingVolumeWorldSpace.bounds,r=(i[0]-t[0])*n[0]+(i[1]-t[1])*n[1]+(i[2]-t[2])*n[2];e.distance=r,e.near=r-i[3],e.far=r+i[3]})),this._items.sort((function(e,t){return e.distance-t.distance}))}},{key:"forEachInDepthRange",value:function(e,t,n){if(t===Pb.Z.DepthOrder.FRONT_TO_BACK)for(var i=0;i<this._items.length;++i){var r=this._items.data[i];r.far<e.near||r.near>e.far||n(r.object,r.near,r.far)}else for(var a=this._items.length-1;a>=0;--a){var o=this._items.data[a];o.far<e.near||o.near>e.far||n(o.object,o.near,o.far)}}}]),e}(),Ib=function(){function e(){(0,o.Z)(this,e),this._view=(0,Ut.Ue)(),this._viewProj=(0,Ut.Ue)(),this._frustum=(0,Au.Ue)(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}return(0,s.Z)(e,[{key:"compute",value:function(e,t){var n=this;this._reset(),(0,Nt.JG)(this._view,e.viewMatrix),(0,Nt.Jp)(this._viewProj,e.projectionMatrix,this._view),(0,Au.JG)(this._frustum,e.frustum);var i=this._view,r=i[2],a=i[6],o=i[10],s=i[14];t.forAll((function(e){e.materialReference&&e.forEachGeometry&&e.forEachGeometry((function(e){if(e.visible&&e.castShadow){var t=e.boundingSphere,i=r*t[0]+a*t[1]+o*t[2]+s,l=i-t[3],u=i+t[3];n._geometries.push(e),n._near.push(-u),n._far.push(-l)}}))}));var l=new ey;if(0===this._geometries.length)return l;for(var u=0;u<this._geometries.length;++u)this._near[u]>l.far&&(l.far=this._near[u]),this._near[u]>2&&this._far[u]<l.near&&(l.near=this._far[u]);var c=this._looseRange;c.near=Math.max(.5*l.near,2),c.far=2*l.far;for(var h=0,d=0,f=0;f<this._geometries.length;++f)this._near[f]<l.near&&(this._near[f]>=c.near?l.near=this._near[f]:this._nearCandidates[h++]=f),this._far[f]>l.far&&(this._far[f]<=c.far?l.far=this._far[f]:this._farCandidates[d++]=f);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return l;this._nearCandidates.sort((function(e,t){return n._near[e]<n._near[t]?-1:n._near[e]>n._near[t]?1:0})),this._farCandidates.sort((function(e,t){return n._far[e]<n._far[t]?1:n._far[e]>n._far[t]?-1:0}));for(var v=0;v<this._nearCandidates.length;++v){var p=this._nearCandidates[v];if(this._near[p]<l.near){var _=this._geometries[p],m=_.boundingInfo;this._includeNearBoundingInfoRec(m,_.shaderTransformation,l)}}for(var g=0;g<this._farCandidates.length;++g){var y=this._farCandidates[g];if(this._far[y]>l.far){var b=this._geometries[y],w=b.boundingInfo;this._includeFarBoundingInfoRec(w,b.shaderTransformation,l)}}return this._reset(),l}},{key:"_reset",value:function(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}},{key:"_includeNearBoundingInfoRec",value:function(e,t,n){if(null!=e){var r=e.center;(0,et.h)((0,Ai.g)(qb),r,t);var a=(0,Me.u1)(t),o=qb[0],s=qb[1],l=qb[2],u=e.radius*a,c=this._frustum;if(!(c[0][0]*o+c[0][1]*s+c[0][2]*l+c[0][3]>u||c[1][0]*o+c[1][1]*s+c[1][2]*l+c[1][3]>u||c[2][0]*o+c[2][1]*s+c[2][2]*l+c[2][3]>u||c[3][0]*o+c[3][1]*s+c[3][2]*l+c[3][3]>u)){var h=this._view[2]*o+this._view[6]*s+this._view[10]*l+this._view[14],d=h+u;if(!(-(h-u)<2||-d>=n.near))if(-d>this._looseRange.near)n.near=-d;else{if(u>100){var f=e.getChildren();if(void 0!==f){var v,p=(0,i.Z)(f);try{for(p.s();!(v=p.n()).done;){var _=v.value;this._includeNearBoundingInfoRec(_,t,n)}}catch(m){p.e(m)}finally{p.f()}return}}Xb.unionDepthRangeWithAABB(n,this._viewProj,t,e.bbMin,e.bbMax)}}}}},{key:"_includeFarBoundingInfoRec",value:function(e,t,n){if(null!=e){var r=e.radius,a=e.center;(0,et.h)((0,Ai.g)(qb),a,t);var o=(0,Me.u1)(t),s=qb[0],l=qb[1],u=qb[2];r*=o;var c=this._frustum;if(!(c[0][0]*s+c[0][1]*l+c[0][2]*u+c[0][3]>r||c[1][0]*s+c[1][1]*l+c[1][2]*u+c[1][3]>r||c[2][0]*s+c[2][1]*l+c[2][2]*u+c[2][3]>r||c[3][0]*s+c[3][1]*l+c[3][2]*u+c[3][3]>r)){var h=this._view[2]*s+this._view[6]*l+this._view[10]*u+this._view[14]-r;if(!(-h<=n.far))if(-h<this._looseRange.far)n.far=-h;else{if(r>100){var d=e.getChildren();if(void 0!==d){var f,v=(0,i.Z)(d);try{for(v.s();!(f=v.n()).done;){var p=f.value;this._includeFarBoundingInfoRec(p,t,n)}}catch(_){v.e(_)}finally{v.f()}return}}Xb.unionDepthRangeWithAABB(n,this._viewProj,t,e.bbMin,e.bbMax)}}}}}]),e}(),Lb=function(){function e(){(0,o.Z)(this,e),this._modelViewProj=(0,Ut.Ue)(),this._clipPosition=[(0,st.Ue)(),(0,st.Ue)(),(0,st.Ue)(),(0,st.Ue)(),(0,st.Ue)(),(0,st.Ue)(),(0,st.Ue)(),(0,st.Ue)()]}return(0,s.Z)(e,[{key:"unionDepthRangeWithAABB",value:function(e,t,n,i,r){var a=this._modelViewProj;(0,Nt.Jp)(a,t,n);for(var o=!1,s=0;s<8;++s){var l=this._clipPosition[s],u=0===s||3===s||4===s||7===s?i[0]:r[0],c=0===s||1===s||4===s||5===s?i[1]:r[1],h=s<4?i[2]:r[2];l[0]=a[0]*u+a[4]*c+a[8]*h+a[12],l[1]=a[1]*u+a[5]*c+a[9]*h+a[13],l[2]=a[2]*u+a[6]*c+a[10]*h+a[14],l[3]=a[3]*u+a[7]*c+a[11]*h+a[15]}for(var d=0;d<12;++d){for(var f=Nb(this._clipPosition[zb[d][0]],this._clipPosition[zb[d][1]],this._clipPosition[zb[d][2]]),v=!0,p=0;p<f.length;++p)if(f[p][3]>=2){v=!1;break}if(!v){o=!0;for(var _=0;_<f.length;++_){var m=f[_][3];Number.isFinite(m)&&(e.near=Math.min(m,e.near),e.far=Math.max(m,e.far))}}}return o}}]),e}();function Nb(e,t,n){for(var i=[e,t,n],r=0;r<4;++r){var a=i;i=[];for(var o=0;o<a.length;++o){var s=a[o],l=a[(o+1)%a.length];Ub(l,r)?(Ub(s,r)||i.push(Hb(s,l,r)),i.push(l)):Ub(s,r)&&i.push(Hb(s,l,r))}}return i}function Ub(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,En.hu)(!1)}function Hb(e,t,n){var i=0;return 0===n?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===n?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===n?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===n&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,ot.l)((0,st.Ue)(),e,t,i)}var Fb,Vb,zb=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],qb=(0,Ai.c)(),Bb=(0,Ut.Ue)(),Gb=ty(),jb=new Zb,Wb=new Ib,Xb=new Lb,Qb=n(53252),Yb=n(59447),Jb=function(){function e(){(0,o.Z)(this,e),this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new y_.mc(new ArrayBuffer(4)),this._layerToOidToColor=new Yb.r,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Yb.r,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}return(0,s.Z)(e,[{key:"setUidToObjectAndLayerId",value:function(e,t,n,i,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;e&&t&&n&&i&&(this._layerUidToId.set(i,n),this._layerUidToPopupEnabled.set(i,r),r&&this._layerUidToGraphicsUidToObjectId.set(i,t,{objectId:e,attributeNodeId:a,attributeIndex:o,subLayerId:s}))}},{key:"getObjectAndLayerIdColor",value:function(e){var t=this.getObjectAndLayerIdColorArray(e);return(0,st.al)(t.get(0,1),t.get(0,2),t.get(0,3),255)}},{key:"getObjectAndLayerIdColorArray",value:function(e){var t;if(!e.layerUid||!e.graphicUid)return this.colorZero;var n=this._layerUidToPopupEnabled.get(e.layerUid);if(void 0===n)return this.colorZero;if(!1===n)return this.colorZero;var i=null===(t=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid))||void 0===t?void 0:t.objectId;if(!i)return this.colorZero;var r=this._layerToOidToColor.get(e.layerUid,i);if(!r){for(;!r;){var a=Math.floor(16777214*Math.random())+1;this._colorToUID.has(a)||(r=a)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,i,r),this._colorToUID.set(r,e)}var o=new ArrayBuffer(4);return new DataView(o).setUint32(0,r,!1),new y_.mc(o)}},{key:"getColorToObjectAndLayerIdMapping",value:function(){var e,t=new Map,n=(0,i.Z)(this._colorToUID.entries());try{for(n.s();!(e=n.n()).done;){var r=(0,Zu.Z)(e.value,2),a=r[0],o=r[1],s=this._layerUidToGraphicsUidToObjectId.get(o.layerUid,o.graphicUid),l=this._layerUidToId.get(o.layerUid);s&&l&&t.set(a,s.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:s.objectId,lid:l,attrId:s.attributeNodeId,attrIdx:s.attributeIndex,subLayerId:s.subLayerId}:{type:"object-and-layer-id",oid:s.objectId,lid:l})}}catch(u){n.e(u)}finally{n.f()}return t}}]),e}();n(75505),n(86741),n(51370),n(37998);!function(e){e.OPAQUE="opaque-color",e.TRANSPARENT="transparent-color",e.COMPOSITE="composite-color",e.FINAL="final-color"}(Fb||(Fb={})),function(e){e.ANTIALIASING="aa-color",e.HIGHLIGHTS="highlight-color",e.MAGNIFIER="magnifier-color"}(Vb||(Vb={}));var Kb,$b=function(){function e(t,n){(0,o.Z)(this,e),this.key=t,this.free=n,this.incarnation=0,this._refCount=1}return(0,s.Z)(e,[{key:"retain",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._refCount+=e}},{key:"release",value:function(){return 0===this._refCount?(console.log("Releasing already released FBO attachment in ".concat((new Error).stack)),!0):(--this._refCount,0===this._refCount&&(this.free(),!0))}}]),e}();!function(e){e[e.FBO=0]="FBO",e[e.DEPTH=1]="DEPTH",e[e.COLOR=2]="COLOR"}(Kb||(Kb={}));var ew=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,e,r)).attachment=i,a.name="",a}return(0,s.Z)(n,[{key:"dispose",value:function(){this.attachment.dispose()}},{key:"usedMemory",get:function(){return this.attachment.usedMemory}}]),n}($b),tw=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,e,i,r)).attachment=i,a.type=Kb.COLOR,a}return(0,s.Z)(n)}(ew),nw=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).type=Kb.DEPTH,e}return(0,s.Z)(n)}(ew),iw=n(46888);var rw,aw,ow=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a,s,l){var u;return(0,o.Z)(this,n),(u=t.call(this,e,l)).type=Kb.FBO,u._colors=new Map,u._name="composite-color",u.acquireDepth=null,u.acquireColor=null,u._name=i,u.fbo=r,u.acquireDepth=a,u.acquireColor=s,u}return(0,s.Z)(n,[{key:"dispose",value:function(){var e;null===(e=this.fbo)||void 0===e||e.dispose()}},{key:"usedMemory",get:function(){var e;return(null===(e=this.fbo)||void 0===e?void 0:e.usedMemory)||0}},{key:"name",get:function(){return this._name}},{key:"setName",value:function(e){this._name=e}},{key:"getTexture",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_t.VY.COLOR_ATTACHMENT0;return n===_t.Lu?null===(e=this.fbo)||void 0===e?void 0:e.depthStencilTexture:null===(t=this.fbo)||void 0===t?void 0:t.getColorTexture(n)}},{key:"getAttachment",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_t.VY.COLOR_ATTACHMENT0;return e===_t.Lu?this._depth:this._colors.get(e)}},{key:"attachDepth",value:function(e){var t;return null!==e&&void 0!==e&&e.retain(),this.detachDepth(),e&&null!==(t=this.fbo)&&void 0!==t&&t.attachDepthStencil(e.attachment),this._depth=e,this}},{key:"detachDepth",value:function(){var e,t;null!==(e=this.fbo)&&void 0!==e&&e.detachDepthStencilTexture(),null!==(t=this.fbo)&&void 0!==t&&t.detachDepthStencilBuffer(),this._depth=(0,x.RY)(this._depth)}},{key:"obtainDepthTexture",value:function(){var e,t=this._depth;return function(e){return(null===e||void 0===e?void 0:e.attachment.type)===iw.B.Texture}(t)?(null!==(e=this.fbo)&&void 0!==e&&e.detachDepthStencilTexture(),this._depth=null,t):null}},{key:"attachColor",value:function(e,t){var n;return e.retain(),this.detachColor(t),null!==(n=this.fbo)&&void 0!==n&&n.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}},{key:"detachColor",value:function(e){var t;null===(t=this.fbo)||void 0===t||t.detachColorTexture(e);var n=this._colors.get(e);this._colors.delete(e),null===n||void 0===n||n.release()}},{key:"detachAll",value:function(){var e=this;this._colors.forEach((function(t,n){return e.detachColor(n)})),this.detachDepth()}}]),n}($b),sw=function(){function e(t,n){(0,o.Z)(this,e),this._last=new Fl.Z,this._incarnation=0,this._cache=new Df.N(t,n)}return(0,s.Z)(e,[{key:"destroy",value:function(){var e;null!==(e=this._last)&&void 0!==e&&e.forAll((function(e){return e.dispose()})),this._last=null,this._cache.destroy()}},{key:"interactive",set:function(e){var t;e&&!this._last?this._last=new Fl.Z:e||(null!==(t=this._last)&&void 0!==t&&t.forAll((function(e){return e.dispose()})),this._last=null)}},{key:"clean",value:function(){var e,t=this;null===(e=this._last)||void 0===e||e.filterInPlace((function(e){return!(e.incarnation<t._incarnation)||(t._cache.put(e.key,e),!1)}))}},{key:"frame",value:function(){++this._incarnation}},{key:"pop",value:function(e){if(this._last){var t=this._last.find((function(t){return t.key===e}));if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}},{key:"put",value:function(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}},{key:"usedMemory",get:function(){var e,t;return null!==(e=null===(t=this._last)||void 0===t?void 0:t.reduce((function(e,t){return e+t.usedMemory}),0))&&void 0!==e?e:0}}]),e}(),lw=n(15880),uw=function(){function e(t){(0,o.Z)(this,e),this.rctx=t,this._acquired=new Set,this._cache=new sw(t.newCache,"FBOCache"),this._depthCache=new sw(t.newCache,"DepthAttachmentCache"),this._colorCache=new sw(t.newCache,"ColorAttachmentCache")}return(0,s.Z)(e,[{key:"destroy",value:function(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}},{key:"clean",value:function(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}},{key:"frameStart",value:function(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}},{key:"frameEnd",value:function(){var e=this.debugCallback;e&&this._acquired.forEach((function(t){return t.type===Kb.FBO&&e(t.name,t.fbo)}))}},{key:"usedMemory",get:function(){return Array.from(this._acquired.values()).reduce((function(e,t){var n,i;return e+("getTexture"in t?null!==(n=null===(i=t.getTexture())||void 0===i?void 0:i.usedMemory)&&void 0!==n?n:0:t.usedMemory)}),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}},{key:"interactive",set:function(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}},{key:"acquire",value:function(e,t,n){var i=this,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:xt.q.RGBA,a=hw(r,e,t),o=this._cache.pop(a);if(o){o.retain(),o.setName(n);var s=this.rctx.getBoundFramebufferObject();this.rctx.bindFramebuffer(o.fbo),this.rctx.setDrawBuffers([_t.VY.COLOR_ATTACHMENT0]),this.rctx.bindFramebuffer(s)}else o=new ow(a,n,new Qt.X(this.rctx,(0,He.Z)((0,He.Z)({},yw[r]),{},{width:e,height:t})),(function(e){var t;null!==(t=e)&&void 0!==t||(e=xt.m.DEPTH_STENCIL_TEXTURE);var n=i._acquireDepth(e,o.fbo.width,o.fbo.height,"".concat(o.name," depth"));return o.attachDepth(n),n.release(),o}),(function(n,r){var a;null!==(a=r)&&void 0!==a||(r=xt.q.RGBA);var s=i._acquireColor(r,e,t,"".concat(o.name," color ").concat(n));return o.attachColor(s,n),s.release(),o}),(function(){i.debugCallback&&i.debugCallback(o.name,o.fbo),i._acquired.delete(o),o.detachAll(),i._cache.put(o)}));return this._trackHandle(o)}},{key:"acquireDepth",value:function(e,t,n,i){return this._acquireDepth(e,t,n,i)}},{key:"_acquireDepth",value:function(e,t,n,i){var r=this,a=hw(e,t,n),o=this._depthCache.pop(a);if(o)return o.retain(),o.name=i,this._trackHandle(o);var s=e===xt.m.DEPTH_STENCIL_TEXTURE?new nw(a,new xn.x(this.rctx,(0,He.Z)((0,He.Z)({},Cw[e]),{},{width:t,height:n})),(function(){r._acquired.delete(s),r._depthCache.put(s)})):new nw(a,new lw.r(this.rctx,(0,He.Z)((0,He.Z)({},Cw[e]),{},{width:t,height:n})),(function(){r._acquired.delete(s),r._depthCache.put(s)}));return s.name=i,this._trackHandle(s)}},{key:"_acquireColor",value:function(e,t,n,i){var r=this,a=hw(e,t,n),o=this._colorCache.pop(a);if(o)return o.retain(),o.name=i,this._trackHandle(o);var s=new tw(a,new xn.x(this.rctx,(0,He.Z)((0,He.Z)({},yw[e]),{},{width:t,height:n})),(function(){r._acquired.delete(s),r._colorCache.put(s)}));return s.name=i,this._trackHandle(s)}},{key:"_trackHandle",value:function(e){return this._acquired.add(e),e}}]),e}(),cw=new ow("default","default",null,(function(){return cw}),(function(){return cw}),(function(){}));function hw(e,t,n){return"".concat(e,"x").concat(t,"x").concat(n)}var dw=new Yt.X;dw.pixelFormat=_t.VI.RED,dw.internalFormat=_t.lP.R8,dw.wrapMode=_t.e8.CLAMP_TO_EDGE;var fw=new Yt.X;fw.pixelFormat=_t.VI.RG,fw.internalFormat=_t.lP.RG8,fw.wrapMode=_t.e8.CLAMP_TO_EDGE;var vw=new Yt.X;vw.internalFormat=_t.lP.RGBA4,vw.dataType=_t.Br.UNSIGNED_SHORT_4_4_4_4,vw.wrapMode=_t.e8.CLAMP_TO_EDGE;var pw=new Yt.X;pw.wrapMode=_t.e8.CLAMP_TO_EDGE;var _w=new Yt.X;_w.wrapMode=_t.e8.CLAMP_TO_EDGE,_w.samplingMode=_t.cw.LINEAR_MIPMAP_LINEAR,_w.hasMipmap=!0,_w.maxAnisotropy=8;var mw=new Yt.X;mw.pixelFormat=_t.VI.RED,mw.dataType=_t.Br.HALF_FLOAT,mw.internalFormat=_t.lP.R16F,mw.samplingMode=_t.cw.NEAREST;var gw=new Yt.X;gw.dataType=_t.Br.HALF_FLOAT,gw.internalFormat=_t.lP.RGBA16F,gw.samplingMode=_t.cw.NEAREST;var yw=(rw={},(0,Gs.Z)(rw,xt.q.RED,dw),(0,Gs.Z)(rw,xt.q.RG,fw),(0,Gs.Z)(rw,xt.q.RGBA4,vw),(0,Gs.Z)(rw,xt.q.RGBA,pw),(0,Gs.Z)(rw,xt.q.RGBA_MIPMAP,_w),(0,Gs.Z)(rw,xt.q.R16F,mw),(0,Gs.Z)(rw,xt.q.RGBA16F,gw),rw),bw=new Yt.X;bw.pixelFormat=_t.VI.DEPTH_STENCIL,bw.dataType=_t.Br.UNSIGNED_INT_24_8,bw.samplingMode=_t.cw.NEAREST,bw.wrapMode=_t.e8.CLAMP_TO_EDGE;var ww,Cw=(aw={},(0,Gs.Z)(aw,xt.m.DEPTH_STENCIL_TEXTURE,bw),(0,Gs.Z)(aw,xt.m.DEPTH16_BUFFER,new K_.Y(_t.Tg.DEPTH_COMPONENT16,4)),aw),xw=n(74779),Tw=n(25920);!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(ww||(ww={}));var Sw=function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ww.FrontToBack;(0,o.Z)(this,e),this._rctx=t,this._techniques=n,this._sorting=i,this._draws=new Fl.Z({initialSize:32,allocator:function(e){return e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}}),this._previouslyBoundDraw=new Map}return(0,s.Z)(e,[{key:"submitDraw",value:function(e,t,n,i){var r,a=this._draws.pushNew();a.geometry=t,a.geometryRanges=n,a.material=e,a.depthSquaredHint=i,a.indexType=null!==(r=t.indexed?t.vao.indexBuffer.indexType:null)&&void 0!==r?r:0}},{key:"prepare",value:function(e,t){var n=this;return this._draws.map((function(i){return i.material.prepareTechnique(n._techniques,e,t,i.geometry.parameters)}))}},{key:"dispatch",value:function(e,t,n){var i=this._rctx;this._previouslyBoundDraw.clear();for(var r=null,a=this._draws.length,o=0;o<a;o++){var s=n[o];s===r&&s.configuration.transparencyPassType===Tw.A.NONE||(i.bindTechnique(s,t,e),r=s);var l=this._draws.data[o],u=l.geometry;i.bindVAO(u.vao),this._previouslyBoundDraw.get(s)!==l.material&&(s.program.bindDraw(l.material,t,e),this._previouslyBoundDraw.set(s,l.material));var c=l.geometryRanges,h=c.length;if(0!==l.indexType)for(var d=kw.get(l.indexType),f=0;f<h;f+=2){var v=c[f],p=c[f+1];i.drawElements(u.primitiveType,p,l.indexType,v*d)}else for(var _=0;_<h;_+=2){var m=c[_],g=c[_+1];i.drawArrays(u.primitiveType,m,g)}}}},{key:"prepareSubmit",value:function(){this._draws.clear()}},{key:"finishSubmit",value:function(){var e=this._sorting===ww.FrontToBack?1:-1;this._draws.sort((function(t,n){var i=e*(t.depthSquaredHint-n.depthSquaredHint);return 0!==i?i:t.geometry.vao.byteSize-n.geometry.vao.byteSize}))}},{key:"count",get:function(){return this._draws.length}}]),e}(),kw=new Map;kw.set(_t.g.UNSIGNED_BYTE,1),kw.set(_t.g.UNSIGNED_SHORT,2),kw.set(_t.g.UNSIGNED_INT,4);var Mw=n(75104),Pw=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.call(this,{}))._passes=null,e.produces=new Map([[fi.r.OPAQUE_MATERIAL,function(t){return e._produces(t)}],[fi.r.TRANSPARENT_MATERIAL,function(t){return!!(e._passes&&e._passes.materialTransparent.count>0)&&e._produces(t)}],[fi.r.INTEGRATED_MESH,function(t){return e._produces(t)}]]),e._materialPassParameters=new xw.SP,e._shadowPassParameters=new xw.kF,e._highlightPassParameters=new xw.T5,e._viewshedPassParameters=new xw.vF,e._systems=new Set,e}return(0,s.Z)(n,[{key:"initializeRenderContext",value:function(e){this._context=e;var t=e.renderContext.rctx,n=e.techniques;this._passes={materialOpaque:new Sw(t,n),materialTransparent:new Sw(t,n,ww.BackToFront),materialIntegratedMesh:new Sw(t,n),shadowMap:new Sw(t,n),highlight:new Sw(t,n),highlightIntegratedMesh:new Sw(t,n),highlightShadowMap:new Sw(t,n),viewshedShadowMap:new Sw(t,n),defaultShadowMap:new Sw(t,n)}}},{key:"rctx",get:function(){return this._context.renderContext.rctx}},{key:"uninitializeRenderContext",value:function(){}},{key:"dispose",value:function(){this._context=null,this._systems.clear()}},{key:"register",value:function(e){this._systems.add(e)}},{key:"_produces",value:function(e){return 0!==this._systems.size&&null!==this._passes&&(e===ep.H_.Highlight?this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0:e!==ep.H_.ShadowHighlight||this._passes.highlight.count>0)}},{key:"prepareRender",value:function(e){var t=this;if(0!==this._systems.size&&null!==this._passes){for(var n=0,i=Object.values(this._passes);n<i.length;n++){i[n].prepareSubmit()}this._systems.forEach((function(n){return n.submit(t._passes,e.bindParameters)}));for(var r=0,a=Object.values(this._passes);r<a.length;r++){a[r].finishSubmit()}this._context.techniques.frameUpdate()}}},{key:"prepareTechniques",value:function(e){if(0===this._systems.size)return null;var t=e.output===ep.H_.Shadow||e.output===ep.H_.ShadowHighlight||e.output===ep.H_.ShadowExcludeHighlight?this._shadowPassParameters:e.output===ep.H_.ViewshedShadow?this._viewshedPassParameters:e.output===ep.H_.Highlight?this._highlightPassParameters:this._materialPassParameters,n=e.bindParameters;return this._updateParameters(n.camera,t,n.slot===fi.r.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e,(function(t,n){return t.prepare(n,e.bindParameters)}))}},{key:"renderNode",value:function(e,t){this._invoke(e,(function(n,i){return n.dispatch(i,e.bindParameters,t)}))}},{key:"_invoke",value:function(e,t){if(null===this._passes)return null;switch(e.bindParameters.slot){case fi.r.OPAQUE_MATERIAL:switch(e.output){case ep.H_.Color:case ep.H_.Depth:case ep.H_.Normal:case ep.H_.ObjectAndLayerIdColor:return t(this._passes.materialOpaque,this._materialPassParameters);case ep.H_.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case ep.H_.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case ep.H_.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case ep.H_.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters);case ep.H_.ViewshedShadow:return t(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case fi.r.TRANSPARENT_MATERIAL:switch(e.output){case ep.H_.Color:case ep.H_.Depth:case ep.H_.Normal:case ep.H_.ObjectAndLayerIdColor:return t(this._passes.materialTransparent,this._materialPassParameters)}break;case fi.r.INTEGRATED_MESH:switch(e.output){case ep.H_.Color:case ep.H_.Depth:case ep.H_.Normal:case ep.H_.ObjectAndLayerIdColor:return t(this._passes.materialIntegratedMesh,this._materialPassParameters);case ep.H_.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}},{key:"notifyDirty",value:function(){this._context.requestRender()}},{key:"queryDepthRange",value:function(e){var t=new ey;return this._systems.forEach((function(n){return iy(t,n.queryShadowCasterDepthRange(e))})),t}},{key:"_updateParameters",value:function(e,t,n){var i=e.viewInverseTransposeMatrix;(0,et.s)(Rw,i[3],i[7],i[11]),Ow.set(Rw),(0,et.c)(t.transformWorldFromViewTH,Ow.high),(0,et.c)(t.transformWorldFromViewTL,Ow.low),(0,et.c)(t.slicePlaneLocalOrigin,Rw),(0,Lt.xO)(t.transformViewFromCameraRelativeRS,e.viewMatrix),(0,Nt.JG)(t.transformProjFromView,e.projectionMatrix),t.identifier===xw.o9.Material&&(this._materialPassParameters.transparent=n,(0,Lt.p4)(Ew,t.transformViewFromCameraRelativeRS),(0,Lt.U_)(t.transformNormalViewFromGlobal,Ew))}}]),n}(di.P6);Pw=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],Pw);var Rw=(0,U.Ue)(),Ew=(0,Ir.Ue)(),Ow=new Mw.I,Aw=n(83866),Dw=n(41287);function Zw(e){return e.name}var Iw=n(37825),Lw=function(){function e(t){(0,o.Z)(this,e),this._context=t,this._nodes=new Fl.Z}return(0,s.Z)(e,[{key:"destroy",value:function(){this._nodes.forEach((function(e){return e.destroy()})),this._nodes.clear()}},{key:"add",value:function(e){this._nodes.push(e),Iw.CM&&console.log("Registered render nodes: ".concat(this._nodes.map((function(e){return e.declaredClass})).join(", ")))}},{key:"remove",value:function(e){this._nodes.remove(e),Iw.CM&&console.log("Registered render nodes: ".concat(this._nodes.map((function(e){return e.declaredClass})).join(", ")))}},{key:"produces",value:function(e){return this._nodes.some((function(t){return t.produces===e}))}},{key:"require",value:function(e){for(var t=this._nodes,n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return i.reduce((function(n,i){return n+t.reduce((function(t,n){var r=n.consumes,a=n.produces;return t+(r.required.includes(e)&&a===i?1:0)}),0)}),0)}},{key:"optional",value:function(e){for(var t=this._nodes,n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return i.reduce((function(n,i){return n+t.reduce((function(t,n){var r,a=n.consumes,o=n.produces;return t+(null!==(r=a.optional)&&void 0!==r&&r.includes(e)&&o===i?1:0)}),0)}),0)}},{key:"updateAnimation",value:function(){return this._nodes.reduce((function(e,t){return t.updateAnimation()||e}),!1)}},{key:"render",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},a=Zw(e)?e.name:e,o=this._nodes.filter((function(e){return e.produces===a}));return 0===o.length||(o.forEach((function(o){var s,l=Zw(e)?[e]:[],u=(0,i.Z)(o.consumes.required);try{for(u.s();!(s=u.n()).done;){var c=s.value;if(c!==a){var h=t.get(c);if(!h)return void(r&&r(l));l.push(h)}}}catch(m){u.e(m)}finally{u.f()}if(o.consumes.optional){var d,f=(0,i.Z)(o.consumes.optional);try{for(f.s();!(d=f.n()).done;){var v=d.value;if(v!==a){var p=t.get(v);p&&l.push(p)}}}catch(m){f.e(m)}finally{f.f()}}try{var _=o.doRender(l,n._context);_&&_!==e&&(Zw(e)?(e.release(),e=_,t.set(a,e)):e=_)}catch(ve){C.Z.getLogger(o).errorOnce(ve)}r&&r(l)})),this._context.rctx.enforceState()),Zw(e)?e:cw}}]),e}(),Nw=function(){function e(t){(0,o.Z)(this,e),this._context=t,this._renderPlugins=new Fl.Z,this._materialRenderers=new Map,this._slots=new Array,this._renderVersion=(0,vd.t)(0);for(var n=0;n<fi.r.MAX_SLOTS;++n)this._slots[n]=[]}return(0,s.Z)(e,[{key:"destroy",value:function(){this._renderPlugins.forEach((function(e){return e.destroy()})),this._renderPlugins.clear(),this._materialRenderers.clear()}},{key:"plugins",get:function(){return this._renderPlugins}},{key:"add",value:function(e,t){var n=this,i=function(){if(null!==t&&void 0!==t&&t.aborted)throw e.uninitializeRenderContext(),(0,S.zE)();n._renderPlugins.push(e),e.materialReference&&n._materialRenderers.set(e.materialReference,e),e.produces.forEach((function(t,i){n._slots[i].push(e)})),n._context.requestRender(),n._renderVersion.value++},r=e.initializeRenderContext(this._context,t);if((0,S.y8)(r))return r.then(i);i()}},{key:"remove",value:function(e){if(null!=e.materialReference&&this._materialRenderers.delete(e.materialReference),null!=this._renderPlugins.removeUnordered(e)){for(var t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((function(t){return t!==e}));e.uninitializeRenderContext(),this._context.requestRender(),this._renderVersion.value++}}},{key:"prepareRender",value:function(){var e=this;this._renderPlugins.forAll((function(t){t.prepareRender&&t.prepareRender(e._context.renderContext)}))}},{key:"updateAnimation",value:function(e){var t=!1;return this._renderPlugins.forAll((function(n){n.updateAnimation&&(t=n.updateAnimation(e)||t)})),t}},{key:"renderFeatureChanged",value:function(){this._renderPlugins.forAll((function(e){e.renderFeatureChanged&&e.renderFeatureChanged()}))}},{key:"prepare",value:function(){for(var e=this,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=function(){var t=o[a];e._context.renderContext.bindParameters.slot=t,e._slots[t].forEach((function(n){var i=n.produces.get(t);(null===i||void 0===i?void 0:i(ep.H_.Color))&&((0,di.QA)(n)&&n.prepareTechnique(e._context.renderContext),(0,di.bV)(n)&&n.prepareTechniques(e._context.renderContext))}))},a=0,o=n;a<o.length;a++)r()}},{key:"_getRenderables",value:function(){var e,t=this,n=this._context.renderContext.bindParameters.slot,i=null!==(e=this._context.renderContext.output)&&void 0!==e?e:ep.H_.Color,r=new Map;return this._slots[n].forEach((function(e){var a=e.produces.get(n);if(null!==a&&void 0!==a&&a(i)&&(!e.isDecoration||t._context.renderContext.bindParameters.decorations!==Kf.Iq.OFF))if((0,di.QA)(e)){var o=e.prepareTechnique(t._context.renderContext);null!=o&&r.set(e,o)}else if((0,di.bV)(e)){var s=e.prepareTechniques(t._context.renderContext);null!=s&&r.set(e,s)}else r.set(e,null)})),r}},{key:"render",value:function(e){for(var t=this,n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var a=0,o=i;a<o.length;a++){var s=o[a];this._context.renderContext.bindParameters.slot=s,this._getRenderables().forEach((function(n,i){return i.renderNode(t._context.renderContext,n,e)}))}}},{key:"queryDepthRange",value:function(e){var t=new ey;return this._renderPlugins.forAll((function(n){var i,r=null===(i=n.queryDepthRange)||void 0===i?void 0:i.call(n,e);iy(t,r)})),t}},{key:"updating",get:function(){return this._renderVersion.value>=0&&this._renderPlugins.some((function(e){return e.running}))}},{key:"produces",value:function(e){for(var t=this,n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var a=function(){var n=s[o];if(t._slots[n].some((function(t){var i=t.produces.get(n);return!!i&&i(e)})))return{v:!0}},o=0,s=i;o<s.length;o++){var l=a();if("object"===typeof l)return l.v}return!1}},{key:"consumes",value:function(e){return this._renderPlugins.some((function(t){return t.consumes().required.includes(e)}))}},{key:"getMaterialRenderer",value:function(e){return this._materialRenderers.get(e)}},{key:"removeEmptyMaterialRenderers",value:function(){var e=this;this._renderPlugins.filterInPlace((function(t){return!t.materialReference||0!==t.numGeometries||(e._materialRenderers.delete(t.materialReference),t.destroy(),!1)}))}},{key:"hasDecorations",get:function(){return this._renderPlugins.some((function(e){return e.isDecoration}))}},{key:"hasOccludees",get:function(){return this._renderPlugins.some((function(e){return e.hasOccludees}))}},{key:"renderOccludedFlags",get:function(){return this._renderPlugins.reduce((function(e,t){return e|t.renderOccludedFlags}),ev.yD.None)}},{key:"usedMemory",get:function(){return this._renderPlugins.reduce((function(e,t){var n;return null!==t.materialReference?e:e+(null!==(n=t.usedMemory)&&void 0!==n?n:0)}),0)}},{key:"test",get:function(){}}]),e}(),Uw=function(){function e(t){(0,o.Z)(this,e),this.techniques=t,this._blitConfiguration=new bb,this._blitParameters=new yb.C}return(0,s.Z)(e,[{key:"render",value:function(e,t,n,i,r){e.bindFramebuffer(n.fbo);var a=this.techniques.acquire(wb,this._blitConfiguration);return e.setClearColor(0,0,0,1),e.clear(_t.lk.COLOR_BUFFER_BIT),null!==a&&void 0!==a&&a.compiled?(this._blitParameters.texture=t.getTexture(),e.bindTechnique(a,i,this._blitParameters),e.screen.draw(),a.release(),n):(r(Kf.Xx.UPDATE),n)}}]),e}(),Hw=function(){function e(){(0,o.Z)(this,e),this._step=Gw,this._dilation=1,this._firstIdleTime=(0,Fn.HA)(0)}return(0,s.Z)(e,[{key:"frame",value:function(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=(0,Fn.HA)(performance.now())):this._firstIdleTime=(0,Fn.HA)(0),(0,w.Z)("disable-feature:high-quality-idle"))this._dilation=1;else{var n=t?performance.now()-this._firstIdleTime:0;if(n>=Vw+zw)return this._step=(0,Fn.HA)(1/0),void(this._dilation=1);this._dilation=n>=Vw?qw:1}var i=(0,Se.uZ)(e/Fw,Gw,jw);this._step===1/0?this._step=(0,Fn.HA)(i):this._step=(0,Fn.HA)(this._step*Bw+i*(1-Bw))}},{key:"value",get:function(){return this._step}},{key:"timeDilation",get:function(){return this._dilation}},{key:"clear",value:function(){this._step=this._firstIdleTime=(0,Fn.HA)(0)}}]),e}(),Fw=.5,Vw=(0,Fn.HA)(12e4),zw=(0,Fn.HA)(1e4),qw=10,Bw=.9,Gw=(0,Fn.HA)(1e3),jw=(0,Fn.HA)(1e3/30),Ww=n(47180),Xw=function(){function e(t,n){(0,o.Z)(this,e),this._fbos=t,this.compositingHelper=n,this._width=4,this._height=4,this._clearColor=(0,st.Ue)()}return(0,s.Z)(e,[{key:"dispose",value:function(){this._color=(0,x.RY)(this._color),this.releaseBuffers()}},{key:"framebuffer",get:function(){return this.color.attachDepth(this.depth),this.color.fbo}},{key:"colorTexture",get:function(){return this.color.getTexture()}},{key:"depthTexture",get:function(){return this.depth.attachment}},{key:"initializeFrame",value:function(e,t,n){this._fbos.interactive=n===ns.YE.Default;var i=this._fbos.rctx;this._width=e.fullWidth,this._height=e.fullHeight,(0,Qt.d)(this,i.parameters.maxTextureSize);var r=this._color;return this._color=null,this.releaseBuffers(),(0,ot.c)(this._clearColor,t),r}},{key:"releaseBuffers",value:function(){var e;null!==(e=this._color)&&void 0!==e&&e.detachDepth(),this._depth=(0,x.RY)(this._depth)}},{key:"renderHUDVisibility",value:function(e,t,n){var i,r,a,o,s;return(null===(i=e)||void 0===i||null===(r=i.fbo)||void 0===r?void 0:r.width)===this._width&&(null===(a=e)||void 0===a||null===(o=a.fbo)||void 0===o?void 0:o.height)===this._height||(null!==(s=e)&&void 0!==s&&s.release(),e=this._fbos.acquire(this._width,this._height,"hud visibility",xt.q.RGBA4)),e.attachDepth(n||this.depth),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(Qw),t(),e.detachDepth(),e}},{key:"compositeToHUDVisibility",value:function(e,t){var n;this._fbos.rctx.bindFramebuffer(null===(n=e.hudVisibility)||void 0===n?void 0:n.fbo),this.compositingHelper.compositeHUD(e,t)}},{key:"renderOITPass",value:function(e,t,n){var i,r,a=this._width,o=this._height;switch(t){case Tw.A.ColorAlpha:(i=this._fbos.acquire(a,o,n?"oit hud color alpha":"oit color alpha",xt.q.RGBA16F)).acquireColor(_t.VY.COLOR_ATTACHMENT1,xt.q.R16F),r=[0,0,0,1];break;case Tw.A.FrontFace:i=this._fbos.acquire(a,o,n?"oit hud front":"oit front"),r=[0,0,0,0]}return n?i.acquireDepth(xt.m.DEPTH16_BUFFER):i.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(i.fbo),this._fbos.rctx.clearFramebuffer(r,n,n),e(),i.detachDepth(),i}},{key:"compositeToFramebuffer",value:function(e,t,n,i){this.bindFbo(),this.compositingHelper.composite(e,t,n,i)}},{key:"compositeOIT",value:function(e,t,n,i){i?(this._fbos.rctx.bindFramebuffer(i.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clear(_t.lk.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(e,t.getTexture(),t.getTexture(_t.VY.COLOR_ATTACHMENT1),n.getTexture())}},{key:"renderDepthDetached",value:function(e){this._bindTarget(this.color),e(),this._bindTarget(this.color,this.depth)}},{key:"renderToCachedFBO",value:function(e,t,n,i){var r,a,o,s,l,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:xt.q.RGBA,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:xt.m.DEPTH16_BUFFER,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:this._width,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:this._height,f=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null;return(null===(r=e)||void 0===r||null===(a=r.fbo)||void 0===a?void 0:a.width)===h&&(null===(o=e)||void 0===o||null===(s=o.fbo)||void 0===s?void 0:s.height)===d||(e=(0,x.RY)(e)),e=null!==(l=e)&&void 0!==l?l:this._fbos.acquire(h,d,t,u),null!==f&&void 0!==f&&f.forEach((function(t){return e.acquireColor(t.attachment,t.format)})),null!=c&&e.acquireDepth(c),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(i,!0,!0),n(),e}},{key:"renderToTargets",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this._bindTarget(t,n),this._fbos.rctx.clearFramebuffer(i,r,a),e(),t.detachDepth()}},{key:"bindFbo",value:function(){var e=null==this._color;if(this._bindTarget(this.color,this.depth),e){var t=this._fbos.rctx;t.setClearStencil(0),t.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),t.clear(_t.lk.COLOR_BUFFER_BIT|_t.lk.DEPTH_BUFFER_BIT|_t.lk.STENCIL_BUFFER_BIT)}}},{key:"_bindTarget",value:function(e,t){e.attachDepth(t),this._fbos.rctx.bindFramebuffer(e.fbo)}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"color",get:function(){return this._ensureColor()}},{key:"_ensureColor",value:function(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}},{key:"updateColor",value:function(e){var t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}},{key:"depth",get:function(){return this._depth||(this._depth=this._fbos.acquireDepth(xt.m.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}}]),e}(),Qw=[0,1,0,1],Yw=n(46293),Jw=function(){function e(){(0,o.Z)(this,e),this._inputs=new Map}return(0,s.Z)(e,[{key:"set",value:function(e,t){this._inputs.set(e,t)}},{key:"get",value:function(e){return this._inputs.get(e)}},{key:"has",value:function(e){return this._inputs.has(e)}},{key:"release",value:function(e){var t;(null===(t=this._inputs.get(e))||void 0===t?void 0:t.release())&&this._inputs.delete(e)}}]),e}(),Kw=n(89822),$w=n(78041),eC=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i){var r;return(0,o.Z)(this,n),r=t.call(this,e,i,(function(){return r.destroy()}))}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:$w.wu,colorWrite:mt.BK,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return _t.MX.TRIANGLE_STRIP}}]),n}(ft.A);eC.shader=new dt.J(Kw.a,(function(){return n.e(87075).then(n.bind(n,87075))}));var tC=n(79485),nC=1/512,iC=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a){var s;return(0,o.Z)(this,n),(s=t.call(this,{}))._techniques=e,s._rctx=i,s._data=r,s._requestRender=a,s._passParameters=new Kw.S(s._data),s._techniqueConfig=new tC.l,s._enabled=!1,s._vao=(0,St.o)(i),s}return(0,s.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._stop(),this._vao=(0,x.M2)(this._vao),this._techniques.release(this._technique),this._technique=null}},{key:"_visualizeShadowCastTechnique",get:function(){return this._technique=this._techniques.releaseAndAcquire(eC,this._techniqueConfig,this._technique),this._technique}},{key:"render",value:function(e){if(this._showVisualization){this._passParameters.sampleScale=1/this._data.computedSamples;var t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,(0,Tn._V)(this._vao,"geometry"))}}},{key:"setOptions",value:function(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}},{key:"opacityFromElevation",get:function(){return this._passParameters.opacityFromElevation},set:function(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}},{key:"_showVisualization",get:function(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>nC}},{key:"_threshold",get:function(){return this._passParameters.threshold},set:function(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}},{key:"_visualization",get:function(){return this._techniqueConfig.visualization},set:function(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniques.release(this._technique),this._technique=null,this._requestRenderIfRunning())}},{key:"_bandSize",get:function(){return this._passParameters.bandSize},set:function(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}},{key:"_bandsEnabled",get:function(){return this._techniqueConfig.bandsEnabled},set:function(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniques.release(this._technique),this._technique=null,this._requestRenderIfRunning())}},{key:"_setColor",value:function(e){var t=this._passParameters.color;(0,ot.a)(e,t)||((0,ot.c)(this._passParameters.color,e),this._requestRenderIfRunning())}},{key:"_setEnabled",value:function(e){e!==this._enabled&&(e?this._start():this._stop())}},{key:"_requestRenderIfRunning",value:function(){this._enabled&&this._requestRender()}},{key:"_start",value:function(){this._enabled=!0,this._requestRender()}},{key:"_stop",value:function(){this._enabled=!1,this._requestRender()}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],iC.prototype,"opacityFromElevation",null),iC=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],iC);var rC=n(471),aC=n(13378),oC=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),i=t.call(this,e,new Jy,(function(){return i.destroy()}))}return(0,s.Z)(n,[{key:"initializeProgram",value:function(e){return new pt.$(e.rctx,n.shader.get().build(this.configuration),vt.i)}},{key:"initializePipeline",value:function(){return(0,mt.sm)({blending:(0,mt.wK)(_t.zi.ONE,_t.zi.ONE,_t.zi.ONE,_t.zi.ONE),colorWrite:mt.BK,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return _t.MX.TRIANGLE_STRIP}}]),n}(ft.A);oC.shader=new dt.J(aC.a,(function(){return n.e(85383).then(n.bind(n,85383))}));var sC=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r,a,s,u){var c;(0,o.Z)(this,n),(c=t.call(this,{})).fbos=e,c._stage=r,c._prepareForShadowMapPass=a,c._renderToShadowMap=s,c._requestRender=u,c._progress=0,c._sampleCount=0,c._passParameters=new Yy.nj,c._cachedLightDirections=[],c._depthRange=ay,c._previewing=!1,c._cameraForcedForScreenshot=!1,c._shadowAccumulatorKey="shadowAccumulator",c._rctx=e.rctx,c._bindParameters=new Kt.p(new rC.l(e,r.viewingMode),null),c._bindParameters.shadowMap.enabled=!0,c._vao=(0,St.o)(c._rctx),c._accumulationRenderer=new iC(i,c._rctx,(0,l.Z)(c),u);var h=c._stage.view.resourceController.scheduler;return c.addHandles([h.registerTask($t.T8.SHADOW_ACCUMULATOR,(0,l.Z)(c)),(0,k.watch)((function(){return r.renderView}),(function(e){c.removeHandles(uC),null!=e&&c.addHandles(e.events.on("force-camera-for-screenshot",(function(){return c._cameraForcedForScreenshot=!0})),uC)}),k.syncAndInitial),(0,k.watch)((function(){return c._previewing}),(function(){return c._requestRenderIfEnabled()}),k.sync)],c._shadowAccumulatorKey),c}return(0,s.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=(0,x.M2)(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=(0,x.M2)(this._fbo),this._vao=(0,x.M2)(this._vao),this._accumulationTechniqueCached=(0,x.RY)(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}},{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){var e;return null===(e=this._fbo)||void 0===e?void 0:e.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){if(null==this._accumulationTechniqueCached){var e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new oC(e)}return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},{key:"_isActive",get:function(){return null!=this._fbo&&this._sampleCount>0}},{key:"canAccumulate",get:function(){return null!=this._bindParameters.depth&&this._depthRange!==ay&&this._opacityFromElevation>nC}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(e){var t=this._cachedLightDirections;if(!(0,gd.fS)(t,e,et.G)){var n=Math.min(aC.S,e.length);t.length=n,this._sampleCount=n;for(var i=0;i<n;++i){var r;t[i]=(0,et.c)(null!==(r=t[i])&&void 0!==r?r:(0,U.Ue)(),e[i])}this._invalidate()}}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(e){this._accumulationRenderer.opacityFromElevation=e}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&this._progress>0}},{key:"runTask",value:function(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}},{key:"renderAccumulation",value:function(e,t,n,i){if(this._depthRange=t,this._updateCamera(n),this._bindParameters.contentCamera=i,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return!1;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();for(var r=this._cameraForcedForScreenshot?this._sampleCount:Math.min(lC,this._sampleCount-this._progress),a=0;a<r;++a)this._accumulateShadow();return this._cameraForcedForScreenshot=!1,this._requestRender(),r>0}},{key:"render",value:function(e){this._accumulationRenderer.render(e)}},{key:"setOptions",value:function(e){if(void 0!==e.enabled){var t=null!=this._fbo;e.enabled!==t&&(e.enabled?this._enable():this._disable())}void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}},{key:"readAccumulatedShadow",value:function(e,t){return!this._isActive||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,_t.VI.RGBA,_t.Br.UNSIGNED_BYTE,cC),cC[0]/this._progress)}},{key:"_enable",value:function(){this._progress=0;var e=new Yt.X;e.pixelFormat=_t.VI.RED,e.internalFormat=_t.lP.R8,e.wrapMode=_t.e8.CLAMP_TO_EDGE,this._fbo=new Qt.X(this._rctx,e),this._requestRender()}},{key:"_disable",value:function(){this._fbo=(0,x.M2)(this._fbo),this._requestRender()}},{key:"_invalidate",value:function(){this._progress=0,this._requestRenderIfEnabled()}},{key:"_clear",value:function(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(_t.lk.COLOR_BUFFER_BIT),this._progress=0}},{key:"_accumulateShadow",value:function(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);var e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,(0,Tn._V)(this._vao,"geometry"))}},{key:"_updateCamera",value:function(e){var t=this._fbo;if(null!=t){var n=this._bindParameters.camera;e.equals(n)||n.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-(0,Se.CW)(4e4,5e4,e.relativeElevation)}}},{key:"_requestRenderIfEnabled",value:function(){this._fbo&&this._requestRender()}},{key:"test",get:function(){}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],sC.prototype,"_progress",void 0),(0,f._)([(0,E.Cb)()],sC.prototype,"_sampleCount",void 0),(0,f._)([(0,E.Cb)()],sC.prototype,"_fbo",void 0),(0,f._)([(0,E.Cb)()],sC.prototype,"_depthRange",void 0),(0,f._)([(0,E.Cb)()],sC.prototype,"_previewing",void 0),(0,f._)([(0,E.Cb)()],sC.prototype,"_accumulationRenderer",void 0),(0,f._)([(0,E.Cb)()],sC.prototype,"_isRefining",null),(0,f._)([(0,E.Cb)()],sC.prototype,"_isActive",null),(0,f._)([(0,E.Cb)()],sC.prototype,"canAccumulate",null),(0,f._)([(0,E.Cb)()],sC.prototype,"_isDoneAccumulating",null),(0,f._)([(0,E.Cb)()],sC.prototype,"_opacityFromElevation",null),(0,f._)([(0,E.Cb)()],sC.prototype,"running",null),sC=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],sC);var lC=6,uC="renderView",cC=new Uint8Array(4),hC=(0,G.a)(),dC=function(){function e(){(0,o.Z)(this,e),this._plane=(0,G.a)()}return(0,s.Z)(e,[{key:"isEnabled",get:function(){return!(0,G.d)(this.plane,hC)}},{key:"plane",get:function(){return this._plane},set:function(e){(0,G.c)(e||hC,this._plane)}}]),e}(),fC=n(58206),vC=n(77958),pC=n(41139),_C=n(90941),mC=n(40235);var gC,yC=function(){function e(t,n){var i=this;(0,o.Z)(this,e),this._timer=t,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,n.forEach((function(e){var t=i._timer.createQuery(),n=i._timer.createQuery();i._queryPool.push(t,n),i._queryResults.set(e,null)}))}return(0,s.Z)(e,[{key:"start",value:function(){mC.P9||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}},{key:"stop",value:function(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();var t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;var n=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,n}},{key:"abort",value:function(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}},{key:"dispose",value:function(){var e=this;null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((function(t){e._timer.deleteQuery(t)})),this._queryResults.forEach((function(t){null!=t&&e._timer.deleteQuery(t)}))}}]),e}();!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.DEPTH="depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.NORMALS="normals",e.SSAO="SSAO",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.OPAQUE_ENVIRONMENT="opaque environment",e.TRANSPARENT_ENVIRONMENT="transparent environment",e.LASER_LINES="laser lines",e.VIEWSHED="viewshed",e.OCCLUDED="occluded",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish"}(gC||(gC={}));var bC,wC,CC=Object.values(Fb).concat(Object.values(Vb)).concat(Object.values(gC)),xC="Total",TC=function(){function e(t){(0,o.Z)(this,e),this._rctx=t,this._startTimeStampCPU=(0,Fn.HA)(0),this._lastTimeStampCPU=(0,Fn.HA)(0),this._totalCPUTime=new _C.Z(xC),this._cpuTimeSamplers=new Map(CC.map((function(e){return[e,new _C.Z(e)]}))),this._enableGPUTimer=0,this._totalGPUTime=new _C.Z("GPU"),this._gpuTimeSamplers=new Map(CC.map((function(e){return[e,new _C.Z(e)]}))),this._totalTime=(0,Fn.HA)(0),this._totalFrameCount=0}return(0,s.Z)(e,[{key:"totalCPUTimeSampler",get:function(){return this._totalCPUTime}},{key:"cpuTimeSamplers",get:function(){return Array.from(this._cpuTimeSamplers.values())}},{key:"totalGPUTimeSampler",get:function(){return this._totalGPUTime}},{key:"gpuTimeSamplers",get:function(){return Array.from(this._gpuTimeSamplers.values())}},{key:"gpuSamplingEnabled",get:function(){return null!=this._gpuTimerPool}},{key:"totalTime",get:function(){return this._totalTime}},{key:"totalFrameCount",get:function(){return this._totalFrameCount}},{key:"elapsedTime",get:function(){return(0,Fn.HA)(performance.now()-this._startTimeStampCPU)}},{key:"enableGPUPerformanceInfo",value:function(){var e=this;if(null==this._gpuTimerPool){var t=[].concat((0,Ru.Z)(CC),[xC]);this._gpuTimerPool=function(e,t){var n=e.capabilities.disjointTimerQuery;return null==n?null:new yC(n,t)}(this._rctx,t)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:function(){}};++this._enableGPUTimer;var n=!1;return{hasGPUTimerSupport:!0,remove:function(){n||(n=!0,--e._enableGPUTimer,0===e._enableGPUTimer&&(e._gpuTimerPool=(0,x.M2)(e._gpuTimerPool)))}}}},{key:"startFrame",value:function(){this._startTimeStampCPU=this._lastTimeStampCPU=(0,Fn.HA)(performance.now()),this._gpuTimerPool&&this._gpuTimerPool.start()}},{key:"advance",value:function(e){var t=(0,Fn.HA)(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){var n=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(n),this._gpuTimerPool.start()}}},{key:"finishFrame",value:function(){if(this._gpuTimerPool){var e=this._gpuTimerPool.stop(gC.FINISH);this._gpuTimeSamplers.get(gC.FINISH).record(e),this._rctx.gl.flush()}var t=(0,Fn.HA)(performance.now()-this._startTimeStampCPU);this._totalTime=(0,Fn.HA)(this._totalTime+t),this._totalCPUTime.record(t),this._gpuTimerPool&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((function(e,t){return e+(t.last||0)}),0)),++this._totalFrameCount}}]),e}(),SC=function(){function e(t,n,i,r,a,s){var l=this;(0,o.Z)(this,e),this._stage=t,this._techniques=i,this._rctx=r,this._compositingHelper=a,this._requestRender=s,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=function(e){},this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=(0,st.al)(0,0,0,1),this._sliceHelper=new dC,this._blit=null,this._state=(0,vd.t)(rs.n.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=Am.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new Hw,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=(0,vd.t)(0),this._renderHiddenTransparentEdges=function(){},this._pluginInput=new Jw,this._releaseNormals=function(e){e.some((function(e){return"normals"===e.name}))&&l._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new uw(r),this._renderStateFeatures=(0,vd.t)((0,is.n)(!(0,w.Z)("disable-feature:high-quality-idle"),t.view.qualityProfile)),this._offscreen=new Xw(this.fboCache,this._compositingHelper),this.performanceInfo=new TC(this._rctx),this._shadowMap=new rC.l(this.fboCache,t.viewingMode),this._viewshed=new fC.U({fboCache:this.fboCache,view:t.view},(function(e,t,n){t.setGLViewport(l._rctx);var i=e.camera,r=e.contentCamera;l._ensureBindParametersCamera(t,t),l._renderAllGeometry(n),l._ensureBindParametersCamera(i,r),e.camera.setGLViewport(l._rctx)})),this._shadowAccumulator=new sC(this.fboCache,i,t,(function(e){var t=l.shadowsEnabled;l._shadowMap.enabled=!0,l._ensureBindParametersCamera(e.camera,e.contentCamera),l._plugins.prepareRender(),l._shadowMap.enabled=t}),(function(e,t,n){var i=l._stage.view.qualitySettings.maximumPixelRatio;e.shadowMap.start(e.camera,t,n,!0,i),l._renderShadowCascades(ep.H_.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(l._rctx),l._ensureBindParametersCamera(e.camera,e.contentCamera)}),s),this._renderContext=new Yw.V1(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new Lw(this._renderContext),this._plugins=new Nw({renderContext:this._renderContext,techniques:i,materials:n,requestRender:s,controller:t,fbos:this.fboCache,isFeatureEnabled:function(e){return l.isFeatureEnabled(e)}}),this.renderPassManager=new Pw,this._plugins.add(this.renderPassManager),this._plugins.add(this._viewshed),this._handles=[(0,k.watch)((function(){return l._stage.view.state.camera}),(function(){return s()}),k.syncAndInitial),(0,k.watch)((function(){return Vl.h.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES}),(function(e){l._renderHiddenTransparentEdges=e?function(){return l._renderEdges(vC.i.TRANSPARENT)}:function(){},s()}),k.initial),(0,k.watch)((function(){var e;return null===(e=l._stage.view.environment.background)||void 0===e?void 0:e.color}),(function(e){var t=e?(0,it.O)(e):st.AG;(0,ot.s)(l._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),s()}),k.syncAndInitial),(0,k.watch)((function(){return l._stage.view.state.camera.relativeElevation}),(function(e){l._inGlobeView=(null!==e&&void 0!==e?e:1/0)>=Dw.o}),k.syncAndInitial)]}return(0,s.Z)(e,[{key:"destroy",value:function(){this._handles.forEach((function(e){return e.remove()})),this._gpuTimerHandle=(0,x.hw)(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=(0,x.IM)(this._loadEdgeViewTask),this._edgeView=(0,x.SC)(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),Ww.j.prune()}},{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"updateRenderFeatures",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!(0,w.Z)("disable-feature:high-quality-idle");this._renderStateFeatures.value=(0,is.n)(t,e),this._plugins.renderFeatureChanged(),this._requestRender()}},{key:"isFeatureEnabled",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._state.value;return null!==(t=this._renderStateFeatures.value.get(n,e))&&void 0!==t&&t}},{key:"setFeatureEnabled",value:function(e,t,n){this._renderStateFeatures.mutate((function(i){return i.set(t,e,n)})),this._requestRender()}},{key:"_highQualityTransparency",get:function(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(is.Y.HighQualityTransparency)}},{key:"hasReflections",get:function(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(is.Y.WaterReflection))}},{key:"hasDecorations",get:function(){return this._plugins.hasDecorations||this._nodes.produces("magnifier-color")}},{key:"hasHighlights",get:function(){return this._plugins.produces(ep.H_.Highlight,fi.r.OPAQUE_MATERIAL,fi.r.TRANSPARENT_MATERIAL,fi.r.DRAPED_MATERIAL)}},{key:"hasLaserlines",get:function(){return this._plugins.produces(this._renderContext.output,fi.r.LASERLINES,fi.r.LASERLINES_CONTRAST_CONTROL)}},{key:"hasSSAO",get:function(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(is.Y.SSAO))&&!this._inGlobeView}},{key:"hasSMAA",get:function(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(is.Y.Antialiasing)}},{key:"fullResolutionAtmosphere",get:function(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(is.Y.HighResolutionAtmosphere)}},{key:"_releaseFBOs",value:function(){this._bindParameters.ssr.lastFrameColor=(0,x.RY)(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.depth=(0,x.RY)(this._bindParameters.multipassTerrain.depth),this._bindParameters.multipassGeometry.depth=(0,x.RY)(this._bindParameters.multipassGeometry.depth)}},{key:"_disposeOffscreenBuffers",value:function(){this._offscreen.dispose(),this._disposeBindBuffers()}},{key:"_disposeBindBuffers",value:function(){this._shadowMap.disposeOffscreenBuffers(),this._viewshed.viewshedShadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=(0,x.RY)(this._bindParameters.depth),this._bindParameters.hudVisibility=(0,x.RY)(this._bindParameters.hudVisibility)}},{key:"updating",get:function(){return null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}},{key:"loadEdgeView",value:function(){var e=this;return this._loadEdgeViewTask||(this._loadEdgeViewTask=(0,ye.vr)(function(){var t=(0,a.Z)((0,r.Z)().mark((function t(i){var a,o,s;return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.e(2731).then(n.bind(n,2731));case 2:return a=t.sent,o=a.EdgeView,(0,S.k_)(i),s=e._edgeView=new o({rctx:e._rctx,renderSR:e._stage.view.renderSpatialReference,viewingMode:e._stage.viewingMode,techniques:e._techniques,setNeedsRender:function(){return e._requestRender()},schedule:DC(e._stage.view.resourceController)}),t.abrupt("return",(e._handles.push((0,k.watch)((function(){return s.updating}),(function(){return e._requestRender()}),k.sync)),e._requestRender(),e._edgeViewCallbacks.forEach((function(e){return e(s)})),e._edgeViewCallbacks.length=0,s));case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())),this._loadEdgeViewTask.promise}},{key:"withEdgeView",value:function(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return this._reprojectionMatrixVersion.value>=0&&(0,Nt.fS)(this._bindParameters.ssr.reprojectionMatrix,Ut.Wd)}},{key:"_reprojectionMatrix",set:function(e){(0,gd.Vx)(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}},{key:"shadowsEnabled",get:function(){var e;return!(null===(e=this._shadowMap)||void 0===e||!e.enabled)}},{key:"setParameters",value:function(e){var t,n=this._shadowMap,i=this._bindParameters;if(void 0!==(null===(t=e.qualitySettings)||void 0===t?void 0:t.reflections)&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&n.maxCascades!==e.shadowMapMaxCascades&&(n.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);var r="virtual"!==e.environment.lighting.type;i.enableFillLights!==r&&(i.enableFillLights=r,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"plugins",get:function(){return this._plugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlend.result}},{key:"_oitEnabled",get:function(){return this._highQualityTransparency&&this._hasOITSupport}},{key:"modify",value:function(e,t){var n=this;this._isRendering&&console.warn("Renderer.modify called while rendering");var i=e.adds,r=e.removes,a=e.updates;if(0!==i.length||0!==r.length||0!==a.length){var o=(0,ns.q9)(e),s=!1;o.forEach((function(i,r){if(!t.done){var a=n._plugins.getMaterialRenderer(r);if(null==a&&i.adds.length>0){var o=new pC.A({material:r});o.initializeRenderContext(n._plugins._context),a=o,n._plugins.add(a)}a&&(a.modify(i),0===a.numGeometries&&(s=!0)),i.removes.forEach((function(t){return e.removes.removeUnordered(t)})),i.adds.forEach((function(t){return e.adds.removeUnordered(t)})),i.updates.forEach((function(t){return e.updates.removeUnordered(t)})),t.madeProgress()}})),s&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}}},{key:"_updateHasFlags",value:function(){var e=this._pluginsHas;e.hudElements=this._plugins.produces(ep.H_.Color,fi.r.LINE_CALLOUTS_HUD_DEPTH,fi.r.HUD_MATERIAL,fi.r.LABEL_MATERIAL),e.water=this._plugins.produces(ep.H_.Normal,fi.r.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees}},{key:"updateAnimation",value:function(e){var t=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e),this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations,this._hasAnimations!==t&&(this._gpuTimerHandle=t?(0,x.hw)(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}},{key:"animationTimestep",get:function(){return this._animationTimestep.value}},{key:"animationTimeDilation",get:function(){return this._animationTimestep.timeDilation}},{key:"resetAnimation",value:function(){this._animationTimestep.clear()}},{key:"tick",value:function(){this.fboCache.clean()}},{key:"render",value:function(e,t){var n,i,r,a,o,s,l=this,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ns.YE.Default,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Kf.Iq.ON;this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();var h=this._offscreen,d=e.camera,f=e.contentCamera,v=e.mode,p=e.alignPixelEnabled;this._state.value=v,this._bindParameters.overlay=this.renderOverlay(t),this._bindParameters.overlay&&this.performanceInfo.advance(gC.OVERLAY),this._renderContext.time=t,this._bindParameters.transparencyPassType=Tw.A.NONE,this._bindParameters.alignPixelEnabled=p,this._bindParameters.decorations=c,this._bindParameters.mainColor=this._bindParameters.mainDepth=null,this._bindParameters.viewshedEnabled=this._viewshed.enabled;var _=this._nodes.produces("magnifier-color"),m=this._nodes.produces("final-color"),g=(0,G.a)(this._sliceHelper.plane);c===Kf.Iq.OFF&&(this._sliceHelper.plane=null),d.setGLViewport(this._rctx);var y=h.initializeFrame(d,this._backgroundColor,u);this.hasReflections?this._bindParameters.ssr.lastFrameColor=y:null===y||void 0===y||y.release(),this._ensureBindParametersCamera(d,f),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&c===Kf.Iq.ON;var b=this._plugins.produces(ep.H_.Color,fi.r.OPAQUE_TERRAIN)&&(this._terrainTransparency===Am.Semitransparent||this._terrainTransparency===Am.TransparentWithDraped),w=this._highQualityTransparency&&b,C=(n=this._plugins).produces.apply(n,[ep.H_.Color].concat(PC));this._prepareShaders(w,C),this.performanceInfo.advance(gC.PREPARE);var T=this._computeDepthRange(d);this._renderShadowMap(d,this._bindParameters.lighting.mainLight.direction,T),this._ensureBindParametersCamera(d,f);var S=this._renderNormals();if(this._pluginInput.set("normals",S),S){var k,M=null;this._needsDepth&&(null!==(k=M=S.getAttachment(_t.Lu))&&void 0!==k&&k.retain()),this._pluginInput.set("ssao",this._renderSSAO()),this._renderNoSSAOGeometryDepth(M),S=null}else this._renderAllGeometryDepth();this._renderShadowAccumulation(T,d,f),this._ensureBindParametersSSR(t),this._renderContext.output=ep.H_.Color,h.bindFbo(),this._bindParameters.mainColor=h.colorTexture,this._bindParameters.mainDepth=h.depthTexture;var P=(i=this.plugins).produces.apply(i,[ep.H_.Color].concat(MC));P&&this._renderOpaqueGeometry(),this._offscreen.updateColor((function(e){return l._renderNodes(Fb.OPAQUE,e,P)})),null!==(r=(a=this.fboCache).debugCallback)&&void 0!==r&&r.call(a,"opaque-color",this._offscreen.color.fbo),this._renderPlugins(fi.r.OPAQUE_ENVIRONMENT,gC.OPAQUE_ENVIRONMENT),this._renderMultipassTerrainDepth(w),this._setMultipassTerrain(w),this._renderEdges(vC.i.OPAQUE),h.bindFbo(),this._renderPlugins(fi.r.VOXEL,gC.VOXEL),this._renderHiddenTransparentEdges(),C&&(this._oitEnabled?this._renderOITPass(bC.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor((function(e){return l._renderNodes(Fb.TRANSPARENT,e,C)})),null!==(o=(s=this.fboCache).debugCallback)&&void 0!==o&&o.call(s,"transparent-color",this._offscreen.color.fbo),this._renderMultipassGeometryDepth(w),this._renderHUDVisibility(),w||this._plugins.render(this._pluginInput,fi.r.LINE_CALLOUTS);var R=u===ns.YE.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this._renderEdges(vC.i.TRANSPARENT);var E=b?this._renderTransparentTerrain():null;E&&(this.performanceInfo.advance(gC.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(w?this._renderLineCallouts(Aw.U.Occluded):h.compositeToHUDVisibility(this._bindParameters,E.getTexture()),this._renderHUD(Aw.U.Occluded,h.color))),this._setTerrainCulling(!1),E&&(h.compositeToFramebuffer(this._bindParameters,E.getTexture(),mb.PremultipliedAlpha,1),E.release(),w&&(this._renderEdges(vC.i.OPAQUE),C&&(this._oitEnabled?this._renderOITPass(bC.Geometry):this._renderTransparentMaterial(),this.performanceInfo.advance(gC.TRANSPARENT)),this._renderEdges(vC.i.TRANSPARENT))),this._bindParameters.ssao=(0,x.RY)(this._bindParameters.ssao),w&&this._renderLineCallouts(Aw.U.NotOccluded),this._setMultipassEnabled(!1),this._renderTransparentEnvironment(),this._renderViewshed(),this._renderLaserlines(),this._renderOccluded(),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._offscreen.updateColor((function(e){return l._renderNodes(Fb.COMPOSITE,e)}));var O=this._nodes.produces("aa-color"),A=!(u!==ns.YE.Default||m||_&&c===Kf.Iq.ON&&u===ns.YE.Default),D=this._pluginInput.get("composite-color"),Z=A?cw:this.fboCache.acquire(D.fbo.width,D.fbo.height,"aa-color"),I=O?this._renderNodes(Vb.ANTIALIASING,Z):this._blitToDefault(D,Z,!1);this._pluginInput.set(Vb.ANTIALIASING,I),this._renderHUD(Aw.U.NotOccluded,I);var L=this._renderNodes(Vb.HIGHLIGHTS,I),N=this._renderNodes(Vb.MAGNIFIER,L);return _&&c===Kf.Iq.ON&&u===ns.YE.Default&&!m&&(N=this._blitToDefault(N)),m?(N.attachDepth(h.depth),this._blitToDefault(this._renderNodes(Fb.FINAL,N)),N.detachDepth()):this._pluginInput.set(Fb.FINAL,N),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=g,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),u!==ns.YE.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:this._pluginInput.get("final-color"),oid:R}}},{key:"_prepareShaders",value:function(e,t){this._renderContext.output=ep.H_.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(fi.r.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(fi.r.LINE_CALLOUTS),t&&this._prepareTransparencySlots(),this._plugins.prepare(fi.r.VIEWSHED,fi.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,fi.r.TRANSPARENT_ENVIRONMENT,fi.r.LASERLINES),this._rctx.gl.flush()}},{key:"_renderObjectAndLayerIdColor",value:function(){if((0,w.Z)("enable-feature:objectAndLayerId-rendering")){var e=this._renderContext.output,t=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return t.acquireDepth(xt.m.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(ep.H_.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=Aw.U.NotOccluded,this._plugins.render(this._pluginInput,fi.r.HUD_MATERIAL),this._renderContext.output=e,this.performanceInfo.advance(gC.OBJECT_AND_LAYER_ID_COLOR),t}}},{key:"finish",value:function(e){this._hasAnimations||this._animationTimestep.clear();var t=this.performanceInfo.gpuSamplingEnabled,n=e===Kf.Xx.BACKGROUND;if(n||t){var i=n?this.performanceInfo.elapsedTime:0,r=t?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),a=Math.max(i,r);this._animationTimestep.frame(a,n)}}},{key:"readDepthPixels",value:function(e,t){var n;if(this._bindParameters.mainDepth){var i=this._offscreen,r=i.width,a=i.height,o=this.fboCache.acquire(r,a,"linear-depth");this._rctx.bindFramebuffer(o.fbo),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.clearFramebuffer([0,0,0,0],!0,!0),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,this._bindParameters.mainDepth),null!==(n=o.fbo)&&void 0!==n&&n.readPixels(e[0],e[1],e[2],e[3],_t.VI.RGBA,_t.Br.UNSIGNED_BYTE,t),o.release()}}},{key:"readHUDVisibility",value:function(e,t,n,i,r){var a,o;null===(a=this._bindParameters.hudVisibility)||void 0===a||null===(o=a.fbo)||void 0===o||o.readPixels(e,t,n,i,_t.VI.RGBA,_t.Br.UNSIGNED_BYTE,r)}},{key:"readAccumulatedShadow",value:function(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}},{key:"_setMultipassTerrain",value:function(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}},{key:"_setMultipassEnabled",value:function(e){this._bindParameters.multipassEnabled=e}},{key:"_setTerrainCulling",value:function(e){this._bindParameters.multipassTerrain.cullAboveGround=e}},{key:"_renderEdges",value:function(e){var t=this,n=this._edgeView;if(null!==n&&void 0!==n&&n.shouldRender()){var i=this._offscreen,r=i.width,a=i.height,o=i.depth,s=this.fboCache.acquire(r,a,"edges"),l=this._bindParameters.multipassGeometry.depth;this._offscreen.renderToTargets((function(){return n.render(t._bindParameters,e)}),s,null!==l&&void 0!==l?l:o,kC),this._offscreen.compositeToFramebuffer(this._bindParameters,s.getTexture(),mb.Alpha,1),s.release(),this.performanceInfo.advance(e===vC.i.OPAQUE?gC.OPAQUE_EDGES:gC.TRANSPARENT_EDGES)}}},{key:"_renderShadowMap",value:function(e,t,n){var i=this._shadowMap;i.enabled&&(i.start(e,t,n,this.isFeatureEnabled(is.Y.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(ep.H_.ShadowHighlight,this._shadowMap),i.moveSnapshot(rC.i.Highlight),this._renderShadowCascades(ep.H_.ShadowExcludeHighlight,this._shadowMap),i.copySnapshot(rC.i.ExcludeHighlight),this._renderShadowCascades(ep.H_.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(ep.H_.Shadow),i.finish(),e.setGLViewport(this._rctx),this.performanceInfo.advance(gC.SHADOW_MAP))}},{key:"_renderShadowCascades",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._shadowMap,r=(0,i.Z)(n.cascades);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(a.camera,a.camera),this._renderAllGeometry(e)}}catch(o){r.e(o)}finally{r.f()}}},{key:"_needsDepth",get:function(){return this._plugins.consumes(ep.H_.Depth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugNeedsDepth}},{key:"_renderNoSSAOGeometryDepth",value:function(e){if(this._needsDepth&&e){var t=this._offscreen,n=t.width,i=t.height,r=this.fboCache.acquire(n,i,"depth");r.attachDepth(e),e.release(),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(void 0,!1,!0),this._renderGeometryExcludedFromSSAO(ep.H_.Depth),(0,x.RY)(this._bindParameters.depth),this._bindParameters.depth=r.obtainDepthTexture(),r.release(),this.performanceInfo.advance(gC.DEPTH)}else this._bindParameters.depth=(0,x.RY)(this._bindParameters.depth)}},{key:"_renderAllGeometryDepth",value:function(){if(this._needsDepth){var e=this._offscreen,t=e.width,n=e.height,i=this.fboCache.acquire(t,n,"depth").acquireDepth(xt.m.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderAllGeometry(ep.H_.Depth),(0,x.RY)(this._bindParameters.depth),this._bindParameters.depth=i.obtainDepthTexture(),i.release(),this.performanceInfo.advance(gC.DEPTH)}else this._bindParameters.depth=(0,x.RY)(this._bindParameters.depth)}},{key:"_renderMultipassTerrainDepth",value:function(e){if(e){var t=this._renderContext.output;this._renderContext.output=ep.H_.Depth;var n=this._offscreen,i=n.width,r=n.height,a=this.fboCache.acquire(i,r,"terrain depth").acquireDepth(xt.m.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(a.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderTransparentTerrain(),(0,x.RY)(this._bindParameters.multipassTerrain.depth),this._bindParameters.multipassTerrain.depth=a.obtainDepthTexture(),this._renderContext.output=t,a.release()}else this._bindParameters.multipassTerrain.depth=(0,x.RY)(this._bindParameters.multipassTerrain.depth)}},{key:"_renderMultipassGeometryDepth",value:function(e){if(e){var t=this._renderContext.output,n=this._offscreen,i=n.width,r=n.height,a=this.fboCache.acquire(i,r,"geometry depth").acquireDepth(xt.m.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(a.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderOpaqueGeometryAndTransparentMaterial(ep.H_.Depth),this._renderContext.output=t,(0,x.RY)(this._bindParameters.multipassGeometry.depth),this._bindParameters.multipassGeometry.depth=a.obtainDepthTexture(),a.release()}else this._bindParameters.multipassGeometry.depth=(0,x.RY)(this._bindParameters.multipassGeometry.depth)}},{key:"_needsDepthRange",get:function(){return this._shadowMap.enabled||this._needsShadowCast}},{key:"_computeDepthRange",value:function(e){if(!this._needsDepthRange)return ay;var t=Eb(e,this._plugins.plugins,this._stage.layers);return iy(t,this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}},{key:"_renderNormals",value:function(){var e=this,t=this._nodes.require("normals","final-color","composite-color","opaque-color","transparent-color"),n=(this.hasSSAO?1:0)+(this.hasLaserlines?1:0)+t;if(0!==n){var i=this._offscreen.renderToCachedFBO(null,"normals",(function(){return e._renderGeometryForSSAO(ep.H_.Normal)}),[0,0,0,0],xt.q.RGBA,xt.m.DEPTH_STENCIL_TEXTURE),r=this._nodes.optional("normals","final-color","composite-color","opaque-color","transparent-color")+(this._viewshedEnabled?1:0);return i.retain(n+r-1),this.performanceInfo.advance(gC.NORMALS),i}}},{key:"_renderSSAO",value:function(){var e=this._pluginInput.get("normals");if(this.hasSSAO&&e){var t=this._nodes.render("ssao",this._pluginInput);return this._bindParameters.ssao=t,e.detachDepth(),this._pluginInput.release("normals"),this.performanceInfo.advance(gC.SSAO),t}null===e||void 0===e||e.detachDepth()}},{key:"_renderAllGeometry",value:function(e){this._renderContext.output=e,this._plugins.prepare(fi.r.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}},{key:"_renderOpaqueGeometryAndTransparentMaterial",value:function(e){this._renderContext.output=e,this._plugins.prepare(fi.r.TRANSPARENT_MATERIAL,fi.r.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}},{key:"_renderGeometryForSSAO",value:function(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,fi.r.INTEGRATED_MESH,fi.r.OPAQUE_TERRAIN,fi.r.OPAQUE_MATERIAL,fi.r.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}},{key:"_renderGeometryExcludedFromSSAO",value:function(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,fi.r.OPAQUE_NO_SSAO_DEPTH,fi.r.TRANSPARENT_NO_SSAO_DEPTH)}},{key:"_prepareOpaqueGeometry",value:function(){var e;(e=this._plugins).prepare.apply(e,MC.concat([fi.r.OPAQUE_ENVIRONMENT]))}},{key:"_renderOpaqueGeometry",value:function(){var e;(e=this._plugins).render.apply(e,[this._pluginInput].concat(MC))}},{key:"_renderTransparentMaterial",value:function(){var e;(e=this._plugins).render.apply(e,[this._pluginInput].concat(PC))}},{key:"_renderTransparentTerrain",value:function(){var e=this,t=this._renderContext.output;if(this._plugins.produces(t,fi.r.TRANSPARENT_TERRAIN)){var n=function(){return e._plugins.render(e._pluginInput,fi.r.TRANSPARENT_TERRAIN)};if(t===ep.H_.Color){var i=this._offscreen,r=i.width,a=i.height,o=i.depth,s=this.fboCache.acquire(r,a,"transparent terrain");return this._offscreen.renderToTargets(n,s,o,[0,0,0,0]),s}n()}}},{key:"_renderHUDVisibility",value:function(){var e=this;this._plugins.produces(this._renderContext.output,fi.r.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,(function(){return e._plugins.render(e._pluginInput,fi.r.OCCLUSION_PIXELS)}),this._bindParameters.multipassGeometry.depth),this._offscreen.bindFbo(),this.performanceInfo.advance(gC.HUD_VISIBILITY)):this._bindParameters.hudVisibility=(0,x.RY)(this._bindParameters.hudVisibility)}},{key:"_renderLineCallouts",value:function(e){var t=this;if(this._bindParameters.hudRenderStyle=e,e===Aw.U.Occluded){var n=this._offscreen,i=n.width,r=n.height,a=n.color,o=this.fboCache.acquireDepth(xt.m.DEPTH16_BUFFER,i,r,"line callouts");this._offscreen.renderToTargets((function(){return t._plugins.render(t._pluginInput,fi.r.LINE_CALLOUTS)}),a,o,void 0,!0,!0),o.release()}else this._plugins.render(this._pluginInput,fi.r.LINE_CALLOUTS)}},{key:"_renderLaserlines",value:function(){var e=this;if(this.hasLaserlines){if(this._plugins.render(this._pluginInput,fi.r.LASERLINES),this._plugins.produces(this._renderContext.output,fi.r.LASERLINES_CONTRAST_CONTROL)){var t=this._offscreen,n=t.width,i=t.height,r=t.depth,a=this.fboCache.acquire(n,i,"laser lines");t.renderToTargets((function(){return e._plugins.render(e._pluginInput,fi.r.LASERLINES_CONTRAST_CONTROL)}),a,r,kC),t.compositeToFramebuffer(this._bindParameters,a.getTexture(),mb.PremultipliedAlpha,1),a.release()}this._pluginInput.release("normals"),this.performanceInfo.advance(gC.LASER_LINES)}}},{key:"_renderHUD",value:function(e,t){var n=this;if(this._pluginsHas.hudElements){if(this._oitEnabled){var i=this._renderOITPass(bC.HUD,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.composite(this._bindParameters,i.getTexture(),mb.PremultipliedAlpha),i.release()}else if(e===Aw.U.Occluded){this._renderContext.output=ep.H_.Color;var r=this._offscreen,a=r.width,o=r.height,s=r.color,l=this.fboCache.acquireDepth(xt.m.DEPTH16_BUFFER,a,o,"hud");this._offscreen.renderToTargets((function(){return n._renderHUDElements(e)}),s,l,void 0,!0,!0),l.release()}else this._renderContext.output=ep.H_.Color,t.acquireDepth(xt.m.DEPTH16_BUFFER),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===Aw.U.Occluded?gC.HUD_OCCLUDED:gC.HUD)}}},{key:"_renderHUDElements",value:function(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(fi.r.LINE_CALLOUTS_HUD_DEPTH,fi.r.HUD_MATERIAL,fi.r.LABEL_MATERIAL),this._plugins.render(this._pluginInput,fi.r.LINE_CALLOUTS_HUD_DEPTH,fi.r.HUD_MATERIAL,fi.r.LABEL_MATERIAL)}},{key:"_needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._plugins.produces(ep.H_.ShadowHighlight,fi.r.OPAQUE_MATERIAL)}},{key:"_renderHighlightPrepass",value:function(){var e=this;if(this.hasHighlights){var t=this._offscreen.renderToCachedFBO(null,"highlights",(function(){e._renderAllGeometry(ep.H_.Highlight),e._rctx.clear(_t.lk.DEPTH_BUFFER_BIT),e._renderHUDElements(Aw.U.Both)}),[0,0,0,0],xt.q.RGBA4,xt.m.DEPTH_STENCIL_TEXTURE);return t.detachDepth(),t}}},{key:"_needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"_renderShadowAccumulation",value:function(e,t,n){this._needsShadowCast&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,e,t,n)&&this.performanceInfo.advance(gC.ACCUMULATED_SHADOWS)}},{key:"_prepareTransparencySlots",value:function(){var e,t;this._renderContext.output=ep.H_.Color,this._bindParameters.transparencyPassType=Tw.A.ColorAlpha,(e=this._plugins).prepare.apply(e,PC),this._bindParameters.transparencyPassType=Tw.A.FrontFace,(t=this._plugins).prepare.apply(t,PC),this._bindParameters.transparencyPassType=Tw.A.NONE,this._techniques.acquire(Sb).release()}},{key:"_renderOITPass",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Aw.U.Both,i=e===bC.HUD,r=i?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,a=i?function(){return t._renderHUDElements(n)}:function(){return t._renderTransparentMaterial()},o=this._renderContext.output;this._renderContext.output=ep.H_.Color,this._bindParameters.transparencyPassType=Tw.A.ColorAlpha;var s=this._offscreen.renderOITPass(a,Tw.A.ColorAlpha,i);this._bindParameters.transparencyPassType=Tw.A.FrontFace;var l=this._offscreen.renderOITPass(a,Tw.A.FrontFace,i);return this._offscreen.compositeOIT(this._bindParameters,s,l,r),null!==r&&void 0!==r&&r.detachDepth(),l.release(),s.release(),this._bindParameters.transparencyPassType=Tw.A.NONE,this._renderContext.output=o,r}},{key:"_renderOccluded",value:function(){var e=this,t=0;RC.clear(),this._plugins.plugins.forAll((function(e){e.materialReference&&e.queryRenderOccludedState(ev.yD.OccludeAndTransparentStencil)&&(t|=ev.yD.OccludeAndTransparentStencil,RC.push(e))}));var n=this._offscreen,i=function(i,r,a,o,s){if(t&r){var l=n.width,u=n.height,c=n.depth,h=e.fboCache.acquire(l,u,"tmp color");n.renderToTargets(a,h,c,[0,0,0,0],o,s),n.compositeToFramebuffer(e._bindParameters,h.getTexture(),mb.PremultipliedAlpha,i),h.release()}},r=function(t,n){e._bindParameters.slot=t,n.forAll((function(t){if((0,di.QA)(t)){var n=t.prepareTechnique(e._renderContext);n&&t.renderNode(e._renderContext,n)}}))};0!==RC.length&&(r(fi.r.OCCLUDER_MATERIAL,RC),i(.5,ev.yD.OccludeAndTransparentStencil,(function(){return r(fi.r.TRANSPARENT_OCCLUDER_MATERIAL,RC)}),!1,!1));var a=RC.length>0;RC.clear(),this._plugins.plugins.forAll((function(e){if(e.materialReference){var n=e.queryRenderOccludedState(ev.yD.OccludeAndTransparent),i=e.queryRenderOccludedState(ev.yD.Transparent),r=e.queryRenderOccludedState(ev.yD.Opaque);(n||i||r)&&(t|=n?ev.yD.OccludeAndTransparent:i?ev.yD.Transparent:ev.yD.Opaque,RC.push(e))}}));var o=this._plugins.renderOccludedFlags;if(t|=o){var s=function(t){e._renderContext.renderOccludedMask=t,o>ev.yD.Occlude&&e._plugins.render(e._pluginInput,fi.r.OCCLUDED_TERRAIN),r(fi.r.OPAQUE_MATERIAL,RC),r(fi.r.TRANSPARENT_MATERIAL,RC),r(fi.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,RC),e._renderContext.renderOccludedMask=Yw.C9};this._renderContext.output=ep.H_.Color,i(.5,ev.yD.OccludeAndTransparent,(function(){return s(ev.yD.OccludeAndTransparent)}),!0,Kf.hU.OutlineVisualElementMask),i(.5,ev.yD.Transparent,(function(){return s(ev.yD.Transparent)}),!0,Kf.hU.OutlineVisualElementMask),i(1,ev.yD.Opaque,(function(){return s(ev.yD.Opaque)}),!0,Kf.hU.OutlineVisualElementMask),(a||RC.length>0)&&this.performanceInfo.advance(gC.OCCLUDED),RC.clear()}}},{key:"_renderTransparentEnvironment",value:function(){this._shadowAccumulator.render(this._bindParameters),this._offscreen.bindFbo(),this._plugins.render(this._pluginInput,fi.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,fi.r.TRANSPARENT_ENVIRONMENT),this.performanceInfo.advance(gC.TRANSPARENT_ENVIRONMENT)}},{key:"_renderViewshed",value:function(){this._viewshedEnabled&&(this._viewshed.renderHighQuality=this.isFeatureEnabled(is.Y.HighResolutionViewshed),this._plugins.render(this._pluginInput,fi.r.VIEWSHED),this._pluginInput.release("normals"),this.performanceInfo.advance(gC.VIEWSHED))}},{key:"_renderPlugins",value:function(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(this._pluginInput,e),this.performanceInfo.advance(t))}},{key:"_renderNodes",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._nodes.produces(e))return n&&this.performanceInfo.advance(e),t;t.setName(e),this._pluginInput.set(e,t);var i=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),i}},{key:"_blitToDefault",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:cw,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._blit||(this._blit=new Uw(this._techniques));var i=this._blit.render(this._rctx,e,t,this._bindParameters,this._requestRender);return this._pluginInput.set(e.name,i),n&&e.release(),i}},{key:"_ensureBindParametersCamera",value:function(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}},{key:"_ensureBindParametersSSR",value:function(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Ut.Wd:((0,Nt.U_)(OC,this._bindParameters.camera.viewMatrix),(0,Nt.U_)(EC,this._bindParameters.camera.projectionMatrix),(0,Nt.Jp)(AC,OC,EC),(0,Nt.Jp)(AC,this._renderContext.lastFrameCamera.viewMatrix,AC),(0,Nt.Jp)(AC,this._renderContext.lastFrameCamera.projectionMatrix,AC),this._reprojectionMatrix=AC);var t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Ut.Wd,this._ssrEnableTime=null}},{key:"addRenderNode",value:function(e){this._nodes.add(e),this._requestRender()}},{key:"removeRenderNode",value:function(e){this._nodes.remove(e),this._requestRender()}},{key:"usedMemory",get:function(){var e,t;return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:null!==(e=null===(t=this.edgeView)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}}},{key:"_viewshedEnabled",get:function(){return this._viewshed.enabled&&this._plugins.produces(this._renderContext.output,fi.r.VIEWSHED)}},{key:"test",get:function(){}}]),e}();(0,f._)([(0,E.Cb)({readOnly:!0})],SC.prototype,"fullResolutionAtmosphere",null),(0,f._)([(0,E.Cb)()],SC.prototype,"_edgeView",void 0),(0,f._)([(0,E.Cb)()],SC.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(bC||(bC={})),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.ShadowMap=2]="ShadowMap",e[e.HudVisibility=3]="HudVisibility",e[e.ViewshedShadowMap=4]="ViewshedShadowMap"}(wC||(wC={}));var kC=[0,0,0,0],MC=[fi.r.INTEGRATED_MESH,fi.r.OPAQUE_TERRAIN,fi.r.OPAQUE_MATERIAL,fi.r.OPAQUE_NO_SSAO_DEPTH],PC=[fi.r.TRANSPARENT_MATERIAL,fi.r.TRANSPARENT_NO_SSAO_DEPTH],RC=new Fl.Z,EC=(0,Ut.Ue)(),OC=(0,Ut.Ue)(),AC=(0,Ut.Ue)();function DC(e){return function(t){return e.immediate.schedule(t)}}var ZC=function(){function e(t){(0,o.Z)(this,e),this._rctx=t,this._vao=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Tt.QI,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:vt.i,i=new Float32Array([-1,-1,3,-1,-1,3]);return new bn.U(e,n,{geometry:t},{geometry:Cn.f.createVertex(e,_t.l1.STATIC_DRAW,i)})}(t)}return(0,s.Z)(e,[{key:"destroy",value:function(){this._vao=(0,x.M2)(this._vao)}},{key:"draw",value:function(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(_t.MX.TRIANGLES,0,3))}},{key:"test",get:function(){}}]),e}();var IC=n(25580),LC=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,e,i)).gl=e,a.newCache=r,a._appleAmdDriverHelper=null,a._refCount=1,a.screen=new ZC((0,l.Z)(a)),a}return(0,s.Z)(n,[{key:"destroy",value:function(){--this._refCount>0||this.dispose()}},{key:"ref",value:function(){++this._refCount}},{key:"dispose",value:function(){var e;(0,u.Z)((0,c.Z)(n.prototype),"dispose",this).call(this),null!==(e=this._appleAmdDriverHelper)&&void 0!==e&&e.dispose(),this.screen.destroy()}},{key:"bindTechnique",value:function(e,t,n,i,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline(!!r)),e.program.bindPass(n,t),i&&e.program.bindDraw(i,t,n),e.program}},{key:"runAppleAmdDriverHelper",value:function(){var e;this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(null!==(e=this._appleAmdDriverHelper)&&void 0!==e||(this._appleAmdDriverHelper=new IC.E(this)),this._appleAmdDriverHelper.run())}},{key:"test",get:function(){}}]),n}(n(85377).x);function NC(e){return!!e.frameUpdate}var UC=n(5195),HC=n(25049),FC=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e,i,r){var a;return(0,o.Z)(this,n),(a=t.call(this,{}))._stage=e,a._techniques=i,a._rctx=r,a._textures=new Map,a._loadingCount=0,a._frameUpdates=new Map,a.events=new $.Z,a._frameTask=e.view.resourceController.scheduler.registerTask($t.T8.TEXTURE_UNLOAD),a}return(0,s.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"destroy",value:function(){this._frameTask.remove(),this._stage.forEachOfType(lg.U.Texture,(function(e){return e.unload()}))}},{key:"updating",get:function(){return this._loadingCount>0||this._frameTask.updating}},{key:"textureTechnique",get:function(){return null==this._textureTechnique&&(this._textureTechnique=this._techniques.acquire(UC.K,new HC.V)),this._textureTechnique}},{key:"acquire",value:function(e){var t,n=this._textures.get(e);return n?(n.ref(),null!==(t=n.loadingPromise)&&void 0!==t?t:n):this._createNewRef(e)}},{key:"update",value:function(){var e=!1;this._frameUpdates.forEach((function(t){var n=t.texture.frameUpdate(t.previousToken);n>=0&&n!==t.previousToken&&(t.previousToken=n,e=!0)})),e&&this.events.emit("changed",Kf.Xx.BACKGROUND)}},{key:"_createNewRef",value:function(e){var t=this,n=this._stage.getObject(e);if(null==n)return(0,En.hu)(void 0!==n),null;var i=n.events.on("unloaded",(function(){i.remove(),t._onTextureUnloaded(e)})),r=new VC(e,(function(){t._frameTask.schedule((function(){r.isUnreferenced&&n.unload()}))}));return this._textures.set(e,r),r.ref(),n.glTexture?(this._updateGLTexture(r,n.glTexture),NC(n)&&this._frameUpdates.set(e,{texture:n,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule((function(){var i=n.load(t._rctx),a=function(i){return t._loadingCount--,r.loadingPromise=null,t._updateGLTexture(r,i),NC(n)&&t._frameUpdates.set(e,{texture:n,previousToken:-1}),r};return(0,S.y8)(i)?i.then(a,(function(e){return t._loadingCount--,r.loadingPromise=null,(0,S.D_)(e)||C.Z.getLogger(t).error(e),null})):a(i)})),r.loadingPromise)}},{key:"_updateGLTexture",value:function(e,t){e.glTexture=t,this.events.emit("changed",Kf.Xx.UPDATE)}},{key:"_onTextureUnloaded",value:function(e){this._textures.delete(e),this._frameUpdates.delete(e)}}]),n}(Z.default);(0,f._)([(0,E.Cb)()],FC.prototype,"_loadingCount",void 0),(0,f._)([(0,E.Cb)()],FC.prototype,"_frameTask",void 0),(0,f._)([(0,E.Cb)()],FC.prototype,"updating",null),FC=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.lib.TextureRepository")],FC);var VC=function(){function e(t,n){(0,o.Z)(this,e),this.id=t,this._release=n,this._refCount=0}return(0,s.Z)(e,[{key:"isUnreferenced",get:function(){return 0===this._refCount}},{key:"ref",value:function(){++this._refCount}},{key:"release",value:function(){--this._refCount,this._refCount>0||(0!==this._refCount?(C.Z.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}]),e}(),zC=n(2522),qC=n(91398);var BC=n(5921),GC=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments))._passParameters=new jC,e._resourcesTask=null,e}return(0,s.Z)(n,[{key:"passParameters",get:function(){return this._passParameters}},{key:"destroy",value:function(){this._resourcesTask=(0,x.IM)(this._resourcesTask),this._passParameters.waveNormal=(0,x.M2)(this._passParameters.waveNormal),this._passParameters.wavePerturbation=(0,x.M2)(this._passParameters.wavePerturbation)}},{key:"updating",get:function(){return!!this._resourcesTask&&!this._resourcesTask.finished}},{key:"ensureResources",value:function(e){var t=this;return this._resourcesTask||(this._resourcesTask=(0,ye.vr)(function(){var n=(0,a.Z)((0,r.Z)().mark((function n(i){return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,Promise.allSettled([t._loadImageResource(e,(0,Yn.V)("esri/images/materials/water/normals.jpg"),(function(e){return t._passParameters.waveNormal=e}),i),t._loadImageResource(e,(0,Yn.V)("esri/images/materials/water/perturbation.jpg"),(function(e){return t._passParameters.wavePerturbation=e}),i)]);case 2:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())),this._resourcesTask.finished?Kf.Rw.LOADED:Kf.Rw.LOADING}},{key:"_loadImageResource",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n,i,a){var o,s;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,ib.t)(n,{signal:a});case 3:o=e.sent,(0,S.k_)(a),(s=new Yt.X(o.width,o.height)).pixelFormat=_t.VI.RGB,s.samplingMode=_t.cw.LINEAR_MIPMAP_LINEAR,s.hasMipmap=!0,s.maxAnisotropy=8,i(new xn.x(t,s,o)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),C.Z.getLogger(this).error("Failed to load water material normal texture.",e.t0);case 12:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(t,n,i,r){return e.apply(this,arguments)}}()}]),n}(Z.default);(0,f._)([(0,E.Cb)()],GC.prototype,"_resourcesTask",void 0),(0,f._)([(0,E.Cb)({type:Boolean,readOnly:!0})],GC.prototype,"updating",null),GC=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],GC);var jC=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n)}(ht.K),WC=new Map;function XC(){return WC}var QC=n(7796),YC=n(51e3),JC=(0,s.Z)((function e(t,n,i){(0,o.Z)(this,e),this.parameters=t,this.frameHasDecorations=n,this.fbos=i})),KC=function(){function e(t,n,i){(0,o.Z)(this,e),this._rctx=t,this._renderFunctions=n,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}return(0,s.Z)(e,[{key:"destroy",value:function(){this._rctx=null}},{key:"takeScreenshot",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._renderFunctions.prepareOverlay();case 2:return this._renderFunctions.requestRenderScene(Kf.Xx.BACKGROUND),n=(0,S.hh)(),e.abrupt("return",(this._screenshotQueue.push({settings:t,resolver:n}),n.promise));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(e,t){var n,r=(0,i.Z)(this._screenshotQueue);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(null!=this._rctx){var o=(0,He.Z)((0,He.Z)({},a.settings),{},{pixelRatio:a.settings.pixelRatio*e.parameters.camera.pixelRatio}),s=this._renderScreenshot(e,o,t);a.resolver(s)}else a.resolver.reject()}}catch(l){r.e(l)}finally{r.f()}this._screenshotQueue.length=0}},{key:"_renderScreenshotOverlay",value:function(e,t,n){e.width=t.width,e.height=t.height;var i=e.getContext("2d"),r=n.pixelRatio;return i.save(),i.translate(0,t.height),i.scale(1,-1),n.region&&i.translate(-n.region.x,-n.region.y),i.scale(r,r),t=this._renderFunctions.renderOverlay(e,n.disableDecorations?Kf.Iq.OFF:Kf.Iq.ON,t),i.restore(),t}},{key:"_readbackScreenshot",value:function(e,t){return e.resample?this._readbackScreenshotResampled((0,He.Z)((0,He.Z)({},e),{},{resample:e.resample}),t):this._readbackScreenshotImmediate(e,t)}},{key:"_readbackScreenshotResampled",value:function(e,t){var n=e.framebufferWidth,i=e.framebufferHeight,r=e.region,a=e.resample,o=this._ensureScreenshotEncodeCanvas(),s=(0,YC.r7)(n,i,o);this._rctx.gl.readPixels(0,0,n,i,_t.VI.RGBA,_t.g.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),t(),s=this._renderScreenshotOverlay(o,s,(0,He.Z)((0,He.Z)({},e),{},{region:void 0}));var l=(0,YC.r7)(r.width,r.height,o);return(0,QC.TT)(s,l,!0,a.region.x,i-(a.region.y+a.region.height),a.region.width,a.region.height)}},{key:"_readbackScreenshotImmediate",value:function(e,t){var n=e.framebufferHeight,i=e.region,r=this._ensureScreenshotEncodeCanvas(),a=(0,YC.r7)(i.width,i.height,r);return this._rctx.gl.readPixels(i.x,n-(i.y+i.height),i.width,i.height,_t.VI.RGBA,_t.g.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(r,a,e)}},{key:"_renderScreenshot",value:function(e,t,n){var i,r=this,a=e.parameters.camera,o={width:t.framebufferWidth,height:t.framebufferHeight};(0,Qt.d)(o,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));var s=!1,l=t.disableDecorations&&e.frameHasDecorations,u=o.width!==a.fullWidth||o.height!==a.fullHeight,c=t.ignorePadding&&a.pixelRatio!==t.pixelRatio,h=u||l||c||t.objectAndLayerIdColor,d=null,f=null;if(h){var v=a.clone();if(t.ignorePadding){for(var p=(0,st.d9)(v.padding),_=0;_<4;_++)p[_]=Math.round(p[_]/v.pixelRatio*t.pixelRatio);v.padding=p}v.fullWidth=o.width,v.fullHeight=o.height,v.pixelRatio=t.pixelRatio;var m=a.fovX-v.fovX,g=a.fovY-v.fovY;m<0&&m<g?v.fovX=a.fovX:g<0&&g<m&&(v.fovY=a.fovY);var y={camera:v,contentCamera:v,mode:rs.n.IDLE,alignPixelEnabled:!0,contentPixelRatio:v.pixelRatio};this._forceCameraHook(y),s=!0;var b=this._renderFunctions.renderScene(y,n,t.objectAndLayerIdColor?ns.YE.ObjectAndLayerID:ns.YE.Screenshot,t.disableDecorations?Kf.Iq.OFF:Kf.Iq.ON);f=b.screen,d=b.oid}this._rctx.bindFramebuffer(null===(i=f)||void 0===i?void 0:i.fbo);var w=this._readbackScreenshot(t,(function(){var e;r._rctx.bindFramebuffer(null),null===(e=f)||void 0===e||e.release()})),C=null;if(t.objectAndLayerIdColor){var x;this._rctx.bindFramebuffer(null===(x=d)||void 0===x?void 0:x.fbo),C=this._readbackScreenshot(t,(function(){var e;r._rctx.bindFramebuffer(null),null===(e=d)||void 0===e||e.release()})),this._rctx.bindFramebuffer(null)}if(h&&!this._rctx.contextAttributes.alpha)for(var T=3;T<w.data.length;T+=4)w.data[T]=255;if(C&&!this._rctx.contextAttributes.alpha)for(var S=3;S<C.data.length;S+=4)C.data[S]=255;return s&&this._forceCameraHook(e.parameters),[w,C]}},{key:"_ensureScreenshotEncodeCanvas",value:function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}]),e}(),$C=!1,ex=n(83826),tx=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;(0,o.Z)(this,n),(i=t.call(this,{})).events=new $.Z,i.waterTextures=new GC,i.objectAndLayerIdRenderHelper=(0,w.Z)("enable-feature:objectAndLayerId-rendering")?new Jb:null,i._needsUpdate=!0,i._needsRender=!0,i._idleSuspend=!0,i._needsWaterReflectionUpdate=!1,i._lastAnimationUpdate=0,i._container=e.container,i._viewingMode=e.viewingMode;try{i._initializeContext(e)}catch(ve){return(0,mg.Z)(i,void console.error("Failed to initialize context",ve))}var r=e.view.resourceController.memoryController;i.stippleTextures=(0,BC.kW)(i._rctx,r),i.markerTextures=function(e,t){return new qC.t((function(t){return(0,zC.LM)(t,e)}),(function(e){return e}),t)}(i._rctx,r),i._techniques=new Fy.M({rctx:i._rctx,viewingMode:e.viewingMode,stippleTextures:i.stippleTextures,waterTextures:i.waterTextures,markerTextures:i.markerTextures}),i._textures=new FC(e,i._techniques,i._rctx),i.addHandles(i._textures.events.on("changed",(function(e){return i.requestRender(e)}))),i._materials=new Qb.h(i._textures,i._techniques,(function(){return i.requestRender()}),(function(){return i.requestRender()})),i._compositingHelper=new kb(i._rctx,i._techniques),i.renderer=new SC(e,i._materials,i._techniques,i._rctx,i._compositingHelper,(function(e){return i.requestRender(e)})),i.addHandles([(0,k.watch)((function(){return e.view.ready}),(function(t){t&&i._createRenderNodes(e.view,e.viewingMode)}),k.initial),(0,k.watch)((function(){var e;return null===(e=i.waterTextures)||void 0===e?void 0:e.updating}),(function(){return i.requestRender()}),k.initial),(0,k.watch)((function(){return e.view.qualityProfile}),(function(e){var t;return null===(t=i.renderer)||void 0===t?void 0:t.updateRenderFeatures(e)}),k.syncAndInitial)]);var a={renderScene:function(e,t,n,r){return i.renderer.render(e,t,n,r)},requestRenderScene:function(e){return i.requestRender(e)},prepareOverlay:function(){return e.options.screenshot.prepareOverlay()},renderOverlay:function(t,n,i){return e.options.screenshot.renderOverlay(t,n,i)}};return i._screenshotManager=new KC(i._rctx,a,(function(e){return i.events.emit("force-camera-for-screenshot",e)})),i._registerFrameTask(e),i}return(0,s.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"destroy",value:function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=(0,x.hw)(this._frameTask),this._techniques=(0,x.SC)(this._techniques),this._componentObjects=(0,x.SC)(this._componentObjects),this._screenshotManager=(0,x.SC)(this._screenshotManager),(0,x.SC)(this.renderer),this._textures=(0,x.SC)(this._textures),(0,x.SC)(this.waterTextures),(0,x.SC)(this.markerTextures),(0,x.SC)(this.stippleTextures),this._canvas=null,this._container=null,this._rctx=(0,x.SC)(this._rctx)}},{key:"_createRenderNodes",value:function(e,t){var n=this;new gb.K({view:e,isEnabled:function(){return n.renderer.hasSSAO},techniques:this._techniques}),new pb({view:e,isEnabled:function(){return n.renderer.hasSMAA},techniques:this._techniques}),new sb({view:e,techniques:this._techniques}),new Qy({view:e,techniques:this._techniques}),new tb({view:e,viewingMode:t,techniques:this._techniques})}},{key:"requestRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Kf.Xx.UPDATE;this._needsRender=!0,e===Kf.Xx.UPDATE&&(this._needsUpdate=!0)}},{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}},{key:"textures",get:function(){return this._textures}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"setIdleSuspend",value:function(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"takeScreenshot",value:function(e){return this._screenshotManager.takeScreenshot(e).then((function(e){return e[0]}))}},{key:"takeScreenshotWithOID",value:function(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}},{key:"getAlpha",value:function(){return!!this._rctx.contextAttributes.alpha}},{key:"getMinimalDepthForArea",value:function(e,t,n,i,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:r,o=i.constrainWindowSize(t,n,r*i.pixelRatio,a*i.pixelRatio),s=this._ensureDepthBuffer(o);this.renderer.readDepthPixels(o,s);for(var l=Number.MAX_VALUE,u=0;u<o[2]*o[3];u++){var c=Rb(4*u,s,i.nearFar);l>c&&c!==i.nearFar[0]&&c!==i.nearFar[1]&&(l=c)}if(e){var h=e.pickDepth(t*i.pixelRatio,n*i.pixelRatio,i);null!=h&&l>h&&h!==i.nearFar[0]&&h!==i.nearFar[1]&&(l=h)}return l===Number.MAX_VALUE?void 0:l}},{key:"_ensureDepthBuffer",value:function(e){var t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}},{key:"reloadShaders",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nv(),e.next=3,this._techniques.reloadAll();case 3:this.requestRender();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_registerFrameTask",value:function(e){var t=this,n=e.view.state,i=!1,r=Kf.Xx.BACKGROUND,a=!1,o={preRender:function(a){var o=a.time;i=t.updating,r=t._needsUpdate?Kf.Xx.UPDATE:Kf.Xx.BACKGROUND,e.commitSyncLayers();var s=(0,Fn.HA)(o-t._lastAnimationUpdate);if(s>t.renderer.animationTimestep||null!=n.forcedAnimationTime||i||t._needsRender){var l=(0,Fn.HA)(s/t.renderer.animationTimeDilation),u=new ev._o(n.camera,l,n.forcedAnimationTime);t.renderer.updateAnimation(u)&&t.requestRender(Kf.Xx.BACKGROUND),t._lastAnimationUpdate=o}},render:function(e){var i=e.time;if((t._needsRender||!t._idleSuspend||!t.renderer.isCameraFinal||t._needsWaterReflectionUpdate)&&n.camera.fullWidth>0&&n.camera.fullHeight>0){var r=t._needsUpdate&&t._idleSuspend&&t.renderer.isCameraFinal;t._needsRender=!1,t._needsUpdate=!1,t._needsWaterReflectionUpdate=!1,t.renderer.render(n,i),a=!0,r&&t.renderer.hasReflections&&(t.requestRender(Kf.Xx.BACKGROUND),t._needsWaterReflectionUpdate=!0)}},update:function(e){var i=e.time,r=t.renderer.hasSlicePlane||t.renderer.hasDecorations||t.renderer.hasHighlights,a=new JC(n,r,t.renderer.fboCache);t._textures.update(),t._screenshotManager.update(a,i)},finish:function(){a&&(t.renderer.finish(n.mode===rs.n.IDLE?r:Kf.Xx.UPDATE),a=!1)}};this._frameTask=(0,M.A)(o)}},{key:"_initializeContext",value:function(e){var t,n,i=e.options;this._canvas=i.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var r={alpha:i.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null===(t=i.stencil)||void 0===t||t,powerPreference:"high-performance",preserveDrawingBuffer:null!==(n=i.preserveDrawingBuffer)&&void 0!==n&&n},a=(0,ex.k)(this._canvas,r);null!=a?(this._rctx=function(e,t){var n={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},i=function(e,n){return t.view.resourceController.memoryController.newCache(e,n)};if($C){var r=nx.get(e);return r?(r.configure(n),r.newCache=i,r.ref(),r):(r=new LC(e,n,i),nx.set(e,r),r.ref(),r)}return new LC(e,n,i)}(a,e),this._loadShaderOnlyExtensions(),!i.alpha&&this._rctx.contextAttributes.alpha&&C.Z.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&(0,w.Z)("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)):C.Z.getLogger(this).error("A WebGL2 context could not be created.")}},{key:"_loadShaderOnlyExtensions",value:function(){this._rctx.capabilities.enable("textureFloatLinear")}},{key:"getObjectAndLayerIdColor",value:function(e){return null!=this.objectAndLayerIdRenderHelper?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}},{key:"componentObjectCollection",get:function(){return null==this._componentObjects&&(this._componentObjects=new Ly(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects},set:function(e){this._componentObjects=e}}]),n}(Z.default);(0,f._)([(0,E.Cb)({type:Boolean,readOnly:!0})],tx.prototype,"updating",null),(0,f._)([(0,E.Cb)()],tx.prototype,"_rctx",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"_container",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"_canvas",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"stippleTextures",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"markerTextures",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"waterTextures",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],tx.prototype,"objectAndLayerIdRenderHelper",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"_textures",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],tx.prototype,"renderer",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"_screenshotManager",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"componentObjectCollection",null),(0,f._)([(0,E.Cb)()],tx.prototype,"_componentObjects",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"_needsUpdate",void 0),(0,f._)([(0,E.Cb)()],tx.prototype,"_needsWaterReflectionUpdate",void 0),tx=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.parts.RenderView")],tx);var nx=XC(),ix=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e))._model=new pg,i._layers=new Fl.Z,i._asyncChangeSet=new ag.as,i._syncChangeSet=new ag.as,i._layerSyncSet=new Set,i}return(0,s.Z)(n,[{key:"initialize",value:function(){this._set("renderView",new tx(this)),this._frameTask=this.view.resourceController.scheduler.registerTask($t.T8.STAGE,this),this.addHandles(this._frameTask)}},{key:"destroy",value:function(){this.renderView.destroy()}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"updating",get:function(){return this.running||this.renderView.updating||this._frameTask.updating}},{key:"renderer",get:function(){var e;return null===(e=this.renderView)||void 0===e?void 0:e.renderer}},{key:"add",value:function(e){this._model.add(e),(0,sg.e)(e)&&this._addLayer(e),this.renderView.requestRender()}},{key:"remove",value:function(e){null!=e&&!this.destroyed&&this._model.remove(e)&&((0,sg.e)(e)&&this._removeLayer(e),this.renderView.requestRender())}},{key:"addMany",value:function(e){null!=e&&(this._model.addMany(e),this.renderView.requestRender())}},{key:"removeMany",value:function(e){var t,n;null!=e&&(null!==(t=this._model)&&void 0!==t&&t.removeMany(e),null===(n=this.renderView)||void 0===n||n.requestRender())}},{key:"forEachOfType",value:function(e,t){this._model.forEachOfType(e,t)}},{key:"handleEvent",value:function(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}},{key:"running",get:function(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}},{key:"runTask",value:function(e){if(this._frameTask.processQueue(e),this._commit(e),!e.hasProgressed)return en.J}},{key:"_commit",value:function(e){var t=this,n=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((function(i){if(!e.done){var r=t._layerSyncSet.has(i.id)||i.updatePolicy===og.j.SYNC,a=r?t._syncChangeSet:t._asyncChangeSet;n.commitLayer(i.id,a),t._layerSyncSet.delete(i.id),a.empty||(t.renderer.modify(a,r?$t.G5:e),t.renderView.requestRender(),e.madeProgress())}})),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,$t.G5),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((function(i){e.done||t._layerSyncSet.has(i.id)||i.updatePolicy!==og.j.ASYNC||(n.commitLayer(i.id,t._asyncChangeSet),t._asyncChangeSet.empty||(t.renderer.modify(t._asyncChangeSet,e),t.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}},{key:"commitSyncLayers",value:function(){var e=this,t=this._model.dirtySet;this._layers.forAll((function(n){e._layerSyncSet.has(n.id)||n.updatePolicy===og.j.SYNC?(t.commitLayer(n.id,e._syncChangeSet),e._layerSyncSet.delete(n.id)):t.commitSyncUpdates(n.id,e._syncChangeSet)}));var n,r=(0,i.Z)(this._layerSyncSet);try{for(r.s();!(n=r.n()).done;){var a=n.value;t.commitLayer(a,this._syncChangeSet)}}catch(o){r.e(o)}finally{r.f()}this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,$t.G5),this.renderView.requestRender())}},{key:"_commitLayer",value:function(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,$t.G5),this.renderView.requestRender())}},{key:"schedule",value:function(e,t){return this._frameTask.schedule(e,t)}},{key:"reschedule",value:function(e,t){return this._frameTask.reschedule(e,t)}},{key:"syncLayer",value:function(e){this._layerSyncSet.add(e),this.renderView.requestRender()}},{key:"getObject",value:function(e){return this._model.getObject(e)}},{key:"layers",get:function(){return this._layers}},{key:"_addLayer",value:function(e){this._layers.includes(e)||this._layers.push(e)}},{key:"_removeLayer",value:function(e){this._commitLayer(e),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,$t.G5))}},{key:"addRenderPlugin",value:function(e,t){var n=this,i=this.renderer.plugins.add(e,t),r=function(){Sh(e)&&n.view.sceneIntersectionHelper.addIntersectionHandler(e)};if((0,S.y8)(i))return i.then(r);r()}},{key:"removeRenderPlugin",value:function(e){this.destroyed||(Sh(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}},{key:"performanceInfo",get:function(){return this._model.getStats()}},{key:"test",get:function(){}}]),n}(Z.default);ix.DebugSettings={endFrameContentValidation:!1},(0,f._)([(0,E.Cb)({constructOnly:!0})],ix.prototype,"view",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],ix.prototype,"options",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ix.prototype,"viewingMode",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],ix.prototype,"container",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ix.prototype,"updating",null),(0,f._)([(0,E.Cb)({constructOnly:!0})],ix.prototype,"_model",void 0),(0,f._)([(0,E.Cb)()],ix.prototype,"renderView",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],ix.prototype,"renderer",null),(0,f._)([(0,E.Cb)({readOnly:!0})],ix.prototype,"running",null),ix=(0,f._)([(0,A.j)("esri.views.3d.webgl-engine.Stage")],ix);var rx=n(69787),ax=n(72612),ox=n(92028),sx=n(87770),lx=n(33006),ux=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var i;return(0,o.Z)(this,n),(i=t.call(this,e)).components=["attribution","zoom","navigation-toggle","compass"],i}return(0,s.Z)(n)}(lx.Z);(0,f._)([(0,E.Cb)()],ux.prototype,"components",void 0);var cx=ux=(0,f._)([(0,A.j)("esri.views.ui.3d.DefaultUI3D")],ux),hx=function(e){(0,h.Z)(f,e);var t=(0,d.Z)(f);function f(e){var n;(0,o.Z)(this,f),(n=t.call(this,e))._userClippingArea=null,n._clippingArea=null,n._initialDefaultSpatialReference=null,n._createGraphicsViewController=null,n._resolveWhenReady=[],n._propertiesPool=new ts.L({slicePlane:G.B},(0,l.Z)(n)),n._resourceController=function(e){return new Ed({view:e})}((0,l.Z)(n)),n._defaultToMapOptions={include:new Set},n._defaultHitTestOptions={exclude:new Set},n.deconflictor=new ku({view:(0,l.Z)(n)}),n.labeler=new Pu.S({view:(0,l.Z)(n),deconflictor:n.deconflictor.labels}),n.sharedSymbolResources=null,n.analyses=new Q.J,n.basemapTerrain=null,n.elevationProvider=null,n.canvas=null,n.constraints=new Ne,n.environment=new Ke,n.environmentManager=new Ci,n.floors=new _.Z,n.fullOpacity=1,n.graphicsView=null,n.analysisViewManager=new xe({view:(0,l.Z)(n)}),n.groundView=null,n.map=null,n.screenSizePerspectiveEnabled=!0,n.state=new hh,n.spatialReference=null,n.alphaCompositingEnabled=!1,n.preserveDrawingBufferEnabled=!1,n.supersampleScreenshotsEnabled=!0,n.type="3d",n.ui=new cx,n._numUpdating=0,n._lastUpdateTime=0,n.updatingProgress=.5,n.highlightOptions=new Xh,(0,R.j2)();var i=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!=e&&e.type===T.y.MOVE||(n._updatingChanged(),n.map&&n.map.allLayers.forEach(function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.when();case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:n._updatingChanged();case 8:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()))};return n.addHandles([(0,k.on)((function(){var e;return null===(e=n.map)||void 0===e?void 0:e.allLayers}),"after-changes",(function(e){return i(e)}),{onListenerAdd:function(){return i()},onListenerRemove:function(){return i()},sync:!0}),n.allLayerViews.on("after-changes",(function(e){return n._updateUpdatingMonitors(e)})),(0,k.watch)((function(){return n.map}),(function(e){e&&"load"in e&&e.load&&e.load().catch((function(){}))}))]),n.inputManager=new Ul({view:(0,l.Z)(n)}),n.stateManager=new as({view:(0,l.Z)(n)}),n}return(0,s.Z)(f,[{key:"initialize",value:function(){var e=this;this.groundView=new se({view:this}),this._updateUpdatingMonitors();var t=function(){return e._updateDefaultToMapOptions()};this.addHandles((0,k.on)((function(){var t;return null===(t=e.map)||void 0===t?void 0:t.allLayers}),"after-changes",t,{onListenerAdd:t,onListenerRemove:t})),this.updatingHandles.add((function(){return e.qualitySettings.memoryLimit}),(function(t){e.resourceController&&(e.resourceController.memoryController.maxMemory=t)}),k.initial),this.updatingHandles.add((function(){return e.qualitySettings.additionalCacheMemory}),(function(t){e.resourceController&&(e.resourceController.memoryController.additionalCacheMemory=t)}),k.initial),this.updatingHandles.add((function(){var t;return null!==(t=e.qualitySettings.frameRate)&&void 0!==t?t:0}),(function(e){return(0,M.bP)(e>0?1e3/Math.ceil(e):0)}),k.initial),this.updatingHandles.add((function(){var t;return null===(t=e.map)||void 0===t?void 0:t.ground}),t,k.syncAndInitial),this.updatingHandles.add((function(){var t,n;return null===(t=e.map)||void 0===t||null===(n=t.ground)||void 0===n?void 0:n.opacity}),(function(){return e._updateDefaultHitTestOptions()}),k.syncAndInitial),this.addHandles((0,k.watch)((function(){return e.spatialReference}),(function(){return e.notifyChange("clippingArea")}),k.sync))}},{key:"destroy",value:function(){var e;this.destroyed||(this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=(0,x.SC)(this.sharedSymbolResources),this._set("labeler",(0,x.SC)(this.labeler)),this._set("deconflictor",(0,x.SC)(this.deconflictor)),this._resourceController=(0,x.SC)(this._resourceController),this._set("stateManager",(0,x.SC)(this.stateManager)),this._set("inputManager",(0,x.SC)(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",(0,x.SC)(this.environmentManager)),this._set("environment",(0,x.SC)(this.environment)),this.groundView=(0,x.SC)(this.groundView),this._exitBasemapTerrain(),null===(e=this._stage)||void 0===e||e.destroy())}},{key:"renderSpatialReference",get:function(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}},{key:"basemapSpatialReference",get:function(){var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.spatialReference}},{key:"animation",get:function(){var e;return null===(e=this.state)||void 0===e?void 0:e.animation}},{key:"camera",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.camera},set:function(e){this.stateManager&&(this.stateManager.camera=e)}},{key:"contentCamera",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.contentCamera},set:function(e){this.stateManager&&(this.stateManager.contentCamera=e)}},{key:"installContentCameraReset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{sticky:!1};return this.stateManager.installContentCameraReset(e)}},{key:"center",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.center},set:function(e){this.stateManager&&(this.stateManager.center=e)}},{key:"clippingArea",get:function(){if("global"===this.viewingMode)return null;var e=this.map,t=this._userClippingArea||(0,x.aF)(e,"clippingArea");return!this._userClippingArea&&!(0,x.aF)(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof Lo.Z?this.spatialReference&&null==(t=dx(t,this.spatialReference))?(C.Z.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(null==(t=t.clone()).intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(C.Z.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)},set:function(e){this.ready&&"global"===this.viewingMode&&null!=e?C.Z.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}},{key:"renderDataExtent",get:function(){if(this.state.viewingMode===he.JY.Global)return null;var e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:dx(t,e)}},{key:"tileInfo",get:function(){var e,t;return null===(e=this.basemapTerrain)||void 0===e||null===(t=e.tilingScheme)||void 0===t?void 0:t.toTileInfo()}},{key:"dataExtent",get:function(){var e=this._groundAndLayersExtent,t=this.spatialReference||ee.Z.WGS84,n=dx(this.clippingArea,t);null!=n&&(e=null!=e?e.intersection(n):n);var i=this._get("dataExtent");return null!=e&&e.equals(i)?i:e}},{key:"_groundAndLayersExtent",get:function(){var e,t,n,i=this.spatialReference||ee.Z.WGS84,r=function(e){var t=dx(e,i);null!=t&&(null!=n?n.union(t):n=t.clone())},a=this.basemapTerrain;if(null!==a&&void 0!==a&&a.spatialReference){var o=a.groundExtent;r(new Lo.Z({xmin:o[0],ymin:o[1],zmin:0,xmax:o[2],ymax:o[3],zmax:0,spatialReference:a.spatialReference}))}if(this.map){this.map.allLayers.forEach((function(e){return function(e){null==e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent)}(e)}))}if(null==n)return null;n.hasZ?(n.zmin=Math.min(0,null!==(e=n.zmin)&&void 0!==e?e:0),n.zmax=Math.max(0,null!==(t=n.zmax)&&void 0!==t?t:0)):(n.zmin=0,n.zmax=0);var s=this._get("_groundAndLayersExtent");return n.equals(s)?s:n}},{key:"castEnvironment",value:function(e){var t,n;return e?e instanceof Ke?e:e instanceof We.Z?null!==(t=null===(n=this.environment)||void 0===n?void 0:n.cloneWithWebsceneEnvironment(e))&&void 0!==t?t:Ke.fromWebsceneEnvironment(e):(0,D.se)(Ke,e):new Ke}},{key:"extent",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.extent},set:function(e){this.stateManager&&(this.stateManager.extent=e)}},{key:"screenCenter",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.screenCenter}},{key:"frustum",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.frustum}},{key:"initialExtentRequired",get:function(){return this.stateManager&&!this.stateManager.hasInitialView}},{key:"_defaultsFromMapSettings",get:function(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}},{key:"interacting",get:function(){var e,t;return this.navigating||null!==(e=null===(t=this.toolViewManager)||void 0===t?void 0:t.interacting)&&void 0!==e&&e}},{key:"stationary",get:function(){return!this.animation&&!this.resizing&&(null==this.state||this.state.stationary)}},{key:"navigating",get:function(){var e,t;return null!==(e=null===(t=this.state)||void 0===t?void 0:t.navigating)&&void 0!==e&&e}},{key:"padding",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.padding},set:function(e){this.stateManager&&(this.stateManager.padding=e)}},{key:"qualityProfile",get:function(){return this._get("qualityProfile")||Fh.getDefaultProfile()},set:function(e){Fh.isValidProfile(e)&&(Fh.apply(e,this.qualitySettings),this._set("qualityProfile",e))}},{key:"slicePlane",set:function(e){if(null!=this._stage&&this._stage.renderer.setParameters({slicePlane:e}),null!=e){var t=this._propertiesPool.get("slicePlane");(0,G.c)(e,t),this._set("slicePlane",t)}else this._set("slicePlane",null)}},{key:"typeSpecificPreconditionsReady",get:function(){var e;return!!this.viewingMode&&!(null===(e=this.stateManager)||void 0===e||!e.preinit(this.spatialReference))}},{key:"resolution",get:function(){return null!=this.spatialReference?(0,W.dp)(this.scale,this.spatialReference):0}},{key:"scale",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.scale},set:function(e){this.stateManager&&(this.stateManager.scale=e)}},{key:"terrainScale",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.terrainScale}},{key:"heightModelInfo",get:function(){var e=this.getDefaultHeightModelInfo();return null!=e?F.Z.deriveUnitFromSR(e,this.spatialReference):null}},{key:"updating",get:function(){var e,t,n,r;if(this.destroyed)return!1;var a=0,o=this.layerViewManager.updating,s=o?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((function(e){if(e.isFulfilled()){if(e.updating){if(o=!0,e.suspended||(0,Bf.wP)(e))return;++s,a+=e.updatingProgress}}else++s}));var l,u=(0,i.Z)(this._updatingObjects);try{for(u.s();!(l=u.n()).done;){var c=l.value;if(null!=c&&c.updating){s+=.1,a+=.05}}}catch(m){u.e(m)}finally{u.f()}var h,d=(0,i.Z)(this._updatingObjectsWithProgress);try{for(d.s();!(h=d.n()).done;){var f=h.value;null!=f&&f.updating&&(++s,a+=f.updatingProgress)}}catch(m){d.e(m)}finally{d.f()}var v=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(o=!!(o||s>0||this.updatingHandles.updating||!this.ready||!this.stationary||v||this._createGraphicsViewController||null!==(e=this.inputManager)&&void 0!==e&&e.updating||null!==(t=this.map)&&void 0!==t&&null!==(n=t.allLayers)&&void 0!==n&&n.some((function(e){return!e.isFulfilled()}))||null!==(r=this.textures)&&void 0!==r&&r.updating),o?(this._numUpdating=Math.max(s,this._numUpdating),a+=this._numUpdating-s):this._numUpdating=0,this._numUpdating>0?a/=this._numUpdating:a=o?0:1,this._get("updatingProgress")!==a){var p=performance.now();if(a<1){var _=Math.min((p-this._lastUpdateTime)/2e3,1);a=this.updatingProgress*(1-_)+a*_}this._set("updatingProgress",a),this._lastUpdateTime=o&&a<1?p:0}return o}},{key:"_updatingObjects",get:function(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}},{key:"_updatingObjectsWithProgress",get:function(){return[this.deconflictor,this.labeler,this.basemapTerrain]}},{key:"viewingMode",get:function(){var e,t=this._predeterminedViewingMode;if(null!=t)return(0,he.M7)(t);var n=this.spatialReference;return n?null!=(null===(e=this.defaultsFromMap)||void 0===e?void 0:e.viewingMode)&&n.equals(this.defaultsFromMap.spatialReference)?(0,he.M7)(this.defaultsFromMap.viewingMode):(0,ox.D)(n,he.JY.Global)?"global":"local":"global"},set:function(e){this.ready?C.Z.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}},{key:"viewpoint",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.viewpoint},set:function(e){this.stateManager&&(this.stateManager.viewpoint=e)}},{key:"zoom",get:function(){return this.stateManager.zoom},set:function(e){this.stateManager&&(this.stateManager.zoom=e)}},{key:"resourceController",get:function(){return this._resourceController}},{key:"quality",get:function(){var e,t,n;return null!==(e=null===(t=this._resourceController)||void 0===t||null===(n=t.memoryController)||void 0===n?void 0:n.memoryFactor)&&void 0!==e?e:1}},{key:"resolutionScale",get:function(){return Math.sqrt(Math.min(1,this.quality/.75))}},{key:"performanceInfo",get:function(){return new Zd(this)}},{key:"on",value:function(e,t,n,i){return this.viewEvents.on(e,t,n,i)||(0,u.Z)((0,c.Z)(f.prototype),"on",this).call(this,e,t)}},{key:"hasEventListener",value:function(e){return(0,u.Z)((0,c.Z)(f.prototype),"hasEventListener",this).call(this,e)||this.viewEvents.hasHandler(e)}},{key:"toMap",value:function(e,t){if(!this.ready)return C.Z.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;var n=(0,ax.Rw)(e)?(0,ax.s6)(this,e):e;return(0,_h.qL)(this,n,t,this._defaultToMapOptions)}},{key:"toScreen",value:function(e){var t;if(!this.ready)return C.Z.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;var n=null!==(t=null==e.z?(0,Vh.KO)(this.elevationProvider,e):null)&&void 0!==t?t:0;return(0,q.K)(e,fx,this.renderSpatialReference,n),this.state.camera.projectToScreen(fx,vx),(0,P.vW)(vx[0],vx[1])}},{key:"pixelSizeAt",value:function(e){return this.ready?e?((0,q.K)(e,fx,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(fx)):0:(C.Z.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}},{key:"overlayPixelSizeInMapUnits",value:function(e){var t=this,n=this.basemapTerrain.overlayManager;return n?n.overlayPixelSizeInMapUnits(e,(function(){return t.pixelSizeAt(e)})):1}},{key:"hitTest",value:function(e,t){if(!this.ready)return C.Z.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;var n=(0,ax.Rw)(e)?(0,ax.s6)(this,e):e;return(0,_h.wX)(this,n,t,this._defaultHitTestOptions)}},{key:"popupHitTest",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",td(this,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"goTo",value:function(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}},{key:"whenAnalysisView",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.parent){e.next=2;break}throw new g.Z("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});case 2:e.t0=t.parent.type,e.next="line-of-sight"===e.t0||"dimension"===e.t0?5:8;break;case 5:return e.next=7,this.whenLayerView(t.parent);case 7:return e.abrupt("return",e.sent.whenAnalysisView());case 8:return e.abrupt("return",this.analysisViewManager.whenAnalysisView(t));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"whenLayerView",value:function(e){return(0,u.Z)((0,c.Z)(f.prototype),"whenLayerView",this).call(this,e)}},{key:"takeScreenshot",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n,i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._completeSettings(t),e.next=3,this.whenReady();case 3:return e.next=5,this._stage.renderView.takeScreenshot(n);case 5:return i=e.sent,e.abrupt("return",(0,QC.cv)(i,n,this._pixelFormat()));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_takeScreenshot",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n,i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._completeSettings(t),e.next=3,this.whenReady();case 3:return e.next=5,this._stage.renderView.takeScreenshot(n);case 5:return i=e.sent,e.abrupt("return",(0,QC.v8)(i,this._pixelFormat()));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_takeScreenshotWithObjectAndLayerId",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n,i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._completeSettings(t),e.next=3,this.whenReady();case 3:return e.next=5,this._stage.renderView.takeScreenshotWithOID(n);case 5:return i=e.sent,e.abrupt("return",[(0,QC.v8)(i[0],this._pixelFormat()),(0,QC.v8)(i[1],this._pixelFormat())]);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_completeSettings",value:function(e){var t=(0,QC.uz)(e,this);return t.pixelRatio/=this.state.pixelRatio,(0,QC.$3)(t,this.supersampleScreenshotsEnabled,this.padding)}},{key:"_pixelFormat",value:function(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}},{key:"test",get:function(){}},{key:"takeScreenshotWithObjectAndLayerId",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var n,i,a,o;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,w.Z)("enable-feature:objectAndLayerId-rendering")){e.next=2;break}throw new Error("has enable-feature:objectAndLayerId-rendering must be true");case 2:return n=this._completeSettings(t),e.next=5,this.whenReady();case 5:return e.next=7,this._stage.renderView.takeScreenshotWithOID(n);case 7:return i=e.sent,a=(0,QC.cv)(i[0],n,this._pixelFormat()),(o=this._completeSettings(t)).format="png",e.abrupt("return",[a,(0,QC.cv)(i[1],o,this._pixelFormat())]);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getColorToObjectAndLayerIdMapping",value:function(){if(null==this._stage.renderView.objectAndLayerIdRenderHelper)throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}},{key:"addUpdatingPromise",value:function(e){return this.updatingHandles.addPromise(e)}},{key:"importLayerView",value:function(e){return ge(e)}},{key:"hasLayerViewModule",value:function(e){return me(e)}},{key:"forceDOMReadyCycle",value:function(){this.forceReadyCycle()}},{key:"getDefaultSpatialReference",value:function(){var e,t,n;return this.map&&"initialViewProperties"in this.map&&(null===(e=this.map.initialViewProperties)||void 0===e?void 0:e.spatialReference)||(null===(t=this.defaultsFromMap)||void 0===t?void 0:t.spatialReference)||(null===(n=this.defaultsFromMap)||void 0===n?void 0:n.ready)&&this._initialDefaultSpatialReference||null}},{key:"validate",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){var t,n;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,sx.B)(this.type),(n=(0,w.Z)("safari"))&&n<9&&(t=new g.Z("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:n})),null==t){e.next=4;break}throw C.Z.getLogger(this).warn("#validate()",t.message),t;case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_predeterminedViewingMode",get:function(){var e,t,n=this._isOverridden("viewingMode")?this._get("viewingMode"):null!==(e=this.map&&"initialViewProperties"in this.map?null===(t=this.map.initialViewProperties)||void 0===t?void 0:t.viewingMode:null)&&void 0!==e?e:null;return null!=n?(0,he.wg)(n):null}},{key:"getSpatialReferenceSupport",value:function(e,t){var n=this._predeterminedViewingMode;if(null!=n)return this._validateSpatialReferenceForViewingMode(e,t,n)?{constraints:this._makeSpatialReferenceConstraints(e,t,n)}:null;var i=this._validateSpatialReferenceForViewingMode(e,t,he.JY.Local),r=this._validateSpatialReferenceForViewingMode(e,t,he.JY.Global);return i||r?i&&r?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:i?{constraints:this._makeSpatialReferenceConstraints(e,t,he.JY.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,he.JY.Global)}:null}},{key:"_validateSpatialReferenceForViewingMode",value:function(e,t,n){return!!(0,ox.D)(e,n)&&(null==t||!!(0,X.Am)(t)||(!(0,X.iC)(t)||null!=(0,Bf.E_)(t,e,n))&&(!(0,X.Tv)(t)||n!==he.JY.Global))}},{key:"_makeSpatialReferenceConstraints",value:function(e,t,n){if(null==t)return[{spatialReference:e,viewingMode:n}];var i=e.isWebMercator,r=e.isWGS84;return(0,X.Am)(t)&&(i||r)?r&&n!==he.JY.Local&&null!==(0,Bf.er)(t.tileInfo,t.fullExtent,e,he.JY.Global)?[{spatialReference:i?ee.Z.WGS84:ee.Z.WebMercator,viewingMode:n}]:[{spatialReference:e,viewingMode:n},{spatialReference:ee.Z.WebMercator,viewingMode:n}]:(0,X.iC)(t)||(0,X.Tv)(t)||!i&&!r?(0,X.iC)(t)&&i&&n!==he.JY.Global?[{spatialReference:e,viewingMode:n},{spatialReference:ee.Z.WGS84,viewingMode:he.JY.Local}]:[{spatialReference:e,viewingMode:n}]:[{spatialReference:e,viewingMode:n},{spatialReference:i?ee.Z.WGS84:ee.Z.WebMercator,viewingMode:n}]}},{key:"_validateSpatialReference",value:function(e){var t=null!=this.getSpatialReferenceSupport(e),n=this._predeterminedViewingMode;return t||(null!=n?C.Z.getLogger(this).warnOnce("Spatial reference defined on view not supported in ".concat((0,he.M7)(n)," viewing mode.")):e.isGeographic&&C.Z.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}},{key:"whenReady",value:function(){var e=this;return new Promise((function(t){e.ready?t(e):e._resolveWhenReady.push(t)}))}},{key:"trackGraphicState",value:function(e){if(!e.graphic)return C.Z.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;var t=this.getViewForGraphic(e.graphic),n=null,i=!1,r=function(t){var r;!i&&null!=t&&"processor"in t&&"graphics-3d"===(null===(r=t.processor)||void 0===r?void 0:r.type)&&t.processor.graphicsCore&&(n=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?r(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((function(e){return r(e)}),(function(){})).catch((function(){})),(0,b.kB)((function(){i=!0,null!=n&&(n.remove(),n=null)}))}},{key:"highlight",value:function(e){var t=this;if(Array.isArray(e))return(0,b.AL)(e.map((function(e){return t.highlight(e)})));if(_.Z.isCollection(e))return(0,b.AL)(e.toArray().map((function(e){return t.highlight(e)})));var n=this.getViewForGraphic(e);return n&&"highlight"in n?n.highlight(e):(0,b.kB)()}},{key:"maskOccludee",value:function(e){if(!e)return C.Z.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;var t=this.getViewForGraphic(e),n=null,i=!1,r=function(t){!i&&null!=t&&(0,rx._1)(t)&&(n=t.maskOccludee(e))};return null!=t?r(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((function(e){return r(e)}),(function(){})).catch((function(){})),(0,b.kB)((function(){i=!0,null!=n&&(n.remove(),n=null)}))}},{key:"getViewForGraphic",value:function(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((function(t){return t.layer===e.layer})):null}},{key:"graphicChanged",value:function(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}},{key:"whenViewForGraphic",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n){var i=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.layer!==this){e.next=4;break}return e.next=3,(0,k.whenOnce)((function(){return i.graphicsView}));case 3:return e.abrupt("return",this.graphicsView);case 4:if(t.layer&&this.map){e.next=6;break}throw new g.Z("no-view-for-graphic");case 6:return e.abrupt("return",n&&n.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise((function(e,n){var r=i.map.allLayers.on("change",(function(a){a.added.includes(t.layer)&&(r.remove(),i.whenLayerView(t.layer).then(e,n))}))})):this.whenLayerView(t.layer));case 7:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_initBasemapTerrain",value:function(){this._set("basemapTerrain",new jm({view:this})),this._set("elevationProvider",new Oh({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}},{key:"_exitBasemapTerrain",value:function(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}},{key:"_initGlobe",value:function(){var e=this;this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Mf({view:this})),this._set("featureTiles",new ah({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));var t=function(){var t,n=null===(t=e.basemapTerrain)||void 0===t?void 0:t.extent;if(e.clippingArea||n)if(n&&e.basemapTerrain.spatialReference){var i=null!=e.basemapTerrain.extent&&null!=e.basemapTerrain.spatialReference?(0,V.project)((0,B.HH)(e.basemapTerrain.extent,e.basemapTerrain.spatialReference),e.spatialReference):null;null!=e.clippingArea?e.featureTiles.filterExtent=e.clippingArea.intersection(i):e.featureTiles.filterExtent=i}else e.featureTiles.filterExtent=e.clippingArea;else e.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((function(){return Vl.h.FEATURE_TILE_TREE_SHOW_TILES}),(function(t){t&&e.featureTiles&&!e._featureTreeDebugger?e.updatingHandles.addPromise(n.e(76077).then(n.bind(n,76077))).then((function(t){var n=t.FeatureTileTree3DDebugger;!e._featureTreeDebugger&&Vl.h.FEATURE_TILE_TREE_SHOW_TILES&&(e._featureTreeDebugger=new n({view:e}))})):t||!e._featureTreeDebugger||Vl.h.FEATURE_TILE_TREE_SHOW_TILES||(e._featureTreeDebugger.destroy(),e._featureTreeDebugger=null)}),k.syncAndInitial),this.updatingHandles.add((function(){return e.clippingArea}),t,k.syncAndInitial),this.updatingHandles.add((function(){return e.basemapTerrain.extent}),t,k.syncAndInitial)],"feature-tiles"),this.stateManager.init()}},{key:"_exitGlobe",value:function(){this.state&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}},{key:"_initCoordinateSystem",value:function(){var e=this;if(this.spatialReference){var t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new Kh(this.map,t));var n=this.state.isGlobal,i=(0,j.E2)(n,t);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",fd.Z.create(this.state.viewingMode,i)),n||this.addHandles((0,k.watch)((function(){var t;return null===(t=e.basemapTerrain)||void 0===t?void 0:t.extent}),(function(t){var n=e.renderCoordsHelper.spatialReference;null==t||0===t[0]&&0===t[1]&&0===t[2]&&0===t[3]||!(0,z.d)(t,e.basemapTerrain.spatialReference,px,n)||(e.renderCoordsHelper.extent=px)}),k.sync),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(ea.jb/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}},{key:"_exitCoordinateSystem",value:function(){this.mapCoordsHelper&&(this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}},{key:"_updatingChanged",value:function(){this.notifyChange("updating")}},{key:"_updateUpdatingMonitors",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!=t&&t.type===T.y.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((function(t){t.destroyed||(e.addHandles((0,k.watch)((function(){return[t.updating,t.updatingProgress]}),(function(){return e._updatingChanged()}),k.sync),"updatingMonitors"),t.when((function(){return e._updatingChanged()}),(function(){return e._updatingChanged()})))})),this._updatingChanged())}},{key:"_prepareScreenshotOverlay",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.overlay,!e.t0){e.next=4;break}return e.next=4,this.overlay.prepare();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_renderScreenshotOverlay",value:function(e,t,n){if(!this.overlay||!this.overlay.hasVisibleItems)return n;var i=e.getContext("2d");return i.putImageData(n,0,0),this.overlay.renderCanvas(e,{disableDecorations:t===Kf.Iq.OFF}),i.getImageData(0,0,n.width,n.height)}},{key:"_initStage",value:function(){var e=this,t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:function(){return e._prepareScreenshotOverlay()},renderOverlay:function(t,n,i){return e._renderScreenshotOverlay(t,n,i)}}},n=new yh(this.state.viewingMode,(function(t){return e._stage.layers.forAll(t)}),this);this._set("sceneIntersectionHelper",n);var i=(0,m.L7)(this.surface);this._stage=new ix({view:this,options:t,container:i}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.addHandles([this.updatingHandles.add((function(){return e.qualitySettings.highQualityTransparency}),(function(t){return e._stage.renderer.setParameters({highQualityTransparency:t})}),k.initial),this.on("pointer-move",(function(){var t;return null===(t=e._stage)||void 0===t?void 0:t.renderer.resetAnimation()})),(0,y.on)(this._stage.renderView.canvas,"webglcontextlost",(function(t){e.fatalError=new g.Z("webgl-context-lost",t.statusMessage)}))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(ea.jb/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}},{key:"_exitStage",value:function(){this._set("sceneIntersectionHelper",null),this._stage=(0,x.SC)(this._stage),this.removeHandles("stage"),this._set("canvas",null)}},{key:"_initSurface",value:function(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Xd({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}},{key:"_exitSurface",value:function(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}},{key:"_createGraphicsViewIfNeeded",value:function(){var e=this;if(!this.graphicsView&&!this._createGraphicsViewController&&0!==this.graphics.length){this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;var t=function(){e._createGraphicsViewController=null,e._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this._updatingChanged()}}},{key:"_createGraphicsViewAsync",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var i,a=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([n.e(50489),n.e(80143),n.e(73364)]).then(n.bind(n,73364));case 2:return i=e.sent.default,(0,S.k_)(t),e.next=6,(0,k.whenOnce)((function(){var e;return null===(e=a.basemapTerrain)||void 0===e?void 0:e.ready}),t);case 6:this._set("graphicsView",new i({view:this}));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_disposeGraphicsView",value:function(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),null!=this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}},{key:"_startup",value:function(){var e=this,t=(0,he.wg)(this.viewingMode);t===he.JY.Global&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.addHandles((0,k.on)((function(){return e.graphics}),"after-changes",(function(){return e._createGraphicsViewIfNeeded()})),"graphics-view"),this._createGraphicsViewIfNeeded();var n=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties:null,i=null===n||void 0===n?void 0:n.environment;i&&N(this.environment,i),this.timeExtent=null===n||void 0===n?void 0:n.timeExtent,this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new qd(this._stage,this.resourceController.scheduler));var r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach((function(t){return t(e)}))}},{key:"_teardown",value:function(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",(0,x.SC)(this.textures)),this._exitSurface(),this._set("ready",!1)}},{key:"_updateDefaultToMapOptions",value:function(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(ya.xX);var e,t=(0,i.Z)(this.map.allLayers.items);try{for(t.s();!(e=t.n()).done;){var n=e.value;(0,X.nx)(n.type)&&this._defaultToMapOptions.include.add(n.uid)}}catch(r){t.e(r)}finally{t.f()}}}},{key:"_updateDefaultHitTestOptions",value:function(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(ya.xX);var e,t=(0,i.Z)(this.map.allLayers.items);try{for(t.s();!(e=t.n()).done;){var n=e.value;(0,X.nx)(n.type)&&n.opacity<1&&this._defaultHitTestOptions.exclude.add(n.uid)}}catch(r){t.e(r)}finally{t.f()}}}}]),f}((0,Y.g)((0,le.u)((0,J.f)(ue.Z))));function dx(e,t){return null!=e&&(0,V.canProjectWithoutEngine)(e.spatialReference,t)?(0,V.project)(e,t):null}hx.type="3d",(0,f._)([(0,E.Cb)()],hx.prototype,"_userClippingArea",void 0),(0,f._)([(0,E.Cb)()],hx.prototype,"_resourceController",void 0),(0,f._)([(0,E.Cb)()],hx.prototype,"_stage",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"deconflictor",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"labeler",void 0),(0,f._)([(0,E.Cb)((0,H.z)(Q.J,"analyses"))],hx.prototype,"analyses",void 0),(0,f._)([(0,E.Cb)({type:ce.Z,readOnly:!0})],hx.prototype,"animation",null),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"basemapTerrain",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"elevationProvider",void 0),(0,f._)([(0,E.Cb)()],hx.prototype,"camera",null),(0,f._)([(0,E.Cb)({type:v.Z})],hx.prototype,"contentCamera",null),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"canvas",void 0),(0,f._)([(0,E.Cb)({type:No.Z})],hx.prototype,"center",null),(0,f._)([(0,E.Cb)({type:Lo.Z})],hx.prototype,"clippingArea",null),(0,f._)([(0,E.Cb)({type:Ne})],hx.prototype,"constraints",void 0),(0,f._)([(0,E.Cb)({type:Lo.Z,readOnly:!0})],hx.prototype,"renderDataExtent",null),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"tileInfo",null),(0,f._)([(0,E.Cb)({type:Lo.Z,readOnly:!0})],hx.prototype,"dataExtent",null),(0,f._)([(0,E.Cb)({type:Lo.Z,readOnly:!0})],hx.prototype,"_groundAndLayersExtent",null),(0,f._)([(0,E.Cb)({type:Ke})],hx.prototype,"environment",void 0),(0,f._)([(0,O.p)("environment")],hx.prototype,"castEnvironment",null),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"environmentManager",void 0),(0,f._)([(0,E.Cb)({type:Lo.Z})],hx.prototype,"extent",null),(0,f._)([(0,E.Cb)()],hx.prototype,"floors",void 0),(0,f._)([(0,E.Cb)()],hx.prototype,"screenCenter",null),(0,f._)([(0,E.Cb)()],hx.prototype,"frustum",null),(0,f._)([(0,E.Cb)({type:Number,readOnly:!0})],hx.prototype,"fullOpacity",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"graphicsView",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"analysisViewManager",void 0),(0,f._)([(0,E.Cb)()],hx.prototype,"groundView",void 0),(0,f._)([(0,E.Cb)({type:Boolean})],hx.prototype,"initialExtentRequired",null),(0,f._)([(0,E.Cb)()],hx.prototype,"_defaultsFromMapSettings",null),(0,f._)([(0,E.Cb)()],hx.prototype,"interacting",null),(0,f._)([(0,E.Cb)()],hx.prototype,"stationary",null),(0,f._)([(0,E.Cb)()],hx.prototype,"navigating",null),(0,f._)([(0,E.Cb)()],hx.prototype,"map",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"mapCoordsHelper",void 0),(0,f._)([(0,E.Cb)()],hx.prototype,"padding",null),(0,f._)([(0,E.Cb)({type:Mf,readOnly:!0})],hx.prototype,"pointsOfInterest",void 0),(0,f._)([(0,E.Cb)({type:ah,readOnly:!0})],hx.prototype,"featureTiles",void 0),(0,f._)([(0,E.Cb)()],hx.prototype,"_featureTreeDebugger",void 0),(0,f._)([(0,E.Cb)({type:Boolean})],hx.prototype,"screenSizePerspectiveEnabled",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],hx.prototype,"deactivatedWebGLExtensions",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],hx.prototype,"debugWebGLExtensions",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],hx.prototype,"renderCanvas",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],hx.prototype,"state",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"inputManager",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"stateManager",void 0),(0,f._)([(0,E.Cb)({type:["low","medium","high"]})],hx.prototype,"qualityProfile",null),(0,f._)([(0,E.Cb)({type:dd,get:function(){var e=this._get("qualitySettings");return e||(e=new dd,Fh.apply(this.qualityProfile,e)),e}})],hx.prototype,"qualitySettings",void 0),(0,f._)([(0,E.Cb)()],hx.prototype,"slicePlane",null),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"typeSpecificPreconditionsReady",null),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"renderCoordsHelper",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"sceneIntersectionHelper",void 0),(0,f._)([(0,E.Cb)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],hx.prototype,"resolution",null),(0,f._)([(0,E.Cb)({type:Number})],hx.prototype,"scale",null),(0,f._)([(0,E.Cb)()],hx.prototype,"heightModelInfo",null),(0,f._)([(0,E.Cb)()],hx.prototype,"spatialReference",void 0),(0,f._)([(0,E.Cb)({type:Boolean,constructOnly:!0})],hx.prototype,"alphaCompositingEnabled",void 0),(0,f._)([(0,E.Cb)({constructOnly:!0})],hx.prototype,"preserveDrawingBufferEnabled",void 0),(0,f._)([(0,E.Cb)({type:Boolean})],hx.prototype,"supersampleScreenshotsEnabled",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"type",void 0),(0,f._)([(0,E.Cb)(),(0,O.p)((function(e){return e instanceof lx.Z?e:(0,D.TJ)(cx,e)}))],hx.prototype,"ui",void 0),(0,f._)([(0,E.Cb)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],hx.prototype,"updating",null),(0,f._)([(0,E.Cb)()],hx.prototype,"_updatingObjects",null),(0,f._)([(0,E.Cb)()],hx.prototype,"_updatingObjectsWithProgress",null),(0,f._)([(0,E.Cb)({type:Number,readOnly:!0,dependsOn:["updating"]})],hx.prototype,"updatingProgress",void 0),(0,f._)([(0,E.Cb)({type:["global","local"]})],hx.prototype,"viewingMode",null),(0,f._)([(0,E.Cb)({type:p.Z})],hx.prototype,"viewpoint",null),(0,f._)([(0,E.Cb)({type:Number})],hx.prototype,"zoom",null),(0,f._)([(0,E.Cb)({type:Xh})],hx.prototype,"highlightOptions",void 0),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"quality",null),(0,f._)([(0,E.Cb)({readOnly:!0})],hx.prototype,"resolutionScale",null),(0,f._)([(0,E.Cb)()],hx.prototype,"textures",void 0),hx=(0,f._)([(0,A.j)("esri.views.SceneView")],hx);var fx=(0,U.Ue)(),vx=(0,P.s1)(),px=(0,B.Ue)(),_x=hx},4583:function(e,t,n){n.d(t,{e:function(){return s}});var i=n(74165),r=n(15861),a=n(66978),o=n(38330);function s(e){return l.apply(this,arguments)}function l(){return l=(0,r.Z)((0,i.Z)().mark((function e(t){var r,s,l,u,c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.e(83581).then(n.bind(n,83581)),s=n.e(78938).then(n.bind(n,78938)),e.t0=o.t,e.next=5,r;case 5:return e.t1=e.sent.default,e.t2={signal:t},l=(0,e.t0)(e.t1,e.t2),e.t3=o.t,e.next=11,s;case 11:return e.t4=e.sent.default,e.t5={signal:t},u=(0,e.t3)(e.t4,e.t5),e.next=16,l;case 16:return e.t6=e.sent,e.next=19,u;case 19:return e.t7=e.sent,c={mask:e.t6,overlay:e.t7},e.abrupt("return",((0,a.k_)(t),c));case 22:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}},78738:function(e,t,n){n.d(t,{J:function(){return a}});var i=n(15671),r=n(43144),a=function(){function e(t){(0,i.Z)(this,e),this._gain=t,this.lastValue=void 0,this.filteredDelta=void 0}return(0,r.Z)(e,[{key:"update",value:function(e){if(this.hasLastValue()){var t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}},{key:"reset",value:function(){this.lastValue=void 0,this.filteredDelta=void 0}},{key:"hasLastValue",value:function(){return void 0!==this.lastValue}},{key:"hasFilteredDelta",value:function(){return void 0!==this.filteredDelta}},{key:"computeDelta",value:function(e){return void 0===this.lastValue?NaN:e-this.lastValue}},{key:"_updateDelta",value:function(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}]),e}()},99742:function(e,t,n){n.d(t,{X:function(){return a}});var i=n(15671),r=n(43144),a=function(){function e(t,n,r){(0,i.Z)(this,e),this._initialVelocity=t,this._stopVelocity=n,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}return(0,r.Z)(e,[{key:"duration",get:function(){return this._duration}},{key:"isFinished",value:function(e){return e>this.duration}},{key:"friction",get:function(){return this._friction}},{key:"value",value:function(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}},{key:"valueDelta",value:function(e,t){var n=this.value(e);return this.value(e+t)-n}},{key:"valueFromInitialVelocity",value:function(e,t){t=Math.min(t,this.duration);var n=1-this.friction;return e*(Math.pow(n,t)-1)/Math.log(n)}}]),e}()},82332:function(e,t,n){n.d(t,{s:function(){return l}});var i=n(15671),r=n(43144),a=n(16889),o=n(78738),s=n(99742),l=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;(0,i.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=n,this._friction=r,this._maxVelocity=a,this.enabled=!0,this.value=new o.J(.8),this.time=new o.J(.3)}return(0,r.Z)(e,[{key:"add",value:function(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){var n=this.value.computeDelta(e);this.value.filteredDelta*n<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}},{key:"reset",value:function(){this.value.reset(),this.time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;var e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,a.uZ)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,n){return new s.X(e,t,n)}}]),e}()},87022:function(e,t,n){n.d(t,{G:function(){return f}});var i=n(15671),r=n(43144),a=n(88301),o=n(61120),s=n(60136),l=n(29388),u=n(32035),c=n(12400),h=n(78738),d=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,r,a,o,s){var l;return(0,i.Z)(this,n),(l=t.call(this,e,r,a))._sceneVelocity=o,l.direction=s,l}return(0,r.Z)(n,[{key:"value",value:function(e){return(0,a.Z)((0,o.Z)(n.prototype),"valueFromInitialVelocity",this).call(this,this._sceneVelocity,e)}}]),n}(n(99742).X),f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;(0,i.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=n,this._friction=r,this.enabled=!0,this._time=new h.J(.6),this._screen=[new h.J(.4),new h.J(.4)],this._scene=[new h.J(.6),new h.J(.6),new h.J(.6)],this._tmpDirection=(0,c.Ue)()}return(0,r.Z)(e,[{key:"add",value:function(e,t,n){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(n)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(n)}}},{key:"reset",value:function(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;var e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,n=null==e||null==t?0:Math.sqrt(e*e+t*t),i=this._time.filteredDelta,r=null==i||null==n?0:n/i;return Math.abs(r)<this._minimumInitialVelocity?null:this.createMomentum(r,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,n){var i,r,a;(0,u.s)(this._tmpDirection,null!==(i=this._scene[0].filteredDelta)&&void 0!==i?i:0,null!==(r=this._scene[1].filteredDelta)&&void 0!==r?r:0,null!==(a=this._scene[2].filteredDelta)&&void 0!==a?a:0);var o=(0,u.l)(this._tmpDirection);o>0&&(0,u.j)(this._tmpDirection,this._tmpDirection,1/o);var s=this._time.filteredDelta;return new d(e,t,n,null==s?0:o/s,this._tmpDirection)}}]),e}()},19475:function(e,t,n){n.d(t,{y:function(){return u}});var i=n(15671),r=n(43144),a=n(88301),o=n(61120),s=n(60136),l=n(29388),u=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return(0,i.Z)(this,n),t.call(this,e,r,a,o)}return(0,r.Z)(n,[{key:"add",value:function(e,t){var i=this.value.lastValue;if(null!=i){for(var r=e-i;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;e=i+r}(0,a.Z)((0,o.Z)(n.prototype),"add",this).call(this,e,t)}}]),n}(n(82332).s)},62124:function(e,t,n){n.d(t,{D:function(){return d}});var i=n(15671),r=n(43144),a=n(88301),o=n(61120),s=n(60136),l=n(29388),u=n(99742),c=n(82332),h=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,r,a){return(0,i.Z)(this,n),t.call(this,e,r,a)}return(0,r.Z)(n,[{key:"value",value:function(e){var t=(0,a.Z)((0,o.Z)(n.prototype),"value",this).call(this,e);return Math.exp(t)}},{key:"valueDelta",value:function(e,t){var i=(0,a.Z)((0,o.Z)(n.prototype),"value",this).call(this,e),r=(0,a.Z)((0,o.Z)(n.prototype),"value",this).call(this,e+t)-i;return Math.exp(r)}}]),n}(u.X),d=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return(0,i.Z)(this,n),t.call(this,e,r,a,o)}return(0,r.Z)(n,[{key:"add",value:function(e,t){(0,a.Z)((0,o.Z)(n.prototype),"add",this).call(this,Math.log(e),t)}},{key:"createMomentum",value:function(e,t,n){return new h(e,t,n)}}]),n}(c.s)},4914:function(e,t,n){n.d(t,{Cr:function(){return C},FN:function(){return b},KY:function(){return y},Sx:function(){return d},Uy:function(){return v},Z1:function(){return p},_e:function(){return m},qj:function(){return w},un:function(){return g},xI:function(){return _}});var i,r=n(37762),a=n(47898),o=n(68860),s=n(32035),l=n(12400),u=n(5986),c=n(92975),h=n(25003);function d(e){return f(e,i.Horizontal)}function f(e,t){var n=e.hasZ,s=e.spatialReference,l=(0,h.m)(s),u=0,c=(0,o.j5)(l);if(null==c)return null;var d,f=t===i.Direct?b:w,v=(0,r.Z)(e.paths);try{for(v.s();!(d=v.n()).done;){var p=d.value;if(!(p.length<2))for(var _=p.length-1,m=0;m<_;++m){var g=p[m];T[0]=g[0],T[1]=g[1],T[2]=n?g[2]:0;var y=p[m+1];S[0]=y[0],S[1]=y[1],S[2]=n?y[2]:0;var C=f(T,S,s);if(null==C)return null;u+=C.value}}}catch(x){v.e(x)}finally{v.f()}return(0,a.yG)(u,c)}function v(e,t){var n=e.spatialReference;return(0,c.fS)(n,t.spatialReference)?(T[0]=e.x,T[1]=e.y,T[2]=e.hasZ?e.z:0,S[0]=t.x,S[1]=t.y,S[2]=t.hasZ?t.z:0,function(e,t,n){var i=x(e,t,n);return null!=i?{direct:(0,a.yG)(i.direct,i.unit),horizontal:(0,a.yG)(i.horizontal,i.unit),vertical:(0,a.yG)(i.vertical,i.unit)}:null}(T,S,n)):null}function p(e,t){var n=e.spatialReference;return(0,c.fS)(n,t.spatialReference)?(T[0]=e.x,T[1]=e.y,T[2]=e.hasZ?e.z:0,S[0]=t.x,S[1]=t.y,S[2]=t.hasZ?t.z:0,b(T,S,n)):null}function _(e,t){var n=e.spatialReference;return(0,c.fS)(n,t.spatialReference)?(T[0]=e.x,T[1]=e.y,T[2]=e.hasZ?e.z:0,S[0]=t.x,S[1]=t.y,S[2]=t.hasZ?t.z:0,w(T,S,n)):null}function m(e,t){var n=e.spatialReference;return(0,c.fS)(n,t.spatialReference)?(T[0]=e.x,T[1]=e.y,T[2]=e.hasZ?e.z:0,S[0]=t.x,S[1]=t.y,S[2]=t.hasZ?t.z:0,C(T,S,n)):null}function g(e){return null!=e?y(e.hasZ?e.z:0,e.spatialReference):null}function y(e,t){var n=(0,o.y)(t);return null!=n?(0,a.yG)(null!==e&&void 0!==e?e:0,n):null}function b(e,t,n){var r=x(e,t,n,i.Direct);return null!=r?(0,a.yG)(r.direct,r.unit):null}function w(e,t,n){var r=x(e,t,n,i.Horizontal);return null!=r?(0,a.yG)(r.horizontal,r.unit):null}function C(e,t,n){var r=x(e,t,n,i.Vertical);return null!=r?(0,a.yG)(r.verticalSigned,r.unit):null}function x(e,t,n,r){var a=(0,h.m)(n),l=(0,o.j5)(a);if(null==l)return null;var c=t[2]-e[2];if(r===i.Vertical)return{verticalSigned:c,unit:l};if(!(0,u.S)(e,n,k,a)||!(0,u.S)(t,n,M,a))return null;if(r===i.Direct)return{direct:(0,s.p)(M,k),unit:l};if((0,s.s)(P,e[0],e[1],t[2]),!(0,u.S)(P,n,P,a))return null;var d=(0,s.p)(P,M);return r===i.Horizontal?{horizontal:d,unit:l}:{direct:(0,s.p)(M,k),horizontal:d,vertical:Math.abs(c),unit:l}}!function(e){e[e.Direct=0]="Direct",e[e.Horizontal=1]="Horizontal",e[e.Vertical=2]="Vertical"}(i||(i={}));var T=(0,l.Ue)(),S=(0,l.Ue)(),k=(0,l.Ue)(),M=(0,l.Ue)(),P=(0,l.Ue)()},74923:function(e,t,n){n.d(t,{HV:function(){return c},ZV:function(){return a},qm:function(){return u}});var i=n(74165),r=n(15861);function a(e,t){return o.apply(this,arguments)}function o(){return o=(0,r.Z)((0,i.Z)().mark((function e(t,n){var r,a,o,l,u;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("2d"!==t.type){e.next=2;break}return e.abrupt("return",t.hitTest(n));case 2:return e.next=4,t.hitTest(n);case 4:if(0!==(a=e.sent).results.length){e.next=7;break}return e.abrupt("return",a);case 7:return o=a.results[0],l=(null!==(r=o.distance)&&void 0!==r?r:0)*(1+s),u=a.results.findIndex((function(e){var t;return(null!==(t=e.distance)&&void 0!==t?t:0)>l})),e.abrupt("return",(-1!==u&&(a.results=a.results.slice(0,u)),o&&a.ground.distance>l&&(a.ground.mapPoint=null),a));case 9:case"end":return e.stop()}}),e)}))),o.apply(this,arguments)}var s=.05;function l(e){return"graphic"===(null===e||void 0===e?void 0:e.type)}function u(e){var t;return null!==(t=e.find(l))&&void 0!==t?t:null}function c(e){return e.filter(l)}},69787:function(e,t,n){function i(e){return e&&"function"==typeof e.highlight}function r(e){return e&&"function"==typeof e.maskOccludee}function a(e,t,n){return null==e||e>=n&&(0===t||e<=t)}function o(e,t){if(t&&e){var n=e.minScale,i=e.maxScale;if(s(n,i))return a(t,n,i)}return!0}function s(e,t){return null!=e&&e>0||null!=t&&t>0}function l(e){return!(null!==e&&void 0!==e&&e.minScale)||!e.maxScale||e.minScale>=e.maxScale}function u(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatures"in e&&"layer"in e&&"view"in e}n.d(t,{Av:function(){return s},Cy:function(){return l},GB:function(){return o},Xi:function(){return u},_1:function(){return r},rs:function(){return a},tl:function(){return i}})},25003:function(e,t,n){n.d(t,{m:function(){return o}});var i=n(83448),r=n(29691),a=n(92975);function o(e){return(0,a.N$)(e)?(0,a.oR)(e)||(0,a.sS)(e)||(0,a.yW)(e)||(0,i.fY)(e)?r.wY:e:(0,r.rS)(e)}},92028:function(e,t,n){n.d(t,{D:function(){return a}});var i=n(72619),r=n(50951);function a(e,t){return null!=e&&(null==t||(t===r.JY.Local?!e.isGeographic||e.isWGS84||e.wkid===i.W.CGCS2000:e.isWebMercator||e.isWGS84||e.wkid===i.W.CGCS2000||e.wkid===i.W.GCSMARS2000||e.wkid===i.W.GCSMARS2000_SPHERE||e.wkid===i.W.GCSMOON2000))}},21147:function(e,t,n){n.d(t,{Z:function(){return S}});var i=n(15671),r=n(43144),a=n(60136),o=n(29388),s=n(27366),l=n(46784),u=n(84652),c=n(32718),h=n(49861),d=(n(93169),n(69912)),f=n(3389),v=n(50902),p=n(23548),_=n(18814),m=n(67808),g=n(2581),y=n(13910),b={base:g.Z,key:"type",typeMap:{color:y.Z}};var w,C={types:b,json:{read:function(e){return function(t,n,i){if(!t)return t;for(var r in e.typeMap)if(t.type===r){var a=new e.typeMap[r];return a.read(t,i),a}}}(b),write:{overridePolicy:function(e,t,n){return{enabled:!(null!==n&&void 0!==n&&n.isPresentation)}}}}},x=function(e,t,n){return{enabled:!(null!==n&&void 0!==n&&n.isPresentation)}},T=w=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).lighting=new _.Z,r.background=null,r.atmosphereEnabled=!0,r.starsEnabled=!0,r}return(0,r.Z)(n,[{key:"weather",set:function(e){(0,v.b8)(null===e||void 0===e?void 0:e.type,c.Z.getLogger(this))&&this._set("weather",e)}},{key:"clone",value:function(){return new w(this.cloneConstructProperties())}},{key:"cloneConstructProperties",value:function(){return{lighting:this.lighting&&"virtual"===this.lighting.type?m.Z.prototype.clone.call(this.lighting):_.Z.prototype.clone.call(this.lighting),background:(0,u.d9)(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}}]),n}(l.wq);(0,s._)([(0,h.Cb)({types:p.j,nonNullable:!0,json:{write:!0}})],T.prototype,"lighting",void 0),(0,s._)([(0,h.Cb)(C)],T.prototype,"background",void 0),(0,s._)([(0,h.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:x}}})],T.prototype,"atmosphereEnabled",void 0),(0,s._)([(0,h.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:x}}})],T.prototype,"starsEnabled",void 0),(0,s._)([(0,h.Cb)({types:v.Hr,nonNullable:!0,json:{write:!0},value:new f.Z})],T.prototype,"weather",null);var S=T=w=(0,s._)([(0,d.j)("esri.webscene.Environment")],T)},18814:function(e,t,n){n.d(t,{Z:function(){return p}});var i,r=n(15671),a=n(43144),o=n(60136),s=n(29388),l=n(27366),u=n(46784),c=n(49861),h=(n(93169),n(32718),n(84936),n(38511)),d=n(69912),f=n(31201),v=i=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e)).type="sun",i.date=null,i.directShadowsEnabled=!1,i.displayUTCOffset=null,i}return(0,a.Z)(n,[{key:"readDate",value:function(e,t){return null!=t.datetime&&new Date(t.datetime)||null}},{key:"writeDate",value:function(e,t,n){t[n]=e.getTime()}},{key:"readDirectShadowsEnabled",value:function(e,t){return!!t.directShadows}},{key:"writedirectShadowsEnabled",value:function(e,t,n){e&&(t[n]=e)}},{key:"writeDisplayUTCOffset",value:function(e,t){null!=e&&(t.displayUTCOffset=e)}},{key:"clone",value:function(){return new i(this.cloneConstructProperties())}},{key:"cloneConstructProperties",value:function(){var e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}}]),n}(u.wq);(0,l._)([(0,c.Cb)({readOnly:!0,type:["sun"],json:{write:!0}})],v.prototype,"type",void 0),(0,l._)([(0,c.Cb)({type:Date,json:{type:Number,write:{target:"datetime"}}})],v.prototype,"date",void 0),(0,l._)([(0,h.r)("date",["datetime"])],v.prototype,"readDate",null),(0,l._)([(0,f.c)("date")],v.prototype,"writeDate",null),(0,l._)([(0,c.Cb)({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],v.prototype,"directShadowsEnabled",void 0),(0,l._)([(0,h.r)("directShadowsEnabled",["directShadows"])],v.prototype,"readDirectShadowsEnabled",null),(0,l._)([(0,f.c)("directShadowsEnabled")],v.prototype,"writedirectShadowsEnabled",null),(0,l._)([(0,c.Cb)({type:Number,json:{write:!0}})],v.prototype,"displayUTCOffset",void 0),(0,l._)([(0,f.c)("displayUTCOffset")],v.prototype,"writeDisplayUTCOffset",null);var p=v=i=(0,l._)([(0,d.j)("esri.webscene.SunLighting")],v)},67808:function(e,t,n){n.d(t,{Z:function(){return f}});var i,r=n(15671),a=n(43144),o=n(60136),s=n(29388),l=n(27366),u=n(46784),c=n(49861),h=(n(93169),n(32718),n(84936),n(69912)),d=i=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e)).type="virtual",i.directShadowsEnabled=!1,i}return(0,a.Z)(n,[{key:"clone",value:function(){return new i(this.cloneConstructProperties())}},{key:"cloneConstructProperties",value:function(){return{directShadowsEnabled:this.directShadowsEnabled}}}]),n}(u.wq);(0,l._)([(0,c.Cb)({readOnly:!0,type:["virtual"],json:{write:!0}})],d.prototype,"type",void 0),(0,l._)([(0,c.Cb)({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],d.prototype,"directShadowsEnabled",void 0);var f=d=i=(0,l._)([(0,h.j)("esri.webscene.VirtualLighting")],d)},2581:function(e,t,n){n.d(t,{Z:function(){return d}});var i=n(15671),r=n(43144),a=n(60136),o=n(29388),s=n(27366),l=n(46784),u=n(49861),c=(n(93169),n(32718),n(84936),n(69912)),h=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){return(0,i.Z)(this,n),t.call(this,e)}return(0,r.Z)(n,[{key:"clone",value:function(){throw new Error("Subclasses of Background should implement their own clone method.")}}]),n}(l.wq);(0,s._)([(0,u.Cb)({readOnly:!0,json:{read:!1}})],h.prototype,"type",void 0);var d=h=(0,s._)([(0,c.j)("esri.webscene.background.Background")],h)},13910:function(e,t,n){n.d(t,{Z:function(){return g}});var i,r=n(15671),a=n(43144),o=n(60136),s=n(29388),l=n(1413),u=n(27366),c=n(51995),h=n(49861),d=(n(93169),n(32718),n(84936),n(27135)),f=n(69912),v=n(70271),p=n(2581),_=(0,l.Z)((0,l.Z)({},v.a),{},{nonNullable:!0}),m=i=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e)).type="color",i.color=new c.Z([0,0,0,1]),i}return(0,a.Z)(n,[{key:"clone",value:function(){return new i(this.cloneProperties())}},{key:"cloneProperties",value:function(){return{color:this.color.clone()}}}]),n}(p.Z);(0,u._)([(0,d.J)({color:"color"},{readOnly:!0})],m.prototype,"type",void 0),(0,u._)([(0,h.Cb)(_)],m.prototype,"color",void 0);var g=m=i=(0,u._)([(0,f.j)("esri.webscene.background.ColorBackground")],m)},23548:function(e,t,n){n.d(t,{j:function(){return a}});var i=n(18814),r=n(67808),a={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:i.Z,virtual:r.Z}}}}]);
//# sourceMappingURL=94638.0d25396e.chunk.js.map