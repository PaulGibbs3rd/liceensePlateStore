"use strict";(self.webpackChunkreact_training=self.webpackChunkreact_training||[]).push([[51941],{7872:function(e,t,n){n.d(t,{P:function(){return M},a:function(){return E},b:function(){return U},c:function(){return L},g:function(){return H}});var r,i,a,o,u,s,l,d=n(30168),c=n(15671),h=n(43144),f=n(60136),p=n(29388),v=n(16889),_=n(29134),g=n(7025),y=n(13611),m=n(6644),b=n(32035),k=n(12400),x=n(41414),S=n(37081),w=n(33280),P=n(137),C=n(78980),Z=n(22527),N=n(82999),A=n(86471),I=n(98634),z=n(76028),R=n(8654),O=n(64201),F=n(4760),M=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(){var e;return(0,c.Z)(this,n),(e=t.apply(this,arguments)).clipBox=(0,x.Ue)(x.gy),e.useFixedSizes=!1,e.useRealWorldSymbolSizes=!1,e.scaleFactor=1,e.minSizePx=0,e.size=0,e.sizePx=0,e}return(0,h.Z)(n,[{key:"fixedSize",get:function(){return this.drawScreenSpace?this.sizePx:this.size}},{key:"screenMinSize",get:function(){return this.useFixedSizes?0:this.minSizePx}},{key:"drawScreenSpace",get:function(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}]),n}(I.K),E=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e,r,i){var a;return(0,c.Z)(this,n),(a=t.call(this,e)).origin=e,a.isLeaf=r,a.splatSize=i,a}return(0,h.Z)(n)}(w.UT);function L(e){var t=new O.kG,n=e.output===S.H_.Color,c=e.output===S.H_.Highlight,h=t.vertex,f=t.fragment;return t.include(w.f5,e),t.attributes.add(F.T.POSITION,"vec3"),t.attributes.add(F.T.COLOR,"vec3"),h.uniforms.add(new z.K("modelView",(function(e,t){return(0,_.Jp)(V,t.camera.viewMatrix,(0,_.vc)(V,e.origin))})),new R.g("proj",(function(e,t){return t.camera.projectionMatrix})),new Z.q("screenMinMaxSize",(function(e,t,n){return(0,y.t8)(D,n.useFixedSizes?0:n.minSizePx*t.camera.pixelRatio,H(e.isLeaf)*t.camera.pixelRatio)})),e.useFixedSizes?new N.A("pointScale",(function(e,t){return(0,y.t8)(D,e.fixedSize*t.camera.pixelRatio,t.camera.fullHeight)})):new Z.q("pointScale",(function(e,t,n){return(0,y.t8)(D,e.splatSize*n.scaleFactor*t.camera.pixelRatio,t.camera.fullHeight/t.camera.pixelRatio)}))),e.clippingEnabled?h.uniforms.add(new A.B("clipMin",(function(e,t,n){return(0,b.s)(q,n.clipBox[0]-e.origin[0],n.clipBox[1]-e.origin[1],n.clipBox[2]-e.origin[2])})),new A.B("clipMax",(function(e,t,n){return(0,b.s)(q,n.clipBox[3]-e.origin[0],n.clipBox[4]-e.origin[1],n.clipBox[5]-e.origin[2])}))):(h.constants.add("clipMin","vec3",[-v.F3,-v.F3,-v.F3]),h.constants.add("clipMax","vec3",[v.F3,v.F3,v.F3])),n&&t.varyings.add("vColor","vec3"),h.code.add((0,I.H)(r||(r=(0,d.Z)(["\n    void main(void) {\n      // Move clipped points outside of clipspace\n      if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||\n        position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {\n        gl_Position = vec4(0.0,0.0,0.0,2.0);\n        gl_PointSize = 0.0;\n        return;\n      }\n\n      if (rejectBySlice(position)) {\n        gl_Position = vec4(0.0,0.0,0.0,2.0);\n        gl_PointSize = 0.0;\n        return;\n      }\n\n      // Position in camera space\n      vec4 camera = modelView * vec4(position, 1.0);\n\n      float pointSize = pointScale.x;\n      vec4 position = proj * camera;\n     ","\n\n     gl_PointSize = clampedScreenSize;\n     gl_Position = position;\n\n     ","\n    }\n  "])),e.drawScreenSize?(0,I.H)(i||(i=(0,d.Z)(["\n      float clampedScreenSize = pointSize;"]))):(0,I.H)(a||(a=(0,d.Z)(["\n      float pointRadius = 0.5 * pointSize;\n      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);\n      vec4 positionOffset = proj * cameraOffset;\n      float radius = abs(positionOffset.y - position.y);\n      float viewHeight = pointScale.y;\n      // screen diameter = (2 * r / w) * (h / 2)\n      float screenPointSize = (radius / position.w) * viewHeight;\n      float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);\n      // Shift towards camera, to move rendered point out of terrain i.e. to\n      // the camera-facing end of the virtual point when considering it as a\n      // 3D sphere.\n      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;\n      position = proj * camera;"]))),n?(0,I.H)(o||(o=(0,d.Z)(["vColor = color;"]))):"")),f.include(C.n,e),c&&t.include(P.bA,e),f.code.add((0,I.H)(u||(u=(0,d.Z)(["\n    void main(void) {\n        vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);\n        float r2 = dot(vOffset, vOffset);\n\n        if (r2 > 0.25) {\n          discard;\n        }\n        ","\n        ","\n    }\n  "])),c?(0,I.H)(s||(s=(0,d.Z)(["outputHighlight();"]))):"",n?(0,I.H)(l||(l=(0,d.Z)(["fragColor = vec4(vColor, 1.0);"]))):"")),t}function H(e){return e?256:64}var V=(0,g.Ue)(),q=(0,k.Ue)(),D=(0,m.Ue)(),U=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:E,PointRendererPassParameters:M,build:L,getMaxPointSizeScreenspace:H},Symbol.toStringTag,{value:"Module"}))},46798:function(e,t,n){n.d(t,{q:function(){return h}});var r=n(37762),i=n(1413),a=n(15671),o=n(43144),u=n(63780),s=n(42537),l=n(32718),d=n(66978),c=n(70431),h=function(){function e(t,n,o,u){var s=this,d=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};(0,a.Z)(this,e),this._mainMethod=n,this._transferLists=o,this._listeners=[],this._promise=(0,c.bA)(t,(0,i.Z)((0,i.Z)({},d),{},{schedule:u})).then((function(e){if(void 0===s._thread){s._thread=e,s._promise=null,d.hasInitialize&&s.broadcast({},"initialize");var t,n=(0,r.Z)(s._listeners);try{for(n.s();!(t=n.n()).done;){var i=t.value;s._connectListener(i)}}catch(a){n.e(a)}finally{n.f()}}else e.close()})),this._promise.catch((function(e){return l.Z.getLogger("esri.core.workers.WorkerHandle").error("Failed to initialize ".concat(t," worker: ").concat(e))}))}return(0,o.Z)(e,[{key:"on",value:function(e,t){var n=this,r={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(r),this._connectListener(r),(0,s.kB)((function(){r.removed=!0,(0,u.Od)(n._listeners,r),n._thread&&null!=r.threadHandle&&r.threadHandle.remove()}))}},{key:"destroy",value:function(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}},{key:"invoke",value:function(e,t){return this.invokeMethod(this._mainMethod,e,t)}},{key:"invokeMethod",value:function(e,t,n){var r=this;if(this._thread){var i=this._transferLists[e],a=i?i(t):[];return this._thread.invoke(e,t,{transferList:a,signal:n})}return this._promise?this._promise.then((function(){return(0,d.k_)(n),r.invokeMethod(e,t,n)})):Promise.reject(null)}},{key:"broadcast",value:function(e,t){var n=this;return this._thread?Promise.all(this._thread.broadcast(t,e)).then((function(){})):this._promise?this._promise.then((function(){return n.broadcast(e,t)})):Promise.reject()}},{key:"promise",get:function(){return this._promise}},{key:"_connectListener",value:function(e){this._thread&&this._thread.on(e.eventName,e.callback).then((function(t){e.removed||(e.threadHandle=t)}))}}]),e}()},42069:function(e,t,n){n.d(t,{A:function(){return y}});var r=n(74165),i=n(15861),a=n(15671),o=n(43144),u=n(88301),s=n(61120),l=n(60136),d=n(29388),c=n(27366),h=n(42537),f=n(66978),p=n(94172),v=n(49861),_=(n(93169),n(32718),n(84936),n(69912)),g=n(5354),y=function(e){var t=function(e){(0,l.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).slicePlaneEnabled=!1,e.supportsHeightUnitConversion=!1,e}return(0,o.Z)(n,[{key:"postscript",value:function(){(0,u.Z)((0,s.Z)(n.prototype),"postscript",this).call(this),(0,g.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}},{key:"_validateHeightModelInfo",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(){var t,n,i,a=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new AbortController,n=t.signal,this.addHandles((0,h.kB)((function(){return t.abort()}))),e.next=4,(0,p.whenOnce)((function(){var e;return null===(e=a.view.defaultsFromMap)||void 0===e?void 0:e.heightModelInfoReady}),n);case 4:if((0,f.k_)(n),!(i=(0,g.Wt)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion))){e.next=8;break}throw i;case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),n}(e);return(0,c._)([(0,v.Cb)()],t.prototype,"view",void 0),(0,c._)([(0,v.Cb)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,c._)([(0,_.j)("esri.views.3d.layers.LayerView3D")],t)}},51941:function(e,t,n){n.r(t),n.d(t,{default:function(){return nt}});var r=n(1413),i=n(29439),a=n(74165),o=n(15861),u=n(93433),s=n(37762),l=n(15671),d=n(43144),c=n(88301),h=n(61120),f=n(60136),p=n(29388),v=n(27366),_=n(63780),g=n(14921),y=n(80987),m=n(42537),b=(n(93169),n(32718)),k=n(92026),x=n(66978),S=n(94172),w=n(17842),P=n(18722),C=n(49861),Z=n(69912),N=n(32035),A=n(93311),I=n(41414),z=n(55652),R=n(9114),O=n(52175),F=(n(64538),n(56754),n(30539),n(37270)),M=n(41388),E=n(74509),L=n(42069),H=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e,r,i,a,o){var u;return(0,l.Z)(this,n),(u=t.call(this,e,r,-1,i,a)).queue=o,u}return(0,d.Z)(n)}(n(20488).W),V=(0,d.Z)((function e(t,n,r,i){(0,l.Z)(this,e),this.loading=t,this.indexLoading=n,this.processing=r,this.idleProcessing=i})),q=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){return(0,l.Z)(this,n),t.call(this,"PointCloudWorker","transform",{transform:function(e){return function(e){var t=[e.geometryBuffer];if(null!=e.primaryAttributeData&&e.primaryAttributeData.buffer&&t.push(e.primaryAttributeData.buffer),null!=e.modulationAttributeData&&e.modulationAttributeData.buffer&&t.push(e.modulationAttributeData.buffer),null!=e.filterAttributesData){var n,r=(0,s.Z)(e.filterAttributesData);try{for(r.s();!(n=r.n()).done;){var i=n.value;null!=i&&i.buffer&&t.push(i.buffer)}}catch(l){r.e(l)}finally{r.f()}}var a,o=(0,s.Z)(e.userAttributesData);try{for(o.s();!(a=o.n()).done;){var u=a.value;u.buffer&&t.push(u.buffer)}}catch(l){o.e(l)}finally{o.f()}return t}(e)}},e)}return(0,d.Z)(n)}(n(46798).q);var D=n(44011);var U=[!1],T=[null],B=[!1],W=[null];function Q(e,t,n){for(var r=e;r>0;){var i=t.indexOf(r);if(i>=0)return i;r=n.getParentId(r)}return t.indexOf(r)}function G(e,t,n){for(var r=[t.remove[0]],i=[];1===r.length;){var a=r.pop();i.length=0;for(var o=0;o<t.load.length;o++){for(var u=t.load[o],s=n.getParentId(u);s!==a;)u=s,s=n.getParentId(u);var l=r.indexOf(u);l<0&&(l=r.length,r.push(u),i.push([])),i[l].push(t.load[o])}}t.load=r;for(var d=0;d<r.length;d++)i[d].length>1?e.push({remove:[r[d]],load:i[d]}):r[d]=i[d][0]}var j=n(29691),J=function(){function e(t,n,r){(0,l.Z)(this,e),this._pages=[],this.pageSize=0,this._nodeSR=t,this._renderSR=n,this._renderSRSphericalPCPF=(0,j.rS)(n),this.pageSize=r}return(0,d.Z)(e,[{key:"addPage",value:function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._pages.length<e;)this._pages.push(null);X(t,this._nodeSR,this._renderSR,n,this._renderSRSphericalPCPF),this._pages[e]={nodes:t,parents:new Uint32Array(this.pageSize)},K(this._pages,this.pageSize)}},{key:"hasPage",value:function(e){return!!this._pages[e]}},{key:"getNode",value:function(e){var t=this.pageSize;return this._pages[Y(e,t)].nodes[$(e,t)]}},{key:"getRenderObb",value:function(e){var t=this.pageSize;return this._pages[Y(e,t)].nodes[$(e,t)].obbInRenderSR}},{key:"setRenderObb",value:function(e,t){var n=this.pageSize;this._pages[Y(e,n)].nodes[$(e,n)].obbInRenderSR.copy(t)}},{key:"getParentId",value:function(e){var t=this.pageSize;return this._pages[Y(e,t)].parents[$(e,t)]}},{key:"hasNodes",value:function(e,t){for(var n=Y(e,this.pageSize),r=Y(e+t-1,this.pageSize),i=n;i<=r;i++)if(null==this._pages[i])return!1;return!0}},{key:"forEachNodeId",value:function(e){for(var t=0;t<this._pages.length;t++){var n=this._pages[t];if(n)for(var r=0;r<n.nodes.length;r++)e(t*this.pageSize+r)}}},{key:"createVisibilityTraverse",value:function(){var e={index:this,queue:[],masks:[],tempAabb:(0,I.Ue)()};return function(t,n){return function(e,t,n){var r=e.index;if(!r.hasNodes(0,1))return;var i=e.queue;i.length=0,i.push(0);var a=e.masks;for(a.length=0,a.push(0);i.length>0;){var o=i.pop(),u=a.pop(),s=r.getNode(o),l=r.getRenderObb(o),d=!0;if(null!=t.clippingBox){var c=1<<t.frustum.length;u&c||(l.toAaBoundingBox(e.tempAabb),(0,I.r3)(t.clippingBox,e.tempAabb)?u|=c:(0,I.kK)(t.clippingBox,e.tempAabb)||(d=!1))}for(var h=0;h<t.frustum.length&&d;h++){var f=1<<h;if(!(u&f)){var p=l.intersectPlane(t.frustum[h]);p>0?d=!1:p<0&&(u|=f)}}if(n.predicate(o,s,d)){for(var v=s.firstChild,_=s.childCount,g=!1,y=Y(v,r.pageSize),m=Y(v+_-1,r.pageSize),b=y;b<=m;b++)if(!r.hasPage(b)){n.pageMiss(o,b),g=!0;break}if(!g)for(var k=0;k<_;k++)i.push(v+k),a.push(u)}}}(e,t,n)}}}]),e}();function X(e,t,n,r,i){for(var a=0;a<e.length;a++){var o=e[a];o.obb.transform(o.obbInRenderSR,t,n,r,i)}}function K(e,t){for(var n=[0];n.length;)for(var r=n.pop(),i=e[Y(r,t)].nodes[$(r,t)],a=0;a<i.childCount;a++){var o=i.firstChild+a;null!=e[Y(o,t)]&&(e[Y(o,t)].parents[$(o,t)]=r,n.push(o))}}function Y(e,t){return e/t|0}function $(e,t){return e%t}function ee(e){var t,n=e.renderer,r=null===n||void 0===n?void 0:n.type,i=null!==(t=null===n||void 0===n?void 0:n.toJSON())&&void 0!==t?t:null,a=null,o=!1,u=e.attributeStorageInfo;"point-cloud-unique-value"===r||"point-cloud-stretch"===r||"point-cloud-class-breaks"===r?a=ie(u,n.field):"point-cloud-rgb"===r?o=null!=(a=re(u,n.field)):o=null!=(a=re(u,"RGB"));var s=null;return null!==n&&void 0!==n&&n.colorModulation&&(s=ie(u,n.colorModulation.field)),{rendererJSON:i,isRGBRenderer:o,primaryAttribute:a,modulationAttribute:s}}function te(e){var t=e.filters;return t?t.map((function(t){return{filterJSON:t.toJSON(),attributeInfo:ie(e.attributeStorageInfo,t.field)}})):[]}function ne(e){var t=null===e||void 0===e?void 0:e.pointSizeAlgorithm;return t&&"fixed-size"===t.type?t:null}function re(e,t){var n,r=(0,s.Z)(null!==e&&void 0!==e?e:[]);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.name===t&&null!=i.attributeValues&&"UInt8"===i.attributeValues.valueType&&3===i.attributeValues.valuesPerElement)return{name:t,storageInfo:i,useElevation:!1}}}catch(a){r.e(a)}finally{r.f()}return null}function ie(e,t){var n,r=(0,s.Z)(null!==e&&void 0!==e?e:[]);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.name===t){var a="embedded-elevation"===i.encoding;return a?{name:t,storageInfo:null,useElevation:a}:{name:t,storageInfo:i,useElevation:a}}}}catch(o){r.e(o)}finally{r.f()}return"elevation"===(null===t||void 0===t?void 0:t.toLowerCase())?{name:t,storageInfo:null,useElevation:!0}:null}var ae=n(74432),oe=n(52639),ue=(n(84936),function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,l.Z)(this,n),(r=t.call(this,e)).pointCloudMetadata=null,r}return(0,d.Z)(n)}(oe.Z));(0,v._)([(0,C.Cb)({constructOnly:!0,clonable:"reference"})],ue.prototype,"pointCloudMetadata",void 0),ue=(0,v._)([(0,Z.j)("esri.views.3d.layers.i3s.PointGraphic")],ue);var se=n(27546),le=n(12400),de=n(19093),ce=n(40885),he=n(85312),fe=n(68401),pe=n(47669),ve=function(){function e(t){(0,l.Z)(this,e),this._context=t,this._highlights=new Set}return(0,d.Z)(e,[{key:"empty",get:function(){return 0===this._highlights.size}},{key:"destroy",value:function(){this._highlights=null}},{key:"add",value:function(e){var t=this,n=new _e(e);return this._highlights.add(n),this._enableSet(n),(0,m.kB)((function(){return t._removeSet(n)}))}},{key:"_removeSet",value:function(e){this._disableSet(e),this._highlights.delete(e)}},{key:"_enableSet",value:function(e){var t=this;e.enabled||(e.enabled=!0,this._context.forEachNode((function(n){return t._enableSetForNode(e,n)})))}},{key:"_enableSetForNode",value:function(e,t){var n=this;if(e.enabled){var r=e.ids.get(t.id);r&&r.forEach((function(r){return n._context.addHighlight(t,r,e.id)}))}}},{key:"_disableSet",value:function(e){var t=this;e.enabled&&(e.enabled=!1,this._context.forEachNode((function(n){return t._disableSetForNode(e,n)})))}},{key:"_disableSetForNode",value:function(e,t){e.enabled||this._context.removeHighlight(t,e.id)}},{key:"nodeAdded",value:function(e){var t=this;this._highlights.forEach((function(n){return t._enableSetForNode(n,e)}))}},{key:"nodeRemoved",value:function(e){var t=this;this._highlights.forEach((function(n){return t._disableSetForNode(n,e)}))}},{key:"removeAll",value:function(){var e=this;this._highlights.forEach((function(t){return e._disableSet(t)}))}}]),e}(),_e=function(){function e(t){(0,l.Z)(this,e),this.id=new pe.O(fe.V_.Highlight),this.ids=new Map,this.enabled=!1;var n,r=(0,s.Z)(t);try{for(r.s();!(n=r.n()).done;){var i=n.value;null!=i&&this._add(i.nodeId,i.pointId)}}catch(a){r.e(a)}finally{r.f()}}return(0,d.Z)(e,[{key:"_add",value:function(e,t){var n=this.ids.get(e);n?n.add(t):this.ids.set(e,new Set([t]))}}]),e}(),ge=n(37081),ye=n(70374),me=n(7566),be=n(88153),ke=n(54463),xe=n(93822),Se=n(80658),we=n(4760),Pe=n(7872),Ce=n(82144),Ze=n(31132),Ne=n(27627),Ae=n(50411),Ie=n(8548),ze=n(36207),Re=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e,r,i){return(0,l.Z)(this,n),t.call(this,e,r,i)}return(0,d.Z)(n,[{key:"initializeProgram",value:function(e){return new Ne.$(e.rctx,n.shader.get().build(this.configuration),me.i)}},{key:"initializePipeline",value:function(){return(0,ze.sm)({depthTest:{func:Ie.wb.LESS},depthWrite:ze.LZ,colorWrite:ze.BK,stencilWrite:this.configuration.hasOccludees?Ae.s3:null,stencilTest:this.configuration.hasOccludees?Ae.RY:null,drawBuffers:this.configuration.output===ge.H_.Depth?{buffers:[Ie.Xg.NONE]}:null})}}]),n}(Ze.A);Re.shader=new Ce.J(Pe.b,(function(){return n.e(83655).then(n.bind(n,83655))}));var Oe=n(33559),Fe=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(){var e;return(0,l.Z)(this,n),(e=t.apply(this,arguments)).output=ge.H_.Color,e.hasSlicePlane=!1,e.drawScreenSize=!1,e.useFixedSizes=!1,e.hasOccludees=!1,e.clippingEnabled=!1,e}return(0,d.Z)(n)}(n(8883).W);(0,v._)([(0,Oe.o)({count:ge.H_.COUNT})],Fe.prototype,"output",void 0),(0,v._)([(0,Oe.o)()],Fe.prototype,"hasSlicePlane",void 0),(0,v._)([(0,Oe.o)()],Fe.prototype,"drawScreenSize",void 0),(0,v._)([(0,Oe.o)()],Fe.prototype,"useFixedSizes",void 0),(0,v._)([(0,Oe.o)()],Fe.prototype,"hasOccludees",void 0),(0,v._)([(0,Oe.o)()],Fe.prototype,"clippingEnabled",void 0),(0,v._)([(0,Oe.o)({constValue:!0})],Fe.prototype,"hasSliceInVertexProgram",void 0);var Me=n(44070),Ee=n(61109),Le={positions:[new Ee.G(we.T.POSITION,3,Ie.g.FLOAT,0,12)],colors:[new Ee.G(we.T.COLOR,3,Ie.g.UNSIGNED_BYTE,0,3,!0)]},He=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,l.Z)(this,n),(r=t.call(this,e)).type=ke.q7.PCL,r.isGround=!1,r._passParameters=new Pe.P,r._highlights=new ve({forEachNode:function(e){return r.forEachNode(e)},addHighlight:function(e,t,n){return r._addHighlight(e,t,n)},removeHighlight:function(e,t){return r._removeHighlight(e,t)}}),r.produces=new Map([[xe.r.OPAQUE_MATERIAL,function(e){return!((0,ge.BX)(e)||e===ge.H_.Highlight&&r._highlights.empty)}],[xe.r.OPAQUE_NO_SSAO_DEPTH,function(e){return(0,ge.BX)(e)}]]),r.layerUid="",r._slicePlaneEnabled=!1,r._techniqueConfig=new Fe,r._nodes=new se.Z,r}return(0,d.Z)(n,[{key:"initializeRenderContext",value:function(e){this._context=e,e.requestRender()}},{key:"uninitializeRenderContext",value:function(){}},{key:"intersect",value:function(e,t,n,r){var i=this,a=(0,le.Ue)(),o=(0,le.Ue)(),u=(0,le.Ue)(),l=(0,le.Ue)(),d=(0,z.Ue)(),c=e.camera.perScreenPixelRatio/2,h=e.camera.near;(0,N.f)(o,r,n);var f=1/(0,N.l)(o);(0,N.j)(o,o,f),(0,N.k)(u,o),(0,de.s)(d,o[0],o[1],o[2],-(0,N.m)(o,n));var p=new Te,v=new Te,_=new Array,g=(0,I.Ue)(),y=(0,I.Ue)(this._passParameters.clipBox);(0,I.cv)(y,-n[0],-n[1],-n[2],y),this._nodes.forAll((function(s){var m=s.splatSize*i._passParameters.scaleFactor,b=s.obb.minimumDistancePlane(d),k=s.obb.maximumDistancePlane(d);b-=De(m,b+h,i._passParameters,c,s.isLeaf);var x=(k-=De(m,k+h,i._passParameters,c,s.isLeaf))<0,S=null!=p.dist&&null!=v.dist&&p.dist<b*f&&v.dist>k*f;if(!x&&!S){var w=qe(m,k+h,i._passParameters,c,s.isLeaf);if(s.obb.intersectRay(n,o,w)){var P=w*w;s.obb.toAaBoundingBox(g),(0,I.cv)(g,-n[0],-n[1],-n[2],g);var C=!(0,I.r3)(y,g);(0,N.f)(l,s.origin,n);for(var Z=s.coordinates.length/3,A=function(d){if(a[0]=l[0]+s.coordinates[3*d],a[1]=l[1]+s.coordinates[3*d+1],a[2]=l[2]+s.coordinates[3*d+2],C&&!(0,I.BD)(y,a))return"continue";var g=(0,N.m)(a,o),b=(0,N.q)(a)-g*g;if(b>P)return"continue";var k=g+h,x=De(m,k,i._passParameters,c,s.isLeaf);if(g-x<0)return"continue";var S=qe(m,k-=x,i._passParameters,c,s.isLeaf);if(b>S*S)return"continue";var w=(g-x)*f,Z=function(e){return e.point=function(e,t,n){return null==n&&(n=(0,le.Ue)()),n[0]=e.origin[0]+e.coordinates[3*t],n[1]=e.origin[1]+e.coordinates[3*t+1],n[2]=e.origin[2]+e.coordinates[3*t+2],n}(s,d,e.point),e.dist=w,e.normal=u,e.node=s,e.pointId=d,e.layerUid=i.layerUid,e};if((null==p.dist||w<p.dist)&&(null==t||t(n,r,w))&&Z(p),e.options.store!==ke.eC.MIN&&(null==v.dist||w>v.dist)&&(null==t||t(n,r,w))&&Z(v),e.options.store===ke.eC.ALL&&(null==t||t(n,r,w))){var A=new Te;_.push(Z(A))}},z=0;z<Z;z++)A(z)}}}));var m=function(e,t){var n=function(e){var t=e.layerUid,n=e.node,r=e.pointId;return new he.AK(e.point,t,r,(function(){return i.createGraphic(n,r,e.point)}))}(t);e.set(i.type,n,t.dist,t.normal)};if(Be(p)){var b=e.results.min;(null==b.dist||p.dist<b.dist)&&m(b,p)}if(Be(v)&&e.options.store!==ke.eC.MIN){var k=e.results.max;(null==k.dist||v.dist>k.dist)&&m(k,v)}if(e.options.store===ke.eC.ALL){var x,S=(0,ce.zk)(n,r),w=(0,s.Z)(_);try{for(w.s();!(x=w.n()).done;){var P=x.value,C=(0,be.LP)(S);m(C,P),e.results.all.push(C)}}catch(Z){w.e(Z)}finally{w.f()}}}},{key:"prepareTechnique",value:function(e){var t=this;return 0!==this._nodes.length&&(e.output===ge.H_.Color||(0,ge.BX)(e.output)&&e.bindParameters.slot===xe.r.OPAQUE_NO_SSAO_DEPTH||e.output===ge.H_.Highlight)?(this._nodes.forAll((function(n){null==n.vao&&t._initNode(e,n)})),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=e.output,this._context.techniques.releaseAndAcquire(Re,this._techniqueConfig,this._technique)):null}},{key:"renderNode",value:function(e,t){var n=this,r=e.rctx,i=r.bindTechnique(t,e.bindParameters,this._passParameters),a=e.output===ge.H_.Highlight;this._nodes.forAll((function(t){0===t.coordinates.length||a&&!t.highlights||(i.bindDraw(t,e.bindParameters,n._passParameters),r.bindVAO(t.vao),a?n._renderHighlightFragments(r,t):r.drawArrays(Ie.MX.POINTS,0,t.coordinates.length/3))}))}},{key:"_renderHighlightFragments",value:function(e,t){var n=t.highlights;if(null!=n){for(var r=n[0].component,i=r+1,a=1;a<n.length;a++){var o=n[a].component;if(o!==i){var u=i-r;u>0&&e.drawArrays(Ie.MX.POINTS,r,u),r=o}i=o+1}var s=i-r;s>0&&e.drawArrays(Ie.MX.POINTS,r,s)}}},{key:"useFixedSizes",get:function(){return this._passParameters.useFixedSizes},set:function(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._passParameters.scaleFactor},set:function(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._passParameters.minSizePx},set:function(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._passParameters.useRealWorldSymbolSizes},set:function(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._passParameters.size},set:function(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._passParameters.sizePx},set:function(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){(0,I.t8)(this._passParameters.clipBox,e||I.gy)}},{key:"_clippingEnabled",get:function(){return!(0,I.fS)(this._passParameters.clipBox,I.gy,(function(e,t){return e===t}))}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}},{key:"addNode",value:function(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}},{key:"removeNode",value:function(e){var t=this,n=null;return this._nodes.filterInPlace((function(r){return r.id!==e||(n=r,r.vao=(0,k.M2)(r.vao),t._highlights.nodeRemoved(r),!1)})),this._requestRender(),n}},{key:"forEachNode",value:function(e){this._nodes.forAll(e)}},{key:"removeAll",value:function(){this._nodes.forAll((function(e){return e.vao=(0,k.M2)(e.vao)})),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}},{key:"highlight",value:function(e){return this._highlights.add(e)}},{key:"_addHighlight",value:function(e,t,n){e.highlights=function(e,t,n){null==e&&(e=[]);var r={component:t,id:n};e.push(r);for(var i=Ue(r),a=e.length-1;a>0&&i<Ue(e[a-1]);){var o;o=[e[a],e[a-1]],e[a-1]=o[0],e[a]=o[1],--a}return e}(e.highlights,t,n),this._requestRender()}},{key:"_removeHighlight",value:function(e,t){e.highlights=function(e,t){if(null==e)return e;var n=e.filter((function(e){return e.id!==t}));return 0===n.length?null:n}(e.highlights,t),this._requestRender()}},{key:"_initNode",value:function(e,t){var n=e.rctx;t.vao=new Se.U(n,me.i,Le,{positions:Me.f.createVertex(n,Ie.l1.STATIC_DRAW,t.coordinates),colors:Me.f.createVertex(n,Ie.l1.STATIC_DRAW,t.rgb)})}},{key:"_requestRender",value:function(){this._context&&this._context.requestRender()}}]),n}(ye.He);(0,v._)([(0,C.Cb)({constructOnly:!0})],He.prototype,"createGraphic",void 0),He=(0,v._)([(0,Z.j)("esri.views.3d.layers.i3s.PointRenderer")],He);var Ve=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e,r,i,a,o,u,s,d){var c,h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,f=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null;return(0,l.Z)(this,n),(c=t.call(this,i,o,r)).id=e,c.obb=a,c.coordinates=u,c.rgb=s,c.attributes=d,c.pointIdFilterMap=h,c.highlights=f,c}return(0,d.Z)(n)}(Pe.a);function qe(e,t,n,r,i){if(n.drawScreenSpace)return n.fixedSize*t*r;var a=(0,Pe.g)(i)*t*r;return n.useFixedSizes?Math.min(n.fixedSize/2,a):n.screenMinSize>0?Math.min(Math.max(n.screenMinSize*t*r,e/2),a):Math.min(e/2,a)}function De(e,t,n,r,i){return n.drawScreenSpace?0:qe(e,t,n,r,i)}function Ue(e){return null!=e.component?e.component:-1}var Te=(0,d.Z)((function e(){(0,l.Z)(this,e),this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}));function Be(e){return null!=e.dist&&null!=e.point&&null!=e.pointId&&null!=e.node}var We=n(23224),Qe=n(65206),Ge=n(9985),je=n(45888),Je=n(89414),Xe=n(58890),Ke=n(67581),Ye=n(69787),$e=n(93463),et=(0,z.Ue)(),tt=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(){var e;return(0,l.Z)(this,n),(e=t.apply(this,arguments)).type="point-cloud-3d",e.maximumPointCount=4e6,e.slicePlaneEnabled=!1,e._renderer=null,e._rendererAdded=!1,e._renderedNodes=new Set,e._updateViewNeeded=!0,e._lodFactor=1,e._maxLoggedBoxWarnings=5,e._pageMultiplier=1,e._nodeLoadEpoch=0,e._indexQueue=[],e._workQueue=new Array,e._idleQueue=new M.b,e._indexPagesLoading=new Map,e._loadingNodes=new Map,e._recalcWork=!0,e._layerIsVisible=!1,e._codedDomainPopulationPromise=null,e._codedDomainPopulationAbortController=null,e._totalWork=0,e._index=null,e._loadingInitNodePage=!1,e._nodeIdArray=[],e.ignoresMemoryFactor=!1,e}return(0,d.Z)(n,[{key:"baseUrl",get:function(){var e,t;return null!==(e=null===(t=this.layer.parsedUrl)||void 0===t?void 0:t.path)&&void 0!==e?e:""}},{key:"pointScale",get:function(){var e,t=function(e){var t=null===e||void 0===e?void 0:e.pointSizeAlgorithm;return t&&"splat"===t.type?t:null}(null===(e=this.layer)||void 0===e?void 0:e.renderer);return null!=(null===t||void 0===t?void 0:t.scaleFactor)?t.scaleFactor:1}},{key:"useRealWorldSymbolSizes",get:function(){var e,t=ne(null===(e=this.layer)||void 0===e?void 0:e.renderer);return null!=(null===t||void 0===t?void 0:t.useRealWorldSymbolSizes)&&t.useRealWorldSymbolSizes}},{key:"pointSize",get:function(){var e,t=ne(null===(e=this.layer)||void 0===e?void 0:e.renderer);return null!=(null===t||void 0===t?void 0:t.size)?t.size:0}},{key:"inverseDensity",get:function(){var e;return null!==(e=this.layer)&&void 0!==e&&e.renderer?96/this.layer.renderer.pointsPerInch:5}},{key:"availableFields",get:function(){var e=ee(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.modulationAttribute.name);var n=te(this.layer);if(n){var r,i=(0,s.Z)(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;a.attributeInfo&&t.add(a.attributeInfo.name)}}catch(d){i.e(d)}finally{i.f()}}if(this.layer.outFields){var o,u=(0,s.Z)((0,F.Lk)(this.layer.fieldsIndex,this.layer.outFields));try{for(u.s();!(o=u.n()).done;){var l=o.value;t.add(l)}}catch(d){u.e(d)}finally{u.f()}}return Array.from(t)}},{key:"_clippingBox",get:function(){if(!this.view||!this.view.clippingArea)return null;var e=(0,I.Ue)(),t=this.view.renderSpatialReference;return(0,Qe.O)(this.view.clippingArea,e,t)?e:null}},{key:"_elevationOffset",get:function(){var e=this.layer&&this.layer.elevationInfo;return e&&"absolute-height"===e.mode?(0,E.ap)(e,this.layer.spatialReference):0}},{key:"initialize",value:function(){var e=this,t=this.view.resourceController,n=function(e){return function(t){return e.immediate.schedule(t)}}(t);this._worker=new q(n),this.addResolvingPromise(this._worker.promise),(0,D.zW)(this.layer),(0,D.yS)(this.layer,this.view),this._indexRequester=t.createStreamDataRequester(je.Bh.I3S_INDEX),this._dataRequester=t.createStreamDataRequester(je.Bh.I3S_DATA),this._initRenderer();var r=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.newCache("pcl-".concat(this.layer.uid)),this._updatingHandles.add((function(){return e._clippingBox}),(function(){return e._setUpdateViewNeeded()}),S.initial),this._updatingHandles.add((function(){return e._elevationOffset}),(function(){return e._elevationOffsetChanged()}),S.initial),this._updatingHandles.add((function(){return e.layer.renderer}),(function(){return e._rendererChanged()}),S.initial),this._updatingHandles.add((function(){return e.layer.filters}),(function(){return e._reload()}),S.initial),this._updatingHandles.add((function(){return e.layer.outFields}),(function(){return e._reload()}),S.initial),this._updatingHandles.add((function(){return e.layer.effectiveScaleRange}),(function(){return e._setUpdateViewNeeded()})),this._updatingHandles.add((function(){return e.view.state.contentCamera}),(function(){return e._setUpdateViewNeeded()})),this.addHandles([(0,S.watch)((function(){return e.view.quality}),(function(){return e._setUpdateViewNeeded()}),S.sync)]),this.addResolvingPromise(r),this.when((function(){e.addHandles([t.scheduler.registerTask($e.T8.POINT_CLOUD_LAYER,e),t.scheduler.registerIdleStateCallbacks((function(){return e._idleBegin()}),(function(){return e._idleEnd()})),e._updatingHandles.add((function(){return e.suspended}),(function(t){t?e._clearNodeState():e._setUpdateViewNeeded()}),S.initial)])}),(function(){e._updatingHandles.removeAll(),e.removeAllHandles()}))}},{key:"_setUpdateViewNeeded",value:function(){this._updateViewNeeded=!0,this._updateLoading()}},{key:"destroy",value:function(){this.cancelLoading(),this._worker=(0,k.SC)(this._worker),this._destroyRenderer(),this._memCache=(0,k.SC)(this._memCache),this._codedDomainPopulationAbortController=(0,k.IM)(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}},{key:"_initRenderer",value:function(){var e=this;this._renderer=new He({createGraphic:function(t,n,r){return e._createGraphic(t,n,r)}}),this._renderer.layerUid=this.layer.uid,this._updatingHandles.add((function(){return e._clippingBox}),(function(t){return e._renderer.clippingBox=t}),S.initial),this._updatingHandles.add((function(){return e.suspended}),(function(t){return e._setPointsVisible(!t)}),S.initial),this._updatingHandles.add((function(){return e.pointScale}),(function(t){return e._renderer.scaleFactor=t}),S.initial),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add((function(){return e.useRealWorldSymbolSizes}),(function(t){return e._renderer.useRealWorldSymbolSizes=t}),S.initial),this._updatingHandles.add((function(){return e.pointSize}),(function(t){var n=(0,w.F2)(t);e._renderer.size=t,e._renderer.sizePx=n}),S.initial),this._updatingHandles.add((function(){return e.slicePlaneEnabled}),(function(t){return e._renderer.slicePlaneEnabled=t}),S.initial),this._updatingHandles.add((function(){return e.inverseDensity}),(function(){return e._setUpdateViewNeeded()}),S.initial),this._updatingHandles.add((function(){return e.maximumPointCount}),(function(){return e._setUpdateViewNeeded()}),S.initial),this._updatingHandles.add((function(){return e.view.qualitySettings.sceneService.pointCloud.lodFactor}),(function(t){e._lodFactor=t,e._setUpdateViewNeeded()}),S.initial)}},{key:"_destroyRenderer",value:function(){this._renderer.removeAll(),this._setPointsVisible(!1)}},{key:"_createGraphic",value:function(e,t,n){var r=null!=e.pointIdFilterMap?e.pointIdFilterMap[t]:t,i=(0,Ge.K0)(this.view,n),a=this._createGraphicAttributes(e,r);return new ue({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:i,attributes:a,layer:this.layer,sourceLayer:this.layer})}},{key:"_createGraphicAttributes",value:function(e,t){var n,r={},i=(0,s.Z)(e.attributes);try{for(i.s();!(n=i.n()).done;){var a=n.value;this._encodeGraphicAttribute(a.attributeInfo,a.values,t,r)}}catch(o){i.e(o)}finally{i.f()}return r}},{key:"_encodeGraphicAttribute",value:function(e,t,n,r){var i,a,o=null===(i=e.storageInfo)||void 0===i?void 0:i.attributeValues,u=null!==(a=null===o||void 0===o?void 0:o.valuesPerElement)&&void 0!==a?a:1;if(1===u)r[e.name]=t[n];else if("UInt8"===(null===o||void 0===o?void 0:o.valueType)&&u<=4){for(var s=0,l=n*u,d=l;d<l+u;d++)s=(s<<8)+t[d];r[e.name]=s}else r[e.name]=void 0}},{key:"_setPointsVisible",value:function(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}},{key:"_rendererChanged",value:function(){this._renderer.useFixedSizes=function(e){var t=null===e||void 0===e?void 0:e.pointSizeAlgorithm;return!(null===t||void 0===t||!t.type)&&"fixed-size"===t.type}(this.layer.renderer),this._reload()}},{key:"_reload",value:function(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}},{key:"_elevationOffsetChanged",value:function(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}},{key:"_displayNodes",value:function(e){this._workQueue=function(e,t,n){for(var r=0;r<t.length;r++)B[r]=!1,W[r]=null;for(var i=0;i<e.length;i++)U[i]=!1,T[i]=null;for(var a=0;a<t.length;a++){var o=Q(t[a],e,n);o>=0&&(B[a]=!0,null!=T[o]?T[o].push(t[a]):T[o]=[t[a]])}for(var u=0;u<e.length;u++){var s=Q(e[u],t,n);s>=0&&(U[u]=!0,null!=W[s]?W[s].push(e[u]):W[s]=[e[u]])}for(var l=[],d=0;d<e.length;d++)null!=T[d]||U[d]||l.push({load:[],remove:[e[d]]});for(var c=0;c<t.length;c++)null!=W[c]||B[c]||l.push({load:[t[c]],remove:[]});for(var h=0;h<t.length;h++)null!=W[h]&&(W[h].length>1||W[h][0]!==t[h])&&l.push({load:[t[h]],remove:W[h]});for(var f=0;f<e.length;f++)null!=T[f]&&(T[f].length>1||T[f][0]!==e[f])&&l.push({load:T[f],remove:[e[f]]});return l}((0,u.Z)(this._renderedNodes),e,this._index),function(e,t,n){e.sort((function(e,r){if(0===e.load.length&&0===r.load.length)return 0;if(0===e.load.length)return-1;if(0===r.load.length)return 1;if(0===e.remove.length&&0===r.remove.length){var i=n.getRenderObb(e.load[0]).center,a=n.getRenderObb(r.load[0]).center;return(0,N.m)(i,t)-(0,N.m)(a,t)}if(0===e.remove.length)return-1;if(0===r.remove.length)return 1;if(1===e.load.length&&1===r.load.length){var o=n.getRenderObb(e.load[0]).center,u=n.getRenderObb(r.load[0]).center;return(0,N.m)(o,t)-(0,N.m)(u,t)}if(1===e.load.length)return-1;if(1===r.load.length)return 1;var s=n.getRenderObb(e.remove[0]).center,l=n.getRenderObb(r.remove[0]).center;return(0,N.m)(s,t)-(0,N.m)(l,t)}))}(this._workQueue,this.view.state.contentCamera.viewForward,this._index),function(e,t,n){for(var r=0;r<e.length;++r){var i=e[r];i.load.length>t&&1===i.remove.length&&G(e,i,n)}}(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}},{key:"cancelLoading",value:function(){this._cancelNodeLoading(),this._cancelIndexLoading()}},{key:"_cancelNodeLoading",value:function(){var e=new Array;this._loadingNodes.forEach((function(t){var n=t.abortController;return e.push(n)})),this._loadingNodes.clear();for(var t=0,n=e;t<n.length;t++){n[t].abort()}this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}},{key:"_updateQueues",value:function(){var e=this,t=new Set;this._workQueue.forEach((function(e){return e.load.forEach((function(e){return t.add(e)}))}));var n=new Array,r=new Map;this._loadingNodes.forEach((function(e,i){t.has(i)?r.set(i,e):n.push(e)})),this._loadingNodes=r;for(var i=0,a=n;i<a.length;i++){a[i].abortController.abort()}this._workQueue=this._workQueue.filter((function(t){var n,r=(0,s.Z)(t.load);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(e._loadingNodes.has(i))return e._recalcWork=!0,!1}}catch(a){r.e(a)}finally{r.f()}return!0})),this._totalWork=this._computeWork(),this._updateLoading()}},{key:"_cancelIndexLoading",value:function(){this._indexQueue=[],this._indexPagesLoading.forEach((function(e){return e.abortController.abort()})),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}},{key:"_clearNodeState",value:function(){var e=this;this._nodeLoadEpoch++,this._renderedNodes.forEach((function(t){return e._removeFromRenderer(t)})),this._cancelNodeLoading()}},{key:"_idleBegin",value:function(){this._setUpdateViewNeeded()}},{key:"_idleEnd",value:function(){this._setUpdateViewNeeded()}},{key:"running",get:function(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}},{key:"runTask",value:function(e){var t=this;if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;var n=this._isRootNodeVisible();n!==this._layerIsVisible&&(this._layerIsVisible=n,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((function(){return t._updateWorkQueues()}));this._indexQueue.length>0&&e.run((function(){return t._processIndexQueue()})););this._processWorkQueue(e),this._idleQueue.runTask(e)}}},{key:"_processIndexQueue",value:function(){var e=this,t=this._indexQueue.shift(),n=this._loadNodePage(t);return this._indexPagesLoading.set(t,n),n.promise.then((function(n){e._index.addPage(t,n,e._elevationOffset),e._setUpdateViewNeeded()})).then((function(){e._indexPagesLoading.delete(t)}),(function(){e._indexPagesLoading.delete(t)})),!0}},{key:"_processWorkQueue",value:function(e){for(;!e.done;){var t=this._scheduleWorkEntry();if(null==t)return void e.madeProgress();this._processWorkEntry(t),e.madeProgress()}}},{key:"_scheduleWorkEntry",value:function(){for(var e=this,t=this._workQueue.length;t--;){var n=this._workQueue.shift();if(!n.remove.find((function(t){return!e._renderedNodes.has(t)})))return n;this._workQueue.push(n)}return null}},{key:"_processWorkEntry",value:function(e){var t=this;if(0!==e.load.length)Promise.all(e.load.map((function(e){var n=new AbortController,r=t._memCache.pop(e.toString());return null!=r?t._loadingNodes.set(e,{abortController:n,promise:Promise.resolve(r)}):t._loadingNodes.has(e)||t._loadingNodes.set(e,{abortController:n,promise:t._loadNode(e,n.signal)}),t._loadingNodes.get(e).promise}))).then((function(n){for(var r=0;r<e.load.length;r++)if(n[r]){var i=t._setupRendererData(e.load[r],n[r]);t._addToRenderer(i)}var a,o=(0,s.Z)(e.remove);try{for(o.s();!(a=o.n()).done;){var u=a.value;t._removeFromRenderer(u)}}catch(l){o.e(l)}finally{o.f()}})).catch((function(){})).then((function(){var n,r=(0,s.Z)(e.load);try{for(r.s();!(n=r.n()).done;){var i=n.value;t._loadingNodes.delete(i)}}catch(a){r.e(a)}finally{r.f()}t._updateLoading(),t._recalcWork&&!t._idleQueue.running&&0===t._indexQueue.length&&0===t._loadingNodes.size&&(t._recalcWork=!1,t._setUpdateViewNeeded())})),this._updateLoading();else{var n,r=(0,s.Z)(e.remove);try{for(r.s();!(n=r.n()).done;){var i=n.value;this._removeFromRenderer(i)}}catch(a){r.e(a)}finally{r.f()}}}},{key:"_populateClassCodeCodedDomain",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r,i,o,u,s,l,d;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u="CLASS_CODE",(s=this.layer.fieldsIndex.get(u))&&!s.domain){e.next=3;break}return e.abrupt("return");case 3:if(t.includes(s.name)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,(0,g.q6)(this.layer.queryCachedStatistics(u,{signal:n}));case 7:if(!1!==(l=e.sent).ok){e.next=10;break}return e.abrupt("return");case 10:(d=null===(r=l.value)||void 0===r||null===(i=r.stats)||void 0===i||null===(o=i.labels)||void 0===o?void 0:o.labels)&&Array.isArray(d)&&(s.domain=new O.Z({name:"CLASS_CODE",codedValues:d.map((function(e){return new R.u({code:e.value,name:e.label})}))}));case 12:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"prepareFetchPopupFeatures",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(t,this._codedDomainPopulationAbortController.signal).then((function(){n._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"whenGraphicAttributes",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r,i,u,l,d,c=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._splitGraphicsPerNode(t),i=this.layer.attributeStorageInfo,u=n.map((function(e){return ie(i,e)})).filter(_.pC),l=function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=c._index.getNode(n),e.next=3,(0,g.Ed)(u,function(){var e=(0,o.Z)((0,a.Z)().mark((function e(n){var i,o,u,l,d;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.useElevation){e.next=6;break}return e.next=3,c._loadElevationAttributeFromGeometry(r.resourceId);case 3:e.t0=e.sent,e.next=9;break;case 6:return e.next=8,c._loadAndParseAttribute(r,n);case 8:e.t0=e.sent;case 9:if(i=e.t0){o=(0,s.Z)(t);try{for(o.s();!(u=o.n()).done;)l=u.value,c._isValidPointGraphic(l)&&(d=l.pointCloudMetadata.attributePointIndexInNode,c._encodeGraphicAttribute(n,i,d,l.attributes))}catch(a){o.e(a)}finally{o.f()}}case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),d=[],r.forEach((function(e,t){d.push(l(e,t))})),e.next=4,Promise.allSettled(d);case 4:return e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_isValidPointGraphic",value:function(e){var t;return e instanceof ue&&(null===(t=e.pointCloudMetadata)||void 0===t?void 0:t.epoch)===this._nodeLoadEpoch}},{key:"_splitGraphicsPerNode",value:function(e){var t,n=new Map,r=(0,s.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(this._isValidPointGraphic(i)){var a=i.pointCloudMetadata,o=n.get(a.nodeId);o?o.push(i):n.set(a.nodeId,[i])}}}catch(u){r.e(u)}finally{r.f()}return n}},{key:"_loadAndParseAttribute",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._loadAttribute(t.resourceId,n,null);case 2:return r=e.sent,e.abrupt("return",null!=r?(0,ae.dH)({attributeInfo:n,buffer:r},null,t.vertexCount):null);case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadElevationAttributeFromGeometry",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.layer.store.defaultGeometrySchema,e.t0=ae.Ym,e.t1=n,e.next=5,this._loadGeometry(t,null);case 5:return e.t2=e.sent,r=(0,e.t0)(e.t1,e.t2),e.abrupt("return",(0,ae.et)(r,r.length/3));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"highlight",value:function(e){var t=this;if(!e)return(0,m.kB)();var n=y.Z.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(n.map((function(e){return t._graphicToPointDefinition(e)})))}},{key:"_graphicToPointDefinition",value:function(e){if(!this._isValidPointGraphic(e))return null;var t=e.pointCloudMetadata,n=t.nodeId,r=t.pointIndexInNode;return null!=n&&null!=r?{nodeId:n,pointId:r}:null}},{key:"_computeWork",value:function(){var e,t=0,n=(0,s.Z)(this._workQueue);try{for(n.s();!(e=n.n()).done;){var r=e.value;t+=r.load.length+r.remove.length}}catch(i){n.e(i)}finally{n.f()}return t+=this._loadingNodes.size,t+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,t+=this._loadingInitNodePage?100:0,t+=this._updateViewNeeded?100:0}},{key:"updatingProgressValue",get:function(){if(this.suspended)return this._updateViewNeeded?0:1;var e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}},{key:"_updateLoading",value:function(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}},{key:"canResume",value:function(){return(0,c.Z)((0,h.Z)(n.prototype),"canResume",this).call(this)&&this._layerIsVisible}},{key:"isUpdating",value:function(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}},{key:"visibleAtCurrentScale",get:function(){return(0,Ye.GB)(this.layer.effectiveScaleRange,this.view.terrainScale)}},{key:"_initNodePages",value:function(){var e=this,t=this.layer.store.index,n=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new J(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,n),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then((function(t){e._index.addPage(0,t,e._elevationOffset),e._loadingInitNodePage=!1,e._setUpdateViewNeeded()}))}},{key:"_loadNodePage",value:function(e){var t=this,n=new AbortController,r="".concat(this.baseUrl,"/nodepages/").concat(e*this._pageMultiplier);return{promise:this._requestNodePage(r,n.signal).then((function(n){return n.nodes.map((function(n,r){var i,a;return{resourceId:null!=n.resourceId?n.resourceId:e*t._index.pageSize+r,obb:Je.Oo.fromJSON(n.obb),obbInRenderSR:new Je.Oo,firstChild:n.firstChild,childCount:n.childCount,vertexCount:null!==(i=n.vertexCount)&&void 0!==i?i:n.pointCount,lodThreshold:null!==(a=n.lodThreshold)&&void 0!==a?a:n.effectiveArea}}))})),abortController:n}}},{key:"_updateWorkQueues",value:function(){if(!this._updateViewNeeded)return!1;for(var e=this.view.quality,t=this.inverseDensity/this._lodFactor*e,n=this.maximumPointCount*this._lodFactor*e,r=this._computeNodesForMinimumDensity(t),i=this._computePointCount(r),a=Math.sqrt(i/(.75*n));i>n;)t*=a,r=this._computeNodesForMinimumDensity(t),i=this._computePointCount(r),a=Math.sqrt(2);return this._displayNodes(r),this._updateViewNeeded=!1,this._updateLoading(),!0}},{key:"_computePointCount",value:function(e){for(var t=0,n=0;n<e.length;n++){var r=this._index.getNode(e[n]);r&&(t+=r.vertexCount)}return t}},{key:"_isRootNodeVisible",value:function(){var e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:function(t,n,r){return e=r,!1},pageMiss:function(){}}),e}},{key:"_computeNodesForMinimumDensity",value:function(e){var t=this,n=this.view.state.contentCamera,r=n.frustum,i=this._clippingBox,a=n.viewForward,o=(0,N.m)(a,n.eye),u=(0,z.Oy)(a,-o,et),s=n.perScreenPixelRatio/2,l=e*e,d=this._nodeIdArray;d.length=0;var c=function(e){return d.push(e)};return this._traverseVisible({frustum:r,clippingBox:i},{predicate:function(e,n,r){if(!r)return!1;if(0===n.childCount)return c(e),!1;var i=t._index.getRenderObb(e);return!(t._computeAveragePixelArea(i,n.lodThreshold,n.vertexCount,u,s)<=l)||(c(e),!1)},pageMiss:function(e,n){c(e),t._indexQueue.includes(n)||t._indexQueue.push(n)}}),d}},{key:"_computeAveragePixelArea",value:function(e,t,n,r,i){var a=Math.max(1e-7,e.minimumDistancePlane(r));return t/(a*a)/(4*i*i)/n}},{key:"_loadNode",value:function(e,t){try{return this._loadNodeAsync(e,t)}catch(J){throw(0,x.D_)(J)||b.Z.getLogger(this).error(J),J}}},{key:"_loadAdditionalUserAttributes",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){var i,o,u,l,d,c,h,f,p,v;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.layer.outFields){e.next=3;break}return e.abrupt("return",[]);case 3:o=(0,F.Lk)(this.layer.fieldsIndex,i),u=new Set(t.map((function(e){return null!=e?e.name:null}))),l=this.layer.attributeStorageInfo,d=[],c=(0,s.Z)(o),e.prev=5,c.s();case 7:if((h=c.n()).done){e.next=15;break}if(f=h.value,!u.has(f)){e.next=11;break}return e.abrupt("continue",13);case 11:(p=ie(l,f))&&d.push(n(p));case 13:e.next=7;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(5),c.e(e.t0);case 20:return e.prev=20,c.f(),e.finish(20);case 23:return e.next=25,(0,x.OT)(d);case 25:return v=e.sent,e.abrupt("return",((0,x.k_)(r),v.filter(_.pC)));case 27:case"end":return e.stop()}}),e,this,[[5,17,20,23]])})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_loadNodeAsync",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r,s,l,d,c,h=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._index.getNode(t),s=ee(this.layer),l=te(this.layer),d=r.resourceId,c=function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:if(!t.useElevation){e.next=4;break}return e.abrupt("return",{attributeInfo:t,buffer:null});case 4:return e.next=6,h._loadAttribute(d,t,n);case 6:return r=e.sent,e.abrupt("return",null!=r?{attributeInfo:t,buffer:r}:null);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.abrupt("return",this._idleQueue.push((0,o.Z)((0,a.Z)().mark((function e(){var r,o,f,p,v,_,g,y,m,b,k,S,w,P,C,Z;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=h._loadGeometry(d,n),o=s.primaryAttribute,f=s.modulationAttribute,p=c(o),v=c(f),_=l.map((function(e){return e.attributeInfo})),g=_.map((function(e){return c(e)})),y=h._loadAdditionalUserAttributes([o,f].concat((0,u.Z)(_)),c,n),e.next=10,Promise.all([r,p,v,Promise.all(g),y]);case 10:return m=e.sent,b=(0,i.Z)(m,5),k=b[0],S=b[1],w=b[2],P=b[3],C=b[4],(0,x.k_)(n),Z={geometryBuffer:k,primaryAttributeData:S,modulationAttributeData:w,filterAttributesData:P,userAttributesData:C,schema:h.layer.store.defaultGeometrySchema,rendererInfo:s,filterInfo:l,obbData:h._index.getRenderObb(t).data,elevationOffset:h._elevationOffset,inSR:h.layer.spatialReference.toJSON(),outSR:h.view.renderCoordsHelper.spatialReference.toJSON()},e.abrupt("return",h._worker.invoke(Z,n));case 20:case"end":return e.stop()}}),e)}))),n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadGeometry",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._requestData("".concat(this.baseUrl,"/nodes/").concat(t,"/geometries/0"),n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadAttribute",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){var i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==n&&void 0!==n&&n.storageInfo){e.next=2;break}return e.abrupt("return",null);case 2:return i=n.storageInfo.key,e.abrupt("return",this._requestData("".concat(this.baseUrl,"/nodes/").concat(t,"/attributes/").concat(i),r));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_requestNodePage",value:function(e,t){var n=(0,r.Z)((0,r.Z)({f:"json"},this.layer.customParameters),{},{token:this.layer.apiKey});return this._indexRequester.request(e,"json",{query:n,signal:t})}},{key:"_requestData",value:function(e,t){return this._dataRequester.request(e,"binary",{query:(0,r.Z)((0,r.Z)({},this.layer.customParameters),{},{token:this.layer.apiKey}),signal:t})}},{key:"_removeFromRenderer",value:function(e){if(this._renderedNodes.has(e)){var t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._memCache.put(t.id.toString(),t,function(e){return 5*e.coordinates.length+128}(t))}}},{key:"_addToRenderer",value:function(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}},{key:"_setupRendererData",value:function(e,t){var n=this._index.getNode(e),r=Math.sqrt(n.lodThreshold/n.vertexCount),i=this._index.getRenderObb(e);if(function(e){return e.hasOwnProperty("splatSize")}(t))return t.splatSize=r,t.obb=i,(0,N.c)(t.origin,t.obb.center),t;var a=Je.Oo.fromData(t.obbData),o=a.halfSize,u=i.halfSize,s=.01*Math.max(u[0],u[1],u[2]);if(o[0]>u[0]+s||o[1]>u[1]+s||o[2]>u[2]+s){if(this._maxLoggedBoxWarnings>0){var l=function(e){return"[".concat(e.halfSize[0],", ").concat(e.halfSize[1],", ").concat(e.halfSize[2],"]")};b.Z.getLogger(this).warn("Node ".concat(e," reported bounding box too small. got ").concat(l(i)," but points cover ").concat(l(a))),0==--this._maxLoggedBoxWarnings&&b.Z.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,a)}return new Ve(e,r,(0,A.d9)(i.center),i,0===n.childCount,t.points,t.rgb,t.attributes,t.pointIdFilterMap)}},{key:"usedMemory",get:function(){var e=0;return this._renderer.forEachNode((function(t){e+=rt,e+=(0,P.Xw)(t.coordinates);var n,r=(0,s.Z)(t.attributes);try{for(r.s();!(n=r.n()).done;){var i=n.value.values;(0,P.eP)(i.buffer)&&(e+=(0,P.Xw)(i))}}catch(a){r.e(a)}finally{r.f()}})),e}},{key:"unloadedMemory",get:function(){var e=this,t=this._renderedNodes.size;if(t<4)return 0;for(var n=(0,u.Z)(this._renderedNodes).reduce((function(t,n){return t+e._index.getNode(n).vertexCount})),r=this._loadingNodes.size,i=0;i<this._workQueue.length;i++)r+=this._workQueue[i].load.length,r-=this._workQueue[i].remove.length;return r<0?0:r*n/t*((this.usedMemory-t*rt)/n)+r*rt}},{key:"performanceInfo",get:function(){var e=this;return new H(this.usedMemory,this._renderedNodes.size,(0,u.Z)(this._renderedNodes).reduce((function(t,n){return t+e._index.getNode(n).vertexCount}),0),this.maximumPointCount,new V(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}},{key:"test",get:function(){}}]),n}((0,We.i)((0,L.A)(Ke.Z)));(0,v._)([(0,C.Cb)()],tt.prototype,"layer",void 0),(0,v._)([(0,C.Cb)()],tt.prototype,"baseUrl",null),(0,v._)([(0,C.Cb)()],tt.prototype,"pointScale",null),(0,v._)([(0,C.Cb)()],tt.prototype,"useRealWorldSymbolSizes",null),(0,v._)([(0,C.Cb)()],tt.prototype,"pointSize",null),(0,v._)([(0,C.Cb)()],tt.prototype,"inverseDensity",null),(0,v._)([(0,C.Cb)()],tt.prototype,"maximumPointCount",void 0),(0,v._)([(0,C.Cb)({readOnly:!0})],tt.prototype,"availableFields",null),(0,v._)([(0,C.Cb)({readOnly:!0})],tt.prototype,"_clippingBox",null),(0,v._)([(0,C.Cb)({readOnly:!0})],tt.prototype,"_elevationOffset",null),(0,v._)([(0,C.Cb)({type:Boolean})],tt.prototype,"slicePlaneEnabled",void 0),(0,v._)([(0,C.Cb)()],tt.prototype,"updating",void 0),(0,v._)([(0,C.Cb)(Xe.q)],tt.prototype,"updatingProgress",void 0),(0,v._)([(0,C.Cb)({readOnly:!0})],tt.prototype,"updatingProgressValue",null),(0,v._)([(0,C.Cb)({readOnly:!0})],tt.prototype,"visibleAtCurrentScale",null);var nt=tt=(0,v._)([(0,Z.j)("esri.views.3d.layers.PointCloudLayerView3D")],tt);var rt=160},74432:function(e,t,n){n.d(t,{Ym:function(){return d},aE:function(){return l},dH:function(){return c},et:function(){return h},hv:function(){return f}});var r=n(37762),i=(n(93169),n(21134)),a=n(89431),o=n(87005),u=n(28278),s=n(2821);function l(e,t,n,r){var u,s=e.rendererJSON,l=e.isRGBRenderer,d=null,c=null;if(t&&l)d=t;else if(t&&"pointCloudUniqueValueRenderer"===(null===s||void 0===s?void 0:s.type)){var h=(c=o.Z.fromJSON(s)).colorUniqueValueInfos;d=new Uint8Array(3*r);for(var f=p(c.fieldTransformType),v=0;v<r;v++)for(var _=(f?f(t[v]):t[v])+"",g=0;g<h.length;g++)if(h[g].values.includes(_)){d[3*v]=h[g].color.r,d[3*v+1]=h[g].color.g,d[3*v+2]=h[g].color.b;break}}else if(t&&"pointCloudStretchRenderer"===(null===s||void 0===s?void 0:s.type)){var y=(c=a.Z.fromJSON(s)).stops;d=new Uint8Array(3*r);for(var m=p(c.fieldTransformType),b=0;b<r;b++){var k=m?m(t[b]):t[b],x=y.length-1;if(k<y[0].value)d[3*b]=y[0].color.r,d[3*b+1]=y[0].color.g,d[3*b+2]=y[0].color.b;else if(k>=y[x].value)d[3*b]=y[x].color.r,d[3*b+1]=y[x].color.g,d[3*b+2]=y[x].color.b;else for(var S=1;S<y.length;S++)if(k<y[S].value){var w=(k-y[S-1].value)/(y[S].value-y[S-1].value);d[3*b]=y[S].color.r*w+y[S-1].color.r*(1-w),d[3*b+1]=y[S].color.g*w+y[S-1].color.g*(1-w),d[3*b+2]=y[S].color.b*w+y[S-1].color.b*(1-w);break}}}else if(t&&"pointCloudClassBreaksRenderer"===(null===s||void 0===s?void 0:s.type)){var P=(c=i.Z.fromJSON(s)).colorClassBreakInfos;d=new Uint8Array(3*r);for(var C=p(c.fieldTransformType),Z=0;Z<r;Z++)for(var N=C?C(t[Z]):t[Z],A=0;A<P.length;A++)if(N>=P[A].minValue&&N<=P[A].maxValue){d[3*Z]=P[A].color.r,d[3*Z+1]=P[A].color.g,d[3*Z+2]=P[A].color.b;break}}else d=new Uint8Array(3*r).fill(255);if(n&&null!==(u=c)&&void 0!==u&&u.colorModulation)for(var I=c.colorModulation.minValue,z=c.colorModulation.maxValue,R=0;R<r;R++){var O=n[R],F=O>=z?1:O<=I?.3:.3+.7*(O-I)/(z-I);d[3*R]=F*d[3*R],d[3*R+1]=F*d[3*R+1],d[3*R+2]=F*d[3*R+2]}return d}function d(e,t){if(null==e.encoding||""===e.encoding){var n=(0,u.W7)(t,e);if(null==n.vertexAttributes.position)return;for(var r=(0,u.I_)(t,n.vertexAttributes.position),i=n.header.fields,a=[i.offsetX,i.offsetY,i.offsetZ],o=[i.scaleX,i.scaleY,i.scaleZ],l=r.length/3,d=new Float64Array(3*l),c=0;c<l;c++)d[3*c]=r[3*c]*o[0]+a[0],d[3*c+1]=r[3*c+1]*o[1]+a[1],d[3*c+2]=r[3*c+2]*o[2]+a[2];return d}if("lepcc-xyz"===e.encoding)return(0,s.Gi)(t).result}function c(e,t,n){return null!==e&&void 0!==e&&e.attributeInfo.useElevation?t?h(t,n):null:null!==e&&void 0!==e&&e.attributeInfo.storageInfo?(0,u.qM)(e.attributeInfo.storageInfo,e.buffer,n):null}function h(e,t){for(var n=new Float64Array(t),r=0;r<t;r++)n[r]=e[3*r+2];return n}function f(e,t,n,i,a){for(var o=e.length/3,u=0,s=0;s<o;s++){for(var l=!0,d=0;d<i.length&&l;d++){var c=i[d].filterJSON,h=a[d].values[s];switch(c.type){case"pointCloudValueFilter":var f="exclude"===c.mode;c.values.includes(h)===f&&(l=!1);break;case"pointCloudBitfieldFilter":var p=v(c.requiredSetBits),_=v(c.requiredClearBits);((h&p)!==p||h&_)&&(l=!1);break;case"pointCloudReturnFilter":var g,y=15&h,m=h>>>4&15,b=m>1,k=1===y,x=y===m,S=!1,w=(0,r.Z)(c.includedReturns);try{for(w.s();!(g=w.n()).done;){var P=g.value;if("last"===P&&x||"firstOfMany"===P&&k&&b||"lastOfMany"===P&&x&&b||"single"===P&&!b){S=!0;break}}}catch(C){w.e(C)}finally{w.f()}S||(l=!1)}}l&&(n[u]=s,e[3*u]=e[3*s],e[3*u+1]=e[3*s+1],e[3*u+2]=e[3*s+2],t[3*u]=t[3*s],t[3*u+1]=t[3*s+1],t[3*u+2]=t[3*s+2],u++)}return u}function p(e){switch(e){default:case null:case"none":return function(e){return e};case"low-four-bit":return function(e){return 15&e};case"high-four-bit":return function(e){return(240&e)>>4};case"absolute-value":return function(e){return Math.abs(e)};case"modulo-ten":return function(e){return e%10}}}function v(e){var t,n=0,i=(0,r.Z)(e||[]);try{for(i.s();!(t=i.n()).done;){n|=1<<t.value}}catch(a){i.e(a)}finally{i.f()}return n}},23224:function(e,t,n){n.d(t,{i:function(){return _}});var r=n(93433),i=n(37762),a=n(74165),o=n(15861),u=n(15671),s=n(43144),l=n(60136),d=n(29388),c=n(27366),h=n(10064),f=(n(32718),n(93169),n(84936),n(69912)),p=n(37270),v=n(24405),_=function(e){var t=function(e){(0,l.Z)(n,e);var t=(0,d.Z)(n);function n(){return(0,u.Z)(this,n),t.apply(this,arguments)}return(0,s.Z)(n,[{key:"_validateFetchPopupFeatures",value:function(e){var t=this.layer;if(!t.popupEnabled)throw new h.Z("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t});if(!(0,v.V5)(t,e))throw new h.Z("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t})}},{key:"prepareFetchPopupFeatures",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPopupFeaturesFromGraphics",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var o,u,s,l,d,c,h,f,_,g,y,m;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._validateFetchPopupFeatures(n),0!==t.length){e.next=2;break}return e.abrupt("return",[]);case 2:if(o="scene"===this.layer.type&&null!=this.layer.associatedLayer?this.layer.associatedLayer:this.layer,u=[],e.t0="fieldsIndex"in this.layer,!e.t0){e.next=12;break}return e.t1=p.Lk,e.t2=this.layer.fieldsIndex,e.next=10,(0,v.e7)(o,(0,v.V5)(this.layer,n));case 10:e.t3=e.sent,u=(0,e.t1)(e.t2,e.t3);case 12:return e.next=14,this.prepareFetchPopupFeatures(u);case 14:s=new Set,l=[],d=[],c=(0,i.Z)(t);try{for(c.s();!(h=c.n()).done;)f=h.value,(0,p.Gm)(u,f,s)?d.push(f):l.push(f)}catch(a){c.e(a)}finally{c.f()}if(0!==d.length){e.next=19;break}return e.abrupt("return",l);case 19:for(_=new Map,g=0;g<t.length;g++)_.set(null!==(y=t[g].getObjectId())&&void 0!==y?y:0,g);return e.next=23,this.whenGraphicAttributes(d,(0,r.Z)(s)).catch((function(){return d})).then((function(e){return l.concat(e)}));case 23:return m=e.sent,e.abrupt("return",(m.sort((function(e,t){var n,r,i,a,o=null!==(n=e.getObjectId())&&void 0!==n?n:0,u=null!==(r=_.get(o))&&void 0!==r?r:0,s=null!==(i=t.getObjectId())&&void 0!==i?i:0;return u-(null!==(a=_.get(s))&&void 0!==a?a:0)})),m));case 25:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),n}(e);return t=(0,c._)([(0,f.j)("esri.views.3d.layers.support.PopupSceneLayerView")],t)}},67581:function(e,t,n){n.d(t,{Z:function(){return m}});var r=n(15671),i=n(43144),a=n(60136),o=n(29388),u=n(27366),s=n(7138),l=n(91505),d=n(79056),c=n(32718),h=n(92026),f=n(67426),p=n(49861),v=(n(93169),n(84936),n(69912)),_=n(46634),g=n(69787),y=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e))._updatingHandles=new _.R,i.layer=null,i.parent=null,i}return(0,i.Z)(n,[{key:"initialize",value:function(){var e=this;this.when().catch((function(t){if("layerview:create-error"!==t.name){var n,r=e.layer&&e.layer.id||"no id",i=(null===(n=e.layer)||void 0===n?void 0:n.title)||"no title";c.Z.getLogger(e).error("#resolve()","Failed to resolve layer view (layer title: '".concat(i,"', id: '").concat(r,"')"),t)}}))}},{key:"destroy",value:function(){this._updatingHandles=(0,h.SC)(this._updatingHandles)}},{key:"fullOpacity",get:function(){var e,t,n,r;return(null!==(e=null===(t=this.layer)||void 0===t?void 0:t.opacity)&&void 0!==e?e:1)*(null!==(n=null===(r=this.parent)||void 0===r?void 0:r.fullOpacity)&&void 0!==n?n:1)}},{key:"suspended",get:function(){return this.destroyed||!this.canResume()}},{key:"suspendInfo",get:function(){return this.getSuspendInfo()}},{key:"legendEnabled",get:function(){var e;return!this.suspended&&!0===(null===(e=this.layer)||void 0===e?void 0:e.legendEnabled)}},{key:"updating",get:function(){var e;return!((null===(e=this._updatingHandles)||void 0===e||!e.updating)&&!this.isUpdating())}},{key:"updatingProgress",get:function(){return this.updating?0:1}},{key:"updateSuspended",get:function(){return this.suspended}},{key:"visible",get:function(){var e;return!0===(null===(e=this.layer)||void 0===e?void 0:e.visible)},set:function(e){this._overrideIfSome("visible",e)}},{key:"visibleAtCurrentScale",get:function(){return!0}},{key:"visibleAtCurrentTimeExtent",get:function(){var e,t=this.view.timeExtent,n=null===(e=this.layer)||void 0===e?void 0:e.visibilityTimeExtent;return!t||!n||!t.intersection(n).isEmpty}},{key:"canResume",value:function(){var e,t,n,r=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&(null===(e=this.layer)||void 0===e?void 0:e.loaded)&&!(null!==(t=this.parent)&&void 0!==t&&t.suspended)&&(null===(n=this.view)||void 0===n?void 0:n.ready)&&(0,g.Cy)(r)&&this.visibleAtCurrentScale&&this.visibleAtCurrentTimeExtent||!1}},{key:"getSuspendInfo",value:function(){var e,t,n=null!==(e=this.parent)&&void 0!==e&&e.suspended?this.parent.suspendInfo:{};null!==(t=this.view)&&void 0!==t&&t.ready||(n.viewNotReady=!0),this.layer&&this.layer.loaded||(n.layerNotLoaded=!0);var r=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return(0,g.Cy)(r)&&this.visibleAtCurrentScale||(n.outsideScaleRange=!0),this.visibleAtCurrentTimeExtent||(n.outsideVisibilityTimeExtent=!0),this.visible||(n.layerInvisible=!0),n}},{key:"isUpdating",value:function(){return!1}}]),n}((0,d.IG)((0,f.v)(l.Z.EventedMixin(s.default))));(0,u._)([(0,p.Cb)()],y.prototype,"view",void 0),(0,u._)([(0,p.Cb)()],y.prototype,"fullOpacity",null),(0,u._)([(0,p.Cb)()],y.prototype,"layer",void 0),(0,u._)([(0,p.Cb)()],y.prototype,"parent",void 0),(0,u._)([(0,p.Cb)({readOnly:!0})],y.prototype,"suspended",null),(0,u._)([(0,p.Cb)({readOnly:!0})],y.prototype,"suspendInfo",null),(0,u._)([(0,p.Cb)({readOnly:!0})],y.prototype,"legendEnabled",null),(0,u._)([(0,p.Cb)({type:Boolean,readOnly:!0})],y.prototype,"updating",null),(0,u._)([(0,p.Cb)({readOnly:!0})],y.prototype,"updatingProgress",null),(0,u._)([(0,p.Cb)()],y.prototype,"updateSuspended",null),(0,u._)([(0,p.Cb)()],y.prototype,"visible",null),(0,u._)([(0,p.Cb)({readOnly:!0})],y.prototype,"visibleAtCurrentScale",null),(0,u._)([(0,p.Cb)({readOnly:!0})],y.prototype,"visibleAtCurrentTimeExtent",null);var m=y=(0,u._)([(0,v.j)("esri.views.layers.LayerView")],y)},24405:function(e,t,n){n.d(t,{V5:function(){return l},e7:function(){return u},zc:function(){return d}});var r=n(74165),i=n(93433),a=n(15861),o=n(37270);function u(e){return s.apply(this,arguments)}function s(){return s=(0,a.Z)((0,r.Z)().mark((function e(t){var n,a,u,s,l,d,c,h,f,p,v,_=arguments;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(u=_.length>1&&void 0!==_[1]?_[1]:t.popupTemplate)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,u.getRequiredFields(t.fieldsIndex);case 5:if(s=e.sent,l=u.lastEditInfoEnabled,d=t.objectIdField,c=t.typeIdField,h=t.globalIdField,f=t.relationships,!s.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:return p=l?(0,o.CH)(t):[],v=(0,o.Q0)(t.fieldsIndex,[].concat((0,i.Z)(s),(0,i.Z)(p))),e.abrupt("return",(c&&v.push(c),v&&d&&null!==(n=t.fieldsIndex)&&void 0!==n&&n.has(d)&&!v.includes(d)&&v.push(d),v&&h&&null!==(a=t.fieldsIndex)&&void 0!==a&&a.has(h)&&!v.includes(h)&&v.push(h),f&&f.forEach((function(e){var n,r=e.keyField;v&&r&&(null===(n=t.fieldsIndex)||void 0===n?void 0:n.has(r))&&!v.includes(r)&&v.push(r)})),v));case 15:case"end":return e.stop()}}),e)}))),s.apply(this,arguments)}function l(e,t){return e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&null!=e.defaultPopupTemplate?e.defaultPopupTemplate:null}function d(e,t){return null!=l(e,{defaultPopupTemplateEnabled:t})}}}]);
//# sourceMappingURL=51941.19b03423.chunk.js.map