"use strict";(self.webpackChunkreact_training=self.webpackChunkreact_training||[]).push([[32191],{32191:function(e,r,t){t.r(r),t.d(r,{default:function(){return X}});var n=t(43144),i=t(15671),s=t(60136),o=t(29388),a=t(19545),l=t(74165),u=t(15861),c=t(1413),h=t(37762),d=t(27366),v=t(42265),p=t(76200),f=t(10064),_=t(91505),g=t(98928),m=t(84652),y=t(18202),k=t(66978),w=t(35995),S=t(49861),I=(t(93169),t(32718),t(69912)),A=(t(59166),t(84936),t(33565)),U=t(8905),b=(t(80975),t(80532)),T=t(67005),x=t(37384),C=t(8704),P="esri-identity-modal",O={base:P,info:"".concat(P,"__info"),notice:"".concat(P,"__notice")},R=function(e){(0,s.Z)(a,e);var r=(0,o.Z)(a);function a(e,t){var n;return(0,i.Z)(this,a),(n=r.call(this,e,t)).container=document.createElement("div"),n.error=null,n.oAuthPrompt=!1,n.open=!1,n.signingIn=!1,n.server=null,n.resource=null,n._usernameInputNode=null,n._passwordInputNode=null,document.body.appendChild(n.container),n}return(0,n.Z)(a,[{key:"loadDependencies",value:function(){return(0,U.h)({button:function(){return Promise.all([t.e(92358),t.e(46895),t.e(54438),t.e(14105),t.e(32275)]).then(t.bind(t,32275))},input:function(){return Promise.all([t.e(92358),t.e(46895),t.e(54438),t.e(8715),t.e(16746)]).then(t.bind(t,75655))},label:function(){return Promise.all([t.e(92358),t.e(35738)]).then(t.bind(t,35738))},modal:function(){return Promise.all([t.e(92358),t.e(46895),t.e(63839),t.e(42454)]).then(t.bind(t,42454))},notice:function(){return Promise.all([t.e(92358),t.e(46895),t.e(15669)]).then(t.bind(t,15669))}})}},{key:"title",get:function(){var e;return null===(e=this.commonMessages)||void 0===e?void 0:e.auth.signIn}},{key:"render",value:function(){var e,r=this,t=this.open,n=this.title,i=this.messages,s=this.signingIn,o=this.oAuthPrompt,a=this.server,l=this.resource,u=this.error,c=i.info,h=i.oAuthInfo,d=i.lblItem,v=i.invalidUser,p=i.noAuthService,f=i.lblUser,_=i.lblPwd,g=i.lblCancel,m=i.lblSigning,y=i.lblOk;return(0,T.u)("div",{class:this.classes(O.base,(0,x.rk)())},(0,T.u)("form",{bind:this,onsubmit:this._submit},(0,T.u)("calcite-modal",{bind:this,open:t,outsideCloseDisabled:!0,scale:"s",widthScale:"s",onCalciteModalClose:this._cancel,onCalciteModalOpen:this._focusUsernameInput},(0,T.u)("div",{slot:"header"},n),(0,T.u)("div",{slot:"content"},(0,T.u)("div",{class:O.info},(0,C.n)(o?h:c,{server:a&&/\.arcgis\.com/i.test(a)?"ArcGIS Online":a,resource:"(".concat(l||d,")")})),u?(0,T.u)("calcite-notice",{class:O.notice,icon:"exclamation-mark-triangle",kind:"danger",open:!0},(0,T.u)("div",{slot:"message"},null!==(e=u.details)&&void 0!==e&&e.httpStatus?v:p)):null,o?null:[(0,T.u)("calcite-label",null,f,(0,T.u)("calcite-input",{afterCreate:function(e){return r._usernameInputNode=e},autocomplete:"off",bind:this,name:"username",required:!0,spellcheck:!1,type:"text",value:""})),(0,T.u)("calcite-label",null,_,(0,T.u)("calcite-input",{afterCreate:function(e){return r._passwordInputNode=e},bind:this,name:"password",required:!0,type:"password",value:""}))]),(0,T.u)("calcite-button",{appearance:"outline",bind:this,onclick:this._cancel,slot:"secondary",type:"button",width:"full"},g),(0,T.u)("calcite-button",{loading:!!s,slot:"primary",type:"submit",width:"full"},s?m:y))))}},{key:"_focusUsernameInput",value:function(){var e=this;requestAnimationFrame((function(){var r;null===(r=e._usernameInputNode)||void 0===r||r.setFocus()}))}},{key:"_cancel",value:function(){this._set("signingIn",!1),this.open=!1,this._usernameInputNode&&(this._usernameInputNode.value=""),this._passwordInputNode&&(this._passwordInputNode.value=""),this.emit("cancel")}},{key:"_submit",value:function(e){var r,t;e.preventDefault(),this._set("signingIn",!0);var n=this.oAuthPrompt?{}:{username:null===(r=this._usernameInputNode)||void 0===r?void 0:r.value,password:null===(t=this._passwordInputNode)||void 0===t?void 0:t.value};this.emit("submit",n)}}]),a}(A.Z);(0,d._)([(0,S.Cb)({readOnly:!0})],R.prototype,"container",void 0),(0,d._)([(0,S.Cb)(),(0,b.H)("esri/t9n/common")],R.prototype,"commonMessages",void 0),(0,d._)([(0,S.Cb)()],R.prototype,"error",void 0),(0,d._)([(0,S.Cb)(),(0,b.H)("esri/identity/t9n/identity")],R.prototype,"messages",void 0),(0,d._)([(0,S.Cb)()],R.prototype,"oAuthPrompt",void 0),(0,d._)([(0,S.Cb)()],R.prototype,"open",void 0),(0,d._)([(0,S.Cb)()],R.prototype,"signingIn",void 0),(0,d._)([(0,S.Cb)()],R.prototype,"server",void 0),(0,d._)([(0,S.Cb)({readOnly:!0})],R.prototype,"title",null),(0,d._)([(0,S.Cb)()],R.prototype,"resource",void 0);var D=R=(0,d._)([(0,I.j)("esri.identity.IdentityModal")],R),Z="esriJSAPIOAuth",q=function(){function e(r,t){(0,i.Z)(this,e),this.oAuthInfo=null,this.storage=null,this.appId=null,this.codeVerifier=null,this.expires=null,this.refreshToken=null,this.ssl=null,this.stateUID=null,this.token=null,this.userId=null,this.oAuthInfo=r,this.storage=t,this._init()}return(0,n.Z)(e,[{key:"isValid",value:function(){var e=!1;if(this.oAuthInfo&&this.userId&&(this.refreshToken||this.token))if(null==this.expires&&this.refreshToken)e=!0;else if(this.expires){var r=Date.now();this.expires>r&&(this.expires-r)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(e=!0)}return e}},{key:"save",value:function(){if(!this.storage)return!1;var e=this._load(),r=this.oAuthInfo;if(null!==r&&void 0!==r&&r.authNamespace&&r.portalUrl){var t=e[r.authNamespace];t||(t=e[r.authNamespace]={}),this.appId||(this.appId=r.appId),t[r.portalUrl]={appId:this.appId,codeVerifier:this.codeVerifier,expires:this.expires,refreshToken:this.refreshToken,ssl:this.ssl,stateUID:this.stateUID,token:this.token,userId:this.userId};try{this.storage.setItem(Z,JSON.stringify(e))}catch(L){return console.warn(L),!1}return!0}return!1}},{key:"destroy",value:function(){var e=this._load(),r=this.oAuthInfo;if(null!==r&&void 0!==r&&r.appId&&null!==r&&void 0!==r&&r.portalUrl&&(null==this.expires||this.expires>Date.now())&&(this.refreshToken||this.token)){var t=r.portalUrl.replace(/^http:/i,"https:")+"/sharing/rest/oauth2/revokeToken",n=new FormData;if(n.append("f","json"),n.append("auth_token",this.refreshToken||this.token),n.append("client_id",r.appId),n.append("token_type_hint",this.refreshToken?"refresh_token":"access_token"),"function"==typeof navigator.sendBeacon)navigator.sendBeacon(t,n);else{var i=new XMLHttpRequest;i.open("POST",t),i.send(n)}}if(null!==r&&void 0!==r&&r.authNamespace&&r.portalUrl&&this.storage){var s=e[r.authNamespace];if(s){delete s[r.portalUrl];try{this.storage.setItem(Z,JSON.stringify(e))}catch(L){console.log(L)}}}r&&(r._oAuthCred=null,this.oAuthInfo=null)}},{key:"_init",value:function(){var e=this._load(),r=this.oAuthInfo;if(null!==r&&void 0!==r&&r.authNamespace&&r.portalUrl){var t=e[r.authNamespace];t&&((t=t[r.portalUrl])&&(this.appId=t.appId,this.codeVerifier=t.codeVerifier,this.expires=t.expires,this.refreshToken=t.refreshToken,this.ssl=t.ssl,this.stateUID=t.stateUID,this.token=t.token,this.userId=t.userId))}}},{key:"_load",value:function(){var e={};if(this.storage){var r=this.storage.getItem(Z);if(r)try{e=JSON.parse(r)}catch(E){console.warn(E)}}return e}}]),e}();q.prototype.declaredClass="esri.identity.OAuthCredential";var j,N=t(46784),E=j=function(e){(0,s.Z)(t,e);var r=(0,o.Z)(t);function t(e){var n;return(0,i.Z)(this,t),(n=r.call(this,e))._oAuthCred=null,n.appId=null,n.authNamespace="/",n.expiration=20160,n.flowType="auto",n.forceLogin=!1,n.forceUserId=!1,n.locale=null,n.minTimeUntilExpiration=30,n.popup=!1,n.popupCallbackUrl="oauth-callback.html",n.popupWindowFeatures="height=490,width=800,resizable,scrollbars,status",n.portalUrl="https://www.arcgis.com",n.preserveUrlHash=!1,n.userId=null,n}return(0,n.Z)(t,[{key:"clone",value:function(){return j.fromJSON(this.toJSON())}}]),t}(N.wq);(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"appId",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"authNamespace",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"expiration",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"flowType",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"forceLogin",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"forceUserId",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"locale",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"minTimeUntilExpiration",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"popup",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"popupCallbackUrl",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"popupWindowFeatures",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"portalUrl",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"preserveUrlHash",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],E.prototype,"userId",void 0);var V=E=j=(0,d._)([(0,I.j)("esri.identity.OAuthInfo")],E),L=function(e){(0,s.Z)(t,e);var r=(0,o.Z)(t);function t(e){var n;return(0,i.Z)(this,t),(n=r.call(this,e)).adminTokenServiceUrl=null,n.currentVersion=null,n.hasPortal=null,n.hasServer=null,n.owningSystemUrl=null,n.owningTenant=null,n.server=null,n.shortLivedTokenValidity=null,n.tokenServiceUrl=null,n.webTierAuth=null,n}return(0,n.Z)(t)}(N.wq);(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"adminTokenServiceUrl",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"currentVersion",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"hasPortal",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"hasServer",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"owningSystemUrl",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"owningTenant",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"server",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"shortLivedTokenValidity",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"tokenServiceUrl",void 0),(0,d._)([(0,S.Cb)({json:{write:!0}})],L.prototype,"webTierAuth",void 0);var M=L=(0,d._)([(0,I.j)("esri.identity.ServerInfo")],L),B=t(80139),z={},F=function(e){var r=new w.R9(e.owningSystemUrl).host,t=new w.R9(e.server).host,n=/.+\.arcgis\.com$/i;return n.test(r)&&n.test(t)},H=function(e,r){return!!(F(e)&&r&&r.some((function(r){return r.test(e.server)})))},J=null,W=null;try{J=window.localStorage,W=window.sessionStorage}catch(Y){}var $=function(e){(0,s.Z)(t,e);var r=(0,o.Z)(t);function t(){var e;return(0,i.Z)(this,t),(e=r.call(this))._portalConfig=globalThis.esriGeowConfig,e.serverInfos=[],e.oAuthInfos=[],e.credentials=[],e._soReqs=[],e._xoReqs=[],e._portals=[],e._defaultOAuthInfo=null,e._defaultTokenValidity=60,e.dialog=null,e.tokenValidity=null,e.normalizeWebTierAuth=!1,e._appOrigin="null"!==window.origin?window.origin:window.location.origin,e._appUrlObj=(0,w.mN)(window.location.href),e._busy=null,e._rejectOnPersistedPageShow=!1,e._oAuthLocationParams=null,e._gwTokenUrl="/sharing/rest/generateToken",e._agsRest="/rest/services",e._agsPortal=/\/sharing(\/|$)/i,e._agsAdmin=/(https?:\/\/[^/]+\/[^/]+)\/admin\/?(\/.*)?$/i,e._adminSvcs=/\/rest\/admin\/services(\/|$)/i,e._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}],e._legacyFed=[],e._regexSDirUrl=/http.+\/rest\/services\/?/gi,e._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MissionServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer|VideoServer)).*/gi,e._gwUser=/http.+\/users\/([^/]+).*/i,e._gwItem=/http.+\/items\/([^/]+).*/i,e._gwGroup=/http.+\/groups\/([^/]+).*/i,e._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,e._createDefaultOAuthInfo=!0,e._hasTestedIfAppIsOnPortal=!1,e._getPlatformSelfError=null,e._getOAuthLocationParams(),window.addEventListener("pageshow",(function(r){e._pageShowHandler(r)})),e}return(0,n.Z)(t,[{key:"registerServers",value:function(e){var r=this,t=this.serverInfos;t?(e=e.filter((function(e){return!r.findServerInfo(e.server)})),this.serverInfos=t.concat(e)):this.serverInfos=e,e.forEach((function(e){e.owningSystemUrl&&r._portals.push(e.owningSystemUrl),e.hasPortal&&r._portals.push(e.server)}))}},{key:"registerOAuthInfos",value:function(e){var r=this.oAuthInfos;if(r){var t,n=(0,h.Z)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value,s=this.findOAuthInfo(i.portalUrl);s&&r.splice(r.indexOf(s),1)}}catch(o){n.e(o)}finally{n.f()}this.oAuthInfos=r.concat(e)}else this.oAuthInfos=e}},{key:"registerToken",value:function(e){var r;e=(0,c.Z)({},e);var t,n=this._sanitizeUrl(e.server),i=this._isServerRsrc(n),s=this.findServerInfo(n),o=!0;s||((s=new M).server=this._getServerInstanceRoot(n),i?s.hasServer=!0:(s.tokenServiceUrl=this._getTokenSvcUrl(n),s.hasPortal=!0),this.registerServers([s])),(t=this._findCredential(n))?(delete e.server,Object.assign(t,e),o=!1):((t=new G({userId:e.userId,server:null!==(r=s.server)&&void 0!==r?r:void 0,token:e.token,expires:e.expires,ssl:e.ssl,scope:i?"server":"portal"})).resources=[n],this.credentials.push(t)),t.emitTokenChange(!1),o||t.refreshServerTokens()}},{key:"toJSON",value:function(){return(0,m.yd)({serverInfos:this.serverInfos.map((function(e){return e.toJSON()})),oAuthInfos:this.oAuthInfos.map((function(e){return e.toJSON()})),credentials:this.credentials.map((function(e){return e.toJSON()}))})}},{key:"initialize",value:function(e){var r=this;if(e){"string"==typeof e&&(e=JSON.parse(e));var t=e.serverInfos,n=e.oAuthInfos,i=e.credentials;if(t){var s=[];t.forEach((function(e){e.server&&e.tokenServiceUrl&&s.push(e.declaredClass?e:new M(e))})),s.length&&this.registerServers(s)}if(n){var o=[];n.forEach((function(e){e.appId&&o.push(e.declaredClass?e:new V(e))})),o.length&&this.registerOAuthInfos(o)}i&&i.forEach((function(e){e.server&&e.token&&e.expires&&e.expires>Date.now()&&((e=e.declaredClass?e:new G(e)).emitTokenChange(),r.credentials.push(e))}))}}},{key:"findServerInfo",value:function(e){var r;e=this._sanitizeUrl(e);var t,n=(0,h.Z)(this.serverInfos);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(this._hasSameServerInstance(i.server,e)){r=i;break}}}catch(s){n.e(s)}finally{n.f()}return r}},{key:"findOAuthInfo",value:function(e){var r;e=this._sanitizeUrl(e);var t,n=(0,h.Z)(this.oAuthInfos);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(this._hasSameServerInstance(i.portalUrl,e)){r=i;break}}}catch(s){n.e(s)}finally{n.f()}return r}},{key:"findCredential",value:function(e,r){if(e){var t;e=this._sanitizeUrl(e);var n=this._isServerRsrc(e)?"server":"portal";if(r){var i,s=(0,h.Z)(this.credentials);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(this._hasSameServerInstance(o.server,e)&&r===o.userId&&o.scope===n){t=o;break}}}catch(c){s.e(c)}finally{s.f()}}else{var a,l=(0,h.Z)(this.credentials);try{for(l.s();!(a=l.n()).done;){var u=a.value;if(this._hasSameServerInstance(u.server,e)&&-1!==this._getIdenticalSvcIdx(e,u)&&u.scope===n){t=u;break}}}catch(c){l.e(c)}finally{l.f()}}return t}}},{key:"getCredential",value:function(e,r){var t,n,i,s=!0;r&&(n=!!r.token,i=r.error,s=!1!==r.prompt),r=(0,c.Z)({},r),e=this._sanitizeUrl(e);var o=new AbortController,a=(0,k.hh)();if(r.signal&&(0,k.fu)(r.signal,(function(){o.abort()})),(0,k.fu)(o,(function(){a.reject(new f.Z("identity-manager:user-aborted","ABORTED"))})),(0,k.Hc)(o))return a.promise;r.signal=o.signal;var l,u=this._isAdminResource(e),h=n?this.findCredential(e):null;if(h&&i&&i.details&&498===i.details.httpStatus)h.destroy();else if(h)return l=new f.Z("identity-manager:not-authorized","You are currently signed in as: '"+h.userId+"'. You do not have access to this resource: "+e,{error:i}),a.reject(l),a.promise;var d=this._findCredential(e,r);if(d)return a.resolve(d),a.promise;var v=this.findServerInfo(e);if(v)!v.hasPortal&&v.server&&v.owningSystemUrl&&this._hasSameServerInstance(v.server,v.owningSystemUrl)&&(v.hasPortal=!0),!v.hasServer&&this._isServerRsrc(e)&&(v._restInfoPms=this._getTokenSvcUrl(e),v.hasServer=!0);else{var p=this._getTokenSvcUrl(e);if(!p)return l=new f.Z("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),a.reject(l),a.promise;(v=new M).server=this._getServerInstanceRoot(e),"string"==typeof p?(v.tokenServiceUrl=p,v.hasPortal=!0):(v._restInfoPms=p,v.hasServer=!0),this.registerServers([v])}return v.hasPortal&&void 0===v._selfReq&&(s||(0,w.D6)(v.tokenServiceUrl,this._appOrigin)||this._gwDomains.some((function(e){return e.tokenServiceUrl===v.tokenServiceUrl})))&&(v._selfReq={owningTenant:null===(t=r)||void 0===t?void 0:t.owningTenant,selfDfd:this._getPortalSelf(v.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),e)}),this._enqueue(e,v,r,a,u)}},{key:"getResourceName",value:function(e){return this._isRESTService(e)?e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(e)&&e.replace(this._gwUser,"$1")||this._gwItem.test(e)&&e.replace(this._gwItem,"$1")||this._gwGroup.test(e)&&e.replace(this._gwGroup,"$1")||""}},{key:"generateToken",value:function(e,r,t){var n,i,s,o,a,l,u,h,d=this._rePortalTokenSvc.test(e.tokenServiceUrl),v=new w.R9(this._appOrigin),_=e.shortLivedTokenValidity;r&&((h=this.tokenValidity||_||this._defaultTokenValidity)>_&&_>0&&(h=_)),t&&(n=t.isAdmin,i=t.serverUrl,s=t.token,l=t.signal,u=t.ssl,e.customParameters=t.customParameters),n?o=e.adminTokenServiceUrl:(o=e.tokenServiceUrl,a=new w.R9(o.toLowerCase()),e.webTierAuth&&(null===t||void 0===t?void 0:t.serverUrl)&&!u&&"http"===v.scheme&&((0,w.D6)(v.uri,o,!0)||"https"===a.scheme&&v.host===a.host&&"7080"===v.port&&"7443"===a.port)&&(o=o.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));var g=(0,c.Z)({query:(0,c.Z)({request:"getToken",username:null===r||void 0===r?void 0:r.username,password:null===r||void 0===r?void 0:r.password,serverUrl:i,token:s,expiration:h,referer:n||d?this._appOrigin:null,client:n?"referer":null,f:"json"},e.customParameters),method:"post",authMode:"anonymous",useProxy:this._useProxy(e,t),signal:l},null===t||void 0===t?void 0:t.ioArgs);return d||(g.withCredentials=!1),(0,p.Z)(o,g).then((function(t){var n=t.data;if(null===n||void 0===n||!n.token)return new f.Z("identity-manager:authentication-failed","Unable to generate token");var i=e.server;return z[i]||(z[i]={}),r&&(z[i][r.username]=r.password),n.validity=h,n}))}},{key:"isBusy",value:function(){return!!this._busy}},{key:"checkSignInStatus",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(r){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.checkAppAccess(r,"");case 2:return e.abrupt("return",e.sent.credential);case 3:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"checkAppAccess",value:function(e,r,t){var n=this,i=!1;return this.getCredential(e,{prompt:!1}).then((function(s){var o,a={f:"json"};if("portal"===s.scope)if(r&&(n._doPortalSignIn(e)||null!==t&&void 0!==t&&t.force))o=s.server+"/sharing/rest/oauth2/validateAppAccess",a.client_id=r;else{if(!s.token)return{credential:s};o=s.server+"/sharing/rest"}else{if(!s.token)return{credential:s};o=s.server+"/rest/services"}return s.token&&(a.token=s.token),(0,p.Z)(o,{query:a,authMode:"anonymous"}).then((function(e){if(!1===e.data.valid)throw new f.Z("identity-manager:not-authorized","You are currently signed in as: '".concat(s.userId,"'."),e.data);return i=!!e.data.viewOnlyUserTypeApp,{credential:s}})).catch((function(e){var r;if("identity-manager:not-authorized"===e.name)throw e;var t=null===(r=e.details)||void 0===r?void 0:r.httpStatus;if(498===t)throw s.destroy(),new f.Z("identity-manager:not-authenticated","User is not signed in.");if(400===t)throw new f.Z("identity-manager:invalid-request");return{credential:s}}))})).then((function(e){return{credential:e.credential,viewOnly:i}}))}},{key:"setOAuthResponseHash",value:function(e){e&&("#"===e.charAt(0)&&(e=e.substring(1)),this._processOAuthPopupParams((0,w.u0)(e)))}},{key:"setOAuthRedirectionHandler",value:function(e){this._oAuthRedirectFunc=e}},{key:"setProtocolErrorHandler",value:function(e){this._protocolFunc=e}},{key:"signIn",value:function(e,r){var t=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=(0,k.hh)(),s=function(){var e,r,n;null!==(e=l)&&void 0!==e&&e.remove(),null!==(r=u)&&void 0!==r&&r.remove(),null!==(n=t.dialog)&&void 0!==n&&n.destroy(),t.dialog=l=u=null},o=function(){s(),t._oAuthDfd=null,i.reject(new f.Z("identity-manager:user-aborted","ABORTED"))};n.signal&&(0,k.fu)(n.signal,(function(){o()}));var a=new D({open:!0,resource:this.getResourceName(e),server:r.server});this.dialog=a,this.emit("dialog-create");var l=a.on("cancel",o),u=a.on("submit",(function(e){t.generateToken(r,e,{isAdmin:n.isAdmin,signal:n.signal}).then((function(t){var o;s();var a=new G({userId:e.username,server:null!==(o=r.server)&&void 0!==o?o:void 0,token:t.token,expires:null!=t.expires?Number(t.expires):null,ssl:!!t.ssl,isAdmin:n.isAdmin,validity:t.validity});i.resolve(a)})).catch((function(e){a.error=e,a.signingIn=!1}))}));return i.promise}},{key:"oAuthSignIn",value:function(e,r,t,n){var i=this;this._oAuthDfd=(0,k.hh)();var s,o=this._oAuthDfd;null!==n&&void 0!==n&&n.signal&&(0,k.fu)(n.signal,(function(){var e=i._oAuthDfd&&i._oAuthDfd.oAuthWin_;e&&!e.closed?e.close():i.dialog&&h()})),o.resUrl_=e,o.sinfo_=r,o.oinfo_=t;var a,l,u=t._oAuthCred;if(u.storage&&("authorization-code"===t.flowType||"auto"===t.flowType&&r.currentVersion>=8.4)){var c=crypto.getRandomValues(new Uint8Array(32));s=(0,w.rS)(c),u.codeVerifier=s,c=crypto.getRandomValues(new Uint8Array(32)),u.stateUID=(0,w.rS)(c),u.save()||(u.codeVerifier=s=null)}else u.codeVerifier=null;this._getCodeChallenge(s).then((function(s){var o=!n||!1!==n.oAuthPopupConfirmation;if(t.popup&&o){var u=new D({oAuthPrompt:!0,server:r.server,open:!0});i.dialog=u,i.emit("dialog-create"),a=u.on("cancel",h),l=u.on("submit",(function(){d(),i._doOAuthSignIn(e,r,t,s)}))}else i._doOAuthSignIn(e,r,t,s)}));var h=function(){d(),i._oAuthDfd=null,o.reject(new f.Z("identity-manager:user-aborted","ABORTED"))},d=function(){var e,r,t;null!==(e=a)&&void 0!==e&&e.remove(),null!==(r=l)&&void 0!==r&&r.remove(),null!==(t=i.dialog)&&void 0!==t&&t.destroy(),i.dialog=null};return o.promise}},{key:"destroyCredentials",value:function(){this.credentials&&this.credentials.slice().forEach((function(e){e.destroy()})),this.emit("credentials-destroy")}},{key:"enablePostMessageAuth",value:function(){var e=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"https://www.arcgis.com/sharing/rest";this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=(0,g.on)(window,"message",(function(t){var n;if((t.origin===e._appOrigin||t.origin.endsWith(".arcgis.com"))&&"arcgis:auth:requestCredential"===(null===(n=t.data)||void 0===n?void 0:n.type)){var i=t.source;e.getCredential(r).then((function(e){i.postMessage({type:"arcgis:auth:credential",credential:{expires:e.expires,server:e.server,ssl:e.ssl,token:e.token,userId:e.userId}},t.origin)})).catch((function(e){i.postMessage({type:"arcgis:auth:error",error:{name:e.name,message:e.message}},t.origin)}))}}))}},{key:"disablePostMessageAuth",value:function(){this._postMessageAuthHandle&&(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)}},{key:"_getOAuthLocationParams",value:function(){var e=window.location.hash;if(e){var r;"#"===e.charAt(0)&&(e=e.substring(1));var t=(0,w.u0)(e),n=!1;if(t.access_token&&t.expires_in&&t.state&&t.hasOwnProperty("username"))try{t.state=JSON.parse(t.state),t.state.portalUrl&&(this._oAuthLocationParams=t,n=!0)}catch(d){}else if(t.error&&t.error_description&&(console.log("IdentityManager OAuth Error: ",t.error," - ",t.error_description),"access_denied"===t.error&&(n=!0,t.state)))try{t.state=JSON.parse(t.state)}catch(v){}n&&(window.location.hash=(null===(r=t.state)||void 0===r?void 0:r.hash)||"")}var i=window.location.search;if(i){"?"===i.charAt(0)&&(i=i.substring(1));var s=(0,w.u0)(i),o=!1;if(s.code&&s.state)try{s.state=JSON.parse(s.state),s.state.portalUrl&&s.state.uid&&(this._oAuthLocationParams=s,o=!0)}catch(p){}else if(s.error&&s.error_description&&(console.log("IdentityManager OAuth Error: ",s.error," - ",s.error_description),"access_denied"===s.error&&(o=!0,s.state)))try{s.state=JSON.parse(s.state)}catch(f){}if(o){var a,l=(0,c.Z)({},s);["code","error","error_description","message_code","persist","state"].forEach((function(e){delete l[e]}));var u=(0,w.B7)(l),h=window.location.pathname+(u?"?".concat(u):"")+((null===(a=s.state)||void 0===a?void 0:a.hash)||"");window.history.replaceState(window.history.state,"",h)}}}},{key:"_getOAuthToken",value:function(e,r,t,n,i){return e=e.replace(/^http:/i,"https:"),(0,p.Z)("".concat(e,"/sharing/rest/oauth2/token"),{authMode:"anonymous",method:"post",query:n&&i?{grant_type:"authorization_code",code:r,redirect_uri:n,client_id:t,code_verifier:i}:{grant_type:"refresh_token",refresh_token:r,client_id:t}}).then((function(e){return e.data}))}},{key:"_getCodeChallenge",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(r){var t,n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r||!globalThis.isSecureContext){e.next=6;break}return t=(new TextEncoder).encode(r),e.next=4,crypto.subtle.digest("SHA-256",t);case 4:return n=e.sent,e.abrupt("return",(0,w.rS)(new Uint8Array(n)));case 6:return e.abrupt("return",null);case 7:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()},{key:"_pageShowHandler",value:function(e){if(e.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){var r=new f.Z("identity-manager:user-aborted","ABORTED");this._errbackFunc(r)}}},{key:"_findCredential",value:function(e,r){var t,n,i,s,o=this,a=-1,l=null===r||void 0===r?void 0:r.token,u=null===r||void 0===r?void 0:r.resource,c=this._isServerRsrc(e)?"server":"portal",h=this.credentials.filter((function(r){return o._hasSameServerInstance(r.server,e)&&r.scope===c}));if(e=u||e,h.length)if(1===h.length){var d;if(t=h[0],i=this.findServerInfo(t.server),n=null===(d=i)||void 0===d?void 0:d.owningSystemUrl,s=n?this.findCredential(n,t.userId):void 0,a=this._getIdenticalSvcIdx(e,t),!l)return-1===a&&t.resources.push(e),this._addResource(e,s),t;-1!==a&&(t.resources.splice(a,1),this._removeResource(e,s))}else{var v,p;if(h.some((function(r){var t;return-1!==(p=o._getIdenticalSvcIdx(e,r))&&(v=r,i=o.findServerInfo(v.server),n=null===(t=i)||void 0===t?void 0:t.owningSystemUrl,s=n?o.findCredential(n,v.userId):void 0,a=p,!0)})),l)v&&(v.resources.splice(a,1),this._removeResource(e,s));else if(v)return this._addResource(e,s),v}}},{key:"_findOAuthInfo",value:function(e){var r=this.findOAuthInfo(e);if(!r){var t,n=(0,h.Z)(this.oAuthInfos);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(this._isIdProvider(i.portalUrl,e)){r=i;break}}}catch(s){n.e(s)}finally{n.f()}}return r}},{key:"_addResource",value:function(e,r){r&&-1===this._getIdenticalSvcIdx(e,r)&&r.resources.push(e)}},{key:"_removeResource",value:function(e,r){var t=-1;r&&((t=this._getIdenticalSvcIdx(e,r))>-1&&r.resources.splice(t,1))}},{key:"_useProxy",value:function(e,r){return(null===r||void 0===r?void 0:r.isAdmin)&&!(0,w.D6)(e.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(e.tokenServiceUrl)&&"10.1"===String(e.currentVersion)&&!(0,w.D6)(e.tokenServiceUrl,this._appOrigin)}},{key:"_getOrigin",value:function(e){var r=new w.R9(e);return r.scheme+"://"+r.host+(null!=r.port?":"+r.port:"")}},{key:"_getServerInstanceRoot",value:function(e){var r=e.toLowerCase(),t=r.indexOf(this._agsRest);return-1===t&&this._isAdminResource(e)&&(t=this._agsAdmin.test(e)?e.replace(this._agsAdmin,"$1").length:e.search(this._adminSvcs)),-1!==t||(0,B.P5)(r)||(t=r.indexOf("/sharing")),-1===t&&r.endsWith("/")&&(t=r.length-1),t>-1?e.substring(0,t):e}},{key:"_hasSameServerInstance",value:function(e,r){return e.endsWith("/")&&(e=e.slice(0,-1)),e=e.toLowerCase(),r=this._getServerInstanceRoot(r).toLowerCase(),e=(0,B.c_)(e),r=(0,B.c_)(r),(e=e.substring(e.indexOf(":")))===r.substring(r.indexOf(":"))}},{key:"_sanitizeUrl",value:function(e){var r=(v.Z.request.proxyUrl||"").toLowerCase(),t=r?e.toLowerCase().indexOf(r+"?"):-1;return-1!==t&&(e=e.substring(t+r.length+1)),e=(0,w.Fv)(e),(0,w.mN)(e).path}},{key:"_isRESTService",value:function(e){return e.includes(this._agsRest)}},{key:"_isAdminResource",value:function(e){return this._agsAdmin.test(e)||this._adminSvcs.test(e)}},{key:"_isServerRsrc",value:function(e){return this._isRESTService(e)||this._isAdminResource(e)}},{key:"_isIdenticalService",value:function(e,r){var t=!1;if(this._isRESTService(e)&&this._isRESTService(r)){var n=this._getSuffix(e).toLowerCase(),i=this._getSuffix(r).toLowerCase();if(!(t=n===i)){var s=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;t=n.replaceAll(s,"$1")===i.replaceAll(s,"$1")}}else this._isAdminResource(e)&&this._isAdminResource(r)?t=!0:this._isServerRsrc(e)||this._isServerRsrc(r)||!this._isPortalDomain(e)||(t=!0);return t}},{key:"_isPortalDomain",value:function(e){var r=this,t=new w.R9(e.toLowerCase()),n=this._portalConfig,i=this._gwDomains.some((function(e){return e.regex.test(t.uri)}));return!i&&n&&(i=this._hasSameServerInstance(this._getServerInstanceRoot(n.restBaseUrl),t.uri)),i||v.Z.portalUrl&&(i=(0,w.D6)(t,v.Z.portalUrl,!0)),i||(i=this._portals.some((function(e){return r._hasSameServerInstance(e,t.uri)}))),i=i||this._agsPortal.test(t.path)}},{key:"_isIdProvider",value:function(e,r){var t=-1,n=-1;this._gwDomains.forEach((function(i,s){-1===t&&i.regex.test(e)&&(t=s),-1===n&&i.regex.test(r)&&(n=s)}));var i=!1;if(t>-1&&n>-1&&(0===t||4===t?0!==n&&4!==n||(i=!0):1===t?1!==n&&2!==n||(i=!0):2===t?2===n&&(i=!0):3===t&&3===n&&(i=!0)),!i){var s=this.findServerInfo(r),o=null===s||void 0===s?void 0:s.owningSystemUrl;o&&F(s)&&this._isPortalDomain(o)&&this._isIdProvider(e,o)&&(i=!0)}return i}},{key:"_getIdenticalSvcIdx",value:function(e,r){for(var t=-1,n=0;n<r.resources.length;n++){var i=r.resources[n];if(this._isIdenticalService(e,i)){t=n;break}}return t}},{key:"_getSuffix",value:function(e){return e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")}},{key:"_getTokenSvcUrl",value:function(e){var r,t=this;if(this._isRESTService(e)||this._isAdminResource(e)){var n=this._getServerInstanceRoot(e);return{adminUrl:n+"/admin/generateToken",promise:(0,p.Z)(e=n+"/rest/info",{query:{f:"json"}}).then((function(e){return e.data}))}}if(this._isPortalDomain(e)){var i="";if(this._gwDomains.some((function(r){return r.regex.test(e)&&(i=r.tokenServiceUrl),!!i})),i||this._portals.some((function(r){return t._hasSameServerInstance(r,e)&&(i=r+t._gwTokenUrl),!!i})),i||-1!==(r=e.toLowerCase().indexOf("/sharing"))&&(i=e.substring(0,r)+this._gwTokenUrl),i||(i=this._getOrigin(e)+this._gwTokenUrl),i){var s=new w.R9(e).port;/^http:\/\//i.test(e)&&"7080"===s&&(i=i.replace(/:7080/i,":7443")),i=i.replace(/http:/i,"https:")}return i}}},{key:"_processOAuthResponseParams",value:function(e,r,t){var n,i=r._oAuthCred;if(e.code){var s=i.codeVerifier;return i.codeVerifier=null,i.stateUID=null,i.save(),this._getOAuthToken(t.server,e.code,r.appId,this._getRedirectURI(r,!0),s).then((function(n){var s,o=new G({userId:n.username,server:null!==(s=t.server)&&void 0!==s?s:void 0,token:n.access_token,expires:Date.now()+1e3*n.expires_in,ssl:n.ssl,oAuthState:e.state,_oAuthCred:i});return r.userId=o.userId,i.storage=n.persist?J:W,i.refreshToken=n.refresh_token,i.token=null,i.expires=n.refresh_token_expires_in?Date.now()+1e3*n.refresh_token_expires_in:null,i.userId=o.userId,i.ssl=o.ssl,i.save(),o}))}var o=new G({userId:e.username,server:null!==(n=t.server)&&void 0!==n?n:void 0,token:e.access_token,expires:Date.now()+1e3*Number(e.expires_in),ssl:"true"===e.ssl,oAuthState:e.state,_oAuthCred:i});return r.userId=o.userId,i.storage=e.persist?J:W,i.refreshToken=null,i.token=o.token,i.expires=o.expires,i.userId=o.userId,i.ssl=o.ssl,i.save(),Promise.resolve(o)}},{key:"_processOAuthPopupParams",value:function(e){var r,t=this._oAuthDfd;if(this._oAuthDfd=null,t)if(clearInterval(this._oAuthIntervalId),null!==(r=this._oAuthOnPopupHandle)&&void 0!==r&&r.remove(),e.error){var n="access_denied"===e.error,i=new f.Z(n?"identity-manager:user-aborted":"identity-manager:authentication-failed",n?"ABORTED":"OAuth: "+e.error+" - "+e.error_description);t.reject(i)}else this._processOAuthResponseParams(e,t.oinfo_,t.sinfo_).then((function(e){t.resolve(e)})).catch((function(e){t.reject(e)}))}},{key:"_setOAuthResponseQueryString",value:function(e){e&&("?"===e.charAt(0)&&(e=e.substring(1)),this._processOAuthPopupParams((0,w.u0)(e)))}},{key:"_exchangeToken",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(r,t,n){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,p.Z)("".concat(r,"/sharing/rest/oauth2/exchangeToken"),{authMode:"anonymous",method:"post",query:{f:"json",client_id:t,token:n}});case 2:return e.abrupt("return",e.sent.data.token);case 3:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}()},{key:"_getPlatformSelf",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(r,t){var n,i;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this._getPlatformSelfError&&Date.now()-this._getPlatformSelfError[1]<1e3)){e.next=2;break}throw this._getPlatformSelfError[0];case 2:return r=r.replace(/^http:/i,"https:"),e.prev=3,e.next=6,(0,p.Z)("".concat(r,"/sharing/rest/oauth2/platformSelf"),{authMode:"anonymous",headers:{"X-Esri-Auth-Client-Id":t,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},method:"post",query:{f:"json",expiration:30},withCredentials:!0});case 6:return n=e.sent,e.abrupt("return",(this._getPlatformSelfError=null,n.data));case 10:throw e.prev=10,e.t0=e.catch(3),"OAUTH_0066"===(null===(i=e.t0.details)||void 0===i?void 0:i.messageCode)&&(this._getPlatformSelfError=[e.t0,Date.now()]),e.t0;case 13:case"end":return e.stop()}}),e,this,[[3,10]])})));return function(r,t){return e.apply(this,arguments)}}()},{key:"_getPortalSelf",value:function(e,r){var t;return this._gwDomains.some((function(r){return r.regex.test(e)&&(t=r.customBaseUrl),!!t})),t?Promise.resolve({allSSL:!0,currentVersion:"8.4",customBaseUrl:t,portalMode:"multitenant",supportsOAuth:!0}):(this._appOrigin.startsWith("https:")?e=e.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(r)&&(e=e.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),(0,p.Z)(e,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then((function(e){return e.data})))}},{key:"_doPortalSignIn",value:function(e){var r=this._portalConfig,t=window.location.href,n=this.findServerInfo(e);return!(!r&&!this._isPortalDomain(t)||!(n?n.hasPortal||n.owningSystemUrl&&this._isPortalDomain(n.owningSystemUrl):this._isPortalDomain(e))||!(this._isIdProvider(t,e)||r&&(this._hasSameServerInstance(this._getServerInstanceRoot(r.restBaseUrl),e)||this._isIdProvider(r.restBaseUrl,e))||(0,w.D6)(t,e,!0)))}},{key:"_checkProtocol",value:function(e,r,t,n){var i=!0,s=n?r.adminTokenServiceUrl:r.tokenServiceUrl;return s.trim().toLowerCase().startsWith("https:")&&!this._appOrigin.startsWith("https:")&&(0,w.ed)(s)&&!(i=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:e,serverInfo:r}))&&t(new f.Z("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection.")),i}},{key:"_enqueue",value:function(e,r,t,n,i,s){return n||(n=(0,k.hh)()),n.resUrl_=e,n.sinfo_=r,n.options_=t,n.admin_=i,n.refresh_=s,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(e),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(n)):this._xoReqs.push(n):this._doSignIn(n),n.promise}},{key:"_doSignIn",value:function(e){var r=this;this._busy=e,this._rejectOnPersistedPageShow=!1;var t=function(t){var n,i=null===(n=e.options_)||void 0===n?void 0:n.resource,s=e.resUrl_,o=e.refresh_,a=!1;r.credentials.includes(t)||(o&&r.credentials.includes(o)?(o.userId=t.userId,o.token=t.token,o.expires=t.expires,o.validity=t.validity,o.ssl=t.ssl,o.creationTime=t.creationTime,a=!0,t=o):r.credentials.push(t)),t.resources||(t.resources=[]),t.resources.includes(i||s)||t.resources.push(i||s),t.scope=r._isServerRsrc(s)?"server":"portal",t.emitTokenChange();var l=r._soReqs,u={};r._soReqs=[],l.forEach((function(e){if(!r._isIdenticalService(s,e.resUrl_)){var n=r._getSuffix(e.resUrl_);u[n]||(u[n]=!0,t.resources.push(e.resUrl_))}})),e.resolve(t),l.forEach((function(e){r._hasSameServerInstance(r._getServerInstanceRoot(s),e.resUrl_)?e.resolve(t):r._soReqs.push(e)})),r._busy=e.resUrl_=e.sinfo_=e.refresh_=null,a||r.emit("credential-create",{credential:t}),r._soReqs.length?r._doSignIn(r._soReqs.shift()):r._xoReqs.length&&r._doSignIn(r._xoReqs.shift())},n=function(t){e.reject(t),r._busy=e.resUrl_=e.sinfo_=e.refresh_=null,r._soReqs.length?r._doSignIn(r._soReqs.shift()):r._xoReqs.length&&r._doSignIn(r._xoReqs.shift())},i=function i(s,o,a,l){var u,c,h,d,v,p=e.sinfo_,_=!e.options_||!1!==e.options_.prompt,m=p.hasPortal&&r._findOAuthInfo(e.resUrl_);if(s)t(new G({userId:s,server:null!==(u=p.server)&&void 0!==u?u:void 0,token:null!==a&&void 0!==a?a:void 0,expires:null!=l?Number(l):null,ssl:!!o}));else if(window!==window.parent&&null!==(c=r._appUrlObj.query)&&void 0!==c&&c["arcgis-auth-origin"]&&null!==(h=r._appUrlObj.query)&&void 0!==h&&h["arcgis-auth-portal"]&&r._hasSameServerInstance(r._getServerInstanceRoot(r._appUrlObj.query["arcgis-auth-portal"]),e.resUrl_)){var y;window.parent.postMessage({type:"arcgis:auth:requestCredential"},r._appUrlObj.query["arcgis-auth-origin"]);var S=(0,g.on)(window,"message",(function(e){e.source===window.parent&&e.data&&("arcgis:auth:credential"===e.data.type?(S.remove(),e.data.credential.expires<Date.now()?n(new f.Z("identity-manager:credential-request-failed","Parent application's token has expired.")):t(new G(e.data.credential))):"arcgis:auth:error"===e.data.type&&(S.remove(),"tokenExpiredError"===e.data.error.name?n(new f.Z("identity-manager:credential-request-failed","Parent application's token has expired.")):n(f.Z.fromJSON(e.data.error))))}));(0,k.fu)(null===(y=e.options_)||void 0===y?void 0:y.signal,(function(){S.remove()}))}else if(m){var I=m._oAuthCred;if(!I){var A=new q(m,J),U=new q(m,W);A.isValid()&&U.isValid()?A.expires>U.expires?(I=A,U.destroy()):(I=U,A.destroy()):I=A.isValid()?A:U,m._oAuthCred=I}if(I.isValid()){var b,T,x,C;d=new G({userId:null!==(b=I.userId)&&void 0!==b?b:void 0,server:null!==(T=p.server)&&void 0!==T?T:void 0,token:null!==(x=I.token)&&void 0!==x?x:void 0,expires:I.expires,ssl:null!==(C=I.ssl)&&void 0!==C?C:void 0,_oAuthCred:I});var P=m.appId!==I.appId&&r._doPortalSignIn(e.resUrl_);P||I.refreshToken?(e._pendingDfd=I.refreshToken?r._getOAuthToken(p.server,I.refreshToken,I.appId).then((function(e){return d.expires=Date.now()+1e3*e.expires_in,d.token=e.access_token,d})):Promise.resolve(d),e._pendingDfd.then((function(e){return P?r._exchangeToken(e.server,m.appId,e.token).then((function(r){return e.token=r,e})).catch((function(){return e})):e})).then((function(e){t(e)})).catch((function(){var e;null!==(e=I)&&void 0!==e&&e.destroy(),i()}))):t(d)}else if(r._oAuthLocationParams&&r._hasSameServerInstance(m.portalUrl,r._oAuthLocationParams.state.portalUrl)&&(r._oAuthLocationParams.access_token||r._oAuthLocationParams.code&&r._oAuthLocationParams.state.uid===I.stateUID&&I.codeVerifier)){var O=r._oAuthLocationParams;r._oAuthLocationParams=null,e._pendingDfd=r._processOAuthResponseParams(O,m,p).then((function(e){t(e)})).catch(n)}else{var R=function(){_?e._pendingDfd=r.oAuthSignIn(e.resUrl_,p,m,e.options_).then(t,n):(v=new f.Z("identity-manager:not-authenticated","User is not signed in."),n(v))};r._doPortalSignIn(e.resUrl_)?e._pendingDfd=r._getPlatformSelf(p.server,m.appId).then((function(e){var n;(0,w.D6)(e.portalUrl,r._appOrigin,!0)?(d=new G({userId:e.username,server:null!==(n=p.server)&&void 0!==n?n:void 0,expires:Date.now()+1e3*e.expires_in,token:e.token}),t(d)):R()})).catch(R):R()}}else if(_){if(r._checkProtocol(e.resUrl_,p,n,e.admin_)){var D=e.options_;e.admin_&&((D=D||{}).isAdmin=!0),e._pendingDfd=r.signIn(e.resUrl_,p,D).then(t,n)}}else v=new f.Z("identity-manager:not-authenticated","User is not signed in."),n(v)},s=function(){var i,s,o,a,l=e.sinfo_,u=l.owningSystemUrl,c=e.options_;if(c&&(i=c.token,s=c.error,o=c.prompt),!(a=r._findCredential(u,{token:i,resource:e.resUrl_}))){var d,v=(0,h.Z)(r.credentials);try{for(v.s();!(d=v.n()).done;){var p=d.value;if(r._isIdProvider(u,p.server)){a=p;break}}}catch(g){v.e(g)}finally{v.f()}}if(a){var f=r.findCredential(e.resUrl_,a.userId);if(f)t(f);else if(H(l,r._legacyFed)){var _=a.toJSON();_.server=l.server,_.resources=null,t(new G(_))}else(e._pendingDfd=r.generateToken(r.findServerInfo(a.server),null,{serverUrl:e.resUrl_,token:a.token,signal:e.options_.signal,ssl:a.ssl})).then((function(r){var n,i;t(new G({userId:null===(n=a)||void 0===n?void 0:n.userId,server:null!==(i=l.server)&&void 0!==i?i:void 0,token:r.token,expires:null!=r.expires?Number(r.expires):null,ssl:!!r.ssl,isAdmin:e.admin_,validity:r.validity}))}),n)}else r._busy=null,i&&(e.options_.token=null),(e._pendingDfd=r.getCredential(u.replace(/\/?$/,"/sharing"),{resource:e.resUrl_,owningTenant:l.owningTenant,signal:e.options_.signal,token:i,error:s,prompt:o})).then((function(){r._enqueue(e.resUrl_,e.sinfo_,e.options_,e,e.admin_)}),(function(r){e.resUrl_=e.sinfo_=e.refresh_=null,e.reject(r)}))};this._errbackFunc=n;var o=e.sinfo_.owningSystemUrl,a=this._isServerRsrc(e.resUrl_),l=e.sinfo_._restInfoPms;l?l.promise.then((function(t){var n=e.sinfo_;if(n._restInfoPms){var o,l;n.adminTokenServiceUrl=n._restInfoPms.adminUrl,n._restInfoPms=null,n.tokenServiceUrl=null!==(o=(0,y.hS)("authInfo.tokenServicesUrl",t)||(0,y.hS)("authInfo.tokenServiceUrl",t)||(0,y.hS)("tokenServiceUrl",t))&&void 0!==o?o:null,n.shortLivedTokenValidity=null!==(l=(0,y.hS)("authInfo.shortLivedTokenValidity",t))&&void 0!==l?l:null,n.currentVersion=t.currentVersion,n.owningTenant=t.owningTenant;var u=n.owningSystemUrl=t.owningSystemUrl;u&&r._portals.push(u)}a&&n.owningSystemUrl?s():i()}),(function(){e.sinfo_._restInfoPms=null;var r=new f.Z("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");n(r)})):a&&o?s():e.sinfo_._selfReq?e.sinfo_._selfReq.selfDfd.then((function(t){var n,i,s,o,a,l={};return t&&(i=null===(n=t.user)||void 0===n?void 0:n.username,l.username=i,l.allSSL=t.allSSL,s=t.supportsOAuth,a=parseFloat(t.currentVersion),"multitenant"===t.portalMode&&(o=t.customBaseUrl),e.sinfo_.currentVersion=a),e.sinfo_.webTierAuth=!!i,i&&r.normalizeWebTierAuth?r.generateToken(e.sinfo_,null,{ssl:l.allSSL}).catch((function(){return null})).then((function(e){return l.portalToken=null===e||void 0===e?void 0:e.token,l.tokenExpiration=null===e||void 0===e?void 0:e.expires,l})):!i&&s&&a>=4.4&&!r._findOAuthInfo(e.resUrl_)?r._generateOAuthInfo({portalUrl:e.sinfo_.server,customBaseUrl:o,owningTenant:e.sinfo_._selfReq.owningTenant}).catch((function(){return null})).then((function(){return l})):l})).catch((function(){return null})).then((function(r){e.sinfo_._selfReq=null,r?i(r.username,r.allSSL,r.portalToken,r.tokenExpiration):i()})):i()}},{key:"_generateOAuthInfo",value:function(e){var r,t=this,n=null,i=e.portalUrl,s=e.customBaseUrl,o=e.owningTenant,a=!this._defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(a){var l=(n=window.location.href).indexOf("?");l>-1&&(n=n.slice(0,l)),l=n.search(/\/(apps|home)\//),n=l>-1?n.slice(0,l):null}return a&&n?(this._hasTestedIfAppIsOnPortal=!0,r=(0,p.Z)(n+"/sharing/rest",{query:{f:"json"}}).then((function(){t._defaultOAuthInfo=new V({appId:"arcgisonline",popupCallbackUrl:n+"/home/oauth-callback.html"})}))):r=Promise.resolve(),r.then((function(){if(t._defaultOAuthInfo)return i=i.replace(/^http:/i,"https:"),(0,p.Z)(i+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:o,client_id:t._defaultOAuthInfo.appId,redirect_uri:(0,w.hF)(t._defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then((function(e){if(e.data.valid){var r=t._defaultOAuthInfo.clone();e.data.urlKey&&s?r.portalUrl="https://"+e.data.urlKey.toLowerCase()+"."+s:r.portalUrl=i,r.popup=window!==window.top||!((0,w.D6)(i,t._appOrigin)||t._gwDomains.some((function(e){return e.regex.test(i)&&e.regex.test(t._appOrigin)}))),t.oAuthInfos.push(r)}}))}))}},{key:"_doOAuthSignIn",value:function(e,r,t,n){var i=this,s=t._oAuthCred,o={portalUrl:t.portalUrl};!t.popup&&t.preserveUrlHash&&window.location.hash&&(o.hash=window.location.hash),s.stateUID&&(o.uid=s.stateUID);var a={client_id:t.appId,response_type:s.codeVerifier?"code":"token",state:JSON.stringify(o),expiration:t.expiration,locale:t.locale,redirect_uri:this._getRedirectURI(t,!!s.codeVerifier)};t.forceLogin&&(a.force_login=!0),t.forceUserId&&t.userId&&(a.prepopulatedusername=t.userId),!t.popup&&this._doPortalSignIn(e)&&(a.redirectToUserOrgUrl=!0),s.codeVerifier&&(a.code_challenge=n||s.codeVerifier,a.code_challenge_method=n?"S256":"plain");var l=t.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",u=l+"?"+(0,w.B7)(a);if(t.popup){var c=window.open(u,"esriJSAPIOAuth",t.popupWindowFeatures);if(c)c.focus(),this._oAuthDfd.oAuthWin_=c,this._oAuthIntervalId=setInterval((function(){if(c.closed){clearInterval(i._oAuthIntervalId),i._oAuthOnPopupHandle.remove();var e=i._oAuthDfd;if(e){var r=new f.Z("identity-manager:user-aborted","ABORTED");e.reject(r)}}}),500),this._oAuthOnPopupHandle=(0,g.on)(window,["arcgis:auth:hash","arcgis:auth:location:search"],(function(e){"arcgis:auth:hash"===e.type?i.setOAuthResponseHash(e.detail):i._setOAuthResponseQueryString(e.detail)}));else{var h=new f.Z("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(h)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:a,authorizeUrl:l,resourceUrl:e,serverInfo:r,oAuthInfo:t}):window.location.href=u}},{key:"_getRedirectURI",value:function(e,r){var t=window.location.href.replace(/#.*$/,"");if(e.popup)return(0,w.hF)(e.popupCallbackUrl);if(r){var n=(0,w.mN)(t);return n.query&&["code","error","error_description","message_code","persist","state"].forEach((function(e){delete n.query[e]})),(0,w.fl)(n.path,n.query)}return t}}]),t}(_.Z);$.prototype.declaredClass="esri.identity.IdentityManagerBase";var G=function(e){(0,s.Z)(t,e);var r=(0,o.Z)(t);function t(e){var n;return(0,i.Z)(this,t),(n=r.call(this,e))._oAuthCred=null,n.tokenRefreshBuffer=2,(null===e||void 0===e?void 0:e._oAuthCred)&&(n._oAuthCred=e._oAuthCred),n}return(0,n.Z)(t,[{key:"initialize",value:function(){this.resources=this.resources||[],null==this.creationTime&&(this.creationTime=Date.now())}},{key:"refreshToken",value:function(){var e,r=this,t=a.id,n=t.findServerInfo(this.server),i=null===n||void 0===n?void 0:n.owningSystemUrl,s=!!i&&"server"===this.scope,o=s&&H(n,t._legacyFed),l=n.webTierAuth,u=l&&t.normalizeWebTierAuth,c=z[this.server],h=null===c||void 0===c?void 0:c[this.userId],d=this.resources&&this.resources[0],v=s?t.findServerInfo(i):null,p={username:this.userId,password:h};if(!l||u){s&&!v&&t.serverInfos.some((function(e){return t._isIdProvider(i,e.server)&&(v=e),!!v}));var f=v?t.findCredential(v.server,this.userId):null;if(!s||f){if(!o){if(s)e={serverUrl:d,token:null===f||void 0===f?void 0:f.token,ssl:null===f||void 0===f?void 0:f.ssl};else if(u)p=null,e={ssl:this.ssl};else{var _;if(!h)return d&&(d=t._sanitizeUrl(d),this._enqueued=1,(_=t._enqueue(d,n,null,null,this.isAdmin,this)).then((function(){r._enqueued=0,r.refreshServerTokens()})).catch((function(){r._enqueued=0}))),_;this.isAdmin&&(e={isAdmin:!0})}return t.generateToken(s?v:n,s?null:p,e).then((function(e){r.token=e.token,r.expires=null!=e.expires?Number(e.expires):null,r.creationTime=Date.now(),r.validity=e.validity,r.emitTokenChange(),r.refreshServerTokens()})).catch((function(){}))}null===f||void 0===f||f.refreshToken()}}}},{key:"refreshServerTokens",value:function(){var e=this;if("portal"===this.scope){var r=a.id;r.credentials.forEach((function(t){var n=r.findServerInfo(t.server),i=null===n||void 0===n?void 0:n.owningSystemUrl;t!==e&&t.userId===e.userId&&i&&"server"===t.scope&&(r._hasSameServerInstance(e.server,i)||r._isIdProvider(i,e.server))&&(H(n,r._legacyFed)?(t.token=e.token,t.expires=e.expires,t.creationTime=e.creationTime,t.validity=e.validity,t.emitTokenChange()):t.refreshToken())}))}}},{key:"emitTokenChange",value:function(e){clearTimeout(this._refreshTimer);var r=a.id,t=this.server?r.findServerInfo(this.server):null,n=null===t||void 0===t?void 0:t.owningSystemUrl,i=n?r.findServerInfo(n):null;!1===e||n&&"portal"!==this.scope&&(!(null!==i&&void 0!==i&&i.webTierAuth)||r.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer(),this.emit("token-change")}},{key:"destroy",value:function(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);var e=a.id,r=e.credentials.indexOf(this);r>-1&&e.credentials.splice(r,1),this.emitTokenChange(),this.emit("destroy")}},{key:"toJSON",value:function(){var e=(0,m.yd)({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),r=this.resources;return r&&r.length>0&&(e.resources=r.slice()),e}},{key:"_startRefreshTimer",value:function(){clearTimeout(this._refreshTimer);var e=6e4*this.tokenRefreshBuffer,r=Math.pow(2,31)-1,t=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();t<0?t=0:t>r&&(t=r),this._refreshTimer=setTimeout(this.refreshToken.bind(this),t>e?t-e:t)}}]),t}(_.Z.EventedAccessor);(0,d._)([(0,S.Cb)()],G.prototype,"creationTime",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"expires",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"isAdmin",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"oAuthState",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"resources",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"scope",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"server",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"ssl",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"token",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"tokenRefreshBuffer",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"userId",void 0),(0,d._)([(0,S.Cb)()],G.prototype,"validity",void 0),G=(0,d._)([(0,I.j)("esri.identity.Credential")],G);var K=function(e){(0,s.Z)(t,e);var r=(0,o.Z)(t);function t(){return(0,i.Z)(this,t),r.apply(this,arguments)}return(0,n.Z)(t)}($);K.prototype.declaredClass="esri.identity.IdentityManager";var X=new K;(0,a.qh)(X)},37384:function(e,r,t){t.d(r,{$o:function(){return i},V$:function(){return o},rk:function(){return s}});var n="calcite-mode-";function i(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-mode-name").replaceAll(/\s|'|"/g,"").startsWith("dark")}function s(){return"".concat(n).concat(i()?"dark":"light")}function o(e){a(e),e.classList.add(s())}function a(e){Array.from(e.classList).forEach((function(r){r.startsWith(n)&&e.classList.remove(r)}))}}}]);
//# sourceMappingURL=32191.1c34613e.chunk.js.map